/*! For license information please see module.js.LICENSE.txt */
define(["react","lodash","@grafana/ui","@grafana/data","@grafana/runtime"],(function(e,t,n,a,r){return function(e){var t={};function n(a){if(t[a])return t[a].exports;var r=t[a]={i:a,l:!1,exports:{}};return e[a].call(r.exports,r,r.exports,n),r.l=!0,r.exports}return n.m=e,n.c=t,n.d=function(e,t,a){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:a})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var a=Object.create(null);if(n.r(a),Object.defineProperty(a,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)n.d(a,r,function(t){return e[t]}.bind(null,r));return a},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="/",n(n.s=5)}([function(t,n){t.exports=e},function(e,n){e.exports=t},function(e,t){e.exports=n},function(e,t){e.exports=a},function(e,t){e.exports=r},function(e,t,n){"use strict";n.r(t);var a=n(3);function r(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}var i=function(){function e(t){var n=this;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.$scope=t,this.annotation=t.ctrl.annotation,this.datasource=t.ctrl.datasource,this.annotation.query=this.annotation.query||{},this.annotation.databases=this.annotation.databases||[],this.annotation.templates=this.annotation.templates||[],this.annotation.regex=this.annotation.regex||{},this.annotation.attribute=this.annotation.attribute||{},this.annotation.showEndTime=this.annotation.showEndTime||!1,this.datasource.getAssetServer(this.datasource.afserver.name).then((function(e){return n.getDatabases(e.WebId)}))}var t,n,a;return e.$inject=["$scope"],t=e,(n=[{key:"templateChanged",value:function(){}},{key:"databaseChanged",value:function(){this.annotation.templates=[],this.getEventFrames()}},{key:"getDatabases",value:function(e){var t=this,n=this;n.datasource.getDatabases(e).then((function(e){n.annotation.databases=e,t.$scope.$apply()}))}},{key:"getEventFrames",value:function(){var e=this,t=this;t.datasource.getEventFrameTemplates(this.annotation.database.WebId).then((function(n){t.annotation.templates=n,e.$scope.$apply()}))}}])&&r(t.prototype,n),a&&r(t,a),Object.defineProperty(t,"prototype",{writable:!1}),e}();i.templateUrl="partials/annotations.editor.html";var o=n(0),l=n.n(o),s=n(2);function u(e){return(u="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function c(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function m(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}function h(e,t){return(h=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e})(e,t)}function p(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,a=d(e);if(t){var r=d(this).constructor;n=Reflect.construct(a,arguments,r)}else n=a.apply(this,arguments);return f(this,n)}}function f(e,t){if(t&&("object"===u(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}function d(e){return(d=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}var v=s.LegacyForms.FormField,b=function(e){return Object.assign(Object.assign({},e),{jsonData:Object.assign(Object.assign({},e.jsonData),{url:e.url})})},g=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&h(e,t)}(i,e);var t,n,a,r=p(i);function i(){var e;return c(this,i),(e=r.apply(this,arguments)).onPIServerChange=function(t){var n=e.props,a=n.onOptionsChange,r=n.options,i=Object.assign(Object.assign({},r.jsonData),{piserver:t.target.value});a(Object.assign(Object.assign({},r),{jsonData:i}))},e.onAFServerChange=function(t){var n=e.props,a=n.onOptionsChange,r=n.options,i=Object.assign(Object.assign({},r.jsonData),{afserver:t.target.value});a(Object.assign(Object.assign({},r),{jsonData:i}))},e.onAFDatabaseChange=function(t){var n=e.props,a=n.onOptionsChange,r=n.options,i=Object.assign(Object.assign({},r.jsonData),{afdatabase:t.target.value});a(Object.assign(Object.assign({},r),{jsonData:i}))},e.onMyOptionsChange=function(t){(0,e.props.onOptionsChange)(b(t))},e}return t=i,(n=[{key:"render",value:function(){var e=this.props.options,t=b(e);return l.a.createElement("div",null,l.a.createElement(s.DataSourceHttpSettings,{defaultUrl:"https://server.name/piwebapi",dataSourceConfig:t,onChange:this.onMyOptionsChange,showAccessOptions:!0}),l.a.createElement("h3",{className:"page-heading"},"PI/AF Connection Details"),l.a.createElement("div",{className:"gf-form-group"},l.a.createElement("div",{className:"gf-form"},l.a.createElement(v,{label:"PI Server",labelWidth:10,inputWidth:25,onChange:this.onPIServerChange,value:t.jsonData.piserver||"",placeholder:"Default PI Server to use for data requests"})),l.a.createElement("div",{className:"gf-form"},l.a.createElement(v,{label:"AF Server",labelWidth:10,inputWidth:25,onChange:this.onAFServerChange,value:t.jsonData.afserver||"",placeholder:"Default AF Server to use for data requests"})),l.a.createElement("div",{className:"gf-form"},l.a.createElement(v,{label:"AF Database",labelWidth:10,inputWidth:25,onChange:this.onAFDatabaseChange,value:t.jsonData.afdatabase||"",placeholder:"Default AF Database server for AF queries"}))))}}])&&m(t.prototype,n),a&&m(t,a),Object.defineProperty(t,"prototype",{writable:!1}),i}(o.PureComponent),y=n(1);function O(e,t){var n={};for(var a in e)Object.prototype.hasOwnProperty.call(e,a)&&t.indexOf(a)<0&&(n[a]=e[a]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var r=0;for(a=Object.getOwnPropertySymbols(e);r<a.length;r++)t.indexOf(a[r])<0&&Object.prototype.propertyIsEnumerable.call(e,a[r])&&(n[a[r]]=e[a[r]])}return n}function j(e,t,n,a){return new(n||(n=Promise))((function(r,i){function o(e){try{s(a.next(e))}catch(e){i(e)}}function l(e){try{s(a.throw(e))}catch(e){i(e)}}function s(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,l)}s((a=a.apply(e,t||[])).next())}))}Object.create;Object.create;var P=function(e){var t=e.label,n=e.labelWidth,a=void 0===n?12:n,r=e.tooltip,i=e.children;return l.a.createElement(l.a.Fragment,null,l.a.createElement(s.InlineFormLabel,{width:a,tooltip:r},t),i)},S=function(){return l.a.createElement("div",{className:"gf-form gf-form--grow"},l.a.createElement("div",{className:"gf-form-label gf-form-label--grow"}))},E=function(e){var t=O(e,[]);return l.a.createElement(w,null,l.a.createElement(P,Object.assign({},t)))},w=function(e){return l.a.createElement("div",{className:"gf-form-inline"},e.children,l.a.createElement(S,null))},I=function(e){var t=O(e,[]);return l.a.createElement(C,null,l.a.createElement(P,Object.assign({},t)))},C=function(e){return l.a.createElement(l.a.Fragment,null,e.children)},x={target:";",attributes:[],segments:[],regex:{enable:!1},summary:{types:[],basis:"EventWeighted",interval:"",nodata:"Null"},expression:"",interpolate:{enable:!1},recordedValues:{enable:!1},digitalStates:{enable:!1},isPiPoint:!1};function A(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null==n)return;var a,r,i=[],o=!0,l=!1;try{for(n=n.call(e);!(o=(a=n.next()).done)&&(i.push(a.value),!t||i.length!==t);o=!0);}catch(e){l=!0,r=e}finally{try{o||null==n.return||n.return()}finally{if(l)throw r}}return i}(e,t)||function(e,t){if(!e)return;if("string"==typeof e)return V(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return V(e,t)}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function V(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,a=new Array(t);n<t;n++)a[n]=e[n];return a}var k=function(e){var t=e.isRaw,n=e.onChange,a=A(Object(o.useState)(!1),2),r=a[0],i=a[1];return Object(o.useEffect)((function(){i(!1)}),[t]),t?l.a.createElement(l.a.Fragment,null,l.a.createElement(s.Button,{"aria-label":"Switch to visual editor",icon:"pen",variant:"secondary",type:"button",onClick:function(){i(!0)}}),l.a.createElement(s.ConfirmModal,{isOpen:r,title:"Switch to visual editor mode",body:"Are you sure to switch to visual editor mode? You will lose the changes done in raw query mode.",confirmText:"Yes, switch to editor mode",dismissText:"No, stay in raw query mode",onConfirm:function(){n(!1)},onDismiss:function(){i(!1)}})):l.a.createElement(s.Button,{"aria-label":"Switch to text editor",icon:"pen",variant:"secondary",type:"button",onClick:function(){n(!0)}})};function N(e){return(N="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function F(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}function T(e,t){return(T=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e})(e,t)}function D(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,a=B(e);if(t){var r=B(this).constructor;n=Reflect.construct(a,arguments,r)}else n=a.apply(this,arguments);return W(this,n)}}function W(e,t){if(t&&("object"===N(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return R(e)}function R(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function B(e){return(B=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}var q=function(e){var t;return e.value?l.a.createElement("div",{className:"gf-form-label ".concat("template"===e.value.type?"query-keyword":"")},null!==(t=e.label)&&void 0!==t?t:"--no label--"):l.a.createElement("a",{className:"gf-form-label query-part"},l.a.createElement(s.Icon,{name:"plus"}))},_=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&T(e,t)}(i,e);var t,n,a,r=D(i);function i(e){var t;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,i),(t=r.call(this,e)).piServer=[],t.availableAttributes={},t.state={isPiPoint:!1,segments:[],attributes:[],summaries:[],attributeSegment:{},summarySegment:{},calculationBasisSegment:{},noDataReplacementSegment:{}},t.segmentChangeValue=function(e){var n=t.props.query;t.setState({segments:e},(function(){return t.onChange(Object.assign(Object.assign({},n),{segments:e}))}))},t.attributeChangeValue=function(e){var n=t.props.query;t.setState({attributes:e},(function(){return t.onChange(Object.assign(Object.assign({},n),{attributes:e}))}))},t.onPiPointChange=function(e,n){var a=t.state.attributes.slice(0);"-REMOVE-"===e.label?Object(y.remove)(a,(function(e,t){return t===n})):a[n]=e,t.checkPiPointSegments(e,a)},t.onAttributeChange=function(e,n){var a=t.state.attributes.slice(0);a[n]=e,t.checkAttributeSegments(a,t.state.segments)},t.onSegmentChange=function(e,n){var a,r,i=t.props.query,o=t.state.segments.slice(0);return"-REMOVE-"===e.label?(o=Object(y.slice)(o,0,n),t.checkAttributeSegments([],o),0===o.length?o.push({label:""}):(null===(a=o[o.length-1].value)||void 0===a?void 0:a.expandable)&&o.push({label:"Select Element",value:{value:"-Select Element-"}}),i.isPiPoint&&(t.piServer=[]),void t.segmentChangeValue(o)):(o[n]=e,i.isPiPoint?(t.piServer.push(e),void t.segmentChangeValue(o)):(n<o.length-1&&(o=Object(y.slice)(o,0,n+1)),t.checkAttributeSegments([],o),(null===(r=e.value)||void 0===r?void 0:r.expandable)&&o.push({label:"Select Element",value:{value:"-Select Element-"}}),void t.segmentChangeValue(o)))},t.getElementSegments=function(e,n){var a,r,i,o,l,s=t.props,u=s.datasource,c=s.query,m=s.data,h=R(t),p=c.isPiPoint?{type:"dataserver"}:{path:t.getSegmentPathUpTo(null!=n?n:t.state.segments.slice(0),e)};if(!c.isPiPoint){if((null===(a=u.afserver)||void 0===a?void 0:a.name)&&0===e)return Promise.resolve([{label:u.afserver.name,value:{value:u.afserver.name,expandable:!0}}]);if((null===(r=u.afserver)||void 0===r?void 0:r.name)&&(null===(i=u.afdatabase)||void 0===i?void 0:i.name)&&1===e)return Promise.resolve([{label:u.afdatabase.name,value:{value:u.afdatabase.name,expandable:!0}}])}return u.metricFindQuery(p,Object.assign(null!==(l=null===(o=null==m?void 0:m.request)||void 0===o?void 0:o.scopedVars)&&void 0!==l?l:{},{isPiPoint:c.isPiPoint})).then((function(e){var t=Object(y.map)(e,(function(e){return{label:e.text,value:{webId:e.WebId,value:e.text,expandable:!c.isPiPoint&&e.expandable}}}));if(0===t.length)return t;var n=u.templateSrv.getVariables();return Object(y.each)(n,(function(e){var n={label:"${"+e.name+"}",value:{type:"template",value:"${"+e.name+"}",expandable:!c.isPiPoint}};t.unshift(n)})),t.unshift({label:"-REMOVE-",value:{value:"-REMOVE-"}}),t})).catch((function(e){return h.error=e.message||"Failed to issue metric query",[]}))},t.getAttributeSegmentsPI=function(e){var n,a,r=t.props,i=r.datasource,o=r.query,l=r.data,s=R(t),u={path:"",webId:t.getSelectedPIServer(),pointName:(null!=e?e:"")+"*",type:"pipoint"},c=[];return i.metricFindQuery(u,Object.assign(null!==(a=null===(n=null==l?void 0:l.request)||void 0===n?void 0:n.scopedVars)&&void 0!==a?a:{},{isPiPoint:o.isPiPoint})).then((function(t){return(c=Object(y.map)(t,(function(e){return{path:e.Path,label:e.text,value:{value:e.text,expandable:!1}}}))).unshift({label:e,value:{value:e,expandable:!1}}),c.unshift({label:"-REMOVE-",value:{value:"-REMOVE-"}}),c})).catch((function(e){return s.error=e.message||"Failed to issue metric query",c}))},t.getAttributeSegmentsAF=function(e){var n=R(t),a=[];return Object(y.forOwn)(n.availableAttributes,(function(e,t){var n={label:t,value:{value:t,expandable:!0}};a.push(n)})),a.unshift({label:"-REMOVE-",value:{value:"-REMOVE-"}}),a},t.buildFromTarget=function(e,n,a){var r=e.target.split(";"),i=r.length>0?r[0].split("\\"):[];return i.length>1||1===i.length&&""!==i[0]?(r.splice(0,1),Object(y.each)(i,(function(e,t){n.push({label:e,value:{value:e,expandable:!0}})})),Object(y.each)(r,(function(e,t){""!==e&&a.push({label:e,value:{value:e,expandable:!1}})})),t.getElementSegments(i.length+1,n).then((function(e){return e.length>0&&n.push({label:"Select Element",value:{value:"-Select Element-"}}),n}))):Promise.resolve(n)},t.checkAfServer=function(){var e,n,a=t.props.datasource,r=[];return(null===(e=a.afserver)||void 0===e?void 0:e.name)?(r.push({label:a.afserver.name,value:{value:a.afserver.name,expandable:!0}}),(null===(n=a.afdatabase)||void 0===n?void 0:n.name)&&r.push({label:a.afdatabase.name,value:{value:a.afdatabase.name,expandable:!0}}),r.push({label:"Select Element",value:{value:"-Select Element-"}})):r.push({label:""}),r},t.updateArray=function(e,n,a,r,i){t.setState({segments:e,attributes:n,summaries:a,isPiPoint:r},(function(){return t.checkAttributeSegments(n,t.state.segments).then((function(){i&&i()}))}))},t.scopedVarsDone=!1,t.componentDidMount=function(){t.initialLoad(!1)},t.componentDidUpdate=function(){var e,n,a;"Done"===(null===(e=t.props.data)||void 0===e?void 0:e.state)&&(null===(a=null===(n=t.props.data)||void 0===n?void 0:n.request)||void 0===a?void 0:a.scopedVars)&&!t.scopedVarsDone&&(t.scopedVarsDone=!0,t.initialLoad(!0))},t.initialLoad=function(e){var n,a,r,i=t.props.query,o=Object(y.defaults)(i,x),l=o.segments,s=o.attributes,u=o.summary,c=o.isPiPoint,m=e?[]:null!==(n=null==l?void 0:l.slice(0))&&void 0!==n?n:[],h=e?[]:null!==(a=null==s?void 0:s.slice(0))&&void 0!==a?a:[],p=null!==(r=null==u?void 0:u.types)&&void 0!==r?r:[];if(c||0!==m.length)c&&m.length>0&&(t.piServer=m);else{if(i.target&&i.target.length>0&&";"!==i.target)return h=[],void t.buildFromTarget(i,m,h).then((function(e){t.updateArray(e,h,p,c)})).catch((function(e){}));m=t.checkAfServer()}t.updateArray(m,h,p,c,(function(){t.onChange(i)}))},t.onChange=function(e){var n,a=t.props,r=a.onChange,i=a.onRunQuery;if(e.summary.types=t.state.summaries,e.rawQuery){if(e.target=null!==(n=e.query)&&void 0!==n?n:"",""!==e.target){var o=e.target.split(";"),l=o[0].split("\\");o.splice(0,1),e.attributes=[],(l.length>1||1===l.length&&""!==l[0])&&(e.elementPath=l.join("\\"),Object(y.each)(o,(function(t,n){""!==t&&e.attributes.push({label:t,value:{value:t,expandable:!1}})})))}}else e.elementPath=t.getSegmentPathUpTo(t.state.segments,t.state.segments.length),e.target=e.elementPath+";"+Object(y.join)(e.attributes.map((function(e){var t;return null===(t=e.value)||void 0===t?void 0:t.value})),";");r(e),e.target&&e.target.length>0&&e.attributes.length>0&&i()},t.stateCallback=function(){var e=t.props.query;t.onChange(e)},t.onIsPiPointChange=function(e){var n=t.props.query,a=!n.isPiPoint;t.setState({segments:a?[{label:""}]:t.checkAfServer(),attributes:[],isPiPoint:a},(function(){t.onChange(Object.assign(Object.assign({},n),{expression:"",attributes:t.state.attributes,segments:t.state.segments,isPiPoint:a}))}))},t.onSegmentChange=t.onSegmentChange.bind(R(t)),t.calcBasisValueChanged=t.calcBasisValueChanged.bind(R(t)),t.calcNoDataValueChanged=t.calcNoDataValueChanged.bind(R(t)),t.onSummaryAction=t.onSummaryAction.bind(R(t)),t.onSummaryValueChanged=t.onSummaryValueChanged.bind(R(t)),t.onAttributeAction=t.onAttributeAction.bind(R(t)),t.onAttributeChange=t.onAttributeChange.bind(R(t)),t.summaryTypes=["Total","Average","Minimum","Maximum","Range","StdDev","PopulationStdDev","Count","PercentGood","All","AllForNonNumeric"],t.calculationBasis=["TimeWeighted","EventWeighted","TimeWeightedContinuous","TimeWeightedDiscrete","EventWeightedExcludeMostRecentEvent","EventWeightedExcludeEarliestEvent","EventWeightedIncludeBothEnds"],t.noDataReplacement=["Null","Drop","Previous","0","Keep"],t}return t=i,(n=[{key:"isValueEmpty",value:function(e){return!e||!e.value||!e.value.length||"-REMOVE-"===e.value}},{key:"calcBasisValueChanged",value:function(e){var t,n=this.props.query,a=n.summary;a.basis=null===(t=e.value)||void 0===t?void 0:t.value,this.onChange(Object.assign(Object.assign({},n),{summary:a}))}},{key:"getCalcBasisSegments",value:function(){return Object(y.map)(this.calculationBasis,(function(e){return{label:e,value:{value:e,expandable:!0}}}))}},{key:"calcNoDataValueChanged",value:function(e){var t,n=this.props.query,a=n.summary;a.nodata=null===(t=e.value)||void 0===t?void 0:t.value,this.onChange(Object.assign(Object.assign({},n),{summary:a}))}},{key:"getNoDataSegments",value:function(){return Object(y.map)(this.noDataReplacement,(function(e){return{label:e,value:{value:e,expandable:!0}}}))}},{key:"onSummaryValueChanged",value:function(e,t){var n=this.state.summaries.slice(0);n[t]=e,this.isValueEmpty(e.value)&&n.splice(t,1),this.setState({summaries:n},this.stateCallback)}},{key:"getSummarySegments",value:function(){var e=this,t=Object(y.filter)(this.summaryTypes,(function(t){return-1===e.state.summaries.map((function(e){var t;return null===(t=e.value)||void 0===t?void 0:t.value})).indexOf(t)})),n=Object(y.map)(t,(function(e){return{label:e,value:{value:e,expandable:!0}}}));return n.unshift({label:"-REMOVE-",value:{value:"-REMOVE-"}}),n}},{key:"removeSummary",value:function(e){var t=Object(y.filter)(this.state.summaries,(function(t){return t!==e}));this.setState({summaries:t})}},{key:"onSummaryAction",value:function(e){var t,n=this.state.summaries.slice(0);if(!this.isValueEmpty(e.value)){var a={label:e.label,value:{value:null===(t=e.value)||void 0===t?void 0:t.value,expandable:!0}};n.push(a)}this.setState({summarySegment:{},summaries:n},this.stateCallback)}},{key:"removeAttribute",value:function(e){var t=Object(y.filter)(this.state.attributes,(function(t){return t!==e}));this.attributeChangeValue(t)}},{key:"onAttributeAction",value:function(e){var t,n=this.props.query,a=this.state.attributes.slice(0);if(!this.isValueEmpty(e.value)){var r={label:e.label,value:{value:null===(t=e.value)||void 0===t?void 0:t.value,expandable:!n.isPiPoint}};a.push(r)}this.attributeChangeValue(a)}},{key:"getSegmentPathUpTo",value:function(e,t){var n=e.slice(0,t);return Object(y.reduce)(n,(function(e,t){var n;return t.value?(null===(n=t.value.value)||void 0===n?void 0:n.startsWith("-Select"))?e:e?e+"\\"+t.value.value:t.value.value:""}),"")}},{key:"checkAttributeSegments",value:function(e,t){var n,a,r=this,i=this.props,o=i.datasource,l=i.data,s=this,u={path:this.getSegmentPathUpTo(t.slice(0),t.length),type:"attributes"};return o.metricFindQuery(u,Object.assign(null!==(a=null===(n=null==l?void 0:l.request)||void 0===n?void 0:n.scopedVars)&&void 0!==a?a:{},{isPiPoint:!1})).then((function(t){var n={};Object(y.each)(t,(function(e){n[e.Path.substring(e.Path.indexOf("|")+1)]=e.WebId}));var a=Object(y.filter)(e,(function(e){var t,a=o.templateSrv.replace(null===(t=e.value)||void 0===t?void 0:t.value);return void 0!==n[a]}));s.availableAttributes=n,r.attributeChangeValue(a)})).catch((function(t){s.error=t.message||"Failed to issue metric query",r.attributeChangeValue(e)}))}},{key:"checkPiPointSegments",value:function(e,t){var n,a,r=this.props,i=r.datasource,o=r.data,l=this,s={path:e.path,webId:l.getSelectedPIServer(),pointName:e.label,type:"pipoint"};return i.metricFindQuery(s,Object.assign(null!==(a=null===(n=null==o?void 0:o.request)||void 0===n?void 0:n.scopedVars)&&void 0!==a?a:{},{isPiPoint:!0})).then((function(){l.attributeChangeValue(t)})).catch((function(e){l.error=e.message||"Failed to issue metric query",l.attributeChangeValue([])}))}},{key:"getSelectedPIServer",value:function(){var e,t=this,n="";return this.piServer.forEach((function(e){var a=t.props.query.target.split(";");a.length>=2&&a[0]===e.text&&(n=e.WebId)})),this.piServer.length>0?null===(e=this.piServer[0].value)||void 0===e?void 0:e.webId:n}},{key:"textEditorChanged",value:function(){var e=this,t=this.props,n=t.query,a=t.onChange,r=n.target.split(";"),i=r.length>0?r[0].split("\\"):[],o=[],l=[];i.length>1||1===i.length&&""!==i[0]?(r.splice(0,1),Object(y.each)(i,(function(e,t){o.push({label:e,value:{type:e.match(/\${\w+}/gi)?"template":void 0,value:e,expandable:!0}})})),this.getElementSegments(i.length+1,o).then((function(e){e.length>0&&o.push({label:"Select Element",value:{value:"-Select Element-"}})})),Object(y.each)(r,(function(e,t){""!==e&&l.push({label:e,value:{value:e,expandable:!1}})})),this.updateArray(o,l,this.state.summaries,n.isPiPoint,(function(){a(Object.assign(Object.assign({},n),{query:void 0,rawQuery:!1}))}))):(o=this.checkAfServer(),this.updateArray(o,this.state.attributes,this.state.summaries,n.isPiPoint,(function(){e.onChange(Object.assign(Object.assign({},n),{query:void 0,rawQuery:!1,attributes:e.state.attributes,segments:e.state.segments}))})))}},{key:"render",value:function(){var e=this,t=this.props,n=t.query,a=t.onChange,r=t.onRunQuery,i=Object(y.defaults)(n,x),o=i.interpolate,u=i.query,c=i.rawQuery,m=i.digitalStates,h=i.recordedValues,p=i.expression,f=i.isPiPoint,d=i.summary,v=i.display,b=i.regex;return l.a.createElement(l.a.Fragment,null,l.a.createElement(s.InlineField,{label:"Is Pi Point?",labelWidth:24},l.a.createElement(s.InlineSwitch,{value:f,onChange:this.onIsPiPointChange})),!!c&&l.a.createElement(s.InlineFieldRow,null,l.a.createElement(s.InlineField,{label:"Raw Query",labelWidth:24,grow:!0},l.a.createElement(s.Input,{onBlur:this.stateCallback,value:u,onChange:function(e){return a(Object.assign(Object.assign({},i),{query:e.target.value}))},placeholder:"enter query"})),l.a.createElement(k,{isRaw:!0,onChange:function(t){return e.textEditorChanged()}})),!c&&l.a.createElement(l.a.Fragment,null,l.a.createElement("div",{className:"gf-form-inline"},l.a.createElement(I,{label:f?"PI Server":"AF Elements",tooltip:f?"Select PI server.":"Select AF Element."},this.state.segments.map((function(t,n){return l.a.createElement(s.SegmentAsync,{key:"element-"+n,Component:l.a.createElement(q,{value:t.value,label:t.label}),onChange:function(t){return e.onSegmentChange(t,n)},loadOptions:function(t){return e.getElementSegments(n)},allowCustomValue:!0,inputMinWidth:200})})),l.a.createElement(S,null),!f&&l.a.createElement(k,{isRaw:!1,onChange:function(e){a(Object.assign(Object.assign({},i),{query:i.target,rawQuery:e}))}}))),l.a.createElement(E,{label:f?"Pi Points":"Attributes"},this.state.attributes.map((function(t,n){return f?l.a.createElement(s.SegmentAsync,{key:"attributes-"+n,Component:l.a.createElement(q,{value:t.value,label:t.label}),disabled:0===e.piServer.length,onChange:function(t){return e.onPiPointChange(t,n)},loadOptions:e.getAttributeSegmentsPI,reloadOptionsOnChange:!0,allowCustomValue:!0,inputMinWidth:250}):l.a.createElement(s.Segment,{key:"attributes-"+n,Component:l.a.createElement(q,{value:t.value,label:t.label}),disabled:e.state.segments.length<=2,onChange:function(t){return e.onAttributeChange(t,n)},options:e.getAttributeSegmentsAF(),allowCustomValue:!0,inputMinWidth:250})})),f&&l.a.createElement(s.SegmentAsync,{Component:l.a.createElement(q,{value:this.state.attributeSegment.value,label:this.state.attributeSegment.label}),disabled:0===this.piServer.length,onChange:this.onAttributeAction,loadOptions:this.getAttributeSegmentsPI,reloadOptionsOnChange:!0,allowCustomValue:!0,inputMinWidth:250}),!f&&l.a.createElement(s.Segment,{Component:l.a.createElement(q,{value:this.state.attributeSegment.value,label:this.state.attributeSegment.label}),disabled:this.state.segments.length<=2,onChange:this.onAttributeAction,options:this.getAttributeSegmentsAF(),allowCustomValue:!0,inputMinWidth:250}))),!f&&l.a.createElement(s.InlineField,{label:"Calculation",labelWidth:24,tooltip:"Modify all attributes by an equation. Use '.' for current item. Leave Attributes empty if you wish to perform element based calculations."},l.a.createElement(s.Input,{onBlur:r,value:p,onChange:function(t){return e.onChange(Object.assign(Object.assign({},i),{expression:t.target.value}))},placeholder:"'.'*2"})),l.a.createElement(s.InlineFieldRow,null,l.a.createElement(s.InlineField,{label:"Max Recorded Values",labelWidth:24,tooltip:"Maximum number of recorded value to retrive from the data archive, without using interpolation."},l.a.createElement(s.Input,{onBlur:r,value:h.maxNumber,onChange:function(t){return e.onChange(Object.assign(Object.assign({},i),{recordedValues:Object.assign(Object.assign({},h),{maxNumber:parseInt(t.target.value,10)})}))},type:"number",placeholder:"1000"})),l.a.createElement(s.InlineField,{label:"Recorded Values",labelWidth:24},l.a.createElement(s.InlineSwitch,{value:h.enable,onChange:function(){return e.onChange(Object.assign(Object.assign({},i),{recordedValues:Object.assign(Object.assign({},h),{enable:!h.enable})}))}})),l.a.createElement(s.InlineField,{label:"Digital States",labelWidth:24},l.a.createElement(s.InlineSwitch,{value:m.enable,onChange:function(){return e.onChange(Object.assign(Object.assign({},i),{digitalStates:Object.assign(Object.assign({},m),{enable:!m.enable})}))}}))),l.a.createElement(s.InlineFieldRow,null,l.a.createElement(s.InlineField,{label:"Interpolate Period",labelWidth:24,tooltip:"Override time between sampling, e.g. '30s'. Defaults to timespan/chart width."},l.a.createElement(s.Input,{onBlur:r,value:o.interval,onChange:function(t){return e.onChange(Object.assign(Object.assign({},i),{interpolate:Object.assign(Object.assign({},o),{interval:t.target.value})}))},placeholder:"30s"})),l.a.createElement(s.InlineField,{label:"Interpolate",labelWidth:24},l.a.createElement(s.InlineSwitch,{value:o.enable,onChange:function(){return e.onChange(Object.assign(Object.assign({},i),{interpolate:Object.assign(Object.assign({},o),{enable:!o.enable})}))}})),l.a.createElement(s.InlineField,{label:"Replace Bad Data",labelWidth:24,tooltip:"Replacement for bad quality values."},l.a.createElement(s.Segment,{Component:l.a.createElement(q,{value:{value:d.nodata},label:d.nodata}),onChange:this.calcNoDataValueChanged,options:this.getNoDataSegments(),allowCustomValue:!0}))),l.a.createElement(s.InlineFieldRow,null,l.a.createElement(s.InlineField,{label:"Summary Period",labelWidth:24,tooltip:"Override time between sampling, e.g. '30s'."},l.a.createElement(s.Input,{onBlur:r,value:d.interval,onChange:function(e){return a(Object.assign(Object.assign({},i),{summary:Object.assign(Object.assign({},d),{interval:e.target.value})}))},placeholder:"30s"})),l.a.createElement(s.InlineField,{label:"Basis",labelWidth:24,tooltip:"Defines the possible calculation options when performing summary calculations over time-series data."},l.a.createElement(s.Segment,{Component:l.a.createElement(q,{value:{value:d.basis},label:d.basis}),onChange:this.calcBasisValueChanged,options:this.getCalcBasisSegments(),allowCustomValue:!0})),l.a.createElement(s.InlineField,{label:"Summaries",labelWidth:24,tooltip:"Replacement for bad quality values."},l.a.createElement(s.InlineFieldRow,null,this.state.summaries.map((function(t,n){return l.a.createElement(s.Segment,{key:"summaries-"+n,Component:l.a.createElement(q,{value:t.value,label:t.label}),onChange:function(t){return e.onSummaryValueChanged(t,n)},options:e.getSummarySegments(),allowCustomValue:!0})})),l.a.createElement(s.Segment,{Component:l.a.createElement(q,{value:this.state.summarySegment.value,label:this.state.summarySegment.label}),onChange:this.onSummaryAction,options:this.getSummarySegments(),allowCustomValue:!0})))),l.a.createElement(s.InlineFieldRow,null,l.a.createElement(s.InlineField,{label:"Display Name",labelWidth:24,tooltip:"If single attribute, modify display name. Otherwise use regex to modify display name."},l.a.createElement(s.Input,{onBlur:r,value:v,onChange:function(t){return e.onChange(Object.assign(Object.assign({},i),{display:t.target.value}))},placeholder:"Display"})),l.a.createElement(s.InlineField,{label:"Enable Regex Replace",labelWidth:24},l.a.createElement(s.InlineSwitch,{value:b.enable,onChange:function(){e.onChange(Object.assign(Object.assign({},i),{regex:Object.assign(Object.assign({},b),{enable:!b.enable})}))}})),l.a.createElement(s.InlineField,{label:"Search",labelWidth:16},l.a.createElement(s.Input,{onBlur:r,value:b.search,onChange:function(t){return e.onChange(Object.assign(Object.assign({},i),{regex:Object.assign(Object.assign({},b),{search:t.target.value})}))},placeholder:"(.*)"})),l.a.createElement(s.InlineField,{label:"Replace",labelWidth:16},l.a.createElement(s.Input,{onBlur:r,value:b.replace,onChange:function(t){return e.onChange(Object.assign(Object.assign({},i),{regex:Object.assign(Object.assign({},b),{replace:t.target.value})}))},placeholder:"$1"}))))}}])&&F(t.prototype,n),a&&F(t,a),Object.defineProperty(t,"prototype",{writable:!1}),i}(o.PureComponent),G=n(4);function M(e){return(M="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function L(){L=function(){return e};var e={},t=Object.prototype,n=t.hasOwnProperty,a="function"==typeof Symbol?Symbol:{},r=a.iterator||"@@iterator",i=a.asyncIterator||"@@asyncIterator",o=a.toStringTag||"@@toStringTag";function l(e,t,n){return Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{l({},"")}catch(e){l=function(e,t,n){return e[t]=n}}function s(e,t,n,a){var r=t&&t.prototype instanceof m?t:m,i=Object.create(r.prototype),o=new S(a||[]);return i._invoke=function(e,t,n){var a="suspendedStart";return function(r,i){if("executing"===a)throw new Error("Generator is already running");if("completed"===a){if("throw"===r)throw i;return w()}for(n.method=r,n.arg=i;;){var o=n.delegate;if(o){var l=O(o,n);if(l){if(l===c)continue;return l}}if("next"===n.method)n.sent=n._sent=n.arg;else if("throw"===n.method){if("suspendedStart"===a)throw a="completed",n.arg;n.dispatchException(n.arg)}else"return"===n.method&&n.abrupt("return",n.arg);a="executing";var s=u(e,t,n);if("normal"===s.type){if(a=n.done?"completed":"suspendedYield",s.arg===c)continue;return{value:s.arg,done:n.done}}"throw"===s.type&&(a="completed",n.method="throw",n.arg=s.arg)}}}(e,n,o),i}function u(e,t,n){try{return{type:"normal",arg:e.call(t,n)}}catch(e){return{type:"throw",arg:e}}}e.wrap=s;var c={};function m(){}function h(){}function p(){}var f={};l(f,r,(function(){return this}));var d=Object.getPrototypeOf,v=d&&d(d(E([])));v&&v!==t&&n.call(v,r)&&(f=v);var b=p.prototype=m.prototype=Object.create(f);function g(e){["next","throw","return"].forEach((function(t){l(e,t,(function(e){return this._invoke(t,e)}))}))}function y(e,t){var a;this._invoke=function(r,i){function o(){return new t((function(a,o){!function a(r,i,o,l){var s=u(e[r],e,i);if("throw"!==s.type){var c=s.arg,m=c.value;return m&&"object"==M(m)&&n.call(m,"__await")?t.resolve(m.__await).then((function(e){a("next",e,o,l)}),(function(e){a("throw",e,o,l)})):t.resolve(m).then((function(e){c.value=e,o(c)}),(function(e){return a("throw",e,o,l)}))}l(s.arg)}(r,i,a,o)}))}return a=a?a.then(o,o):o()}}function O(e,t){var n=e.iterator[t.method];if(void 0===n){if(t.delegate=null,"throw"===t.method){if(e.iterator.return&&(t.method="return",t.arg=void 0,O(e,t),"throw"===t.method))return c;t.method="throw",t.arg=new TypeError("The iterator does not provide a 'throw' method")}return c}var a=u(n,e.iterator,t.arg);if("throw"===a.type)return t.method="throw",t.arg=a.arg,t.delegate=null,c;var r=a.arg;return r?r.done?(t[e.resultName]=r.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=void 0),t.delegate=null,c):r:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,c)}function j(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function P(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function S(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(j,this),this.reset(!0)}function E(e){if(e){var t=e[r];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var a=-1,i=function t(){for(;++a<e.length;)if(n.call(e,a))return t.value=e[a],t.done=!1,t;return t.value=void 0,t.done=!0,t};return i.next=i}}return{next:w}}function w(){return{value:void 0,done:!0}}return h.prototype=p,l(b,"constructor",p),l(p,"constructor",h),h.displayName=l(p,o,"GeneratorFunction"),e.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===h||"GeneratorFunction"===(t.displayName||t.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,p):(e.__proto__=p,l(e,o,"GeneratorFunction")),e.prototype=Object.create(b),e},e.awrap=function(e){return{__await:e}},g(y.prototype),l(y.prototype,i,(function(){return this})),e.AsyncIterator=y,e.async=function(t,n,a,r,i){void 0===i&&(i=Promise);var o=new y(s(t,n,a,r),i);return e.isGeneratorFunction(n)?o:o.next().then((function(e){return e.done?e.value:o.next()}))},g(b),l(b,o,"Generator"),l(b,r,(function(){return this})),l(b,"toString",(function(){return"[object Generator]"})),e.keys=function(e){var t=[];for(var n in e)t.push(n);return t.reverse(),function n(){for(;t.length;){var a=t.pop();if(a in e)return n.value=a,n.done=!1,n}return n.done=!0,n}},e.values=E,S.prototype={constructor:S,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(P),!e)for(var t in this)"t"===t.charAt(0)&&n.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=void 0)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var t=this;function a(n,a){return o.type="throw",o.arg=e,t.next=n,a&&(t.method="next",t.arg=void 0),!!a}for(var r=this.tryEntries.length-1;r>=0;--r){var i=this.tryEntries[r],o=i.completion;if("root"===i.tryLoc)return a("end");if(i.tryLoc<=this.prev){var l=n.call(i,"catchLoc"),s=n.call(i,"finallyLoc");if(l&&s){if(this.prev<i.catchLoc)return a(i.catchLoc,!0);if(this.prev<i.finallyLoc)return a(i.finallyLoc)}else if(l){if(this.prev<i.catchLoc)return a(i.catchLoc,!0)}else{if(!s)throw new Error("try statement without catch or finally");if(this.prev<i.finallyLoc)return a(i.finallyLoc)}}}},abrupt:function(e,t){for(var a=this.tryEntries.length-1;a>=0;--a){var r=this.tryEntries[a];if(r.tryLoc<=this.prev&&n.call(r,"finallyLoc")&&this.prev<r.finallyLoc){var i=r;break}}i&&("break"===e||"continue"===e)&&i.tryLoc<=t&&t<=i.finallyLoc&&(i=null);var o=i?i.completion:{};return o.type=e,o.arg=t,i?(this.method="next",this.next=i.finallyLoc,c):this.complete(o)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),c},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.finallyLoc===e)return this.complete(n.completion,n.afterLoc),P(n),c}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.tryLoc===e){var a=n.completion;if("throw"===a.type){var r=a.arg;P(n)}return r}}throw new Error("illegal catch attempt")},delegateYield:function(e,t,n){return this.delegate={iterator:E(e),resultName:t,nextLoc:n},"next"===this.method&&(this.arg=void 0),c}},e}function Q(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}function U(e,t){return(U=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e})(e,t)}function $(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,a=z(e);if(t){var r=z(this).constructor;n=Reflect.construct(a,arguments,r)}else n=a.apply(this,arguments);return H(this,n)}}function H(e,t){if(t&&("object"===M(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}function z(e){return(z=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}var J=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&U(e,t)}(o,e);var t,n,r,i=$(o);function o(e){var t,n;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,o),(t=i.call(this,e)).isProxy=!1,t.webidCache=new Map,t.basicAuth=e.basicAuth,t.withCredentials=e.withCredentials,t.url=e.url,t.name=e.name,t.templateSrv=Object(G.getTemplateSrv)(),t.backendSrv=Object(G.getBackendSrv)(),t.piwebapiurl=null===(n=e.jsonData.url)||void 0===n?void 0:n.toString(),t.isProxy=/^http(s)?:\/\//.test(t.url)||"proxy"===e.jsonData.access,t.piserver={name:(e.jsonData||{}).piserver,webid:void 0},t.afserver={name:(e.jsonData||{}).afserver,webid:void 0},t.afdatabase={name:(e.jsonData||{}).afdatabase,webid:void 0},Promise.all([t.getAssetServer(t.afserver.name).then((function(e){return t.afserver.webid=e.WebId})),t.getDataServer(t.piserver.name).then((function(e){return t.piserver.webid=e.WebId})),t.getDatabase(t.afserver.name?t.afserver.name+"\\"+t.afdatabase.name:void 0).then((function(e){return t.afdatabase.webid=e.WebId}))]),t}return t=o,(n=[{key:"eventFrameToAnnotation",value:function(e,t,n,a){e.regex&&e.regex.enable&&(n.Name=n.Name.replace(new RegExp(e.regex.search),e.regex.replace));var r="";return a&&Object(y.each)(a,(function(e){var t=e.Value.Value?e.Value.Value.Name||e.Value.Value.Value||e.Value.Value:null;r+="<br />"+e.Name+": "+t})),{annotation:e,title:(t?"END ":e.showEndTime?"START ":"")+e.name,time:new Date(t?n.EndTime:n.StartTime).getTime(),text:n.Name+r+"<br />Start: "+n.StartTime+"<br />End: "+n.EndTime}}},{key:"buildQueryParameters",value:function(e){var t=this;return e.targets=Object(y.filter)(e.targets,(function(e){return!(!e||!e.target||e.target.startsWith("Select AF"))})),e.targets=Object(y.map)(e.targets,(function(n){var a=t,r={target:t.templateSrv.replace(n.elementPath,e.scopedVars),elementPath:t.templateSrv.replace(n.elementPath,e.scopedVars),elementPathArray:[{path:t.templateSrv.replace(n.elementPath,e.scopedVars),variable:""}],attributes:Object(y.map)(n.attributes,(function(n){var a;return t.templateSrv.replace((null===(a=n.value)||void 0===a?void 0:a.value)||n,e.scopedVars)})),segments:Object(y.map)(n.segments,(function(n){var a;return t.templateSrv.replace(null===(a=n.value)||void 0===a?void 0:a.value,e.scopedVars)})),display:n.display,refId:n.refId,hide:n.hide,interpolate:n.interpolate||{enable:!1},recordedValues:n.recordedValues||{enable:!1},digitalStates:n.digitalStates||{enable:!1},webid:n.webid,webids:n.webids||[],regex:n.regex||{enable:!1},expression:n.expression||"",summary:n.summary||{types:[]},startTime:e.range.from,endTime:e.range.to,isPiPoint:n.isPiPoint,scopedVars:e.scopedVars};r.expression&&(r.expression=t.templateSrv.replace(r.expression,e.scopedVars)),void 0!==r.summary.types&&(r.summary.types=Object(y.filter)(r.summary.types,(function(e){return null!=e&&""!==e})));var i=Object(y.keys)(e.scopedVars);return t.templateSrv.getVariables().forEach((function(e){if(a.isAllSelected(e.current)&&i.indexOf(e.name)<0){var t=e.options.filter((function(e){return!e.selected}));r.attributes=r.attributes.map((function(n){return t.map((function(t){return e.allValue?n.replace(e.allValue,t.value):n.replace(/{[a-zA-z0-9,-_]+}/gi,t.value)}))})),r.attributes=Object(y.uniq)(Object(y.flatten)(r.attributes)),r.elementPathArray=a.getElementPath(r.elementPathArray,t,e.allValue)}else if(Array.isArray(e.current.text)&&i.indexOf(e.name)<0){var n=e.options.filter((function(e){return e.selected})),o=e.current.value.join(",");r.attributes=r.attributes.map((function(e){return n.map((function(t){return e.replace("{".concat(o,"}"),t.value)}))})),r.attributes=Object(y.uniq)(Object(y.flatten)(r.attributes)),r.elementPathArray=a.getElementPath(r.elementPathArray,n,"{".concat(o,"}"))}})),r})),e}},{key:"query",value:function(e){return j(this,void 0,void 0,L().mark((function t(){var n,r;return L().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(n=this,(r=this.buildQueryParameters(e)).targets=Object(y.filter)(r.targets,(function(e){return!e.hide})),!(r.targets.length<=0)){t.next=7;break}return t.abrupt("return",Promise.resolve({data:[]}));case 7:return t.abrupt("return",Promise.all(n.getStream(r)).then((function(e){var t=[];return Object(y.each)(e,(function(e){Object(y.each)(e,(function(e){return t.push(e)}))})),{data:t.sort((function(e,t){return+(e.target>t.target)||+(e.target===t.target)-1})).map((function(e){return Object(a.toDataFrame)(e)}))}})));case 8:case"end":return t.stop()}}),t,this)})))}},{key:"testDatasource",value:function(){return this.backendSrv.datasourceRequest({url:this.url+"/",method:"GET"}).then((function(e){if(200===e.status)return{status:"success",message:"Data source is working",title:"Success"};throw new Error("Failed")}))}},{key:"annotationQuery",value:function(e){var t=this;if(!this.afdatabase.webid)return Promise.resolve([]);var n=e.annotation.query.categoryName?this.templateSrv.replace(e.annotation.query.categoryName,e.scopedVars,"glob"):null,a=e.annotation.query.nameFilter?this.templateSrv.replace(e.annotation.query.nameFilter,e.scopedVars,"glob"):null,r=e.annotation.template?e.annotation.template.Name:null,i={name:e.annotation.name,datasource:e.annotation.datasource,enable:e.annotation.enable,iconColor:e.annotation.iconColor,showEndTime:e.annotation.showEndTime,regex:e.annotation.regex,attribute:e.annotation.attribute,categoryName:n,templateName:r,nameFilter:a},o=[];if(i.categoryName&&o.push("categoryName="+i.categoryName),i.nameFilter&&o.push("nameFilter="+i.nameFilter),i.templateName&&o.push("templateName="+i.templateName),!o.length)return Promise.resolve([]);if(o.push("startTime="+e.range.from.toJSON()),o.push("endTime="+e.range.to.toJSON()),i.attribute&&i.attribute.enable){var l=this.piwebapiurl+"/streamsets/{0}/value?selectedFields=Items.WebId%3BItems.Value%3BItems.Name";i.attribute.name&&(l=this.piwebapiurl+"/streamsets/{0}/value?nameFilter="+i.attribute.name+"&selectedFields=Items.WebId%3BItems.Value%3BItems.Name");var s={};return s[1]={Method:"GET",Resource:this.piwebapiurl+"/assetdatabases/"+this.afdatabase.webid+"/eventframes?"+o.join("&")},s[2]={Method:"GET",RequestTemplate:{Resource:l},Parameters:["$.1.Content.Items[*].WebId"],ParentIds:["1"]},this.restBatch(s).then((function(n){var a=n.data[1].Content,r=n.data[2].Content,o=Object(y.map)(a.Items,(function(e,n){return Object(y.curry)(t.eventFrameToAnnotation)(i,!1,e,r.Items[n].Content.Items)}));if(e.annotation.showEndTime){var l=Object(y.map)(a.Items,(function(e,n){return Object(y.curry)(t.eventFrameToAnnotation)(i,!0,e,r.Items[n].Content.Items)}));Object(y.each)(l,(function(e){o.push(e)}))}return o}))}return this.restGet("/assetdatabases/"+this.afdatabase.webid+"/eventframes?"+o.join("&")).then((function(n){var a=Object(y.map)(n.data.Items,Object(y.curry)(t.eventFrameToAnnotation)(i,!1));if(e.annotation.showEndTime){var r=Object(y.map)(n.data.Items,Object(y.curry)(t.eventFrameToAnnotation)(i,!0));Object(y.each)(r,(function(e){a.push(e)}))}return a}))}},{key:"metricQueryTransform",value:function(e){return Object(y.map)(e,(function(e){var t,n;return{text:e.Name,expandable:void 0===e.HasChildren||!0===e.HasChildren||(null!==(t=e.Path)&&void 0!==t?t:"").split("\\").length<=3,HasChildren:e.HasChildren,Items:null!==(n=e.Items)&&void 0!==n?n:[],Path:e.Path,WebId:e.WebId}}))}},{key:"metricFindQuery",value:function(e,t){var n,a,r=this,i=["servers","databases","databaseElements","elements"];return"string"==typeof e&&(e=JSON.parse(e)),t.isPiPoint?e.path=this.templateSrv.replace(e.path,t):(""===e.path?e.type=i[0]:"attributes"!==e.type&&(e.type=i[Math.max(0,Math.min(e.path.split("\\").length,i.length-1))]),e.path=this.templateSrv.replace(e.path,t),e.path=e.path.replace(/\{([^\\])*\}/gi,(function(e){return e.substring(1,e.length-2).split(",")[0]}))),e.filter=null!==(n=e.filter)&&void 0!==n?n:"*","servers"===e.type?(null===(a=r.afserver)||void 0===a?void 0:a.name)?r.getAssetServer(r.afserver.name).then((function(e){return[e]})).then(r.metricQueryTransform):r.getAssetServers().then(r.metricQueryTransform):"databases"===e.type?r.getAssetServer(e.path).then((function(e){var t;return r.getDatabases(null!==(t=e.WebId)&&void 0!==t?t:"",{})})).then(r.metricQueryTransform):"databaseElements"===e.type?r.getDatabase(e.path).then((function(e){var t;return r.getDatabaseElements(null!==(t=e.WebId)&&void 0!==t?t:"",{selectedFields:"Items.WebId%3BItems.Name%3BItems.Items%3BItems.Path%3BItems.HasChildren"})})).then(r.metricQueryTransform):"elements"===e.type?r.getElement(e.path).then((function(t){var n;return r.getElements(null!==(n=t.WebId)&&void 0!==n?n:"",{selectedFields:"Items.WebId%3BItems.Name%3BItems.Items%3BItems.Path%3BItems.HasChildren",nameFilter:e.filter})})).then(r.metricQueryTransform):"attributes"===e.type?r.getElement(e.path).then((function(t){var n;return r.getAttributes(null!==(n=t.WebId)&&void 0!==n?n:"",{searchFullHierarchy:"true",selectedFields:"Items.WebId%3BItems.Name%3BItems.Path",nameFilter:e.filter})})).then(r.metricQueryTransform):"dataserver"===e.type?r.getDataServers().then(r.metricQueryTransform):"pipoint"===e.type?r.piPointSearch(e.webId,e.pointName).then(r.metricQueryTransform):Promise.reject("Bad type")}},{key:"getSummaryUrl",value:function(e){return""===e.interval.trim()?"&summaryType="+e.types.map((function(e){var t;return null===(t=e.value)||void 0===t?void 0:t.value})).join("&summaryType=")+"&calculationBasis="+e.basis:"&summaryType="+e.types.map((function(e){var t;return null===(t=e.value)||void 0===t?void 0:t.value})).join("&summaryType=")+"&calculationBasis="+e.basis+"&summaryDuration="+e.interval.trim()}},{key:"parsePiPointValueList",value:function(e,t,n){var a=this,r=this,i=[];return Object(y.each)(e,(function(e){var o=a.noDataReplace(n?e.Value:e,t.summary.nodata,r.parsePiPointValue(n?e.Value:e,t,n)),l=o.grafanaDataPoint;o.previousValue,o.drop||i.push(l)})),i}},{key:"parsePiPointValue",value:function(e,t,n){var a,r,i=n||"object"!==M(e.Value)?e.Value:null===(a=e.Value)||void 0===a?void 0:a.Value;return!e.Good||(null===(r=t.digitalStates)||void 0===r?void 0:r.enable)?[(i=n||"object"!==M(e.Value)?e.Name:e.Value.Name).trim(),new Date(e.Timestamp).getTime()]:[this.checkNumber(i)?Number(i):i.trim(),new Date(e.Timestamp).getTime()]}},{key:"noDataReplace",value:function(e,t,n){var a,r,i=null,o=!1;return!e.Good||"No Data"===e.Value||(null===(a=e.Value)||void 0===a?void 0:a.Name)&&"No Data"===(null===(r=e.Value)||void 0===r?void 0:r.Name)?"Drop"===t?o=!0:"0"===t?n[0]=0:"Keep"===t||("Null"===t?n[0]=null:"Previous"===t&&null!==i&&(n[0]=i)):i=e.Value,{grafanaDataPoint:n,previousValue:i,drop:o}}},{key:"processResults",value:function(e,t,n,a){var r=this,i=t.summary&&t.summary.types&&t.summary.types.length>0;if(n=a?n:this.getPath(t.elementPathArray,e.Path)+"|"+n,t.regex&&t.regex.enable&&t.regex.search.length&&t.regex.replace.length&&(n=n.replace(new RegExp(t.regex.search),t.regex.replace)),i){var o=[],l=Object(y.groupBy)(e.Items,(function(e){return e.Type}));return Object(y.forOwn)(l,(function(e,a){o.push({refId:t.refId,target:n+"["+a+"]",datapoints:r.parsePiPointValueList(e,t,i)})})),o}return[{refId:t.refId,target:n,datapoints:r.parsePiPointValueList(e.Items,t,i)}]}},{key:"isAllSelected",value:function(e){return!!e&&(Array.isArray(e.text)?e.text.indexOf("All")>=0:"All"===e.text)}},{key:"checkNumber",value:function(e){return"number"==typeof e&&!Number.isNaN(e)&&Number.isFinite(e)}},{key:"getElementPath",value:function(e,t,n){var a=[];return e.forEach((function(e){if(n&&e.path.indexOf(n)>=0||!n&&e.path.match(/{[a-zA-z0-9,-_]+}/gi)){var r=t.map((function(t){return{path:n?e.path.replace(n,t.value):e.path.replace(/{[a-zA-z0-9,-_]+}/gi,t.value),variable:t.value}}));a=a.concat(r)}})),a.length?Object(y.uniq)(Object(y.flatten)(a)):e}},{key:"getPath",value:function(e,t){var n,a,r=t.split("|");if(0===r.length)return"";if(0===e.length)return"";var i=0===(r=r[0].split("\\")).length?"":null!==(n=r.pop())&&void 0!==n?n:"",o=null===(a=e.find((function(e){return t.indexOf(e.path)>=0})))||void 0===a?void 0:a.variable;return o?o+"|"+i:i}},{key:"getStream",value:function(e){var t=this,n=this,a=[];return Object(y.each)(e.targets,(function(r){r.attributes=Object(y.filter)(r.attributes||[],(function(e){return e}));var i="",o=r.summary&&r.summary.types&&r.summary.types.length>0,l=r.interpolate&&r.interpolate.enable,s=r.interpolate.interval?r.interpolate.interval:e.interval,u="?startTime="+e.range.from.toJSON()+"&endTime="+e.range.to.toJSON(),c=r.expression||r.elementPath,m=r.display?t.templateSrv.replace(r.display,e.scopedVars):null;if(r.expression)i+="/calculation",i+=o?"/summary"+u+(l?"&sampleType=Interval&sampleInterval="+s:""):"/intervals"+u+"&sampleInterval="+s,i+="&expression="+encodeURIComponent(r.expression),r.attributes.length>0?a.push(n.internalStream(e,r,i)):a.push(n.restGetWebId(r.elementPath,r.isPiPoint).then((function(e){return n.restPost(i+e.WebId).then((function(e){return n.processResults(e.data,r,m||c,!1)})).catch((function(e){return n.error=e}))})));else{if(i+="/streamsets",o)i+="/summary"+u+"&intervals="+e.maxDataPoints+t.getSummaryUrl(r.summary);else if(r.interpolate&&r.interpolate.enable)i+="/interpolated"+u+"&interval="+s;else if(r.recordedValues&&r.recordedValues.enable){var h=r.recordedValues.maxNumber&&!isNaN(r.recordedValues.maxNumber)?r.recordedValues.maxNumber:1e3;i+="/recorded"+u+"&maxCount="+h}else i+="/plot"+u+"&intervals="+e.maxDataPoints;a.push(n.internalStream(e,r,i))}})),a}},{key:"internalStream",value:function(e,t,n){var a=this,r=t.expression||t.elementPath,i=t.display?this.templateSrv.replace(t.display,e.scopedVars):null,o=1===t.elementPathArray.length&&t.elementPath===t.elementPathArray[0].path;return(o?t.attributes.length>1?a.restGetWebId(t.elementPath,t.isPiPoint).then((function(e){return a.getAttributes(e.WebId,{searchFullHierarchy:"true",nameFilter:"*"})})).then((function(e){return e.filter((function(e){var n;return t.attributes.indexOf(e.Name)>=0||t.attributes.indexOf(null===(n=e.Path)||void 0===n?void 0:n.split("|").splice(1).join("|"))>=0}))})):Promise.all(Object(y.map)(t.attributes,(function(e){return a.restGetWebId(t.elementPath+"|"+e,t.isPiPoint)}))):t.attributes.length>1?Promise.all(t.elementPathArray.map((function(e){return a.restGetWebId(e.path,t.isPiPoint).then((function(e){return a.getAttributes(e.WebId,{searchFullHierarchy:"true",nameFilter:"*"})})).then((function(e){return e.filter((function(e){var n;return t.attributes.indexOf(e.Name)>=0||t.attributes.indexOf(null===(n=e.Path)||void 0===n?void 0:n.split("|").splice(1).join("|"))>=0}))}))}))):Promise.all(Object(y.flatten)(Object(y.map)(t.attributes,(function(e){return t.elementPathArray.map((function(n){return a.restGetWebId(n.path+"|"+e,t.isPiPoint)}))}))))).then((function(e){var l={};return Object(y.each)(Object(y.flatten)(e),(function(e,t){l[t+1]={Method:"GET",Resource:a.piwebapiurl+n+"&webid="+e.WebId}})),a.restBatch(l).then((function(n){var l=[];return Object(y.each)(n.data,(function(n,s){if(t.expression){var u=e[parseInt(s,10)-1].Name;Object(y.each)(a.processResults(n.Content,t,i||u||r,o),(function(e){return l.push(e)}))}else Object(y.each)(n.Content.Items,(function(e){Object(y.each)(a.processResults(e,t,i||e.Name||r,o),(function(e){return l.push(e)}))}))})),l})).catch((function(e){return a.error=e}))}))}},{key:"restGet",value:function(e){return this.backendSrv.datasourceRequest({url:this.url+e,method:"GET",headers:{"Content-Type":"application/json"}}).then((function(e){return e}))}},{key:"restGetWebId",value:function(e,t){var n=this,a=n.webidCache.get(e);if(a)return Promise.resolve({Path:e,WebId:a.WebId,Name:a.Name});var r="";return r=t?"/points?selectedFields=WebId%3BName%3BPath&path=\\\\"+e.replace("|","\\"):(e.indexOf("|")>=0?"/attributes?selectedFields=WebId%3BName%3BPath&path=\\\\":"/elements?selectedFields=WebId%3BName%3BPath&path=\\\\")+e,this.backendSrv.datasourceRequest({url:this.url+r,method:"GET",headers:{"Content-Type":"application/json"}}).then((function(t){return n.webidCache.set(e,t.data),{Path:e,WebId:t.data.WebId,Name:t.data.Name}}))}},{key:"restBatch",value:function(e){return this.backendSrv.datasourceRequest({url:this.url+"/batch",data:e,method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"message/http"}})}},{key:"restPost",value:function(e){return this.backendSrv.datasourceRequest({url:this.url,method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"message/http","X-PIWEBAPI-HTTP-METHOD":"GET","X-PIWEBAPI-RESOURCE-ADDRESS":e}})}},{key:"getDataServers",value:function(){return this.restGet("/dataservers").then((function(e){var t;return null!==(t=e.data.Items)&&void 0!==t?t:[]}))}},{key:"getDataServer",value:function(e){return e?this.restGet("/dataservers?name="+e).then((function(e){return e.data})):Promise.resolve({})}},{key:"getAssetServers",value:function(){return this.restGet("/assetservers").then((function(e){var t;return null!==(t=e.data.Items)&&void 0!==t?t:[]}))}},{key:"getAssetServer",value:function(e){return e?this.restGet("/assetservers?path=\\\\"+e).then((function(e){return e.data})):Promise.resolve({})}},{key:"getDatabase",value:function(e){return e?this.restGet("/assetdatabases?path=\\\\"+e).then((function(e){return e.data})):Promise.resolve({})}},{key:"getDatabases",value:function(e,t){return e?this.restGet("/assetservers/"+e+"/assetdatabases").then((function(e){var t;return null!==(t=e.data.Items)&&void 0!==t?t:[]})):Promise.resolve([])}},{key:"getElement",value:function(e){return e?this.restGet("/elements?path=\\\\"+e).then((function(e){return e.data})):Promise.resolve({})}},{key:"getEventFrameTemplates",value:function(e){return e?this.restGet("/assetdatabases/"+e+"/elementtemplates?selectedFields=Items.InstanceType%3BItems.Name%3BItems.WebId").then((function(e){var t;return Object(y.filter)(null!==(t=e.data.Items)&&void 0!==t?t:[],(function(e){return"EventFrame"===e.InstanceType}))})):Promise.resolve([])}},{key:"getElementTemplates",value:function(e){return e?this.restGet("/assetdatabases/"+e+"/elementtemplates?selectedFields=Items.InstanceType%3BItems.Name%3BItems.WebId").then((function(e){var t;return Object(y.filter)(null!==(t=e.data.Items)&&void 0!==t?t:[],(function(e){return"Element"===e.InstanceType}))})):Promise.resolve([])}},{key:"getAttributes",value:function(e,t){var n="?"+Object(y.map)(t,(function(e,t){return t+"="+e})).join("&");return"?"===n&&(n=""),this.restGet("/elements/"+e+"/attributes"+n).then((function(e){var t;return null!==(t=e.data.Items)&&void 0!==t?t:[]}))}},{key:"getDatabaseElements",value:function(e,t){var n="?"+Object(y.map)(t,(function(e,t){return t+"="+e})).join("&");return"?"===n&&(n=""),this.restGet("/assetdatabases/"+e+"/elements"+n).then((function(e){var t;return null!==(t=e.data.Items)&&void 0!==t?t:[]}))}},{key:"getElements",value:function(e,t){var n="?"+Object(y.map)(t,(function(e,t){return t+"="+e})).join("&");return"?"===n&&(n=""),this.restGet("/elements/"+e+"/elements"+n).then((function(e){var t;return null!==(t=e.data.Items)&&void 0!==t?t:[]}))}},{key:"piPointSearch",value:function(e,t){var n=this.templateSrv.replace(t),a="".concat(n),r=!1;if(n!==t)for(var i,o=/\{(\w|,)+\}/g;null!==(i=o.exec(n));)i.index===o.lastIndex&&o.lastIndex++,i.forEach((function(e,t){0===t&&(n=n.replace(e,e.replace("{","(").replace("}",")").replace(",","|")),a=a.replace(e,"*"),r=!0)}));return this.restGet("/dataservers/"+e+"/points?maxCount=20&nameFilter="+a).then((function(e){var t;return e&&(null===(t=e.data)||void 0===t?void 0:t.Items)?r?e.data.Items.filter((function(e){var t;return null===(t=e.Name)||void 0===t?void 0:t.match(n)})):e.data.Items:[]}))}},{key:"getWebId",value:function(e){var t=e.target.indexOf("\\")>=0,n=e.target.indexOf("|")>=0;return t||-1!==e.target.indexOf(".")?t?t&&n?this.restGet("/attributes?path=\\\\"+e.target).then((function(t){return void 0===t.data||200!==t.status?[{WebId:e.target,Name:e.display||e.target}]:(t.data.Name=e.display||t.data.Name,[t.data])})):this.restGet("/elements?path=\\\\"+e.target).then((function(t){return void 0===t.data||200!==t.status?[{WebId:e.target,Name:e.display||e.target}]:(t.data.Name=e.display||t.data.Name,[t.data])})):this.piPointSearch(this.piserver.webid,e.target).then((function(t){return void 0===t||0===t.length?[{WebId:e.target,Name:e.display||e.target}]:t})):Promise.resolve([{WebId:e.target,Name:e.display||e.target}])}}])&&Q(t.prototype,n),r&&Q(t,r),Object.defineProperty(t,"prototype",{writable:!1}),o}(a.DataSourceApi);n.d(t,"plugin",(function(){return X}));var X=new a.DataSourcePlugin(J).setConfigEditor(g).setQueryEditor(_).setAnnotationQueryCtrl(i)}])}));
//# sourceMappingURL=module.js.map