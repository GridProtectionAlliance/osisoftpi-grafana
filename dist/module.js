/*! For license information please see module.js.LICENSE.txt */
define(["@grafana/data","@grafana/runtime","@grafana/ui","lodash","react","rxjs"],((e,t,n,a,r,i)=>(()=>{"use strict";var l=[e=>{e.exports=r},e=>{e.exports=n},t=>{t.exports=e},e=>{e.exports=a},,e=>{e.exports=i},e=>{e.exports=t}],o={};function u(e){var t=o[e];if(void 0!==t)return t.exports;var n=o[e]={exports:{}};return l[e](n,n.exports,u),n.exports}u.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return u.d(t,{a:t}),t},u.d=(e,t)=>{for(var n in t)u.o(t,n)&&!u.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},u.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),u.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var s={};return(()=>{u.r(s),u.d(s,{plugin:()=>Ae});var e,t,n=u(2),a=u(0),r=u.n(a),i=u(1);function l(e){return l="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},l(e)}function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function c(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}function m(e,t){return m=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},m(e,t)}function p(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,a=h(e);if(t){var r=h(this).constructor;n=Reflect.construct(a,arguments,r)}else n=a.apply(this,arguments);return f(this,n)}}function f(e,t){if(t&&("object"===l(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return d(e)}function d(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function h(e){return h=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},h(e)}function v(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function g(){return g=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var a in n)Object.prototype.hasOwnProperty.call(n,a)&&(e[a]=n[a])}return e},g.apply(this,arguments)}var b,y,P=i.LegacyForms.FormField,E=function(e){return g({},e,{jsonData:g({},e.jsonData,{url:e.url})})},S=function(n){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&m(e,t)}(f,n);var a,l,u,s=p(f);function f(){var e;o(this,f);for(var t=arguments.length,n=new Array(t),a=0;a<t;a++)n[a]=arguments[a];return v(d(e=s.call.apply(s,[this].concat(n))),"onPIServerChange",(function(t){var n=e.props,a=n.onOptionsChange,r=n.options,i=g({},r.jsonData,{piserver:t.target.value});a(g({},r,{jsonData:i}))})),v(d(e),"onAFServerChange",(function(t){var n=e.props,a=n.onOptionsChange,r=n.options,i=g({},r.jsonData,{afserver:t.target.value});a(g({},r,{jsonData:i}))})),v(d(e),"onAFDatabaseChange",(function(t){var n=e.props,a=n.onOptionsChange,r=n.options,i=g({},r.jsonData,{afdatabase:t.target.value});a(g({},r,{jsonData:i}))})),v(d(e),"onHttpOptionsChange",(function(t){(0,e.props.onOptionsChange)(E(t))})),v(d(e),"onPiPointChange",(function(t){var n=e.props,a=n.onOptionsChange,r=n.options,i=g({},r.jsonData,{piserver:t.target.checked?r.jsonData.piserver:"",pipoint:t.target.checked});a(g({},r,{jsonData:i}))})),v(d(e),"onNewFormatChange",(function(t){var n=e.props,a=n.onOptionsChange,r=n.options,i=g({},r.jsonData,{newFormat:t.target.checked});a(g({},r,{jsonData:i}))})),v(d(e),"onUseUnitChange",(function(t){var n=e.props,a=n.onOptionsChange,r=n.options,i=g({},r.jsonData,{useUnit:t.target.checked});a(g({},r,{jsonData:i}))})),e}return a=f,(l=[{key:"render",value:function(){var n=this.props.options,a=E(n);return r().createElement("div",null,r().createElement(i.DataSourceHttpSettings,{defaultUrl:"https://server.name/piwebapi",dataSourceConfig:a,onChange:this.onHttpOptionsChange,showAccessOptions:!0}),e||(e=r().createElement("h3",{className:"page-heading"},"Custom Configuration")),r().createElement("div",{className:"gf-form-group"},r().createElement("div",{className:"gf-form-inline"},r().createElement(i.InlineField,{label:"Enable PI Points in Query",labelWidth:24},r().createElement(i.InlineSwitch,{value:a.jsonData.pipoint,onChange:this.onPiPointChange}))),r().createElement("div",{className:"gf-form-inline"},r().createElement(i.InlineField,{label:"Enable New Data Format",labelWidth:24},r().createElement(i.InlineSwitch,{value:a.jsonData.newFormat,onChange:this.onNewFormatChange}))),r().createElement("div",{className:"gf-form-inline"},r().createElement(i.InlineField,{label:"Enable Unit in Data",labelWidth:24},r().createElement(i.InlineSwitch,{value:a.jsonData.useUnit,onChange:this.onUseUnitChange})))),t||(t=r().createElement("h3",{className:"page-heading"},"PI/AF Connection Details")),r().createElement("div",{className:"gf-form-group"},a.jsonData.pipoint&&r().createElement("div",{className:"gf-form"},r().createElement(P,{label:"PI Server",labelWidth:10,inputWidth:25,onChange:this.onPIServerChange,value:a.jsonData.piserver||"",placeholder:"Default PI Server to use for data requests"})),r().createElement("div",{className:"gf-form"},r().createElement(P,{label:"AF Server",labelWidth:10,inputWidth:25,onChange:this.onAFServerChange,value:a.jsonData.afserver||"",placeholder:"Default AF Server to use for data requests"})),r().createElement("div",{className:"gf-form"},r().createElement(P,{label:"AF Database",labelWidth:10,inputWidth:25,onChange:this.onAFDatabaseChange,value:a.jsonData.afdatabase||"",placeholder:"Default AF Database server for AF queries"}))))}}])&&c(a.prototype,l),u&&c(a,u),Object.defineProperty(a,"prototype",{writable:!1}),f}(a.PureComponent),w=u(3);function I(){return I=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var a in n)Object.prototype.hasOwnProperty.call(n,a)&&(e[a]=n[a])}return e},I.apply(this,arguments)}var C=function(e){var t=e.label,n=e.labelWidth,a=void 0===n?12:n,l=e.tooltip,o=e.children;return r().createElement(r().Fragment,null,r().createElement(i.InlineFormLabel,{width:a,tooltip:l},t),o)},x=function(){return b||(b=r().createElement("div",{className:"gf-form gf-form--grow"},r().createElement("div",{className:"gf-form-label gf-form-label--grow"})))},O=function(e){var t=I({},e);return r().createElement(A,null,r().createElement(C,t))},A=function(e){return r().createElement("div",{className:"gf-form-inline"},e.children,y||(y=r().createElement(x,null)))},F=function(e){var t=I({},e);return r().createElement(D,null,r().createElement(C,t))},D=function(e){return r().createElement(r().Fragment,null,e.children)},j={target:";",attributes:[],segments:[],regex:{enable:!1},summary:{types:[],basis:"EventWeighted",interval:"",nodata:"Null"},expression:"",interpolate:{enable:!1},useLastValue:{enable:!1},recordedValues:{enable:!1},digitalStates:{enable:!1},useUnit:{enable:!1},isPiPoint:!1};function N(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null==n)return;var a,r,i=[],l=!0,o=!1;try{for(n=n.call(e);!(l=(a=n.next()).done)&&(i.push(a.value),!t||i.length!==t);l=!0);}catch(e){o=!0,r=e}finally{try{l||null==n.return||n.return()}finally{if(o)throw r}}return i}(e,t)||function(e,t){if(!e)return;if("string"==typeof e)return T(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return T(e,t)}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function T(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,a=new Array(t);n<t;n++)a[n]=e[n];return a}var V,k,W=function(e){var t=e.isRaw,n=e.onChange,l=N((0,a.useState)(!1),2),o=l[0],u=l[1];return(0,a.useEffect)((function(){u(!1)}),[t]),t?r().createElement(r().Fragment,null,r().createElement(i.Button,{"aria-label":"Switch to visual editor",icon:"pen",variant:"secondary",type:"button",onClick:function(){u(!0)}}),r().createElement(i.ConfirmModal,{isOpen:o,title:"Switch to visual editor mode",body:"Are you sure to switch to visual editor mode? You will lose the changes done in raw query mode.",confirmText:"Yes, switch to editor mode",dismissText:"No, stay in raw query mode",onConfirm:function(){n(!1)},onDismiss:function(){u(!1)}})):r().createElement(i.Button,{"aria-label":"Switch to text editor",icon:"pen",variant:"secondary",type:"button",onClick:function(){n(!0)}})};function B(e){return B="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},B(e)}function R(){return R=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var a in n)Object.prototype.hasOwnProperty.call(n,a)&&(e[a]=n[a])}return e},R.apply(this,arguments)}function q(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}function _(e,t){return _=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},_(e,t)}function U(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,a=M(e);if(t){var r=M(this).constructor;n=Reflect.construct(a,arguments,r)}else n=a.apply(this,arguments);return L(this,n)}}function L(e,t){if(t&&("object"===B(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return G(e)}function G(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function M(e){return M=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},M(e)}function Q(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var H=24,$=250,J="-REMOVE-",X=function(e){var t;return e.value?r().createElement("div",{className:"gf-form-label ".concat("template"===e.value.type?"query-keyword":"")},null!==(t=e.label)&&void 0!==t?t:"--no label--"):V||(V=r().createElement("a",{className:"gf-form-label query-part"},r().createElement(i.Icon,{name:"plus"})))},Y=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&_(e,t)}(o,e);var t,n,a,l=U(o);function o(e){var t;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,o),Q(G(t=l.call(this,e)),"error",void 0),Q(G(t),"piServer",[]),Q(G(t),"availableAttributes",{}),Q(G(t),"summaryTypes",void 0),Q(G(t),"calculationBasis",void 0),Q(G(t),"noDataReplacement",void 0),Q(G(t),"state",{isPiPoint:!1,segments:[],attributes:[],summaries:[],attributeSegment:{},summarySegment:{},calculationBasisSegment:{},noDataReplacementSegment:{}}),Q(G(t),"segmentChangeValue",(function(e){var n=t.props.query;t.setState({segments:e},(function(){return t.onChange(R({},n,{segments:e}))}))})),Q(G(t),"attributeChangeValue",(function(e){var n=t.props.query;t.setState({attributes:e},(function(){return t.onChange(R({},n,{attributes:e}))}))})),Q(G(t),"onPiPointChange",(function(e,n){var a=t.state.attributes.slice(0);e.label===J?(0,w.remove)(a,(function(e,t){return t===n})):a[n]=e,t.checkPiPointSegments(e,a)})),Q(G(t),"onAttributeChange",(function(e,n){var a,r=t.state.attributes.slice(0);r[n].label!==(null===(a=e.value)||void 0===a?void 0:a.value)&&(r[n]=e,t.checkAttributeSegments(r,t.state.segments))})),Q(G(t),"onSegmentChange",(function(e,n){var a,r=t.props.query,i=t.state.segments.slice(0);i[n].label!==(null===(a=e.value)||void 0===a?void 0:a.value)&&t.setState({attributes:[]},(function(){return e.label===J?(i=(0,w.slice)(i,0,n),void t.checkAttributeSegments([],i).then((function(){var e;0===i.length?i.push({label:""}):null!==(e=i[i.length-1].value)&&void 0!==e&&e.expandable&&i.push({label:"Select Element",value:{value:"-Select Element-"}}),r.isPiPoint&&(t.piServer=[]),t.segmentChangeValue(i)}))):(i[n]=e,r.isPiPoint?(t.piServer.push(e),void t.segmentChangeValue(i)):(n<i.length-1&&(i=(0,w.slice)(i,0,n+1)),void t.checkAttributeSegments([],i).then((function(){var n;null!==(n=e.value)&&void 0!==n&&n.expandable&&i.push({label:"Select Element",value:{value:"-Select Element-"}}),t.segmentChangeValue(i)}))))}))})),Q(G(t),"getElementSegments",(function(e,n){var a,r,i=t.props,l=i.datasource,o=i.query,u=i.data,s=G(t),c=o.isPiPoint?{type:"dataserver"}:{path:t.getSegmentPathUpTo(null!=n?n:t.state.segments.slice(0),e),afServerWebId:t.state.segments.length>0&&t.state.segments[0].value?t.state.segments[0].value.webId:void 0};if(!o.isPiPoint){var m,p,f;if(null!==(m=l.afserver)&&void 0!==m&&m.name&&0===e)return Promise.resolve([{label:l.afserver.name,value:{value:l.afserver.name,expandable:!0}}]);if(null!==(p=l.afserver)&&void 0!==p&&p.name&&null!==(f=l.afdatabase)&&void 0!==f&&f.name&&1===e)return Promise.resolve([{label:l.afdatabase.name,value:{value:l.afdatabase.name,expandable:!0}}])}return l.metricFindQuery(c,Object.assign(null!==(a=null==u||null===(r=u.request)||void 0===r?void 0:r.scopedVars)&&void 0!==a?a:{},{isPiPoint:o.isPiPoint})).then((function(e){var t=(0,w.map)(e,(function(e){return{label:e.text,value:{webId:e.WebId,value:e.text,expandable:!o.isPiPoint&&e.expandable}}}));if(0===t.length)return t;var n=l.templateSrv.getVariables();return(0,w.each)(n,(function(e){var n={label:"${"+e.name+"}",value:{type:"template",value:"${"+e.name+"}",expandable:!o.isPiPoint}};t.unshift(n)})),t.unshift({label:J,value:{value:J}}),t})).catch((function(e){return s.error=e.message||"Failed to issue metric query",[]}))})),Q(G(t),"getAttributeSegmentsPI",(function(e){var n,a,r=t.props,i=r.datasource,l=r.query,o=r.data,u=G(t),s={path:"",webId:t.getSelectedPIServer(),pointName:(null!=e?e:"")+"*",type:"pipoint"},c=[];return c.push({label:J,value:{value:J}}),i.metricFindQuery(s,Object.assign(null!==(n=null==o||null===(a=o.request)||void 0===a?void 0:a.scopedVars)&&void 0!==n?n:{},{isPiPoint:l.isPiPoint})).then((function(t){c=(0,w.map)(t,(function(e){return{path:e.Path,label:e.text,value:{value:e.text,expandable:!1}}})),e&&e.length>0&&c.unshift({label:e,value:{value:e,expandable:!1}});var n=i.templateSrv.getVariables();return(0,w.each)(n,(function(e){var t={label:"${"+e.name+"}",value:{type:"template",value:"${"+e.name+"}",expandable:!l.isPiPoint}};c.unshift(t)})),c})).catch((function(e){return u.error=e.message||"Failed to issue metric query",c}))})),Q(G(t),"getAttributeSegmentsAF",(function(e){var n=G(t),a=[];return a.push({label:J,value:{value:J}}),(0,w.forOwn)(n.availableAttributes,(function(e,t){var n={label:t,value:{value:t,expandable:!0}};a.push(n)})),a})),Q(G(t),"buildFromTarget",(function(e,n,a){var r=e.target.split(";"),i=r.length>0?r[0].split("\\"):[];return i.length>1||1===i.length&&""!==i[0]?(r.splice(0,1),(0,w.each)(i,(function(e,t){n.push({label:e,value:{type:e.match(/\${\w+}/gi)?"template":void 0,value:e,expandable:!0}})})),(0,w.each)(r,(function(e,t){""!==e&&a.push({label:e,value:{value:e,expandable:!1}})})),t.getElementSegments(i.length+1,n).then((function(e){return e.length>0&&n.push({label:"Select Element",value:{value:"-Select Element-"}}),n}))):Promise.resolve(n)})),Q(G(t),"checkAfServer",(function(){var e,n,a=t.props.datasource,r=[];null!==(e=a.afserver)&&void 0!==e&&e.name?(r.push({label:a.afserver.name,value:{value:a.afserver.name,expandable:!0}}),null!==(n=a.afdatabase)&&void 0!==n&&n.name&&r.push({label:a.afdatabase.name,value:{value:a.afdatabase.name,expandable:!0}}),r.push({label:"Select Element",value:{value:"-Select Element-"}})):r.push({label:""});return r})),Q(G(t),"updateArray",(function(e,n,a,r,i){t.setState({segments:e,attributes:n,summaries:a,isPiPoint:r},(function(){r||t.checkAttributeSegments(n,t.state.segments).then((function(){i&&i()}))}))})),Q(G(t),"scopedVarsDone",!1),Q(G(t),"componentDidMount",(function(){t.initialLoad(!1)})),Q(G(t),"componentDidUpdate",(function(){var e,n,a,r=t.props.query;"Done"===(null===(e=t.props.data)||void 0===e?void 0:e.state)&&null!==(n=t.props.data)&&void 0!==n&&null!==(a=n.request)&&void 0!==a&&a.scopedVars&&!t.scopedVarsDone&&(t.scopedVarsDone=!0,t.initialLoad(!r.isPiPoint))})),Q(G(t),"initialLoad",(function(e){var n,a,r,i=t.props.query,l=(0,w.defaults)(i,j),o=l.segments,u=l.attributes,s=l.summary,c=l.isPiPoint,m=e?[]:null!==(n=null==o?void 0:o.slice(0))&&void 0!==n?n:[],p=e?[]:null!==(a=null==u?void 0:u.slice(0))&&void 0!==a?a:[],f=null!==(r=null==s?void 0:s.types)&&void 0!==r?r:[];if(c||0!==m.length)c&&m.length>0&&(t.piServer=m);else{if(i.target&&i.target.length>0&&";"!==i.target)return p=[],void t.buildFromTarget(i,m,p).then((function(e){t.updateArray(e,p,f,!1)})).catch((function(e){}));m=t.checkAfServer()}t.updateArray(m,p,f,!!c,(function(){t.onChange(i)}))})),Q(G(t),"onChange",(function(e){var n,a,r=t.props,i=r.onChange,l=r.onRunQuery;(e.summary.types=t.state.summaries,e.rawQuery)?e.target=null!==(n=e.query)&&void 0!==n?n:"":(e.elementPath=t.getSegmentPathUpTo(t.state.segments,t.state.segments.length),e.target=e.elementPath+";"+(0,w.join)(null===(a=e.attributes)||void 0===a?void 0:a.map((function(e){var t;return null===(t=e.value)||void 0===t?void 0:t.value})),";"));i(e),e.target&&e.target.length>0&&l()})),Q(G(t),"stateCallback",(function(){var e=t.props.query;t.onChange(e)})),Q(G(t),"onIsPiPointChange",(function(e){var n=t.props.query,a=!n.isPiPoint;t.setState({segments:a?[{label:""}]:t.checkAfServer(),attributes:[],isPiPoint:a},(function(){t.onChange(R({},n,{expression:"",attributes:t.state.attributes,segments:t.state.segments,isPiPoint:a}))}))})),t.onSegmentChange=t.onSegmentChange.bind(G(t)),t.calcBasisValueChanged=t.calcBasisValueChanged.bind(G(t)),t.calcNoDataValueChanged=t.calcNoDataValueChanged.bind(G(t)),t.onSummaryAction=t.onSummaryAction.bind(G(t)),t.onSummaryValueChanged=t.onSummaryValueChanged.bind(G(t)),t.onAttributeAction=t.onAttributeAction.bind(G(t)),t.onAttributeChange=t.onAttributeChange.bind(G(t)),t.summaryTypes=["Total","Average","Minimum","Maximum","Range","StdDev","PopulationStdDev","Count","PercentGood","All","AllForNonNumeric"],t.calculationBasis=["TimeWeighted","EventWeighted","TimeWeightedContinuous","TimeWeightedDiscrete","EventWeightedExcludeMostRecentEvent","EventWeightedExcludeEarliestEvent","EventWeightedIncludeBothEnds"],t.noDataReplacement=["Null","Drop","Previous","0","Keep"],t}return t=o,(n=[{key:"isValueEmpty",value:function(e){return!e||!e.value||!e.value.length||e.value===J}},{key:"calcBasisValueChanged",value:function(e){var t,n=this.props.query,a=n.summary;a.basis=null===(t=e.value)||void 0===t?void 0:t.value,this.onChange(R({},n,{summary:a}))}},{key:"getCalcBasisSegments",value:function(){return(0,w.map)(this.calculationBasis,(function(e){return{label:e,value:{value:e,expandable:!0}}}))}},{key:"calcNoDataValueChanged",value:function(e){var t,n=this.props.query,a=n.summary;a.nodata=null===(t=e.value)||void 0===t?void 0:t.value,this.onChange(R({},n,{summary:a}))}},{key:"getNoDataSegments",value:function(){return(0,w.map)(this.noDataReplacement,(function(e){return{label:e,value:{value:e,expandable:!0}}}))}},{key:"onSummaryValueChanged",value:function(e,t){var n=this.state.summaries.slice(0);n[t]=e,this.isValueEmpty(e.value)&&n.splice(t,1),this.setState({summaries:n},this.stateCallback)}},{key:"getSummarySegments",value:function(){var e=this,t=(0,w.filter)(this.summaryTypes,(function(t){return-1===e.state.summaries.map((function(e){var t;return null===(t=e.value)||void 0===t?void 0:t.value})).indexOf(t)})),n=(0,w.map)(t,(function(e){return{label:e,value:{value:e,expandable:!0}}}));return n.unshift({label:J,value:{value:J}}),n}},{key:"removeSummary",value:function(e){var t=(0,w.filter)(this.state.summaries,(function(t){return t!==e}));this.setState({summaries:t})}},{key:"onSummaryAction",value:function(e){var t=this.state.summaries.slice(0);if(!this.isValueEmpty(e.value)){var n,a={label:e.label,value:{value:null===(n=e.value)||void 0===n?void 0:n.value,expandable:!0}};t.push(a)}this.setState({summarySegment:{},summaries:t},this.stateCallback)}},{key:"removeAttribute",value:function(e){var t=(0,w.filter)(this.state.attributes,(function(t){return t!==e}));this.attributeChangeValue(t)}},{key:"onAttributeAction",value:function(e){var t=this.props.query,n=this.state.attributes.slice(0);if(!this.isValueEmpty(e.value)){var a,r={label:e.label,value:{value:null===(a=e.value)||void 0===a?void 0:a.value,expandable:!t.isPiPoint}};n.push(r)}this.attributeChangeValue(n)}},{key:"getSegmentPathUpTo",value:function(e,t){var n=e.slice(0,t);return(0,w.reduce)(n,(function(e,t){var n;return t.value?null!==(n=t.value.value)&&void 0!==n&&n.startsWith("-Select")?e:e?e+"\\"+t.value.value:t.value.value:""}),"")}},{key:"checkAttributeSegments",value:function(e,t){var n,a,r=this,i=this.props,l=i.datasource,o=i.data,u=this,s={path:this.getSegmentPathUpTo(t.slice(0),t.length),type:"attributes"};return l.metricFindQuery(s,Object.assign(null!==(n=null==o||null===(a=o.request)||void 0===a?void 0:a.scopedVars)&&void 0!==n?n:{},{isPiPoint:!1})).then((function(t){var n={};(0,w.each)(t,(function(e){n[e.Path.substring(e.Path.indexOf("|")+1)]=e.WebId}));var a=(0,w.filter)(e,(function(e){var t,a=l.templateSrv.replace(null===(t=e.value)||void 0===t?void 0:t.value);return void 0!==n[a]}));u.availableAttributes=n,r.attributeChangeValue(a)})).catch((function(t){u.error=t.message||"Failed to issue metric query",r.attributeChangeValue(e)}))}},{key:"checkPiPointSegments",value:function(e,t){var n,a,r=this.props,i=r.datasource,l=r.data,o=this,u={path:e.path,webId:o.getSelectedPIServer(),pointName:e.label,type:"pipoint"};return i.metricFindQuery(u,Object.assign(null!==(n=null==l||null===(a=l.request)||void 0===a?void 0:a.scopedVars)&&void 0!==n?n:{},{isPiPoint:!0})).then((function(){o.attributeChangeValue(t)})).catch((function(e){o.error=e.message||"Failed to issue metric query",o.attributeChangeValue([])}))}},{key:"getSelectedPIServer",value:function(){var e,t=this,n="";return this.piServer.forEach((function(e){var a=t.props.query.target.split(";");a.length>=2&&a[0]===e.text&&(n=e.WebId)})),this.piServer.length>0?null===(e=this.piServer[0].value)||void 0===e?void 0:e.webId:n}},{key:"textEditorChanged",value:function(){var e=this,t=this.props,n=t.query,a=t.onChange,r=n.target.split(";"),i=r.length>0?r[0].split("\\"):[],l=[],o=[];i.length>1||1===i.length&&""!==i[0]?(r.splice(0,1),(0,w.each)(i,(function(e,t){l.push({label:e,value:{type:e.match(/\${\w+}/gi)?"template":void 0,value:e,expandable:!0}})})),(0,w.each)(r,(function(e,t){""!==e&&o.push({label:e,value:{value:e,expandable:!1}})})),this.getElementSegments(i.length+1,l).then((function(e){e.length>0&&l.push({label:"Select Element",value:{value:"-Select Element-"}})})).then((function(){e.updateArray(l,o,e.state.summaries,n.isPiPoint,(function(){a(R({},n,{query:void 0,rawQuery:!1}))}))}))):(l=this.checkAfServer(),this.updateArray(l,this.state.attributes,this.state.summaries,n.isPiPoint,(function(){e.onChange(R({},n,{query:void 0,rawQuery:!1,attributes:e.state.attributes,segments:e.state.segments}))})))}},{key:"render",value:function(){var e=this,t=this.props,n=t.query,a=t.onChange,l=t.onRunQuery,o=(0,w.defaults)(n,j),u=o.useLastValue,s=o.useUnit,c=o.interpolate,m=o.query,p=o.rawQuery,f=o.digitalStates,d=o.recordedValues,h=o.expression,v=o.isPiPoint,g=o.summary,b=o.display,y=o.regex;return r().createElement(r().Fragment,null,this.props.datasource.piPointConfig&&r().createElement(i.InlineField,{label:"Is Pi Point?",labelWidth:H},r().createElement(i.InlineSwitch,{value:v,onChange:this.onIsPiPointChange})),!!p&&r().createElement(i.InlineFieldRow,null,r().createElement(i.InlineField,{label:"Raw Query",labelWidth:H,grow:!0},r().createElement(i.Input,{onBlur:this.stateCallback,value:m,onChange:function(e){return a(R({},o,{query:e.target.value}))},placeholder:"enter query"})),r().createElement(W,{isRaw:!0,onChange:function(t){return e.textEditorChanged()}})),!p&&r().createElement(r().Fragment,null,r().createElement("div",{className:"gf-form-inline"},r().createElement(F,{label:v?"PI Server":"AF Elements",tooltip:v?"Select PI server.":"Select AF Element."},this.state.segments.map((function(t,n){return r().createElement(i.SegmentAsync,{key:"element-"+n,Component:r().createElement(X,{value:t.value,label:t.label}),onChange:function(t){return e.onSegmentChange(t,n)},loadOptions:function(t){return e.getElementSegments(n)},allowCustomValue:!0,inputMinWidth:200})})),k||(k=r().createElement(x,null)),!v&&r().createElement(W,{isRaw:!1,onChange:function(e){a(R({},o,{query:o.target,rawQuery:e}))}}))),r().createElement(O,{label:v?"Pi Points":"Attributes"},this.state.attributes.map((function(t,n){return v?r().createElement(i.SegmentAsync,{key:"attributes-"+n,Component:r().createElement(X,{value:t.value,label:t.label}),disabled:0===e.piServer.length,onChange:function(t){return e.onPiPointChange(t,n)},loadOptions:e.getAttributeSegmentsPI,reloadOptionsOnChange:!0,allowCustomValue:!0,inputMinWidth:$}):r().createElement(i.Segment,{key:"attributes-"+n,Component:r().createElement(X,{value:t.value,label:t.label}),disabled:e.state.segments.length<=2,onChange:function(t){return e.onAttributeChange(t,n)},options:e.getAttributeSegmentsAF(),allowCustomValue:!0,inputMinWidth:$})})),v&&r().createElement(i.SegmentAsync,{Component:r().createElement(X,{value:this.state.attributeSegment.value,label:this.state.attributeSegment.label}),disabled:0===this.piServer.length,onChange:this.onAttributeAction,loadOptions:this.getAttributeSegmentsPI,reloadOptionsOnChange:!0,allowCustomValue:!0,inputMinWidth:$}),!v&&r().createElement(i.Segment,{Component:r().createElement(X,{value:this.state.attributeSegment.value,label:this.state.attributeSegment.label}),disabled:this.state.segments.length<=2,onChange:this.onAttributeAction,options:this.getAttributeSegmentsAF(),allowCustomValue:!0,inputMinWidth:$}))),r().createElement(i.InlineFieldRow,null,r().createElement(i.InlineField,{label:"Use Last Value",tooltip:"Fetch only last value from time range",labelWidth:H},r().createElement(i.InlineSwitch,{value:u.enable,onChange:function(){return e.onChange(R({},o,{useLastValue:R({},u,{enable:!u.enable})}))}})),this.props.datasource.useUnitConfig&&r().createElement(i.InlineField,{label:"Use unit from datapoints",tooltip:"Use unit in label from PI tag or PI AF attribute",labelWidth:H},r().createElement(i.InlineSwitch,{value:s.enable,onChange:function(){return e.onChange(R({},o,{useUnit:R({},s,{enable:!s.enable})}))}}))),r().createElement(i.InlineFieldRow,null,r().createElement(i.InlineField,{label:"Calculation",labelWidth:H,tooltip:"Modify all attributes by an equation. Use '.' for current item. Leave Attributes empty if you wish to perform element based calculations."},r().createElement(i.Input,{onBlur:l,value:h,onChange:function(e){return a(R({},o,{expression:e.target.value}))},placeholder:"'.'*2"}))),!u.enable&&r().createElement(r().Fragment,null,r().createElement(i.InlineFieldRow,null,r().createElement(i.InlineField,{label:"Max Recorded Values",labelWidth:H,tooltip:"Maximum number of recorded value to retrive from the data archive, without using interpolation."},r().createElement(i.Input,{onBlur:l,value:d.maxNumber,onChange:function(e){return a(R({},o,{recordedValues:R({},d,{maxNumber:parseInt(e.target.value,10)})}))},type:"number",placeholder:"1000"})),r().createElement(i.InlineField,{label:"Recorded Values",labelWidth:H},r().createElement(i.InlineSwitch,{value:d.enable,onChange:function(){return e.onChange(R({},o,{recordedValues:R({},d,{enable:!d.enable})}))}})),r().createElement(i.InlineField,{label:"Digital States",labelWidth:H},r().createElement(i.InlineSwitch,{value:f.enable,onChange:function(){return e.onChange(R({},o,{digitalStates:R({},f,{enable:!f.enable})}))}}))),r().createElement(i.InlineFieldRow,null,r().createElement(i.InlineField,{label:h?"Interval Period":"Interpolate Period",labelWidth:H,tooltip:"Override time between sampling, e.g. '30s'. Defaults to timespan/chart width."},r().createElement(i.Input,{onBlur:l,value:c.interval,onChange:function(e){return a(R({},o,{interpolate:R({},c,{interval:e.target.value})}))},placeholder:"30s"})),r().createElement(i.InlineField,{label:h?"Interval Values":"Interpolate",labelWidth:H},r().createElement(i.InlineSwitch,{value:c.enable,onChange:function(){return e.onChange(R({},o,{interpolate:R({},c,{enable:!c.enable})}))}})),r().createElement(i.InlineField,{label:"Replace Bad Data",labelWidth:H,tooltip:"Replacement for bad quality values."},r().createElement(i.Segment,{Component:r().createElement(X,{value:{value:g.nodata},label:g.nodata}),onChange:this.calcNoDataValueChanged,options:this.getNoDataSegments(),allowCustomValue:!0}))),r().createElement(i.InlineFieldRow,null,r().createElement(i.InlineField,{label:"Summary Period",labelWidth:H,tooltip:"Define the summary period, e.g. '30s'."},r().createElement(i.Input,{onBlur:l,value:g.interval,onChange:function(e){return a(R({},o,{summary:R({},g,{interval:e.target.value})}))},placeholder:"30s"})),r().createElement(i.InlineField,{label:"Basis",labelWidth:H,tooltip:"Defines the possible calculation options when performing summary calculations over time-series data."},r().createElement(i.Segment,{Component:r().createElement(X,{value:{value:g.basis},label:g.basis}),onChange:this.calcBasisValueChanged,options:this.getCalcBasisSegments(),allowCustomValue:!0})),r().createElement(i.InlineField,{label:"Summaries",labelWidth:H,tooltip:"PI Web API summary options."},r().createElement(i.InlineFieldRow,null,this.state.summaries.map((function(t,n){return r().createElement(i.Segment,{key:"summaries-"+n,Component:r().createElement(X,{value:t.value,label:t.label}),onChange:function(t){return e.onSummaryValueChanged(t,n)},options:e.getSummarySegments(),allowCustomValue:!0})})),r().createElement(i.Segment,{Component:r().createElement(X,{value:this.state.summarySegment.value,label:this.state.summarySegment.label}),onChange:this.onSummaryAction,options:this.getSummarySegments(),allowCustomValue:!0}))))),r().createElement(i.InlineFieldRow,null,r().createElement(i.InlineField,{label:"Display Name",labelWidth:H,tooltip:"If single attribute, modify display name. Otherwise use regex to modify display name."},r().createElement(i.Input,{onBlur:l,value:b,onChange:function(e){return a(R({},o,{display:e.target.value}))},placeholder:"Display"})),r().createElement(i.InlineField,{label:"Enable Regex Replace",labelWidth:H},r().createElement(i.InlineSwitch,{value:y.enable,onChange:function(){e.onChange(R({},o,{regex:R({},y,{enable:!y.enable})}))}})),r().createElement(i.InlineField,{label:"Search",labelWidth:16},r().createElement(i.Input,{onBlur:l,value:y.search,onChange:function(e){return a(R({},o,{regex:R({},y,{search:e.target.value})}))},placeholder:"(.*)"})),r().createElement(i.InlineField,{label:"Replace",labelWidth:16},r().createElement(i.Input,{onBlur:l,value:y.replace,onChange:function(e){return a(R({},o,{regex:R({},y,{replace:e.target.value})}))},placeholder:"$1"}))))}}])&&q(t.prototype,n),a&&q(t,a),Object.defineProperty(t,"prototype",{writable:!1}),o}(a.PureComponent),z=u(5),K=u(6);function Z(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return ee(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return ee(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var a=0,r=function(){};return{s:r,n:function(){return a>=e.length?{done:!0}:{done:!1,value:e[a++]}},e:function(e){throw e},f:r}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var i,l=!0,o=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return l=e.done,e},e:function(e){o=!0,i=e},f:function(){try{l||null==n.return||n.return()}finally{if(o)throw i}}}}function ee(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,a=new Array(t);n<t;n++)a[n]=e[n];return a}function te(e){var t,a,r=[],i=[],l=Z(e.datapoints);try{for(l.s();!(a=l.n()).done;){var o=a.value;i.push(o[0]),r.push(o[1])}}catch(e){l.e(e)}finally{l.f()}var u=[{name:n.TIME_SERIES_TIME_FIELD_NAME,type:n.FieldType.time,config:{},values:new n.ArrayVector(r)},{name:null!==(t=e.target)&&void 0!==t?t:n.TIME_SERIES_VALUE_FIELD_NAME,type:n.FieldType.number,config:{unit:e.unit},values:new n.ArrayVector(i),labels:e.tags}];return e.title&&(u[1].config.displayNameFromDS=e.title),{name:"",refId:e.refId,meta:e.meta,fields:u,length:i.length}}function ne(e){return(0,w.map)(e,(function(e){var t,n;return{text:e.Name,expandable:void 0===e.HasChildren||!0===e.HasChildren||(null!==(t=e.Path)&&void 0!==t?t:"").split("\\").length<=3,HasChildren:e.HasChildren,Items:null!==(n=e.Items)&&void 0!==n?n:[],Path:e.Path,WebId:e.WebId}}))}function ae(e,t){return e.map((function(e,n){var a=[{text:"StartTime"},{text:"EndTime"}],r=[e.StartTime,e.EndTime];return t&&t[n].Content.Items.forEach((function(e){a.push({text:e.Name}),r.push(String(e.Value.Value?e.Value.Value.Name||e.Value.Value.Value||e.Value.Value:""))})),{name:e.Name,columns:a,rows:[r]}}))}function re(e){return"number"==typeof e&&!Number.isNaN(e)&&Number.isFinite(e)}function ie(e){var t,n=e.split("|");return 0===n.length||0===(n=n[0].split("\\")).length?"":null!==(t=n.pop())&&void 0!==t?t:""}function le(e,t){var n;if(!t||0===e.length)return"";var a=ie(t),r=null===(n=e.find((function(e){return t.indexOf(e.path)>=0})))||void 0===n?void 0:n.variable;return r?r+"|"+a:a}function oe(e,t,n){return e?n.replace(/'\.'/g,"'".concat(t.Name,"'")):n}function ue(){return ue=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var a in n)Object.prototype.hasOwnProperty.call(n,a)&&(e[a]=n[a])}return e},ue.apply(this,arguments)}function se(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null==n)return;var a,r,i=[],l=!0,o=!1;try{for(n=n.call(e);!(l=(a=n.next()).done)&&(i.push(a.value),!t||i.length!==t);l=!0);}catch(e){o=!0,r=e}finally{try{l||null==n.return||n.return()}finally{if(o)throw r}}return i}(e,t)||function(e,t){if(!e)return;if("string"==typeof e)return ce(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return ce(e,t)}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function ce(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,a=new Array(t);n<t;n++)a[n]=e[n];return a}var me=30,pe=(0,a.memo)((function(e){var t,n,l,o,u,s,c,m,p=e.query,f=e.datasource,d=e.annotation,h=e.onChange,v=e.onRunQuery,g=se((0,a.useState)(""),2),b=g[0],y=g[1],P=se((0,a.useState)(null!==(t=null==d||null===(n=d.target)||void 0===n?void 0:n.database)&&void 0!==t?t:{}),2),E=P[0],S=P[1];if(void 0===d)return null;var w=function(e){var t=d.target;if(t&&t[e])return{label:t[e].Name,value:t[e]}};return f.getAssetServer(f.afserver.name).then((function(e){y(e.WebId)})),r().createElement(r().Fragment,null,r().createElement("div",{className:"gf-form-group"},r().createElement(i.InlineFieldRow,null,r().createElement(i.InlineField,{label:"Database",labelWidth:me,grow:!0},r().createElement(i.AsyncSelect,{key:null!=b?b:"database-key",loadOptions:function(){return f.getDatabases(b).then((function(e){return e.map((function(e){return{label:e.Name,value:e}}))}))},loadingMessage:"Loading",value:w("database"),onChange:function(e){S(e.value),h(ue({},p,{database:e.value,template:void 0}))},defaultOptions:!0})),r().createElement(i.InlineField,{label:"Event Frames",labelWidth:me,grow:!0},r().createElement(i.AsyncSelect,{key:null!==(l=null==E?void 0:E.WebId)&&void 0!==l?l:"default-template-key",loadOptions:function(){return f.getEventFrameTemplates(null==E?void 0:E.WebId).then((function(e){return e.map((function(e){return{label:e.Name,value:e}}))}))},loadingMessage:"Loading",value:w("template"),onChange:function(e){return h(ue({},p,{template:e.value}))},defaultOptions:!0})),r().createElement(i.InlineField,{label:"Show Start and End Time",labelWidth:me,grow:!0},r().createElement(i.InlineSwitch,{value:!!p.showEndTime,onChange:function(e){return h(ue({},p,{showEndTime:e.currentTarget.checked}))}}))),r().createElement(i.InlineFieldRow,null,r().createElement(i.InlineField,{label:"Category name",labelWidth:me,grow:!0},r().createElement(i.Input,{type:"text",value:p.categoryName,onBlur:function(e){return v()},onChange:function(e){return h(ue({},p,{categoryName:e.currentTarget.value}))},placeholder:"Enter category name"})),r().createElement(i.InlineField,{label:"Name Filter",labelWidth:me,grow:!0},r().createElement(i.Input,{type:"text",value:p.nameFilter,onBlur:function(e){return v()},onChange:function(e){return h(ue({},p,{nameFilter:e.currentTarget.value}))},placeholder:"Enter name filter"}))),r().createElement(i.InlineFieldRow,null,r().createElement(i.InlineField,{label:"Enable Name Regex Replacement",labelWidth:me,grow:!1},r().createElement(i.InlineSwitch,{value:null===(o=p.regex)||void 0===o?void 0:o.enable,onChange:function(e){return h(ue({},p,{regex:ue({},p.regex,{enable:e.currentTarget.checked})}))}})),r().createElement(i.InlineField,{label:"Name Filter",labelWidth:20,grow:!1},r().createElement(i.Input,{type:"text",value:null===(u=p.regex)||void 0===u?void 0:u.search,onBlur:function(e){return v()},onChange:function(e){return h(ue({},p,{regex:ue({},p.regex,{search:e.currentTarget.value})}))},placeholder:"(.*)",width:50})),r().createElement(i.InlineField,{label:"Replace",labelWidth:20,grow:!0},r().createElement(i.Input,{type:"text",value:null==p||null===(s=p.regex)||void 0===s?void 0:s.replace,onBlur:function(e){return v()},onChange:function(e){return h(ue({},p,{regex:ue({},p.regex,{replace:e.currentTarget.value})}))},placeholder:"$1"}))),r().createElement(i.InlineFieldRow,null,r().createElement(i.InlineField,{label:"Enable Attribute Usage",labelWidth:me,grow:!1},r().createElement(i.InlineSwitch,{value:null===(c=p.attribute)||void 0===c?void 0:c.enable,onChange:function(e){return h(ue({},p,{attribute:ue({},p.attribute,{enable:e.currentTarget.checked})}))}})),r().createElement(i.InlineField,{label:"Attribute Name",labelWidth:me,grow:!0},r().createElement(i.Input,{type:"text",value:null===(m=p.attribute)||void 0===m?void 0:m.name,onBlur:function(e){return v()},onChange:function(e){return h(ue({},p,{attribute:ue({},p.attribute,{name:e.currentTarget.value})}))},placeholder:"Enter name"})))))}));function fe(){return fe=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var a in n)Object.prototype.hasOwnProperty.call(n,a)&&(e[a]=n[a])}return e},fe.apply(this,arguments)}function de(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return he(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return he(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var a=0,r=function(){};return{s:r,n:function(){return a>=e.length?{done:!0}:{done:!1,value:e[a++]}},e:function(e){throw e},f:r}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var i,l=!0,o=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return l=e.done,e},e:function(e){o=!0,i=e},f:function(){try{l||null==n.return||n.return()}finally{if(o)throw i}}}}function he(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,a=new Array(t);n<t;n++)a[n]=e[n];return a}function ve(e){return ve="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},ve(e)}function ge(){ge=function(){return e};var e={},t=Object.prototype,n=t.hasOwnProperty,a="function"==typeof Symbol?Symbol:{},r=a.iterator||"@@iterator",i=a.asyncIterator||"@@asyncIterator",l=a.toStringTag||"@@toStringTag";function o(e,t,n){return Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{o({},"")}catch(e){o=function(e,t,n){return e[t]=n}}function u(e,t,n,a){var r=t&&t.prototype instanceof m?t:m,i=Object.create(r.prototype),l=new w(a||[]);return i._invoke=function(e,t,n){var a="suspendedStart";return function(r,i){if("executing"===a)throw new Error("Generator is already running");if("completed"===a){if("throw"===r)throw i;return C()}for(n.method=r,n.arg=i;;){var l=n.delegate;if(l){var o=P(l,n);if(o){if(o===c)continue;return o}}if("next"===n.method)n.sent=n._sent=n.arg;else if("throw"===n.method){if("suspendedStart"===a)throw a="completed",n.arg;n.dispatchException(n.arg)}else"return"===n.method&&n.abrupt("return",n.arg);a="executing";var u=s(e,t,n);if("normal"===u.type){if(a=n.done?"completed":"suspendedYield",u.arg===c)continue;return{value:u.arg,done:n.done}}"throw"===u.type&&(a="completed",n.method="throw",n.arg=u.arg)}}}(e,n,l),i}function s(e,t,n){try{return{type:"normal",arg:e.call(t,n)}}catch(e){return{type:"throw",arg:e}}}e.wrap=u;var c={};function m(){}function p(){}function f(){}var d={};o(d,r,(function(){return this}));var h=Object.getPrototypeOf,v=h&&h(h(I([])));v&&v!==t&&n.call(v,r)&&(d=v);var g=f.prototype=m.prototype=Object.create(d);function b(e){["next","throw","return"].forEach((function(t){o(e,t,(function(e){return this._invoke(t,e)}))}))}function y(e,t){function a(r,i,l,o){var u=s(e[r],e,i);if("throw"!==u.type){var c=u.arg,m=c.value;return m&&"object"==ve(m)&&n.call(m,"__await")?t.resolve(m.__await).then((function(e){a("next",e,l,o)}),(function(e){a("throw",e,l,o)})):t.resolve(m).then((function(e){c.value=e,l(c)}),(function(e){return a("throw",e,l,o)}))}o(u.arg)}var r;this._invoke=function(e,n){function i(){return new t((function(t,r){a(e,n,t,r)}))}return r=r?r.then(i,i):i()}}function P(e,t){var n=e.iterator[t.method];if(void 0===n){if(t.delegate=null,"throw"===t.method){if(e.iterator.return&&(t.method="return",t.arg=void 0,P(e,t),"throw"===t.method))return c;t.method="throw",t.arg=new TypeError("The iterator does not provide a 'throw' method")}return c}var a=s(n,e.iterator,t.arg);if("throw"===a.type)return t.method="throw",t.arg=a.arg,t.delegate=null,c;var r=a.arg;return r?r.done?(t[e.resultName]=r.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=void 0),t.delegate=null,c):r:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,c)}function E(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function S(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function w(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(E,this),this.reset(!0)}function I(e){if(e){var t=e[r];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var a=-1,i=function t(){for(;++a<e.length;)if(n.call(e,a))return t.value=e[a],t.done=!1,t;return t.value=void 0,t.done=!0,t};return i.next=i}}return{next:C}}function C(){return{value:void 0,done:!0}}return p.prototype=f,o(g,"constructor",f),o(f,"constructor",p),p.displayName=o(f,l,"GeneratorFunction"),e.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===p||"GeneratorFunction"===(t.displayName||t.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,f):(e.__proto__=f,o(e,l,"GeneratorFunction")),e.prototype=Object.create(g),e},e.awrap=function(e){return{__await:e}},b(y.prototype),o(y.prototype,i,(function(){return this})),e.AsyncIterator=y,e.async=function(t,n,a,r,i){void 0===i&&(i=Promise);var l=new y(u(t,n,a,r),i);return e.isGeneratorFunction(n)?l:l.next().then((function(e){return e.done?e.value:l.next()}))},b(g),o(g,l,"Generator"),o(g,r,(function(){return this})),o(g,"toString",(function(){return"[object Generator]"})),e.keys=function(e){var t=[];for(var n in e)t.push(n);return t.reverse(),function n(){for(;t.length;){var a=t.pop();if(a in e)return n.value=a,n.done=!1,n}return n.done=!0,n}},e.values=I,w.prototype={constructor:w,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(S),!e)for(var t in this)"t"===t.charAt(0)&&n.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=void 0)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var t=this;function a(n,a){return l.type="throw",l.arg=e,t.next=n,a&&(t.method="next",t.arg=void 0),!!a}for(var r=this.tryEntries.length-1;r>=0;--r){var i=this.tryEntries[r],l=i.completion;if("root"===i.tryLoc)return a("end");if(i.tryLoc<=this.prev){var o=n.call(i,"catchLoc"),u=n.call(i,"finallyLoc");if(o&&u){if(this.prev<i.catchLoc)return a(i.catchLoc,!0);if(this.prev<i.finallyLoc)return a(i.finallyLoc)}else if(o){if(this.prev<i.catchLoc)return a(i.catchLoc,!0)}else{if(!u)throw new Error("try statement without catch or finally");if(this.prev<i.finallyLoc)return a(i.finallyLoc)}}}},abrupt:function(e,t){for(var a=this.tryEntries.length-1;a>=0;--a){var r=this.tryEntries[a];if(r.tryLoc<=this.prev&&n.call(r,"finallyLoc")&&this.prev<r.finallyLoc){var i=r;break}}i&&("break"===e||"continue"===e)&&i.tryLoc<=t&&t<=i.finallyLoc&&(i=null);var l=i?i.completion:{};return l.type=e,l.arg=t,i?(this.method="next",this.next=i.finallyLoc,c):this.complete(l)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),c},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.finallyLoc===e)return this.complete(n.completion,n.afterLoc),S(n),c}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.tryLoc===e){var a=n.completion;if("throw"===a.type){var r=a.arg;S(n)}return r}}throw new Error("illegal catch attempt")},delegateYield:function(e,t,n){return this.delegate={iterator:I(e),resultName:t,nextLoc:n},"next"===this.method&&(this.arg=void 0),c}},e}function be(e,t,n,a,r,i,l){try{var o=e[i](l),u=o.value}catch(e){return void n(e)}o.done?t(u):Promise.resolve(u).then(a,r)}function ye(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function Pe(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}function Ee(e,t){return Ee=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},Ee(e,t)}function Se(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,a=Ce(e);if(t){var r=Ce(this).constructor;n=Reflect.construct(a,arguments,r)}else n=a.apply(this,arguments);return we(this,n)}}function we(e,t){if(t&&("object"===ve(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return Ie(e)}function Ie(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function Ce(e){return Ce=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},Ce(e)}function xe(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var Oe=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&Ee(e,t)}(u,e);var t,a,r,i,l,o=Se(u);function u(e){var t,n,a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:(0,K.getTemplateSrv)(),r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:(0,K.getBackendSrv)();return ye(this,u),xe(Ie(n=o.call(this,e)),"piserver",void 0),xe(Ie(n),"afserver",void 0),xe(Ie(n),"afdatabase",void 0),xe(Ie(n),"piPointConfig",void 0),xe(Ie(n),"newFormatConfig",void 0),xe(Ie(n),"useUnitConfig",void 0),xe(Ie(n),"url",void 0),xe(Ie(n),"name",void 0),xe(Ie(n),"isProxy",!1),xe(Ie(n),"piwebapiurl",void 0),xe(Ie(n),"webidCache",new Map),xe(Ie(n),"error",void 0),n.templateSrv=a,n.backendSrv=r,n.url=e.url,n.name=e.name,n.piwebapiurl=null===(t=e.jsonData.url)||void 0===t?void 0:t.toString(),n.isProxy=/^http(s)?:\/\//.test(n.url)||"proxy"===e.jsonData.access,n.piserver={name:(e.jsonData||{}).piserver,webid:void 0},n.afserver={name:(e.jsonData||{}).afserver,webid:void 0},n.afdatabase={name:(e.jsonData||{}).afdatabase,webid:void 0},n.piPointConfig=e.jsonData.pipoint||!1,n.newFormatConfig=e.jsonData.newFormat||!1,n.useUnitConfig=e.jsonData.useUnit||!1,n.annotations={QueryEditor:pe,prepareQuery:function(e){return e.target&&(e.target.isAnnotation=!0),e.target},processEvents:function(e,t){return(0,z.of)(n.eventFrameToAnnotation(e,t))}},Promise.all([n.getDataServer(n.piserver.name).then((function(e){return n.piserver.webid=e.WebId})),n.getAssetServer(n.afserver.name).then((function(e){return n.afserver.webid=e.WebId})),n.getDatabase(n.afserver.name&&n.afdatabase.name?n.afserver.name+"\\"+n.afdatabase.name:void 0).then((function(e){return n.afdatabase.webid=e.WebId}))]),n}return t=u,a=[{key:"query",value:(i=ge().mark((function e(t){var n;return ge().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(1!==t.targets.length||!t.targets[0].isAnnotation){e.next=2;break}return e.abrupt("return",this.processAnnotationQuery(t));case 2:if(!((n=this.buildQueryParameters(t)).targets.length<=0)){e.next=7;break}return e.abrupt("return",Promise.resolve({data:[]}));case 7:return e.abrupt("return",Promise.all(this.getStream(n)).then((function(e){var t=[];return(0,w.each)(e,(function(e){(0,w.each)(e,(function(e){return t.push(e)}))})),0===(t=t.filter((function(e){return e.datapoints.length>0}))).length?{data:[]}:{data:t.sort((function(e,t){return+(e.target>t.target)||+(e.target===t.target)-1})).map((function(e){return te(e)}))}})));case 8:case"end":return e.stop()}}),e,this)})),l=function(){var e=this,t=arguments;return new Promise((function(n,a){var r=i.apply(e,t);function l(e){be(r,n,a,l,o,"next",e)}function o(e){be(r,n,a,l,o,"throw",e)}l(void 0)}))},function(e){return l.apply(this,arguments)})},{key:"testDatasource",value:function(){return this.backendSrv.datasourceRequest({url:this.url+"/",method:"GET"}).then((function(e){if(e.status<300)return{status:"success",message:"Data source is working",title:"Success"};throw new Error("Failed")}))}},{key:"metricFindQuery",value:function(e,t){var n,a,r=this,i=["servers","databases","databaseElements","elements"];return"string"==typeof e&&(e=JSON.parse(e)),t.isPiPoint?e.path=this.templateSrv.replace(e.path,t):(""===e.path?e.type=i[0]:(e.path=this.templateSrv.replace(e.path,t),e.path=e.path.split(";")[0],"attributes"!==e.type&&(e.type=i[Math.max(0,Math.min(e.path.split("\\").length,i.length-1))])),e.path=e.path.replace(/\{([^\\])*\}/gi,(function(e){return e.substring(1,e.length-2).split(",")[0]}))),e.filter=null!==(n=e.filter)&&void 0!==n?n:"*","servers"===e.type?null!==(a=r.afserver)&&void 0!==a&&a.name?r.getAssetServer(r.afserver.name).then((function(e){return[e]})).then(ne):r.getAssetServers().then(ne):"databases"===e.type&&e.afServerWebId?r.getDatabases(e.afServerWebId,{}).then(ne):"databases"===e.type?r.getAssetServer(e.path).then((function(e){var t;return r.getDatabases(null!==(t=e.WebId)&&void 0!==t?t:"",{})})).then(ne):"databaseElements"===e.type?r.getDatabase(e.path).then((function(e){var t;return r.getDatabaseElements(null!==(t=e.WebId)&&void 0!==t?t:"",{selectedFields:"Items.WebId%3BItems.Name%3BItems.Items%3BItems.Path%3BItems.HasChildren"})})).then(ne):"elements"===e.type?r.getElement(e.path).then((function(t){var n;return r.getElements(null!==(n=t.WebId)&&void 0!==n?n:"",{selectedFields:"Items.Description%3BItems.WebId%3BItems.Name%3BItems.Items%3BItems.Path%3BItems.HasChildren",nameFilter:e.filter})})).then(ne):"attributes"===e.type?r.getElement(e.path).then((function(t){var n;return r.getAttributes(null!==(n=t.WebId)&&void 0!==n?n:"",{searchFullHierarchy:"true",selectedFields:"Items.Type%3BItems.DefaultUnitsName%3BItems.Description%3BItems.WebId%3BItems.Name%3BItems.Path",nameFilter:e.filter})})).then(ne):"dataserver"===e.type?r.getDataServers().then(ne):"pipoint"===e.type?r.piPointSearch(e.webId,e.pointName).then(ne):Promise.reject("Bad type")}},{key:"getSummaryUrl",value:function(e){return""===e.interval.trim()?"&summaryType="+e.types.map((function(e){var t;return null===(t=e.value)||void 0===t?void 0:t.value})).join("&summaryType=")+"&calculationBasis="+e.basis:"&summaryType="+e.types.map((function(e){var t;return null===(t=e.value)||void 0===t?void 0:t.value})).join("&summaryType=")+"&calculationBasis="+e.basis+"&summaryDuration="+e.interval.trim()}},{key:"processAnnotationQuery",value:function(e){var t,a=e.targets[0],r=a.categoryName?this.templateSrv.replace(a.categoryName,e.scopedVars,"glob"):null,i=a.nameFilter?this.templateSrv.replace(a.nameFilter,e.scopedVars,"glob"):null,l=a.template?a.template.Name:null,o={datasource:a.datasource,showEndTime:a.showEndTime,regex:a.regex,attribute:a.attribute,categoryName:r,templateName:l,nameFilter:i},u=[];if(o.categoryName&&u.push("categoryName="+o.categoryName),o.nameFilter&&u.push("nameFilter="+o.nameFilter),o.templateName&&u.push("templateName="+o.templateName),!u.length)return Promise.resolve({data:[]});if(u.push("startTime="+e.range.from.toISOString()),u.push("endTime="+e.range.to.toISOString()),o.attribute&&o.attribute.enable){var s,c=this.piwebapiurl+"/streamsets/{0}/value?selectedFields=Items.WebId%3BItems.Value%3BItems.Name";o.attribute.name&&o.attribute.name.trim().length>0&&(c+="&nameFilter="+o.attribute.name.trim());var m={1:{Method:"GET",Resource:this.piwebapiurl+"/assetdatabases/"+(null===(s=a.database)||void 0===s?void 0:s.WebId)+"/eventframes?"+u.join("&")},2:{Method:"GET",RequestTemplate:{Resource:c},Parameters:["$.1.Content.Items[*].WebId"],ParentIds:["1"]}};return this.restBatch(m).then((function(e){var t=e.data[1].Content,a=e.data[2].Content;return{data:ae(t.Items,a.Items).map((function(e){return(0,n.toDataFrame)(e)}))}}))}return this.restGet("/assetdatabases/"+(null===(t=a.database)||void 0===t?void 0:t.WebId)+"/eventframes?"+u.join("&")).then((function(e){return{data:ae(e.data.Items).map((function(e){return(0,n.toDataFrame)(e)}))}}))}},{key:"eventFrameToAnnotation",value:function(e,t){var n=e.target,a=[];return t.forEach((function(t){var r,i,l,o="",u=t.name,s=null===(r=t.fields.find((function(e){return"EndTime"===e.name})))||void 0===r?void 0:r.values.get(0),c=null===(i=t.fields.find((function(e){return"StartTime"===e.name})))||void 0===i?void 0:i.values.get(0),m=t.fields.filter((function(e){return["StartTime","EndTime"].indexOf(e.name)<0}));m&&(0,w.each)(m,(function(e){o+="<br />"+e.name+": "+e.values.get(0)})),n.regex&&n.regex.enable&&(u=u.replace(new RegExp(n.regex.search),n.regex.replace)),a.push({id:null===(l=n.database)||void 0===l?void 0:l.WebId,annotation:e,title:"Name: ".concat(e.name),time:new Date(c).getTime(),timeEnd:n.showEndTime?new Date(s).getTime():void 0,text:"Tag: ".concat(u)+o+"<br />Start: "+new Date(c).toLocaleString("pt-BR")+"<br />End: "+new Date(s).toLocaleString("pt-BR"),tags:["OSISoft PI"]})})),a}},{key:"buildQueryParameters",value:function(e){var t=this;return e.targets=(0,w.filter)(e.targets,(function(e){return!(!e||!e.target||e.hide||e.target.startsWith("Select AF"))})),e.targets=(0,w.map)(e.targets,(function(n){var a;if(n.rawQuery&&n.target){var r=function(e){var t=e.split(";"),n=t[0].split("\\");t.splice(0,1);var a=[];if(n.length>1||1===n.length&&""!==n[0]){var r=n.join("\\");return(0,w.each)(t,(function(e,t){""!==e&&a.push({label:e,value:{value:e,expandable:!1}})})),{attributes:a,elementPath:r}}return{attributes:a,elementPath:null}}(t.templateSrv.replace(n.target,e.scopedVars)),i=r.attributes,l=r.elementPath;n.attributes=i,n.elementPath=l}var o=t,u={target:t.templateSrv.replace(n.elementPath,e.scopedVars),elementPath:t.templateSrv.replace(n.elementPath,e.scopedVars),elementPathArray:[{path:t.templateSrv.replace(n.elementPath,e.scopedVars),variable:""}],attributes:(0,w.map)(n.attributes,(function(n){var a;return t.templateSrv.replace((null===(a=n.value)||void 0===a?void 0:a.value)||n,e.scopedVars)})),isAnnotation:!!n.isAnnotation,segments:(0,w.map)(n.segments,(function(n){var a;return t.templateSrv.replace(null===(a=n.value)||void 0===a?void 0:a.value,e.scopedVars)})),display:n.display,refId:n.refId,hide:n.hide,interpolate:n.interpolate||{enable:!1},useLastValue:n.useLastValue||{enable:!1},useUnit:n.useUnit||{enable:!1},recordedValues:n.recordedValues||{enable:!1},digitalStates:n.digitalStates||{enable:!1},webid:null!==(a=n.webid)&&void 0!==a?a:"",webids:n.webids||[],regex:n.regex||{enable:!1},expression:n.expression||"",summary:n.summary||{types:[]},startTime:e.range.from,endTime:e.range.to,isPiPoint:!!n.isPiPoint,scopedVars:e.scopedVars};u.expression&&(u.expression=t.templateSrv.replace(u.expression,e.scopedVars)),void 0!==u.summary.types&&(u.summary.types=(0,w.filter)(u.summary.types,(function(e){return null!=e&&""!==e})));var s=(0,w.keys)(e.scopedVars);return t.templateSrv.getVariables().forEach((function(e){if((r=e.current)&&(Array.isArray(r.text)?r.text.indexOf("All")>=0:"All"===r.text)&&s.indexOf(e.name)<0){var t=e.options.filter((function(e){return!e.selected}));u.attributes=u.attributes.map((function(n){return t.map((function(t){return e.allValue?n.replace(e.allValue,t.value):n.replace(/{[a-z 0-9,-_]+}/gi,t.value)}))})),u.attributes=(0,w.uniq)((0,w.flatten)(u.attributes)),u.elementPathArray=o.getElementPath(u.elementPathArray,t,e.allValue)}else if(Array.isArray(e.current.text)&&s.indexOf(e.name)<0){var n=e.options.filter((function(e){return e.selected})),a=e.current.value.join(",");u.attributes=u.attributes.map((function(e){return n.map((function(t){return e.replace("{".concat(a,"}"),t.value)}))})),u.attributes=(0,w.uniq)((0,w.flatten)(u.attributes)),u.elementPathArray=o.getElementPath(u.elementPathArray,n,"{".concat(a,"}"))}var r})),u})),e}},{key:"parsePiPointValueData",value:function(e,t,n){var a=this,r=[];return Array.isArray(e)?(0,w.each)(e,(function(e){a.piPointValue(n?e.Value:e,t,n,r)})):this.piPointValue(e,t,n,r),r}},{key:"piPointValue",value:function(e,t,n,a){var r=function(e,t,n){var a,r,i=null,l=!1;return!e.Good||"No Data"===e.Value||null!==(a=e.Value)&&void 0!==a&&a.Name&&"No Data"===(null===(r=e.Value)||void 0===r?void 0:r.Name)?"Drop"===t?l=!0:"0"===t?n[0]=0:"Keep"===t||("Null"===t?n[0]=null:"Previous"===t&&null!==i&&(n[0]=i)):i=e.Value,{grafanaDataPoint:n,previousValue:i,drop:l}}(e,t.summary.nodata,this.parsePiPointValue(e,t,n)),i=r.grafanaDataPoint;r.previousValue,r.drop||a.push(i)}},{key:"parsePiPointValue",value:function(e,t,n){var a,r,i,l,o=n||"object"!==ve(e.Value)?e.Value:null===(a=e.Value)||void 0===a?void 0:a.Value;return!e.Good||null!==(r=t.digitalStates)&&void 0!==r&&r.enable?[re(o=null!==(i=n||"object"!==ve(e.Value)?e.Name:null===(l=e.Value)||void 0===l?void 0:l.Name)&&void 0!==i?i:"")?Number(o):o.trim(),new Date(e.Timestamp).getTime()]:[re(o)?Number(o):o.trim(),new Date(e.Timestamp).getTime()]}},{key:"toTags",value:function(e,t){var n,a=["Path","WebId","Id","ServerTime","ServerVersion"],r=(0,w.omitBy)(e,(function(e,t){return!e||!e.length||a.indexOf(t)>=0}));return r.Element=t?this.piserver.name:ie(null!==(n=e.Path)&&void 0!==n?n:""),Object.keys(r).sort().reduce((function(e,t){var n;return e[(n=t,n.charAt(0).toLocaleLowerCase()+n.slice(1))]=r[t],e}),{})}},{key:"processResults",value:function(e,t,n,a,r){var i=this,l=t.summary&&t.summary.types&&t.summary.types.length>0;if(t.isPiPoint||t.display||!e.Path||(n=i.newFormatConfig?(a?ie(e.Path):le(t.elementPathArray,e.Path))+"|"+n:a?n:le(t.elementPathArray,e.Path)+"|"+n),t.regex&&t.regex.enable&&t.regex.search.length&&t.regex.replace.length&&(n=n.replace(new RegExp(t.regex.search),t.regex.replace)),l){var o=[],u=(0,w.groupBy)(e.Items,(function(e){return e.Type}));return(0,w.forOwn)(u,(function(e,a){o.push({refId:t.refId,target:n+"["+a+"]",meta:{path:r.Path,pathSeparator:"\\"},tags:i.newFormatConfig?i.toTags(r,t.isPiPoint):{},datapoints:i.parsePiPointValueData(e,t,l),path:r.Path,unit:i.useUnitConfig&&t.useUnit.enable?r.DefaultUnitsName:void 0})})),o}return[{refId:t.refId,target:n,meta:{path:r.Path,pathSeparator:"\\"},tags:i.newFormatConfig?i.toTags(r,t.isPiPoint):{},datapoints:i.parsePiPointValueData(e.Items||e.Value,t,l),path:r.Path,unit:i.useUnitConfig&&t.useUnit.enable?r.DefaultUnitsName:void 0}]}},{key:"getElementPath",value:function(e,t,n){var a=[];return e.forEach((function(e){if(n&&e.path.indexOf(n)>=0||!n&&e.path.match(/{[a-z 0-9,-_]+}/gi)){var r=t.map((function(t){return{path:n?e.path.replace(n,t.value):e.path.replace(/{[a-z 0-9,-_]+}/gi,t.value),variable:t.value}}));a=a.concat(r)}})),a.length?(0,w.uniq)((0,w.flatten)(a)):e}},{key:"getStream",value:function(e){var t=this,n=this,a=[];return(0,w.each)(e.targets,(function(r){if(!r.isPiPoint||n.piPointConfig){r.attributes=(0,w.filter)(r.attributes||[],(function(e){return e}));var i="",l=r.summary&&r.summary.types&&r.summary.types.length>0,o=r.interpolate&&r.interpolate.enable,u=r.recordedValues&&r.recordedValues.enable,s=r.interpolate.interval?r.interpolate.interval:e.interval,c="?startTime="+e.range.from.toJSON()+"&endTime="+e.range.to.toJSON(),m=r.expression||r.elementPath,p=r.display?t.templateSrv.replace(r.display,e.scopedVars):null;if(r.expression){var f;if(i+="/calculation",null!==(f=r.useLastValue)&&void 0!==f&&f.enable)i+="/times?&time="+e.range.to.toJSON();else if(l)i+="/summary"+c+(o?"&sampleType=Interval&sampleInterval="+s:"");else if(o)i+="/intervals"+c+"&sampleInterval="+s;else if(u)i+="/recorded"+c;else{for(var d=Math.floor((e.range.to.valueOf()-e.range.from.valueOf())/40),h="time="+e.range.from.toJSON(),v=1;v<40;v++){var g=e.range.from.valueOf()+v*d;h+="&time="+new Date(g).toISOString()}h+="&time="+e.range.to.toJSON(),i+="/times?"+h}i+="&expression="+encodeURIComponent(r.expression.replace(/\${intervalTime}/g,s)),r.attributes.length>0?a.push(n.createBatchGetWebId(r,i,p)):a.push(n.restGetWebId(r.elementPath,!1).then((function(e){return n.restPost(i+"&webId="+e.WebId).then((function(t){return n.processResults(t.data,r,p||m,!1,e)})).catch((function(e){return n.error=e}))})))}else{var b;if(i+="/streamsets",null!==(b=r.useLastValue)&&void 0!==b&&b.enable)i+="/value?time="+e.range.to.toJSON();else if(l)i+="/summary"+c+"&intervals="+e.maxDataPoints+t.getSummaryUrl(r.summary);else if(o)i+="/interpolated"+c+"&interval="+s;else if(u){var y=r.recordedValues.maxNumber&&!isNaN(r.recordedValues.maxNumber)?r.recordedValues.maxNumber:e.maxDataPoints;i+="/recorded"+c+"&maxCount="+y}else i+="/plot"+c+"&intervals="+e.maxDataPoints;a.push(n.createBatchGetWebId(r,i,p))}}})),a}},{key:"handleBatchResponse",value:function(e,t,n){for(var a=this,r=t.expression||t.elementPath,i=1===t.elementPathArray.length&&t.elementPath===t.elementPathArray[0].path,l=i?t.attributes.length:t.elementPathArray.length,o=[],u=function(l){var u="Req".concat(l+1e3),s=e.config.data[u].Headers?e.config.data[u].Headers["Asset-Path"]:null,c=e.data[u];if(c.Status>=400)return"continue";var m=void 0;if(s)m=a.webidCache.get(s);else{var p=e.data["Req".concat(l)].Content;m={Path:p.Path,Type:p.Type||p.PointType,DefaultUnitsName:p.DefaultUnitsName||p.EngineeringUnits,Description:p.Description||p.Descriptor,WebId:p.WebId,Name:p.Name},a.webidCache.set(m.Path,m)}t.expression?(0,w.each)(a.processResults(c.Content,t,n||m.Name||r,i,m),(function(e){return o.push(e)})):(0,w.each)(c.Content.Items,(function(e){(0,w.each)(a.processResults(e,t,n||e.Name||r,i,m),(function(e){return o.push(e)}))}))},s=1;s<=l;s++)u(s);return Promise.resolve(o)}},{key:"createQueryPair",value:function(e,t,n,a,r,i,l){var o="",u="";o=e?"/points?selectedFields=Descriptor%3BPointType%3BEngineeringUnits%3BWebId%3BName%3BPath&path="+(u="\\\\"+t+"\\"+n):"/attributes?selectedFields=Type%3BDefaultUnitsName%3BDescription%3BWebId%3BName%3BPath&path="+(u="\\\\"+t+"|"+n);var s=this.webidCache.get(u);s?a["Req".concat(r+1e3)]={Method:"GET",Resource:this.piwebapiurl+oe(i,{Name:n},l)+"&webId="+(i?this.piserver.webid:s.WebId),Headers:{"Asset-Path":u}}:(a["Req".concat(r)]={Method:"GET",Resource:this.piwebapiurl+o},a["Req".concat(r+1e3)]={Method:"GET",ParentIds:["Req".concat(r)],Parameters:["$.Req".concat(r,".Content.WebId")],Resource:this.piwebapiurl+oe(i,{Name:n},l)+(i?"&webId="+this.piserver.webid:"&webId={0}")})}},{key:"createBatchGetWebId",value:function(e,t,n){var a,r=this,i=1===e.elementPathArray.length&&e.elementPath===e.elementPathArray[0].path,l=e.isPiPoint&&!!e.expression,o={},u=1,s=de(e.attributes);try{var c=function(){var n=a.value;i?(r.createQueryPair(e.isPiPoint,e.elementPath,n,o,u,l,t),u++):e.elementPathArray.forEach((function(a){r.createQueryPair(e.isPiPoint,a.path,n,o,u,l,t),u++}))};for(s.s();!(a=s.n()).done;)c()}catch(e){s.e(e)}finally{s.f()}return this.restBatch(o).then((function(t){return r.handleBatchResponse(t,e,n)}))}},{key:"restGet",value:function(e){return this.backendSrv.datasourceRequest({url:this.url+e,method:"GET",headers:{"Content-Type":"application/json"}}).then((function(e){return e}))}},{key:"restGetWebId",value:function(e,t){var n=this,a=n.webidCache.get(e);if(a)return Promise.resolve(fe({},a));var r="";return r=t?"/points?selectedFields=Descriptor%3BPointType%3BEngineeringUnits%3BWebId%3BName%3BPath&path=\\\\"+e.replace("|","\\"):(e.indexOf("|")>=0?"/attributes?selectedFields=Type%3BDefaultUnitsName%3BDescription%3BWebId%3BName%3BPath&path=\\\\":"/elements?selectedFields=Description%3BWebId%3BName%3BPath&path=\\\\")+e,this.backendSrv.datasourceRequest({url:this.url+r,method:"GET",headers:{"Content-Type":"application/json"}}).then((function(t){var a={Path:e,Type:t.data.Type||t.data.PointType,DefaultUnitsName:t.data.DefaultUnitsName||t.data.EngineeringUnits,Description:t.data.Description||t.data.Descriptor,WebId:t.data.WebId,Name:t.data.Name};return n.webidCache.set(e,a),fe({},a)}))}},{key:"restBatch",value:function(e){return this.backendSrv.datasourceRequest({url:this.url+"/batch",data:e,method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"message/http"}})}},{key:"restPost",value:function(e){return this.backendSrv.datasourceRequest({url:this.url,method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"message/http","X-PIWEBAPI-HTTP-METHOD":"GET","X-PIWEBAPI-RESOURCE-ADDRESS":e}})}},{key:"getDataServers",value:function(){return this.restGet("/dataservers").then((function(e){var t;return null!==(t=e.data.Items)&&void 0!==t?t:[]}))}},{key:"getDataServer",value:function(e){return e?this.restGet("/dataservers?name="+e).then((function(e){return e.data})):Promise.resolve({})}},{key:"getAssetServers",value:function(){return this.restGet("/assetservers").then((function(e){var t;return null!==(t=e.data.Items)&&void 0!==t?t:[]}))}},{key:"getAssetServer",value:function(e){return e?this.restGet("/assetservers?path=\\\\"+e).then((function(e){return e.data})):Promise.resolve({})}},{key:"getDatabase",value:function(e){return e?this.restGet("/assetdatabases?path=\\\\"+e).then((function(e){return e.data})):Promise.resolve({})}},{key:"getDatabases",value:function(e,t){return e?this.restGet("/assetservers/"+e+"/assetdatabases").then((function(e){var t;return null!==(t=e.data.Items)&&void 0!==t?t:[]})):Promise.resolve([])}},{key:"getElement",value:function(e){return e?this.restGet("/elements?path=\\\\"+e).then((function(e){return e.data})):Promise.resolve({})}},{key:"getEventFrameTemplates",value:function(e){return e?this.restGet("/assetdatabases/"+e+"/elementtemplates?selectedFields=Items.InstanceType%3BItems.Name%3BItems.WebId").then((function(e){var t;return(0,w.filter)(null!==(t=e.data.Items)&&void 0!==t?t:[],(function(e){return"EventFrame"===e.InstanceType}))})):Promise.resolve([])}},{key:"getElementTemplates",value:function(e){return e?this.restGet("/assetdatabases/"+e+"/elementtemplates?selectedFields=Items.InstanceType%3BItems.Name%3BItems.WebId").then((function(e){var t;return(0,w.filter)(null!==(t=e.data.Items)&&void 0!==t?t:[],(function(e){return"Element"===e.InstanceType}))})):Promise.resolve([])}},{key:"getAttributes",value:function(e,t){var n="?"+(0,w.map)(t,(function(e,t){return t+"="+e})).join("&");return"?"===n&&(n=""),this.restGet("/elements/"+e+"/attributes"+n).then((function(e){var t;return null!==(t=e.data.Items)&&void 0!==t?t:[]}))}},{key:"getDatabaseElements",value:function(e,t){var n="?"+(0,w.map)(t,(function(e,t){return t+"="+e})).join("&");return"?"===n&&(n=""),this.restGet("/assetdatabases/"+e+"/elements"+n).then((function(e){var t;return null!==(t=e.data.Items)&&void 0!==t?t:[]}))}},{key:"getElements",value:function(e,t){var n="?"+(0,w.map)(t,(function(e,t){return t+"="+e})).join("&");return"?"===n&&(n=""),this.restGet("/elements/"+e+"/elements"+n).then((function(e){var t;return null!==(t=e.data.Items)&&void 0!==t?t:[]}))}},{key:"piPointSearch",value:function(e,t){var n=this.templateSrv.replace(t),a="".concat(n),r=!1;if(n!==t)for(var i,l=/\{(\w|,)+\}/g;null!==(i=l.exec(n));)i.index===l.lastIndex&&l.lastIndex++,i.forEach((function(e,t){0===t&&(n=n.replace(e,e.replace("{","(").replace("}",")").replace(",","|")),a=a.replace(e,"*"),r=!0)}));return this.restGet("/dataservers/"+e+"/points?maxCount=50&nameFilter="+a).then((function(e){var t;return e&&null!==(t=e.data)&&void 0!==t&&t.Items?r?e.data.Items.filter((function(e){var t;return null===(t=e.Name)||void 0===t?void 0:t.match(n)})):e.data.Items:[]}))}}],a&&Pe(t.prototype,a),r&&Pe(t,r),Object.defineProperty(t,"prototype",{writable:!1}),u}(n.DataSourceApi),Ae=new n.DataSourcePlugin(Oe).setQueryEditor(Y).setConfigEditor(S)})(),s})()));
//# sourceMappingURL=module.js.map