define(["@grafana/data","react","@grafana/ui","lodash","rxjs","@grafana/runtime"],((e,t,a,n,l,r)=>(()=>{"use strict";var i={781:t=>{t.exports=e},531:e=>{e.exports=r},7:e=>{e.exports=a},241:e=>{e.exports=n},959:e=>{e.exports=t},269:e=>{e.exports=l}},s={};function o(e){var t=s[e];if(void 0!==t)return t.exports;var a=s[e]={exports:{}};return i[e](a,a.exports,o),a.exports}o.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return o.d(t,{a:t}),t},o.d=(e,t)=>{for(var a in t)o.o(t,a)&&!o.o(e,a)&&Object.defineProperty(e,a,{enumerable:!0,get:t[a]})},o.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),o.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var u={};o.r(u),o.d(u,{plugin:()=>X});var m=o(781),h=o(959),d=o.n(h),c=o(7);function p(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function v(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{},n=Object.keys(a);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(a).filter((function(e){return Object.getOwnPropertyDescriptor(a,e).enumerable})))),n.forEach((function(t){p(e,t,a[t])}))}return e}function g(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t.push.apply(t,a)}return t}(Object(t)).forEach((function(a){Object.defineProperty(e,a,Object.getOwnPropertyDescriptor(t,a))})),e}const{FormField:b}=c.LegacyForms,y=e=>g(v({},e),{jsonData:g(v({},e.jsonData),{url:e.url})});class f extends h.PureComponent{render(){const{options:e}=this.props,t=y(e);return d().createElement("div",null,d().createElement(c.DataSourceHttpSettings,{defaultUrl:"https://server.name/piwebapi",dataSourceConfig:t,onChange:this.onHttpOptionsChange,showAccessOptions:!0}),d().createElement("h3",{className:"page-heading"},"Custom Configuration"),d().createElement("div",{className:"gf-form-group"},d().createElement("div",{className:"gf-form"},d().createElement(b,{label:"Max Cache Time",labelWidth:13,inputWidth:12,type:"number",tooltip:"Maximum number of hours for WebID cache. Default 12h",onChange:this.onMaxCacheTimeChange,value:t.jsonData.maxCacheTime,placeholder:"Cache in hours"})),d().createElement("div",{className:"gf-form-inline"},d().createElement(c.InlineField,{label:"Enable PI Points in Query",labelWidth:26,tooltip:"Allow queries to PI data server"},d().createElement(c.InlineSwitch,{value:t.jsonData.pipoint,onChange:this.onPiPointChange}))),d().createElement("div",{className:"gf-form-inline"},d().createElement(c.InlineField,{label:"Enable New Data Format",labelWidth:26,tooltip:"Allow new extended format in data frames"},d().createElement(c.InlineSwitch,{value:t.jsonData.newFormat,onChange:this.onNewFormatChange}))),d().createElement("div",{className:"gf-form-inline"},d().createElement(c.InlineField,{label:"Enable Unit From Data",labelWidth:26,tooltip:"Add units defined in PI to data frames"},d().createElement(c.InlineSwitch,{value:t.jsonData.useUnit,onChange:this.onUseUnitChange})))),d().createElement("h3",{className:"page-heading"},"PI/AF Connection Details"),d().createElement("div",{className:"gf-form-group"},t.jsonData.pipoint&&d().createElement("div",{className:"gf-form"},d().createElement(b,{label:"PI Server",labelWidth:13,inputWidth:20,onChange:this.onPIServerChange,value:t.jsonData.piserver||"",tooltip:"Default PI Server to use for data requests",placeholder:"PI Server"})),d().createElement("div",{className:"gf-form"},d().createElement(b,{label:"AF Server",labelWidth:13,inputWidth:20,onChange:this.onAFServerChange,value:t.jsonData.afserver||"",tooltip:"Default AF Server to use for data requests",placeholder:"AF Server"})),d().createElement("div",{className:"gf-form"},d().createElement(b,{label:"AF Database",labelWidth:13,inputWidth:20,onChange:this.onAFDatabaseChange,value:t.jsonData.afdatabase||"",tooltip:"Default AF Database server for AF queries",placeholder:"AF Database"}))),d().createElement("h3",{className:"page-heading"},"Additional Configuration"),d().createElement("div",{className:"gf-form-group"},d().createElement("div",{className:"gf-form-inline"},d().createElement(c.InlineField,{label:"Enable Experimental Features",labelWidth:26},d().createElement(c.InlineSwitch,{value:t.jsonData.useExperimental,onChange:this.onUseExperimentalChange}))),t.jsonData.useExperimental&&d().createElement("div",{className:"gf-form-inline"},d().createElement(c.InlineField,{label:"Enable Response Cache",labelWidth:26,tooltip:"Use cached response when API returns error"},d().createElement(c.InlineSwitch,{value:t.jsonData.useResponseCache,onChange:this.onUseResponseCacheChange})))))}constructor(...e){super(...e),p(this,"onPIServerChange",(e=>{const{onOptionsChange:t,options:a}=this.props,n=g(v({},a.jsonData),{piserver:e.target.value});t(g(v({},a),{jsonData:n}))})),p(this,"onAFServerChange",(e=>{const{onOptionsChange:t,options:a}=this.props,n=g(v({},a.jsonData),{afserver:e.target.value});t(g(v({},a),{jsonData:n}))})),p(this,"onAFDatabaseChange",(e=>{const{onOptionsChange:t,options:a}=this.props,n=g(v({},a.jsonData),{afdatabase:e.target.value});t(g(v({},a),{jsonData:n}))})),p(this,"onHttpOptionsChange",(e=>{const{onOptionsChange:t}=this.props;t(y(e))})),p(this,"onPiPointChange",(e=>{const{onOptionsChange:t,options:a}=this.props,n=g(v({},a.jsonData),{piserver:e.target.checked?a.jsonData.piserver:"",pipoint:e.target.checked});t(g(v({},a),{jsonData:n}))})),p(this,"onNewFormatChange",(e=>{const{onOptionsChange:t,options:a}=this.props,n=g(v({},a.jsonData),{newFormat:e.target.checked});t(g(v({},a),{jsonData:n}))})),p(this,"onMaxCacheTimeChange",(e=>{const{onOptionsChange:t,options:a}=this.props,n=g(v({},a.jsonData),{maxCacheTime:Number(e.target.value)});t(g(v({},a),{jsonData:n}))})),p(this,"onUseUnitChange",(e=>{const{onOptionsChange:t,options:a}=this.props,n=g(v({},a.jsonData),{useUnit:e.target.checked});t(g(v({},a),{jsonData:n}))})),p(this,"onUseExperimentalChange",(e=>{const{onOptionsChange:t,options:a}=this.props,n=g(v({},a.jsonData),{useExperimental:e.target.checked,useStreaming:!!e.target.checked&&a.jsonData.useStreaming});t(g(v({},a),{jsonData:n}))})),p(this,"onUseStreamingChange",(e=>{const{onOptionsChange:t,options:a}=this.props,n=g(v({},a.jsonData),{useStreaming:e.target.checked});t(g(v({},a),{jsonData:n}))})),p(this,"onUseResponseCacheChange",(e=>{const{onOptionsChange:t,options:a}=this.props,n=g(v({},a.jsonData),{useResponseCache:e.target.checked});t(g(v({},a),{jsonData:n}))}))}}var E=o(241);function S(){return S=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e},S.apply(this,arguments)}function C(e){if(null==e)throw new TypeError("Cannot destructure "+e);return e}const I=({label:e,labelWidth:t=12,tooltip:a,children:n})=>d().createElement(d().Fragment,null,d().createElement(c.InlineFormLabel,{width:t,tooltip:a},e),n),P=()=>d().createElement("div",{className:"gf-form gf-form--grow"},d().createElement("div",{className:"gf-form-label gf-form-label--grow"})),w=e=>{var t=S({},C(e));return d().createElement(O,null,d().createElement(I,t))},O=e=>d().createElement("div",{className:"gf-form-inline"},e.children,d().createElement(P,null)),x=e=>{var t=S({},C(e));return d().createElement(D,null,d().createElement(I,t))},D=e=>d().createElement(d().Fragment,null,e.children),F={target:";",attributes:[],segments:[],regex:{enable:!1},nodata:"Null",summary:{enable:!1,types:[],basis:"EventWeighted",duration:"",sampleTypeInterval:!1,sampleInterval:""},expression:"",interpolate:{enable:!1},useLastValue:{enable:!1},recordedValues:{enable:!1,boundaryType:"Inside"},digitalStates:{enable:!1},enableStreaming:{enable:!1},useUnit:{enable:!1},isPiPoint:!1},j=({isRaw:e,onChange:t})=>{const[a,n]=(0,h.useState)(!1);return(0,h.useEffect)((()=>{n(!1)}),[e]),e?d().createElement(d().Fragment,null,d().createElement(c.Button,{"aria-label":"Switch to visual editor",icon:"pen",variant:"secondary",type:"button",onClick:()=>{n(!0)}}),d().createElement(c.ConfirmModal,{isOpen:a,title:"Switch to visual editor mode",body:"Are you sure to switch to visual editor mode? You will lose the changes done in raw query mode.",confirmText:"Yes, switch to editor mode",dismissText:"No, stay in raw query mode",onConfirm:()=>{t(!1)},onDismiss:()=>{n(!1)}})):d().createElement(c.Button,{"aria-label":"Switch to text editor",icon:"pen",variant:"secondary",type:"button",onClick:()=>{t(!0)}})};function A(e){var t;return(0,E.filter)(null!==(t=null==e?void 0:e.types)&&void 0!==t?t:[],(e=>null!=e&&""!==String(e))).map((e=>{if("string"==typeof e||e instanceof String){const t=String(e);return{label:t,value:{value:t,expandable:!0}}}return e}))}function V(e){return(0,E.map)(e,(e=>{var t,a;return{text:e.Name,expandable:void 0===e.HasChildren||!0===e.HasChildren||(null!==(t=e.Path)&&void 0!==t?t:"").split("\\").length<=3,HasChildren:e.HasChildren,Items:null!==(a=e.Items)&&void 0!==a?a:[],Path:e.Path,WebId:e.WebId}}))}function W(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function T(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{},n=Object.keys(a);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(a).filter((function(e){return Object.getOwnPropertyDescriptor(a,e).enumerable})))),n.forEach((function(t){W(e,t,a[t])}))}return e}function N(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t.push.apply(t,a)}return t}(Object(t)).forEach((function(a){Object.defineProperty(e,a,Object.getOwnPropertyDescriptor(t,a))})),e}const B=24,R=250,q="-REMOVE-",k=e=>{var t;return e.value?d().createElement("div",{style:{width:e.width,marginRight:e.marginRight},className:"gf-form-label "+("template"===e.value.type?"query-keyword":"")},null!==(t=e.label)&&void 0!==t?t:"--no label--"):d().createElement("a",{className:"gf-form-label query-part"},d().createElement(c.Icon,{name:"plus"}))};class U extends h.PureComponent{isValueEmpty(e){return!e||!e.value||!e.value.length||e.value===q}calcBasisValueChanged(e){const t=this.props.query,a=t.summary;var n;a&&(a.basis=null===(n=e.value)||void 0===n?void 0:n.value),this.onChange(N(T({},t),{summary:a}))}getCalcBasisSegments(){return(0,E.map)(this.calculationBasis,(e=>({label:e,value:{value:e,expandable:!0}})))}recordedBoundaryTypeValueChanged(e){const t=this.props.query,a=t.recordedValues;var n;a&&(a.boundaryType=null===(n=e.value)||void 0===n?void 0:n.value),this.onChange(N(T({},t),{recordedValues:a}))}getRecordedBoundaryTypeSegments(){return(0,E.map)(this.recordedBoundaryTypes,(e=>({label:e,value:{value:e,expandable:!0}})))}calcNoDataValueChanged(e){var t;const a=this.props.query,n=null===(t=e.value)||void 0===t?void 0:t.value;this.onChange(N(T({},a),{nodata:n}))}getNoDataSegments(){return(0,E.map)(this.noDataReplacement,(e=>({label:e,value:{value:e,expandable:!0}})))}onSummaryValueChanged(e,t){const a=this.state.summaries.slice(0);a[t]=e,this.isValueEmpty(e.value)&&a.splice(t,1),this.setState({summaries:a},this.stateCallback)}getSummarySegments(){const e=(0,E.filter)(this.summaryTypes,(e=>-1===this.state.summaries.map((e=>{var t;return null===(t=e.value)||void 0===t?void 0:t.value})).indexOf(e))),t=(0,E.map)(e,(e=>({label:e,value:{value:e,expandable:!0}})));return t.unshift({label:q,value:{value:q}}),t}removeSummary(e){const t=(0,E.filter)(this.state.summaries,(t=>t!==e));this.setState({summaries:t})}onSummaryAction(e){const t=this.state.summaries.slice(0);if(!this.isValueEmpty(e.value)){var a;let n={label:e.label,value:{value:null===(a=e.value)||void 0===a?void 0:a.value,expandable:!0}};t.push(n)}this.setState({summarySegment:{},summaries:t},this.stateCallback)}removeAttribute(e){const t=(0,E.filter)(this.state.attributes,(t=>t!==e));this.attributeChangeValue(t)}onAttributeAction(e){const{query:t}=this.props,a=this.state.attributes.slice(0);if(null!==e.value&&"object"!=typeof e.value&&!Array.isArray(e.value)){const t=String(e.value);e.value={type:t.match(/\${\w+}/gi)?"template":void 0,value:t}}if(!this.isValueEmpty(e.value)){var n,l,r;let i={label:e.label,value:{type:(null===(n=e.value)||void 0===n?void 0:n.value)&&(null===(l=e.value)||void 0===l?void 0:l.value.match(/\${\w+}/gi))?"template":void 0,value:null===(r=e.value)||void 0===r?void 0:r.value,expandable:!t.isPiPoint}};a.push(i)}this.attributeChangeValue(a)}getSegmentPathUpTo(e,t){const a=e.slice(0,t);return(0,E.reduce)(a,((e,t)=>{var a;return t.value?(null===(a=t.value.value)||void 0===a?void 0:a.startsWith("-Select"))?e:e?e+"\\"+t.value.value:t.value.value:""}),"")}checkAttributeSegments(e,t){var a;const{datasource:n,data:l}=this.props,r=this,i={path:this.getSegmentPathUpTo(t.slice(0),t.length),type:"attributes"};var s;return n.metricFindQuery(i,Object.assign(null!==(s=null==l||null===(a=l.request)||void 0===a?void 0:a.scopedVars)&&void 0!==s?s:{},{isPiPoint:!1})).then((t=>{const a={};(0,E.each)(t,(e=>{a[e.Path.substring(e.Path.indexOf("|")+1)]=e.WebId}));const l=(0,E.filter)(e,(e=>{var t;const l=n.templateSrv.replace(null===(t=e.value)||void 0===t?void 0:t.value);return void 0!==a[l]}));return r.availableAttributes=a,this.attributeChangeValue(l)})).catch((t=>(r.error=t.message||"Failed to issue metric query",this.attributeChangeValue(e))))}checkPiPointSegments(e,t){var a;const{datasource:n,data:l}=this.props,r=this,i={path:e.path,webId:r.getSelectedPIServer(),pointName:e.label,type:"pipoint"};var s;return n.metricFindQuery(i,Object.assign(null!==(s=null==l||null===(a=l.request)||void 0===a?void 0:a.scopedVars)&&void 0!==s?s:{},{isPiPoint:!0})).then((()=>r.attributeChangeValue(t))).catch((e=>(r.error=e.message||"Failed to issue metric query",r.attributeChangeValue([]))))}getSelectedPIServer(){var e;let t="";return this.piServer.forEach((e=>{const a=this.props.query.target.split(";");a.length>=2&&a[0]===e.text&&(t=e.WebId)})),this.piServer.length>0?null===(e=this.piServer[0].value)||void 0===e?void 0:e.webId:t}textEditorChanged(){const{query:e}=this.props,t=e.target.split(";"),a=t.length>0?t[0].split("\\"):[];let n=[],l=[];a.length>1||1===a.length&&""!==a[0]?(t.splice(0,1),(0,E.each)(a,((e,t)=>{n.push({label:e,value:{type:e.match(/\${\w+}/gi)?"template":void 0,value:e,expandable:!0}})})),(0,E.each)(t,(function(e,t){""!==e&&l.push({label:e,value:{type:e.match(/\${\w+}/gi)?"template":void 0,value:e,expandable:!1}})})),this.getElementSegments(a.length+1,n).then((e=>{e.length>0&&n.push({label:"Select Element",value:{value:"-Select Element-"}})})).then((()=>{this.updateArray(n,l,this.state.summaries,e.isPiPoint,(()=>{this.onChange(N(T({},e),{query:void 0,rawQuery:!1,attributes:this.state.attributes,segments:this.state.segments}))}))}))):(n=this.checkAfServer(),this.updateArray(n,this.state.attributes,this.state.summaries,e.isPiPoint,(()=>{this.onChange(N(T({},e),{query:void 0,rawQuery:!1,attributes:this.state.attributes,segments:this.state.segments}))})))}render(){const{query:e,onChange:t,onRunQuery:a}=this.props,n=(0,E.defaults)(e,F),{useLastValue:l,useUnit:r,interpolate:i,query:s,rawQuery:o,digitalStates:u,enableStreaming:m,recordedValues:h,expression:p,isPiPoint:v,hideError:g,summary:b,nodata:y,display:f,regex:S}=n;return d().createElement(d().Fragment,null,this.props.datasource.piPointConfig&&d().createElement(c.InlineField,{label:"Is Pi Point?",labelWidth:B},d().createElement(c.InlineSwitch,{value:v,onChange:this.onIsPiPointChange})),!!o&&d().createElement(c.InlineFieldRow,null,d().createElement(c.InlineField,{label:"Raw Query",labelWidth:B,grow:!0},d().createElement(c.Input,{onBlur:this.stateCallback,value:s,onChange:e=>t(N(T({},n),{query:e.target.value})),placeholder:"enter query"})),d().createElement(j,{isRaw:!0,onChange:e=>this.textEditorChanged()})),!o&&d().createElement(d().Fragment,null,d().createElement("div",{className:"gf-form-inline"},d().createElement(x,{label:v?"PI Server":"AF Elements",tooltip:v?"Select PI server.":"Select AF Element."},this.state.segments.map(((e,t)=>d().createElement(c.SegmentAsync,{key:"element-"+t,Component:d().createElement(k,{value:e.value,label:e.label}),onChange:e=>this.onSegmentChange(e,t),loadOptions:e=>this.getElementSegments(t),allowCustomValue:!0,inputMinWidth:200}))),d().createElement(P,null),!v&&d().createElement(j,{isRaw:!1,onChange:e=>{t(N(T({},n),{query:n.target,rawQuery:e}))}}))),d().createElement(w,{label:v?"Pi Points":"Attributes"},this.state.attributes.map(((e,t)=>v?d().createElement(c.SegmentAsync,{key:"attributes-"+t,Component:d().createElement(k,{value:e.value,label:e.label}),disabled:0===this.piServer.length,onChange:e=>this.onPiPointChange(e,t),loadOptions:this.getAttributeSegmentsPI,reloadOptionsOnChange:!0,allowCustomValue:!0,inputMinWidth:R}):d().createElement(c.Segment,{key:"attributes-"+t,Component:d().createElement(k,{value:e.value,label:e.label}),disabled:this.state.segments.length<=2,onChange:e=>this.onAttributeChange(e,t),options:this.getAttributeSegmentsAF(),allowCustomValue:!0,inputMinWidth:R}))),v&&d().createElement(c.SegmentAsync,{Component:d().createElement(k,{value:this.state.attributeSegment.value,label:this.state.attributeSegment.label}),disabled:0===this.piServer.length,onChange:this.onAttributeAction,loadOptions:this.getAttributeSegmentsPI,reloadOptionsOnChange:!0,allowCustomValue:!0,inputMinWidth:R}),!v&&d().createElement(c.Segment,{Component:d().createElement(k,{value:this.state.attributeSegment.value,label:this.state.attributeSegment.label}),disabled:this.state.segments.length<=2,onChange:this.onAttributeAction,options:this.getAttributeSegmentsAF(),allowCustomValue:!0,inputMinWidth:R}))),d().createElement(c.InlineFieldRow,null,d().createElement(c.InlineField,{label:"Calculation",grow:!0,labelWidth:B,tooltip:"Modify all attributes by an equation. Use '.' for current item. Leave Attributes empty if you wish to perform element based calculations."},d().createElement(c.Input,{onBlur:a,value:p,onChange:e=>t(N(T({},n),{expression:e.target.value})),placeholder:"'.'*2"}))),d().createElement(c.InlineFieldRow,null,d().createElement(c.InlineField,{label:"Use Last Value",tooltip:"Returns values of the attributes for an Element or Pi Point at the specified end time (StreamSet GetValues).",labelWidth:B},d().createElement(c.InlineSwitch,{value:l.enable,onChange:()=>this.onChange(N(T({},n),{useLastValue:N(T({},l),{enable:!l.enable}),recordedValues:F.recordedValues,interpolate:F.interpolate,summary:F.summary}))})),l.enable&&d().createElement(c.InlineField,{label:"Ignore end time",tooltip:"Returns End of stream value (StreamSet GetEnd). Ignore selected end time.",labelWidth:B},d().createElement(c.InlineSwitch,{value:h.enable,onChange:()=>this.onChange(N(T({},n),{recordedValues:{enable:!h.enable,boundaryType:"Inside"}}))})),d().createElement(c.InlineField,{label:"Digital States",labelWidth:B},d().createElement(c.InlineSwitch,{value:u.enable,onChange:()=>this.onChange(N(T({},n),{digitalStates:N(T({},u),{enable:!u.enable})}))})),d().createElement(c.InlineField,{label:"Replace Bad Data",labelWidth:B,tooltip:"Replacement for bad quality values."},d().createElement(c.Segment,{Component:d().createElement(k,{width:96,value:{value:y},label:y}),onChange:this.calcNoDataValueChanged,options:this.getNoDataSegments(),allowCustomValue:!0})),this.props.datasource.useUnitConfig&&d().createElement(c.InlineField,{label:"Use unit from datapoints",tooltip:"Use unit in label from PI tag or PI AF attribute",labelWidth:B},d().createElement(c.InlineSwitch,{value:r.enable,onChange:()=>this.onChange(N(T({},n),{useUnit:N(T({},r),{enable:!r.enable})}))})),this.props.datasource.useStreaming&&d().createElement(c.InlineField,{label:"Enable Streaming",labelWidth:B,tooltip:"Enable streaming data if it is supported for the point type."},d().createElement(c.InlineSwitch,{value:m.enable,onChange:()=>this.onChange(N(T({},n),{enableStreaming:N(T({},m),{enable:!m.enable})}))}))),(i.enable||!l.enable&&!h.enable&&!b.enable)&&d().createElement(c.InlineFieldRow,null,d().createElement(c.InlineField,{label:p?"Interval Values":"Interpolate",labelWidth:B,tooltip:p?"":"Returns interpolated values of attributes for an element or pi point over the specified time range at the specified sampling interval (StreamSet GetInterpolated)."},d().createElement(c.InlineSwitch,{value:i.enable,onChange:()=>this.onChange(N(T({},n),{interpolate:N(T({},i),{enable:!i.enable,interval:void 0}),useLastValue:F.useLastValue,recordedValues:F.recordedValues,summary:F.summary}))})),d().createElement(c.InlineField,{disabled:!i.enable,label:p?"Interval Period":"Interpolate Period",labelWidth:B,tooltip:"Override time between sampling, e.g. '30s'. Defaults to timespan/chart width."},d().createElement(c.Input,{onBlur:a,width:30.633375,value:i.interval,onChange:e=>t(N(T({},n),{interpolate:N(T({},i),{interval:e.target.value})})),placeholder:"30s"}))),!l.enable&&!i.enable&&!b.enable&&d().createElement(c.InlineFieldRow,null,d().createElement(c.InlineField,{label:"Recorded Values",labelWidth:B,tooltip:"Returns recorded values of the attributes for an element, event frame, or attribute (StreamSet GetRecorded)."},d().createElement(c.InlineSwitch,{value:h.enable,onChange:()=>this.onChange(N(T({},n),{recordedValues:N(T({},h),{enable:!h.enable,maxNumber:void 0,boundaryType:"Inside"}),useLastValue:F.useLastValue,interpolate:F.interpolate,summary:F.summary}))})),d().createElement(c.InlineField,{label:"Max Recorded Values",labelWidth:B,tooltip:"Maximum number of recorded value to retrive from the data archive, without using interpolation."},d().createElement(c.Input,{onBlur:a,width:30.633375,value:h.maxNumber,onChange:e=>t(N(T({},n),{recordedValues:N(T({},h),{maxNumber:parseInt(e.target.value,10)})})),type:"number",placeholder:"1000"})),d().createElement(c.InlineField,{label:"Boundary Type",labelWidth:B,tooltip:"Defines the behavior of data retrieval at the end points of a specified time range."},d().createElement(c.Segment,{Component:d().createElement(k,{width:96,value:{value:null==h?void 0:h.boundaryType},label:null==h?void 0:h.boundaryType}),onChange:this.recordedBoundaryTypeValueChanged,options:this.getRecordedBoundaryTypeSegments(),allowCustomValue:!0}))),(b.enable||!h.enable&&!l.enable&&!i.enable)&&d().createElement(c.InlineFieldRow,null,d().createElement(c.InlineField,{label:"Summary Enable",labelWidth:B,tooltip:"Returns summary values of the attributes for an element, event frame or attribute (StreamSet GetSummaries)."},d().createElement(c.InlineSwitch,{value:null==b?void 0:b.enable,onChange:()=>this.onChange(N(T({},n),{summary:N(T({},b),{enable:!(null==b?void 0:b.enable)}),useLastValue:F.useLastValue,recordedValues:F.recordedValues,interpolate:F.interpolate}))})),d().createElement(c.InlineField,{disabled:!(null==b?void 0:b.enable),label:"Summary Basis",labelWidth:B,tooltip:"Defines the possible calculation options when performing summary calculations over time-series data."},d().createElement(c.Segment,{Component:d().createElement(k,{width:245.067,marginRight:"0",value:{value:null==b?void 0:b.basis},label:null==b?void 0:b.basis}),onChange:this.calcBasisValueChanged,options:this.getCalcBasisSegments(),allowCustomValue:!0})),d().createElement(c.InlineField,{disabled:!(null==b?void 0:b.enable),label:"Summaries Types",labelWidth:B,tooltip:"PI Web API summary options."},d().createElement(c.InlineFieldRow,null,this.state.summaries.map(((e,t)=>d().createElement(c.Segment,{key:"summaries-"+t,Component:d().createElement(k,{value:e.value,label:e.label}),onChange:e=>this.onSummaryValueChanged(e,t),options:this.getSummarySegments(),allowCustomValue:!0}))),d().createElement(c.Segment,{Component:d().createElement(k,{value:this.state.summarySegment.value,label:this.state.summarySegment.label}),onChange:this.onSummaryAction,options:this.getSummarySegments(),allowCustomValue:!0})))),(null==b?void 0:b.enable)&&d().createElement(c.InlineFieldRow,null,d().createElement(c.InlineField,{label:"Enable interval",labelWidth:B,tooltip:"Enable summary type interval."},d().createElement(c.InlineSwitch,{value:!!(null==b?void 0:b.sampleTypeInterval),onChange:()=>this.onChange(N(T({},n),{summary:N(T({},b),{sampleTypeInterval:!(null==b?void 0:b.sampleTypeInterval)})}))})),d().createElement(c.InlineField,{disabled:!b.sampleTypeInterval,label:"Sample Interval",labelWidth:B,tooltip:"A time span specifies how often the filter expression is evaluated when computing the summary for an interval, if the sampleType is enable."},d().createElement(c.Input,{onBlur:a,width:30.633375,value:null==b?void 0:b.sampleInterval,onChange:e=>t(N(T({},n),{summary:N(T({},b),{sampleInterval:e.target.value})})),placeholder:"30s"})),d().createElement(c.InlineField,{label:"Summary Period",labelWidth:B,tooltip:"The duration of each summary interval, e.g. '30s'."},d().createElement(c.Input,{onBlur:a,width:30.633375,value:null==b?void 0:b.duration,onChange:e=>t(N(T({},n),{summary:N(T({},b),{duration:e.target.value})})),placeholder:"30s"}))),d().createElement(c.InlineFieldRow,null,d().createElement(c.InlineField,{label:"Display Name",labelWidth:B,tooltip:"If single attribute, modify display name. Otherwise use regex to modify display name."},d().createElement(c.Input,{onBlur:a,width:30.633375,value:f,onChange:e=>t(N(T({},n),{display:e.target.value})),placeholder:"Display"})),d().createElement(c.InlineField,{label:"Enable Regex Replace",labelWidth:B},d().createElement(c.InlineSwitch,{value:S.enable,onChange:()=>{this.onChange(N(T({},n),{regex:N(T({},S),{enable:!S.enable})}))}})),d().createElement(c.InlineField,{label:"Search",labelWidth:B},d().createElement(c.Input,{onBlur:a,width:B,value:S.search,onChange:e=>t(N(T({},n),{regex:N(T({},S),{search:e.target.value})})),placeholder:"(.*)"})),d().createElement(c.InlineField,{label:"Replace",labelWidth:B},d().createElement(c.Input,{onBlur:a,width:B,value:S.replace,onChange:e=>t(N(T({},n),{regex:N(T({},S),{replace:e.target.value})})),placeholder:"$1"}))),d().createElement(c.InlineFieldRow,null,d().createElement(c.InlineField,{label:"Ignore API Error?",labelWidth:B,tooltip:"Don't present errors from PiWebAPI in the panel."},d().createElement(c.InlineSwitch,{value:g,onChange:this.onHideErrorChange}))))}constructor(e){super(e),W(this,"error",void 0),W(this,"piServer",[]),W(this,"availableAttributes",{}),W(this,"summaryTypes",void 0),W(this,"calculationBasis",void 0),W(this,"recordedBoundaryTypes",void 0),W(this,"noDataReplacement",void 0),W(this,"state",{isPiPoint:!1,hideError:!1,segments:[],attributes:[],summaries:[],attributeSegment:{},summarySegment:{},calculationBasisSegment:{},noDataReplacementSegment:{}}),W(this,"segmentChangeValue",(e=>{const t=this.props.query;this.setState({segments:e},(()=>this.onChange(N(T({},t),{segments:e}))))})),W(this,"attributeChangeValue",(e=>{const t=this.props.query;return new Promise((a=>this.setState({attributes:e},(()=>{this.onChange(N(T({},t),{attributes:e})),a()}))))})),W(this,"onPiPointChange",((e,t)=>{let a=this.state.attributes.slice(0);e.label===q?(0,E.remove)(a,((e,a)=>a===t)):a[t]=e,this.checkPiPointSegments(e,a)})),W(this,"onAttributeChange",((e,t)=>{var a;let n=this.state.attributes.slice(0);n[t].label!==(null===(a=e.value)||void 0===a?void 0:a.value)&&(n[t]=e,this.checkAttributeSegments(n,this.state.segments))})),W(this,"onSegmentChange",((e,t)=>{var a;const{query:n}=this.props;let l=this.state.segments.slice(0);if(null!==e.value&&"object"!=typeof e.value&&!Array.isArray(e.value)){const t=String(e.value);e.value={type:t.match(/\${\w+}/gi)?"template":void 0,value:t}}l[t].label!==(null===(a=e.value)||void 0===a?void 0:a.value)&&this.setState({attributes:[]},(()=>e.label===q?(l=(0,E.slice)(l,0,t),void this.checkAttributeSegments([],l).then((()=>{var e;0===l.length?l.push({label:""}):(null===(e=l[l.length-1].value)||void 0===e?void 0:e.expandable)&&l.push({label:"Select Element",value:{value:"-Select Element-"}}),n.isPiPoint&&(this.piServer=[]),this.segmentChangeValue(l)}))):(l[t]=e,n.isPiPoint?(this.piServer.push(e),void this.segmentChangeValue(l)):(t<l.length-1&&(l=(0,E.slice)(l,0,t+1)),void this.checkAttributeSegments([],l).then((()=>{var a,n;return"template"===(null===(a=e.value)||void 0===a?void 0:a.type)?this.getElementSegments(l.length+1,l).then((e=>(e.length>0&&(l[t].value.expandable=!0,l.push({label:"Select Element",value:{value:"-Select Element-"}})),this.segmentChangeValue(l),l))):((null===(n=e.value)||void 0===n?void 0:n.expandable)&&l.push({label:"Select Element",value:{value:"-Select Element-"}}),new Promise((e=>{this.segmentChangeValue(l),e(l)})))}))))))})),W(this,"getElementSegments",((e,t)=>{var a;const{datasource:n,query:l,data:r}=this.props,i=this,s=l.isPiPoint?{type:"dataserver"}:{path:this.getSegmentPathUpTo(null!=t?t:this.state.segments.slice(0),e),afServerWebId:this.state.segments.length>0&&this.state.segments[0].value?this.state.segments[0].value.webId:void 0};if(!l.isPiPoint){var o,u,m;if((null===(o=n.afserver)||void 0===o?void 0:o.name)&&0===e)return Promise.resolve([{label:n.afserver.name,value:{value:n.afserver.name,expandable:!0}}]);if((null===(u=n.afserver)||void 0===u?void 0:u.name)&&(null===(m=n.afdatabase)||void 0===m?void 0:m.name)&&1===e)return Promise.resolve([{label:n.afdatabase.name,value:{value:n.afdatabase.name,expandable:!0}}])}var h;return n.metricFindQuery(s,Object.assign(null!==(h=null==r||null===(a=r.request)||void 0===a?void 0:a.scopedVars)&&void 0!==h?h:{},{isPiPoint:l.isPiPoint})).then((e=>{const t=(0,E.map)(e,(e=>({label:e.text,value:{webId:e.WebId,value:e.text,expandable:!l.isPiPoint&&e.expandable}})));if(0===t.length)return t;const a=n.templateSrv.getVariables();return(0,E.each)(a,(e=>{let a={label:"${"+e.name+"}",value:{type:"template",value:"${"+e.name+"}",expandable:!l.isPiPoint}};t.unshift(a)})),t.unshift({label:q,value:{value:q}}),t})).catch((e=>(i.error=e.message||"Failed to issue metric query",[])))})),W(this,"getAttributeSegmentsPI",(e=>{var t;const{datasource:a,query:n,data:l}=this.props,r=this,i={path:"",webId:this.getSelectedPIServer(),pointName:(null!=e?e:"")+"*",type:"pipoint"};let s=[];var o;return a.metricFindQuery(i,Object.assign(null!==(o=null==l||null===(t=l.request)||void 0===t?void 0:t.scopedVars)&&void 0!==o?o:{},{isPiPoint:n.isPiPoint})).then((t=>{s=(0,E.map)(t,(e=>({path:e.Path,label:e.text,value:{value:e.text,expandable:!1}}))),e&&e.length>0&&s.unshift({label:e,value:{value:e,expandable:!1}});const l=a.templateSrv.getVariables();return(0,E.each)(l,(e=>{let t={label:"${"+e.name+"}",value:{type:"template",value:"${"+e.name+"}",expandable:!n.isPiPoint}};s.unshift(t)})),s.unshift({label:q,value:{value:q}}),s})).catch((e=>(r.error=e.message||"Failed to issue metric query",s)))})),W(this,"getAttributeSegmentsAF",(e=>{const{datasource:t}=this.props;let a=[];a.push({label:q,value:{value:q}});const n=t.templateSrv.getVariables();return(0,E.each)(n,(e=>{let t={label:"${"+e.name+"}",value:{type:"template",value:"${"+e.name+"}",expandable:!1}};a.push(t)})),(0,E.forOwn)(this.availableAttributes,((e,t)=>{let n={label:t,value:{value:t,expandable:!0}};a.push(n)})),a})),W(this,"buildFromTarget",((e,t,a)=>{const n=e.target.split(";"),l=n.length>0?n[0].split("\\"):[];return l.length>1||1===l.length&&""!==l[0]?(n.splice(0,1),(0,E.each)(l,((e,a)=>{t.push({label:e,value:{type:e.match(/\${\w+}/gi)?"template":void 0,value:e,expandable:!0}})})),(0,E.each)(n,((e,t)=>{""!==e&&a.push({label:e,value:{type:e.match(/\${\w+}/gi)?"template":void 0,value:e,expandable:!1}})})),this.getElementSegments(l.length+1,t).then((e=>(e.length>0&&t.push({label:"Select Element",value:{value:"-Select Element-"}}),t)))):Promise.resolve(t)})),W(this,"checkAfServer",(()=>{var e;const{datasource:t}=this.props,a=[];var n;return(null===(e=t.afserver)||void 0===e?void 0:e.name)?(a.push({label:t.afserver.name,value:{value:t.afserver.name,expandable:!0}}),(null===(n=t.afdatabase)||void 0===n?void 0:n.name)&&a.push({label:t.afdatabase.name,value:{value:t.afdatabase.name,expandable:!0}}),a.push({label:"Select Element",value:{value:"-Select Element-"}})):a.push({label:""}),a})),W(this,"updateArray",((e,t,a,n,l)=>{this.setState({segments:e,attributes:t,summaries:a,isPiPoint:n},(()=>{n||this.checkAttributeSegments(t,this.state.segments).then((()=>{l&&l()}))}))})),W(this,"scopedVarsDone",!1),W(this,"componentDidMount",(()=>{this.initialLoad(!1)})),W(this,"componentDidUpdate",(()=>{var e,t,a;const{query:n}=this.props;"Done"===(null===(e=this.props.data)||void 0===e?void 0:e.state)&&(null===(a=this.props.data)||void 0===a||null===(t=a.request)||void 0===t?void 0:t.scopedVars)&&!this.scopedVarsDone&&(this.scopedVarsDone=!0,this.initialLoad(!n.isPiPoint))})),W(this,"initialLoad",(e=>{const{query:t}=this.props,a=(0,E.defaults)(t,F),{segments:n,attributes:l,summary:r,isPiPoint:i}=a;var s;let o=e?[]:null!==(s=null==n?void 0:n.slice(0))&&void 0!==s?s:[];var u;let m=e?[]:null!==(u=null==l?void 0:l.slice(0))&&void 0!==u?u:[],h=A(r);if(i||0!==o.length)i&&o.length>0&&(this.piServer=o);else{if(t.target&&t.target.length>0&&";"!==t.target)return m=[],void this.buildFromTarget(t,o,m).then((e=>{this.updateArray(e,m,h,!1)})).catch((e=>console.error(e)));o=this.checkAfServer()}this.updateArray(o,m,h,!!i,(()=>{this.onChange(t)}))})),W(this,"onChange",(e=>{const{onChange:t,onRunQuery:a}=this.props;var n,l;if(e.rawQuery){if(e.target=null!==(n=e.query)&&void 0!==n?n:"",e.query){const{attributes:t,elementPath:a}=function(e){const t=e.split(";"),a=t[0].split("\\");t.splice(0,1);let n=[];if(a.length>1||1===a.length&&""!==a[0]){const e=a.join("\\");return(0,E.each)(t,(function(e,t){""!==e&&n.push({label:e,value:{value:e,expandable:!1}})})),{attributes:n,elementPath:e}}return{attributes:n,elementPath:null}}(e.target);e.attributes=t,e.elementPath=a}}else e.elementPath=this.getSegmentPathUpTo(this.state.segments,this.state.segments.length),e.target=e.elementPath+";"+(0,E.join)(null===(l=e.attributes)||void 0===l?void 0:l.map((e=>{var t;return null===(t=e.value)||void 0===t?void 0:t.value})),";");const r=T({},F.summary,e.summary);r&&(r.types=this.state.summaries),t(N(T({},e),{summary:r})),this.isValidQuery(e)&&a()})),W(this,"isValidQuery",(e=>{if(e.target&&e.target.length>0&&";"!==e.target){e.target=e.target.trim();const t=e.target.split(";",2);return 2===t.length&&t[0].length>0&&t[1].length>0}return!1})),W(this,"stateCallback",(()=>{const e=this.props.query;this.onChange(e)})),W(this,"onIsPiPointChange",(e=>{const{query:t}=this.props,a=!t.isPiPoint;this.setState({segments:a?[{label:""}]:this.checkAfServer(),attributes:[],isPiPoint:a},(()=>{this.onChange(N(T({},t),{expression:"",attributes:this.state.attributes,segments:this.state.segments,isPiPoint:a}))}))})),W(this,"onHideErrorChange",(e=>{const{query:t}=this.props,a=!t.hideError;this.setState({hideError:a},(()=>{this.onChange(N(T({},t),{hideError:a}))}))})),this.onSegmentChange=this.onSegmentChange.bind(this),this.calcBasisValueChanged=this.calcBasisValueChanged.bind(this),this.recordedBoundaryTypeValueChanged=this.recordedBoundaryTypeValueChanged.bind(this),this.calcNoDataValueChanged=this.calcNoDataValueChanged.bind(this),this.onSummaryAction=this.onSummaryAction.bind(this),this.onSummaryValueChanged=this.onSummaryValueChanged.bind(this),this.onAttributeAction=this.onAttributeAction.bind(this),this.onAttributeChange=this.onAttributeChange.bind(this),this.summaryTypes=["Total","Average","Minimum","Maximum","Range","StdDev","PopulationStdDev","Count","PercentGood","All","AllForNonNumeric"],this.calculationBasis=["TimeWeighted","EventWeighted","TimeWeightedContinuous","TimeWeightedDiscrete","EventWeightedExcludeMostRecentEvent","EventWeightedExcludeEarliestEvent","EventWeightedIncludeBothEnds"],this.recordedBoundaryTypes=["Inside","Outside","Interpolated"],this.noDataReplacement=["Null","Drop","Previous","0","Keep"]}}var M=o(269),L=o(531);function Q(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function G(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{},n=Object.keys(a);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(a).filter((function(e){return Object.getOwnPropertyDescriptor(a,e).enumerable})))),n.forEach((function(t){Q(e,t,a[t])}))}return e}function $(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t.push.apply(t,a)}return t}(Object(t)).forEach((function(a){Object.defineProperty(e,a,Object.getOwnPropertyDescriptor(t,a))})),e}const H=30,_=(0,h.memo)((function(e){var t,a,n,l,r,i;const{query:s,datasource:o,annotation:u,onChange:m,onRunQuery:p}=e,[v,g]=(0,h.useState)("");var b;const[y,f]=(0,h.useState)(null!==(b=null==u||null===(t=u.target)||void 0===t?void 0:t.database)&&void 0!==b?b:{});if(void 0===u)return null;const E=e=>{const t=u.target;if(t&&t[e])return{label:t[e].Name,value:t[e]}};var S;return o.getAssetServer(o.afserver.name).then((e=>{g(e.WebId)})),d().createElement(d().Fragment,null,d().createElement("div",{className:"gf-form-group"},d().createElement(c.InlineFieldRow,null,d().createElement(c.InlineField,{label:"Database",labelWidth:H,grow:!0},d().createElement(c.AsyncSelect,{key:null!=v?v:"database-key",loadOptions:()=>o.getDatabases(v).then((e=>e.map((e=>({label:e.Name,value:e}))))),loadingMessage:"Loading",value:E("database"),onChange:e=>{f(e.value),m($(G({},s),{database:e.value,template:void 0}))},defaultOptions:!0})),d().createElement(c.InlineField,{label:"Event Frames",labelWidth:H,grow:!0},d().createElement(c.AsyncSelect,{key:null!==(S=null==y?void 0:y.WebId)&&void 0!==S?S:"default-template-key",loadOptions:()=>o.getEventFrameTemplates(null==y?void 0:y.WebId).then((e=>e.map((e=>({label:e.Name,value:e}))))),loadingMessage:"Loading",value:E("template"),onChange:e=>m($(G({},s),{template:e.value})),defaultOptions:!0})),d().createElement(c.InlineField,{label:"Show Start and End Time",labelWidth:H,grow:!0},d().createElement(c.InlineSwitch,{value:!!s.showEndTime,onChange:e=>m($(G({},s),{showEndTime:e.currentTarget.checked}))}))),d().createElement(c.InlineFieldRow,null,d().createElement(c.InlineField,{label:"Category name",labelWidth:H,grow:!0},d().createElement(c.Input,{type:"text",value:s.categoryName,onBlur:e=>p(),onChange:e=>m($(G({},s),{categoryName:e.currentTarget.value})),placeholder:"Enter category name"})),d().createElement(c.InlineField,{label:"Name Filter",labelWidth:H,grow:!0},d().createElement(c.Input,{type:"text",value:s.nameFilter,onBlur:e=>p(),onChange:e=>m($(G({},s),{nameFilter:e.currentTarget.value})),placeholder:"Enter name filter"}))),d().createElement(c.InlineFieldRow,null,d().createElement(c.InlineField,{label:"Enable Name Regex Replacement",labelWidth:H,grow:!1},d().createElement(c.InlineSwitch,{value:null===(a=s.regex)||void 0===a?void 0:a.enable,onChange:e=>m($(G({},s),{regex:$(G({},s.regex),{enable:e.currentTarget.checked})}))})),d().createElement(c.InlineField,{label:"Name Filter",labelWidth:20,grow:!1},d().createElement(c.Input,{type:"text",value:null===(n=s.regex)||void 0===n?void 0:n.search,onBlur:e=>p(),onChange:e=>m($(G({},s),{regex:$(G({},s.regex),{search:e.currentTarget.value})})),placeholder:"(.*)",width:50})),d().createElement(c.InlineField,{label:"Replace",labelWidth:20,grow:!0},d().createElement(c.Input,{type:"text",value:null==s||null===(l=s.regex)||void 0===l?void 0:l.replace,onBlur:e=>p(),onChange:e=>m($(G({},s),{regex:$(G({},s.regex),{replace:e.currentTarget.value})})),placeholder:"$1"}))),d().createElement(c.InlineFieldRow,null,d().createElement(c.InlineField,{label:"Enable Attribute Usage",labelWidth:H,grow:!1},d().createElement(c.InlineSwitch,{value:null===(r=s.attribute)||void 0===r?void 0:r.enable,onChange:e=>m($(G({},s),{attribute:$(G({},s.attribute),{enable:e.currentTarget.checked})}))})),d().createElement(c.InlineField,{label:"Attribute Name",labelWidth:H,grow:!0},d().createElement(c.Input,{type:"text",value:null===(i=s.attribute)||void 0===i?void 0:i.name,onBlur:e=>p(),onChange:e=>m($(G({},s),{attribute:$(G({},s.attribute),{name:e.currentTarget.value})})),placeholder:"Enter name"})))))}));function J(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function Y(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{},n=Object.keys(a);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(a).filter((function(e){return Object.getOwnPropertyDescriptor(a,e).enumerable})))),n.forEach((function(t){J(e,t,a[t])}))}return e}function K(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t.push.apply(t,a)}return t}(Object(t)).forEach((function(a){Object.defineProperty(e,a,Object.getOwnPropertyDescriptor(t,a))})),e}class z extends L.DataSourceWithBackend{applyTemplateVariables(e,t){return K(Y({},e),{target:e.target?this.templateSrv.replace(e.target,t):""})}query(e){if(1===e.targets.length&&e.targets[0].isAnnotation)return super.query(e);const t=this.buildQueryParameters(e);return t.targets.length<=0?(0,M.of)({data:[]}):super.query(t)}metricFindQuery(e,t){const a=this,n=["servers","databases","databaseElements","elements"];var l,r,i;return"string"==typeof e&&(e=JSON.parse(e)),t.isPiPoint?e.path=this.templateSrv.replace(e.path,t):(""===e.path?e.type=n[0]:(e.path=this.templateSrv.replace(e.path,t),e.path=e.path.split(";")[0],"attributes"!==e.type&&(e.type=n[Math.max(0,Math.min(e.path.split("\\").length,n.length-1))])),e.path=e.path.replace(/\{([^\\])*\}/gi,(e=>e.substring(1,e.length-2).split(",")[0]))),e.filter=null!==(l=e.filter)&&void 0!==l?l:"*",e.max=null!==(r=e.max)&&void 0!==r?r:1e4,"servers"===e.type?(null===(i=a.afserver)||void 0===i?void 0:i.name)?a.getAssetServer(a.afserver.name).then((e=>[e])).then(V):a.getAssetServers().then(V):"databases"===e.type&&e.afServerWebId?a.getDatabases(e.afServerWebId,{}).then(V):"databases"===e.type?a.getAssetServer(e.path).then((e=>{var t;return a.getDatabases(null!==(t=e.WebId)&&void 0!==t?t:"",{})})).then(V):"databaseElements"===e.type?a.getDatabase(e.path).then((e=>{var t;return a.getDatabaseElements(null!==(t=e.WebId)&&void 0!==t?t:"",{selectedFields:"Items.WebId%3BItems.Name%3BItems.Items%3BItems.Path%3BItems.HasChildren"})})).then(V):"elements"===e.type?a.getElement(e.path).then((t=>{var n;return a.getElements(null!==(n=t.WebId)&&void 0!==n?n:"",{selectedFields:"Items.Description%3BItems.WebId%3BItems.Name%3BItems.Items%3BItems.Path%3BItems.HasChildren",nameFilter:e.filter})})).then(V):"attributes"===e.type?a.getElement(e.path).then((t=>{var n;return a.getAttributes(null!==(n=t.WebId)&&void 0!==n?n:"",{searchFullHierarchy:"true",selectedFields:"Items.Type%3BItems.DefaultUnitsName%3BItems.Description%3BItems.WebId%3BItems.Name%3BItems.Path",nameFilter:e.filter,maxCount:e.max})})).then(V):"dataserver"===e.type?a.getDataServers().then(V):"pipoint"===e.type?a.piPointSearch(e.webId,e.pointName).then(V):Promise.reject("Bad type")}buildQueryParameters(e){return e.targets=(0,E.filter)(e.targets,(e=>{var t;return!(!e||!e.target||0===(null===(t=e.attributes)||void 0===t?void 0:t.length)||";"===e.target||e.hide||e.target.startsWith("Select AF"))})),e.maxDataPoints&&(e.maxDataPoints=e.maxDataPoints>3e4?3e4:e.maxDataPoints),e.targets=(0,E.map)(e.targets,(t=>{var a;const n={enableStreaming:t.enableStreaming,target:this.templateSrv.replace(t.target,e.scopedVars),elementPath:this.templateSrv.replace(t.elementPath,e.scopedVars),attributes:(0,E.map)(t.attributes,(t=>(t.value&&(t.value.value=this.templateSrv.replace(t.value.value,e.scopedVars)),t))),segments:(0,E.map)(t.segments,(t=>(t.value&&(t.value.value=this.templateSrv.replace(t.value.value,e.scopedVars)),t))),isAnnotation:!!t.isAnnotation,display:t.display?this.templateSrv.replace(t.display,e.scopedVars):void 0,refId:t.refId,hide:t.hide,interpolate:t.interpolate?K(Y({},t.interpolate),{interval:this.templateSrv.replace(t.interpolate.interval,e.scopedVars)}):{enable:!1},useLastValue:t.useLastValue||{enable:!1},useUnit:t.useUnit||{enable:!1},recordedValues:t.recordedValues||{enable:!1},digitalStates:t.digitalStates||{enable:!1},webid:null!==(a=t.webid)&&void 0!==a?a:"",regex:t.regex||{enable:!1},expression:t.expression||"",summary:t.summary||{enable:!1,types:[]},nodata:t.nodata,startTime:e.range.from,endTime:e.range.to,isPiPoint:!!t.isPiPoint,hideError:!!t.hideError,scopedVars:e.scopedVars,hashCode:""};return n.expression&&(n.expression=this.templateSrv.replace(n.expression,e.scopedVars)),n.summary.enable&&(n.summary.duration=n.summary.duration?this.templateSrv.replace(n.summary.duration,e.scopedVars):n.summary.duration,n.summary.sampleTypeInterval=!!n.summary.sampleTypeInterval,n.summary.sampleInterval=n.summary.sampleInterval?this.templateSrv.replace(n.summary.sampleInterval,e.scopedVars):n.summary.sampleInterval),n.summary.types=A(n.summary),n.hashCode=function(e){const t=(new TextEncoder).encode(e);return btoa(String.fromCharCode(...t))}(function(e){const t=Object.assign({},e);return delete t.startTime,delete t.endTime,delete t.scopedVars,delete t.hashCode,delete t.webid,JSON.stringify(t)}(n)),n})),e}eventFrameToAnnotation(e,t){const a=e.target,n=[],l=Intl.DateTimeFormat().resolvedOptions().locale;return t.forEach((e=>{let t=this.transformDataFrameToMap(e);for(let e=0;e<t.time.length;e++){var r;let i=t.title[e];(null===(r=a.regex)||void 0===r?void 0:r.enable)&&a.regex.search&&a.regex.replace&&(i=i.replace(new RegExp(a.regex.search),a.regex.replace)),t.timeEnd[e]<0&&(t.timeEnd[e]=null);let s="Tag: "+i;a.attribute&&a.attribute.enable&&(s+=t.attributeText[e]),s+="<br />Start: "+new Date(t.time[e]).toLocaleString(l)+"<br />End: ",t.timeEnd[e]?s+=new Date(t.timeEnd[e]).toLocaleString(l):s+="Eventframe is open";const o={time:t.time[e],timeEnd:a.showEndTime?t.timeEnd[e]:void 0,title:i,id:t.id[e],text:s,tags:["OSISoft PI"]};n.push(o)}})),n}transformDataFrameToMap(e){const t={};return e.fields.forEach((e=>{t[e.name]=e.values.toArray()})),t}restGet(e){return this.getResource(`${e}`).then((e=>e))}getDataServers(){return this.restGet("/dataservers").then((e=>{var t;return null!==(t=e.Items)&&void 0!==t?t:[]}))}getDataServer(e){return e?this.restGet("/dataservers?name="+e).then((e=>e)):Promise.resolve({})}getAssetServers(){return this.restGet("/assetservers").then((e=>{var t;return null!==(t=e.Items)&&void 0!==t?t:[]}))}getAssetServer(e){return e?this.restGet("/assetservers?path=\\\\"+e).then((e=>e)):Promise.resolve({})}getDatabase(e){return e?this.restGet("/assetdatabases?path=\\\\"+e).then((e=>e)):Promise.resolve({})}getDatabases(e,t){return e?this.restGet("/assetservers/"+e+"/assetdatabases").then((e=>{var t;return null!==(t=e.Items)&&void 0!==t?t:[]})):Promise.resolve([])}getElement(e){return e?this.restGet("/elements?path=\\\\"+e).then((e=>e)):Promise.resolve({})}getEventFrameTemplates(e){return e?this.restGet("/assetdatabases/"+e+"/elementtemplates?selectedFields=Items.InstanceType%3BItems.Name%3BItems.WebId").then((e=>{var t;return(0,E.filter)(null!==(t=e.Items)&&void 0!==t?t:[],(e=>"EventFrame"===e.InstanceType))})):Promise.resolve([])}getElementTemplates(e){return e?this.restGet("/assetdatabases/"+e+"/elementtemplates?selectedFields=Items.InstanceType%3BItems.Name%3BItems.WebId").then((e=>{var t;return(0,E.filter)(null!==(t=e.Items)&&void 0!==t?t:[],(e=>"Element"===e.InstanceType))})):Promise.resolve([])}getAttributes(e,t){let a="?"+(0,E.map)(t,((e,t)=>t+"="+e)).join("&");return"?"===a&&(a=""),this.restGet("/elements/"+e+"/attributes"+a).then((e=>{var t;return null!==(t=e.Items)&&void 0!==t?t:[]}))}getDatabaseElements(e,t){let a="?"+(0,E.map)(t,((e,t)=>t+"="+e)).join("&");return"?"===a&&(a=""),this.restGet("/assetdatabases/"+e+"/elements"+a).then((e=>{var t;return null!==(t=e.Items)&&void 0!==t?t:[]}))}getElements(e,t){let a="?"+(0,E.map)(t,((e,t)=>t+"="+e)).join("&");return"?"===a&&(a=""),this.restGet("/elements/"+e+"/elements"+a).then((e=>{var t;return null!==(t=e.Items)&&void 0!==t?t:[]}))}piPointSearch(e,t){let a=this.templateSrv.replace(t),n=`${a}`,l=!1;if(a!==t){const e=/\{(\w|,)+\}/g;let t;for(;null!==(t=e.exec(a));)t.index===e.lastIndex&&e.lastIndex++,t.forEach(((e,t)=>{0===t&&(a=a.replace(e,e.replace("{","(").replace("}",")").replace(",","|")),n=n.replace(e,"*"),l=!0)}))}return this.restGet("/dataservers/"+e+"/points?maxCount=100&nameFilter="+n).then((e=>e&&(null==e?void 0:e.Items)?l?e.Items.filter((e=>{var t;return null===(t=e.Name)||void 0===t?void 0:t.match(a)})):e.Items:[]))}constructor(e,t=(0,L.getTemplateSrv)()){super(e),J(this,"templateSrv",void 0),J(this,"piserver",void 0),J(this,"afserver",void 0),J(this,"afdatabase",void 0),J(this,"piPointConfig",void 0),J(this,"newFormatConfig",void 0),J(this,"useUnitConfig",void 0),J(this,"useExperimental",void 0),J(this,"useStreaming",void 0),this.templateSrv=t,this.piserver={name:(e.jsonData||{}).piserver,webid:void 0},this.afserver={name:(e.jsonData||{}).afserver,webid:void 0},this.afdatabase={name:(e.jsonData||{}).afdatabase,webid:void 0},this.piPointConfig=e.jsonData.pipoint||!1,this.newFormatConfig=e.jsonData.newFormat||!1,this.useUnitConfig=e.jsonData.useUnit||!1,this.useExperimental=e.jsonData.useExperimental||!1,this.useStreaming=e.jsonData.useStreaming||!1,this.annotations={QueryEditor:_,prepareQuery:e=>(e.target&&(e.target.queryType="Annotation",e.target.isAnnotation=!0),e.target),processEvents:(e,t)=>(0,M.of)(this.eventFrameToAnnotation(e,t))},Promise.all([this.getDataServer(this.piserver.name).then((e=>this.piserver.webid=e.WebId)),this.getAssetServer(this.afserver.name).then((e=>this.afserver.webid=e.WebId)),this.getDatabase(this.afserver.name&&this.afdatabase.name?this.afserver.name+"\\"+this.afdatabase.name:void 0).then((e=>this.afdatabase.webid=e.WebId))])}}const X=new m.DataSourcePlugin(z).setQueryEditor(U).setConfigEditor(f);return u})()));
//# sourceMappingURL=module.js.map