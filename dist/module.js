define(["@grafana/data","react","@grafana/ui","lodash","rxjs","@grafana/runtime"],((e,t,a,n,l,r)=>(()=>{"use strict";var i={781:t=>{t.exports=e},531:e=>{e.exports=r},7:e=>{e.exports=a},241:e=>{e.exports=n},959:e=>{e.exports=t},269:e=>{e.exports=l}},s={};function o(e){var t=s[e];if(void 0!==t)return t.exports;var a=s[e]={exports:{}};return i[e](a,a.exports,o),a.exports}o.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return o.d(t,{a:t}),t},o.d=(e,t)=>{for(var a in t)o.o(t,a)&&!o.o(e,a)&&Object.defineProperty(e,a,{enumerable:!0,get:t[a]})},o.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),o.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var u={};return(()=>{o.r(u),o.d(u,{plugin:()=>M});var e=o(781),t=o(959),a=o.n(t),n=o(7);function l(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function r(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{},n=Object.keys(a);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(a).filter((function(e){return Object.getOwnPropertyDescriptor(a,e).enumerable})))),n.forEach((function(t){l(e,t,a[t])}))}return e}function i(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);a.push.apply(a,n)}return a}(Object(t)).forEach((function(a){Object.defineProperty(e,a,Object.getOwnPropertyDescriptor(t,a))})),e}const{FormField:s}=n.LegacyForms,h=e=>i(r({},e),{jsonData:i(r({},e.jsonData),{url:e.url})});class m extends t.PureComponent{render(){const{options:e}=this.props,t=h(e);return a().createElement("div",null,a().createElement(n.DataSourceHttpSettings,{defaultUrl:"https://server.name/piwebapi",dataSourceConfig:t,onChange:this.onHttpOptionsChange,showAccessOptions:!0}),a().createElement("h3",{className:"page-heading"},"Custom Configuration"),a().createElement("div",{className:"gf-form-group"},a().createElement("div",{className:"gf-form-inline"},a().createElement(n.InlineField,{label:"Enable PI Points in Query",labelWidth:24},a().createElement(n.InlineSwitch,{value:t.jsonData.pipoint,onChange:this.onPiPointChange}))),a().createElement("div",{className:"gf-form-inline"},a().createElement(n.InlineField,{label:"Enable New Data Format",labelWidth:24},a().createElement(n.InlineSwitch,{value:t.jsonData.newFormat,onChange:this.onNewFormatChange}))),a().createElement("div",{className:"gf-form-inline"},a().createElement(n.InlineField,{label:"Enable Unit in Data",labelWidth:24},a().createElement(n.InlineSwitch,{value:t.jsonData.useUnit,onChange:this.onUseUnitChange}))),a().createElement("div",{className:"gf-form-inline"},a().createElement(n.InlineField,{label:"Enable Experimental Features",labelWidth:24},a().createElement(n.InlineSwitch,{value:t.jsonData.useExperimental,onChange:this.onUseExperimentalChange}))),t.jsonData.useExperimental&&a().createElement("div",{className:"gf-form-inline"},a().createElement(n.InlineField,{label:"Enable Steaming Support",labelWidth:24},a().createElement(n.InlineSwitch,{value:t.jsonData.useStreaming,onChange:this.onUseStreamingChange})))),a().createElement("h3",{className:"page-heading"},"PI/AF Connection Details"),a().createElement("div",{className:"gf-form-group"},t.jsonData.pipoint&&a().createElement("div",{className:"gf-form"},a().createElement(s,{label:"PI Server",labelWidth:10,inputWidth:25,onChange:this.onPIServerChange,value:t.jsonData.piserver||"",placeholder:"Default PI Server to use for data requests"})),a().createElement("div",{className:"gf-form"},a().createElement(s,{label:"AF Server",labelWidth:10,inputWidth:25,onChange:this.onAFServerChange,value:t.jsonData.afserver||"",placeholder:"Default AF Server to use for data requests"})),a().createElement("div",{className:"gf-form"},a().createElement(s,{label:"AF Database",labelWidth:10,inputWidth:25,onChange:this.onAFDatabaseChange,value:t.jsonData.afdatabase||"",placeholder:"Default AF Database server for AF queries"}))))}constructor(...e){super(...e),l(this,"onPIServerChange",(e=>{const{onOptionsChange:t,options:a}=this.props,n=i(r({},a.jsonData),{piserver:e.target.value});t(i(r({},a),{jsonData:n}))})),l(this,"onAFServerChange",(e=>{const{onOptionsChange:t,options:a}=this.props,n=i(r({},a.jsonData),{afserver:e.target.value});t(i(r({},a),{jsonData:n}))})),l(this,"onAFDatabaseChange",(e=>{const{onOptionsChange:t,options:a}=this.props,n=i(r({},a.jsonData),{afdatabase:e.target.value});t(i(r({},a),{jsonData:n}))})),l(this,"onHttpOptionsChange",(e=>{const{onOptionsChange:t}=this.props;t(h(e))})),l(this,"onPiPointChange",(e=>{const{onOptionsChange:t,options:a}=this.props,n=i(r({},a.jsonData),{piserver:e.target.checked?a.jsonData.piserver:"",pipoint:e.target.checked});t(i(r({},a),{jsonData:n}))})),l(this,"onNewFormatChange",(e=>{const{onOptionsChange:t,options:a}=this.props,n=i(r({},a.jsonData),{newFormat:e.target.checked});t(i(r({},a),{jsonData:n}))})),l(this,"onUseUnitChange",(e=>{const{onOptionsChange:t,options:a}=this.props,n=i(r({},a.jsonData),{useUnit:e.target.checked});t(i(r({},a),{jsonData:n}))})),l(this,"onUseExperimentalChange",(e=>{const{onOptionsChange:t,options:a}=this.props,n=i(r({},a.jsonData),{useExperimental:e.target.checked,useStreaming:!!e.target.checked&&a.jsonData.useStreaming});t(i(r({},a),{jsonData:n}))})),l(this,"onUseStreamingChange",(e=>{const{onOptionsChange:t,options:a}=this.props,n=i(r({},a.jsonData),{useStreaming:e.target.checked});t(i(r({},a),{jsonData:n}))}))}}var c=o(241);function d(){return d=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e},d.apply(this,arguments)}function p(e){if(null==e)throw new TypeError("Cannot destructure "+e);return e}const g=({label:e,labelWidth:t=12,tooltip:l,children:r})=>a().createElement(a().Fragment,null,a().createElement(n.InlineFormLabel,{width:t,tooltip:l},e),r),v=()=>a().createElement("div",{className:"gf-form gf-form--grow"},a().createElement("div",{className:"gf-form-label gf-form-label--grow"})),b=e=>{var t=d({},p(e));return a().createElement(y,null,a().createElement(g,t))},y=e=>a().createElement("div",{className:"gf-form-inline"},e.children,a().createElement(v,null)),f=e=>{var t=d({},p(e));return a().createElement(E,null,a().createElement(g,t))},E=e=>a().createElement(a().Fragment,null,e.children),S={target:";",attributes:[],segments:[],regex:{enable:!1},summary:{types:[],basis:"EventWeighted",interval:"",nodata:"Null"},expression:"",interpolate:{enable:!1},useLastValue:{enable:!1},recordedValues:{enable:!1},digitalStates:{enable:!1},enableStreaming:{enable:!1},useUnit:{enable:!1},isPiPoint:!1},P=({isRaw:e,onChange:l})=>{const[r,i]=(0,t.useState)(!1);return(0,t.useEffect)((()=>{i(!1)}),[e]),e?a().createElement(a().Fragment,null,a().createElement(n.Button,{"aria-label":"Switch to visual editor",icon:"pen",variant:"secondary",type:"button",onClick:()=>{i(!0)}}),a().createElement(n.ConfirmModal,{isOpen:r,title:"Switch to visual editor mode",body:"Are you sure to switch to visual editor mode? You will lose the changes done in raw query mode.",confirmText:"Yes, switch to editor mode",dismissText:"No, stay in raw query mode",onConfirm:()=>{l(!1)},onDismiss:()=>{i(!1)}})):a().createElement(n.Button,{"aria-label":"Switch to text editor",icon:"pen",variant:"secondary",type:"button",onClick:()=>{l(!0)}})};function C(e){return(0,c.map)(e,(e=>{var t,a;return{text:e.Name,expandable:void 0===e.HasChildren||!0===e.HasChildren||(null!==(t=e.Path)&&void 0!==t?t:"").split("\\").length<=3,HasChildren:e.HasChildren,Items:null!==(a=e.Items)&&void 0!==a?a:[],Path:e.Path,WebId:e.WebId}}))}function I(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function w(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{},n=Object.keys(a);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(a).filter((function(e){return Object.getOwnPropertyDescriptor(a,e).enumerable})))),n.forEach((function(t){I(e,t,a[t])}))}return e}function O(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);a.push.apply(a,n)}return a}(Object(t)).forEach((function(a){Object.defineProperty(e,a,Object.getOwnPropertyDescriptor(t,a))})),e}const D=24,x=250,F="-REMOVE-",j=e=>{var t;return e.value?a().createElement("div",{className:"gf-form-label "+("template"===e.value.type?"query-keyword":"")},null!==(t=e.label)&&void 0!==t?t:"--no label--"):a().createElement("a",{className:"gf-form-label query-part"},a().createElement(n.Icon,{name:"plus"}))};class A extends t.PureComponent{isValueEmpty(e){return!e||!e.value||!e.value.length||e.value===F}calcBasisValueChanged(e){const t=this.props.query,a=t.summary;var n;a&&(a.basis=null===(n=e.value)||void 0===n?void 0:n.value),this.onChange(O(w({},t),{summary:a}))}getCalcBasisSegments(){return(0,c.map)(this.calculationBasis,(e=>({label:e,value:{value:e,expandable:!0}})))}calcNoDataValueChanged(e){const t=this.props.query,a=t.summary;var n;a&&(a.nodata=null===(n=e.value)||void 0===n?void 0:n.value),this.onChange(O(w({},t),{summary:a}))}getNoDataSegments(){return(0,c.map)(this.noDataReplacement,(e=>({label:e,value:{value:e,expandable:!0}})))}onSummaryValueChanged(e,t){const a=this.state.summaries.slice(0);a[t]=e,this.isValueEmpty(e.value)&&a.splice(t,1),this.setState({summaries:a},this.stateCallback)}getSummarySegments(){const e=(0,c.filter)(this.summaryTypes,(e=>-1===this.state.summaries.map((e=>{var t;return null===(t=e.value)||void 0===t?void 0:t.value})).indexOf(e))),t=(0,c.map)(e,(e=>({label:e,value:{value:e,expandable:!0}})));return t.unshift({label:F,value:{value:F}}),t}removeSummary(e){const t=(0,c.filter)(this.state.summaries,(t=>t!==e));this.setState({summaries:t})}onSummaryAction(e){const t=this.state.summaries.slice(0);if(!this.isValueEmpty(e.value)){var a;let n={label:e.label,value:{value:null===(a=e.value)||void 0===a?void 0:a.value,expandable:!0}};t.push(n)}this.setState({summarySegment:{},summaries:t},this.stateCallback)}removeAttribute(e){const t=(0,c.filter)(this.state.attributes,(t=>t!==e));this.attributeChangeValue(t)}onAttributeAction(e){const{query:t}=this.props,a=this.state.attributes.slice(0);if(!this.isValueEmpty(e.value)){var n;let l={label:e.label,value:{value:null===(n=e.value)||void 0===n?void 0:n.value,expandable:!t.isPiPoint}};a.push(l)}this.attributeChangeValue(a)}getSegmentPathUpTo(e,t){const a=e.slice(0,t);return(0,c.reduce)(a,((e,t)=>{var a;return t.value?(null===(a=t.value.value)||void 0===a?void 0:a.startsWith("-Select"))?e:e?e+"\\"+t.value.value:t.value.value:""}),"")}checkAttributeSegments(e,t){var a;const{datasource:n,data:l}=this.props,r=this,i={path:this.getSegmentPathUpTo(t.slice(0),t.length),type:"attributes"};var s;return n.metricFindQuery(i,Object.assign(null!==(s=null==l||null===(a=l.request)||void 0===a?void 0:a.scopedVars)&&void 0!==s?s:{},{isPiPoint:!1})).then((t=>{const a={};(0,c.each)(t,(e=>{a[e.Path.substring(e.Path.indexOf("|")+1)]=e.WebId}));const l=(0,c.filter)(e,(e=>{var t;const l=n.templateSrv.replace(null===(t=e.value)||void 0===t?void 0:t.value);return void 0!==a[l]}));return r.availableAttributes=a,this.attributeChangeValue(l)})).catch((t=>(r.error=t.message||"Failed to issue metric query",this.attributeChangeValue(e))))}checkPiPointSegments(e,t){var a;const{datasource:n,data:l}=this.props,r=this,i={path:e.path,webId:r.getSelectedPIServer(),pointName:e.label,type:"pipoint"};var s;return n.metricFindQuery(i,Object.assign(null!==(s=null==l||null===(a=l.request)||void 0===a?void 0:a.scopedVars)&&void 0!==s?s:{},{isPiPoint:!0})).then((()=>r.attributeChangeValue(t))).catch((e=>(r.error=e.message||"Failed to issue metric query",r.attributeChangeValue([]))))}getSelectedPIServer(){var e;let t="";return this.piServer.forEach((e=>{const a=this.props.query.target.split(";");a.length>=2&&a[0]===e.text&&(t=e.WebId)})),this.piServer.length>0?null===(e=this.piServer[0].value)||void 0===e?void 0:e.webId:t}textEditorChanged(){const{query:e}=this.props,t=e.target.split(";"),a=t.length>0?t[0].split("\\"):[];let n=[],l=[];a.length>1||1===a.length&&""!==a[0]?(t.splice(0,1),(0,c.each)(a,((e,t)=>{n.push({label:e,value:{type:e.match(/\${\w+}/gi)?"template":void 0,value:e,expandable:!0}})})),(0,c.each)(t,(function(e,t){""!==e&&l.push({label:e,value:{value:e,expandable:!1}})})),this.getElementSegments(a.length+1,n).then((e=>{e.length>0&&n.push({label:"Select Element",value:{value:"-Select Element-"}})})).then((()=>{this.updateArray(n,l,this.state.summaries,e.isPiPoint,(()=>{this.onChange(O(w({},e),{query:void 0,rawQuery:!1,attributes:this.state.attributes,segments:this.state.segments}))}))}))):(n=this.checkAfServer(),this.updateArray(n,this.state.attributes,this.state.summaries,e.isPiPoint,(()=>{this.onChange(O(w({},e),{query:void 0,rawQuery:!1,attributes:this.state.attributes,segments:this.state.segments}))})))}render(){const{query:e,onChange:t,onRunQuery:l}=this.props,r=(0,c.defaults)(e,S),{useLastValue:i,useUnit:s,interpolate:o,query:u,rawQuery:h,digitalStates:m,enableStreaming:d,recordedValues:p,expression:g,isPiPoint:y,summary:E,display:C,regex:I}=r;return a().createElement(a().Fragment,null,this.props.datasource.piPointConfig&&a().createElement(n.InlineField,{label:"Is Pi Point?",labelWidth:D},a().createElement(n.InlineSwitch,{value:y,onChange:this.onIsPiPointChange})),!!h&&a().createElement(n.InlineFieldRow,null,a().createElement(n.InlineField,{label:"Raw Query",labelWidth:D,grow:!0},a().createElement(n.Input,{onBlur:this.stateCallback,value:u,onChange:e=>t(O(w({},r),{query:e.target.value})),placeholder:"enter query"})),a().createElement(P,{isRaw:!0,onChange:e=>this.textEditorChanged()})),!h&&a().createElement(a().Fragment,null,a().createElement("div",{className:"gf-form-inline"},a().createElement(f,{label:y?"PI Server":"AF Elements",tooltip:y?"Select PI server.":"Select AF Element."},this.state.segments.map(((e,t)=>a().createElement(n.SegmentAsync,{key:"element-"+t,Component:a().createElement(j,{value:e.value,label:e.label}),onChange:e=>this.onSegmentChange(e,t),loadOptions:e=>this.getElementSegments(t),allowCustomValue:!0,inputMinWidth:200}))),a().createElement(v,null),!y&&a().createElement(P,{isRaw:!1,onChange:e=>{t(O(w({},r),{query:r.target,rawQuery:e}))}}))),a().createElement(b,{label:y?"Pi Points":"Attributes"},this.state.attributes.map(((e,t)=>y?a().createElement(n.SegmentAsync,{key:"attributes-"+t,Component:a().createElement(j,{value:e.value,label:e.label}),disabled:0===this.piServer.length,onChange:e=>this.onPiPointChange(e,t),loadOptions:this.getAttributeSegmentsPI,reloadOptionsOnChange:!0,allowCustomValue:!0,inputMinWidth:x}):a().createElement(n.Segment,{key:"attributes-"+t,Component:a().createElement(j,{value:e.value,label:e.label}),disabled:this.state.segments.length<=2,onChange:e=>this.onAttributeChange(e,t),options:this.getAttributeSegmentsAF(),allowCustomValue:!0,inputMinWidth:x}))),y&&a().createElement(n.SegmentAsync,{Component:a().createElement(j,{value:this.state.attributeSegment.value,label:this.state.attributeSegment.label}),disabled:0===this.piServer.length,onChange:this.onAttributeAction,loadOptions:this.getAttributeSegmentsPI,reloadOptionsOnChange:!0,allowCustomValue:!0,inputMinWidth:x}),!y&&a().createElement(n.Segment,{Component:a().createElement(j,{value:this.state.attributeSegment.value,label:this.state.attributeSegment.label}),disabled:this.state.segments.length<=2,onChange:this.onAttributeAction,options:this.getAttributeSegmentsAF(),allowCustomValue:!0,inputMinWidth:x}))),a().createElement(n.InlineFieldRow,null,a().createElement(n.InlineField,{label:"Calculation",grow:!0,labelWidth:D,tooltip:"Modify all attributes by an equation. Use '.' for current item. Leave Attributes empty if you wish to perform element based calculations."},a().createElement(n.Input,{onBlur:l,value:g,onChange:e=>t(O(w({},r),{expression:e.target.value})),placeholder:"'.'*2"}))),a().createElement(n.InlineFieldRow,null,a().createElement(n.InlineField,{label:"Use Last Value",tooltip:"Fetch only last value from time range",labelWidth:D},a().createElement(n.InlineSwitch,{value:i.enable,onChange:()=>this.onChange(O(w({},r),{useLastValue:O(w({},i),{enable:!i.enable})}))})),a().createElement(n.InlineField,{label:"Digital States",labelWidth:D},a().createElement(n.InlineSwitch,{value:m.enable,onChange:()=>this.onChange(O(w({},r),{digitalStates:O(w({},m),{enable:!m.enable})}))})),a().createElement(n.InlineField,{label:"Replace Bad Data",labelWidth:D,tooltip:"Replacement for bad quality values."},a().createElement(n.Segment,{Component:a().createElement(j,{value:{value:null==E?void 0:E.nodata},label:null==E?void 0:E.nodata}),onChange:this.calcNoDataValueChanged,options:this.getNoDataSegments(),allowCustomValue:!0})),this.props.datasource.useUnitConfig&&a().createElement(n.InlineField,{label:"Use unit from datapoints",tooltip:"Use unit in label from PI tag or PI AF attribute",labelWidth:D},a().createElement(n.InlineSwitch,{value:s.enable,onChange:()=>this.onChange(O(w({},r),{useUnit:O(w({},s),{enable:!s.enable})}))})),this.props.datasource.useStreaming&&a().createElement(n.InlineField,{label:"Enable Streaming",labelWidth:D,tooltip:"Enable streaming data if it is supported for the point type."},a().createElement(n.InlineSwitch,{value:d.enable,onChange:()=>this.onChange(O(w({},r),{enableStreaming:O(w({},d),{enable:!d.enable})}))}))),a().createElement(n.InlineFieldRow,null,!i.enable&&a().createElement(n.InlineField,{label:"Max Recorded Values",labelWidth:D,tooltip:"Maximum number of recorded value to retrive from the data archive, without using interpolation."},a().createElement(n.Input,{onBlur:l,value:p.maxNumber,onChange:e=>t(O(w({},r),{recordedValues:O(w({},p),{maxNumber:parseInt(e.target.value,10)})})),type:"number",placeholder:"1000"})),a().createElement(n.InlineField,{label:"Recorded Values",labelWidth:D},a().createElement(n.InlineSwitch,{value:p.enable,onChange:()=>this.onChange(O(w({},r),{recordedValues:O(w({},p),{enable:!p.enable})}))}))),!i.enable&&a().createElement(n.InlineFieldRow,null,a().createElement(n.InlineField,{label:g?"Interval Period":"Interpolate Period",labelWidth:D,tooltip:"Override time between sampling, e.g. '30s'. Defaults to timespan/chart width."},a().createElement(n.Input,{onBlur:l,value:o.interval,onChange:e=>t(O(w({},r),{interpolate:O(w({},o),{interval:e.target.value})})),placeholder:"30s"})),a().createElement(n.InlineField,{label:g?"Interval Values":"Interpolate",labelWidth:D},a().createElement(n.InlineSwitch,{value:o.enable,onChange:()=>this.onChange(O(w({},r),{interpolate:O(w({},o),{enable:!o.enable})}))}))),!i.enable&&a().createElement(n.InlineFieldRow,null,a().createElement(n.InlineField,{label:"Summary Period",labelWidth:D,tooltip:"Define the summary period, e.g. '30s'."},a().createElement(n.Input,{onBlur:l,value:null==E?void 0:E.interval,onChange:e=>t(O(w({},r),{summary:O(w({},E),{interval:e.target.value})})),placeholder:"30s"})),a().createElement(n.InlineField,{label:"Basis",labelWidth:D,tooltip:"Defines the possible calculation options when performing summary calculations over time-series data."},a().createElement(n.Segment,{Component:a().createElement(j,{value:{value:null==E?void 0:E.basis},label:null==E?void 0:E.basis}),onChange:this.calcBasisValueChanged,options:this.getCalcBasisSegments(),allowCustomValue:!0})),a().createElement(n.InlineField,{label:"Summaries",labelWidth:D,tooltip:"PI Web API summary options."},a().createElement(n.InlineFieldRow,null,this.state.summaries.map(((e,t)=>a().createElement(n.Segment,{key:"summaries-"+t,Component:a().createElement(j,{value:e.value,label:e.label}),onChange:e=>this.onSummaryValueChanged(e,t),options:this.getSummarySegments(),allowCustomValue:!0}))),a().createElement(n.Segment,{Component:a().createElement(j,{value:this.state.summarySegment.value,label:this.state.summarySegment.label}),onChange:this.onSummaryAction,options:this.getSummarySegments(),allowCustomValue:!0})))),a().createElement(n.InlineFieldRow,null,a().createElement(n.InlineField,{label:"Display Name",labelWidth:D,tooltip:"If single attribute, modify display name. Otherwise use regex to modify display name."},a().createElement(n.Input,{onBlur:l,value:C,onChange:e=>t(O(w({},r),{display:e.target.value})),placeholder:"Display"})),a().createElement(n.InlineField,{label:"Enable Regex Replace",labelWidth:D},a().createElement(n.InlineSwitch,{value:I.enable,onChange:()=>{this.onChange(O(w({},r),{regex:O(w({},I),{enable:!I.enable})}))}})),a().createElement(n.InlineField,{label:"Search",labelWidth:16},a().createElement(n.Input,{onBlur:l,value:I.search,onChange:e=>t(O(w({},r),{regex:O(w({},I),{search:e.target.value})})),placeholder:"(.*)"})),a().createElement(n.InlineField,{label:"Replace",labelWidth:16},a().createElement(n.Input,{onBlur:l,value:I.replace,onChange:e=>t(O(w({},r),{regex:O(w({},I),{replace:e.target.value})})),placeholder:"$1"}))))}constructor(e){super(e),I(this,"error",void 0),I(this,"piServer",[]),I(this,"availableAttributes",{}),I(this,"summaryTypes",void 0),I(this,"calculationBasis",void 0),I(this,"noDataReplacement",void 0),I(this,"state",{isPiPoint:!1,segments:[],attributes:[],summaries:[],attributeSegment:{},summarySegment:{},calculationBasisSegment:{},noDataReplacementSegment:{}}),I(this,"segmentChangeValue",(e=>{const t=this.props.query;this.setState({segments:e},(()=>this.onChange(O(w({},t),{segments:e}))))})),I(this,"attributeChangeValue",(e=>{const t=this.props.query;return new Promise((a=>this.setState({attributes:e},(()=>{this.onChange(O(w({},t),{attributes:e})),a()}))))})),I(this,"onPiPointChange",((e,t)=>{let a=this.state.attributes.slice(0);e.label===F?(0,c.remove)(a,((e,a)=>a===t)):a[t]=e,this.checkPiPointSegments(e,a)})),I(this,"onAttributeChange",((e,t)=>{var a;let n=this.state.attributes.slice(0);n[t].label!==(null===(a=e.value)||void 0===a?void 0:a.value)&&(n[t]=e,this.checkAttributeSegments(n,this.state.segments))})),I(this,"onSegmentChange",((e,t)=>{var a;const{query:n}=this.props;let l=this.state.segments.slice(0);l[t].label!==(null===(a=e.value)||void 0===a?void 0:a.value)&&this.setState({attributes:[]},(()=>e.label===F?(l=(0,c.slice)(l,0,t),void this.checkAttributeSegments([],l).then((()=>{var e;0===l.length?l.push({label:""}):(null===(e=l[l.length-1].value)||void 0===e?void 0:e.expandable)&&l.push({label:"Select Element",value:{value:"-Select Element-"}}),n.isPiPoint&&(this.piServer=[]),this.segmentChangeValue(l)}))):(l[t]=e,n.isPiPoint?(this.piServer.push(e),void this.segmentChangeValue(l)):(t<l.length-1&&(l=(0,c.slice)(l,0,t+1)),void this.checkAttributeSegments([],l).then((()=>{var t;(null===(t=e.value)||void 0===t?void 0:t.expandable)&&l.push({label:"Select Element",value:{value:"-Select Element-"}}),this.segmentChangeValue(l)}))))))})),I(this,"getElementSegments",((e,t)=>{var a;const{datasource:n,query:l,data:r}=this.props,i=this,s=l.isPiPoint?{type:"dataserver"}:{path:this.getSegmentPathUpTo(null!=t?t:this.state.segments.slice(0),e),afServerWebId:this.state.segments.length>0&&this.state.segments[0].value?this.state.segments[0].value.webId:void 0};if(!l.isPiPoint){var o,u,h;if((null===(o=n.afserver)||void 0===o?void 0:o.name)&&0===e)return Promise.resolve([{label:n.afserver.name,value:{value:n.afserver.name,expandable:!0}}]);if((null===(u=n.afserver)||void 0===u?void 0:u.name)&&(null===(h=n.afdatabase)||void 0===h?void 0:h.name)&&1===e)return Promise.resolve([{label:n.afdatabase.name,value:{value:n.afdatabase.name,expandable:!0}}])}var m;return n.metricFindQuery(s,Object.assign(null!==(m=null==r||null===(a=r.request)||void 0===a?void 0:a.scopedVars)&&void 0!==m?m:{},{isPiPoint:l.isPiPoint})).then((e=>{const t=(0,c.map)(e,(e=>({label:e.text,value:{webId:e.WebId,value:e.text,expandable:!l.isPiPoint&&e.expandable}})));if(0===t.length)return t;const a=n.templateSrv.getVariables();return(0,c.each)(a,(e=>{let a={label:"${"+e.name+"}",value:{type:"template",value:"${"+e.name+"}",expandable:!l.isPiPoint}};t.unshift(a)})),t.unshift({label:F,value:{value:F}}),t})).catch((e=>(i.error=e.message||"Failed to issue metric query",[])))})),I(this,"getAttributeSegmentsPI",(e=>{var t;const{datasource:a,query:n,data:l}=this.props,r=this,i={path:"",webId:this.getSelectedPIServer(),pointName:(null!=e?e:"")+"*",type:"pipoint"};let s=[];var o;return s.push({label:F,value:{value:F}}),a.metricFindQuery(i,Object.assign(null!==(o=null==l||null===(t=l.request)||void 0===t?void 0:t.scopedVars)&&void 0!==o?o:{},{isPiPoint:n.isPiPoint})).then((t=>{s=(0,c.map)(t,(e=>({path:e.Path,label:e.text,value:{value:e.text,expandable:!1}}))),e&&e.length>0&&s.unshift({label:e,value:{value:e,expandable:!1}});const l=a.templateSrv.getVariables();return(0,c.each)(l,(e=>{let t={label:"${"+e.name+"}",value:{type:"template",value:"${"+e.name+"}",expandable:!n.isPiPoint}};s.unshift(t)})),s})).catch((e=>(r.error=e.message||"Failed to issue metric query",s)))})),I(this,"getAttributeSegmentsAF",(e=>{let t=[];return t.push({label:F,value:{value:F}}),(0,c.forOwn)(this.availableAttributes,((e,a)=>{let n={label:a,value:{value:a,expandable:!0}};t.push(n)})),t})),I(this,"buildFromTarget",((e,t,a)=>{const n=e.target.split(";"),l=n.length>0?n[0].split("\\"):[];return l.length>1||1===l.length&&""!==l[0]?(n.splice(0,1),(0,c.each)(l,((e,a)=>{t.push({label:e,value:{type:e.match(/\${\w+}/gi)?"template":void 0,value:e,expandable:!0}})})),(0,c.each)(n,((e,t)=>{""!==e&&a.push({label:e,value:{value:e,expandable:!1}})})),this.getElementSegments(l.length+1,t).then((e=>(e.length>0&&t.push({label:"Select Element",value:{value:"-Select Element-"}}),t)))):Promise.resolve(t)})),I(this,"checkAfServer",(()=>{var e;const{datasource:t}=this.props,a=[];var n;return(null===(e=t.afserver)||void 0===e?void 0:e.name)?(a.push({label:t.afserver.name,value:{value:t.afserver.name,expandable:!0}}),(null===(n=t.afdatabase)||void 0===n?void 0:n.name)&&a.push({label:t.afdatabase.name,value:{value:t.afdatabase.name,expandable:!0}}),a.push({label:"Select Element",value:{value:"-Select Element-"}})):a.push({label:""}),a})),I(this,"updateArray",((e,t,a,n,l)=>{this.setState({segments:e,attributes:t,summaries:a,isPiPoint:n},(()=>{n||this.checkAttributeSegments(t,this.state.segments).then((()=>{l&&l()}))}))})),I(this,"scopedVarsDone",!1),I(this,"componentDidMount",(()=>{this.initialLoad(!1)})),I(this,"componentDidUpdate",(()=>{var e,t,a;const{query:n}=this.props;"Done"===(null===(e=this.props.data)||void 0===e?void 0:e.state)&&(null===(a=this.props.data)||void 0===a||null===(t=a.request)||void 0===t?void 0:t.scopedVars)&&!this.scopedVarsDone&&(this.scopedVarsDone=!0,this.initialLoad(!n.isPiPoint))})),I(this,"initialLoad",(e=>{const{query:t}=this.props,a=(0,c.defaults)(t,S),{segments:n,attributes:l,summary:r,isPiPoint:i}=a;var s;let o=e?[]:null!==(s=null==n?void 0:n.slice(0))&&void 0!==s?s:[];var u;let h=e?[]:null!==(u=null==l?void 0:l.slice(0))&&void 0!==u?u:[];var m;let d=null!==(m=null==r?void 0:r.types)&&void 0!==m?m:[];if(i||0!==o.length)i&&o.length>0&&(this.piServer=o);else{if(t.target&&t.target.length>0&&";"!==t.target)return h=[],void this.buildFromTarget(t,o,h).then((e=>{this.updateArray(e,h,d,!1)})).catch((e=>console.error(e)));o=this.checkAfServer()}this.updateArray(o,h,d,!!i,(()=>{this.onChange(t)}))})),I(this,"onChange",(e=>{const{onChange:t,onRunQuery:a}=this.props;var n,l;if(e.rawQuery){if(e.target=null!==(n=e.query)&&void 0!==n?n:"",e.query){const{attributes:t,elementPath:a}=function(e){const t=e.split(";"),a=t[0].split("\\");t.splice(0,1);let n=[];if(a.length>1||1===a.length&&""!==a[0]){const e=a.join("\\");return(0,c.each)(t,(function(e,t){""!==e&&n.push({label:e,value:{value:e,expandable:!1}})})),{attributes:n,elementPath:e}}return{attributes:n,elementPath:null}}(e.target);e.attributes=t,e.elementPath=a}}else e.elementPath=this.getSegmentPathUpTo(this.state.segments,this.state.segments.length),e.target=e.elementPath+";"+(0,c.join)(null===(l=e.attributes)||void 0===l?void 0:l.map((e=>{var t;return null===(t=e.value)||void 0===t?void 0:t.value})),";");const r=e.summary;r&&(r.types=this.state.summaries),t(O(w({},e),{summary:r})),console.log("QUERY",e.elementPath,e.attributes,e.target),this.isValidQuery(e)&&a()})),I(this,"isValidQuery",(e=>{if(e.target&&e.target.length>0&&";"!==e.target){e.target=e.target.trim();const t=e.target.split(";",2);return 2===t.length&&t[0].length>0&&t[1].length>0}return!1})),I(this,"stateCallback",(()=>{const e=this.props.query;this.onChange(e)})),I(this,"onIsPiPointChange",(e=>{const{query:t}=this.props,a=!t.isPiPoint;this.setState({segments:a?[{label:""}]:this.checkAfServer(),attributes:[],isPiPoint:a},(()=>{this.onChange(O(w({},t),{expression:"",attributes:this.state.attributes,segments:this.state.segments,isPiPoint:a}))}))})),this.onSegmentChange=this.onSegmentChange.bind(this),this.calcBasisValueChanged=this.calcBasisValueChanged.bind(this),this.calcNoDataValueChanged=this.calcNoDataValueChanged.bind(this),this.onSummaryAction=this.onSummaryAction.bind(this),this.onSummaryValueChanged=this.onSummaryValueChanged.bind(this),this.onAttributeAction=this.onAttributeAction.bind(this),this.onAttributeChange=this.onAttributeChange.bind(this),this.summaryTypes=["Total","Average","Minimum","Maximum","Range","StdDev","PopulationStdDev","Count","PercentGood","All","AllForNonNumeric"],this.calculationBasis=["TimeWeighted","EventWeighted","TimeWeightedContinuous","TimeWeightedDiscrete","EventWeightedExcludeMostRecentEvent","EventWeightedExcludeEarliestEvent","EventWeightedIncludeBothEnds"],this.noDataReplacement=["Null","Drop","Previous","0","Keep"]}}var W=o(269),V=o(531);function N(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function T(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{},n=Object.keys(a);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(a).filter((function(e){return Object.getOwnPropertyDescriptor(a,e).enumerable})))),n.forEach((function(t){N(e,t,a[t])}))}return e}function k(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);a.push.apply(a,n)}return a}(Object(t)).forEach((function(a){Object.defineProperty(e,a,Object.getOwnPropertyDescriptor(t,a))})),e}const B=30,q=(0,t.memo)((function(e){var l,r,i,s,o,u;const{query:h,datasource:m,annotation:c,onChange:d,onRunQuery:p}=e,[g,v]=(0,t.useState)("");var b;const[y,f]=(0,t.useState)(null!==(b=null==c||null===(l=c.target)||void 0===l?void 0:l.database)&&void 0!==b?b:{});if(void 0===c)return null;const E=e=>{const t=c.target;if(t&&t[e])return{label:t[e].Name,value:t[e]}};var S;return m.getAssetServer(m.afserver.name).then((e=>{v(e.WebId)})),a().createElement(a().Fragment,null,a().createElement("div",{className:"gf-form-group"},a().createElement(n.InlineFieldRow,null,a().createElement(n.InlineField,{label:"Database",labelWidth:B,grow:!0},a().createElement(n.AsyncSelect,{key:null!=g?g:"database-key",loadOptions:()=>m.getDatabases(g).then((e=>e.map((e=>({label:e.Name,value:e}))))),loadingMessage:"Loading",value:E("database"),onChange:e=>{f(e.value),d(k(T({},h),{database:e.value,template:void 0}))},defaultOptions:!0})),a().createElement(n.InlineField,{label:"Event Frames",labelWidth:B,grow:!0},a().createElement(n.AsyncSelect,{key:null!==(S=null==y?void 0:y.WebId)&&void 0!==S?S:"default-template-key",loadOptions:()=>m.getEventFrameTemplates(null==y?void 0:y.WebId).then((e=>e.map((e=>({label:e.Name,value:e}))))),loadingMessage:"Loading",value:E("template"),onChange:e=>d(k(T({},h),{template:e.value})),defaultOptions:!0})),a().createElement(n.InlineField,{label:"Show Start and End Time",labelWidth:B,grow:!0},a().createElement(n.InlineSwitch,{value:!!h.showEndTime,onChange:e=>d(k(T({},h),{showEndTime:e.currentTarget.checked}))}))),a().createElement(n.InlineFieldRow,null,a().createElement(n.InlineField,{label:"Category name",labelWidth:B,grow:!0},a().createElement(n.Input,{type:"text",value:h.categoryName,onBlur:e=>p(),onChange:e=>d(k(T({},h),{categoryName:e.currentTarget.value})),placeholder:"Enter category name"})),a().createElement(n.InlineField,{label:"Name Filter",labelWidth:B,grow:!0},a().createElement(n.Input,{type:"text",value:h.nameFilter,onBlur:e=>p(),onChange:e=>d(k(T({},h),{nameFilter:e.currentTarget.value})),placeholder:"Enter name filter"}))),a().createElement(n.InlineFieldRow,null,a().createElement(n.InlineField,{label:"Enable Name Regex Replacement",labelWidth:B,grow:!1},a().createElement(n.InlineSwitch,{value:null===(r=h.regex)||void 0===r?void 0:r.enable,onChange:e=>d(k(T({},h),{regex:k(T({},h.regex),{enable:e.currentTarget.checked})}))})),a().createElement(n.InlineField,{label:"Name Filter",labelWidth:20,grow:!1},a().createElement(n.Input,{type:"text",value:null===(i=h.regex)||void 0===i?void 0:i.search,onBlur:e=>p(),onChange:e=>d(k(T({},h),{regex:k(T({},h.regex),{search:e.currentTarget.value})})),placeholder:"(.*)",width:50})),a().createElement(n.InlineField,{label:"Replace",labelWidth:20,grow:!0},a().createElement(n.Input,{type:"text",value:null==h||null===(s=h.regex)||void 0===s?void 0:s.replace,onBlur:e=>p(),onChange:e=>d(k(T({},h),{regex:k(T({},h.regex),{replace:e.currentTarget.value})})),placeholder:"$1"}))),a().createElement(n.InlineFieldRow,null,a().createElement(n.InlineField,{label:"Enable Attribute Usage",labelWidth:B,grow:!1},a().createElement(n.InlineSwitch,{value:null===(o=h.attribute)||void 0===o?void 0:o.enable,onChange:e=>d(k(T({},h),{attribute:k(T({},h.attribute),{enable:e.currentTarget.checked})}))})),a().createElement(n.InlineField,{label:"Attribute Name",labelWidth:B,grow:!0},a().createElement(n.Input,{type:"text",value:null===(u=h.attribute)||void 0===u?void 0:u.name,onBlur:e=>p(),onChange:e=>d(k(T({},h),{attribute:k(T({},h.attribute),{name:e.currentTarget.value})})),placeholder:"Enter name"})))))}));function R(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}class U extends V.DataSourceWithBackend{applyTemplateVariables(e,t){return a=function(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{},n=Object.keys(a);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(a).filter((function(e){return Object.getOwnPropertyDescriptor(a,e).enumerable})))),n.forEach((function(t){R(e,t,a[t])}))}return e}({},e),n=null!=(n={target:e.target?this.templateSrv.replace(e.target,t):""})?n:{},Object.getOwnPropertyDescriptors?Object.defineProperties(a,Object.getOwnPropertyDescriptors(n)):function(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);a.push.apply(a,n)}return a}(Object(n)).forEach((function(e){Object.defineProperty(a,e,Object.getOwnPropertyDescriptor(n,e))})),a;var a,n}query(e){if(1===e.targets.length&&e.targets[0].isAnnotation)return super.query(e);const t=this.buildQueryParameters(e);return t.targets.length<=0?(0,W.of)({data:[]}):super.query(t)}metricFindQuery(e,t){const a=this,n=["servers","databases","databaseElements","elements"];var l,r;return"string"==typeof e&&(e=JSON.parse(e)),t.isPiPoint?e.path=this.templateSrv.replace(e.path,t):(""===e.path?e.type=n[0]:(e.path=this.templateSrv.replace(e.path,t),e.path=e.path.split(";")[0],"attributes"!==e.type&&(e.type=n[Math.max(0,Math.min(e.path.split("\\").length,n.length-1))])),e.path=e.path.replace(/\{([^\\])*\}/gi,(e=>e.substring(1,e.length-2).split(",")[0]))),e.filter=null!==(l=e.filter)&&void 0!==l?l:"*","servers"===e.type?(null===(r=a.afserver)||void 0===r?void 0:r.name)?a.getAssetServer(a.afserver.name).then((e=>[e])).then(C):a.getAssetServers().then(C):"databases"===e.type&&e.afServerWebId?a.getDatabases(e.afServerWebId,{}).then(C):"databases"===e.type?a.getAssetServer(e.path).then((e=>{var t;return a.getDatabases(null!==(t=e.WebId)&&void 0!==t?t:"",{})})).then(C):"databaseElements"===e.type?a.getDatabase(e.path).then((e=>{var t;return a.getDatabaseElements(null!==(t=e.WebId)&&void 0!==t?t:"",{selectedFields:"Items.WebId%3BItems.Name%3BItems.Items%3BItems.Path%3BItems.HasChildren"})})).then(C):"elements"===e.type?a.getElement(e.path).then((t=>{var n;return a.getElements(null!==(n=t.WebId)&&void 0!==n?n:"",{selectedFields:"Items.Description%3BItems.WebId%3BItems.Name%3BItems.Items%3BItems.Path%3BItems.HasChildren",nameFilter:e.filter})})).then(C):"attributes"===e.type?a.getElement(e.path).then((t=>{var n;return a.getAttributes(null!==(n=t.WebId)&&void 0!==n?n:"",{searchFullHierarchy:"true",selectedFields:"Items.Type%3BItems.DefaultUnitsName%3BItems.Description%3BItems.WebId%3BItems.Name%3BItems.Path",nameFilter:e.filter})})).then(C):"dataserver"===e.type?a.getDataServers().then(C):"pipoint"===e.type?a.piPointSearch(e.webId,e.pointName).then(C):Promise.reject("Bad type")}buildQueryParameters(e){return e.targets=(0,c.filter)(e.targets,(e=>{var t;return!(!e||!e.target||0===(null===(t=e.attributes)||void 0===t?void 0:t.length)||";"===e.target||e.hide||e.target.startsWith("Select AF"))})),e.maxDataPoints&&(e.maxDataPoints=e.maxDataPoints>3e4?3e4:e.maxDataPoints),e.targets=(0,c.map)(e.targets,(t=>{var a;const n={enableStreaming:t.enableStreaming,target:this.templateSrv.replace(t.target,e.scopedVars),elementPath:this.templateSrv.replace(t.elementPath,e.scopedVars),attributes:(0,c.map)(t.attributes,(t=>(t.value&&this.templateSrv.replace(t.value.value,e.scopedVars),t))),segments:(0,c.map)(t.segments,(t=>(t.value&&this.templateSrv.replace(t.value.value,e.scopedVars),t))),isAnnotation:!!t.isAnnotation,display:t.display?this.templateSrv.replace(t.display,e.scopedVars):void 0,refId:t.refId,hide:t.hide,interpolate:t.interpolate||{enable:!1},useLastValue:t.useLastValue||{enable:!1},useUnit:t.useUnit||{enable:!1},recordedValues:t.recordedValues||{enable:!1},digitalStates:t.digitalStates||{enable:!1},webid:null!==(a=t.webid)&&void 0!==a?a:"",regex:t.regex||{enable:!1},expression:t.expression||"",summary:t.summary||{types:[]},startTime:e.range.from,endTime:e.range.to,isPiPoint:!!t.isPiPoint,scopedVars:e.scopedVars};return n.expression&&(n.expression=this.templateSrv.replace(n.expression,e.scopedVars)),void 0!==n.summary.types&&(n.summary.types=(0,c.filter)(n.summary.types,(e=>null!=e&&""!==e))),n})),e}eventFrameToAnnotation(e,t){const a=e.target,n=[],l=Intl.DateTimeFormat().resolvedOptions().locale;return t.forEach((e=>{let t=this.transformDataFrameToMap(e);for(let e=0;e<t.time.length;e++){let r=t.title[e];a.regex&&a.regex.enable&&(r=r.replace(new RegExp(a.regex.search),a.regex.replace)),t.timeEnd[e]<0&&(t.timeEnd[e]=null);let i="Tag: "+r;a.attribute&&a.attribute.enable&&(i+=t.attributeText[e]),i+="<br />Start: "+new Date(t.time[e]).toLocaleString(l)+"<br />End: ",t.timeEnd[e]?i+=new Date(t.timeEnd[e]).toLocaleString(l):i+="Eventframe is open";const s={time:t.time[e],timeEnd:a.showEndTime?t.timeEnd[e]:void 0,title:r,id:t.id[e],text:i,tags:["OSISoft PI"]};n.push(s)}})),n}transformDataFrameToMap(e){const t={};return e.fields.forEach((e=>{t[e.name]=e.values.toArray()})),t}restGet(e){const t=this.backendSrv.fetch({url:`/api/datasources/${this.id}/resources${e}`,method:"GET",headers:{"Content-Type":"application/json"}});return(0,W.firstValueFrom)(t).then((e=>e))}getDataServers(){return this.restGet("/dataservers").then((e=>{var t;return null!==(t=e.data.Items)&&void 0!==t?t:[]}))}getDataServer(e){return e?this.restGet("/dataservers?name="+e).then((e=>e.data)):Promise.resolve({})}getAssetServers(){return this.restGet("/assetservers").then((e=>{var t;return null!==(t=e.data.Items)&&void 0!==t?t:[]}))}getAssetServer(e){return e?this.restGet("/assetservers?path=\\\\"+e).then((e=>e.data)):Promise.resolve({})}getDatabase(e){return e?this.restGet("/assetdatabases?path=\\\\"+e).then((e=>e.data)):Promise.resolve({})}getDatabases(e,t){return e?this.restGet("/assetservers/"+e+"/assetdatabases").then((e=>{var t;return null!==(t=e.data.Items)&&void 0!==t?t:[]})):Promise.resolve([])}getElement(e){return e?this.restGet("/elements?path=\\\\"+e).then((e=>e.data)):Promise.resolve({})}getEventFrameTemplates(e){return e?this.restGet("/assetdatabases/"+e+"/elementtemplates?selectedFields=Items.InstanceType%3BItems.Name%3BItems.WebId").then((e=>{var t;return(0,c.filter)(null!==(t=e.data.Items)&&void 0!==t?t:[],(e=>"EventFrame"===e.InstanceType))})):Promise.resolve([])}getElementTemplates(e){return e?this.restGet("/assetdatabases/"+e+"/elementtemplates?selectedFields=Items.InstanceType%3BItems.Name%3BItems.WebId").then((e=>{var t;return(0,c.filter)(null!==(t=e.data.Items)&&void 0!==t?t:[],(e=>"Element"===e.InstanceType))})):Promise.resolve([])}getAttributes(e,t){let a="?"+(0,c.map)(t,((e,t)=>t+"="+e)).join("&");return"?"===a&&(a=""),this.restGet("/elements/"+e+"/attributes"+a).then((e=>{var t;return null!==(t=e.data.Items)&&void 0!==t?t:[]}))}getDatabaseElements(e,t){let a="?"+(0,c.map)(t,((e,t)=>t+"="+e)).join("&");return"?"===a&&(a=""),this.restGet("/assetdatabases/"+e+"/elements"+a).then((e=>{var t;return null!==(t=e.data.Items)&&void 0!==t?t:[]}))}getElements(e,t){let a="?"+(0,c.map)(t,((e,t)=>t+"="+e)).join("&");return"?"===a&&(a=""),this.restGet("/elements/"+e+"/elements"+a).then((e=>{var t;return null!==(t=e.data.Items)&&void 0!==t?t:[]}))}piPointSearch(e,t){let a=this.templateSrv.replace(t),n=`${a}`,l=!1;if(a!==t){const e=RegExp("\\{(\\w|,)+\\}","gs");let t;for(;null!==(t=e.exec(a));)t.index===e.lastIndex&&e.lastIndex++,t.forEach(((e,t)=>{0===t&&(a=a.replace(e,e.replace("{","(").replace("}",")").replace(",","|")),n=n.replace(e,"*"),l=!0)}))}return this.restGet("/dataservers/"+e+"/points?maxCount=50&nameFilter="+n).then((e=>{var t;return e&&(null===(t=e.data)||void 0===t?void 0:t.Items)?l?e.data.Items.filter((e=>{var t;return null===(t=e.Name)||void 0===t?void 0:t.match(a)})):e.data.Items:[]}))}constructor(e,t=(0,V.getTemplateSrv)(),a=(0,V.getBackendSrv)()){super(e),R(this,"templateSrv",void 0),R(this,"backendSrv",void 0),R(this,"piserver",void 0),R(this,"afserver",void 0),R(this,"afdatabase",void 0),R(this,"piPointConfig",void 0),R(this,"newFormatConfig",void 0),R(this,"useUnitConfig",void 0),R(this,"useExperimental",void 0),R(this,"useStreaming",void 0),this.templateSrv=t,this.backendSrv=a,this.piserver={name:(e.jsonData||{}).piserver,webid:void 0},this.afserver={name:(e.jsonData||{}).afserver,webid:void 0},this.afdatabase={name:(e.jsonData||{}).afdatabase,webid:void 0},this.piPointConfig=e.jsonData.pipoint||!1,this.newFormatConfig=e.jsonData.newFormat||!1,this.useUnitConfig=e.jsonData.useUnit||!1,this.useExperimental=e.jsonData.useExperimental||!1,this.useStreaming=e.jsonData.useStreaming||!1,this.annotations={QueryEditor:q,prepareQuery:e=>(e.target&&(e.target.queryType="Annotation",e.target.isAnnotation=!0),e.target),processEvents:(e,t)=>(0,W.of)(this.eventFrameToAnnotation(e,t))},Promise.all([this.getDataServer(this.piserver.name).then((e=>this.piserver.webid=e.WebId)),this.getAssetServer(this.afserver.name).then((e=>this.afserver.webid=e.WebId)),this.getDatabase(this.afserver.name&&this.afdatabase.name?this.afserver.name+"\\"+this.afdatabase.name:void 0).then((e=>this.afdatabase.webid=e.WebId))])}}const M=new e.DataSourcePlugin(U).setQueryEditor(A).setConfigEditor(m)})(),u})()));
//# sourceMappingURL=module.js.map