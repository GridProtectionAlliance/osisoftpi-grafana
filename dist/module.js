/*! For license information please see module.js.LICENSE.txt */
define(["@grafana/data","@grafana/runtime","@grafana/ui","lodash","react"],((e,t,n,a,r)=>(()=>{"use strict";var i=[e=>{e.exports=r},e=>{e.exports=n},t=>{t.exports=e},e=>{e.exports=a},,e=>{e.exports=t}],o={};function l(e){var t=o[e];if(void 0!==t)return t.exports;var n=o[e]={exports:{}};return i[e](n,n.exports,l),n.exports}l.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return l.d(t,{a:t}),t},l.d=(e,t)=>{for(var n in t)l.o(t,n)&&!l.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},l.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),l.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var u={};return(()=>{l.r(u),l.d(u,{plugin:()=>Ee});var e=l(2);function t(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}function n(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var a=function(){function e(t){var a=this;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),n(this,"$scope",void 0),n(this,"annotation",void 0),n(this,"datasource",void 0),this.$scope=t,this.annotation=t.ctrl.annotation,this.datasource=t.ctrl.datasource,this.annotation.query=this.annotation.query||{},this.annotation.databases=this.annotation.databases||[],this.annotation.templates=this.annotation.templates||[],this.annotation.regex=this.annotation.regex||{},this.annotation.attribute=this.annotation.attribute||{},this.annotation.showEndTime=this.annotation.showEndTime||!1,this.datasource.getAssetServer(this.datasource.afserver.name).then((function(e){return a.getDatabases(e.WebId)}))}var a,r,i;return e.$inject=["$scope"],a=e,(r=[{key:"templateChanged",value:function(){}},{key:"databaseChanged",value:function(){this.annotation.templates=[],this.getEventFrames()}},{key:"getDatabases",value:function(e){var t=this,n=this;n.datasource.getDatabases(e).then((function(e){n.annotation.databases=e,t.$scope.$apply()}))}},{key:"getEventFrames",value:function(){var e=this,t=this;t.datasource.getEventFrameTemplates(this.annotation.database.WebId).then((function(n){t.annotation.templates=n,e.$scope.$apply()}))}}])&&t(a.prototype,r),i&&t(a,i),Object.defineProperty(a,"prototype",{writable:!1}),e}();n(a,"templateUrl","partials/annotations.editor.html");var r,i,o=l(0),s=l.n(o),c=l(1);function m(e){return m="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},m(e)}function p(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function h(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}function f(e,t){return f=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},f(e,t)}function d(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,a=g(e);if(t){var r=g(this).constructor;n=Reflect.construct(a,arguments,r)}else n=a.apply(this,arguments);return v(this,n)}}function v(e,t){if(t&&("object"===m(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return b(e)}function b(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function g(e){return g=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},g(e)}function y(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function P(){return P=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var a in n)Object.prototype.hasOwnProperty.call(n,a)&&(e[a]=n[a])}return e},P.apply(this,arguments)}var S,E,w=c.LegacyForms.FormField,I=function(e){return P({},e,{jsonData:P({},e.jsonData,{url:e.url})})},C=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&f(e,t)}(l,e);var t,n,a,o=d(l);function l(){var e;p(this,l);for(var t=arguments.length,n=new Array(t),a=0;a<t;a++)n[a]=arguments[a];return y(b(e=o.call.apply(o,[this].concat(n))),"onPIServerChange",(function(t){var n=e.props,a=n.onOptionsChange,r=n.options,i=P({},r.jsonData,{piserver:t.target.value});a(P({},r,{jsonData:i}))})),y(b(e),"onAFServerChange",(function(t){var n=e.props,a=n.onOptionsChange,r=n.options,i=P({},r.jsonData,{afserver:t.target.value});a(P({},r,{jsonData:i}))})),y(b(e),"onAFDatabaseChange",(function(t){var n=e.props,a=n.onOptionsChange,r=n.options,i=P({},r.jsonData,{afdatabase:t.target.value});a(P({},r,{jsonData:i}))})),y(b(e),"onHttpOptionsChange",(function(t){(0,e.props.onOptionsChange)(I(t))})),y(b(e),"onPiPointChange",(function(t){var n=e.props,a=n.onOptionsChange,r=n.options,i=P({},r.jsonData,{piserver:t.target.checked?r.jsonData.piserver:"",pipoint:t.target.checked});a(P({},r,{jsonData:i}))})),y(b(e),"onNewFormatChange",(function(t){var n=e.props,a=n.onOptionsChange,r=n.options,i=P({},r.jsonData,{newFormat:t.target.checked});a(P({},r,{jsonData:i}))})),e}return t=l,(n=[{key:"render",value:function(){var e=this.props.options,t=I(e);return s().createElement("div",null,s().createElement(c.DataSourceHttpSettings,{defaultUrl:"https://server.name/piwebapi",dataSourceConfig:t,onChange:this.onHttpOptionsChange,showAccessOptions:!0}),r||(r=s().createElement("h3",{className:"page-heading"},"Custom Configuration")),s().createElement("div",{className:"gf-form-group"},s().createElement("div",{className:"gf-form-inline"},s().createElement(c.InlineField,{label:"Enable PI Points in Query",labelWidth:24},s().createElement(c.InlineSwitch,{value:t.jsonData.pipoint,onChange:this.onPiPointChange}))),s().createElement("div",{className:"gf-form-inline"},s().createElement(c.InlineField,{label:"Enable New Data Format",labelWidth:24},s().createElement(c.InlineSwitch,{value:t.jsonData.newFormat,onChange:this.onNewFormatChange})))),i||(i=s().createElement("h3",{className:"page-heading"},"PI/AF Connection Details")),s().createElement("div",{className:"gf-form-group"},t.jsonData.pipoint&&s().createElement("div",{className:"gf-form"},s().createElement(w,{label:"PI Server",labelWidth:10,inputWidth:25,onChange:this.onPIServerChange,value:t.jsonData.piserver||"",placeholder:"Default PI Server to use for data requests"})),s().createElement("div",{className:"gf-form"},s().createElement(w,{label:"AF Server",labelWidth:10,inputWidth:25,onChange:this.onAFServerChange,value:t.jsonData.afserver||"",placeholder:"Default AF Server to use for data requests"})),s().createElement("div",{className:"gf-form"},s().createElement(w,{label:"AF Database",labelWidth:10,inputWidth:25,onChange:this.onAFDatabaseChange,value:t.jsonData.afdatabase||"",placeholder:"Default AF Database server for AF queries"}))))}}])&&h(t.prototype,n),a&&h(t,a),Object.defineProperty(t,"prototype",{writable:!1}),l}(o.PureComponent),x=l(3);function A(){return A=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var a in n)Object.prototype.hasOwnProperty.call(n,a)&&(e[a]=n[a])}return e},A.apply(this,arguments)}var O=function(e){var t=e.label,n=e.labelWidth,a=void 0===n?12:n,r=e.tooltip,i=e.children;return s().createElement(s().Fragment,null,s().createElement(c.InlineFormLabel,{width:a,tooltip:r},t),i)},D=function(){return S||(S=s().createElement("div",{className:"gf-form gf-form--grow"},s().createElement("div",{className:"gf-form-label gf-form-label--grow"})))},T=function(e){var t=A({},e);return s().createElement(N,null,s().createElement(O,t))},N=function(e){return s().createElement("div",{className:"gf-form-inline"},e.children,E||(E=s().createElement(D,null)))},j=function(e){var t=A({},e);return s().createElement(V,null,s().createElement(O,t))},V=function(e){return s().createElement(s().Fragment,null,e.children)},F={target:";",attributes:[],segments:[],regex:{enable:!1},summary:{types:[],basis:"EventWeighted",interval:"",nodata:"Null"},expression:"",interpolate:{enable:!1},useLastValue:{enable:!1},recordedValues:{enable:!1},digitalStates:{enable:!1},isPiPoint:!1};function k(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null==n)return;var a,r,i=[],o=!0,l=!1;try{for(n=n.call(e);!(o=(a=n.next()).done)&&(i.push(a.value),!t||i.length!==t);o=!0);}catch(e){l=!0,r=e}finally{try{o||null==n.return||n.return()}finally{if(l)throw r}}return i}(e,t)||function(e,t){if(!e)return;if("string"==typeof e)return B(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return B(e,t)}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function B(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,a=new Array(t);n<t;n++)a[n]=e[n];return a}var W,R,q=function(e){var t=e.isRaw,n=e.onChange,a=k((0,o.useState)(!1),2),r=a[0],i=a[1];return(0,o.useEffect)((function(){i(!1)}),[t]),t?s().createElement(s().Fragment,null,s().createElement(c.Button,{"aria-label":"Switch to visual editor",icon:"pen",variant:"secondary",type:"button",onClick:function(){i(!0)}}),s().createElement(c.ConfirmModal,{isOpen:r,title:"Switch to visual editor mode",body:"Are you sure to switch to visual editor mode? You will lose the changes done in raw query mode.",confirmText:"Yes, switch to editor mode",dismissText:"No, stay in raw query mode",onConfirm:function(){n(!1)},onDismiss:function(){i(!1)}})):s().createElement(c.Button,{"aria-label":"Switch to text editor",icon:"pen",variant:"secondary",type:"button",onClick:function(){n(!0)}})};function _(e){return _="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},_(e)}function L(){return L=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var a in n)Object.prototype.hasOwnProperty.call(n,a)&&(e[a]=n[a])}return e},L.apply(this,arguments)}function G(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}function M(e,t){return M=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},M(e,t)}function Q(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,a=H(e);if(t){var r=H(this).constructor;n=Reflect.construct(a,arguments,r)}else n=a.apply(this,arguments);return U(this,n)}}function U(e,t){if(t&&("object"===_(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return $(e)}function $(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function H(e){return H=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},H(e)}function z(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var J=24,X=250,Y="-REMOVE-",K=function(e){var t;return e.value?s().createElement("div",{className:"gf-form-label ".concat("template"===e.value.type?"query-keyword":"")},null!==(t=e.label)&&void 0!==t?t:"--no label--"):W||(W=s().createElement("a",{className:"gf-form-label query-part"},s().createElement(c.Icon,{name:"plus"})))},Z=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&M(e,t)}(i,e);var t,n,a,r=Q(i);function i(e){var t;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,i),z($(t=r.call(this,e)),"error",void 0),z($(t),"piServer",[]),z($(t),"availableAttributes",{}),z($(t),"summaryTypes",void 0),z($(t),"calculationBasis",void 0),z($(t),"noDataReplacement",void 0),z($(t),"state",{isPiPoint:!1,segments:[],attributes:[],summaries:[],attributeSegment:{},summarySegment:{},calculationBasisSegment:{},noDataReplacementSegment:{}}),z($(t),"segmentChangeValue",(function(e){var n=t.props.query;t.setState({segments:e},(function(){return t.onChange(L({},n,{segments:e}))}))})),z($(t),"attributeChangeValue",(function(e){var n=t.props.query;t.setState({attributes:e},(function(){return t.onChange(L({},n,{attributes:e}))}))})),z($(t),"onPiPointChange",(function(e,n){var a=t.state.attributes.slice(0);e.label===Y?(0,x.remove)(a,(function(e,t){return t===n})):a[n]=e,t.checkPiPointSegments(e,a)})),z($(t),"onAttributeChange",(function(e,n){var a,r=t.state.attributes.slice(0);r[n].label!==(null===(a=e.value)||void 0===a?void 0:a.value)&&(r[n]=e,t.checkAttributeSegments(r,t.state.segments))})),z($(t),"onSegmentChange",(function(e,n){var a,r=t.props.query,i=t.state.segments.slice(0);i[n].label!==(null===(a=e.value)||void 0===a?void 0:a.value)&&t.setState({attributes:[]},(function(){return e.label===Y?(i=(0,x.slice)(i,0,n),void t.checkAttributeSegments([],i).then((function(){var e;0===i.length?i.push({label:""}):null!==(e=i[i.length-1].value)&&void 0!==e&&e.expandable&&i.push({label:"Select Element",value:{value:"-Select Element-"}}),r.isPiPoint&&(t.piServer=[]),t.segmentChangeValue(i)}))):(i[n]=e,r.isPiPoint?(t.piServer.push(e),void t.segmentChangeValue(i)):(n<i.length-1&&(i=(0,x.slice)(i,0,n+1)),void t.checkAttributeSegments([],i).then((function(){var n;null!==(n=e.value)&&void 0!==n&&n.expandable&&i.push({label:"Select Element",value:{value:"-Select Element-"}}),t.segmentChangeValue(i)}))))}))})),z($(t),"getElementSegments",(function(e,n){var a,r,i=t.props,o=i.datasource,l=i.query,u=i.data,s=$(t),c=l.isPiPoint?{type:"dataserver"}:{path:t.getSegmentPathUpTo(null!=n?n:t.state.segments.slice(0),e)};if(!l.isPiPoint){var m,p,h;if(null!==(m=o.afserver)&&void 0!==m&&m.name&&0===e)return Promise.resolve([{label:o.afserver.name,value:{value:o.afserver.name,expandable:!0}}]);if(null!==(p=o.afserver)&&void 0!==p&&p.name&&null!==(h=o.afdatabase)&&void 0!==h&&h.name&&1===e)return Promise.resolve([{label:o.afdatabase.name,value:{value:o.afdatabase.name,expandable:!0}}])}return o.metricFindQuery(c,Object.assign(null!==(a=null==u||null===(r=u.request)||void 0===r?void 0:r.scopedVars)&&void 0!==a?a:{},{isPiPoint:l.isPiPoint})).then((function(e){var t=(0,x.map)(e,(function(e){return{label:e.text,value:{webId:e.WebId,value:e.text,expandable:!l.isPiPoint&&e.expandable}}}));if(0===t.length)return t;var n=o.templateSrv.getVariables();return(0,x.each)(n,(function(e){var n={label:"${"+e.name+"}",value:{type:"template",value:"${"+e.name+"}",expandable:!l.isPiPoint}};t.unshift(n)})),t.unshift({label:Y,value:{value:Y}}),t})).catch((function(e){return s.error=e.message||"Failed to issue metric query",[]}))})),z($(t),"getAttributeSegmentsPI",(function(e){var n,a,r=t.props,i=r.datasource,o=r.query,l=r.data,u=$(t),s={path:"",webId:t.getSelectedPIServer(),pointName:(null!=e?e:"")+"*",type:"pipoint"},c=[];return i.metricFindQuery(s,Object.assign(null!==(n=null==l||null===(a=l.request)||void 0===a?void 0:a.scopedVars)&&void 0!==n?n:{},{isPiPoint:o.isPiPoint})).then((function(t){c=(0,x.map)(t,(function(e){return{path:e.Path,label:e.text,value:{value:e.text,expandable:!1}}})),e&&e.length>0&&c.unshift({label:e,value:{value:e,expandable:!1}});var n=i.templateSrv.getVariables();return(0,x.each)(n,(function(e){var t={label:"${"+e.name+"}",value:{type:"template",value:"${"+e.name+"}",expandable:!o.isPiPoint}};c.unshift(t)})),c.unshift({label:Y,value:{value:Y}}),c})).catch((function(e){return u.error=e.message||"Failed to issue metric query",c}))})),z($(t),"getAttributeSegmentsAF",(function(e){var n=$(t),a=[];return(0,x.forOwn)(n.availableAttributes,(function(e,t){var n={label:t,value:{value:t,expandable:!0}};a.push(n)})),a.unshift({label:Y,value:{value:Y}}),a})),z($(t),"buildFromTarget",(function(e,n,a){var r=e.target.split(";"),i=r.length>0?r[0].split("\\"):[];return i.length>1||1===i.length&&""!==i[0]?(r.splice(0,1),(0,x.each)(i,(function(e,t){n.push({label:e,value:{type:e.match(/\${\w+}/gi)?"template":void 0,value:e,expandable:!0}})})),(0,x.each)(r,(function(e,t){""!==e&&a.push({label:e,value:{value:e,expandable:!1}})})),t.getElementSegments(i.length+1,n).then((function(e){return e.length>0&&n.push({label:"Select Element",value:{value:"-Select Element-"}}),n}))):Promise.resolve(n)})),z($(t),"checkAfServer",(function(){var e,n,a=t.props.datasource,r=[];null!==(e=a.afserver)&&void 0!==e&&e.name?(r.push({label:a.afserver.name,value:{value:a.afserver.name,expandable:!0}}),null!==(n=a.afdatabase)&&void 0!==n&&n.name&&r.push({label:a.afdatabase.name,value:{value:a.afdatabase.name,expandable:!0}}),r.push({label:"Select Element",value:{value:"-Select Element-"}})):r.push({label:""});return r})),z($(t),"updateArray",(function(e,n,a,r,i){t.setState({segments:e,attributes:n,summaries:a,isPiPoint:r},(function(){r||t.checkAttributeSegments(n,t.state.segments).then((function(){i&&i()}))}))})),z($(t),"scopedVarsDone",!1),z($(t),"componentDidMount",(function(){t.initialLoad(!1)})),z($(t),"componentDidUpdate",(function(){var e,n,a,r=t.props.query;"Done"===(null===(e=t.props.data)||void 0===e?void 0:e.state)&&null!==(n=t.props.data)&&void 0!==n&&null!==(a=n.request)&&void 0!==a&&a.scopedVars&&!t.scopedVarsDone&&(t.scopedVarsDone=!0,t.initialLoad(!r.isPiPoint))})),z($(t),"initialLoad",(function(e){var n,a,r,i=t.props.query,o=(0,x.defaults)(i,F),l=o.segments,u=o.attributes,s=o.summary,c=o.isPiPoint,m=e?[]:null!==(n=null==l?void 0:l.slice(0))&&void 0!==n?n:[],p=e?[]:null!==(a=null==u?void 0:u.slice(0))&&void 0!==a?a:[],h=null!==(r=null==s?void 0:s.types)&&void 0!==r?r:[];if(c||0!==m.length)c&&m.length>0&&(t.piServer=m);else{if(i.target&&i.target.length>0&&";"!==i.target)return p=[],void t.buildFromTarget(i,m,p).then((function(e){t.updateArray(e,p,h,c)})).catch((function(e){}));m=t.checkAfServer()}t.updateArray(m,p,h,c,(function(){t.onChange(i)}))})),z($(t),"onChange",(function(e){var n,a=t.props,r=a.onChange,i=a.onRunQuery;(e.summary.types=t.state.summaries,e.rawQuery)?e.target=null!==(n=e.query)&&void 0!==n?n:"":(e.elementPath=t.getSegmentPathUpTo(t.state.segments,t.state.segments.length),e.target=e.elementPath+";"+(0,x.join)(e.attributes.map((function(e){var t;return null===(t=e.value)||void 0===t?void 0:t.value})),";"));r(e),e.target&&e.target.length>0&&i()})),z($(t),"stateCallback",(function(){var e=t.props.query;t.onChange(e)})),z($(t),"onIsPiPointChange",(function(e){var n=t.props.query,a=!n.isPiPoint;t.setState({segments:a?[{label:""}]:t.checkAfServer(),attributes:[],isPiPoint:a},(function(){t.onChange(L({},n,{expression:"",attributes:t.state.attributes,segments:t.state.segments,isPiPoint:a}))}))})),t.onSegmentChange=t.onSegmentChange.bind($(t)),t.calcBasisValueChanged=t.calcBasisValueChanged.bind($(t)),t.calcNoDataValueChanged=t.calcNoDataValueChanged.bind($(t)),t.onSummaryAction=t.onSummaryAction.bind($(t)),t.onSummaryValueChanged=t.onSummaryValueChanged.bind($(t)),t.onAttributeAction=t.onAttributeAction.bind($(t)),t.onAttributeChange=t.onAttributeChange.bind($(t)),t.summaryTypes=["Total","Average","Minimum","Maximum","Range","StdDev","PopulationStdDev","Count","PercentGood","All","AllForNonNumeric"],t.calculationBasis=["TimeWeighted","EventWeighted","TimeWeightedContinuous","TimeWeightedDiscrete","EventWeightedExcludeMostRecentEvent","EventWeightedExcludeEarliestEvent","EventWeightedIncludeBothEnds"],t.noDataReplacement=["Null","Drop","Previous","0","Keep"],t}return t=i,(n=[{key:"isValueEmpty",value:function(e){return!e||!e.value||!e.value.length||e.value===Y}},{key:"calcBasisValueChanged",value:function(e){var t,n=this.props.query,a=n.summary;a.basis=null===(t=e.value)||void 0===t?void 0:t.value,this.onChange(L({},n,{summary:a}))}},{key:"getCalcBasisSegments",value:function(){return(0,x.map)(this.calculationBasis,(function(e){return{label:e,value:{value:e,expandable:!0}}}))}},{key:"calcNoDataValueChanged",value:function(e){var t,n=this.props.query,a=n.summary;a.nodata=null===(t=e.value)||void 0===t?void 0:t.value,this.onChange(L({},n,{summary:a}))}},{key:"getNoDataSegments",value:function(){return(0,x.map)(this.noDataReplacement,(function(e){return{label:e,value:{value:e,expandable:!0}}}))}},{key:"onSummaryValueChanged",value:function(e,t){var n=this.state.summaries.slice(0);n[t]=e,this.isValueEmpty(e.value)&&n.splice(t,1),this.setState({summaries:n},this.stateCallback)}},{key:"getSummarySegments",value:function(){var e=this,t=(0,x.filter)(this.summaryTypes,(function(t){return-1===e.state.summaries.map((function(e){var t;return null===(t=e.value)||void 0===t?void 0:t.value})).indexOf(t)})),n=(0,x.map)(t,(function(e){return{label:e,value:{value:e,expandable:!0}}}));return n.unshift({label:Y,value:{value:Y}}),n}},{key:"removeSummary",value:function(e){var t=(0,x.filter)(this.state.summaries,(function(t){return t!==e}));this.setState({summaries:t})}},{key:"onSummaryAction",value:function(e){var t=this.state.summaries.slice(0);if(!this.isValueEmpty(e.value)){var n,a={label:e.label,value:{value:null===(n=e.value)||void 0===n?void 0:n.value,expandable:!0}};t.push(a)}this.setState({summarySegment:{},summaries:t},this.stateCallback)}},{key:"removeAttribute",value:function(e){var t=(0,x.filter)(this.state.attributes,(function(t){return t!==e}));this.attributeChangeValue(t)}},{key:"onAttributeAction",value:function(e){var t=this.props.query,n=this.state.attributes.slice(0);if(!this.isValueEmpty(e.value)){var a,r={label:e.label,value:{value:null===(a=e.value)||void 0===a?void 0:a.value,expandable:!t.isPiPoint}};n.push(r)}this.attributeChangeValue(n)}},{key:"getSegmentPathUpTo",value:function(e,t){var n=e.slice(0,t);return(0,x.reduce)(n,(function(e,t){var n;return t.value?null!==(n=t.value.value)&&void 0!==n&&n.startsWith("-Select")?e:e?e+"\\"+t.value.value:t.value.value:""}),"")}},{key:"checkAttributeSegments",value:function(e,t){var n,a,r=this,i=this.props,o=i.datasource,l=i.data,u=this,s={path:this.getSegmentPathUpTo(t.slice(0),t.length),type:"attributes"};return o.metricFindQuery(s,Object.assign(null!==(n=null==l||null===(a=l.request)||void 0===a?void 0:a.scopedVars)&&void 0!==n?n:{},{isPiPoint:!1})).then((function(t){var n={};(0,x.each)(t,(function(e){n[e.Path.substring(e.Path.indexOf("|")+1)]=e.WebId}));var a=(0,x.filter)(e,(function(e){var t,a=o.templateSrv.replace(null===(t=e.value)||void 0===t?void 0:t.value);return void 0!==n[a]}));u.availableAttributes=n,r.attributeChangeValue(a)})).catch((function(t){u.error=t.message||"Failed to issue metric query",r.attributeChangeValue(e)}))}},{key:"checkPiPointSegments",value:function(e,t){var n,a,r=this.props,i=r.datasource,o=r.data,l=this,u={path:e.path,webId:l.getSelectedPIServer(),pointName:e.label,type:"pipoint"};return i.metricFindQuery(u,Object.assign(null!==(n=null==o||null===(a=o.request)||void 0===a?void 0:a.scopedVars)&&void 0!==n?n:{},{isPiPoint:!0})).then((function(){l.attributeChangeValue(t)})).catch((function(e){l.error=e.message||"Failed to issue metric query",l.attributeChangeValue([])}))}},{key:"getSelectedPIServer",value:function(){var e,t=this,n="";return this.piServer.forEach((function(e){var a=t.props.query.target.split(";");a.length>=2&&a[0]===e.text&&(n=e.WebId)})),this.piServer.length>0?null===(e=this.piServer[0].value)||void 0===e?void 0:e.webId:n}},{key:"textEditorChanged",value:function(){var e=this,t=this.props,n=t.query,a=t.onChange,r=n.target.split(";"),i=r.length>0?r[0].split("\\"):[],o=[],l=[];i.length>1||1===i.length&&""!==i[0]?(r.splice(0,1),(0,x.each)(i,(function(e,t){o.push({label:e,value:{type:e.match(/\${\w+}/gi)?"template":void 0,value:e,expandable:!0}})})),(0,x.each)(r,(function(e,t){""!==e&&l.push({label:e,value:{value:e,expandable:!1}})})),this.getElementSegments(i.length+1,o).then((function(e){e.length>0&&o.push({label:"Select Element",value:{value:"-Select Element-"}})})).then((function(){e.updateArray(o,l,e.state.summaries,n.isPiPoint,(function(){a(L({},n,{query:void 0,rawQuery:!1}))}))}))):(o=this.checkAfServer(),this.updateArray(o,this.state.attributes,this.state.summaries,n.isPiPoint,(function(){e.onChange(L({},n,{query:void 0,rawQuery:!1,attributes:e.state.attributes,segments:e.state.segments}))})))}},{key:"render",value:function(){var e=this,t=this.props,n=t.query,a=t.onChange,r=t.onRunQuery,i=(0,x.defaults)(n,F),o=i.useLastValue,l=i.interpolate,u=i.query,m=i.rawQuery,p=i.digitalStates,h=i.recordedValues,f=i.expression,d=i.isPiPoint,v=i.summary,b=i.display,g=i.regex;return s().createElement(s().Fragment,null,this.props.datasource.piPointConfig&&s().createElement(c.InlineField,{label:"Is Pi Point?",labelWidth:J},s().createElement(c.InlineSwitch,{value:d,onChange:this.onIsPiPointChange})),!!m&&s().createElement(c.InlineFieldRow,null,s().createElement(c.InlineField,{label:"Raw Query",labelWidth:J,grow:!0},s().createElement(c.Input,{onBlur:this.stateCallback,value:u,onChange:function(e){return a(L({},i,{query:e.target.value}))},placeholder:"enter query"})),s().createElement(q,{isRaw:!0,onChange:function(t){return e.textEditorChanged()}})),!m&&s().createElement(s().Fragment,null,s().createElement("div",{className:"gf-form-inline"},s().createElement(j,{label:d?"PI Server":"AF Elements",tooltip:d?"Select PI server.":"Select AF Element."},this.state.segments.map((function(t,n){return s().createElement(c.SegmentAsync,{key:"element-"+n,Component:s().createElement(K,{value:t.value,label:t.label}),onChange:function(t){return e.onSegmentChange(t,n)},loadOptions:function(t){return e.getElementSegments(n)},allowCustomValue:!0,inputMinWidth:200})})),R||(R=s().createElement(D,null)),!d&&s().createElement(q,{isRaw:!1,onChange:function(e){a(L({},i,{query:i.target,rawQuery:e}))}}))),s().createElement(T,{label:d?"Pi Points":"Attributes"},this.state.attributes.map((function(t,n){return d?s().createElement(c.SegmentAsync,{key:"attributes-"+n,Component:s().createElement(K,{value:t.value,label:t.label}),disabled:0===e.piServer.length,onChange:function(t){return e.onPiPointChange(t,n)},loadOptions:e.getAttributeSegmentsPI,reloadOptionsOnChange:!0,allowCustomValue:!0,inputMinWidth:X}):s().createElement(c.Segment,{key:"attributes-"+n,Component:s().createElement(K,{value:t.value,label:t.label}),disabled:e.state.segments.length<=2,onChange:function(t){return e.onAttributeChange(t,n)},options:e.getAttributeSegmentsAF(),allowCustomValue:!0,inputMinWidth:X})})),d&&s().createElement(c.SegmentAsync,{Component:s().createElement(K,{value:this.state.attributeSegment.value,label:this.state.attributeSegment.label}),disabled:0===this.piServer.length,onChange:this.onAttributeAction,loadOptions:this.getAttributeSegmentsPI,reloadOptionsOnChange:!0,allowCustomValue:!0,inputMinWidth:X}),!d&&s().createElement(c.Segment,{Component:s().createElement(K,{value:this.state.attributeSegment.value,label:this.state.attributeSegment.label}),disabled:this.state.segments.length<=2,onChange:this.onAttributeAction,options:this.getAttributeSegmentsAF(),allowCustomValue:!0,inputMinWidth:X}))),s().createElement(c.InlineFieldRow,null,s().createElement(c.InlineField,{label:"Use Last Value",labelWidth:J},s().createElement(c.InlineSwitch,{value:o.enable,onChange:function(){return e.onChange(L({},i,{useLastValue:L({},o,{enable:!o.enable})}))}}))),!o.enable&&s().createElement(s().Fragment,null,s().createElement(c.InlineField,{label:"Calculation",labelWidth:J,tooltip:"Modify all attributes by an equation. Use '.' for current item. Leave Attributes empty if you wish to perform element based calculations."},s().createElement(c.Input,{onBlur:r,value:f,onChange:function(e){return a(L({},i,{expression:e.target.value}))},placeholder:"'.'*2"})),s().createElement(c.InlineFieldRow,null,s().createElement(c.InlineField,{label:"Max Recorded Values",labelWidth:J,tooltip:"Maximum number of recorded value to retrive from the data archive, without using interpolation."},s().createElement(c.Input,{onBlur:r,value:h.maxNumber,onChange:function(e){return a(L({},i,{recordedValues:L({},h,{maxNumber:parseInt(e.target.value,10)})}))},type:"number",placeholder:"1000"})),s().createElement(c.InlineField,{label:"Recorded Values",labelWidth:J},s().createElement(c.InlineSwitch,{value:h.enable,onChange:function(){return e.onChange(L({},i,{recordedValues:L({},h,{enable:!h.enable})}))}})),s().createElement(c.InlineField,{label:"Digital States",labelWidth:J},s().createElement(c.InlineSwitch,{value:p.enable,onChange:function(){return e.onChange(L({},i,{digitalStates:L({},p,{enable:!p.enable})}))}}))),s().createElement(c.InlineFieldRow,null,s().createElement(c.InlineField,{label:"Interpolate Period",labelWidth:J,tooltip:"Override time in seconds between sampling, e.g. '30'. Defaults to timespan/chart width."},s().createElement(c.Input,{onBlur:r,value:l.interval,onChange:function(e){return a(L({},i,{interpolate:L({},l,{interval:e.target.value})}))},placeholder:"30"})),s().createElement(c.InlineField,{label:"Interpolate",labelWidth:J},s().createElement(c.InlineSwitch,{value:l.enable,onChange:function(){return e.onChange(L({},i,{interpolate:L({},l,{enable:!l.enable})}))}})),s().createElement(c.InlineField,{label:"Replace Bad Data",labelWidth:J,tooltip:"Replacement for bad quality values."},s().createElement(c.Segment,{Component:s().createElement(K,{value:{value:v.nodata},label:v.nodata}),onChange:this.calcNoDataValueChanged,options:this.getNoDataSegments(),allowCustomValue:!0}))),s().createElement(c.InlineFieldRow,null,s().createElement(c.InlineField,{label:"Summary Period",labelWidth:J,tooltip:"Override time between sampling, e.g. '30s'."},s().createElement(c.Input,{onBlur:r,value:v.interval,onChange:function(e){return a(L({},i,{summary:L({},v,{interval:e.target.value})}))},placeholder:"30s"})),s().createElement(c.InlineField,{label:"Basis",labelWidth:J,tooltip:"Defines the possible calculation options when performing summary calculations over time-series data."},s().createElement(c.Segment,{Component:s().createElement(K,{value:{value:v.basis},label:v.basis}),onChange:this.calcBasisValueChanged,options:this.getCalcBasisSegments(),allowCustomValue:!0})),s().createElement(c.InlineField,{label:"Summaries",labelWidth:J,tooltip:"Replacement for bad quality values."},s().createElement(c.InlineFieldRow,null,this.state.summaries.map((function(t,n){return s().createElement(c.Segment,{key:"summaries-"+n,Component:s().createElement(K,{value:t.value,label:t.label}),onChange:function(t){return e.onSummaryValueChanged(t,n)},options:e.getSummarySegments(),allowCustomValue:!0})})),s().createElement(c.Segment,{Component:s().createElement(K,{value:this.state.summarySegment.value,label:this.state.summarySegment.label}),onChange:this.onSummaryAction,options:this.getSummarySegments(),allowCustomValue:!0}))))),s().createElement(c.InlineFieldRow,null,s().createElement(c.InlineField,{label:"Display Name",labelWidth:J,tooltip:"If single attribute, modify display name. Otherwise use regex to modify display name."},s().createElement(c.Input,{onBlur:r,value:b,onChange:function(e){return a(L({},i,{display:e.target.value}))},placeholder:"Display"})),s().createElement(c.InlineField,{label:"Enable Regex Replace",labelWidth:J},s().createElement(c.InlineSwitch,{value:g.enable,onChange:function(){e.onChange(L({},i,{regex:L({},g,{enable:!g.enable})}))}})),s().createElement(c.InlineField,{label:"Search",labelWidth:16},s().createElement(c.Input,{onBlur:r,value:g.search,onChange:function(e){return a(L({},i,{regex:L({},g,{search:e.target.value})}))},placeholder:"(.*)"})),s().createElement(c.InlineField,{label:"Replace",labelWidth:16},s().createElement(c.Input,{onBlur:r,value:g.replace,onChange:function(e){return a(L({},i,{regex:L({},g,{replace:e.target.value})}))},placeholder:"$1"}))))}}])&&G(t.prototype,n),a&&G(t,a),Object.defineProperty(t,"prototype",{writable:!1}),i}(o.PureComponent),ee=l(5);function te(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return ne(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return ne(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var a=0,r=function(){};return{s:r,n:function(){return a>=e.length?{done:!0}:{done:!1,value:e[a++]}},e:function(e){throw e},f:r}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var i,o=!0,l=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return o=e.done,e},e:function(e){l=!0,i=e},f:function(){try{o||null==n.return||n.return()}finally{if(l)throw i}}}}function ne(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,a=new Array(t);n<t;n++)a[n]=e[n];return a}function ae(t){var n,a,r=[],i=[],o=te(t.datapoints);try{for(o.s();!(a=o.n()).done;){var l=a.value;i.push(l[0]),r.push(l[1])}}catch(e){o.e(e)}finally{o.f()}var u=[{name:e.TIME_SERIES_TIME_FIELD_NAME,type:e.FieldType.time,config:{},values:new e.ArrayVector(r)},{name:null!==(n=t.target)&&void 0!==n?n:e.TIME_SERIES_VALUE_FIELD_NAME,type:e.FieldType.number,config:{unit:t.unit},values:new e.ArrayVector(i),labels:t.tags}];return t.title&&(u[1].config.displayNameFromDS=t.title),{name:"",refId:t.refId,meta:t.meta,fields:u,length:i.length}}function re(e){return"number"==typeof e&&!Number.isNaN(e)&&Number.isFinite(e)}function ie(e){var t,n=e.split("|");return 0===n.length||0===(n=n[0].split("\\")).length?"":null!==(t=n.pop())&&void 0!==t?t:""}function oe(e,t){var n,a=ie(t);if(0===e.length)return"";var r=null===(n=e.find((function(e){return t.indexOf(e.path)>=0})))||void 0===n?void 0:n.variable;return r?r+"|"+a:a}function le(e,t,n){return e?n.replace(/'\.'/g,"'".concat(t.Name,"'")):n}function ue(){return ue=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var a in n)Object.prototype.hasOwnProperty.call(n,a)&&(e[a]=n[a])}return e},ue.apply(this,arguments)}function se(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return ce(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return ce(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var a=0,r=function(){};return{s:r,n:function(){return a>=e.length?{done:!0}:{done:!1,value:e[a++]}},e:function(e){throw e},f:r}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var i,o=!0,l=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return o=e.done,e},e:function(e){l=!0,i=e},f:function(){try{o||null==n.return||n.return()}finally{if(l)throw i}}}}function ce(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,a=new Array(t);n<t;n++)a[n]=e[n];return a}function me(e){return me="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},me(e)}function pe(){pe=function(){return e};var e={},t=Object.prototype,n=t.hasOwnProperty,a="function"==typeof Symbol?Symbol:{},r=a.iterator||"@@iterator",i=a.asyncIterator||"@@asyncIterator",o=a.toStringTag||"@@toStringTag";function l(e,t,n){return Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{l({},"")}catch(e){l=function(e,t,n){return e[t]=n}}function u(e,t,n,a){var r=t&&t.prototype instanceof m?t:m,i=Object.create(r.prototype),o=new w(a||[]);return i._invoke=function(e,t,n){var a="suspendedStart";return function(r,i){if("executing"===a)throw new Error("Generator is already running");if("completed"===a){if("throw"===r)throw i;return C()}for(n.method=r,n.arg=i;;){var o=n.delegate;if(o){var l=P(o,n);if(l){if(l===c)continue;return l}}if("next"===n.method)n.sent=n._sent=n.arg;else if("throw"===n.method){if("suspendedStart"===a)throw a="completed",n.arg;n.dispatchException(n.arg)}else"return"===n.method&&n.abrupt("return",n.arg);a="executing";var u=s(e,t,n);if("normal"===u.type){if(a=n.done?"completed":"suspendedYield",u.arg===c)continue;return{value:u.arg,done:n.done}}"throw"===u.type&&(a="completed",n.method="throw",n.arg=u.arg)}}}(e,n,o),i}function s(e,t,n){try{return{type:"normal",arg:e.call(t,n)}}catch(e){return{type:"throw",arg:e}}}e.wrap=u;var c={};function m(){}function p(){}function h(){}var f={};l(f,r,(function(){return this}));var d=Object.getPrototypeOf,v=d&&d(d(I([])));v&&v!==t&&n.call(v,r)&&(f=v);var b=h.prototype=m.prototype=Object.create(f);function g(e){["next","throw","return"].forEach((function(t){l(e,t,(function(e){return this._invoke(t,e)}))}))}function y(e,t){function a(r,i,o,l){var u=s(e[r],e,i);if("throw"!==u.type){var c=u.arg,m=c.value;return m&&"object"==me(m)&&n.call(m,"__await")?t.resolve(m.__await).then((function(e){a("next",e,o,l)}),(function(e){a("throw",e,o,l)})):t.resolve(m).then((function(e){c.value=e,o(c)}),(function(e){return a("throw",e,o,l)}))}l(u.arg)}var r;this._invoke=function(e,n){function i(){return new t((function(t,r){a(e,n,t,r)}))}return r=r?r.then(i,i):i()}}function P(e,t){var n=e.iterator[t.method];if(void 0===n){if(t.delegate=null,"throw"===t.method){if(e.iterator.return&&(t.method="return",t.arg=void 0,P(e,t),"throw"===t.method))return c;t.method="throw",t.arg=new TypeError("The iterator does not provide a 'throw' method")}return c}var a=s(n,e.iterator,t.arg);if("throw"===a.type)return t.method="throw",t.arg=a.arg,t.delegate=null,c;var r=a.arg;return r?r.done?(t[e.resultName]=r.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=void 0),t.delegate=null,c):r:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,c)}function S(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function E(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function w(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(S,this),this.reset(!0)}function I(e){if(e){var t=e[r];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var a=-1,i=function t(){for(;++a<e.length;)if(n.call(e,a))return t.value=e[a],t.done=!1,t;return t.value=void 0,t.done=!0,t};return i.next=i}}return{next:C}}function C(){return{value:void 0,done:!0}}return p.prototype=h,l(b,"constructor",h),l(h,"constructor",p),p.displayName=l(h,o,"GeneratorFunction"),e.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===p||"GeneratorFunction"===(t.displayName||t.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,h):(e.__proto__=h,l(e,o,"GeneratorFunction")),e.prototype=Object.create(b),e},e.awrap=function(e){return{__await:e}},g(y.prototype),l(y.prototype,i,(function(){return this})),e.AsyncIterator=y,e.async=function(t,n,a,r,i){void 0===i&&(i=Promise);var o=new y(u(t,n,a,r),i);return e.isGeneratorFunction(n)?o:o.next().then((function(e){return e.done?e.value:o.next()}))},g(b),l(b,o,"Generator"),l(b,r,(function(){return this})),l(b,"toString",(function(){return"[object Generator]"})),e.keys=function(e){var t=[];for(var n in e)t.push(n);return t.reverse(),function n(){for(;t.length;){var a=t.pop();if(a in e)return n.value=a,n.done=!1,n}return n.done=!0,n}},e.values=I,w.prototype={constructor:w,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(E),!e)for(var t in this)"t"===t.charAt(0)&&n.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=void 0)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var t=this;function a(n,a){return o.type="throw",o.arg=e,t.next=n,a&&(t.method="next",t.arg=void 0),!!a}for(var r=this.tryEntries.length-1;r>=0;--r){var i=this.tryEntries[r],o=i.completion;if("root"===i.tryLoc)return a("end");if(i.tryLoc<=this.prev){var l=n.call(i,"catchLoc"),u=n.call(i,"finallyLoc");if(l&&u){if(this.prev<i.catchLoc)return a(i.catchLoc,!0);if(this.prev<i.finallyLoc)return a(i.finallyLoc)}else if(l){if(this.prev<i.catchLoc)return a(i.catchLoc,!0)}else{if(!u)throw new Error("try statement without catch or finally");if(this.prev<i.finallyLoc)return a(i.finallyLoc)}}}},abrupt:function(e,t){for(var a=this.tryEntries.length-1;a>=0;--a){var r=this.tryEntries[a];if(r.tryLoc<=this.prev&&n.call(r,"finallyLoc")&&this.prev<r.finallyLoc){var i=r;break}}i&&("break"===e||"continue"===e)&&i.tryLoc<=t&&t<=i.finallyLoc&&(i=null);var o=i?i.completion:{};return o.type=e,o.arg=t,i?(this.method="next",this.next=i.finallyLoc,c):this.complete(o)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),c},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.finallyLoc===e)return this.complete(n.completion,n.afterLoc),E(n),c}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.tryLoc===e){var a=n.completion;if("throw"===a.type){var r=a.arg;E(n)}return r}}throw new Error("illegal catch attempt")},delegateYield:function(e,t,n){return this.delegate={iterator:I(e),resultName:t,nextLoc:n},"next"===this.method&&(this.arg=void 0),c}},e}function he(e,t,n,a,r,i,o){try{var l=e[i](o),u=l.value}catch(e){return void n(e)}l.done?t(u):Promise.resolve(u).then(a,r)}function fe(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}function de(e,t){return de=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},de(e,t)}function ve(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,a=ye(e);if(t){var r=ye(this).constructor;n=Reflect.construct(a,arguments,r)}else n=a.apply(this,arguments);return be(this,n)}}function be(e,t){if(t&&("object"===me(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return ge(e)}function ge(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function ye(e){return ye=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},ye(e)}function Pe(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var Se=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&de(e,t)}(l,e);var t,n,a,r,i,o=ve(l);function l(e){var t,n;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,l),Pe(ge(n=o.call(this,e)),"piserver",void 0),Pe(ge(n),"afserver",void 0),Pe(ge(n),"afdatabase",void 0),Pe(ge(n),"piPointConfig",void 0),Pe(ge(n),"newFormatConfig",void 0),Pe(ge(n),"basicAuth",void 0),Pe(ge(n),"withCredentials",void 0),Pe(ge(n),"url",void 0),Pe(ge(n),"name",void 0),Pe(ge(n),"isProxy",!1),Pe(ge(n),"templateSrv",void 0),Pe(ge(n),"backendSrv",void 0),Pe(ge(n),"piwebapiurl",void 0),Pe(ge(n),"webidCache",new Map),Pe(ge(n),"error",void 0),n.basicAuth=e.basicAuth,n.withCredentials=e.withCredentials,n.url=e.url,n.name=e.name,n.templateSrv=(0,ee.getTemplateSrv)(),n.backendSrv=(0,ee.getBackendSrv)(),n.piwebapiurl=null===(t=e.jsonData.url)||void 0===t?void 0:t.toString(),n.isProxy=/^http(s)?:\/\//.test(n.url)||"proxy"===e.jsonData.access,n.piserver={name:(e.jsonData||{}).piserver,webid:void 0},n.afserver={name:(e.jsonData||{}).afserver,webid:void 0},n.afdatabase={name:(e.jsonData||{}).afdatabase,webid:void 0},n.piPointConfig=e.jsonData.pipoint||!1,n.newFormatConfig=e.jsonData.newFormat||!1,Promise.all([n.getDataServer(n.piserver.name).then((function(e){return n.piserver.webid=e.WebId})),n.getAssetServer(n.afserver.name).then((function(e){return n.afserver.webid=e.WebId})),n.getDatabase(n.afserver.name?n.afserver.name+"\\"+n.afdatabase.name:void 0).then((function(e){return n.afdatabase.webid=e.WebId}))]).then((function(){})),n}return t=l,n=[{key:"eventFrameToAnnotation",value:function(e,t,n,a){e.regex&&e.regex.enable&&(n.Name=n.Name.replace(new RegExp(e.regex.search),e.regex.replace));var r="";return a&&(0,x.each)(a,(function(e){var t=e.Value.Value?e.Value.Value.Name||e.Value.Value.Value||e.Value.Value:null;r+="<br />"+e.Name+": "+t})),{annotation:e,title:(t?"END ":e.showEndTime?"START ":"")+e.name,time:new Date(t?n.EndTime:n.StartTime).getTime(),text:n.Name+r+"<br />Start: "+n.StartTime+"<br />End: "+n.EndTime}}},{key:"buildQueryParameters",value:function(e){var t=this;return e.targets=(0,x.filter)(e.targets,(function(e){return!(!e||!e.target||e.hide||e.target.startsWith("Select AF"))})),e.targets=(0,x.map)(e.targets,(function(n){if(n.rawQuery&&n.target){var a=function(e){var t=e.split(";"),n=t[0].split("\\");t.splice(0,1);var a=[];if(n.length>1||1===n.length&&""!==n[0]){var r=n.join("\\");return(0,x.each)(t,(function(e,t){""!==e&&a.push({label:e,value:{value:e,expandable:!1}})})),{attributes:a,elementPath:r}}return{attributes:a,elementPath:null}}(t.templateSrv.replace(n.target,e.scopedVars)),r=a.attributes,i=a.elementPath;n.attributes=r,n.elementPath=i}var o=t,l={target:t.templateSrv.replace(n.elementPath,e.scopedVars),elementPath:t.templateSrv.replace(n.elementPath,e.scopedVars),elementPathArray:[{path:t.templateSrv.replace(n.elementPath,e.scopedVars),variable:""}],attributes:(0,x.map)(n.attributes,(function(n){var a;return t.templateSrv.replace((null===(a=n.value)||void 0===a?void 0:a.value)||n,e.scopedVars)})),segments:(0,x.map)(n.segments,(function(n){var a;return t.templateSrv.replace(null===(a=n.value)||void 0===a?void 0:a.value,e.scopedVars)})),display:n.display,refId:n.refId,hide:n.hide,interpolate:n.interpolate||{enable:!1},useLastValue:n.useLastValue||{enable:!1},recordedValues:n.recordedValues||{enable:!1},digitalStates:n.digitalStates||{enable:!1},webid:n.webid,webids:n.webids||[],regex:n.regex||{enable:!1},expression:n.expression||"",summary:n.summary||{types:[]},startTime:e.range.from,endTime:e.range.to,isPiPoint:n.isPiPoint,scopedVars:e.scopedVars};l.expression&&(l.expression=t.templateSrv.replace(l.expression,e.scopedVars)),void 0!==l.summary.types&&(l.summary.types=(0,x.filter)(l.summary.types,(function(e){return null!=e&&""!==e})));var u=(0,x.keys)(e.scopedVars);return t.templateSrv.getVariables().forEach((function(e){if(o.isAllSelected(e.current)&&u.indexOf(e.name)<0){var t=e.options.filter((function(e){return!e.selected}));l.attributes=l.attributes.map((function(n){return t.map((function(t){return e.allValue?n.replace(e.allValue,t.value):n.replace(/{[a-zA-z0-9,-_]+}/gi,t.value)}))})),l.attributes=(0,x.uniq)((0,x.flatten)(l.attributes)),l.elementPathArray=o.getElementPath(l.elementPathArray,t,e.allValue)}else if(Array.isArray(e.current.text)&&u.indexOf(e.name)<0){var n=e.options.filter((function(e){return e.selected})),a=e.current.value.join(",");l.attributes=l.attributes.map((function(e){return n.map((function(t){return e.replace("{".concat(a,"}"),t.value)}))})),l.attributes=(0,x.uniq)((0,x.flatten)(l.attributes)),l.elementPathArray=o.getElementPath(l.elementPathArray,n,"{".concat(a,"}"))}})),l})),e}},{key:"query",value:(r=pe().mark((function e(t){var n,a;return pe().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=this,!((a=this.buildQueryParameters(t)).targets.length<=0)){e.next=6;break}return e.abrupt("return",Promise.resolve({data:[]}));case 6:return e.abrupt("return",Promise.all(n.getStream(a)).then((function(e){var t=[];return(0,x.each)(e,(function(e){(0,x.each)(e,(function(e){return t.push(e)}))})),0===(t=t.filter((function(e){return e.datapoints.length>0}))).length?{data:[]}:{data:t.sort((function(e,t){return+(e.target>t.target)||+(e.target===t.target)-1})).map((function(e){return ae(e)}))}})));case 7:case"end":return e.stop()}}),e,this)})),i=function(){var e=this,t=arguments;return new Promise((function(n,a){var i=r.apply(e,t);function o(e){he(i,n,a,o,l,"next",e)}function l(e){he(i,n,a,o,l,"throw",e)}o(void 0)}))},function(e){return i.apply(this,arguments)})},{key:"testDatasource",value:function(){return this.backendSrv.datasourceRequest({url:this.url+"/",method:"GET"}).then((function(e){if(200===e.status)return{status:"success",message:"Data source is working",title:"Success"};throw new Error("Failed")}))}},{key:"annotationQuery",value:function(e){var t=this;if(!this.afdatabase.webid)return Promise.resolve([]);var n=e.annotation.query.categoryName?this.templateSrv.replace(e.annotation.query.categoryName,e.scopedVars,"glob"):null,a=e.annotation.query.nameFilter?this.templateSrv.replace(e.annotation.query.nameFilter,e.scopedVars,"glob"):null,r=e.annotation.template?e.annotation.template.Name:null,i={name:e.annotation.name,datasource:e.annotation.datasource,enable:e.annotation.enable,iconColor:e.annotation.iconColor,showEndTime:e.annotation.showEndTime,regex:e.annotation.regex,attribute:e.annotation.attribute,categoryName:n,templateName:r,nameFilter:a},o=[];if(i.categoryName&&o.push("categoryName="+i.categoryName),i.nameFilter&&o.push("nameFilter="+i.nameFilter),i.templateName&&o.push("templateName="+i.templateName),!o.length)return Promise.resolve([]);if(o.push("startTime="+e.range.from.toJSON()),o.push("endTime="+e.range.to.toJSON()),i.attribute&&i.attribute.enable){var l=this.piwebapiurl+"/streamsets/{0}/value?selectedFields=Items.WebId%3BItems.Value%3BItems.Name";i.attribute.name&&(l=this.piwebapiurl+"/streamsets/{0}/value?nameFilter="+i.attribute.name+"&selectedFields=Items.WebId%3BItems.Value%3BItems.Name");var u={};return u[1]={Method:"GET",Resource:this.piwebapiurl+"/assetdatabases/"+this.afdatabase.webid+"/eventframes?"+o.join("&")},u[2]={Method:"GET",RequestTemplate:{Resource:l},Parameters:["$.1.Content.Items[*].WebId"],ParentIds:["1"]},this.restBatch(u).then((function(n){var a=n.data[1].Content,r=n.data[2].Content,o=(0,x.map)(a.Items,(function(e,n){return(0,x.curry)(t.eventFrameToAnnotation)(i,!1,e,r.Items[n].Content.Items)}));if(e.annotation.showEndTime){var l=(0,x.map)(a.Items,(function(e,n){return(0,x.curry)(t.eventFrameToAnnotation)(i,!0,e,r.Items[n].Content.Items)}));(0,x.each)(l,(function(e){o.push(e)}))}return o}))}return this.restGet("/assetdatabases/"+this.afdatabase.webid+"/eventframes?"+o.join("&")).then((function(n){var a=(0,x.map)(n.data.Items,(0,x.curry)(t.eventFrameToAnnotation)(i,!1));if(e.annotation.showEndTime){var r=(0,x.map)(n.data.Items,(0,x.curry)(t.eventFrameToAnnotation)(i,!0));(0,x.each)(r,(function(e){a.push(e)}))}return a}))}},{key:"metricQueryTransform",value:function(e){return(0,x.map)(e,(function(e){var t,n;return{text:e.Name,expandable:void 0===e.HasChildren||!0===e.HasChildren||(null!==(t=e.Path)&&void 0!==t?t:"").split("\\").length<=3,HasChildren:e.HasChildren,Items:null!==(n=e.Items)&&void 0!==n?n:[],Path:e.Path,WebId:e.WebId}}))}},{key:"metricFindQuery",value:function(e,t){var n,a,r=this,i=["servers","databases","databaseElements","elements"];return"string"==typeof e&&(e=JSON.parse(e)),t.isPiPoint?e.path=this.templateSrv.replace(e.path,t):(""===e.path?e.type=i[0]:(e.path=this.templateSrv.replace(e.path,t),e.path=e.path.split(";")[0],"attributes"!==e.type&&(e.type=i[Math.max(0,Math.min(e.path.split("\\").length,i.length-1))])),e.path=e.path.replace(/\{([^\\])*\}/gi,(function(e){return e.substring(1,e.length-2).split(",")[0]}))),e.filter=null!==(n=e.filter)&&void 0!==n?n:"*","servers"===e.type?null!==(a=r.afserver)&&void 0!==a&&a.name?r.getAssetServer(r.afserver.name).then((function(e){return[e]})).then(r.metricQueryTransform):r.getAssetServers().then(r.metricQueryTransform):"databases"===e.type?r.getAssetServer(e.path).then((function(e){var t;return r.getDatabases(null!==(t=e.WebId)&&void 0!==t?t:"",{})})).then(r.metricQueryTransform):"databaseElements"===e.type?r.getDatabase(e.path).then((function(e){var t;return r.getDatabaseElements(null!==(t=e.WebId)&&void 0!==t?t:"",{selectedFields:"Items.WebId%3BItems.Name%3BItems.Items%3BItems.Path%3BItems.HasChildren"})})).then(r.metricQueryTransform):"elements"===e.type?r.getElement(e.path).then((function(t){var n;return r.getElements(null!==(n=t.WebId)&&void 0!==n?n:"",{selectedFields:"Items.Description%3BItems.WebId%3BItems.Name%3BItems.Items%3BItems.Path%3BItems.HasChildren",nameFilter:e.filter})})).then(r.metricQueryTransform):"attributes"===e.type?r.getElement(e.path).then((function(t){var n;return r.getAttributes(null!==(n=t.WebId)&&void 0!==n?n:"",{searchFullHierarchy:"true",selectedFields:"Items.Type%3BItems.DefaultUnitsName%3BItems.Description%3BItems.WebId%3BItems.Name%3BItems.Path",nameFilter:e.filter})})).then(r.metricQueryTransform):"dataserver"===e.type?r.getDataServers().then(r.metricQueryTransform):"pipoint"===e.type?r.piPointSearch(e.webId,e.pointName).then(r.metricQueryTransform):Promise.reject("Bad type")}},{key:"getSummaryUrl",value:function(e){return""===e.interval.trim()?"&summaryType="+e.types.map((function(e){var t;return null===(t=e.value)||void 0===t?void 0:t.value})).join("&summaryType=")+"&calculationBasis="+e.basis:"&summaryType="+e.types.map((function(e){var t;return null===(t=e.value)||void 0===t?void 0:t.value})).join("&summaryType=")+"&calculationBasis="+e.basis+"&summaryDuration="+e.interval.trim()}},{key:"parsePiPointValueData",value:function(e,t,n){var a=this,r=[];return Array.isArray(e)?(0,x.each)(e,(function(e){a.piPointValue(n?e.Value:e,t,n,r)})):this.piPointValue(e,t,n,r),r}},{key:"piPointValue",value:function(e,t,n,a){var r=function(e,t,n){var a,r,i=null,o=!1;return!e.Good||"No Data"===e.Value||null!==(a=e.Value)&&void 0!==a&&a.Name&&"No Data"===(null===(r=e.Value)||void 0===r?void 0:r.Name)?"Drop"===t?o=!0:"0"===t?n[0]=0:"Keep"===t||("Null"===t?n[0]=null:"Previous"===t&&null!==i&&(n[0]=i)):i=e.Value,{grafanaDataPoint:n,previousValue:i,drop:o}}(e,t.summary.nodata,this.parsePiPointValue(e,t,n)),i=r.grafanaDataPoint;r.previousValue,r.drop||a.push(i)}},{key:"parsePiPointValue",value:function(e,t,n){var a,r,i,o,l=n||"object"!==me(e.Value)?e.Value:null===(a=e.Value)||void 0===a?void 0:a.Value;return!e.Good||null!==(r=t.digitalStates)&&void 0!==r&&r.enable?[re(l=null!==(i=n||"object"!==me(e.Value)?e.Name:null===(o=e.Value)||void 0===o?void 0:o.Name)&&void 0!==i?i:"")?Number(l):l.trim(),new Date(e.Timestamp).getTime()]:[re(l)?Number(l):l.trim(),new Date(e.Timestamp).getTime()]}},{key:"toTags",value:function(e,t){var n,a=["Path","WebId","Id","ServerTime","ServerVersion"],r=(0,x.omitBy)(e,(function(e,t){return!e||!e.length||a.indexOf(t)>=0}));return r.Element=t?this.piserver.name:ie(null!==(n=e.Path)&&void 0!==n?n:""),Object.keys(r).sort().reduce((function(e,t){var n;return e[(n=t,n.charAt(0).toLocaleLowerCase()+n.slice(1))]=r[t],e}),{})}},{key:"processResults",value:function(e,t,n,a,r){var i=this,o=this,l=t.summary&&t.summary.types&&t.summary.types.length>0;if(t.isPiPoint||t.display||(n=this.newFormatConfig?(a?ie(e.Path):oe(t.elementPathArray,e.Path))+"|"+n:a?n:oe(t.elementPathArray,e.Path)+"|"+n),t.regex&&t.regex.enable&&t.regex.search.length&&t.regex.replace.length&&(n=n.replace(new RegExp(t.regex.search),t.regex.replace)),l){var u=[],s=(0,x.groupBy)(e.Items,(function(e){return e.Type}));return(0,x.forOwn)(s,(function(e,a){u.push({refId:t.refId,target:n+"["+a+"]",meta:{path:r.Path,pathSeparator:"\\"},tags:i.newFormatConfig?o.toTags(r,t.isPiPoint):{},datapoints:o.parsePiPointValueData(e,t,l),path:r.Path})})),u}return[{refId:t.refId,target:n,meta:{path:r.Path,pathSeparator:"\\"},tags:this.newFormatConfig?o.toTags(r,t.isPiPoint):{},datapoints:o.parsePiPointValueData(e.Items||e.Value,t,l),path:r.Path,unit:r.DefaultUnitsName}]}},{key:"isAllSelected",value:function(e){return!!e&&(Array.isArray(e.text)?e.text.indexOf("All")>=0:"All"===e.text)}},{key:"getElementPath",value:function(e,t,n){var a=[];return e.forEach((function(e){if(n&&e.path.indexOf(n)>=0||!n&&e.path.match(/{[a-zA-z0-9,-_]+}/gi)){var r=t.map((function(t){return{path:n?e.path.replace(n,t.value):e.path.replace(/{[a-zA-z0-9,-_]+}/gi,t.value),variable:t.value}}));a=a.concat(r)}})),a.length?(0,x.uniq)((0,x.flatten)(a)):e}},{key:"getStream",value:function(e){var t=this,n=this,a=[];return(0,x.each)(e.targets,(function(r){if(!r.isPiPoint||n.piPointConfig){r.attributes=(0,x.filter)(r.attributes||[],(function(e){return e}));var i="",o=r.summary&&r.summary.types&&r.summary.types.length>0,l=r.interpolate&&r.interpolate.enable,u=r.interpolate.interval?r.interpolate.interval:e.interval,s="?startTime="+e.range.from.toJSON()+"&endTime="+e.range.to.toJSON(),c=r.expression||r.elementPath,m=r.display?t.templateSrv.replace(r.display,e.scopedVars):null;if(r.expression)i+="/calculation",i+=o?"/summary"+s+(l?"&sampleType=Interval&sampleInterval="+u:""):l?"/intervals"+s+"&sampleInterval="+u:"/recorded"+s,i+="&expression="+encodeURIComponent(r.expression.replace(/\${intervalTime}/g,u)),r.attributes.length>0?a.push(n.createBatchGetWebId(r,i,m)):a.push(n.restGetWebId(r.elementPath,!1).then((function(e){return n.restPost(i+e.WebId).then((function(t){return n.processResults(t.data,r,m||c,!1,e)})).catch((function(e){return n.error=e}))})));else{var p;if(i+="/streamsets",o)i+="/summary"+s+"&intervals="+e.maxDataPoints+t.getSummaryUrl(r.summary);else if(l)i+="/interpolated"+s+"&interval="+u;else if(r.recordedValues&&r.recordedValues.enable){var h=r.recordedValues.maxNumber&&!isNaN(r.recordedValues.maxNumber)?r.recordedValues.maxNumber:e.maxDataPoints;i+="/recorded"+s+"&maxCount="+h}else null!==(p=r.useLastValue)&&void 0!==p&&p.enable?i+="/value?time="+e.range.to.toJSON():i+="/plot"+s+"&intervals="+e.maxDataPoints;a.push(n.createBatchGetWebId(r,i,m))}}})),a}},{key:"handleBatchResponse",value:function(e,t,n){var a,r=this,i=t.expression||t.elementPath,o=1===t.elementPathArray.length&&t.elementPath===t.elementPathArray[0].path,l=1,u=[],s=se(t.attributes);try{var c=function(){a.value;var s="Req".concat(l+1e3),c=e.config.data[s].Headers?e.config.data[s].Headers["Asset-Path"]:null,m=e.data[s];if(m.Status>=400)return"continue";var p=void 0;if(c)p=r.webidCache.get(c);else{var h=e.data["Req".concat(l)].Content;p={Path:h.Path,Type:h.Type||h.PointType,DefaultUnitsName:h.DefaultUnitsName||h.EngineeringUnits,Description:h.Description||h.Descriptor,WebId:h.WebId,Name:h.Name},r.webidCache.set(p.Path,p)}t.expression?(0,x.each)(r.processResults(m.Content,t,n||p.Name||i,o,p),(function(e){return u.push(e)})):(0,x.each)(m.Content.Items,(function(e){(0,x.each)(r.processResults(e,t,n||e.Name||i,o,p),(function(e){return u.push(e)}))})),l++};for(s.s();!(a=s.n()).done;)c()}catch(e){s.e(e)}finally{s.f()}return Promise.resolve(u)}},{key:"createQueryPair",value:function(e,t,n,a,r,i,o){var l="",u="";l=e?"/points?selectedFields=Descriptor%3BPointType%3BEngineeringUnits%3BWebId%3BName%3BPath&path="+(u="\\\\"+t+"\\"+n):"/attributes?selectedFields=Type%3BDefaultUnitsName%3BDescription%3BWebId%3BName%3BPath&path="+(u="\\\\"+t+"|"+n);var s=this.webidCache.get(u);s?a["Req".concat(r+1e3)]={Method:"GET",Resource:this.piwebapiurl+le(i,{Name:n},o)+"&webId="+(i?this.piserver.webid:s.WebId),Headers:{"Asset-Path":u}}:(a["Req".concat(r)]={Method:"GET",Resource:this.piwebapiurl+l},a["Req".concat(r+1e3)]={Method:"GET",ParentIds:["Req".concat(r)],Parameters:["$.Req".concat(r,".Content.WebId")],Resource:this.piwebapiurl+le(i,{Name:n},o)+(i?"&webId="+this.piserver.webid:"&webId={0}")})}},{key:"createBatchGetWebId",value:function(e,t,n){var a,r=this,i=1===e.elementPathArray.length&&e.elementPath===e.elementPathArray[0].path,o=e.isPiPoint&&!!e.expression,l={},u=1,s=se(e.attributes);try{var c=function(){var n=a.value;i?(r.createQueryPair(e.isPiPoint,e.elementPath,n,l,u,o,t),u++):e.elementPathArray.forEach((function(a){r.createQueryPair(e.isPiPoint,a.path,n,l,u,o,t),u++}))};for(s.s();!(a=s.n()).done;)c()}catch(e){s.e(e)}finally{s.f()}return this.restBatch(l).then((function(t){return r.handleBatchResponse(t,e,n)}))}},{key:"restGet",value:function(e){return this.backendSrv.datasourceRequest({url:this.url+e,method:"GET",headers:{"Content-Type":"application/json"}}).then((function(e){return e}))}},{key:"restGetWebId",value:function(e,t){var n=this,a=n.webidCache.get(e);if(a)return Promise.resolve(ue({},a));var r="";return r=t?"/points?selectedFields=Descriptor%3BPointType%3BEngineeringUnits%3BWebId%3BName%3BPath&path=\\\\"+e.replace("|","\\"):(e.indexOf("|")>=0?"/attributes?selectedFields=Type%3BDefaultUnitsName%3BDescription%3BWebId%3BName%3BPath&path=\\\\":"/elements?selectedFields=Description%3BWebId%3BName%3BPath&path=\\\\")+e,this.backendSrv.datasourceRequest({url:this.url+r,method:"GET",headers:{"Content-Type":"application/json"}}).then((function(t){var a={Path:e,Type:t.data.Type||t.data.PointType,DefaultUnitsName:t.data.DefaultUnitsName||t.data.EngineeringUnits,Description:t.data.Description||t.data.Descriptor,WebId:t.data.WebId,Name:t.data.Name};return n.webidCache.set(e,a),ue({},a)}))}},{key:"restBatch",value:function(e){return this.backendSrv.datasourceRequest({url:this.url+"/batch",data:e,method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"message/http"}})}},{key:"restPost",value:function(e){return this.backendSrv.datasourceRequest({url:this.url,method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"message/http","X-PIWEBAPI-HTTP-METHOD":"GET","X-PIWEBAPI-RESOURCE-ADDRESS":e}})}},{key:"getDataServers",value:function(){return this.restGet("/dataservers").then((function(e){var t;return null!==(t=e.data.Items)&&void 0!==t?t:[]}))}},{key:"getDataServer",value:function(e){return e?this.restGet("/dataservers?name="+e).then((function(e){return e.data})):Promise.resolve({})}},{key:"getAssetServers",value:function(){return this.restGet("/assetservers").then((function(e){var t;return null!==(t=e.data.Items)&&void 0!==t?t:[]}))}},{key:"getAssetServer",value:function(e){return e?this.restGet("/assetservers?path=\\\\"+e).then((function(e){return e.data})):Promise.resolve({})}},{key:"getDatabase",value:function(e){return e?this.restGet("/assetdatabases?path=\\\\"+e).then((function(e){return e.data})):Promise.resolve({})}},{key:"getDatabases",value:function(e,t){return e?this.restGet("/assetservers/"+e+"/assetdatabases").then((function(e){var t;return null!==(t=e.data.Items)&&void 0!==t?t:[]})):Promise.resolve([])}},{key:"getElement",value:function(e){return e?this.restGet("/elements?path=\\\\"+e).then((function(e){return e.data})):Promise.resolve({})}},{key:"getEventFrameTemplates",value:function(e){return e?this.restGet("/assetdatabases/"+e+"/elementtemplates?selectedFields=Items.InstanceType%3BItems.Name%3BItems.WebId").then((function(e){var t;return(0,x.filter)(null!==(t=e.data.Items)&&void 0!==t?t:[],(function(e){return"EventFrame"===e.InstanceType}))})):Promise.resolve([])}},{key:"getElementTemplates",value:function(e){return e?this.restGet("/assetdatabases/"+e+"/elementtemplates?selectedFields=Items.InstanceType%3BItems.Name%3BItems.WebId").then((function(e){var t;return(0,x.filter)(null!==(t=e.data.Items)&&void 0!==t?t:[],(function(e){return"Element"===e.InstanceType}))})):Promise.resolve([])}},{key:"getAttributes",value:function(e,t){var n="?"+(0,x.map)(t,(function(e,t){return t+"="+e})).join("&");return"?"===n&&(n=""),this.restGet("/elements/"+e+"/attributes"+n).then((function(e){var t;return null!==(t=e.data.Items)&&void 0!==t?t:[]}))}},{key:"getDatabaseElements",value:function(e,t){var n="?"+(0,x.map)(t,(function(e,t){return t+"="+e})).join("&");return"?"===n&&(n=""),this.restGet("/assetdatabases/"+e+"/elements"+n).then((function(e){var t;return null!==(t=e.data.Items)&&void 0!==t?t:[]}))}},{key:"getElements",value:function(e,t){var n="?"+(0,x.map)(t,(function(e,t){return t+"="+e})).join("&");return"?"===n&&(n=""),this.restGet("/elements/"+e+"/elements"+n).then((function(e){var t;return null!==(t=e.data.Items)&&void 0!==t?t:[]}))}},{key:"piPointSearch",value:function(e,t){var n=this.templateSrv.replace(t),a="".concat(n),r=!1;if(n!==t)for(var i,o=/\{(\w|,)+\}/g;null!==(i=o.exec(n));)i.index===o.lastIndex&&o.lastIndex++,i.forEach((function(e,t){0===t&&(n=n.replace(e,e.replace("{","(").replace("}",")").replace(",","|")),a=a.replace(e,"*"),r=!0)}));return this.restGet("/dataservers/"+e+"/points?maxCount=50&nameFilter="+a).then((function(e){var t;return e&&null!==(t=e.data)&&void 0!==t&&t.Items?r?e.data.Items.filter((function(e){var t;return null===(t=e.Name)||void 0===t?void 0:t.match(n)})):e.data.Items:[]}))}},{key:"getWebId",value:function(e){var t=this,n=e.target.indexOf("\\")>=0,a=e.target.indexOf("|")>=0;return n||-1!==e.target.indexOf(".")?n?n&&a?t.restGet("/attributes?path=\\\\"+e.target).then((function(t){return void 0===t.data||200!==t.status?[{WebId:e.target,Name:e.display||e.target}]:(t.data.Name=e.display||t.data.Name,[t.data])})):t.restGet("/elements?path=\\\\"+e.target).then((function(t){return void 0===t.data||200!==t.status?[{WebId:e.target,Name:e.display||e.target}]:(t.data.Name=e.display||t.data.Name,[t.data])})):t.piPointSearch(this.piserver.webid,e.target).then((function(t){return void 0===t||0===t.length?[{WebId:e.target,Name:e.display||e.target}]:t})):Promise.resolve([{WebId:e.target,Name:e.display||e.target}])}}],n&&fe(t.prototype,n),a&&fe(t,a),Object.defineProperty(t,"prototype",{writable:!1}),l}(e.DataSourceApi),Ee=new e.DataSourcePlugin(Se).setConfigEditor(C).setQueryEditor(Z).setAnnotationQueryCtrl(a)})(),u})()));
//# sourceMappingURL=module.js.map