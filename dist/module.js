define(["@grafana/data","react","@grafana/ui","lodash","rxjs","@grafana/runtime"],((e,t,a,n,l,r)=>(()=>{"use strict";var i={781:t=>{t.exports=e},531:e=>{e.exports=r},7:e=>{e.exports=a},241:e=>{e.exports=n},959:e=>{e.exports=t},269:e=>{e.exports=l}},s={};function o(e){var t=s[e];if(void 0!==t)return t.exports;var a=s[e]={exports:{}};return i[e](a,a.exports,o),a.exports}o.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return o.d(t,{a:t}),t},o.d=(e,t)=>{for(var a in t)o.o(t,a)&&!o.o(e,a)&&Object.defineProperty(e,a,{enumerable:!0,get:t[a]})},o.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),o.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var u={};o.r(u),o.d(u,{plugin:()=>z});var h=o(781),m=o(959),c=o.n(m),d=o(7);function p(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function g(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{},n=Object.keys(a);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(a).filter((function(e){return Object.getOwnPropertyDescriptor(a,e).enumerable})))),n.forEach((function(t){p(e,t,a[t])}))}return e}function v(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);a.push.apply(a,n)}return a}(Object(t)).forEach((function(a){Object.defineProperty(e,a,Object.getOwnPropertyDescriptor(t,a))})),e}const{FormField:b}=d.LegacyForms,y=e=>v(g({},e),{jsonData:v(g({},e.jsonData),{url:e.url})});class f extends m.PureComponent{render(){const{options:e}=this.props,t=y(e);return c().createElement("div",null,c().createElement(d.DataSourceHttpSettings,{defaultUrl:"https://server.name/piwebapi",dataSourceConfig:t,onChange:this.onHttpOptionsChange,showAccessOptions:!0}),c().createElement("h3",{className:"page-heading"},"Custom Configuration"),c().createElement("div",{className:"gf-form-group"},c().createElement("div",{className:"gf-form-inline"},c().createElement(d.InlineField,{label:"Enable PI Points in Query",labelWidth:24},c().createElement(d.InlineSwitch,{value:t.jsonData.pipoint,onChange:this.onPiPointChange}))),c().createElement("div",{className:"gf-form-inline"},c().createElement(d.InlineField,{label:"Enable New Data Format",labelWidth:24},c().createElement(d.InlineSwitch,{value:t.jsonData.newFormat,onChange:this.onNewFormatChange}))),c().createElement("div",{className:"gf-form-inline"},c().createElement(d.InlineField,{label:"Enable Unit in Data",labelWidth:24},c().createElement(d.InlineSwitch,{value:t.jsonData.useUnit,onChange:this.onUseUnitChange}))),c().createElement("div",{className:"gf-form-inline"},c().createElement(d.InlineField,{label:"Enable Experimental Features",labelWidth:24},c().createElement(d.InlineSwitch,{value:t.jsonData.useExperimental,onChange:this.onUseExperimentalChange}))),t.jsonData.useExperimental&&c().createElement("div",{className:"gf-form-inline"},c().createElement(d.InlineField,{label:"Enable Steaming Support",labelWidth:24},c().createElement(d.InlineSwitch,{value:t.jsonData.useStreaming,onChange:this.onUseStreamingChange})))),c().createElement("h3",{className:"page-heading"},"PI/AF Connection Details"),c().createElement("div",{className:"gf-form-group"},t.jsonData.pipoint&&c().createElement("div",{className:"gf-form"},c().createElement(b,{label:"PI Server",labelWidth:10,inputWidth:25,onChange:this.onPIServerChange,value:t.jsonData.piserver||"",placeholder:"Default PI Server to use for data requests"})),c().createElement("div",{className:"gf-form"},c().createElement(b,{label:"AF Server",labelWidth:10,inputWidth:25,onChange:this.onAFServerChange,value:t.jsonData.afserver||"",placeholder:"Default AF Server to use for data requests"})),c().createElement("div",{className:"gf-form"},c().createElement(b,{label:"AF Database",labelWidth:10,inputWidth:25,onChange:this.onAFDatabaseChange,value:t.jsonData.afdatabase||"",placeholder:"Default AF Database server for AF queries"}))))}constructor(...e){super(...e),p(this,"onPIServerChange",(e=>{const{onOptionsChange:t,options:a}=this.props,n=v(g({},a.jsonData),{piserver:e.target.value});t(v(g({},a),{jsonData:n}))})),p(this,"onAFServerChange",(e=>{const{onOptionsChange:t,options:a}=this.props,n=v(g({},a.jsonData),{afserver:e.target.value});t(v(g({},a),{jsonData:n}))})),p(this,"onAFDatabaseChange",(e=>{const{onOptionsChange:t,options:a}=this.props,n=v(g({},a.jsonData),{afdatabase:e.target.value});t(v(g({},a),{jsonData:n}))})),p(this,"onHttpOptionsChange",(e=>{const{onOptionsChange:t}=this.props;t(y(e))})),p(this,"onPiPointChange",(e=>{const{onOptionsChange:t,options:a}=this.props,n=v(g({},a.jsonData),{piserver:e.target.checked?a.jsonData.piserver:"",pipoint:e.target.checked});t(v(g({},a),{jsonData:n}))})),p(this,"onNewFormatChange",(e=>{const{onOptionsChange:t,options:a}=this.props,n=v(g({},a.jsonData),{newFormat:e.target.checked});t(v(g({},a),{jsonData:n}))})),p(this,"onUseUnitChange",(e=>{const{onOptionsChange:t,options:a}=this.props,n=v(g({},a.jsonData),{useUnit:e.target.checked});t(v(g({},a),{jsonData:n}))})),p(this,"onUseExperimentalChange",(e=>{const{onOptionsChange:t,options:a}=this.props,n=v(g({},a.jsonData),{useExperimental:e.target.checked,useStreaming:!!e.target.checked&&a.jsonData.useStreaming});t(v(g({},a),{jsonData:n}))})),p(this,"onUseStreamingChange",(e=>{const{onOptionsChange:t,options:a}=this.props,n=v(g({},a.jsonData),{useStreaming:e.target.checked});t(v(g({},a),{jsonData:n}))}))}}var E=o(241);function S(){return S=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e},S.apply(this,arguments)}function P(e){if(null==e)throw new TypeError("Cannot destructure "+e);return e}const C=({label:e,labelWidth:t=12,tooltip:a,children:n})=>c().createElement(c().Fragment,null,c().createElement(d.InlineFormLabel,{width:t,tooltip:a},e),n),I=()=>c().createElement("div",{className:"gf-form gf-form--grow"},c().createElement("div",{className:"gf-form-label gf-form-label--grow"})),w=e=>{var t=S({},P(e));return c().createElement(O,null,c().createElement(C,t))},O=e=>c().createElement("div",{className:"gf-form-inline"},e.children,c().createElement(I,null)),x=e=>{var t=S({},P(e));return c().createElement(D,null,c().createElement(C,t))},D=e=>c().createElement(c().Fragment,null,e.children),F={target:";",attributes:[],segments:[],regex:{enable:!1},summary:{types:[],basis:"EventWeighted",interval:"",nodata:"Null"},expression:"",interpolate:{enable:!1},useLastValue:{enable:!1},recordedValues:{enable:!1},digitalStates:{enable:!1},enableStreaming:{enable:!1},useUnit:{enable:!1},isPiPoint:!1},j=({isRaw:e,onChange:t})=>{const[a,n]=(0,m.useState)(!1);return(0,m.useEffect)((()=>{n(!1)}),[e]),e?c().createElement(c().Fragment,null,c().createElement(d.Button,{"aria-label":"Switch to visual editor",icon:"pen",variant:"secondary",type:"button",onClick:()=>{n(!0)}}),c().createElement(d.ConfirmModal,{isOpen:a,title:"Switch to visual editor mode",body:"Are you sure to switch to visual editor mode? You will lose the changes done in raw query mode.",confirmText:"Yes, switch to editor mode",dismissText:"No, stay in raw query mode",onConfirm:()=>{t(!1)},onDismiss:()=>{n(!1)}})):c().createElement(d.Button,{"aria-label":"Switch to text editor",icon:"pen",variant:"secondary",type:"button",onClick:()=>{t(!0)}})};function A(e){return(0,E.map)(e,(e=>{var t,a;return{text:e.Name,expandable:void 0===e.HasChildren||!0===e.HasChildren||(null!==(t=e.Path)&&void 0!==t?t:"").split("\\").length<=3,HasChildren:e.HasChildren,Items:null!==(a=e.Items)&&void 0!==a?a:[],Path:e.Path,WebId:e.WebId}}))}function W(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function V(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{},n=Object.keys(a);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(a).filter((function(e){return Object.getOwnPropertyDescriptor(a,e).enumerable})))),n.forEach((function(t){W(e,t,a[t])}))}return e}function N(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);a.push.apply(a,n)}return a}(Object(t)).forEach((function(a){Object.defineProperty(e,a,Object.getOwnPropertyDescriptor(t,a))})),e}const T=24,k=250,B="-REMOVE-",q=e=>{var t;return e.value?c().createElement("div",{className:"gf-form-label "+("template"===e.value.type?"query-keyword":"")},null!==(t=e.label)&&void 0!==t?t:"--no label--"):c().createElement("a",{className:"gf-form-label query-part"},c().createElement(d.Icon,{name:"plus"}))};class R extends m.PureComponent{isValueEmpty(e){return!e||!e.value||!e.value.length||e.value===B}calcBasisValueChanged(e){const t=this.props.query,a=t.summary;var n;a&&(a.basis=null===(n=e.value)||void 0===n?void 0:n.value),this.onChange(N(V({},t),{summary:a}))}getCalcBasisSegments(){return(0,E.map)(this.calculationBasis,(e=>({label:e,value:{value:e,expandable:!0}})))}calcNoDataValueChanged(e){const t=this.props.query,a=t.summary;var n;a&&(a.nodata=null===(n=e.value)||void 0===n?void 0:n.value),this.onChange(N(V({},t),{summary:a}))}getNoDataSegments(){return(0,E.map)(this.noDataReplacement,(e=>({label:e,value:{value:e,expandable:!0}})))}onSummaryValueChanged(e,t){const a=this.state.summaries.slice(0);a[t]=e,this.isValueEmpty(e.value)&&a.splice(t,1),this.setState({summaries:a},this.stateCallback)}getSummarySegments(){const e=(0,E.filter)(this.summaryTypes,(e=>-1===this.state.summaries.map((e=>{var t;return null===(t=e.value)||void 0===t?void 0:t.value})).indexOf(e))),t=(0,E.map)(e,(e=>({label:e,value:{value:e,expandable:!0}})));return t.unshift({label:B,value:{value:B}}),t}removeSummary(e){const t=(0,E.filter)(this.state.summaries,(t=>t!==e));this.setState({summaries:t})}onSummaryAction(e){const t=this.state.summaries.slice(0);if(!this.isValueEmpty(e.value)){var a;let n={label:e.label,value:{value:null===(a=e.value)||void 0===a?void 0:a.value,expandable:!0}};t.push(n)}this.setState({summarySegment:{},summaries:t},this.stateCallback)}removeAttribute(e){const t=(0,E.filter)(this.state.attributes,(t=>t!==e));this.attributeChangeValue(t)}onAttributeAction(e){const{query:t}=this.props,a=this.state.attributes.slice(0);if(!this.isValueEmpty(e.value)){var n;let l={label:e.label,value:{value:null===(n=e.value)||void 0===n?void 0:n.value,expandable:!t.isPiPoint}};a.push(l)}this.attributeChangeValue(a)}getSegmentPathUpTo(e,t){const a=e.slice(0,t);return(0,E.reduce)(a,((e,t)=>{var a;return t.value?(null===(a=t.value.value)||void 0===a?void 0:a.startsWith("-Select"))?e:e?e+"\\"+t.value.value:t.value.value:""}),"")}checkAttributeSegments(e,t){var a;const{datasource:n,data:l}=this.props,r=this,i={path:this.getSegmentPathUpTo(t.slice(0),t.length),type:"attributes"};var s;return n.metricFindQuery(i,Object.assign(null!==(s=null==l||null===(a=l.request)||void 0===a?void 0:a.scopedVars)&&void 0!==s?s:{},{isPiPoint:!1})).then((t=>{const a={};(0,E.each)(t,(e=>{a[e.Path.substring(e.Path.indexOf("|")+1)]=e.WebId}));const l=(0,E.filter)(e,(e=>{var t;const l=n.templateSrv.replace(null===(t=e.value)||void 0===t?void 0:t.value);return void 0!==a[l]}));return r.availableAttributes=a,this.attributeChangeValue(l)})).catch((t=>(r.error=t.message||"Failed to issue metric query",this.attributeChangeValue(e))))}checkPiPointSegments(e,t){var a;const{datasource:n,data:l}=this.props,r=this,i={path:e.path,webId:r.getSelectedPIServer(),pointName:e.label,type:"pipoint"};var s;return n.metricFindQuery(i,Object.assign(null!==(s=null==l||null===(a=l.request)||void 0===a?void 0:a.scopedVars)&&void 0!==s?s:{},{isPiPoint:!0})).then((()=>r.attributeChangeValue(t))).catch((e=>(r.error=e.message||"Failed to issue metric query",r.attributeChangeValue([]))))}getSelectedPIServer(){var e;let t="";return this.piServer.forEach((e=>{const a=this.props.query.target.split(";");a.length>=2&&a[0]===e.text&&(t=e.WebId)})),this.piServer.length>0?null===(e=this.piServer[0].value)||void 0===e?void 0:e.webId:t}textEditorChanged(){const{query:e}=this.props,t=e.target.split(";"),a=t.length>0?t[0].split("\\"):[];let n=[],l=[];a.length>1||1===a.length&&""!==a[0]?(t.splice(0,1),(0,E.each)(a,((e,t)=>{n.push({label:e,value:{type:e.match(/\${\w+}/gi)?"template":void 0,value:e,expandable:!0}})})),(0,E.each)(t,(function(e,t){""!==e&&l.push({label:e,value:{value:e,expandable:!1}})})),this.getElementSegments(a.length+1,n).then((e=>{e.length>0&&n.push({label:"Select Element",value:{value:"-Select Element-"}})})).then((()=>{this.updateArray(n,l,this.state.summaries,e.isPiPoint,(()=>{this.onChange(N(V({},e),{query:void 0,rawQuery:!1,attributes:this.state.attributes,segments:this.state.segments}))}))}))):(n=this.checkAfServer(),this.updateArray(n,this.state.attributes,this.state.summaries,e.isPiPoint,(()=>{this.onChange(N(V({},e),{query:void 0,rawQuery:!1,attributes:this.state.attributes,segments:this.state.segments}))})))}render(){const{query:e,onChange:t,onRunQuery:a}=this.props,n=(0,E.defaults)(e,F),{useLastValue:l,useUnit:r,interpolate:i,query:s,rawQuery:o,digitalStates:u,enableStreaming:h,recordedValues:m,expression:p,isPiPoint:g,summary:v,display:b,regex:y}=n;return c().createElement(c().Fragment,null,this.props.datasource.piPointConfig&&c().createElement(d.InlineField,{label:"Is Pi Point?",labelWidth:T},c().createElement(d.InlineSwitch,{value:g,onChange:this.onIsPiPointChange})),!!o&&c().createElement(d.InlineFieldRow,null,c().createElement(d.InlineField,{label:"Raw Query",labelWidth:T,grow:!0},c().createElement(d.Input,{onBlur:this.stateCallback,value:s,onChange:e=>t(N(V({},n),{query:e.target.value})),placeholder:"enter query"})),c().createElement(j,{isRaw:!0,onChange:e=>this.textEditorChanged()})),!o&&c().createElement(c().Fragment,null,c().createElement("div",{className:"gf-form-inline"},c().createElement(x,{label:g?"PI Server":"AF Elements",tooltip:g?"Select PI server.":"Select AF Element."},this.state.segments.map(((e,t)=>c().createElement(d.SegmentAsync,{key:"element-"+t,Component:c().createElement(q,{value:e.value,label:e.label}),onChange:e=>this.onSegmentChange(e,t),loadOptions:e=>this.getElementSegments(t),allowCustomValue:!0,inputMinWidth:200}))),c().createElement(I,null),!g&&c().createElement(j,{isRaw:!1,onChange:e=>{t(N(V({},n),{query:n.target,rawQuery:e}))}}))),c().createElement(w,{label:g?"Pi Points":"Attributes"},this.state.attributes.map(((e,t)=>g?c().createElement(d.SegmentAsync,{key:"attributes-"+t,Component:c().createElement(q,{value:e.value,label:e.label}),disabled:0===this.piServer.length,onChange:e=>this.onPiPointChange(e,t),loadOptions:this.getAttributeSegmentsPI,reloadOptionsOnChange:!0,allowCustomValue:!0,inputMinWidth:k}):c().createElement(d.Segment,{key:"attributes-"+t,Component:c().createElement(q,{value:e.value,label:e.label}),disabled:this.state.segments.length<=2,onChange:e=>this.onAttributeChange(e,t),options:this.getAttributeSegmentsAF(),allowCustomValue:!0,inputMinWidth:k}))),g&&c().createElement(d.SegmentAsync,{Component:c().createElement(q,{value:this.state.attributeSegment.value,label:this.state.attributeSegment.label}),disabled:0===this.piServer.length,onChange:this.onAttributeAction,loadOptions:this.getAttributeSegmentsPI,reloadOptionsOnChange:!0,allowCustomValue:!0,inputMinWidth:k}),!g&&c().createElement(d.Segment,{Component:c().createElement(q,{value:this.state.attributeSegment.value,label:this.state.attributeSegment.label}),disabled:this.state.segments.length<=2,onChange:this.onAttributeAction,options:this.getAttributeSegmentsAF(),allowCustomValue:!0,inputMinWidth:k}))),c().createElement(d.InlineFieldRow,null,c().createElement(d.InlineField,{label:"Calculation",grow:!0,labelWidth:T,tooltip:"Modify all attributes by an equation. Use '.' for current item. Leave Attributes empty if you wish to perform element based calculations."},c().createElement(d.Input,{onBlur:a,value:p,onChange:e=>t(N(V({},n),{expression:e.target.value})),placeholder:"'.'*2"}))),c().createElement(d.InlineFieldRow,null,c().createElement(d.InlineField,{label:"Use Last Value",tooltip:"Fetch only last value from time range",labelWidth:T},c().createElement(d.InlineSwitch,{value:l.enable,onChange:()=>this.onChange(N(V({},n),{useLastValue:N(V({},l),{enable:!l.enable})}))})),c().createElement(d.InlineField,{label:"Digital States",labelWidth:T},c().createElement(d.InlineSwitch,{value:u.enable,onChange:()=>this.onChange(N(V({},n),{digitalStates:N(V({},u),{enable:!u.enable})}))})),c().createElement(d.InlineField,{label:"Replace Bad Data",labelWidth:T,tooltip:"Replacement for bad quality values."},c().createElement(d.Segment,{Component:c().createElement(q,{value:{value:null==v?void 0:v.nodata},label:null==v?void 0:v.nodata}),onChange:this.calcNoDataValueChanged,options:this.getNoDataSegments(),allowCustomValue:!0})),this.props.datasource.useUnitConfig&&c().createElement(d.InlineField,{label:"Use unit from datapoints",tooltip:"Use unit in label from PI tag or PI AF attribute",labelWidth:T},c().createElement(d.InlineSwitch,{value:r.enable,onChange:()=>this.onChange(N(V({},n),{useUnit:N(V({},r),{enable:!r.enable})}))})),this.props.datasource.useStreaming&&c().createElement(d.InlineField,{label:"Enable Streaming",labelWidth:T,tooltip:"Enable streaming data if it is supported for the point type."},c().createElement(d.InlineSwitch,{value:h.enable,onChange:()=>this.onChange(N(V({},n),{enableStreaming:N(V({},h),{enable:!h.enable})}))}))),c().createElement(d.InlineFieldRow,null,!l.enable&&c().createElement(d.InlineField,{label:"Max Recorded Values",labelWidth:T,tooltip:"Maximum number of recorded value to retrive from the data archive, without using interpolation."},c().createElement(d.Input,{onBlur:a,value:m.maxNumber,onChange:e=>t(N(V({},n),{recordedValues:N(V({},m),{maxNumber:parseInt(e.target.value,10)})})),type:"number",placeholder:"1000"})),c().createElement(d.InlineField,{label:"Recorded Values",labelWidth:T},c().createElement(d.InlineSwitch,{value:m.enable,onChange:()=>this.onChange(N(V({},n),{recordedValues:N(V({},m),{enable:!m.enable})}))}))),!l.enable&&c().createElement(d.InlineFieldRow,null,c().createElement(d.InlineField,{label:p?"Interval Period":"Interpolate Period",labelWidth:T,tooltip:"Override time between sampling, e.g. '30s'. Defaults to timespan/chart width."},c().createElement(d.Input,{onBlur:a,value:i.interval,onChange:e=>t(N(V({},n),{interpolate:N(V({},i),{interval:e.target.value})})),placeholder:"30s"})),c().createElement(d.InlineField,{label:p?"Interval Values":"Interpolate",labelWidth:T},c().createElement(d.InlineSwitch,{value:i.enable,onChange:()=>this.onChange(N(V({},n),{interpolate:N(V({},i),{enable:!i.enable})}))}))),!l.enable&&c().createElement(d.InlineFieldRow,null,c().createElement(d.InlineField,{label:"Summary Period",labelWidth:T,tooltip:"Define the summary period, e.g. '30s'."},c().createElement(d.Input,{onBlur:a,value:null==v?void 0:v.interval,onChange:e=>t(N(V({},n),{summary:N(V({},v),{interval:e.target.value})})),placeholder:"30s"})),c().createElement(d.InlineField,{label:"Basis",labelWidth:T,tooltip:"Defines the possible calculation options when performing summary calculations over time-series data."},c().createElement(d.Segment,{Component:c().createElement(q,{value:{value:null==v?void 0:v.basis},label:null==v?void 0:v.basis}),onChange:this.calcBasisValueChanged,options:this.getCalcBasisSegments(),allowCustomValue:!0})),c().createElement(d.InlineField,{label:"Summaries",labelWidth:T,tooltip:"PI Web API summary options."},c().createElement(d.InlineFieldRow,null,this.state.summaries.map(((e,t)=>c().createElement(d.Segment,{key:"summaries-"+t,Component:c().createElement(q,{value:e.value,label:e.label}),onChange:e=>this.onSummaryValueChanged(e,t),options:this.getSummarySegments(),allowCustomValue:!0}))),c().createElement(d.Segment,{Component:c().createElement(q,{value:this.state.summarySegment.value,label:this.state.summarySegment.label}),onChange:this.onSummaryAction,options:this.getSummarySegments(),allowCustomValue:!0})))),c().createElement(d.InlineFieldRow,null,c().createElement(d.InlineField,{label:"Display Name",labelWidth:T,tooltip:"If single attribute, modify display name. Otherwise use regex to modify display name."},c().createElement(d.Input,{onBlur:a,value:b,onChange:e=>t(N(V({},n),{display:e.target.value})),placeholder:"Display"})),c().createElement(d.InlineField,{label:"Enable Regex Replace",labelWidth:T},c().createElement(d.InlineSwitch,{value:y.enable,onChange:()=>{this.onChange(N(V({},n),{regex:N(V({},y),{enable:!y.enable})}))}})),c().createElement(d.InlineField,{label:"Search",labelWidth:16},c().createElement(d.Input,{onBlur:a,value:y.search,onChange:e=>t(N(V({},n),{regex:N(V({},y),{search:e.target.value})})),placeholder:"(.*)"})),c().createElement(d.InlineField,{label:"Replace",labelWidth:16},c().createElement(d.Input,{onBlur:a,value:y.replace,onChange:e=>t(N(V({},n),{regex:N(V({},y),{replace:e.target.value})})),placeholder:"$1"}))))}constructor(e){super(e),W(this,"error",void 0),W(this,"piServer",[]),W(this,"availableAttributes",{}),W(this,"summaryTypes",void 0),W(this,"calculationBasis",void 0),W(this,"noDataReplacement",void 0),W(this,"state",{isPiPoint:!1,segments:[],attributes:[],summaries:[],attributeSegment:{},summarySegment:{},calculationBasisSegment:{},noDataReplacementSegment:{}}),W(this,"segmentChangeValue",(e=>{const t=this.props.query;this.setState({segments:e},(()=>this.onChange(N(V({},t),{segments:e}))))})),W(this,"attributeChangeValue",(e=>{const t=this.props.query;return new Promise((a=>this.setState({attributes:e},(()=>{this.onChange(N(V({},t),{attributes:e})),a()}))))})),W(this,"onPiPointChange",((e,t)=>{let a=this.state.attributes.slice(0);e.label===B?(0,E.remove)(a,((e,a)=>a===t)):a[t]=e,this.checkPiPointSegments(e,a)})),W(this,"onAttributeChange",((e,t)=>{var a;let n=this.state.attributes.slice(0);n[t].label!==(null===(a=e.value)||void 0===a?void 0:a.value)&&(n[t]=e,this.checkAttributeSegments(n,this.state.segments))})),W(this,"onSegmentChange",((e,t)=>{var a;const{query:n}=this.props;let l=this.state.segments.slice(0);l[t].label!==(null===(a=e.value)||void 0===a?void 0:a.value)&&this.setState({attributes:[]},(()=>e.label===B?(l=(0,E.slice)(l,0,t),void this.checkAttributeSegments([],l).then((()=>{var e;0===l.length?l.push({label:""}):(null===(e=l[l.length-1].value)||void 0===e?void 0:e.expandable)&&l.push({label:"Select Element",value:{value:"-Select Element-"}}),n.isPiPoint&&(this.piServer=[]),this.segmentChangeValue(l)}))):(l[t]=e,n.isPiPoint?(this.piServer.push(e),void this.segmentChangeValue(l)):(t<l.length-1&&(l=(0,E.slice)(l,0,t+1)),void this.checkAttributeSegments([],l).then((()=>{var t,a;return"template"===(null===(t=e.value)||void 0===t?void 0:t.type)?this.getElementSegments(l.length+1,l).then((e=>(e.length>0&&l.push({label:"Select Element",value:{value:"-Select Element-"}}),this.segmentChangeValue(l),l))):((null===(a=e.value)||void 0===a?void 0:a.expandable)&&l.push({label:"Select Element",value:{value:"-Select Element-"}}),new Promise((e=>{this.segmentChangeValue(l),e(l)})))}))))))})),W(this,"getElementSegments",((e,t)=>{var a;const{datasource:n,query:l,data:r}=this.props,i=this,s=l.isPiPoint?{type:"dataserver"}:{path:this.getSegmentPathUpTo(null!=t?t:this.state.segments.slice(0),e),afServerWebId:this.state.segments.length>0&&this.state.segments[0].value?this.state.segments[0].value.webId:void 0};if(!l.isPiPoint){var o,u,h;if((null===(o=n.afserver)||void 0===o?void 0:o.name)&&0===e)return Promise.resolve([{label:n.afserver.name,value:{value:n.afserver.name,expandable:!0}}]);if((null===(u=n.afserver)||void 0===u?void 0:u.name)&&(null===(h=n.afdatabase)||void 0===h?void 0:h.name)&&1===e)return Promise.resolve([{label:n.afdatabase.name,value:{value:n.afdatabase.name,expandable:!0}}])}var m;return n.metricFindQuery(s,Object.assign(null!==(m=null==r||null===(a=r.request)||void 0===a?void 0:a.scopedVars)&&void 0!==m?m:{},{isPiPoint:l.isPiPoint})).then((e=>{const t=(0,E.map)(e,(e=>({label:e.text,value:{webId:e.WebId,value:e.text,expandable:!l.isPiPoint&&e.expandable}})));if(0===t.length)return t;const a=n.templateSrv.getVariables();return(0,E.each)(a,(e=>{let a={label:"${"+e.name+"}",value:{type:"template",value:"${"+e.name+"}",expandable:!l.isPiPoint}};t.unshift(a)})),t.unshift({label:B,value:{value:B}}),t})).catch((e=>(i.error=e.message||"Failed to issue metric query",[])))})),W(this,"getAttributeSegmentsPI",(e=>{var t;const{datasource:a,query:n,data:l}=this.props,r=this,i={path:"",webId:this.getSelectedPIServer(),pointName:(null!=e?e:"")+"*",type:"pipoint"};let s=[];var o;return a.metricFindQuery(i,Object.assign(null!==(o=null==l||null===(t=l.request)||void 0===t?void 0:t.scopedVars)&&void 0!==o?o:{},{isPiPoint:n.isPiPoint})).then((t=>{s=(0,E.map)(t,(e=>({path:e.Path,label:e.text,value:{value:e.text,expandable:!1}}))),e&&e.length>0&&s.unshift({label:e,value:{value:e,expandable:!1}});const l=a.templateSrv.getVariables();return(0,E.each)(l,(e=>{let t={label:"${"+e.name+"}",value:{type:"template",value:"${"+e.name+"}",expandable:!n.isPiPoint}};s.unshift(t)})),s.unshift({label:B,value:{value:B}}),s})).catch((e=>(r.error=e.message||"Failed to issue metric query",s)))})),W(this,"getAttributeSegmentsAF",(e=>{let t=[];return t.push({label:B,value:{value:B}}),(0,E.forOwn)(this.availableAttributes,((e,a)=>{let n={label:a,value:{value:a,expandable:!0}};t.push(n)})),t})),W(this,"buildFromTarget",((e,t,a)=>{const n=e.target.split(";"),l=n.length>0?n[0].split("\\"):[];return l.length>1||1===l.length&&""!==l[0]?(n.splice(0,1),(0,E.each)(l,((e,a)=>{t.push({label:e,value:{type:e.match(/\${\w+}/gi)?"template":void 0,value:e,expandable:!0}})})),(0,E.each)(n,((e,t)=>{""!==e&&a.push({label:e,value:{value:e,expandable:!1}})})),this.getElementSegments(l.length+1,t).then((e=>(e.length>0&&t.push({label:"Select Element",value:{value:"-Select Element-"}}),t)))):Promise.resolve(t)})),W(this,"checkAfServer",(()=>{var e;const{datasource:t}=this.props,a=[];var n;return(null===(e=t.afserver)||void 0===e?void 0:e.name)?(a.push({label:t.afserver.name,value:{value:t.afserver.name,expandable:!0}}),(null===(n=t.afdatabase)||void 0===n?void 0:n.name)&&a.push({label:t.afdatabase.name,value:{value:t.afdatabase.name,expandable:!0}}),a.push({label:"Select Element",value:{value:"-Select Element-"}})):a.push({label:""}),a})),W(this,"updateArray",((e,t,a,n,l)=>{this.setState({segments:e,attributes:t,summaries:a,isPiPoint:n},(()=>{n||this.checkAttributeSegments(t,this.state.segments).then((()=>{l&&l()}))}))})),W(this,"scopedVarsDone",!1),W(this,"componentDidMount",(()=>{this.initialLoad(!1)})),W(this,"componentDidUpdate",(()=>{var e,t,a;const{query:n}=this.props;"Done"===(null===(e=this.props.data)||void 0===e?void 0:e.state)&&(null===(a=this.props.data)||void 0===a||null===(t=a.request)||void 0===t?void 0:t.scopedVars)&&!this.scopedVarsDone&&(this.scopedVarsDone=!0,this.initialLoad(!n.isPiPoint))})),W(this,"initialLoad",(e=>{const{query:t}=this.props,a=(0,E.defaults)(t,F),{segments:n,attributes:l,summary:r,isPiPoint:i}=a;var s;let o=e?[]:null!==(s=null==n?void 0:n.slice(0))&&void 0!==s?s:[];var u;let h=e?[]:null!==(u=null==l?void 0:l.slice(0))&&void 0!==u?u:[];var m;let c=null!==(m=null==r?void 0:r.types)&&void 0!==m?m:[];if(i||0!==o.length)i&&o.length>0&&(this.piServer=o);else{if(t.target&&t.target.length>0&&";"!==t.target)return h=[],void this.buildFromTarget(t,o,h).then((e=>{this.updateArray(e,h,c,!1)})).catch((e=>console.error(e)));o=this.checkAfServer()}this.updateArray(o,h,c,!!i,(()=>{this.onChange(t)}))})),W(this,"onChange",(e=>{const{onChange:t,onRunQuery:a}=this.props;var n,l;if(e.rawQuery){if(e.target=null!==(n=e.query)&&void 0!==n?n:"",e.query){const{attributes:t,elementPath:a}=function(e){const t=e.split(";"),a=t[0].split("\\");t.splice(0,1);let n=[];if(a.length>1||1===a.length&&""!==a[0]){const e=a.join("\\");return(0,E.each)(t,(function(e,t){""!==e&&n.push({label:e,value:{value:e,expandable:!1}})})),{attributes:n,elementPath:e}}return{attributes:n,elementPath:null}}(e.target);e.attributes=t,e.elementPath=a}}else e.elementPath=this.getSegmentPathUpTo(this.state.segments,this.state.segments.length),e.target=e.elementPath+";"+(0,E.join)(null===(l=e.attributes)||void 0===l?void 0:l.map((e=>{var t;return null===(t=e.value)||void 0===t?void 0:t.value})),";");const r=e.summary;r&&(r.types=this.state.summaries),t(N(V({},e),{summary:r})),this.isValidQuery(e)&&a()})),W(this,"isValidQuery",(e=>{if(e.target&&e.target.length>0&&";"!==e.target){e.target=e.target.trim();const t=e.target.split(";",2);return 2===t.length&&t[0].length>0&&t[1].length>0}return!1})),W(this,"stateCallback",(()=>{const e=this.props.query;this.onChange(e)})),W(this,"onIsPiPointChange",(e=>{const{query:t}=this.props,a=!t.isPiPoint;this.setState({segments:a?[{label:""}]:this.checkAfServer(),attributes:[],isPiPoint:a},(()=>{this.onChange(N(V({},t),{expression:"",attributes:this.state.attributes,segments:this.state.segments,isPiPoint:a}))}))})),this.onSegmentChange=this.onSegmentChange.bind(this),this.calcBasisValueChanged=this.calcBasisValueChanged.bind(this),this.calcNoDataValueChanged=this.calcNoDataValueChanged.bind(this),this.onSummaryAction=this.onSummaryAction.bind(this),this.onSummaryValueChanged=this.onSummaryValueChanged.bind(this),this.onAttributeAction=this.onAttributeAction.bind(this),this.onAttributeChange=this.onAttributeChange.bind(this),this.summaryTypes=["Total","Average","Minimum","Maximum","Range","StdDev","PopulationStdDev","Count","PercentGood","All","AllForNonNumeric"],this.calculationBasis=["TimeWeighted","EventWeighted","TimeWeightedContinuous","TimeWeightedDiscrete","EventWeightedExcludeMostRecentEvent","EventWeightedExcludeEarliestEvent","EventWeightedIncludeBothEnds"],this.noDataReplacement=["Null","Drop","Previous","0","Keep"]}}var U=o(269),M=o(531);function Q(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function G(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{},n=Object.keys(a);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(a).filter((function(e){return Object.getOwnPropertyDescriptor(a,e).enumerable})))),n.forEach((function(t){Q(e,t,a[t])}))}return e}function L(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);a.push.apply(a,n)}return a}(Object(t)).forEach((function(a){Object.defineProperty(e,a,Object.getOwnPropertyDescriptor(t,a))})),e}const $=30,H=(0,m.memo)((function(e){var t,a,n,l,r,i;const{query:s,datasource:o,annotation:u,onChange:h,onRunQuery:p}=e,[g,v]=(0,m.useState)("");var b;const[y,f]=(0,m.useState)(null!==(b=null==u||null===(t=u.target)||void 0===t?void 0:t.database)&&void 0!==b?b:{});if(void 0===u)return null;const E=e=>{const t=u.target;if(t&&t[e])return{label:t[e].Name,value:t[e]}};var S;return o.getAssetServer(o.afserver.name).then((e=>{v(e.WebId)})),c().createElement(c().Fragment,null,c().createElement("div",{className:"gf-form-group"},c().createElement(d.InlineFieldRow,null,c().createElement(d.InlineField,{label:"Database",labelWidth:$,grow:!0},c().createElement(d.AsyncSelect,{key:null!=g?g:"database-key",loadOptions:()=>o.getDatabases(g).then((e=>e.map((e=>({label:e.Name,value:e}))))),loadingMessage:"Loading",value:E("database"),onChange:e=>{f(e.value),h(L(G({},s),{database:e.value,template:void 0}))},defaultOptions:!0})),c().createElement(d.InlineField,{label:"Event Frames",labelWidth:$,grow:!0},c().createElement(d.AsyncSelect,{key:null!==(S=null==y?void 0:y.WebId)&&void 0!==S?S:"default-template-key",loadOptions:()=>o.getEventFrameTemplates(null==y?void 0:y.WebId).then((e=>e.map((e=>({label:e.Name,value:e}))))),loadingMessage:"Loading",value:E("template"),onChange:e=>h(L(G({},s),{template:e.value})),defaultOptions:!0})),c().createElement(d.InlineField,{label:"Show Start and End Time",labelWidth:$,grow:!0},c().createElement(d.InlineSwitch,{value:!!s.showEndTime,onChange:e=>h(L(G({},s),{showEndTime:e.currentTarget.checked}))}))),c().createElement(d.InlineFieldRow,null,c().createElement(d.InlineField,{label:"Category name",labelWidth:$,grow:!0},c().createElement(d.Input,{type:"text",value:s.categoryName,onBlur:e=>p(),onChange:e=>h(L(G({},s),{categoryName:e.currentTarget.value})),placeholder:"Enter category name"})),c().createElement(d.InlineField,{label:"Name Filter",labelWidth:$,grow:!0},c().createElement(d.Input,{type:"text",value:s.nameFilter,onBlur:e=>p(),onChange:e=>h(L(G({},s),{nameFilter:e.currentTarget.value})),placeholder:"Enter name filter"}))),c().createElement(d.InlineFieldRow,null,c().createElement(d.InlineField,{label:"Enable Name Regex Replacement",labelWidth:$,grow:!1},c().createElement(d.InlineSwitch,{value:null===(a=s.regex)||void 0===a?void 0:a.enable,onChange:e=>h(L(G({},s),{regex:L(G({},s.regex),{enable:e.currentTarget.checked})}))})),c().createElement(d.InlineField,{label:"Name Filter",labelWidth:20,grow:!1},c().createElement(d.Input,{type:"text",value:null===(n=s.regex)||void 0===n?void 0:n.search,onBlur:e=>p(),onChange:e=>h(L(G({},s),{regex:L(G({},s.regex),{search:e.currentTarget.value})})),placeholder:"(.*)",width:50})),c().createElement(d.InlineField,{label:"Replace",labelWidth:20,grow:!0},c().createElement(d.Input,{type:"text",value:null==s||null===(l=s.regex)||void 0===l?void 0:l.replace,onBlur:e=>p(),onChange:e=>h(L(G({},s),{regex:L(G({},s.regex),{replace:e.currentTarget.value})})),placeholder:"$1"}))),c().createElement(d.InlineFieldRow,null,c().createElement(d.InlineField,{label:"Enable Attribute Usage",labelWidth:$,grow:!1},c().createElement(d.InlineSwitch,{value:null===(r=s.attribute)||void 0===r?void 0:r.enable,onChange:e=>h(L(G({},s),{attribute:L(G({},s.attribute),{enable:e.currentTarget.checked})}))})),c().createElement(d.InlineField,{label:"Attribute Name",labelWidth:$,grow:!0},c().createElement(d.Input,{type:"text",value:null===(i=s.attribute)||void 0===i?void 0:i.name,onBlur:e=>p(),onChange:e=>h(L(G({},s),{attribute:L(G({},s.attribute),{name:e.currentTarget.value})})),placeholder:"Enter name"})))))}));function _(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function Y(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{},n=Object.keys(a);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(a).filter((function(e){return Object.getOwnPropertyDescriptor(a,e).enumerable})))),n.forEach((function(t){_(e,t,a[t])}))}return e}function J(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);a.push.apply(a,n)}return a}(Object(t)).forEach((function(a){Object.defineProperty(e,a,Object.getOwnPropertyDescriptor(t,a))})),e}class K extends M.DataSourceWithBackend{applyTemplateVariables(e,t){return J(Y({},e),{target:e.target?this.templateSrv.replace(e.target,t):""})}query(e){if(1===e.targets.length&&e.targets[0].isAnnotation)return super.query(e);const t=this.buildQueryParameters(e);return t.targets.length<=0?(0,U.of)({data:[]}):super.query(t)}metricFindQuery(e,t){const a=this,n=["servers","databases","databaseElements","elements"];var l,r,i;return"string"==typeof e&&(e=JSON.parse(e)),t.isPiPoint?e.path=this.templateSrv.replace(e.path,t):(""===e.path?e.type=n[0]:(e.path=this.templateSrv.replace(e.path,t),e.path=e.path.split(";")[0],"attributes"!==e.type&&(e.type=n[Math.max(0,Math.min(e.path.split("\\").length,n.length-1))])),e.path=e.path.replace(/\{([^\\])*\}/gi,(e=>e.substring(1,e.length-2).split(",")[0]))),e.filter=null!==(l=e.filter)&&void 0!==l?l:"*",e.max=null!==(r=e.max)&&void 0!==r?r:1e4,"servers"===e.type?(null===(i=a.afserver)||void 0===i?void 0:i.name)?a.getAssetServer(a.afserver.name).then((e=>[e])).then(A):a.getAssetServers().then(A):"databases"===e.type&&e.afServerWebId?a.getDatabases(e.afServerWebId,{}).then(A):"databases"===e.type?a.getAssetServer(e.path).then((e=>{var t;return a.getDatabases(null!==(t=e.WebId)&&void 0!==t?t:"",{})})).then(A):"databaseElements"===e.type?a.getDatabase(e.path).then((e=>{var t;return a.getDatabaseElements(null!==(t=e.WebId)&&void 0!==t?t:"",{selectedFields:"Items.WebId%3BItems.Name%3BItems.Items%3BItems.Path%3BItems.HasChildren"})})).then(A):"elements"===e.type?a.getElement(e.path).then((t=>{var n;return a.getElements(null!==(n=t.WebId)&&void 0!==n?n:"",{selectedFields:"Items.Description%3BItems.WebId%3BItems.Name%3BItems.Items%3BItems.Path%3BItems.HasChildren",nameFilter:e.filter})})).then(A):"attributes"===e.type?a.getElement(e.path).then((t=>{var n;return a.getAttributes(null!==(n=t.WebId)&&void 0!==n?n:"",{searchFullHierarchy:"true",selectedFields:"Items.Type%3BItems.DefaultUnitsName%3BItems.Description%3BItems.WebId%3BItems.Name%3BItems.Path",nameFilter:e.filter,maxCount:e.max})})).then(A):"dataserver"===e.type?a.getDataServers().then(A):"pipoint"===e.type?a.piPointSearch(e.webId,e.pointName).then(A):Promise.reject("Bad type")}buildQueryParameters(e){return e.targets=(0,E.filter)(e.targets,(e=>{var t;return!(!e||!e.target||0===(null===(t=e.attributes)||void 0===t?void 0:t.length)||";"===e.target||e.hide||e.target.startsWith("Select AF"))})),e.maxDataPoints&&(e.maxDataPoints=e.maxDataPoints>3e4?3e4:e.maxDataPoints),e.targets=(0,E.map)(e.targets,(t=>{var a;const n={enableStreaming:t.enableStreaming,target:this.templateSrv.replace(t.target,e.scopedVars),elementPath:this.templateSrv.replace(t.elementPath,e.scopedVars),attributes:(0,E.map)(t.attributes,(t=>(t.value&&this.templateSrv.replace(t.value.value,e.scopedVars),t))),segments:(0,E.map)(t.segments,(t=>(t.value&&this.templateSrv.replace(t.value.value,e.scopedVars),t))),isAnnotation:!!t.isAnnotation,display:t.display?this.templateSrv.replace(t.display,e.scopedVars):void 0,refId:t.refId,hide:t.hide,interpolate:t.interpolate?J(Y({},t.interpolate),{interval:this.templateSrv.replace(t.interpolate.interval,e.scopedVars)}):{enable:!1},useLastValue:t.useLastValue||{enable:!1},useUnit:t.useUnit||{enable:!1},recordedValues:t.recordedValues?J(Y({},t.recordedValues),{interval:this.templateSrv.replace(t.recordedValues.maxNumber,e.scopedVars)}):{enable:!1},digitalStates:t.digitalStates||{enable:!1},webid:null!==(a=t.webid)&&void 0!==a?a:"",regex:t.regex||{enable:!1},expression:t.expression||"",summary:t.summary||{types:[]},startTime:e.range.from,endTime:e.range.to,isPiPoint:!!t.isPiPoint,scopedVars:e.scopedVars};return n.expression&&(n.expression=this.templateSrv.replace(n.expression,e.scopedVars)),void 0!==n.summary.types&&(n.summary.types=(0,E.filter)(n.summary.types,(e=>null!=e&&""!==e))),n})),e}eventFrameToAnnotation(e,t){const a=e.target,n=[],l=Intl.DateTimeFormat().resolvedOptions().locale;return t.forEach((e=>{let t=this.transformDataFrameToMap(e);for(let e=0;e<t.time.length;e++){let r=t.title[e];a.regex&&a.regex.enable&&(r=r.replace(new RegExp(a.regex.search),a.regex.replace)),t.timeEnd[e]<0&&(t.timeEnd[e]=null);let i="Tag: "+r;a.attribute&&a.attribute.enable&&(i+=t.attributeText[e]),i+="<br />Start: "+new Date(t.time[e]).toLocaleString(l)+"<br />End: ",t.timeEnd[e]?i+=new Date(t.timeEnd[e]).toLocaleString(l):i+="Eventframe is open";const s={time:t.time[e],timeEnd:a.showEndTime?t.timeEnd[e]:void 0,title:r,id:t.id[e],text:i,tags:["OSISoft PI"]};n.push(s)}})),n}transformDataFrameToMap(e){const t={};return e.fields.forEach((e=>{t[e.name]=e.values.toArray()})),t}restGet(e){const t=this.backendSrv.fetch({url:`/api/datasources/${this.id}/resources${e}`,method:"GET",headers:{"Content-Type":"application/json"}});return(0,U.firstValueFrom)(t).then((e=>e))}getDataServers(){return this.restGet("/dataservers").then((e=>{var t;return null!==(t=e.data.Items)&&void 0!==t?t:[]}))}getDataServer(e){return e?this.restGet("/dataservers?name="+e).then((e=>e.data)):Promise.resolve({})}getAssetServers(){return this.restGet("/assetservers").then((e=>{var t;return null!==(t=e.data.Items)&&void 0!==t?t:[]}))}getAssetServer(e){return e?this.restGet("/assetservers?path=\\\\"+e).then((e=>e.data)):Promise.resolve({})}getDatabase(e){return e?this.restGet("/assetdatabases?path=\\\\"+e).then((e=>e.data)):Promise.resolve({})}getDatabases(e,t){return e?this.restGet("/assetservers/"+e+"/assetdatabases").then((e=>{var t;return null!==(t=e.data.Items)&&void 0!==t?t:[]})):Promise.resolve([])}getElement(e){return e?this.restGet("/elements?path=\\\\"+e).then((e=>e.data)):Promise.resolve({})}getEventFrameTemplates(e){return e?this.restGet("/assetdatabases/"+e+"/elementtemplates?selectedFields=Items.InstanceType%3BItems.Name%3BItems.WebId").then((e=>{var t;return(0,E.filter)(null!==(t=e.data.Items)&&void 0!==t?t:[],(e=>"EventFrame"===e.InstanceType))})):Promise.resolve([])}getElementTemplates(e){return e?this.restGet("/assetdatabases/"+e+"/elementtemplates?selectedFields=Items.InstanceType%3BItems.Name%3BItems.WebId").then((e=>{var t;return(0,E.filter)(null!==(t=e.data.Items)&&void 0!==t?t:[],(e=>"Element"===e.InstanceType))})):Promise.resolve([])}getAttributes(e,t){let a="?"+(0,E.map)(t,((e,t)=>t+"="+e)).join("&");return"?"===a&&(a=""),this.restGet("/elements/"+e+"/attributes"+a).then((e=>{var t;return null!==(t=e.data.Items)&&void 0!==t?t:[]}))}getDatabaseElements(e,t){let a="?"+(0,E.map)(t,((e,t)=>t+"="+e)).join("&");return"?"===a&&(a=""),this.restGet("/assetdatabases/"+e+"/elements"+a).then((e=>{var t;return null!==(t=e.data.Items)&&void 0!==t?t:[]}))}getElements(e,t){let a="?"+(0,E.map)(t,((e,t)=>t+"="+e)).join("&");return"?"===a&&(a=""),this.restGet("/elements/"+e+"/elements"+a).then((e=>{var t;return null!==(t=e.data.Items)&&void 0!==t?t:[]}))}piPointSearch(e,t){let a=this.templateSrv.replace(t),n=`${a}`,l=!1;if(a!==t){const e=RegExp("\\{(\\w|,)+\\}","gs");let t;for(;null!==(t=e.exec(a));)t.index===e.lastIndex&&e.lastIndex++,t.forEach(((e,t)=>{0===t&&(a=a.replace(e,e.replace("{","(").replace("}",")").replace(",","|")),n=n.replace(e,"*"),l=!0)}))}return this.restGet("/dataservers/"+e+"/points?maxCount=50&nameFilter="+n).then((e=>{var t;return e&&(null===(t=e.data)||void 0===t?void 0:t.Items)?l?e.data.Items.filter((e=>{var t;return null===(t=e.Name)||void 0===t?void 0:t.match(a)})):e.data.Items:[]}))}constructor(e,t=(0,M.getTemplateSrv)(),a=(0,M.getBackendSrv)()){super(e),_(this,"templateSrv",void 0),_(this,"backendSrv",void 0),_(this,"piserver",void 0),_(this,"afserver",void 0),_(this,"afdatabase",void 0),_(this,"piPointConfig",void 0),_(this,"newFormatConfig",void 0),_(this,"useUnitConfig",void 0),_(this,"useExperimental",void 0),_(this,"useStreaming",void 0),this.templateSrv=t,this.backendSrv=a,this.piserver={name:(e.jsonData||{}).piserver,webid:void 0},this.afserver={name:(e.jsonData||{}).afserver,webid:void 0},this.afdatabase={name:(e.jsonData||{}).afdatabase,webid:void 0},this.piPointConfig=e.jsonData.pipoint||!1,this.newFormatConfig=e.jsonData.newFormat||!1,this.useUnitConfig=e.jsonData.useUnit||!1,this.useExperimental=e.jsonData.useExperimental||!1,this.useStreaming=e.jsonData.useStreaming||!1,this.annotations={QueryEditor:H,prepareQuery:e=>(e.target&&(e.target.queryType="Annotation",e.target.isAnnotation=!0),e.target),processEvents:(e,t)=>(0,U.of)(this.eventFrameToAnnotation(e,t))},Promise.all([this.getDataServer(this.piserver.name).then((e=>this.piserver.webid=e.WebId)),this.getAssetServer(this.afserver.name).then((e=>this.afserver.webid=e.WebId)),this.getDatabase(this.afserver.name&&this.afdatabase.name?this.afserver.name+"\\"+this.afdatabase.name:void 0).then((e=>this.afdatabase.webid=e.WebId))])}}const z=new h.DataSourcePlugin(K).setQueryEditor(R).setConfigEditor(f);return u})()));
//# sourceMappingURL=module.js.map