define(["react","lodash","@grafana/ui","@grafana/data","@grafana/runtime"],(function(e,t,a,n,r){return function(e){var t={};function a(n){if(t[n])return t[n].exports;var r=t[n]={i:n,l:!1,exports:{}};return e[n].call(r.exports,r,r.exports,a),r.l=!0,r.exports}return a.m=e,a.c=t,a.d=function(e,t,n){a.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},a.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},a.t=function(e,t){if(1&t&&(e=a(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(a.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)a.d(n,r,function(t){return e[t]}.bind(null,r));return n},a.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return a.d(t,"a",t),t},a.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},a.p="/",a(a.s=5)}([function(t,a){t.exports=e},function(e,a){e.exports=t},function(e,t){e.exports=a},function(e,t){e.exports=n},function(e,t){e.exports=r},function(e,t,a){"use strict";a.r(t);var n=a(3),r=function(){function e(){this.annotation.query=this.annotation.query||{},this.annotation.databases=this.annotation.databases||[],this.annotation.templates=this.annotation.templates||[],this.annotation.regex=this.annotation.regex||{},this.annotation.attribute=this.annotation.attribute||{},this.annotation.showEndTime=this.annotation.showEndTime||!1,this.getDatabases()}return e.prototype.templateChanged=function(){},e.prototype.databaseChanged=function(){this.getEventFrames()},e.prototype.getDatabases=function(){var e=this;return e.datasource.getDatabases(e.datasource.afserver.webid).then((function(t){e.annotation.databases=t}))},e.prototype.getEventFrames=function(){var e=this;return e.datasource.getEventFrameTemplates(this.annotation.database.WebId).then((function(t){e.annotation.templates=t}))},e.templateUrl="partials/annotations.editor.html",e}(),s=function(e,t){return(s=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var a in t)Object.prototype.hasOwnProperty.call(t,a)&&(e[a]=t[a])})(e,t)};function i(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function a(){this.constructor=e}s(e,t),e.prototype=null===t?Object.create(t):(a.prototype=t.prototype,new a)}var o=function(){return(o=Object.assign||function(e){for(var t,a=1,n=arguments.length;a<n;a++)for(var r in t=arguments[a])Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e}).apply(this,arguments)};function l(e,t,a,n){return new(a||(a=Promise))((function(r,s){function i(e){try{l(n.next(e))}catch(e){s(e)}}function o(e){try{l(n.throw(e))}catch(e){s(e)}}function l(e){var t;e.done?r(e.value):(t=e.value,t instanceof a?t:new a((function(e){e(t)}))).then(i,o)}l((n=n.apply(e,t||[])).next())}))}function u(e,t){var a,n,r,s,i={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return s={next:o(0),throw:o(1),return:o(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function o(s){return function(o){return function(s){if(a)throw new TypeError("Generator is already executing.");for(;i;)try{if(a=1,n&&(r=2&s[0]?n.return:s[0]?n.throw||((r=n.return)&&r.call(n),0):n.next)&&!(r=r.call(n,s[1])).done)return r;switch(n=0,r&&(s=[2&s[0],r.value]),s[0]){case 0:case 1:r=s;break;case 4:return i.label++,{value:s[1],done:!1};case 5:i.label++,n=s[1],s=[0];continue;case 7:s=i.ops.pop(),i.trys.pop();continue;default:if(!(r=i.trys,(r=r.length>0&&r[r.length-1])||6!==s[0]&&2!==s[0])){i=0;continue}if(3===s[0]&&(!r||s[1]>r[0]&&s[1]<r[3])){i.label=s[1];break}if(6===s[0]&&i.label<r[1]){i.label=r[1],r=s;break}if(r&&i.label<r[2]){i.label=r[2],i.ops.push(s);break}r[2]&&i.ops.pop(),i.trys.pop();continue}s=t.call(e,i)}catch(e){s=[6,e],n=0}finally{a=r=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,o])}}}Object.create;Object.create;var c=a(0),m=a.n(c),p=a(2),d=p.LegacyForms.FormField,h=function(e){return o(o({},e),{jsonData:o(o({},e.jsonData),{url:e.url})})},f=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.onPIServerChange=function(e){var a=t.props,n=a.onOptionsChange,r=a.options,s=o(o({},r.jsonData),{piserver:e.target.value});n(o(o({},r),{jsonData:s}))},t.onAFServerChange=function(e){var a=t.props,n=a.onOptionsChange,r=a.options,s=o(o({},r.jsonData),{afserver:e.target.value});n(o(o({},r),{jsonData:s}))},t.onAFDatabaseChange=function(e){var a=t.props,n=a.onOptionsChange,r=a.options,s=o(o({},r.jsonData),{afdatabase:e.target.value});n(o(o({},r),{jsonData:s}))},t.onMyOptionsChange=function(e){(0,t.props.onOptionsChange)(h(e))},t}return i(t,e),t.prototype.render=function(){var e=this.props.options,t=h(e);return m.a.createElement("div",null,m.a.createElement(p.DataSourceHttpSettings,{defaultUrl:"https://server.name/webapi",dataSourceConfig:t,onChange:this.onMyOptionsChange,showAccessOptions:!0}),m.a.createElement("h3",{className:"page-heading"},"PI/AF Connection Details"),m.a.createElement("div",{className:"gf-form-group"},m.a.createElement("div",{className:"gf-form"},m.a.createElement(d,{label:"PI Server",labelWidth:10,inputWidth:25,onChange:this.onPIServerChange,value:t.jsonData.piserver||"",placeholder:"Default PI Server to use for data requests"})),m.a.createElement("div",{className:"gf-form"},m.a.createElement(d,{label:"AF Server",labelWidth:10,inputWidth:25,onChange:this.onAFServerChange,value:t.jsonData.afserver||"",placeholder:"Default AF Server to use for data requests"})),m.a.createElement("div",{className:"gf-form"},m.a.createElement(d,{label:"AF Database",labelWidth:10,inputWidth:25,onChange:this.onAFDatabaseChange,value:t.jsonData.afdatabase||"",placeholder:"Default AF Database server for AF queries"}))))},t}(c.PureComponent),b=a(1),g=function(e){var t=e.label,a=e.labelWidth,n=void 0===a?8:a,r=e.tooltip,s=e.children;return m.a.createElement(m.a.Fragment,null,m.a.createElement(p.InlineFormLabel,{width:n,className:"query-keyword",tooltip:r},t),s)},v=function(){return m.a.createElement("div",{className:"gf-form gf-form--grow"},m.a.createElement("div",{className:"gf-form-label gf-form-label--grow"}))},y=function(e){var t=function(e,t){var a={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.indexOf(n)<0&&(a[n]=e[n]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var r=0;for(n=Object.getOwnPropertySymbols(e);r<n.length;r++)t.indexOf(n[r])<0&&Object.prototype.propertyIsEnumerable.call(e,n[r])&&(a[n[r]]=e[n[r]])}return a}(e,[]);return m.a.createElement(E,null,m.a.createElement(g,o({},t)))},E=function(e){return m.a.createElement("div",{className:"gf-form-inline"},e.children,m.a.createElement(v,null))},S={target:";",attributes:[],segments:[],regex:{enable:!1},summary:{types:[],basis:"EventWeighted",interval:"",nodata:"Null"},expression:"",interpolate:{enable:!1},recordedValues:{enable:!1},digitalStates:{enable:!1},isPiPoint:!1},P=p.LegacyForms.Input,C=p.LegacyForms.Switch,I=function(e){var t;return e.value?m.a.createElement("div",{className:"gf-form-label"},null!==(t=e.label)&&void 0!==t?t:"---no label--"):m.a.createElement("a",{className:"gf-form-label query-part"},m.a.createElement(p.Icon,{name:"plus"}))},N=function(e){function t(t){var a=e.call(this,t)||this;return a.piServer=[],a.availableAttributes={},a.state={segments:[],attributes:[],summaries:[],attributeSegment:{},summarySegment:{},calculationBasisSegment:{},noDataReplacementSegment:{}},a.onPiPointChange=function(e,t){var n=a.state.attributes.slice(0);"-REMOVE-"===e.label?Object(b.remove)(n,(function(e,a){return a===t})):n[t]=e,a.checkPiPointSegments(e,n)},a.onAttributeChange=function(e,t){var n=a.state.attributes.slice(0);n[t]=e,a.checkAttributeSegments(n,a.state.segments)},a.onSegmentChange=function(e,t){var n,r,s=a.props.query,i=a.state.segments.slice(0);return"-REMOVE-"===e.label?(i=Object(b.slice)(i,0,t),a.checkAttributeSegments([],i),0===i.length?i.push({label:""}):(null===(n=i[i.length-1].value)||void 0===n?void 0:n.expandable)&&i.push({label:"Select Element",value:{value:"-Select Element-"}}),s.isPiPoint&&(a.piServer=[]),void a.segmentChangeValue(i)):(i[t]=e,s.isPiPoint?(a.piServer.push(e),void a.segmentChangeValue(i)):(t<i.length-1&&(i=Object(b.slice)(i,0,t+1)),a.checkAttributeSegments([],i),(null===(r=e.value)||void 0===r?void 0:r.expandable)&&i.push({label:"Select Element",value:{value:"-Select Element-"}}),s.isPiPoint&&a.piServer.push(e),void a.segmentChangeValue(i)))},a.getElementSegments=function(e){var t=a.props,n=t.datasource,r=t.query,s=a,i=r.isPiPoint?{type:"dataserver"}:{path:a.getSegmentPathUpTo(a.state.segments.slice(0),e)};return n.metricFindQuery(i,r.isPiPoint).then((function(e){var t=Object(b.map)(e,(function(e){return{webId:e.WebId,label:e.text,value:{value:e.text,expandable:!r.isPiPoint&&e.expandable}}}));if(0===t.length)return t;var a=n.templateSrv.getVariables();return Object(b.each)(a,(function(e){var a={label:"[["+e.name+"]]",value:{type:"template",value:"[["+e.name+"]]",expandable:!r.isPiPoint}};t.unshift(a)})),t.unshift({label:"-REMOVE-",value:{value:"-REMOVE-"}}),t})).catch((function(e){return s.error=e.message||"Failed to issue metric query",[]}))},a.getAttributeSegmentsPI=function(e){var t=a.props,n=t.datasource,r=t.query,s=a,i=[],o={path:"",webId:s.getSelectedPIServer(),pointName:n.templateSrv.replace(e)+"*",type:"pipoint"};return n.metricFindQuery(o,r.isPiPoint).then((function(t){return(i=Object(b.map)(t,(function(e){return{path:e.Path,label:e.text,value:{value:e.text,expandable:!1}}}))).unshift({label:e,value:{value:e,expandable:!1}}),i.unshift({label:"-REMOVE-",value:{value:"-REMOVE-"}}),i})).catch((function(e){return s.error=e.message||"Failed to issue metric query",i}))},a.getAttributeSegmentsAF=function(e){var t=a,n=[];return Object(b.forOwn)(t.availableAttributes,(function(e,t){var a={label:t,value:{value:t,expandable:!0}};n.push(a)})),n.unshift({label:"-REMOVE-",value:{value:"-REMOVE-"}}),n},a.componentDidMount=function(){var e,t,n,r=a.props.query,s=Object(b.defaults)(r,S),i=s.segments,o=s.attributes,l=s.summary,u=null!==(e=null==i?void 0:i.slice(0))&&void 0!==e?e:[];0===u.length&&u.push({});var c=null!==(t=null==o?void 0:o.slice(0))&&void 0!==t?t:[],m=null!==(n=null==l?void 0:l.types)&&void 0!==n?n:[];r.isPiPoint&&u.length>0&&(a.piServer=u),a.setState({segments:u,attributes:c,summaries:m})},a.segmentChangeValue=function(e){var t=a.props.query;a.setState({segments:e}),a.onChange(o(o({},t),{segments:e}))},a.attributeChangeValue=function(e){var t=a.props.query;a.setState({attributes:e}),a.onChange(o(o({},t),{attributes:e}))},a.onChange=function(e){var t=a.props,n=t.onChange,r=t.onRunQuery;e.summary.types=a.state.summaries,e.elementPath=a.getSegmentPathUpTo(a.state.segments,a.state.segments.length),e.target=e.elementPath+";"+Object(b.join)(e.attributes.map((function(e){var t;return null===(t=e.value)||void 0===t?void 0:t.value})),";"),n(e),e.target&&e.target.length>0&&e.attributes.length>0&&r()},a.stateCallback=function(){var e=a.props.query;a.onChange(e)},a.onIsPiPointChange=function(e){var t=a.props.query;a.setState({segments:[{label:""}],attributes:[]},(function(){a.onChange(o(o({},t),{attributes:a.state.attributes,segments:a.state.segments,isPiPoint:!t.isPiPoint}))}))},a.onSegmentChange=a.onSegmentChange.bind(a),a.calcBasisValueChanged=a.calcBasisValueChanged.bind(a),a.calcNoDataValueChanged=a.calcNoDataValueChanged.bind(a),a.onSummaryAction=a.onSummaryAction.bind(a),a.onSummaryValueChanged=a.onSummaryValueChanged.bind(a),a.onAttributeAction=a.onAttributeAction.bind(a),a.onAttributeChange=a.onAttributeChange.bind(a),a.summaryTypes=["Total","Average","Minimum","Maximum","Range","StdDev","PopulationStdDev","Count","PercentGood","All","AllForNonNumeric"],a.calculationBasis=["TimeWeighted","EventWeighted","TimeWeightedContinuous","TimeWeightedDiscrete","EventWeightedExcludeMostRecentEvent","EventWeightedExcludeEarliestEvent","EventWeightedIncludeBothEnds"],a.noDataReplacement=["Null","Drop","Previous","0","Keep"],a}return i(t,e),t.prototype.isValueEmpty=function(e){return!e||!e.value||!e.value.length||"-REMOVE-"===e.value},t.prototype.calcBasisValueChanged=function(e){var t,a=this.props.query,n=a.summary;n.basis=null===(t=e.value)||void 0===t?void 0:t.value,this.onChange(o(o({},a),{summary:n}))},t.prototype.getCalcBasisSegments=function(){return Object(b.map)(this.calculationBasis,(function(e){return{label:e,value:{value:e,expandable:!0}}}))},t.prototype.calcNoDataValueChanged=function(e){var t,a=this.props.query,n=a.summary;n.nodata=null===(t=e.value)||void 0===t?void 0:t.value,this.onChange(o(o({},a),{summary:n}))},t.prototype.getNoDataSegments=function(){return Object(b.map)(this.noDataReplacement,(function(e){return{label:e,value:{value:e,expandable:!0}}}))},t.prototype.removeSummary=function(e){var t=Object(b.filter)(this.state.summaries,(function(t){return t!==e}));this.setState({summaries:t})},t.prototype.onSummaryAction=function(e){var t,a=this.state.summaries.slice(0);if(!this.isValueEmpty(e.value)){var n={label:e.label,value:{value:null===(t=e.value)||void 0===t?void 0:t.value,expandable:!0}};a.push(n)}this.setState({summarySegment:{},summaries:a},this.stateCallback)},t.prototype.onSummaryValueChanged=function(e,t){var a=this.state.summaries.slice(0);a[t].value=e.value,this.isValueEmpty(e.value)&&a.splice(t,1),this.setState({summaries:a},this.stateCallback)},t.prototype.getSummarySegments=function(){var e=this,t=Object(b.filter)(this.summaryTypes,(function(t){return-1===e.state.summaries.map((function(e){var t;return null===(t=e.value)||void 0===t?void 0:t.value})).indexOf(t)})),a=Object(b.map)(t,(function(e){return{label:e,value:{value:e,expandable:!0}}}));return a.unshift({label:"-REMOVE-",value:{value:"-REMOVE-"}}),a},t.prototype.removeAttribute=function(e){var t=Object(b.filter)(this.state.attributes,(function(t){return t!==e}));this.attributeChangeValue(t)},t.prototype.onAttributeAction=function(e){var t,a=this.props.query,n=this.state.attributes.slice(0);if(!this.isValueEmpty(e.value)){var r={label:e.label,value:{value:null===(t=e.value)||void 0===t?void 0:t.value,expandable:!a.isPiPoint}};n.push(r)}this.attributeChangeValue(n)},t.prototype.getSegmentPathUpTo=function(e,t){var a=e.slice(0,t);return Object(b.reduce)(a,(function(e,t){return t.value?t.value.value.startsWith("-Select")?e:e?e+"\\"+t.value.value:t.value.value:""}),"")},t.prototype.checkAttributeSegments=function(e,t){var a=this,n=this.props.datasource,r=this,s={path:this.getSegmentPathUpTo(t.slice(0),t.length),type:"attributes"};return n.metricFindQuery(s,!1).then((function(t){var s={};Object(b.each)(t,(function(e){s[e.Path.substring(e.Path.indexOf("|")+1)]=e.WebId}));var i=Object(b.filter)(e,(function(e){var t,a=n.templateSrv.replace(null===(t=e.value)||void 0===t?void 0:t.value);return void 0!==s[a]}));r.availableAttributes=s,a.attributeChangeValue(i)})).catch((function(e){r.error=e.message||"Failed to issue metric query",a.attributeChangeValue([])}))},t.prototype.checkPiPointSegments=function(e,t){var a=this,n=this.props.datasource,r=this,s={path:e.path,webId:r.getSelectedPIServer(),pointName:n.templateSrv.replace(e.label),type:"pipoint"};return n.metricFindQuery(s,!0).then((function(){a.attributeChangeValue(t)})).catch((function(e){r.error=e.message||"Failed to issue metric query",a.attributeChangeValue([])}))},t.prototype.getSelectedPIServer=function(){var e=this,t="";return this.piServer.forEach((function(a){var n=e.props.query.target.split(";");n.length>=2&&n[0]===a.text&&(t=a.WebId)})),this.piServer.length>0?this.piServer[0].webId:t},t.prototype.render=function(){var e=this,t=this.props,a=t.query,n=t.onRunQuery,r=Object(b.defaults)(a,S),s=r.interpolate,i=r.digitalStates,l=r.recordedValues,u=r.expression,c=r.isPiPoint,d=r.summary,h=r.display,f=r.regex;return m.a.createElement(m.a.Fragment,null,m.a.createElement("div",{className:"gf-form"},m.a.createElement(C,{className:"gf-form-inline",label:"PI Point Search",labelClass:"query-keyword",checked:c,onChange:this.onIsPiPointChange})),m.a.createElement(y,{label:c?"Element":"Data Server"},this.state.segments.map((function(t,a){return m.a.createElement(p.SegmentAsync,{key:"element-"+a,Component:m.a.createElement(I,{value:t.value,label:t.label}),onChange:function(t){return e.onSegmentChange(t,a)},loadOptions:function(t){return e.getElementSegments(a)},allowCustomValue:!0})}))),m.a.createElement(y,{label:c?"Pi Points":"Attributes"},this.state.attributes.map((function(t,a){return c?m.a.createElement(p.SegmentAsync,{key:"attributes-"+a,Component:m.a.createElement(I,{value:t.value,label:t.label}),disabled:0===e.piServer.length,onChange:function(t){return e.onPiPointChange(t,a)},loadOptions:e.getAttributeSegmentsPI,reloadOptionsOnChange:!0,allowCustomValue:!0}):m.a.createElement(p.Segment,{key:"attributes-"+a,Component:m.a.createElement(I,{value:t.value,label:t.label}),disabled:e.state.segments.length<=2,onChange:function(t){return e.onAttributeChange(t,a)},options:e.getAttributeSegmentsAF(),allowCustomValue:!0})})),c&&m.a.createElement(p.SegmentAsync,{Component:m.a.createElement(I,{value:this.state.attributeSegment.value,label:this.state.attributeSegment.label}),disabled:0===this.piServer.length,onChange:this.onAttributeAction,loadOptions:this.getAttributeSegmentsPI,reloadOptionsOnChange:!0,allowCustomValue:!0}),!c&&m.a.createElement(p.Segment,{Component:m.a.createElement(I,{value:this.state.attributeSegment.value,label:this.state.attributeSegment.label}),disabled:this.state.segments.length<=2,onChange:this.onAttributeAction,options:this.getAttributeSegmentsAF(),allowCustomValue:!0})),m.a.createElement("div",{className:"gf-form-inline"},m.a.createElement("div",{className:"gf-form"},m.a.createElement("label",{className:"gf-form-label query-keyword width-11"},"Calculation",m.a.createElement("i",{className:"fa fa-question-circle","bs-tooltip":"'Modify all attributes by an equation. Use \\'.\\' for current item. Leave Attributes empty if you wish to perform element based calculations.'","data-placement":"top"})),m.a.createElement(P,{className:"gf-form-input",onBlur:n,value:u,onChange:function(t){return e.onChange(o(o({},r),{expression:t.target.value}))},placeholder:"'.'*2"}))),m.a.createElement("div",{className:"gf-form-inline"},m.a.createElement("div",{className:"gf-form"},m.a.createElement("label",{className:"gf-form-label query-keyword width-11"},"Max Recorded Values",m.a.createElement("i",{className:"fa fa-question-circle","bs-tooltip":"'Maximum number of recorded value to retrive from the data archive, without using interpolation.'","data-placement":"top"})),m.a.createElement(P,{className:"gf-form-input width-6",onBlur:n,value:l.maxNumber,onChange:function(t){return e.onChange(o(o({},r),{recordedValues:o(o({},l),{maxNumber:parseInt(t.target.value,10)})}))},type:"number",placeholder:"150000"})),m.a.createElement("div",{className:"gf-form"},m.a.createElement(C,{className:"gf-form-inline",label:"Recorded Values",labelClass:"query-keyword",checked:l.enable,onChange:function(){e.onChange(o(o({},r),{recordedValues:o(o({},l),{enable:!l.enable})}))}})),m.a.createElement("div",{className:"gf-form"},m.a.createElement(C,{className:"gf-form-inline",label:"Digital States",labelClass:"query-keyword",checked:i.enable,onChange:function(){e.onChange(o(o({},r),{digitalStates:o(o({},i),{enable:!i.enable})}))}}))),m.a.createElement("div",{className:"gf-form-inline"},m.a.createElement("div",{className:"gf-form"},m.a.createElement("label",{className:"gf-form-label query-keyword width-11"},"Interpolate Period",m.a.createElement("i",{className:"fa fa-question-circle","bs-tooltip":"'Override time between sampling, e.g. \\'30s\\'. Defaults to timespan/chart width.'","data-placement":"top"})),m.a.createElement(P,{className:"gf-form-input width-5",onBlur:n,value:s.interval,onChange:function(t){return e.onChange(o(o({},r),{interpolate:o(o({},s),{interval:t.target.value})}))},placeholder:"30s"})),m.a.createElement("div",{className:"gf-form"},m.a.createElement(C,{className:"gf-form-inline",label:"Interpolate",labelClass:"query-keyword",checked:s.enable,onChange:function(){e.onChange(o(o({},r),{interpolate:o(o({},s),{enable:!s.enable})}))}})),m.a.createElement("div",{className:"gf-form"},m.a.createElement("label",{className:"gf-form-label query-keyword  width-8"},m.a.createElement("span",null,"Replace Bad Data"),m.a.createElement("i",{className:"fa fa-question-circle","bs-tooltip":"'Replacement for bad quality values.'","data-placement":"top"})),m.a.createElement(p.Segment,{Component:m.a.createElement(I,{value:{value:d.nodata},label:d.nodata}),onChange:this.calcNoDataValueChanged,options:this.getNoDataSegments(),allowCustomValue:!0}))),m.a.createElement("div",{className:"gf-form-inline"},m.a.createElement("div",{className:"gf-form"},m.a.createElement("label",{className:"gf-form-label query-keyword width-11"},"Summary Period",m.a.createElement("i",{className:"fa fa-question-circle","bs-tooltip":"'Override time between sampling, e.g. \\'30s\\'.'","data-placement":"top"})),m.a.createElement(P,{className:"gf-form-input width-5",onBlur:n,value:d.interval,onChange:function(t){return e.onChange(o(o({},r),{summary:o(o({},d),{interval:t.target.value})}))},placeholder:"30s"})),m.a.createElement("div",{className:"gf-form"},m.a.createElement("label",{className:"gf-form-label query-keyword  width-8"},m.a.createElement("span",null,"Basis"),m.a.createElement("i",{className:"fa fa-question-circle","bs-tooltip":"'Defines the possible calculation options when performing summary calculations over time-series data.'","data-placement":"top"})),m.a.createElement(p.Segment,{Component:m.a.createElement(I,{value:{value:d.basis},label:d.basis}),onChange:this.calcBasisValueChanged,options:this.getCalcBasisSegments(),allowCustomValue:!0})),m.a.createElement("div",{className:"gf-form gf-form--grow"},m.a.createElement("label",{className:"gf-form-label query-keyword  width-8"},m.a.createElement("span",null,"Summaries")),this.state.summaries.map((function(t,a){return m.a.createElement(p.Segment,{key:"summaries-"+a,Component:m.a.createElement(I,{value:t.value,label:t.label}),onChange:function(t){return e.onSummaryValueChanged(t,a)},options:e.getSummarySegments(),allowCustomValue:!0})})),m.a.createElement(p.Segment,{Component:m.a.createElement(I,{value:this.state.summarySegment.value,label:this.state.summarySegment.label}),onChange:this.onSummaryAction,options:this.getSummarySegments(),allowCustomValue:!0}),m.a.createElement(v,null))),m.a.createElement("div",{className:"gf-form-inline"},m.a.createElement("div",{className:"gf-form"},m.a.createElement("div",{className:"gf-form max-width-30"},m.a.createElement("label",{className:"gf-form-label query-keyword width-11"},"Display Name",m.a.createElement("i",{className:"fa fa-question-circle","bs-tooltip":"'If single attribute, modify display name. Otherwise use regex to modify display name.'","data-placement":"top"})),m.a.createElement(P,{className:"gf-form-input width-5",onBlur:n,value:h,onChange:function(t){return e.onChange(o(o({},r),{display:t.target.value}))},placeholder:"Display"}))),m.a.createElement("div",{className:"gf-form"},m.a.createElement(C,{className:"gf-form",label:"Enable Regex Replace",labelClass:"query-keyword",checked:f.enable,onChange:function(){e.onChange(o(o({},r),{regex:o(o({},f),{enable:!f.enable})}))}})),m.a.createElement("div",{className:"gf-form"},m.a.createElement("div",{className:"gf-form max-width-30"},m.a.createElement("label",{className:"gf-form-label query-keyword"},"Search"),m.a.createElement(P,{className:"gf-form-input width-5",onBlur:n,value:f.search,onChange:function(t){return e.onChange(o(o({},r),{regex:o(o({},f),{search:t.target.value})}))},placeholder:"(.*)"}))),m.a.createElement("div",{className:"gf-form"},m.a.createElement("div",{className:"gf-form max-width-30"},m.a.createElement("label",{className:"gf-form-label query-keyword"},"Replace"),m.a.createElement(P,{className:"gf-form-input width-5",onBlur:n,value:f.replace,onChange:function(t){return e.onChange(o(o({},r),{regex:o(o({},f),{replace:t.target.value})}))},placeholder:"$1"}))),m.a.createElement(v,null)))},t}(c.PureComponent),O=a(4);function w(e){return(w="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}var j=function(e){function t(t,a){var n,r=e.call(this,t)||this;return r.backendSrv=a,r.isProxy=!1,r.webidCache=new Map,r.basicAuth=t.basicAuth,r.withCredentials=t.withCredentials,r.url=t.url,r.name=t.name,r.templateSrv=Object(O.getTemplateSrv)(),r.piwebapiurl=null===(n=t.jsonData.url)||void 0===n?void 0:n.toString(),r.isProxy=/^http(s)?:\/\//.test(r.url)||"proxy"===t.jsonData.access,r.piserver={name:(t.jsonData||{}).piserver,webid:void 0},r.afserver={name:(t.jsonData||{}).afserver,webid:void 0},r.afdatabase={name:(t.jsonData||{}).afdatabase,webid:void 0},Promise.all([r.getAssetServer(r.afserver.name).then((function(e){return r.afserver.webid=e.WebId})),r.getDataServer(r.piserver.name).then((function(e){return r.piserver.webid=e.WebId})),r.getDatabase(r.afserver.name+"\\"+r.afdatabase.name).then((function(e){return r.afdatabase.webid=e.WebId}))]),r}return i(t,e),t.prototype.eventFrameToAnnotation=function(e,t,a,n){e.regex&&e.regex.enable&&(a.Name=a.Name.replace(new RegExp(e.regex.search),e.regex.replace));var r="";return n&&Object(b.each)(n,(function(e){var t=e.Value.Value?e.Value.Value.Name||e.Value.Value.Value||e.Value.Value:null;r+="<br />"+e.Name+": "+t})),{annotation:e,title:(t?"END ":e.showEndTime?"START ":"")+e.name,time:new Date(t?a.EndTime:a.StartTime).getTime(),text:a.Name+r+"<br />Start: "+a.StartTime+"<br />End: "+a.EndTime}},t.prototype.buildQueryParameters=function(e){var t=this;return e.targets=Object(b.filter)(e.targets,(function(e){return!(!e||!e.target)&&!e.target.startsWith("Select AF")})),e.targets=Object(b.map)(e.targets,(function(a){var n={target:t.templateSrv.replace(a.elementPath,e.scopedVars),elementPath:t.templateSrv.replace(a.elementPath,e.scopedVars),attributes:Object(b.map)(a.attributes,(function(a){var n;return t.templateSrv.replace(null===(n=a.value)||void 0===n?void 0:n.value,e.scopedVars)})),segments:Object(b.map)(a.segments,(function(a){var n;return t.templateSrv.replace(null===(n=a.value)||void 0===n?void 0:n.value,e.scopedVars)})),display:a.display,refId:a.refId,hide:a.hide,interpolate:a.interpolate||{enable:!1},recordedValues:a.recordedValues||{enable:!1},digitalStates:a.digitalStates||{enable:!1},webid:a.webid,webids:a.webids||[],regex:a.regex||{enable:!1},expression:a.expression||"",summary:a.summary||{types:[]},startTime:e.range.from,endTime:e.range.to,isPiPoint:a.isPiPoint};n.expression&&(n.expression=t.templateSrv.replace(n.expression,e.scopedVars)),void 0!==n.summary.types&&(n.summary.types=Object(b.filter)(n.summary.types,(function(e){return null!=e&&""!==e})));var r=Object(b.keys)(e.scopedVars);return t.templateSrv.getVariables().forEach((function(e){e.current&&"All"===e.current.text&&r.indexOf(e.name)<0&&(n.attributes=n.attributes.map((function(t){return e.options.filter((function(e){return!e.selected})).map((function(a){return t.replace("{"+e.query+"}",a.text)}))})),n.attributes=Object(b.uniq)(Object(b.flatten)(n.attributes)))})),n})),e},t.prototype.query=function(e){return l(this,void 0,Promise,(function(){var t,a;return u(this,(function(r){return t=this,(a=this.buildQueryParameters(e)).targets=Object(b.filter)(a.targets,(function(e){return!e.hide})),a.targets.length<=0?[2,Promise.resolve({data:[]})]:[2,Promise.all(t.getStream(a)).then((function(e){var t=[];return Object(b.each)(e,(function(e){Object(b.each)(e,(function(e){return t.push(e)}))})),{data:t.sort((function(e,t){return+(e.target>t.target)||+(e.target===t.target)-1})).map((function(e){return Object(n.toDataFrame)(e)}))}}))]}))}))},t.prototype.testDatasource=function(){return this.backendSrv.datasourceRequest({url:this.url+"/",method:"GET"}).then((function(e){if(200===e.status)return{status:"success",message:"Data source is working",title:"Success"};throw new Error("Failed")}))},t.prototype.annotationQuery=function(e){var t=this;if(!this.afdatabase.webid)return Promise.resolve([]);var a=e.annotation.query.categoryName?this.templateSrv.replace(e.annotation.query.categoryName,e.scopedVars,"glob"):null,n=e.annotation.query.nameFilter?this.templateSrv.replace(e.annotation.query.nameFilter,e.scopedVars,"glob"):null,r=e.annotation.template?e.annotation.template.Name:null,s={name:e.annotation.name,datasource:e.annotation.datasource,enable:e.annotation.enable,iconColor:e.annotation.iconColor,showEndTime:e.annotation.showEndTime,regex:e.annotation.regex,attribute:e.annotation.attribute,categoryName:a,templateName:r,nameFilter:n},i=[];if(s.categoryName&&i.push("categoryName="+s.categoryName),s.nameFilter&&i.push("nameFilter="+s.nameFilter),s.templateName&&i.push("templateName="+s.templateName),!i.length)return Promise.resolve([]);if(i.push("startTime="+e.range.from.toJSON()),i.push("endTime="+e.range.to.toJSON()),s.attribute&&s.attribute.enable){var o=this.piwebapiurl+"/streamsets/{0}/value?selectedFields=Items.WebId;Items.Value;Items.Name";s.attribute.name&&(o=this.piwebapiurl+"/streamsets/{0}/value?nameFilter="+s.attribute.name+"&selectedFields=Items.WebId;Items.Value;Items.Name");var l={};return l[1]={Method:"GET",Resource:this.piwebapiurl+"/assetdatabases/"+this.afdatabase.webid+"/eventframes?"+i.join("&")},l[2]={Method:"GET",RequestTemplate:{Resource:o},Parameters:["$.1.Content.Items[*].WebId"],ParentIds:["1"]},this.restBatch(l).then((function(a){var n=a.data[1].Content,r=a.data[2].Content,i=Object(b.map)(n.Items,(function(e,a){return Object(b.curry)(t.eventFrameToAnnotation)(s,!1,e,r.Items[a].Content.Items)}));if(e.annotation.showEndTime){var o=Object(b.map)(n.Items,(function(e,a){return Object(b.curry)(t.eventFrameToAnnotation)(s,!0,e,r.Items[a].Content.Items)}));Object(b.each)(o,(function(e){i.push(e)}))}return i}))}return this.restGet("/assetdatabases/"+this.afdatabase.webid+"/eventframes?"+i.join("&")).then((function(a){var n=Object(b.map)(a.data.Items,Object(b.curry)(t.eventFrameToAnnotation)(s,!1));if(e.annotation.showEndTime){var r=Object(b.map)(a.data.Items,Object(b.curry)(t.eventFrameToAnnotation)(s,!0));Object(b.each)(r,(function(e){n.push(e)}))}return n}))},t.prototype.metricQueryTransform=function(e){return Object(b.map)(e,(function(e){var t,a;return{text:e.Name,expandable:void 0===e.HasChildren||!0===e.HasChildren||(null!==(t=e.Path)&&void 0!==t?t:"").split("\\").length<=3,HasChildren:e.HasChildren,Items:null!==(a=e.Items)&&void 0!==a?a:[],Path:e.Path,WebId:e.WebId}}))},t.prototype.metricFindQuery=function(e,t){var a=this,n=["servers","databases","databaseElements","elements"];return t||(""===e.path?e.type=n[0]:"attributes"!==e.type&&(e.type=n[Math.max(0,Math.min(e.path.split("\\").length,n.length-1))])),e.path=this.templateSrv.replace(e.path),"servers"===e.type?a.getAssetServers().then(a.metricQueryTransform):"databases"===e.type?a.getAssetServer(e.path).then((function(e){var t;return a.getDatabases(null!==(t=e.WebId)&&void 0!==t?t:"",{})})).then(a.metricQueryTransform):"databaseElements"===e.type?a.getDatabase(e.path).then((function(e){var t;return a.getDatabaseElements(null!==(t=e.WebId)&&void 0!==t?t:"",{selectedFields:"Items.WebId;Items.Name;Items.Items;Items.Path;Items.HasChildren"})})).then(a.metricQueryTransform):"elements"===e.type?a.getElement(e.path).then((function(e){var t;return a.getElements(null!==(t=e.WebId)&&void 0!==t?t:"",{selectedFields:"Items.WebId;Items.Name;Items.Items;Items.Path;Items.HasChildren"})})).then(a.metricQueryTransform):"attributes"===e.type?a.getElement(e.path).then((function(e){var t;return a.getAttributes(null!==(t=e.WebId)&&void 0!==t?t:"",{searchFullHierarchy:"true",selectedFields:"Items.WebId;Items.Name;Items.Path"})})).then(a.metricQueryTransform):"dataserver"===e.type?a.getDataServers().then(a.metricQueryTransform):"pipoint"===e.type?a.piPointSearch(e.webId,e.pointName).then(a.metricQueryTransform):void 0},t.prototype.getSummaryUrl=function(e){return""===e.interval.trim()?"&summaryType="+e.types.map((function(e){var t;return null===(t=e.value)||void 0===t?void 0:t.value})).join("&summaryType=")+"&calculationBasis="+e.basis:"&summaryType="+e.types.map((function(e){var t;return null===(t=e.value)||void 0===t?void 0:t.value})).join("&summaryType=")+"&calculationBasis="+e.basis+"&summaryDuration="+e.interval.trim()},t.prototype.resolveWebIds=function(e){var t={},a=1;Object(b.each)(e.targets,(function(e){var n=e.attributes.length>0,r=a++;t[r.toString()]={Method:"GET",Resource:"/elements?selectedFields=WebId;Name;Path&path=\\\\"+encodeURIComponent(e.elementPath)},n&&Object(b.each)(e.attributes,(function(){t[(a++).toString()]={Method:"GET",Resource:"/elements/{0}/attributes?selectedFields=WebId;Name;Path&nameFilter="+encodeURIComponent(e.elementPath),Parameters:["$."+r+".Content.WebId"],ParentIds:[r.toString()]}}))}))},t.prototype.parsePiPointValueList=function(e,t,a){var n=this,r=this,s=[];return Object(b.each)(e,(function(e){var i=n.noDataReplace(a?e.Value:e,t.summary.nodata,r.parsePiPointValue(e,t,a)),o=i.grafanaDataPoint;i.previousValue;i.drop||s.push(o)})),s},t.prototype.parsePiPointValue=function(e,t,a){var n=a||"object"!==w(e.Value)?Number(e.Value):Number(e.Value.Value),r=e.Value;return t.digitalStates&&t.digitalStates.enable&&(n=e.Value.Name),e.Good||(n=e.Value.Name),a?(n=Number(e.Value.Value),r=e.Value.Value,t.digitalStates&&t.digitalStates.enable&&(n=e.Value.Name),e.Value.Good||(n=e.Value.Name),""===t.summary.interval?t.digitalStates&&t.digitalStates.enable?[n,new Date(e.Timestamp).getTime()]:e.Good?[isNaN(n)?r:n,new Date(t.endTime).getTime()]:[n,new Date(e.Timestamp).getTime()]:t.digitalStates&&t.digitalStates.enable?[n,new Date(e.Timestamp).getTime()]:e.Good?[isNaN(n)?r:n,new Date(e.Timestamp).getTime()]:[n,new Date(e.Timestamp).getTime()]):[isNaN(n)?0:n,new Date(e.Timestamp).getTime()]},t.prototype.noDataReplace=function(e,t,a){var n=null,r=!1;return"No Data"===e.Value||e.Value.Name&&"No Data"===e.Value.Name||!e.Good?"Drop"===t?r=!0:"0"===t?a[0]=0:"Keep"===t||("Null"===t?a[0]=null:"Previous"===t&&null!==n&&(a[0]=n)):n=e.Value,{grafanaDataPoint:a,previousValue:n,drop:r}},t.prototype.processResults=function(e,t,a){var n=this,r=t.summary&&t.summary.types&&t.summary.types.length>0;if(t.regex&&t.regex.enable&&(a=a.replace(new RegExp(t.regex.search),t.regex.replace)),r){var s=[],i=Object(b.groupBy)(e.Items,(function(e){return e.Type}));return Object(b.forOwn)(i,(function(e,i){s.push({target:a+"["+i+"]",refId:t.refId,datapoints:n.parsePiPointValueList(e,t,r)})})),s}return[{target:a,refId:t.refId,datapoints:n.parsePiPointValueList(e.Items,t,r)}]},t.prototype.getStream=function(e){var t=this,a=this,n=[];return Object(b.each)(e.targets,(function(r){r.attributes=Object(b.filter)(r.attributes||[],(function(e){return e}));var s="",i=r.summary&&r.summary.types&&r.summary.types.length>0,o=r.interpolate&&r.interpolate.enable,l=r.interpolate.interval?r.interpolate.interval:e.interval,u="?startTime="+e.range.from.toJSON()+"&endTime="+e.range.to.toJSON(),c=r.expression||r.elementPath;r.expression?(s+="/calculation",s+=i?"/summary"+u+(o?"&sampleType=Interval&sampleInterval="+l:""):"/intervals"+u+"&sampleInterval="+l,s+="&expression="+encodeURIComponent(r.expression),s+="&webid=",r.attributes.length>0?Object(b.each)(r.attributes,(function(e){n.push(a.restGetWebId(r.elementPath+"|"+e,r.isPiPoint).then((function(t){return a.restPost(s+t.WebId).then((function(t){return a.processResults(t.data,r,r.display||e||c)})).catch((function(e){return a.error=e}))})))})):n.push(a.restGetWebId(r.elementPath,r.isPiPoint).then((function(e){return a.restPost(s+e.WebId).then((function(e){return a.processResults(e.data,r,r.display||c)})).catch((function(e){return a.error=e}))})))):(s+="/streamsets",i?s+="/summary"+u+"&intervals="+e.maxDataPoints+t.getSummaryUrl(r.summary):r.interpolate&&r.interpolate.enable?s+="/interpolated"+u+"&interval="+l:r.recordedValues&&r.recordedValues.enable?s+="/recorded"+u+"&maxCount="+r.recordedValues.maxNumber:s+="/plot"+u+"&intervals="+e.maxDataPoints,n.push(Promise.all(Object(b.map)(r.attributes,(function(e){return a.restGetWebId(r.elementPath+"|"+e,r.isPiPoint)}))).then((function(e){var t={};return Object(b.each)(e,(function(e,n){t[n+1]={Method:"GET",Resource:a.piwebapiurl+s+"&webid="+e.WebId}})),a.restBatch(t).then((function(e){var t=[];return Object(b.each)(e.data,(function(e,n){Object(b.each)(e.Content.Items,(function(e){Object(b.each)(a.processResults(e,r,r.display||e.Name||c),(function(e){return t.push(e)}))}))})),t})).catch((function(e){return a.error=e}))}))))})),n},t.prototype.restGet=function(e){return this.backendSrv.datasourceRequest({url:this.url+e,method:"GET",headers:{"Content-Type":"application/json"}}).then((function(e){return e}))},t.prototype.restGetWebId=function(e,t){var a=this,n=a.webidCache.get(e);if(n)return Promise.resolve({Path:e,WebId:n});var r="";return r=t?"/points?selectedFields=WebId;Name;Path&path=\\\\"+e.replace("|","\\"):(e.indexOf("|")>=0?"/attributes?selectedFields=WebId;Name;Path&path=\\\\":"/elements?selectedFields=WebId;Name;Path&path=\\\\")+e,this.backendSrv.datasourceRequest({url:this.url+r,method:"GET",headers:{"Content-Type":"application/json"}}).then((function(t){return a.webidCache.set(e,t.data.WebId),{Path:e,WebId:t.data.WebId}}))},t.prototype.restBatch=function(e){return this.backendSrv.datasourceRequest({url:this.url+"/batch",data:e,method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"message/http"}})},t.prototype.restPost=function(e){return this.backendSrv.datasourceRequest({url:this.url,method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"message/http","X-PIWEBAPI-HTTP-METHOD":"GET","X-PIWEBAPI-RESOURCE-ADDRESS":e}})},t.prototype.getDataServers=function(){return this.restGet("/dataservers").then((function(e){var t;return null!==(t=e.data.Items)&&void 0!==t?t:[]}))},t.prototype.getDataServer=function(e){return e?this.restGet("/dataservers?name="+e).then((function(e){return e.data})):Promise.resolve({})},t.prototype.getAssetServers=function(){return this.restGet("/assetservers").then((function(e){var t;return null!==(t=e.data.Items)&&void 0!==t?t:[]}))},t.prototype.getAssetServer=function(e){return e?this.restGet("/assetservers?path=\\\\"+e).then((function(e){return e.data})):Promise.resolve({})},t.prototype.getDatabase=function(e){return e?this.restGet("/assetdatabases?path=\\\\"+e).then((function(e){return e.data})):Promise.resolve({})},t.prototype.getDatabases=function(e,t){return this.restGet("/assetservers/"+e+"/assetdatabases").then((function(e){var t;return null!==(t=e.data.Items)&&void 0!==t?t:[]}))},t.prototype.getElement=function(e){return this.restGet("/elements?path=\\\\"+e).then((function(e){return e.data}))},t.prototype.getEventFrameTemplates=function(e){return this.restGet("/assetdatabases/"+e+"/elementtemplates?selectedFields=Items.InstanceType;Items.Name;Items.WebId").then((function(e){var t;return Object(b.filter)(null!==(t=e.data.Items)&&void 0!==t?t:[],(function(e){return"EventFrame"===e.InstanceType}))}))},t.prototype.getElementTemplates=function(e){return this.restGet("/assetdatabases/"+e+"/elementtemplates?selectedFields=Items.InstanceType;Items.Name;Items.WebId").then((function(e){var t;return Object(b.filter)(null!==(t=e.data.Items)&&void 0!==t?t:[],(function(e){return"Element"===e.InstanceType}))}))},t.prototype.getAttributes=function(e,t){var a="?"+Object(b.map)(t,(function(e,t){return t+"="+e})).join("&");return"?"===a&&(a=""),this.restGet("/elements/"+e+"/attributes"+a).then((function(e){var t;return null!==(t=e.data.Items)&&void 0!==t?t:[]}))},t.prototype.getDatabaseElements=function(e,t){var a="?"+Object(b.map)(t,(function(e,t){return t+"="+e})).join("&");return"?"===a&&(a=""),this.restGet("/assetdatabases/"+e+"/elements"+a).then((function(e){var t;return null!==(t=e.data.Items)&&void 0!==t?t:[]}))},t.prototype.getElements=function(e,t){var a="?"+Object(b.map)(t,(function(e,t){return t+"="+e})).join("&");return"?"===a&&(a=""),this.restGet("/elements/"+e+"/elements"+a).then((function(e){var t;return null!==(t=e.data.Items)&&void 0!==t?t:[]}))},t.prototype.piPointSearch=function(e,t){return this.restGet("/dataservers/"+e+"/points?maxCount=20&nameFilter="+t).then((function(e){var t;return null!==(t=e.data.Items)&&void 0!==t?t:[]}))},t.prototype.getWebId=function(e){var t=e.target.indexOf("\\")>=0,a=e.target.indexOf("|")>=0;return t||-1!==e.target.indexOf(".")?t?t&&a?this.restGet("/attributes?path=\\\\"+e.target).then((function(t){return void 0===t.data||200!==t.status?[{WebId:e.target,Name:e.display||e.target}]:(t.data.Name=e.display||t.data.Name,[t.data])})):this.restGet("/elements?path=\\\\"+e.target).then((function(t){return void 0===t.data||200!==t.status?[{WebId:e.target,Name:e.display||e.target}]:(t.data.Name=e.display||t.data.Name,[t.data])})):this.piPointSearch(this.piserver.webid,e.target).then((function(t){return void 0===t||0===t.length?[{WebId:e.target,Name:e.display||e.target}]:t})):Promise.resolve([{WebId:e.target,Name:e.display||e.target}])},t}(n.DataSourceApi);a.d(t,"plugin",(function(){return V}));var V=new n.DataSourcePlugin(j).setConfigEditor(f).setQueryEditor(N).setAnnotationQueryCtrl(r)}])}));
//# sourceMappingURL=module.js.map