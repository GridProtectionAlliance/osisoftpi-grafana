define(["react","lodash","@grafana/ui","@grafana/data","@grafana/runtime"],(function(e,t,a,n,r){return function(e){var t={};function a(n){if(t[n])return t[n].exports;var r=t[n]={i:n,l:!1,exports:{}};return e[n].call(r.exports,r,r.exports,a),r.l=!0,r.exports}return a.m=e,a.c=t,a.d=function(e,t,n){a.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},a.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},a.t=function(e,t){if(1&t&&(e=a(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(a.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)a.d(n,r,function(t){return e[t]}.bind(null,r));return n},a.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return a.d(t,"a",t),t},a.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},a.p="/",a(a.s=5)}([function(t,a){t.exports=e},function(e,a){e.exports=t},function(e,t){e.exports=a},function(e,t){e.exports=n},function(e,t){e.exports=r},function(e,t,a){"use strict";a.r(t);var n=a(3),r=function(){function e(){this.annotation.query=this.annotation.query||{},this.annotation.databases=this.annotation.databases||[],this.annotation.templates=this.annotation.templates||[],this.annotation.regex=this.annotation.regex||{},this.annotation.attribute=this.annotation.attribute||{},this.annotation.showEndTime=this.annotation.showEndTime||!1,this.getDatabases()}return e.prototype.templateChanged=function(){},e.prototype.databaseChanged=function(){this.getEventFrames()},e.prototype.getDatabases=function(){var e=this;return e.datasource.getDatabases(e.datasource.afserver.webid).then((function(t){e.annotation.databases=t}))},e.prototype.getEventFrames=function(){var e=this;return e.datasource.getEventFrameTemplates(this.annotation.database.WebId).then((function(t){e.annotation.templates=t}))},e.templateUrl="partials/annotations.editor.html",e}(),i=function(e,t){return(i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var a in t)Object.prototype.hasOwnProperty.call(t,a)&&(e[a]=t[a])})(e,t)};function l(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function a(){this.constructor=e}i(e,t),e.prototype=null===t?Object.create(t):(a.prototype=t.prototype,new a)}var o=function(){return(o=Object.assign||function(e){for(var t,a=1,n=arguments.length;a<n;a++)for(var r in t=arguments[a])Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e}).apply(this,arguments)};function s(e,t){var a={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.indexOf(n)<0&&(a[n]=e[n]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var r=0;for(n=Object.getOwnPropertySymbols(e);r<n.length;r++)t.indexOf(n[r])<0&&Object.prototype.propertyIsEnumerable.call(e,n[r])&&(a[n[r]]=e[n[r]])}return a}function u(e,t,a,n){return new(a||(a=Promise))((function(r,i){function l(e){try{s(n.next(e))}catch(e){i(e)}}function o(e){try{s(n.throw(e))}catch(e){i(e)}}function s(e){var t;e.done?r(e.value):(t=e.value,t instanceof a?t:new a((function(e){e(t)}))).then(l,o)}s((n=n.apply(e,t||[])).next())}))}function c(e,t){var a,n,r,i,l={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return i={next:o(0),throw:o(1),return:o(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function o(i){return function(o){return function(i){if(a)throw new TypeError("Generator is already executing.");for(;l;)try{if(a=1,n&&(r=2&i[0]?n.return:i[0]?n.throw||((r=n.return)&&r.call(n),0):n.next)&&!(r=r.call(n,i[1])).done)return r;switch(n=0,r&&(i=[2&i[0],r.value]),i[0]){case 0:case 1:r=i;break;case 4:return l.label++,{value:i[1],done:!1};case 5:l.label++,n=i[1],i=[0];continue;case 7:i=l.ops.pop(),l.trys.pop();continue;default:if(!(r=l.trys,(r=r.length>0&&r[r.length-1])||6!==i[0]&&2!==i[0])){l=0;continue}if(3===i[0]&&(!r||i[1]>r[0]&&i[1]<r[3])){l.label=i[1];break}if(6===i[0]&&l.label<r[1]){l.label=r[1],r=i;break}if(r&&l.label<r[2]){l.label=r[2],l.ops.push(i);break}r[2]&&l.ops.pop(),l.trys.pop();continue}i=t.call(e,l)}catch(e){i=[6,e],n=0}finally{a=r=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,o])}}}Object.create;function m(e,t){var a="function"==typeof Symbol&&e[Symbol.iterator];if(!a)return e;var n,r,i=a.call(e),l=[];try{for(;(void 0===t||t-- >0)&&!(n=i.next()).done;)l.push(n.value)}catch(e){r={error:e}}finally{try{n&&!n.done&&(a=i.return)&&a.call(i)}finally{if(r)throw r.error}}return l}Object.create;var p=a(0),d=a.n(p),h=a(2),v=h.LegacyForms.FormField,b=function(e){return o(o({},e),{jsonData:o(o({},e.jsonData),{url:e.url})})},f=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.onPIServerChange=function(e){var a=t.props,n=a.onOptionsChange,r=a.options,i=o(o({},r.jsonData),{piserver:e.target.value});n(o(o({},r),{jsonData:i}))},t.onAFServerChange=function(e){var a=t.props,n=a.onOptionsChange,r=a.options,i=o(o({},r.jsonData),{afserver:e.target.value});n(o(o({},r),{jsonData:i}))},t.onAFDatabaseChange=function(e){var a=t.props,n=a.onOptionsChange,r=a.options,i=o(o({},r.jsonData),{afdatabase:e.target.value});n(o(o({},r),{jsonData:i}))},t.onMyOptionsChange=function(e){(0,t.props.onOptionsChange)(b(e))},t}return l(t,e),t.prototype.render=function(){var e=this.props.options,t=b(e);return d.a.createElement("div",null,d.a.createElement(h.DataSourceHttpSettings,{defaultUrl:"https://server.name/webapi",dataSourceConfig:t,onChange:this.onMyOptionsChange,showAccessOptions:!0}),d.a.createElement("h3",{className:"page-heading"},"PI/AF Connection Details"),d.a.createElement("div",{className:"gf-form-group"},d.a.createElement("div",{className:"gf-form"},d.a.createElement(v,{label:"PI Server",labelWidth:10,inputWidth:25,onChange:this.onPIServerChange,value:t.jsonData.piserver||"",placeholder:"Default PI Server to use for data requests"})),d.a.createElement("div",{className:"gf-form"},d.a.createElement(v,{label:"AF Server",labelWidth:10,inputWidth:25,onChange:this.onAFServerChange,value:t.jsonData.afserver||"",placeholder:"Default AF Server to use for data requests"})),d.a.createElement("div",{className:"gf-form"},d.a.createElement(v,{label:"AF Database",labelWidth:10,inputWidth:25,onChange:this.onAFDatabaseChange,value:t.jsonData.afdatabase||"",placeholder:"Default AF Database server for AF queries"}))))},t}(p.PureComponent),g=a(1),y=function(e){var t=e.label,a=e.labelWidth,n=void 0===a?12:a,r=e.tooltip,i=e.children;return d.a.createElement(d.a.Fragment,null,d.a.createElement(h.InlineFormLabel,{width:n,tooltip:r},t),i)},S=function(){return d.a.createElement("div",{className:"gf-form gf-form--grow"},d.a.createElement("div",{className:"gf-form-label gf-form-label--grow"}))},P=function(e){var t=s(e,[]);return d.a.createElement(E,null,d.a.createElement(y,o({},t)))},E=function(e){return d.a.createElement("div",{className:"gf-form-inline"},e.children,d.a.createElement(S,null))},I=function(e){var t=s(e,[]);return d.a.createElement(C,null,d.a.createElement(y,o({},t)))},C=function(e){return d.a.createElement(d.a.Fragment,null,e.children)},O={target:";",attributes:[],segments:[],regex:{enable:!1},summary:{types:[],basis:"EventWeighted",interval:"",nodata:"Null"},expression:"",interpolate:{enable:!1},recordedValues:{enable:!1},digitalStates:{enable:!1},isPiPoint:!1},j=function(e){var t=e.isRaw,a=e.onChange,n=m(Object(p.useState)(!1),2),r=n[0],i=n[1];return Object(p.useEffect)((function(){i(!1)}),[t]),t?d.a.createElement(d.a.Fragment,null,d.a.createElement(h.Button,{"aria-label":"Switch to visual editor",icon:"pen",variant:"secondary",type:"button",onClick:function(){i(!0)}}),d.a.createElement(h.ConfirmModal,{isOpen:r,title:"Switch to visual editor mode",body:"Are you sure to switch to visual editor mode? You will lose the changes done in raw query mode.",confirmText:"Yes, switch to editor mode",dismissText:"No, stay in raw query mode",onConfirm:function(){a(!1)},onDismiss:function(){i(!1)}})):d.a.createElement(h.Button,{"aria-label":"Switch to text editor",icon:"pen",variant:"secondary",type:"button",onClick:function(){a(!0)}})},x=function(e){var t;return e.value?d.a.createElement("div",{className:"gf-form-label "+("template"===e.value.type?"query-keyword":"")},null!==(t=e.label)&&void 0!==t?t:"--no label--"):d.a.createElement("a",{className:"gf-form-label query-part"},d.a.createElement(h.Icon,{name:"plus"}))},w=function(e){function t(t){var a=e.call(this,t)||this;return a.piServer=[],a.availableAttributes={},a.state={isPiPoint:!1,segments:[],attributes:[],summaries:[],attributeSegment:{},summarySegment:{},calculationBasisSegment:{},noDataReplacementSegment:{}},a.segmentChangeValue=function(e){var t=a.props.query;a.setState({segments:e},(function(){return a.onChange(o(o({},t),{segments:e}))}))},a.attributeChangeValue=function(e){var t=a.props.query;a.setState({attributes:e},(function(){return a.onChange(o(o({},t),{attributes:e}))}))},a.onPiPointChange=function(e,t){var n=a.state.attributes.slice(0);"-REMOVE-"===e.label?Object(g.remove)(n,(function(e,a){return a===t})):n[t]=e,a.checkPiPointSegments(e,n)},a.onAttributeChange=function(e,t){var n=a.state.attributes.slice(0);n[t]=e,a.checkAttributeSegments(n,a.state.segments)},a.onSegmentChange=function(e,t){var n,r,i=a.props.query,l=a.state.segments.slice(0);return"-REMOVE-"===e.label?(l=Object(g.slice)(l,0,t),a.checkAttributeSegments([],l),0===l.length?l.push({label:""}):(null===(n=l[l.length-1].value)||void 0===n?void 0:n.expandable)&&l.push({label:"Select Element",value:{value:"-Select Element-"}}),i.isPiPoint&&(a.piServer=[]),void a.segmentChangeValue(l)):(l[t]=e,i.isPiPoint?(a.piServer.push(e),void a.segmentChangeValue(l)):(t<l.length-1&&(l=Object(g.slice)(l,0,t+1)),a.checkAttributeSegments([],l),(null===(r=e.value)||void 0===r?void 0:r.expandable)&&l.push({label:"Select Element",value:{value:"-Select Element-"}}),void a.segmentChangeValue(l)))},a.getElementSegments=function(e){var t,n,r,i=a.props,l=i.datasource,o=i.query,s=a,u=o.isPiPoint?{type:"dataserver"}:{path:a.getSegmentPathUpTo(a.state.segments.slice(0),e)};if(!o.isPiPoint){if((null===(t=l.afserver)||void 0===t?void 0:t.name)&&0===e)return Promise.resolve([{label:l.afserver.name,value:{value:l.afserver.name,expandable:!0}}]);if((null===(n=l.afserver)||void 0===n?void 0:n.name)&&(null===(r=l.afdatabase)||void 0===r?void 0:r.name)&&1===e)return Promise.resolve([{label:l.afdatabase.name,value:{value:l.afdatabase.name,expandable:!0}}])}return l.metricFindQuery(u,{isPiPoint:o.isPiPoint}).then((function(e){var t=Object(g.map)(e,(function(e){return{label:e.text,value:{webId:e.WebId,value:e.text,expandable:!o.isPiPoint&&e.expandable}}}));if(0===t.length)return t;var a=l.templateSrv.getVariables();return Object(g.each)(a,(function(e){var a={label:"${"+e.name+"}",value:{type:"template",value:"${"+e.name+"}",expandable:!o.isPiPoint}};t.unshift(a)})),t.unshift({label:"-REMOVE-",value:{value:"-REMOVE-"}}),t})).catch((function(e){return s.error=e.message||"Failed to issue metric query",[]}))},a.getAttributeSegmentsPI=function(e){var t=a.props,n=t.datasource,r=t.query,i=a,l={path:"",webId:a.getSelectedPIServer(),pointName:(null!=e?e:"")+"*",type:"pipoint"},o=[];return n.metricFindQuery(l,{isPiPoint:r.isPiPoint}).then((function(t){return(o=Object(g.map)(t,(function(e){return{path:e.Path,label:e.text,value:{value:e.text,expandable:!1}}}))).unshift({label:e,value:{value:e,expandable:!1}}),o.unshift({label:"-REMOVE-",value:{value:"-REMOVE-"}}),o})).catch((function(e){return i.error=e.message||"Failed to issue metric query",o}))},a.getAttributeSegmentsAF=function(e){var t=a,n=[];return Object(g.forOwn)(t.availableAttributes,(function(e,t){var a={label:t,value:{value:t,expandable:!0}};n.push(a)})),n.unshift({label:"-REMOVE-",value:{value:"-REMOVE-"}}),n},a.buildFromTarget=function(e,t,n){var r=e.target.split(";"),i=r.length>0?r[0].split("\\"):[];return i.length>1||1===i.length&&""!==i[0]?(r.splice(0,1),Object(g.each)(i,(function(e,a){t.push({label:e,value:{value:e,expandable:!0}})})),Object(g.each)(r,(function(e,t){""!==e&&n.push({label:e,value:{value:e,expandable:!1}})})),a.getElementSegments(t.length+1).then((function(e){return e.length>0&&t.push({label:"Select Element",value:{value:"-Select Element-"}}),t}))):Promise.resolve(t)},a.checkAfServer=function(){var e,t,n=a.props.datasource,r=[];return(null===(e=n.afserver)||void 0===e?void 0:e.name)?(r.push({label:n.afserver.name,value:{value:n.afserver.name,expandable:!0}}),(null===(t=n.afdatabase)||void 0===t?void 0:t.name)&&r.push({label:n.afdatabase.name,value:{value:n.afdatabase.name,expandable:!0}}),r.push({label:"Select Element",value:{value:"-Select Element-"}})):r.push({label:""}),r},a.updateArray=function(e,t,n,r,i){a.setState({segments:e,attributes:t,summaries:n,isPiPoint:r},(function(){return a.checkAttributeSegments(t,a.state.segments).then((function(){i&&i()}))}))},a.componentDidMount=function(){var e,t,n,r=a.props.query,i=Object(g.defaults)(r,O),l=i.segments,o=i.attributes,s=i.summary,u=i.isPiPoint,c=null!==(e=null==l?void 0:l.slice(0))&&void 0!==e?e:[],m=null!==(t=null==o?void 0:o.slice(0))&&void 0!==t?t:[],p=null!==(n=null==s?void 0:s.types)&&void 0!==n?n:[];if(u||0!==c.length)u&&c.length>0&&(a.piServer=c);else{if(r.target&&r.target.length>0&&";"!==r.target)return m=[],void a.buildFromTarget(r,c,m).then((function(e){a.updateArray(e,m,p,u)})).catch((function(e){}));c=a.checkAfServer()}a.updateArray(c,m,p,u,(function(){a.onChange(r)}))},a.onChange=function(e){var t,n=a.props,r=n.onChange,i=n.onRunQuery;if(e.summary.types=a.state.summaries,e.rawQuery){if(e.target=null!==(t=e.query)&&void 0!==t?t:"",""!==e.target){var l=e.target.split(";"),o=l[0].split("\\");l.splice(0,1),e.attributes=[],(o.length>1||1===o.length&&""!==o[0])&&(e.elementPath=o.join("\\"),Object(g.each)(l,(function(t,a){""!==t&&e.attributes.push({label:t,value:{value:t,expandable:!1}})})))}}else e.elementPath=a.getSegmentPathUpTo(a.state.segments,a.state.segments.length),e.target=e.elementPath+";"+Object(g.join)(e.attributes.map((function(e){var t;return null===(t=e.value)||void 0===t?void 0:t.value})),";");r(e),e.target&&e.target.length>0&&e.attributes.length>0&&i()},a.stateCallback=function(){var e=a.props.query;a.onChange(e)},a.onIsPiPointChange=function(e){var t=a.props.query,n=!t.isPiPoint;a.setState({segments:n?[{label:""}]:a.checkAfServer(),attributes:[],isPiPoint:n},(function(){a.onChange(o(o({},t),{expression:"",attributes:a.state.attributes,segments:a.state.segments,isPiPoint:n}))}))},a.onSegmentChange=a.onSegmentChange.bind(a),a.calcBasisValueChanged=a.calcBasisValueChanged.bind(a),a.calcNoDataValueChanged=a.calcNoDataValueChanged.bind(a),a.onSummaryAction=a.onSummaryAction.bind(a),a.onSummaryValueChanged=a.onSummaryValueChanged.bind(a),a.onAttributeAction=a.onAttributeAction.bind(a),a.onAttributeChange=a.onAttributeChange.bind(a),a.summaryTypes=["Total","Average","Minimum","Maximum","Range","StdDev","PopulationStdDev","Count","PercentGood","All","AllForNonNumeric"],a.calculationBasis=["TimeWeighted","EventWeighted","TimeWeightedContinuous","TimeWeightedDiscrete","EventWeightedExcludeMostRecentEvent","EventWeightedExcludeEarliestEvent","EventWeightedIncludeBothEnds"],a.noDataReplacement=["Null","Drop","Previous","0","Keep"],a}return l(t,e),t.prototype.isValueEmpty=function(e){return!e||!e.value||!e.value.length||"-REMOVE-"===e.value},t.prototype.calcBasisValueChanged=function(e){var t,a=this.props.query,n=a.summary;n.basis=null===(t=e.value)||void 0===t?void 0:t.value,this.onChange(o(o({},a),{summary:n}))},t.prototype.getCalcBasisSegments=function(){return Object(g.map)(this.calculationBasis,(function(e){return{label:e,value:{value:e,expandable:!0}}}))},t.prototype.calcNoDataValueChanged=function(e){var t,a=this.props.query,n=a.summary;n.nodata=null===(t=e.value)||void 0===t?void 0:t.value,this.onChange(o(o({},a),{summary:n}))},t.prototype.getNoDataSegments=function(){return Object(g.map)(this.noDataReplacement,(function(e){return{label:e,value:{value:e,expandable:!0}}}))},t.prototype.onSummaryValueChanged=function(e,t){var a=this.state.summaries.slice(0);a[t]=e,this.isValueEmpty(e.value)&&a.splice(t,1),this.setState({summaries:a},this.stateCallback)},t.prototype.getSummarySegments=function(){var e=this,t=Object(g.filter)(this.summaryTypes,(function(t){return-1===e.state.summaries.map((function(e){var t;return null===(t=e.value)||void 0===t?void 0:t.value})).indexOf(t)})),a=Object(g.map)(t,(function(e){return{label:e,value:{value:e,expandable:!0}}}));return a.unshift({label:"-REMOVE-",value:{value:"-REMOVE-"}}),a},t.prototype.removeSummary=function(e){var t=Object(g.filter)(this.state.summaries,(function(t){return t!==e}));this.setState({summaries:t})},t.prototype.onSummaryAction=function(e){var t,a=this.state.summaries.slice(0);if(!this.isValueEmpty(e.value)){var n={label:e.label,value:{value:null===(t=e.value)||void 0===t?void 0:t.value,expandable:!0}};a.push(n)}this.setState({summarySegment:{},summaries:a},this.stateCallback)},t.prototype.removeAttribute=function(e){var t=Object(g.filter)(this.state.attributes,(function(t){return t!==e}));this.attributeChangeValue(t)},t.prototype.onAttributeAction=function(e){var t,a=this.props.query,n=this.state.attributes.slice(0);if(!this.isValueEmpty(e.value)){var r={label:e.label,value:{value:null===(t=e.value)||void 0===t?void 0:t.value,expandable:!a.isPiPoint}};n.push(r)}this.attributeChangeValue(n)},t.prototype.getSegmentPathUpTo=function(e,t){var a=e.slice(0,t);return Object(g.reduce)(a,(function(e,t){var a;return t.value?(null===(a=t.value.value)||void 0===a?void 0:a.startsWith("-Select"))?e:e?e+"\\"+t.value.value:t.value.value:""}),"")},t.prototype.checkAttributeSegments=function(e,t){var a=this,n=this.props.datasource,r=this,i={path:this.getSegmentPathUpTo(t.slice(0),t.length),type:"attributes"};return n.metricFindQuery(i,{isPiPoint:!1}).then((function(t){var i={};Object(g.each)(t,(function(e){i[e.Path.substring(e.Path.indexOf("|")+1)]=e.WebId}));var l=Object(g.filter)(e,(function(e){var t,a=n.templateSrv.replace(null===(t=e.value)||void 0===t?void 0:t.value);return void 0!==i[a]}));r.availableAttributes=i,a.attributeChangeValue(l)})).catch((function(t){r.error=t.message||"Failed to issue metric query",a.attributeChangeValue(e)}))},t.prototype.checkPiPointSegments=function(e,t){var a=this.props.datasource,n=this,r={path:e.path,webId:n.getSelectedPIServer(),pointName:e.label,type:"pipoint"};return a.metricFindQuery(r,{isPiPoint:!0}).then((function(){n.attributeChangeValue(t)})).catch((function(e){n.error=e.message||"Failed to issue metric query",n.attributeChangeValue([])}))},t.prototype.getSelectedPIServer=function(){var e,t=this,a="";return this.piServer.forEach((function(e){var n=t.props.query.target.split(";");n.length>=2&&n[0]===e.text&&(a=e.WebId)})),this.piServer.length>0?null===(e=this.piServer[0].value)||void 0===e?void 0:e.webId:a},t.prototype.textEditorChanged=function(){var e=this,t=this.props,a=t.query,n=t.onChange,r=a.target.split(";"),i=r.length>0?r[0].split("\\"):[],l=[],s=[];i.length>1||1===i.length&&""!==i[0]?(r.splice(0,1),Object(g.each)(i,(function(e,t){l.push({label:e,value:{type:e.match(/\${\w+}/gi)?"template":void 0,value:e,expandable:!0}})})),this.getElementSegments(l.length+1).then((function(e){e.length>0&&l.push({label:"Select Element",value:{value:"-Select Element-"}})})),Object(g.each)(r,(function(e,t){""!==e&&s.push({label:e,value:{value:e,expandable:!1}})})),this.updateArray(l,s,this.state.summaries,a.isPiPoint,(function(){n(o(o({},a),{query:void 0,rawQuery:!1}))}))):(l=this.checkAfServer(),this.updateArray(l,this.state.attributes,this.state.summaries,a.isPiPoint,(function(){e.onChange(o(o({},a),{query:void 0,rawQuery:!1,attributes:e.state.attributes,segments:e.state.segments}))})))},t.prototype.render=function(){var e=this,t=this.props,a=t.query,n=t.onChange,r=t.onRunQuery,i=Object(g.defaults)(a,O),l=i.interpolate,s=i.query,u=i.rawQuery,c=i.digitalStates,m=i.recordedValues,p=i.expression,v=i.isPiPoint,b=i.summary,f=i.display,y=i.regex;return d.a.createElement(d.a.Fragment,null,d.a.createElement(h.InlineField,{label:"Is Pi Point?",labelWidth:24},d.a.createElement(h.InlineSwitch,{value:v,onChange:this.onIsPiPointChange})),!!u&&d.a.createElement(h.InlineFieldRow,null,d.a.createElement(h.InlineField,{label:"Raw Query",labelWidth:24,grow:!0},d.a.createElement(h.Input,{onBlur:this.stateCallback,value:s,onChange:function(e){return n(o(o({},i),{query:e.target.value}))},placeholder:"enter query"})),d.a.createElement(j,{isRaw:!0,onChange:function(t){return e.textEditorChanged()}})),!u&&d.a.createElement(d.a.Fragment,null,d.a.createElement("div",{className:"gf-form-inline"},d.a.createElement(I,{label:v?"PI Server":"AF Elements",tooltip:v?"Select PI server.":"Select AF Element."},this.state.segments.map((function(t,a){return d.a.createElement(h.SegmentAsync,{key:"element-"+a,Component:d.a.createElement(x,{value:t.value,label:t.label}),onChange:function(t){return e.onSegmentChange(t,a)},loadOptions:function(t){return e.getElementSegments(a)},allowCustomValue:!0,inputMinWidth:200})})),d.a.createElement(S,null),!v&&d.a.createElement(j,{isRaw:!1,onChange:function(e){n(o(o({},i),{query:i.target,rawQuery:e}))}}))),d.a.createElement(P,{label:v?"Pi Points":"Attributes"},this.state.attributes.map((function(t,a){return v?d.a.createElement(h.SegmentAsync,{key:"attributes-"+a,Component:d.a.createElement(x,{value:t.value,label:t.label}),disabled:0===e.piServer.length,onChange:function(t){return e.onPiPointChange(t,a)},loadOptions:e.getAttributeSegmentsPI,reloadOptionsOnChange:!0,allowCustomValue:!0,inputMinWidth:250}):d.a.createElement(h.Segment,{key:"attributes-"+a,Component:d.a.createElement(x,{value:t.value,label:t.label}),disabled:e.state.segments.length<=2,onChange:function(t){return e.onAttributeChange(t,a)},options:e.getAttributeSegmentsAF(),allowCustomValue:!0,inputMinWidth:250})})),v&&d.a.createElement(h.SegmentAsync,{Component:d.a.createElement(x,{value:this.state.attributeSegment.value,label:this.state.attributeSegment.label}),disabled:0===this.piServer.length,onChange:this.onAttributeAction,loadOptions:this.getAttributeSegmentsPI,reloadOptionsOnChange:!0,allowCustomValue:!0,inputMinWidth:250}),!v&&d.a.createElement(h.Segment,{Component:d.a.createElement(x,{value:this.state.attributeSegment.value,label:this.state.attributeSegment.label}),disabled:this.state.segments.length<=2,onChange:this.onAttributeAction,options:this.getAttributeSegmentsAF(),allowCustomValue:!0,inputMinWidth:250}))),!v&&d.a.createElement(h.InlineField,{label:"Calculation",labelWidth:24,tooltip:"Modify all attributes by an equation. Use '.' for current item. Leave Attributes empty if you wish to perform element based calculations."},d.a.createElement(h.Input,{onBlur:r,value:p,onChange:function(t){return e.onChange(o(o({},i),{expression:t.target.value}))},placeholder:"'.'*2"})),d.a.createElement(h.InlineFieldRow,null,d.a.createElement(h.InlineField,{label:"Max Recorded Values",labelWidth:24,tooltip:"Maximum number of recorded value to retrive from the data archive, without using interpolation."},d.a.createElement(h.Input,{onBlur:r,value:m.maxNumber,onChange:function(t){return e.onChange(o(o({},i),{recordedValues:o(o({},m),{maxNumber:parseInt(t.target.value,10)})}))},type:"number",placeholder:"150000"})),d.a.createElement(h.InlineField,{label:"Recorded Values",labelWidth:24},d.a.createElement(h.InlineSwitch,{value:m.enable,onChange:function(){return e.onChange(o(o({},i),{recordedValues:o(o({},m),{enable:!m.enable})}))}})),d.a.createElement(h.InlineField,{label:"Digital States",labelWidth:24},d.a.createElement(h.InlineSwitch,{value:c.enable,onChange:function(){return e.onChange(o(o({},i),{digitalStates:o(o({},c),{enable:!c.enable})}))}}))),d.a.createElement(h.InlineFieldRow,null,d.a.createElement(h.InlineField,{label:"Interpolate Period",labelWidth:24,tooltip:"Override time between sampling, e.g. '30s'. Defaults to timespan/chart width."},d.a.createElement(h.Input,{onBlur:r,value:l.interval,onChange:function(t){return e.onChange(o(o({},i),{interpolate:o(o({},l),{interval:t.target.value})}))},placeholder:"30s"})),d.a.createElement(h.InlineField,{label:"Interpolate",labelWidth:24},d.a.createElement(h.InlineSwitch,{value:l.enable,onChange:function(){return e.onChange(o(o({},i),{interpolate:o(o({},l),{enable:!l.enable})}))}})),d.a.createElement(h.InlineField,{label:"Replace Bad Data",labelWidth:24,tooltip:"Replacement for bad quality values."},d.a.createElement(h.Segment,{Component:d.a.createElement(x,{value:{value:b.nodata},label:b.nodata}),onChange:this.calcNoDataValueChanged,options:this.getNoDataSegments(),allowCustomValue:!0}))),d.a.createElement(h.InlineFieldRow,null,d.a.createElement(h.InlineField,{label:"Summary Period",labelWidth:24,tooltip:"Override time between sampling, e.g. '30s'."},d.a.createElement(h.Input,{onBlur:r,value:b.interval,onChange:function(e){return n(o(o({},i),{summary:o(o({},b),{interval:e.target.value})}))},placeholder:"30s"})),d.a.createElement(h.InlineField,{label:"Basis",labelWidth:24,tooltip:"Defines the possible calculation options when performing summary calculations over time-series data."},d.a.createElement(h.Segment,{Component:d.a.createElement(x,{value:{value:b.basis},label:b.basis}),onChange:this.calcBasisValueChanged,options:this.getCalcBasisSegments(),allowCustomValue:!0})),d.a.createElement(h.InlineField,{label:"Summaries",labelWidth:24,tooltip:"Replacement for bad quality values."},d.a.createElement(h.InlineFieldRow,null,this.state.summaries.map((function(t,a){return d.a.createElement(h.Segment,{key:"summaries-"+a,Component:d.a.createElement(x,{value:t.value,label:t.label}),onChange:function(t){return e.onSummaryValueChanged(t,a)},options:e.getSummarySegments(),allowCustomValue:!0})})),d.a.createElement(h.Segment,{Component:d.a.createElement(x,{value:this.state.summarySegment.value,label:this.state.summarySegment.label}),onChange:this.onSummaryAction,options:this.getSummarySegments(),allowCustomValue:!0})))),d.a.createElement(h.InlineFieldRow,null,d.a.createElement(h.InlineField,{label:"Display Name",labelWidth:24,tooltip:"If single attribute, modify display name. Otherwise use regex to modify display name."},d.a.createElement(h.Input,{onBlur:r,value:f,onChange:function(t){return e.onChange(o(o({},i),{display:t.target.value}))},placeholder:"Display"})),d.a.createElement(h.InlineField,{label:"Enable Regex Replace",labelWidth:24},d.a.createElement(h.InlineSwitch,{value:y.enable,onChange:function(){e.onChange(o(o({},i),{regex:o(o({},y),{enable:!y.enable})}))}})),d.a.createElement(h.InlineField,{label:"Search",labelWidth:16},d.a.createElement(h.Input,{onBlur:r,value:y.search,onChange:function(t){return e.onChange(o(o({},i),{regex:o(o({},y),{search:t.target.value})}))},placeholder:"(.*)"})),d.a.createElement(h.InlineField,{label:"Replace",labelWidth:16},d.a.createElement(h.Input,{onBlur:r,value:y.replace,onChange:function(t){return e.onChange(o(o({},i),{regex:o(o({},y),{replace:t.target.value})}))},placeholder:"$1"}))))},t}(p.PureComponent),A=a(4);function V(e){return(V="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}var F=function(e){function t(t){var a,n=e.call(this,t)||this;return n.isProxy=!1,n.webidCache=new Map,n.basicAuth=t.basicAuth,n.withCredentials=t.withCredentials,n.url=t.url,n.name=t.name,n.templateSrv=Object(A.getTemplateSrv)(),n.backendSrv=Object(A.getBackendSrv)(),n.piwebapiurl=null===(a=t.jsonData.url)||void 0===a?void 0:a.toString(),n.isProxy=/^http(s)?:\/\//.test(n.url)||"proxy"===t.jsonData.access,n.piserver={name:(t.jsonData||{}).piserver,webid:void 0},n.afserver={name:(t.jsonData||{}).afserver,webid:void 0},n.afdatabase={name:(t.jsonData||{}).afdatabase,webid:void 0},Promise.all([n.getAssetServer(n.afserver.name).then((function(e){return n.afserver.webid=e.WebId})),n.getDataServer(n.piserver.name).then((function(e){return n.piserver.webid=e.WebId})),n.getDatabase(n.afserver.name+"\\"+n.afdatabase.name).then((function(e){return n.afdatabase.webid=e.WebId}))]),n}return l(t,e),t.prototype.eventFrameToAnnotation=function(e,t,a,n){e.regex&&e.regex.enable&&(a.Name=a.Name.replace(new RegExp(e.regex.search),e.regex.replace));var r="";return n&&Object(g.each)(n,(function(e){var t=e.Value.Value?e.Value.Value.Name||e.Value.Value.Value||e.Value.Value:null;r+="<br />"+e.Name+": "+t})),{annotation:e,title:(t?"END ":e.showEndTime?"START ":"")+e.name,time:new Date(t?a.EndTime:a.StartTime).getTime(),text:a.Name+r+"<br />Start: "+a.StartTime+"<br />End: "+a.EndTime}},t.prototype.buildQueryParameters=function(e){var t=this;return e.targets=Object(g.filter)(e.targets,(function(e){return!(!e||!e.target)&&!e.target.startsWith("Select AF")})),e.targets=Object(g.map)(e.targets,(function(a){var n=t,r={target:t.templateSrv.replace(a.elementPath,e.scopedVars),elementPath:t.templateSrv.replace(a.elementPath,e.scopedVars),elementPathArray:[t.templateSrv.replace(a.elementPath,e.scopedVars)],attributes:Object(g.map)(a.attributes,(function(a){var n;return t.templateSrv.replace((null===(n=a.value)||void 0===n?void 0:n.value)||a,e.scopedVars)})),segments:Object(g.map)(a.segments,(function(a){var n;return t.templateSrv.replace(null===(n=a.value)||void 0===n?void 0:n.value,e.scopedVars)})),display:a.display,refId:a.refId,hide:a.hide,interpolate:a.interpolate||{enable:!1},recordedValues:a.recordedValues||{enable:!1},digitalStates:a.digitalStates||{enable:!1},webid:a.webid,webids:a.webids||[],regex:a.regex||{enable:!1},expression:a.expression||"",summary:a.summary||{types:[]},startTime:e.range.from,endTime:e.range.to,isPiPoint:a.isPiPoint,scopedVars:e.scopedVars};r.expression&&(r.expression=t.templateSrv.replace(r.expression,e.scopedVars)),void 0!==r.summary.types&&(r.summary.types=Object(g.filter)(r.summary.types,(function(e){return null!=e&&""!==e})));var i=Object(g.keys)(e.scopedVars);return t.templateSrv.getVariables().forEach((function(e){if(n.isAllSelected(e.current)&&i.indexOf(e.name)<0){var t=e.options.filter((function(e){return!e.selected}));r.attributes=r.attributes.map((function(a){return t.map((function(t){return a.replace("{"+e.query+"}",t.value)}))})),r.attributes=Object(g.uniq)(Object(g.flatten)(r.attributes)),r.elementPathArray=r.elementPathArray.map((function(a){return t.map((function(t){return a.replace("{"+e.query+"}",t.value)}))})),r.elementPathArray=Object(g.uniq)(Object(g.flatten)(r.elementPathArray))}else if(Array.isArray(e.current.text)&&i.indexOf(e.name)<0){var a=e.options.filter((function(e){return e.selected})),l=e.current.value.join(",");r.attributes=r.attributes.map((function(e){return a.map((function(t){return e.replace("{"+l+"}",t.value)}))})),r.attributes=Object(g.uniq)(Object(g.flatten)(r.attributes)),r.elementPathArray=r.elementPathArray.map((function(e){return a.map((function(t){return e.replace("{"+l+"}",t.value)}))})),r.elementPathArray=Object(g.uniq)(Object(g.flatten)(r.elementPathArray))}})),r})),e},t.prototype.isAllSelected=function(e){return!!e&&(Array.isArray(e.text)?e.text.indexOf("All")>=0:"All"===e.text)},t.prototype.query=function(e){return u(this,void 0,Promise,(function(){var t,a;return c(this,(function(r){return t=this,(a=this.buildQueryParameters(e)).targets=Object(g.filter)(a.targets,(function(e){return!e.hide})),a.targets.length<=0?[2,Promise.resolve({data:[]})]:[2,Promise.all(t.getStream(a)).then((function(e){var t=[];return Object(g.each)(e,(function(e){Object(g.each)(e,(function(e){return t.push(e)}))})),{data:t.sort((function(e,t){return+(e.target>t.target)||+(e.target===t.target)-1})).map((function(e){return Object(n.toDataFrame)(e)}))}}))]}))}))},t.prototype.testDatasource=function(){return this.backendSrv.datasourceRequest({url:this.url+"/",method:"GET"}).then((function(e){if(200===e.status)return{status:"success",message:"Data source is working",title:"Success"};throw new Error("Failed")}))},t.prototype.annotationQuery=function(e){var t=this;if(!this.afdatabase.webid)return Promise.resolve([]);var a=e.annotation.query.categoryName?this.templateSrv.replace(e.annotation.query.categoryName,e.scopedVars,"glob"):null,n=e.annotation.query.nameFilter?this.templateSrv.replace(e.annotation.query.nameFilter,e.scopedVars,"glob"):null,r=e.annotation.template?e.annotation.template.Name:null,i={name:e.annotation.name,datasource:e.annotation.datasource,enable:e.annotation.enable,iconColor:e.annotation.iconColor,showEndTime:e.annotation.showEndTime,regex:e.annotation.regex,attribute:e.annotation.attribute,categoryName:a,templateName:r,nameFilter:n},l=[];if(i.categoryName&&l.push("categoryName="+i.categoryName),i.nameFilter&&l.push("nameFilter="+i.nameFilter),i.templateName&&l.push("templateName="+i.templateName),!l.length)return Promise.resolve([]);if(l.push("startTime="+e.range.from.toJSON()),l.push("endTime="+e.range.to.toJSON()),i.attribute&&i.attribute.enable){var o=this.piwebapiurl+"/streamsets/{0}/value?selectedFields=Items.WebId;Items.Value;Items.Name";i.attribute.name&&(o=this.piwebapiurl+"/streamsets/{0}/value?nameFilter="+i.attribute.name+"&selectedFields=Items.WebId;Items.Value;Items.Name");var s={};return s[1]={Method:"GET",Resource:this.piwebapiurl+"/assetdatabases/"+this.afdatabase.webid+"/eventframes?"+l.join("&")},s[2]={Method:"GET",RequestTemplate:{Resource:o},Parameters:["$.1.Content.Items[*].WebId"],ParentIds:["1"]},this.restBatch(s).then((function(a){var n=a.data[1].Content,r=a.data[2].Content,l=Object(g.map)(n.Items,(function(e,a){return Object(g.curry)(t.eventFrameToAnnotation)(i,!1,e,r.Items[a].Content.Items)}));if(e.annotation.showEndTime){var o=Object(g.map)(n.Items,(function(e,a){return Object(g.curry)(t.eventFrameToAnnotation)(i,!0,e,r.Items[a].Content.Items)}));Object(g.each)(o,(function(e){l.push(e)}))}return l}))}return this.restGet("/assetdatabases/"+this.afdatabase.webid+"/eventframes?"+l.join("&")).then((function(a){var n=Object(g.map)(a.data.Items,Object(g.curry)(t.eventFrameToAnnotation)(i,!1));if(e.annotation.showEndTime){var r=Object(g.map)(a.data.Items,Object(g.curry)(t.eventFrameToAnnotation)(i,!0));Object(g.each)(r,(function(e){n.push(e)}))}return n}))},t.prototype.metricQueryTransform=function(e){return Object(g.map)(e,(function(e){var t,a;return{text:e.Name,expandable:void 0===e.HasChildren||!0===e.HasChildren||(null!==(t=e.Path)&&void 0!==t?t:"").split("\\").length<=3,HasChildren:e.HasChildren,Items:null!==(a=e.Items)&&void 0!==a?a:[],Path:e.Path,WebId:e.WebId}}))},t.prototype.metricFindQuery=function(e,t){var a,n,r=this,i=["servers","databases","databaseElements","elements"];return"string"==typeof e&&(e=JSON.parse(e)),t.isPiPoint?e.path=this.templateSrv.replace(e.path):(""===e.path?e.type=i[0]:"attributes"!==e.type&&(e.type=i[Math.max(0,Math.min(e.path.split("\\").length,i.length-1))]),e.path=this.templateSrv.replace(e.path),e.path=e.path.replace(/\{([^\\])*\}/gm,(function(e){return e.substring(1,e.length-2).split(",")[0]}))),e.filter=null!==(a=e.filter)&&void 0!==a?a:"*","servers"===e.type?(null===(n=r.afserver)||void 0===n?void 0:n.name)?r.getAssetServer(r.afserver.name).then((function(e){return[e]})).then(r.metricQueryTransform):r.getAssetServers().then(r.metricQueryTransform):"databases"===e.type?r.getAssetServer(e.path).then((function(e){var t;return r.getDatabases(null!==(t=e.WebId)&&void 0!==t?t:"",{})})).then(r.metricQueryTransform):"databaseElements"===e.type?r.getDatabase(e.path).then((function(e){var t;return r.getDatabaseElements(null!==(t=e.WebId)&&void 0!==t?t:"",{selectedFields:"Items.WebId;Items.Name;Items.Items;Items.Path;Items.HasChildren"})})).then(r.metricQueryTransform):"elements"===e.type?r.getElement(e.path).then((function(t){var a;return r.getElements(null!==(a=t.WebId)&&void 0!==a?a:"",{selectedFields:"Items.WebId;Items.Name;Items.Items;Items.Path;Items.HasChildren",nameFilter:e.filter})})).then(r.metricQueryTransform):"attributes"===e.type?r.getElement(e.path).then((function(t){var a;return r.getAttributes(null!==(a=t.WebId)&&void 0!==a?a:"",{searchFullHierarchy:"true",selectedFields:"Items.WebId;Items.Name;Items.Path",nameFilter:e.filter})})).then(r.metricQueryTransform):"dataserver"===e.type?r.getDataServers().then(r.metricQueryTransform):"pipoint"===e.type?r.piPointSearch(e.webId,e.pointName).then(r.metricQueryTransform):Promise.reject("Bad type")},t.prototype.getSummaryUrl=function(e){return""===e.interval.trim()?"&summaryType="+e.types.map((function(e){var t;return null===(t=e.value)||void 0===t?void 0:t.value})).join("&summaryType=")+"&calculationBasis="+e.basis:"&summaryType="+e.types.map((function(e){var t;return null===(t=e.value)||void 0===t?void 0:t.value})).join("&summaryType=")+"&calculationBasis="+e.basis+"&summaryDuration="+e.interval.trim()},t.prototype.parsePiPointValueList=function(e,t,a){var n=this,r=this,i=[];return Object(g.each)(e,(function(e){var l=n.noDataReplace(a?e.Value:e,t.summary.nodata,r.parsePiPointValue(a?e.Value:e,t,a)),o=l.grafanaDataPoint;l.previousValue;l.drop||i.push(o)})),i},t.prototype.parsePiPointValue=function(e,t,a){var n=a||"object"!==V(e.Value)?Number(e.Value):Number(e.Value.Value),r=e.Value;return(!e.Good||t.digitalStates&&t.digitalStates.enable)&&(n=a||"object"!==V(e.Value)?e.Name:e.Value.Name),a&&""===t.summary.interval?t.digitalStates&&t.digitalStates.enable?[n,new Date(e.Timestamp).getTime()]:e.Good?[isNaN(n)?0:n,new Date(t.endTime).getTime()]:[n,new Date(e.Timestamp).getTime()]:[isNaN(n)?r:n,new Date(e.Timestamp).getTime()]},t.prototype.noDataReplace=function(e,t,a){var n,r,i=null,l=!1;return!e.Good||"No Data"===e.Value||(null===(n=e.Value)||void 0===n?void 0:n.Name)&&"No Data"===(null===(r=e.Value)||void 0===r?void 0:r.Name)?"Drop"===t?l=!0:"0"===t?a[0]=0:"Keep"===t||("Null"===t?a[0]=null:"Previous"===t&&null!==i&&(a[0]=i)):i=e.Value,{grafanaDataPoint:a,previousValue:i,drop:l}},t.prototype.processResults=function(e,t,a){var n=this,r=t.summary&&t.summary.types&&t.summary.types.length>0;if(t.regex&&t.regex.enable&&(a=a.replace(new RegExp(t.regex.search),t.regex.replace)),r){var i=[],l=Object(g.groupBy)(e.Items,(function(e){return e.Type}));return Object(g.forOwn)(l,(function(e,l){i.push({refId:t.refId,target:a+"["+l+"]",datapoints:n.parsePiPointValueList(e,t,r)})})),i}return[{refId:t.refId,target:a,datapoints:n.parsePiPointValueList(e.Items,t,r)}]},t.prototype.getStream=function(e){var t=this,a=this,n=[];return Object(g.each)(e.targets,(function(r){r.attributes=Object(g.filter)(r.attributes||[],(function(e){return e}));var i="",l=r.summary&&r.summary.types&&r.summary.types.length>0,o=r.interpolate&&r.interpolate.enable,s=r.interpolate.interval?r.interpolate.interval:e.interval,u="?startTime="+e.range.from.toJSON()+"&endTime="+e.range.to.toJSON(),c=r.expression||r.elementPath,m=r.display?t.templateSrv.replace(r.display,e.scopedVars):null;r.expression?(i+="/calculation",i+=l?"/summary"+u+(o?"&sampleType=Interval&sampleInterval="+s:""):"/intervals"+u+"&sampleInterval="+s,i+="&expression="+encodeURIComponent(r.expression),r.attributes.length>0?n.push(a.internalStream(e,r,i)):n.push(a.restGetWebId(r.elementPath,r.isPiPoint).then((function(e){return a.restPost(i+e.WebId).then((function(e){return a.processResults(e.data,r,m||c)})).catch((function(e){return a.error=e}))})))):(i+="/streamsets",l?i+="/summary"+u+"&intervals="+e.maxDataPoints+t.getSummaryUrl(r.summary):r.interpolate&&r.interpolate.enable?i+="/interpolated"+u+"&interval="+s:r.recordedValues&&r.recordedValues.enable?i+="/recorded"+u+"&maxCount="+r.recordedValues.maxNumber:i+="/plot"+u+"&intervals="+e.maxDataPoints,n.push(a.internalStream(e,r,i)))})),n},t.prototype.internalStream=function(e,t,a){var n=this,r=t.expression||t.elementPath,i=t.display?this.templateSrv.replace(t.display,e.scopedVars):null,l=Object(g.map)(t.attributes,(function(e){return 1===t.elementPathArray.length&&t.elementPath===t.elementPathArray[0]?n.restGetWebId(t.elementPath+"|"+e,t.isPiPoint):t.elementPathArray.map((function(a){return n.restGetWebId(a+"|"+e,t.isPiPoint)}))}));return Promise.all(Object(g.flatten)(l)).then((function(e){var l={};return Object(g.each)(e,(function(e,t){l[t+1]={Method:"GET",Resource:n.piwebapiurl+a+"&webid="+e.WebId}})),n.restBatch(l).then((function(a){var l=[];return Object(g.each)(a.data,(function(a,o){if(t.expression){var s=e[parseInt(o,10)-1].Name;Object(g.each)(n.processResults(a.Content,t,i||s||r),(function(e){return l.push(e)}))}else Object(g.each)(a.Content.Items,(function(e){Object(g.each)(n.processResults(e,t,i||e.Name||r),(function(e){return l.push(e)}))}))})),l})).catch((function(e){return n.error=e}))}))},t.prototype.restGet=function(e){return this.backendSrv.datasourceRequest({url:this.url+e,method:"GET",headers:{"Content-Type":"application/json"}}).then((function(e){return e}))},t.prototype.restGetWebId=function(e,t){var a=this,n=a.webidCache.get(e);if(n)return Promise.resolve({Path:e,WebId:n.WebId,Name:n.Name});var r="";return r=t?"/points?selectedFields=WebId;Name;Path&path=\\\\"+e.replace("|","\\"):(e.indexOf("|")>=0?"/attributes?selectedFields=WebId;Name;Path&path=\\\\":"/elements?selectedFields=WebId;Name;Path&path=\\\\")+e,this.backendSrv.datasourceRequest({url:this.url+r,method:"GET",headers:{"Content-Type":"application/json"}}).then((function(t){return a.webidCache.set(e,t.data),{Path:e,WebId:t.data.WebId,Name:t.data.Name}}))},t.prototype.restBatch=function(e){return this.backendSrv.datasourceRequest({url:this.url+"/batch",data:e,method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"message/http"}})},t.prototype.restPost=function(e){return this.backendSrv.datasourceRequest({url:this.url,method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"message/http","X-PIWEBAPI-HTTP-METHOD":"GET","X-PIWEBAPI-RESOURCE-ADDRESS":e}})},t.prototype.getDataServers=function(){return this.restGet("/dataservers").then((function(e){var t;return null!==(t=e.data.Items)&&void 0!==t?t:[]}))},t.prototype.getDataServer=function(e){return e?this.restGet("/dataservers?name="+e).then((function(e){return e.data})):Promise.resolve({})},t.prototype.getAssetServers=function(){return this.restGet("/assetservers").then((function(e){var t;return null!==(t=e.data.Items)&&void 0!==t?t:[]}))},t.prototype.getAssetServer=function(e){return e?this.restGet("/assetservers?path=\\\\"+e).then((function(e){return e.data})):Promise.resolve({})},t.prototype.getDatabase=function(e){return e?this.restGet("/assetdatabases?path=\\\\"+e).then((function(e){return e.data})):Promise.resolve({})},t.prototype.getDatabases=function(e,t){return this.restGet("/assetservers/"+e+"/assetdatabases").then((function(e){var t;return null!==(t=e.data.Items)&&void 0!==t?t:[]}))},t.prototype.getElement=function(e){return this.restGet("/elements?path=\\\\"+e).then((function(e){return e.data}))},t.prototype.getEventFrameTemplates=function(e){return this.restGet("/assetdatabases/"+e+"/elementtemplates?selectedFields=Items.InstanceType;Items.Name;Items.WebId").then((function(e){var t;return Object(g.filter)(null!==(t=e.data.Items)&&void 0!==t?t:[],(function(e){return"EventFrame"===e.InstanceType}))}))},t.prototype.getElementTemplates=function(e){return this.restGet("/assetdatabases/"+e+"/elementtemplates?selectedFields=Items.InstanceType;Items.Name;Items.WebId").then((function(e){var t;return Object(g.filter)(null!==(t=e.data.Items)&&void 0!==t?t:[],(function(e){return"Element"===e.InstanceType}))}))},t.prototype.getAttributes=function(e,t){var a="?"+Object(g.map)(t,(function(e,t){return t+"="+e})).join("&");return"?"===a&&(a=""),this.restGet("/elements/"+e+"/attributes"+a).then((function(e){var t;return null!==(t=e.data.Items)&&void 0!==t?t:[]}))},t.prototype.getDatabaseElements=function(e,t){var a="?"+Object(g.map)(t,(function(e,t){return t+"="+e})).join("&");return"?"===a&&(a=""),this.restGet("/assetdatabases/"+e+"/elements"+a).then((function(e){var t;return null!==(t=e.data.Items)&&void 0!==t?t:[]}))},t.prototype.getElements=function(e,t){var a="?"+Object(g.map)(t,(function(e,t){return t+"="+e})).join("&");return"?"===a&&(a=""),this.restGet("/elements/"+e+"/elements"+a).then((function(e){var t;return null!==(t=e.data.Items)&&void 0!==t?t:[]}))},t.prototype.piPointSearch=function(e,t){var a=this.templateSrv.replace(t),n=""+a,r=!1;if(a!==t)for(var i=/\{([0-9A-Z_a-z]|,)+\}/g,l=void 0;null!==(l=i.exec(a));)l.index===i.lastIndex&&i.lastIndex++,l.forEach((function(e,t){0===t&&(a=a.replace(e,e.replace("{","(").replace("}",")").replace(",","|")),n=n.replace(e,"*"),r=!0)}));return this.restGet("/dataservers/"+e+"/points?maxCount=20&nameFilter="+n).then((function(e){var t;return e&&(null===(t=e.data)||void 0===t?void 0:t.Items)?r?e.data.Items.filter((function(e){var t;return null===(t=e.Name)||void 0===t?void 0:t.match(a)})):e.data.Items:[]}))},t.prototype.getWebId=function(e){var t=e.target.indexOf("\\")>=0,a=e.target.indexOf("|")>=0;return t||-1!==e.target.indexOf(".")?t?t&&a?this.restGet("/attributes?path=\\\\"+e.target).then((function(t){return void 0===t.data||200!==t.status?[{WebId:e.target,Name:e.display||e.target}]:(t.data.Name=e.display||t.data.Name,[t.data])})):this.restGet("/elements?path=\\\\"+e.target).then((function(t){return void 0===t.data||200!==t.status?[{WebId:e.target,Name:e.display||e.target}]:(t.data.Name=e.display||t.data.Name,[t.data])})):this.piPointSearch(this.piserver.webid,e.target).then((function(t){return void 0===t||0===t.length?[{WebId:e.target,Name:e.display||e.target}]:t})):Promise.resolve([{WebId:e.target,Name:e.display||e.target}])},t}(n.DataSourceApi);a.d(t,"plugin",(function(){return T}));var T=new n.DataSourcePlugin(F).setConfigEditor(f).setQueryEditor(w).setAnnotationQueryCtrl(r)}])}));
//# sourceMappingURL=module.js.map