{"version":3,"sources":["../src/query_ctrl.js"],"names":["angular","_","QueryCtrl","PiWebApiDatasourceQueryCtrl","$scope","$injector","uiSegmentSrv","templateSrv","$q","segments","attributes","availableAttributes","piServer","attributeSegment","newPlusButton","summaries","summarySegment","summaryTypes","target","summary","types","basis","interval","nodata","isPiPoint","calculationBasisSegment","newSegment","calculationBasis","noDataReplacementSegment","noDataReplacement","interpolate","enable","recordedValues","digitalStates","textEditorChanged","error","ctrl","oldTarget","oldElement","split","element","getSegmentPathUpTo","length","getAttributes","elementPath","getSummaries","webids","map","attrib","webid","undefined","segmentValue","value","startsWith","panelCtrl","refresh","datasource","getElement","then","results","WebId","splitAttributes","splitElements","splice","each","item","push","expandable","checkOtherSegments","checkAttributeSegments","targetChanged","textEditor","index","arr","slice","reduce","result","segment","webID","forEach","parts","s","text","display","HasChildren","Path","query","path","type","metricFindQuery","toJson","validAttributes","attribute","substring","indexOf","filteredAttributes","filter","changedValue","replace","catch","err","message","fromIndex","getSegmentForValue","children","segmentIndex","focus","func","render","when","part","isValueEmpty","plusButton","html","fake","unshift","attributeText","webId","getSelectedPIServer","pointName","forOwn","items","val","key","altSegments","variables","variable","name","setSegmentFocus","templateUrl"],"mappings":"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","file":"query_ctrl.js","sourceRoot":"gridprotectionalliance-osisoftpi-datasource","sourcesContent":["import angular from 'angular'\nimport _ from 'lodash'\nimport { QueryCtrl } from 'app/plugins/sdk'\nimport './css/query-editor.css!'\n\nexport class PiWebApiDatasourceQueryCtrl extends QueryCtrl {\n\n  constructor ($scope, $injector, uiSegmentSrv, templateSrv, $q) {\n    super($scope, $injector)\n    this.uiSegmentSrv = uiSegmentSrv\n    this.templateSrv = templateSrv\n    this.$q = $q\n    this.segments = []\n    this.attributes = []\n    this.availableAttributes = {}\n    this.piServer = []\n    this.attributeSegment = this.uiSegmentSrv.newPlusButton()\n\n    this.summaries = []\n    this.summarySegment = this.uiSegmentSrv.newPlusButton()\n    this.summaryTypes = [\n      // 'None', // A summary type is not specified.\n      'Total', // A totalization over the time range.\n      'Average', // The average value over the time range.\n      'Minimum', // The minimum value over the time range.\n      'Maximum', // The maximum value over the time range.\n      'Range', // The range value over the time range (minimum-maximum).\n      'StdDev', // The standard deviation over the time range.\n      'PopulationStdDev', // The population standard deviation over the time range.\n      'Count', // The sum of event count over the time range when calculation basis is event weighted. The sum of event time duration over the time range when calculation basis is time weighted.\n      'PercentGood', // Percent of data with good value during the calculation period. For time weighted calculations, the percentage is based on time. For event weighted calculations, the percent is based on event count.\n      'All', // A convenience for requesting all available summary calculations.\n      'AllForNonNumeric' // A convenience for requesting all available summary calculations for non-numeric data.\n    ]\n\n    this.target.summary = this.target.summary || { types: [], basis: 'EventWeighted', interval: '', nodata: 'Null' }\n    this.target.summary.types = this.target.summary.types || []\n    this.target.summary.basis = this.target.summary.basis\n    this.target.summary.nodata = this.target.summary.nodata || 'Null'\n    this.target.summary.interval = this.target.summary.interval || ''\n    this.target.isPiPoint = this.target.isPiPoint || false\n\n    this.calculationBasisSegment = this.uiSegmentSrv.newSegment(this.target.summary.basis)\n    this.calculationBasis = [\n      'TimeWeighted', // Weight the values in the calculation by the time over which they apply. Interpolation is based on whether the attribute is stepped. Interpolated events are generated at the boundaries if necessary.\n      'EventWeighted', // Evaluate values with equal weighting for each event. No interpolation is done. There must be at least one event within the time range to perform a successful calculation. Two events are required for standard deviation. In handling events at the boundary of the calculation, the AFSDK uses following rules:\n      'TimeWeightedContinuous', // Apply weighting as in TimeWeighted, but do all interpolation between values as if they represent continuous data, (standard interpolation) regardless of whether the attribute is stepped.\n      'TimeWeightedDiscrete', // Apply weighting as in TimeWeighted but interpolation between values is performed as if they represent discrete, unrelated values (stair step plot) regardless of the attribute is stepped.\n      'EventWeightedExcludeMostRecentEvent', // The calculation behaves the same as _EventWeighted_, except in the handling of events at the boundary of summary intervals in a multiple intervals calculation. Use this option to prevent events at the intervals boundary from being double count at both intervals. With this option, events at the end time (most recent time) of an interval is not used in that interval.\n      'EventWeightedExcludeEarliestEvent', // Similar to the option _EventWeightedExcludeMostRecentEvent_. Events at the start time(earliest time) of an interval is not used in that interval.\n      'EventWeightedIncludeBothEnds' // Events at both ends of the interval boundaries are included in the event weighted calculation.\n    ]\n\n    this.noDataReplacementSegment = this.uiSegmentSrv.newSegment(this.target.summary.nodata)\n    this.noDataReplacement = [\n      'Null', // replace with nulls\n      'Drop', // drop items\n      'Previous', // use previous value if available\n      '0', // replace with 0\n      'Keep', // Keep value      \n    ]\n\n    this.target.target = this.target.target || ';'\n\n    this.target.interpolate = this.target.interpolate || {enable: false}\n    if (this.target.interpolate === false || this.target.interpolate === true) {\n      this.target.interpolate = { enable: this.target.interpolate }\n    }\n    this.target.interpolate.enable = this.target.interpolate.enable || false\n    \n    this.target.recordedValues = this.target.recordedValues || {enable: false}\n    if (this.target.recordedValues === false || this.target.recordedValues === true) {\n      this.target.recordedValues = { enable: this.target.recordedValues }\n    }\n    this.target.recordedValues.enable = this.target.recordedValues.enable || false\n    \n    this.target.digitalStates = this.target.digitalStates || {enable: false}\n    if (this.target.digitalStates === false || this.target.digitalStates === true) {\n      this.target.digitalStates = { enable: this.target.digitalStates }\n    }\n    this.target.digitalStates.enable = this.target.digitalStates.enable || false\n    \n    // if (this.segments.length === 0) {\n    //   this.segments.push(this.uiSegmentSrv.newSelectMetric())\n    // }\n\n    this.textEditorChanged()\n  }\n\n\n  /**\n   * Queries PI Web API for child elements and attributes when the query segments or options are changed.\n   *  \n   * @memberOf PiWebApiDatasourceQueryCtrl\n   */\n  targetChanged () {\n    if (this.error) { return }\n\n    var ctrl = this\n\n    var oldTarget = this.target.target\n    var oldElement = this.target.target.split(';')[0]\n    var element = this.getSegmentPathUpTo(this.segments.length)\n    var attributes = this.getAttributes()\n    var target = element + ';' + attributes\n    this.target.target = target // _.reduce(this.functions, this.wrapFunction, target)\n    this.target.elementPath = element\n    this.target.attributes = attributes.split(';')\n    this.target.summary.types = this.getSummaries().split(',')\n\n    this.target.webids = _.map(ctrl.target.attributes, attrib => { return ctrl.availableAttributes[attrib] })\n\n    if (element !== oldElement || this.target.webid === undefined) {\n      var segmentValue = this.segments[this.segments.length - 1].value\n      if (!segmentValue.startsWith('Select AF')) {\n        this.panelCtrl.refresh()\n      }\n\n      if (this.target.isPiPoint === false) {\n        this.datasource.getElement(element).then(results => {\n          this.target.webid = results.WebId\n          ctrl.refresh()\n        })\n      }\n    }\n  }\n\n  \n  /**\n   * Queries PI Web API for child elements and attributes when the query text editor is changed.\n   * \n   * \n   * @memberOf PiWebApiDatasourceQueryCtrl\n   */\n  textEditorChanged () {\n    var ctrl = this\n    var splitAttributes = ctrl.target.target.split(';')\n    var splitElements = splitAttributes[0].split('\\\\')\n\n    // remove element hierarchy from attribute collection\n    splitAttributes.splice(0, 1)\n\n    var segments = []\n    var attributes = []\n\n    if (splitElements.length > 1 || (splitElements.length === 1 && splitElements[0] !== '')){\n      _.each(splitElements, function (item) {\n        segments.push(ctrl.uiSegmentSrv.newSegment({ value: item, expandable: true }))\n      })\n    }\n\n    _.each(splitAttributes, function (item) {\n      attributes.push(ctrl.uiSegmentSrv.newSegment({ value: item, expandable: true }))\n    })\n\n    ctrl.segments = segments\n    ctrl.checkOtherSegments(segments.length - 1)\n\n    ctrl.attributes = attributes\n    ctrl.checkAttributeSegments().then(r => {\n      ctrl.targetChanged()\n      ctrl.refresh()\n    })\n\n    var summaries = []\n    _.each(ctrl.target.summary.types, item => {\n      if (item) {\n        summaries.push(ctrl.uiSegmentSrv.newSegment({ value: item, expandable: true }))\n      }\n    })\n    ctrl.summaries = summaries\n  }\n\n  /**\n   * Toggle between segment queries and text editor queries.\n   * \n   * \n   * @memberOf PiWebApiDatasourceQueryCtrl\n   */\n  toggleEditorMode () {\n    this.target.textEditor = !this.target.textEditor\n  }\n\n  /**\n   * Gets the segment information and parses it to a string.\n   * \n   * @param {any} index - Last index of segment to use.\n   * @returns - AF Path or PI Point name.\n   * \n   * @memberOf PiWebApiDatasourceQueryCtrl\n   */\n  getSegmentPathUpTo (index) {\n    var arr = this.segments.slice(0, index)\n\n    return _.reduce(arr, function (result, segment) {\n      if (!segment.value.startsWith('Select AF')) {\n        return result ? (result + '\\\\' + segment.value) : segment.value\n      }\n      return result\n    }, '')\n  }\n\n/**\n   * Gets the webid of the current selected pi data server.\n   * \n   * @memberOf PiWebApiDatasourceQueryCtrl\n   */\n getSelectedPIServer () {\n  var webID = ''\n\n  this.piServer.forEach(s => {\n    var parts = this.target.target.split(';')\n\n    if (parts.length >= 2) {\n      if (parts[0] === s.text) {\n        webID = s.WebId\n        return\n      }\n    }\n  })\n  \n  return webID\n}\n\n/**\n   * Gets the currently selected child attributes.\n   * \n   * @returns - String of selected attributes.\n   * \n   * @memberOf PiWebApiDatasourceQueryCtrl\n   */\n  getAttributes () {\n    var arr = this.attributes.slice(0, this.attributes.length)\n\n    return _.reduce(arr, function (result, segment) {\n      if (!segment.value.startsWith('Select AF')) {\n        return result ? (result + ';' + segment.value) : segment.value\n      }\n      return result\n    }, '')\n  }\n\n  /**\n   * Gets the currently selected summaries.\n   * \n   * @returns - Selected summaries as a string.\n   * \n   * @memberOf PiWebApiDatasourceQueryCtrl\n   */\n  getSummaries () {\n    var arr = this.summaries.slice(0, this.summaries.length)\n\n    return _.reduce(arr, function (result, segment) {\n      if (segment && !segment.value.startsWith('Select AF')) {\n        return result ? (result + ',' + segment.value) : segment.value\n      }\n      return result\n    }, '')\n  }\n\n  /**\n   * Used in converting a query to a string.\n   * \n   * @returns - Query string.\n   * \n   * @memberOf PiWebApiDatasourceQueryCtrl\n   */\n  getCollapsedText () {\n    return '[' + (this.target.display || '') + ']: ' + this.target.target\n  }\n\n  /**\n   * Detects if a metric segment has children.\n   * \n   * @param {any} element - The metric segment to check.\n   * @returns - True if has children or is a server or database, otherwise false.\n   * \n   * @memberOf PiWebApiDatasourceQueryCtrl\n   */\n  isElementSegmentExpandable (element) {\n    return element.HasChildren === undefined || element.HasChildren === true || element.Path.split('\\\\').length <= 3\n  }\n\n  /**\n   * Get the current AF Element's child attributes. Validates when the element selection changes.\n   * \n   * @returns - Collection of attributes.\n   * \n   * @memberOf PiWebApiDatasourceQueryCtrl\n   */\n  checkAttributeSegments () {\n    var ctrl = this\n    var query = {\n      path: this.getSegmentPathUpTo(this.segments.length),\n      type: 'attributes'\n    }\n\n    return this.datasource.metricFindQuery(angular.toJson(query), this.target.isPiPoint)\n    .then(attributes => {\n      var validAttributes = {}\n\n      _.each(attributes, attribute => {\n        validAttributes[attribute.Path.substring(attribute.Path.indexOf('|') + 1)] = attribute.WebId\n      })\n\n      var filteredAttributes = _.filter(ctrl.attributes, attrib => {\n        const changedValue = this.templateSrv.replace(attrib.value)\n        return validAttributes[changedValue] !== undefined\n      })\n\n      if (!ctrl.target.isPiPoint) {\n        ctrl.availableAttributes = validAttributes\n        ctrl.attributes = filteredAttributes\n      }\n    })\n    .catch(err => {\n      ctrl.error = err.message || 'Failed to issue metric query'\n      ctrl.attributes = []\n    })\n  }\n\n  /**\n   * When changing a metric (AF Element) in the query, validates all the children paths.\n   * If the children are different, queries the server for new children and removes any elements after the selected one.\n   * Also validates attributes.\n   * \n   * @param {any} fromIndex\n   * @returns\n   * \n   * @memberOf PiWebApiDatasourceQueryCtrl\n   */\n  checkOtherSegments (fromIndex) {\n    var ctrl = this\n    var query = { path: ctrl.getSegmentPathUpTo(fromIndex + 1) }\n    \n    if (ctrl.segments.length === 0 && ctrl.target.isPiPoint === false) {\n      ctrl.segments.push(ctrl.uiSegmentSrv.getSegmentForValue(null, \"Select AF\"))\n    } else if (ctrl.segments.length === 0 && ctrl.target.isPiPoint === true) {\n      ctrl.segments.push(ctrl.uiSegmentSrv.getSegmentForValue(null, \"Select Dataserver\"))\n    }\n\n    return ctrl.datasource.metricFindQuery(angular.toJson(query), this.target.isPiPoint).then(children => {\n      if (children.length === 0) {\n        if (query.path !== '') {\n          ctrl.segments = ctrl.segments.splice(0, fromIndex + 1)\n          // if (ctrl.segments[ctrl.segments.length - 1].expandable) {\n          //   ctrl.segments.push(ctrl.uiSegmentSrv.getSegmentForValue(null, \"Select AF\"))\n          // }\n        }\n      } else /* if (this.isElementSegmentExpandable(segments[0])) */ {\n        if (ctrl.segments.length === fromIndex) {\n          ctrl.segments = ctrl.segments.splice(0, fromIndex)\n          if (ctrl.segments[ctrl.segments.length - 1].expandable) {\n            if (!ctrl.target.isPiPoint) {\n              ctrl.segments.push(ctrl.uiSegmentSrv.getSegmentForValue(null, \"Select AF Element\"))\n            } \n          }\n        } else {\n          return ctrl.checkOtherSegments(fromIndex + 1)\n        }\n      }\n\n      ctrl.refresh()\n    }).catch(err => {\n      ctrl.segments = ctrl.segments.splice(0, fromIndex)\n      if (ctrl.segments[ctrl.segments.length - 1].expandable) {\n        if (!ctrl.target.isPiPoint) {\n          ctrl.segments.push(ctrl.uiSegmentSrv.getSegmentForValue(null, \"Select AF Element\"))\n        } \n        ctrl.refresh()\n      }\n      ctrl.error = err.message || 'Failed to issue metric query'\n    })\n  }\n\n  /**\n   * Focus the selected segment.\n   * \n   * @param {any} segmentIndex - The currently selected metric.\n   * \n   * @memberOf PiWebApiDatasourceQueryCtrl\n   */\n  setSegmentFocus (segmentIndex) {\n    _.each(this.segments, (segment, index) => {\n      segment.focus = false\n      segment.focus = segmentIndex === index\n    })\n  }\n  // wrap a function for grafana\n  wrapFunction (target, func) {\n    return func.render(target)\n  }\n  // is selected segment empty\n  isValueEmpty (value) {\n    return value === undefined || value === null || value === '' || value === '-REMOVE-'\n  }\n  // get summary calculation basis\n  calcBasisValueChanged (segment, index) {\n    this.target.summary.basis = this.calculationBasisSegment.value\n    this.targetChanged()\n    this.panelCtrl.refresh()\n  }\n\n  calcNoDataValueChanged (segment, index) {\n    this.target.summary.nodata = this.noDataReplacementSegment.value\n    this.targetChanged()\n    this.panelCtrl.refresh()\n  }\n\n  // get summary calculation basis user interface segments\n  getCalcBasisSegments () {\n    var ctrl = this\n    var segments = _.map(this.calculationBasis, item => {\n      return ctrl.uiSegmentSrv.newSegment({value: item, expandable: true})\n    })\n    return this.$q.when(segments)\n  }\n\n // get summary calculation basis user interface segments\n  getNoDataSegments () {\n    var ctrl = this\n    var segments = _.map(this.noDataReplacement, item => {\n      return ctrl.uiSegmentSrv.newSegment({value: item, expandable: true})\n    })\n    return this.$q.when(segments)\n  }\n\n  // remove a summary from the user interface and the query\n  removeSummary (part) {\n    this.summaries = _.filter(this.summaries, function (item) { return item !== part })\n    this.panelCtrl.refresh()\n  }\n  // add a new summary to the query\n  summaryAction () {\n    // if value is not empty, add new attribute segment\n    if (!this.isValueEmpty(this.summarySegment.value)) {\n      this.summaries.push(this.uiSegmentSrv.newSegment({value: this.summarySegment.value, expandable: true}))\n      this.targetChanged()\n    }\n\n    // reset the + button\n    var plusButton = this.uiSegmentSrv.newPlusButton()\n    this.summarySegment.value = plusButton.value\n    this.summarySegment.html = plusButton.html\n    this.summarySegment.fake = plusButton.fake\n    this.summarySegment.type = plusButton.type\n    this.panelCtrl.refresh()\n  }\n  // change a summary query\n  summaryValueChanged (segment, index) {\n    this.summaries[index].value = segment.value\n    if (this.isValueEmpty(segment.value)) {\n      this.summaries.splice(index, 1)\n    }\n    this.targetChanged()\n    this.panelCtrl.refresh()\n  }\n  // get the list of summaries available\n  getSummarySegments () {\n    var ctrl = this\n    // var segments = _.map(_.difference(ctrl.summaryTypes, _.map(ctrl.summaries, seg => { return seg.value || '' })), item => {\n    var segments = _.map(ctrl.summaryTypes, item => {\n      return ctrl.uiSegmentSrv.newSegment({value: item, expandable: true})\n    })\n\n    segments.unshift(ctrl.uiSegmentSrv.newSegment('-REMOVE-'))\n\n    return this.$q.when(segments)\n  }\n  // remove an af attribute from the query\n  removeAttribute (part) {\n    this.attributes = _.filter(this.attributes, function (item) { return item !== part })\n    this.panelCtrl.refresh()\n  }\n  // add an attribute to the query\n  attributeAction () {\n    // if value is not empty, add new attribute segment\n    if (!this.isValueEmpty(this.attributeSegment.value)) {\n      this.attributes.push(this.uiSegmentSrv.newSegment({value: this.attributeSegment.value, expandable: true}))\n      this.targetChanged()\n    }\n\n    // reset the + button\n    var plusButton = this.uiSegmentSrv.newPlusButton()\n    this.attributeSegment.value = plusButton.value\n    this.attributeSegment.html = plusButton.html\n    this.attributeSegment.fake = plusButton.fake\n    this.attributeSegment.type = plusButton.type\n    this.panelCtrl.refresh()\n  }\n  // change an attribute\n  attributeValueChanged (segment, index) {\n    this.attributes[index].value = segment.value\n    if (this.isValueEmpty(segment.value)) {\n      this.attributes.splice(index, 1)\n    }\n    this.targetChanged()\n    this.panelCtrl.refresh()\n  }\n  // get the list of attributes for the user interface\n  getAttributeSegments (attributeText) {\n    var ctrl = this\n    var segments = []\n\n    if (this.target.isPiPoint === true) {\n      var query = { path: '', webId: this.getSelectedPIServer(), pointName: '*' + attributeText + '*' }\n\n      return this.datasource.metricFindQuery(angular.toJson(query), this.target.isPiPoint)\n      .then(items => {\n        _.forOwn(items, (item) => {\n          segments.push(ctrl.uiSegmentSrv.newSegment({value: item.text, expandable: true}))\n        })\n\n        segments.unshift(ctrl.uiSegmentSrv.newSegment('-REMOVE-'))\n\n        return this.$q.when(segments)\n      }).catch(err => {\n        ctrl.error = err.message || 'Failed to issue metric query'\n        return this.$q.when(segments)\n      })\n    } else {\n    _.forOwn(ctrl.availableAttributes, (val, key) => {\n      segments.push(ctrl.uiSegmentSrv.newSegment({value: key, expandable: true}))\n    })\n    }\n    segments.unshift(ctrl.uiSegmentSrv.newSegment('-REMOVE-'))\n\n    return this.$q.when(segments)\n  }\n  // get a ui segment for the attributes\n  getElementSegments (index) {\n    var ctrl = this\n    var query = { path: this.getSegmentPathUpTo(index) }\n\n    return this.datasource.metricFindQuery(angular.toJson(query), this.target.isPiPoint)\n    .then(items => {\n      this.piServer = items\n      var altSegments = _.map(items, item => {\n        return ctrl.uiSegmentSrv.newSegment({value: item.text, expandable: item.expandable})\n      })\n\n      if (altSegments.length === 0) { return altSegments }\n     \n      // add template variables\n      _.each(ctrl.templateSrv.variables, variable => {\n        altSegments.unshift(ctrl.uiSegmentSrv.newSegment({\n          type: 'template',\n          value: '$' + variable.name,\n          expandable: true\n        }))\n      })\n      \n      altSegments.unshift(ctrl.uiSegmentSrv.newSegment('-REMOVE-'))\n\n      // add wildcard option\n      // altSegments.unshift(ctrl.uiSegmentSrv.newSegment('*'))\n      return altSegments\n    }).catch(err => {\n      ctrl.error = err.message || 'Failed to issue metric query'\n      return []\n    })\n  }\n  // changes the selecte af element segment\n  segmentValueChanged (segment, segmentIndex) {\n    var ctrl = this;\n    ctrl.error = null\n\n    if (ctrl.isValueEmpty(segment.value)) {\n      ctrl.segments.length = segmentIndex;\n      ctrl.checkOtherSegments(segmentIndex);\n    }\n\n    if (segment.expandable) {\n      ctrl.checkOtherSegments(segmentIndex + 1)\n      ctrl.setSegmentFocus(segmentIndex + 1)\n      ctrl.targetChanged()\n    } else {\n      ctrl.segments = ctrl.segments.splice(0, segmentIndex + 1)\n    }\n\n    ctrl.setSegmentFocus(segmentIndex + 1)\n    ctrl.checkAttributeSegments()\n    ctrl.targetChanged()\n  }\n\n    /**\n   * Toggle between searching by PI Point and searching via the AF.\n   * \n   * \n   * @memberOf PiWebApiDatasourceQueryCtrl\n   */\n  togglePiPointSearch () {\n    this.textEditorChanged()\n    this.panelCtrl.refresh()\n  }\n\n}\n\nPiWebApiDatasourceQueryCtrl.templateUrl = 'partials/query.editor.html'\n"]}