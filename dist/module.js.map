{"version":3,"sources":["webpack:///webpack/bootstrap","webpack:///external \"react\"","webpack:///external \"lodash\"","webpack:///external \"@grafana/ui\"","webpack:///external \"@grafana/data\"","webpack:///external \"@grafana/runtime\"","webpack:///./AnnotationsQueryCtrl.ts","webpack:///./ConfigEditor.tsx","webpack:///../node_modules/tslib/tslib.es6.js","webpack:///./components/Forms.tsx","webpack:///./types.ts","webpack:///./components/QueryEditorModeSwitcher.tsx","webpack:///./QueryEditor.tsx","webpack:///./datasource.ts","webpack:///./module.ts"],"names":["installedModules","__webpack_require__","moduleId","exports","module","i","l","modules","call","m","c","d","name","getter","o","Object","defineProperty","enumerable","get","r","Symbol","toStringTag","value","t","mode","__esModule","ns","create","key","bind","n","object","property","prototype","hasOwnProperty","p","s","__WEBPACK_EXTERNAL_MODULE__0__","__WEBPACK_EXTERNAL_MODULE__1__","__WEBPACK_EXTERNAL_MODULE__2__","__WEBPACK_EXTERNAL_MODULE__3__","__WEBPACK_EXTERNAL_MODULE__4__","AnnotationsQueryCtrl","$scope","this","annotation","ctrl","datasource","query","databases","templates","regex","attribute","showEndTime","getAssetServer","afserver","then","result","getDatabases","WebId","getEventFrames","webid","dbs","$apply","getEventFrameTemplates","database","templateUrl","FormField","coerceOptions","options","jsonData","url","onPIServerChange","event","props","onOptionsChange","piserver","target","onAFServerChange","onAFDatabaseChange","afdatabase","onMyOptionsChange","originalOptions","defaultUrl","dataSourceConfig","onChange","showAccessOptions","className","label","labelWidth","inputWidth","placeholder","__rest","e","indexOf","getOwnPropertySymbols","length","propertyIsEnumerable","__awaiter","thisArg","_arguments","P","generator","Promise","resolve","reject","fulfilled","step","next","rejected","done","apply","tooltip","children","width","defaultQuery","attributes","segments","enable","summary","types","basis","interval","nodata","expression","interpolate","recordedValues","digitalStates","isPiPoint","isRaw","isModalOpen","setModalOpen","icon","variant","type","onClick","isOpen","title","body","confirmText","dismissText","onConfirm","onDismiss","piServer","availableAttributes","state","summaries","attributeSegment","summarySegment","calculationBasisSegment","noDataReplacementSegment","segmentChangeValue","setState","attributeChangeValue","onPiPointChange","item","index","slice","checkPiPointSegments","onAttributeChange","checkAttributeSegments","onSegmentChange","push","expandable","getElementSegments","currentSegment","data","findQuery","path","getSegmentPathUpTo","metricFindQuery","assign","request","scopedVars","items","altSegments","text","webId","variables","templateSrv","getVariables","variable","selectableValue","unshift","err","error","message","getAttributeSegmentsPI","attributeText","getSelectedPIServer","pointName","Path","getAttributeSegmentsAF","val","buildFromTarget","segmentsArray","attributesArray","splitAttributes","split","splitElements","splice","_","elements","checkAfServer","updateArray","summariesArray","cb","scopedVarsDone","componentDidMount","initialLoad","componentDidUpdate","force","metricsQuery","_segmentsArray","onRunQuery","rawQuery","elementPath","join","map","stateCallback","onIsPiPointChange","queryChange","calcBasisValueChanged","calcNoDataValueChanged","onSummaryAction","onSummaryValueChanged","onAttributeAction","summaryTypes","calculationBasis","noDataReplacement","segment","isValueEmpty","part","arr","startsWith","attributesResponse","validAttributes","substring","filteredAttributes","attrib","changedValue","replace","undefined","webID","forEach","parts","match","queryProps","display","grow","onBlur","textEditorChanged","Component","loadOptions","allowCustomValue","inputMinWidth","disabled","reloadOptionsOnChange","maxNumber","parseInt","getNoDataSegments","getCalcBasisSegments","getSummarySegments","LABEL_WIDTH","search","instanceSettings","isProxy","webidCache","Map","basicAuth","withCredentials","backendSrv","piwebapiurl","toString","test","access","all","getDataServer","getDatabase","annotationOptions","endTime","eventFrame","attributeDataItems","Name","RegExp","attributeData","attributeValue","Value","time","Date","EndTime","StartTime","getTime","targets","ds","tar","elementPathArray","att","refId","hide","webids","startTime","range","from","to","varsKeys","v","isAllSelected","current","filter","selected","attr","vv","allValue","getElementPath","Array","isArray","buildQueryParameters","getStream","targetResponses","flattened","tr","sort","a","b","datasourceRequest","method","response","status","Error","categoryName","nameFilter","templateName","template","iconColor","toJSON","resourceUrl","Method","Resource","RequestTemplate","Parameters","ParentIds","restBatch","Content","valueData","annotations","Items","eventFrameToAnnotation","ends","end","restGet","HasChildren","queryOptions","querydepth","JSON","parse","Math","max","min","metricQueryTransform","getAssetServers","server","db","getDatabaseElements","selectedFields","getElement","element","getElements","getAttributes","searchFullHierarchy","getDataServers","piPointSearch","trim","isSummary","api","datapoints","noDataReplace","parsePiPointValue","grafanaDataPoint","previousValue","drop","num","Good","Timestamp","checkNumber","Number","noDataReplacementMode","content","noTemplate","getPath","innerResults","groups","Type","parsePiPointValueList","number","isNaN","isFinite","newElementPathArray","elem","temp","concat","splitPath","splitStr","pop","foundElement","find","results","isInterpolated","intervalTime","timeRange","targetName","displayName","encodeURIComponent","internalStream","restGetWebId","webidresponse","restPost","processResults","maxDataPoints","getSummaryUrl","datarsp","datarspa","targetResults","targetResult","headers","assetPath","cachedWebId","set","batch","serverId","databaseId","InstanceType","elementId","querystring","filter1","filter2","doFilter","exec","lastIndex","groupIndex","isAf","isAttribute","setConfigEditor","setQueryEditor","setAnnotationQueryCtrl"],"mappings":"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","file":"module.js","sourcesContent":[" \t// The module cache\n \tvar installedModules = {};\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules[moduleId]) {\n \t\t\treturn installedModules[moduleId].exports;\n \t\t}\n \t\t// Create a new module (and put it into the cache)\n \t\tvar module = installedModules[moduleId] = {\n \t\t\ti: moduleId,\n \t\t\tl: false,\n \t\t\texports: {}\n \t\t};\n\n \t\t// Execute the module function\n \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n \t\t// Flag the module as loaded\n \t\tmodule.l = true;\n\n \t\t// Return the exports of the module\n \t\treturn module.exports;\n \t}\n\n\n \t// expose the modules object (__webpack_modules__)\n \t__webpack_require__.m = modules;\n\n \t// expose the module cache\n \t__webpack_require__.c = installedModules;\n\n \t// define getter function for harmony exports\n \t__webpack_require__.d = function(exports, name, getter) {\n \t\tif(!__webpack_require__.o(exports, name)) {\n \t\t\tObject.defineProperty(exports, name, { enumerable: true, get: getter });\n \t\t}\n \t};\n\n \t// define __esModule on exports\n \t__webpack_require__.r = function(exports) {\n \t\tif(typeof Symbol !== 'undefined' && Symbol.toStringTag) {\n \t\t\tObject.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });\n \t\t}\n \t\tObject.defineProperty(exports, '__esModule', { value: true });\n \t};\n\n \t// create a fake namespace object\n \t// mode & 1: value is a module id, require it\n \t// mode & 2: merge all properties of value into the ns\n \t// mode & 4: return value when already ns object\n \t// mode & 8|1: behave like require\n \t__webpack_require__.t = function(value, mode) {\n \t\tif(mode & 1) value = __webpack_require__(value);\n \t\tif(mode & 8) return value;\n \t\tif((mode & 4) && typeof value === 'object' && value && value.__esModule) return value;\n \t\tvar ns = Object.create(null);\n \t\t__webpack_require__.r(ns);\n \t\tObject.defineProperty(ns, 'default', { enumerable: true, value: value });\n \t\tif(mode & 2 && typeof value != 'string') for(var key in value) __webpack_require__.d(ns, key, function(key) { return value[key]; }.bind(null, key));\n \t\treturn ns;\n \t};\n\n \t// getDefaultExport function for compatibility with non-harmony modules\n \t__webpack_require__.n = function(module) {\n \t\tvar getter = module && module.__esModule ?\n \t\t\tfunction getDefault() { return module['default']; } :\n \t\t\tfunction getModuleExports() { return module; };\n \t\t__webpack_require__.d(getter, 'a', getter);\n \t\treturn getter;\n \t};\n\n \t// Object.prototype.hasOwnProperty.call\n \t__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };\n\n \t// __webpack_public_path__\n \t__webpack_require__.p = \"/\";\n\n\n \t// Load entry module and return exports\n \treturn __webpack_require__(__webpack_require__.s = 5);\n","module.exports = __WEBPACK_EXTERNAL_MODULE__0__;","module.exports = __WEBPACK_EXTERNAL_MODULE__1__;","module.exports = __WEBPACK_EXTERNAL_MODULE__2__;","module.exports = __WEBPACK_EXTERNAL_MODULE__3__;","module.exports = __WEBPACK_EXTERNAL_MODULE__4__;","export class AnnotationsQueryCtrl {\r\n  static templateUrl = 'partials/annotations.editor.html';\r\n\r\n  $scope: any;\r\n  annotation: any;\r\n  datasource: any;\r\n\r\n  /** @ngInject */\r\n  constructor($scope: any) {\r\n    this.$scope = $scope;\r\n    this.annotation = $scope.ctrl.annotation;\r\n    this.datasource = $scope.ctrl.datasource;\r\n\r\n    // load defaults\r\n    this.annotation.query = this.annotation.query || {};\r\n    this.annotation.databases = this.annotation.databases || [];\r\n    this.annotation.templates = this.annotation.templates || [];\r\n    this.annotation.regex = this.annotation.regex || {};\r\n    this.annotation.attribute = this.annotation.attribute || {};\r\n    this.annotation.showEndTime = this.annotation.showEndTime || false;\r\n\r\n    this.datasource.getAssetServer(this.datasource.afserver.name).then((result: any) => {\r\n      return this.getDatabases(result.WebId);\r\n    });\r\n  }\r\n  templateChanged() {\r\n    // do nothing\r\n  }\r\n  databaseChanged() {\r\n    this.annotation.templates = [];\r\n    this.getEventFrames();\r\n  }\r\n  getDatabases(webid: string) {\r\n    var ctrl = this;\r\n    ctrl.datasource.getDatabases(webid).then((dbs: any) => {\r\n      ctrl.annotation.databases = dbs;\r\n      this.$scope.$apply();\r\n    });\r\n  }\r\n  getEventFrames() {\r\n    var ctrl = this;\r\n    ctrl.datasource.getEventFrameTemplates(this.annotation.database.WebId).then((templates: any) => {\r\n      ctrl.annotation.templates = templates;\r\n      this.$scope.$apply();\r\n    });\r\n  }\r\n}\r\n","import React, { ChangeEvent, PureComponent } from 'react';\r\nimport { LegacyForms, DataSourceHttpSettings } from '@grafana/ui';\r\nimport { DataSourcePluginOptionsEditorProps, DataSourceJsonData, DataSourceSettings } from '@grafana/data';\r\nimport { PIWebAPIDataSourceJsonData } from './types';\r\n\r\nconst { FormField } = LegacyForms;\r\n\r\ninterface Props extends DataSourcePluginOptionsEditorProps<PIWebAPIDataSourceJsonData, {}> {}\r\n\r\nconst coerceOptions = (\r\n  options: DataSourceSettings<PIWebAPIDataSourceJsonData, {}>\r\n): DataSourceSettings<PIWebAPIDataSourceJsonData, {}> => {\r\n  return {\r\n    ...options,\r\n    jsonData: {\r\n      ...options.jsonData,\r\n      url: options.url,\r\n    },\r\n  };\r\n};\r\n\r\ninterface State {}\r\n\r\nexport class PIWebAPIConfigEditor extends PureComponent<Props, State> {\r\n  onPIServerChange = (event: ChangeEvent<HTMLInputElement>) => {\r\n    const { onOptionsChange, options } = this.props;\r\n    const jsonData = {\r\n      ...options.jsonData,\r\n      piserver: event.target.value,\r\n    };\r\n    onOptionsChange({ ...options, jsonData });\r\n  };\r\n\r\n  onAFServerChange = (event: ChangeEvent<HTMLInputElement>) => {\r\n    const { onOptionsChange, options } = this.props;\r\n    const jsonData = {\r\n      ...options.jsonData,\r\n      afserver: event.target.value,\r\n    };\r\n    onOptionsChange({ ...options, jsonData });\r\n  };\r\n\r\n  onAFDatabaseChange = (event: ChangeEvent<HTMLInputElement>) => {\r\n    const { onOptionsChange, options } = this.props;\r\n    const jsonData = {\r\n      ...options.jsonData,\r\n      afdatabase: event.target.value,\r\n    };\r\n    onOptionsChange({ ...options, jsonData });\r\n  };\r\n\r\n  onMyOptionsChange = (options: DataSourceSettings<DataSourceJsonData, {}>) => {\r\n    const { onOptionsChange } = this.props;\r\n    onOptionsChange(coerceOptions(options));\r\n  };\r\n\r\n  render() {\r\n    const { options: originalOptions } = this.props;\r\n    const options = coerceOptions(originalOptions);\r\n\r\n    return (\r\n      <div>\r\n        <DataSourceHttpSettings\r\n          defaultUrl=\"https://server.name/piwebapi\"\r\n          dataSourceConfig={options}\r\n          onChange={this.onMyOptionsChange}\r\n          showAccessOptions\r\n        />\r\n\r\n        <h3 className=\"page-heading\">PI/AF Connection Details</h3>\r\n\r\n        <div className=\"gf-form-group\">\r\n          <div className=\"gf-form\">\r\n            <FormField\r\n              label=\"PI Server\"\r\n              labelWidth={10}\r\n              inputWidth={25}\r\n              onChange={this.onPIServerChange}\r\n              value={options.jsonData.piserver || ''}\r\n              placeholder=\"Default PI Server to use for data requests\"\r\n            />\r\n          </div>\r\n          <div className=\"gf-form\">\r\n            <FormField\r\n              label=\"AF Server\"\r\n              labelWidth={10}\r\n              inputWidth={25}\r\n              onChange={this.onAFServerChange}\r\n              value={options.jsonData.afserver || ''}\r\n              placeholder=\"Default AF Server to use for data requests\"\r\n            />\r\n          </div>\r\n          <div className=\"gf-form\">\r\n            <FormField\r\n              label=\"AF Database\"\r\n              labelWidth={10}\r\n              inputWidth={25}\r\n              onChange={this.onAFDatabaseChange}\r\n              value={options.jsonData.afdatabase || ''}\r\n              placeholder=\"Default AF Database server for AF queries\"\r\n            />\r\n          </div>\r\n        </div>\r\n      </div>\r\n    );\r\n  }\r\n}\r\n","/*! *****************************************************************************\r\nCopyright (c) Microsoft Corporation.\r\n\r\nPermission to use, copy, modify, and/or distribute this software for any\r\npurpose with or without fee is hereby granted.\r\n\r\nTHE SOFTWARE IS PROVIDED \"AS IS\" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH\r\nREGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY\r\nAND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,\r\nINDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM\r\nLOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR\r\nOTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR\r\nPERFORMANCE OF THIS SOFTWARE.\r\n***************************************************************************** */\r\n/* global Reflect, Promise */\r\n\r\nvar extendStatics = function(d, b) {\r\n    extendStatics = Object.setPrototypeOf ||\r\n        ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||\r\n        function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };\r\n    return extendStatics(d, b);\r\n};\r\n\r\nexport function __extends(d, b) {\r\n    if (typeof b !== \"function\" && b !== null)\r\n        throw new TypeError(\"Class extends value \" + String(b) + \" is not a constructor or null\");\r\n    extendStatics(d, b);\r\n    function __() { this.constructor = d; }\r\n    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());\r\n}\r\n\r\nexport var __assign = function() {\r\n    __assign = Object.assign || function __assign(t) {\r\n        for (var s, i = 1, n = arguments.length; i < n; i++) {\r\n            s = arguments[i];\r\n            for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p)) t[p] = s[p];\r\n        }\r\n        return t;\r\n    }\r\n    return __assign.apply(this, arguments);\r\n}\r\n\r\nexport function __rest(s, e) {\r\n    var t = {};\r\n    for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p) && e.indexOf(p) < 0)\r\n        t[p] = s[p];\r\n    if (s != null && typeof Object.getOwnPropertySymbols === \"function\")\r\n        for (var i = 0, p = Object.getOwnPropertySymbols(s); i < p.length; i++) {\r\n            if (e.indexOf(p[i]) < 0 && Object.prototype.propertyIsEnumerable.call(s, p[i]))\r\n                t[p[i]] = s[p[i]];\r\n        }\r\n    return t;\r\n}\r\n\r\nexport function __decorate(decorators, target, key, desc) {\r\n    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;\r\n    if (typeof Reflect === \"object\" && typeof Reflect.decorate === \"function\") r = Reflect.decorate(decorators, target, key, desc);\r\n    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;\r\n    return c > 3 && r && Object.defineProperty(target, key, r), r;\r\n}\r\n\r\nexport function __param(paramIndex, decorator) {\r\n    return function (target, key) { decorator(target, key, paramIndex); }\r\n}\r\n\r\nexport function __metadata(metadataKey, metadataValue) {\r\n    if (typeof Reflect === \"object\" && typeof Reflect.metadata === \"function\") return Reflect.metadata(metadataKey, metadataValue);\r\n}\r\n\r\nexport function __awaiter(thisArg, _arguments, P, generator) {\r\n    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }\r\n    return new (P || (P = Promise))(function (resolve, reject) {\r\n        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }\r\n        function rejected(value) { try { step(generator[\"throw\"](value)); } catch (e) { reject(e); } }\r\n        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }\r\n        step((generator = generator.apply(thisArg, _arguments || [])).next());\r\n    });\r\n}\r\n\r\nexport function __generator(thisArg, body) {\r\n    var _ = { label: 0, sent: function() { if (t[0] & 1) throw t[1]; return t[1]; }, trys: [], ops: [] }, f, y, t, g;\r\n    return g = { next: verb(0), \"throw\": verb(1), \"return\": verb(2) }, typeof Symbol === \"function\" && (g[Symbol.iterator] = function() { return this; }), g;\r\n    function verb(n) { return function (v) { return step([n, v]); }; }\r\n    function step(op) {\r\n        if (f) throw new TypeError(\"Generator is already executing.\");\r\n        while (_) try {\r\n            if (f = 1, y && (t = op[0] & 2 ? y[\"return\"] : op[0] ? y[\"throw\"] || ((t = y[\"return\"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done) return t;\r\n            if (y = 0, t) op = [op[0] & 2, t.value];\r\n            switch (op[0]) {\r\n                case 0: case 1: t = op; break;\r\n                case 4: _.label++; return { value: op[1], done: false };\r\n                case 5: _.label++; y = op[1]; op = [0]; continue;\r\n                case 7: op = _.ops.pop(); _.trys.pop(); continue;\r\n                default:\r\n                    if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) { _ = 0; continue; }\r\n                    if (op[0] === 3 && (!t || (op[1] > t[0] && op[1] < t[3]))) { _.label = op[1]; break; }\r\n                    if (op[0] === 6 && _.label < t[1]) { _.label = t[1]; t = op; break; }\r\n                    if (t && _.label < t[2]) { _.label = t[2]; _.ops.push(op); break; }\r\n                    if (t[2]) _.ops.pop();\r\n                    _.trys.pop(); continue;\r\n            }\r\n            op = body.call(thisArg, _);\r\n        } catch (e) { op = [6, e]; y = 0; } finally { f = t = 0; }\r\n        if (op[0] & 5) throw op[1]; return { value: op[0] ? op[1] : void 0, done: true };\r\n    }\r\n}\r\n\r\nexport var __createBinding = Object.create ? (function(o, m, k, k2) {\r\n    if (k2 === undefined) k2 = k;\r\n    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });\r\n}) : (function(o, m, k, k2) {\r\n    if (k2 === undefined) k2 = k;\r\n    o[k2] = m[k];\r\n});\r\n\r\nexport function __exportStar(m, o) {\r\n    for (var p in m) if (p !== \"default\" && !Object.prototype.hasOwnProperty.call(o, p)) __createBinding(o, m, p);\r\n}\r\n\r\nexport function __values(o) {\r\n    var s = typeof Symbol === \"function\" && Symbol.iterator, m = s && o[s], i = 0;\r\n    if (m) return m.call(o);\r\n    if (o && typeof o.length === \"number\") return {\r\n        next: function () {\r\n            if (o && i >= o.length) o = void 0;\r\n            return { value: o && o[i++], done: !o };\r\n        }\r\n    };\r\n    throw new TypeError(s ? \"Object is not iterable.\" : \"Symbol.iterator is not defined.\");\r\n}\r\n\r\nexport function __read(o, n) {\r\n    var m = typeof Symbol === \"function\" && o[Symbol.iterator];\r\n    if (!m) return o;\r\n    var i = m.call(o), r, ar = [], e;\r\n    try {\r\n        while ((n === void 0 || n-- > 0) && !(r = i.next()).done) ar.push(r.value);\r\n    }\r\n    catch (error) { e = { error: error }; }\r\n    finally {\r\n        try {\r\n            if (r && !r.done && (m = i[\"return\"])) m.call(i);\r\n        }\r\n        finally { if (e) throw e.error; }\r\n    }\r\n    return ar;\r\n}\r\n\r\n/** @deprecated */\r\nexport function __spread() {\r\n    for (var ar = [], i = 0; i < arguments.length; i++)\r\n        ar = ar.concat(__read(arguments[i]));\r\n    return ar;\r\n}\r\n\r\n/** @deprecated */\r\nexport function __spreadArrays() {\r\n    for (var s = 0, i = 0, il = arguments.length; i < il; i++) s += arguments[i].length;\r\n    for (var r = Array(s), k = 0, i = 0; i < il; i++)\r\n        for (var a = arguments[i], j = 0, jl = a.length; j < jl; j++, k++)\r\n            r[k] = a[j];\r\n    return r;\r\n}\r\n\r\nexport function __spreadArray(to, from, pack) {\r\n    if (pack || arguments.length === 2) for (var i = 0, l = from.length, ar; i < l; i++) {\r\n        if (ar || !(i in from)) {\r\n            if (!ar) ar = Array.prototype.slice.call(from, 0, i);\r\n            ar[i] = from[i];\r\n        }\r\n    }\r\n    return to.concat(ar || Array.prototype.slice.call(from));\r\n}\r\n\r\nexport function __await(v) {\r\n    return this instanceof __await ? (this.v = v, this) : new __await(v);\r\n}\r\n\r\nexport function __asyncGenerator(thisArg, _arguments, generator) {\r\n    if (!Symbol.asyncIterator) throw new TypeError(\"Symbol.asyncIterator is not defined.\");\r\n    var g = generator.apply(thisArg, _arguments || []), i, q = [];\r\n    return i = {}, verb(\"next\"), verb(\"throw\"), verb(\"return\"), i[Symbol.asyncIterator] = function () { return this; }, i;\r\n    function verb(n) { if (g[n]) i[n] = function (v) { return new Promise(function (a, b) { q.push([n, v, a, b]) > 1 || resume(n, v); }); }; }\r\n    function resume(n, v) { try { step(g[n](v)); } catch (e) { settle(q[0][3], e); } }\r\n    function step(r) { r.value instanceof __await ? Promise.resolve(r.value.v).then(fulfill, reject) : settle(q[0][2], r); }\r\n    function fulfill(value) { resume(\"next\", value); }\r\n    function reject(value) { resume(\"throw\", value); }\r\n    function settle(f, v) { if (f(v), q.shift(), q.length) resume(q[0][0], q[0][1]); }\r\n}\r\n\r\nexport function __asyncDelegator(o) {\r\n    var i, p;\r\n    return i = {}, verb(\"next\"), verb(\"throw\", function (e) { throw e; }), verb(\"return\"), i[Symbol.iterator] = function () { return this; }, i;\r\n    function verb(n, f) { i[n] = o[n] ? function (v) { return (p = !p) ? { value: __await(o[n](v)), done: n === \"return\" } : f ? f(v) : v; } : f; }\r\n}\r\n\r\nexport function __asyncValues(o) {\r\n    if (!Symbol.asyncIterator) throw new TypeError(\"Symbol.asyncIterator is not defined.\");\r\n    var m = o[Symbol.asyncIterator], i;\r\n    return m ? m.call(o) : (o = typeof __values === \"function\" ? __values(o) : o[Symbol.iterator](), i = {}, verb(\"next\"), verb(\"throw\"), verb(\"return\"), i[Symbol.asyncIterator] = function () { return this; }, i);\r\n    function verb(n) { i[n] = o[n] && function (v) { return new Promise(function (resolve, reject) { v = o[n](v), settle(resolve, reject, v.done, v.value); }); }; }\r\n    function settle(resolve, reject, d, v) { Promise.resolve(v).then(function(v) { resolve({ value: v, done: d }); }, reject); }\r\n}\r\n\r\nexport function __makeTemplateObject(cooked, raw) {\r\n    if (Object.defineProperty) { Object.defineProperty(cooked, \"raw\", { value: raw }); } else { cooked.raw = raw; }\r\n    return cooked;\r\n};\r\n\r\nvar __setModuleDefault = Object.create ? (function(o, v) {\r\n    Object.defineProperty(o, \"default\", { enumerable: true, value: v });\r\n}) : function(o, v) {\r\n    o[\"default\"] = v;\r\n};\r\n\r\nexport function __importStar(mod) {\r\n    if (mod && mod.__esModule) return mod;\r\n    var result = {};\r\n    if (mod != null) for (var k in mod) if (k !== \"default\" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);\r\n    __setModuleDefault(result, mod);\r\n    return result;\r\n}\r\n\r\nexport function __importDefault(mod) {\r\n    return (mod && mod.__esModule) ? mod : { default: mod };\r\n}\r\n\r\nexport function __classPrivateFieldGet(receiver, state, kind, f) {\r\n    if (kind === \"a\" && !f) throw new TypeError(\"Private accessor was defined without a getter\");\r\n    if (typeof state === \"function\" ? receiver !== state || !f : !state.has(receiver)) throw new TypeError(\"Cannot read private member from an object whose class did not declare it\");\r\n    return kind === \"m\" ? f : kind === \"a\" ? f.call(receiver) : f ? f.value : state.get(receiver);\r\n}\r\n\r\nexport function __classPrivateFieldSet(receiver, state, value, kind, f) {\r\n    if (kind === \"m\") throw new TypeError(\"Private method is not writable\");\r\n    if (kind === \"a\" && !f) throw new TypeError(\"Private accessor was defined without a setter\");\r\n    if (typeof state === \"function\" ? receiver !== state || !f : !state.has(receiver)) throw new TypeError(\"Cannot write private member to an object whose class did not declare it\");\r\n    return (kind === \"a\" ? f.call(receiver, value) : f ? f.value = value : state.set(receiver, value)), value;\r\n}\r\n","import React, { InputHTMLAttributes, FunctionComponent } from 'react';\r\nimport { InlineFormLabel } from '@grafana/ui';\r\n\r\nexport interface Props extends InputHTMLAttributes<HTMLInputElement> {\r\n  label: string;\r\n  tooltip?: string;\r\n  labelWidth?: number;\r\n  children?: React.ReactNode;\r\n  queryEditor?: JSX.Element;\r\n}\r\n\r\nexport const QueryField: FunctionComponent<Partial<Props>> = ({ label, labelWidth = 12, tooltip, children }) => (\r\n  <>\r\n    <InlineFormLabel width={labelWidth} tooltip={tooltip}>\r\n      {label}\r\n    </InlineFormLabel>\r\n    {children}\r\n  </>\r\n);\r\n\r\nexport const QueryRowTerminator = () => {\r\n  return (\r\n    <div className=\"gf-form gf-form--grow\">\r\n      <div className=\"gf-form-label gf-form-label--grow\" />\r\n    </div>\r\n  );\r\n};\r\n\r\nexport const QueryInlineField = ({ ...props }) => {\r\n  return (\r\n    <QueryEditorRow>\r\n      <QueryField {...props} />\r\n    </QueryEditorRow>\r\n  );\r\n};\r\n\r\nexport const QueryEditorRow = (props: Partial<Props>) => {\r\n  return (\r\n    <div className=\"gf-form-inline\">\r\n      {props.children}\r\n      <QueryRowTerminator />\r\n    </div>\r\n  );\r\n};\r\n\r\nexport const QueryRawInlineField = ({ ...props }) => {\r\n  return (\r\n    <QueryRawEditorRow>\r\n      <QueryField {...props} />\r\n    </QueryRawEditorRow>\r\n  );\r\n};\r\n\r\nexport const QueryRawEditorRow = (props: Partial<Props>) => {\r\n  return <>{props.children}</>;\r\n};\r\n","import { DataQuery, DataSourceJsonData } from '@grafana/data';\r\n\r\nexport interface PIWebAPISelectableValue {\r\n  webId?: string;\r\n  value?: string;\r\n  type?: string;\r\n  expandable?: boolean;\r\n}\r\n\r\nexport interface PIWebAPIAnnotationsQuery extends DataQuery {\r\n  target: string;\r\n}\r\n\r\nexport interface PIWebAPIQuery extends DataQuery {\r\n  target: string;\r\n  elementPath: string;\r\n  attributes: any[];\r\n  segments: any[];\r\n  display: any;\r\n  interpolate: any;\r\n  recordedValues: any;\r\n  digitalStates: any;\r\n  webid: string;\r\n  webids: string[];\r\n  regex: any;\r\n  summary: any;\r\n  expression: string;\r\n  isPiPoint: boolean;\r\n  rawQuery?: boolean;\r\n  query?: string;\r\n}\r\n\r\nexport const defaultQuery: Partial<PIWebAPIQuery> = {\r\n  target: ';',\r\n  attributes: [],\r\n  segments: [],\r\n  regex: { enable: false },\r\n  summary: { types: [], basis: 'EventWeighted', interval: '', nodata: 'Null' },\r\n  expression: '',\r\n  interpolate: { enable: false },\r\n  recordedValues: { enable: false },\r\n  digitalStates: { enable: false },\r\n  isPiPoint: false,\r\n};\r\n\r\n/**\r\n * These are options configured for each DataSource instance\r\n */\r\nexport interface PIWebAPIDataSourceJsonData extends DataSourceJsonData {\r\n  url?: string;\r\n  access?: string;\r\n  piserver?: string;\r\n  afserver?: string;\r\n  afdatabase?: string;\r\n}\r\n\r\n/**\r\n * Value that is used in the backend, but never sent over HTTP to the frontend\r\n */\r\nexport interface PIWebAPISecureJsonData {\r\n  apiKey?: string;\r\n}\r\n","import React, { useEffect, useState } from 'react';\r\nimport { Button, ConfirmModal } from '@grafana/ui';\r\n\r\ntype Props = {\r\n  isRaw: boolean;\r\n  onChange: (newIsRaw: boolean) => void;\r\n};\r\n\r\nexport const QueryEditorModeSwitcher = ({ isRaw, onChange }: Props): JSX.Element => {\r\n  const [isModalOpen, setModalOpen] = useState(false);\r\n\r\n  useEffect(() => {\r\n    // if the isRaw changes, we hide the modal\r\n    setModalOpen(false);\r\n  }, [isRaw]);\r\n\r\n  if (isRaw) {\r\n    return (\r\n      <>\r\n        <Button\r\n          aria-label=\"Switch to visual editor\"\r\n          icon=\"pen\"\r\n          variant=\"secondary\"\r\n          type=\"button\"\r\n          onClick={() => {\r\n            // we show the are-you-sure modal\r\n            setModalOpen(true);\r\n          }}\r\n        ></Button>\r\n        <ConfirmModal\r\n          isOpen={isModalOpen}\r\n          title=\"Switch to visual editor mode\"\r\n          body=\"Are you sure to switch to visual editor mode? You will lose the changes done in raw query mode.\"\r\n          confirmText=\"Yes, switch to editor mode\"\r\n          dismissText=\"No, stay in raw query mode\"\r\n          onConfirm={() => {\r\n            onChange(false);\r\n          }}\r\n          onDismiss={() => {\r\n            setModalOpen(false);\r\n          }}\r\n        />\r\n      </>\r\n    );\r\n  } else {\r\n    return (\r\n      <Button\r\n        aria-label=\"Switch to text editor\"\r\n        icon=\"pen\"\r\n        variant=\"secondary\"\r\n        type=\"button\"\r\n        onClick={() => {\r\n          onChange(true);\r\n        }}\r\n      ></Button>\r\n    );\r\n  }\r\n};\r\n","import { each, filter, forOwn, join, reduce, map, slice, remove, defaults } from 'lodash';\r\n\r\nimport React, { PureComponent, ChangeEvent } from 'react';\r\nimport { Icon, InlineField, InlineFieldRow, InlineSwitch, Input, SegmentAsync, Segment } from '@grafana/ui';\r\nimport { QueryEditorProps, SelectableValue, VariableModel } from '@grafana/data';\r\n\r\nimport { PiWebAPIDatasource } from './datasource';\r\nimport { QueryInlineField, QueryRawInlineField, QueryRowTerminator } from './components/Forms';\r\nimport { PIWebAPISelectableValue, PIWebAPIDataSourceJsonData, PIWebAPIQuery, defaultQuery } from './types';\r\nimport { QueryEditorModeSwitcher } from 'components/QueryEditorModeSwitcher';\r\n\r\nconst LABEL_WIDTH = 24;\r\nconst MIN_ELEM_INPUT_WIDTH = 200;\r\nconst MIN_ATTR_INPUT_WIDTH = 250;\r\n\r\ninterface State {\r\n  isPiPoint: boolean;\r\n  segments: Array<SelectableValue<PIWebAPISelectableValue>>;\r\n  attributes: Array<SelectableValue<PIWebAPISelectableValue>>;\r\n  summaries: Array<SelectableValue<PIWebAPISelectableValue>>;\r\n  attributeSegment: SelectableValue<PIWebAPISelectableValue>;\r\n  summarySegment: SelectableValue<PIWebAPISelectableValue>;\r\n  calculationBasisSegment: SelectableValue<PIWebAPISelectableValue>;\r\n  noDataReplacementSegment: SelectableValue<PIWebAPISelectableValue>;\r\n}\r\n\r\ntype Props = QueryEditorProps<PiWebAPIDatasource, PIWebAPIQuery, PIWebAPIDataSourceJsonData>;\r\n\r\nconst REMOVE_LABEL = '-REMOVE-';\r\n\r\nconst CustomLabelComponent = (props: any) => {\r\n  if (props.value) {\r\n    return (\r\n      <div className={`gf-form-label ${props.value.type === 'template' ? 'query-keyword' : ''}`}>\r\n        {props.label ?? '--no label--'}\r\n      </div>\r\n    );\r\n  }\r\n  return (\r\n    <a className=\"gf-form-label query-part\">\r\n      <Icon name=\"plus\" />\r\n    </a>\r\n  );\r\n};\r\n\r\nexport class PIWebAPIQueryEditor extends PureComponent<Props, State> {\r\n  error: any;\r\n  piServer: any[] = [];\r\n  availableAttributes: any = {};\r\n  summaryTypes: string[];\r\n  calculationBasis: string[];\r\n  noDataReplacement: string[];\r\n  state: State = {\r\n    isPiPoint: false,\r\n    segments: [],\r\n    attributes: [],\r\n    summaries: [],\r\n    attributeSegment: {},\r\n    summarySegment: {},\r\n    calculationBasisSegment: {},\r\n    noDataReplacementSegment: {},\r\n  };\r\n\r\n  constructor(props: any) {\r\n    super(props);\r\n    this.onSegmentChange = this.onSegmentChange.bind(this);\r\n    this.calcBasisValueChanged = this.calcBasisValueChanged.bind(this);\r\n    this.calcNoDataValueChanged = this.calcNoDataValueChanged.bind(this);\r\n    this.onSummaryAction = this.onSummaryAction.bind(this);\r\n    this.onSummaryValueChanged = this.onSummaryValueChanged.bind(this);\r\n    this.onAttributeAction = this.onAttributeAction.bind(this);\r\n    this.onAttributeChange = this.onAttributeChange.bind(this);\r\n\r\n    this.summaryTypes = [\r\n      // 'None', // A summary type is not specified.\r\n      'Total', // A totalization over the time range.\r\n      'Average', // The average value over the time range.\r\n      'Minimum', // The minimum value over the time range.\r\n      'Maximum', // The maximum value over the time range.\r\n      'Range', // The range value over the time range (minimum-maximum).\r\n      'StdDev', // The standard deviation over the time range.\r\n      'PopulationStdDev', // The population standard deviation over the time range.\r\n      'Count', // The sum of event count over the time range when calculation basis is event weighted. The sum of event time duration over the time range when calculation basis is time weighted.\r\n      'PercentGood', // Percent of data with good value during the calculation period. For time weighted calculations, the percentage is based on time. For event weighted calculations, the percent is based on event count.\r\n      'All', // A convenience for requesting all available summary calculations.\r\n      'AllForNonNumeric', // A convenience for requesting all available summary calculations for non-numeric data.\r\n    ];\r\n\r\n    this.calculationBasis = [\r\n      'TimeWeighted', // Weight the values in the calculation by the time over which they apply. Interpolation is based on whether the attribute is stepped. Interpolated events are generated at the boundaries if necessary.\r\n      'EventWeighted', // Evaluate values with equal weighting for each event. No interpolation is done. There must be at least one event within the time range to perform a successful calculation. Two events are required for standard deviation. In handling events at the boundary of the calculation, the AFSDK uses following rules:\r\n      'TimeWeightedContinuous', // Apply weighting as in TimeWeighted, but do all interpolation between values as if they represent continuous data, (standard interpolation) regardless of whether the attribute is stepped.\r\n      'TimeWeightedDiscrete', // Apply weighting as in TimeWeighted but interpolation between values is performed as if they represent discrete, unrelated values (stair step plot) regardless of the attribute is stepped.\r\n      'EventWeightedExcludeMostRecentEvent', // The calculation behaves the same as _EventWeighted_, except in the handling of events at the boundary of summary intervals in a multiple intervals calculation. Use this option to prevent events at the intervals boundary from being double count at both intervals. With this option, events at the end time (most recent time) of an interval is not used in that interval.\r\n      'EventWeightedExcludeEarliestEvent', // Similar to the option _EventWeightedExcludeMostRecentEvent_. Events at the start time(earliest time) of an interval is not used in that interval.\r\n      'EventWeightedIncludeBothEnds', // Events at both ends of the interval boundaries are included in the event weighted calculation.\r\n    ];\r\n\r\n    this.noDataReplacement = [\r\n      'Null', // replace with nulls\r\n      'Drop', // drop items\r\n      'Previous', // use previous value if available\r\n      '0', // replace with 0\r\n      'Keep', // Keep value\r\n    ];\r\n  }\r\n\r\n  // is selected segment empty\r\n  isValueEmpty(value: PIWebAPISelectableValue | undefined) {\r\n    return !value || !value.value || !value.value.length || value.value === REMOVE_LABEL;\r\n  }\r\n\r\n  segmentChangeValue = (segments: Array<SelectableValue<PIWebAPISelectableValue>>) => {\r\n    const query = this.props.query;\r\n    this.setState({ segments }, () => this.onChange({ ...query, segments }));\r\n  };\r\n\r\n  attributeChangeValue = (attributes: Array<SelectableValue<PIWebAPISelectableValue>>) => {\r\n    const query = this.props.query;\r\n    this.setState({ attributes }, () => this.onChange({ ...query, attributes }));\r\n  };\r\n\r\n  // summary calculation basis change event\r\n  calcBasisValueChanged(segment: SelectableValue<PIWebAPISelectableValue>) {\r\n    const metricsQuery = this.props.query as PIWebAPIQuery;\r\n    const summary = metricsQuery.summary;\r\n    summary.basis = segment.value?.value;\r\n    this.onChange({ ...metricsQuery, summary });\r\n  }\r\n  // get summary calculation basis user interface segments\r\n  getCalcBasisSegments() {\r\n    const segments = map(this.calculationBasis, (item: string) => {\r\n      let selectableValue: SelectableValue<PIWebAPISelectableValue> = {\r\n        label: item,\r\n        value: {\r\n          value: item,\r\n          expandable: true,\r\n        },\r\n      };\r\n      return selectableValue;\r\n    });\r\n    return segments;\r\n  }\r\n\r\n  // no data change event\r\n  calcNoDataValueChanged(segment: SelectableValue<PIWebAPISelectableValue>) {\r\n    const metricsQuery = this.props.query as PIWebAPIQuery;\r\n    const summary = metricsQuery.summary;\r\n    summary.nodata = segment.value?.value;\r\n    this.onChange({ ...metricsQuery, summary });\r\n  }\r\n  // get no data user interface segments\r\n  getNoDataSegments() {\r\n    var segments = map(this.noDataReplacement, (item: string) => {\r\n      let selectableValue: SelectableValue<PIWebAPISelectableValue> = {\r\n        label: item,\r\n        value: {\r\n          value: item,\r\n          expandable: true,\r\n        },\r\n      };\r\n      return selectableValue;\r\n    });\r\n    return segments;\r\n  }\r\n\r\n  // summary query change event\r\n  onSummaryValueChanged(item: SelectableValue<PIWebAPISelectableValue>, index: number) {\r\n    const summaries = this.state.summaries.slice(0) as Array<SelectableValue<PIWebAPISelectableValue>>;\r\n    summaries[index] = item;\r\n    if (this.isValueEmpty(item.value)) {\r\n      summaries.splice(index, 1);\r\n    }\r\n    this.setState({ summaries }, this.stateCallback);\r\n  }\r\n  // get the list of summaries available\r\n  getSummarySegments() {\r\n    const ctrl = this;\r\n    const summaryTypes = filter(ctrl.summaryTypes, (type) => {\r\n      return this.state.summaries.map((s) => s.value?.value).indexOf(type) === -1;\r\n    });\r\n    var segments = map(summaryTypes, (item: string) => {\r\n      let selectableValue: SelectableValue<PIWebAPISelectableValue> = {\r\n        label: item,\r\n        value: {\r\n          value: item,\r\n          expandable: true,\r\n        },\r\n      };\r\n      return selectableValue;\r\n    });\r\n\r\n    segments.unshift({\r\n      label: REMOVE_LABEL,\r\n      value: {\r\n        value: REMOVE_LABEL,\r\n      },\r\n    });\r\n\r\n    return segments;\r\n  }\r\n\r\n  // remove a summary from the user interface and the query\r\n  removeSummary(part: SelectableValue<PIWebAPISelectableValue>) {\r\n    const summaries = filter(this.state.summaries, (item: SelectableValue<PIWebAPISelectableValue>) => {\r\n      return item !== part;\r\n    });\r\n    this.setState({ summaries });\r\n  }\r\n  // add a new summary to the query\r\n  onSummaryAction(item: SelectableValue<PIWebAPISelectableValue>) {\r\n    const summaries = this.state.summaries.slice(0) as Array<SelectableValue<PIWebAPISelectableValue>>;\r\n    // if value is not empty, add new attribute segment\r\n    if (!this.isValueEmpty(item.value)) {\r\n      let selectableValue: SelectableValue<PIWebAPISelectableValue> = {\r\n        label: item.label,\r\n        value: {\r\n          value: item.value?.value,\r\n          expandable: true,\r\n        },\r\n      };\r\n      summaries.push(selectableValue);\r\n    }\r\n    this.setState({ summarySegment: {}, summaries }, this.stateCallback);\r\n  }\r\n\r\n  // remove an attribute from the query\r\n  removeAttribute(part: SelectableValue<PIWebAPISelectableValue>) {\r\n    const attributes = filter(this.state.attributes, (item: SelectableValue<PIWebAPISelectableValue>) => {\r\n      return item !== part;\r\n    });\r\n    this.attributeChangeValue(attributes);\r\n  }\r\n  // add an attribute to the query\r\n  onAttributeAction(item: SelectableValue<PIWebAPISelectableValue>) {\r\n    const { query } = this.props;\r\n    const attributes = this.state.attributes.slice(0);\r\n    // if value is not empty, add new attribute segment\r\n    if (!this.isValueEmpty(item.value)) {\r\n      let selectableValue: SelectableValue<PIWebAPISelectableValue> = {\r\n        label: item.label,\r\n        value: {\r\n          value: item.value?.value,\r\n          expandable: !query.isPiPoint,\r\n        },\r\n      };\r\n      attributes.push(selectableValue);\r\n    }\r\n    this.attributeChangeValue(attributes);\r\n  }\r\n\r\n  // pi point change event\r\n  onPiPointChange = (item: SelectableValue<PIWebAPISelectableValue>, index: number) => {\r\n    let attributes = this.state.attributes.slice(0);\r\n\r\n    if (item.label === REMOVE_LABEL) {\r\n      remove(attributes, (value, n) => n === index);\r\n    } else {\r\n      // set current value\r\n      attributes[index] = item;\r\n    }\r\n\r\n    this.checkPiPointSegments(item, attributes);\r\n  };\r\n  // attribute change event\r\n  onAttributeChange = (item: SelectableValue<PIWebAPISelectableValue>, index: number) => {\r\n    let attributes = this.state.attributes.slice(0);\r\n\r\n    // set current value\r\n    attributes[index] = item;\r\n\r\n    this.checkAttributeSegments(attributes, this.state.segments);\r\n  };\r\n  // segment change\r\n  onSegmentChange = (item: SelectableValue<PIWebAPISelectableValue>, index: number) => {\r\n    const { query } = this.props;\r\n    let segments = this.state.segments.slice(0);\r\n\r\n    if (item.label === REMOVE_LABEL) {\r\n      segments = slice(segments, 0, index);\r\n      this.checkAttributeSegments([], segments);\r\n      if (segments.length === 0) {\r\n        segments.push({\r\n          label: '',\r\n        });\r\n      } else if (!!segments[segments.length - 1].value?.expandable) {\r\n        segments.push({\r\n          label: 'Select Element',\r\n          value: {\r\n            value: '-Select Element-',\r\n          },\r\n        });\r\n      }\r\n      if (query.isPiPoint) {\r\n        this.piServer = [];\r\n      }\r\n      this.segmentChangeValue(segments);\r\n      return;\r\n    }\r\n\r\n    // set current value\r\n    segments[index] = item;\r\n\r\n    // Accept only one PI server\r\n    if (query.isPiPoint) {\r\n      this.piServer.push(item);\r\n      this.segmentChangeValue(segments);\r\n      return;\r\n    }\r\n\r\n    // changed internal selection\r\n    if (index < segments.length - 1) {\r\n      segments = slice(segments, 0, index + 1);\r\n    }\r\n    this.checkAttributeSegments([], segments);\r\n    // add new options\r\n    if (!!item.value?.expandable) {\r\n      segments.push({\r\n        label: 'Select Element',\r\n        value: {\r\n          value: '-Select Element-',\r\n        },\r\n      });\r\n    }\r\n    this.segmentChangeValue(segments);\r\n  };\r\n\r\n  // get a ui segment for the attributes\r\n  getElementSegments = (\r\n    index: number,\r\n    currentSegment?: Array<SelectableValue<PIWebAPISelectableValue>>\r\n  ): Promise<Array<SelectableValue<PIWebAPISelectableValue>>> => {\r\n    const { datasource, query, data } = this.props;\r\n    var ctrl = this;\r\n    var findQuery = query.isPiPoint\r\n      ? { type: 'dataserver' }\r\n      : { path: this.getSegmentPathUpTo(currentSegment ?? this.state.segments.slice(0), index) };\r\n\r\n    if (!query.isPiPoint) {\r\n      if (datasource.afserver?.name && index === 0) {\r\n        return Promise.resolve([\r\n          {\r\n            label: datasource.afserver.name,\r\n            value: {\r\n              value: datasource.afserver.name,\r\n              expandable: true,\r\n            },\r\n          },\r\n        ]);\r\n      }\r\n      if (datasource.afserver?.name && datasource.afdatabase?.name && index === 1) {\r\n        return Promise.resolve([\r\n          {\r\n            label: datasource.afdatabase.name,\r\n            value: {\r\n              value: datasource.afdatabase.name,\r\n              expandable: true,\r\n            },\r\n          },\r\n        ]);\r\n      }\r\n\r\n      // if (!findQuery.path?.length) {\r\n      //   return Promise.resolve([]);\r\n      // }\r\n    }\r\n    return datasource\r\n      .metricFindQuery(findQuery, Object.assign(data?.request?.scopedVars ?? {}, { isPiPoint: query.isPiPoint }))\r\n      .then((items: any[]) => {\r\n        var altSegments = map(items, (item: any) => {\r\n          let selectableValue: SelectableValue<PIWebAPISelectableValue> = {\r\n            label: item.text,\r\n            value: {\r\n              webId: item.WebId,\r\n              value: item.text,\r\n              expandable: !query.isPiPoint && item.expandable,\r\n            },\r\n          };\r\n          return selectableValue;\r\n        });\r\n\r\n        if (altSegments.length === 0) {\r\n          return altSegments;\r\n        }\r\n\r\n        // add template variables\r\n        const variables = datasource.templateSrv.getVariables();\r\n        each(variables, (variable: VariableModel) => {\r\n          let selectableValue: SelectableValue<PIWebAPISelectableValue> = {\r\n            label: '${' + variable.name + '}',\r\n            value: {\r\n              type: 'template',\r\n              value: '${' + variable.name + '}',\r\n              expandable: !query.isPiPoint,\r\n            },\r\n          };\r\n          altSegments.unshift(selectableValue);\r\n        });\r\n\r\n        altSegments.unshift({\r\n          label: REMOVE_LABEL,\r\n          value: {\r\n            value: REMOVE_LABEL,\r\n          },\r\n        });\r\n\r\n        return altSegments;\r\n      })\r\n      .catch((err: any) => {\r\n        ctrl.error = err.message || 'Failed to issue metric query';\r\n        return [];\r\n      });\r\n  };\r\n\r\n  // get the list of attributes for the user interface - PI\r\n  getAttributeSegmentsPI = (attributeText?: string): Promise<Array<SelectableValue<PIWebAPISelectableValue>>> => {\r\n    const { datasource, query, data } = this.props;\r\n    const ctrl = this;\r\n    const findQuery = {\r\n      path: '',\r\n      webId: this.getSelectedPIServer(),\r\n      pointName: (attributeText ?? '') + '*',\r\n      type: 'pipoint',\r\n    };\r\n    let segments: Array<SelectableValue<PIWebAPISelectableValue>> = [];\r\n    return datasource\r\n      .metricFindQuery(findQuery, Object.assign(data?.request?.scopedVars ?? {}, { isPiPoint: query.isPiPoint }))\r\n      .then((items: any[]) => {\r\n        segments = map(items, (item: any) => {\r\n          let selectableValue: SelectableValue<PIWebAPISelectableValue> = {\r\n            path: item.Path,\r\n            label: item.text,\r\n            value: {\r\n              value: item.text,\r\n              expandable: false,\r\n            },\r\n          };\r\n          return selectableValue;\r\n        });\r\n        segments.unshift({\r\n          label: attributeText,\r\n          value: {\r\n            value: attributeText,\r\n            expandable: false,\r\n          },\r\n        });\r\n        segments.unshift({\r\n          label: REMOVE_LABEL,\r\n          value: {\r\n            value: REMOVE_LABEL,\r\n          },\r\n        });\r\n        return segments;\r\n      })\r\n      .catch((err: any) => {\r\n        ctrl.error = err.message || 'Failed to issue metric query';\r\n        return segments;\r\n      });\r\n  };\r\n\r\n  // get the list of attributes for the user interface - AF\r\n  getAttributeSegmentsAF = (attributeText?: string): Array<SelectableValue<PIWebAPISelectableValue>> => {\r\n    const ctrl = this;\r\n    let segments: Array<SelectableValue<PIWebAPISelectableValue>> = [];\r\n\r\n    forOwn(ctrl.availableAttributes, (val: any, key: string) => {\r\n      let selectableValue: SelectableValue<PIWebAPISelectableValue> = {\r\n        label: key,\r\n        value: {\r\n          value: key,\r\n          expandable: true,\r\n        },\r\n      };\r\n      segments.push(selectableValue);\r\n    });\r\n\r\n    segments.unshift({\r\n      label: REMOVE_LABEL,\r\n      value: {\r\n        value: REMOVE_LABEL,\r\n      },\r\n    });\r\n\r\n    return segments;\r\n  };\r\n\r\n  // build data from target string\r\n  buildFromTarget = (\r\n    query: PIWebAPIQuery,\r\n    segmentsArray: Array<SelectableValue<PIWebAPISelectableValue>>,\r\n    attributesArray: Array<SelectableValue<PIWebAPISelectableValue>>\r\n  ) => {\r\n    const splitAttributes = query.target.split(';');\r\n    const splitElements = splitAttributes.length > 0 ? splitAttributes[0].split('\\\\') : [];\r\n\r\n    if (splitElements.length > 1 || (splitElements.length === 1 && splitElements[0] !== '')) {\r\n      // remove element hierarchy from attribute collection\r\n      splitAttributes.splice(0, 1);\r\n\r\n      each(splitElements, (item, _) => {\r\n        segmentsArray.push({\r\n          label: item,\r\n          value: {\r\n            value: item,\r\n            expandable: true,\r\n          },\r\n        });\r\n      });\r\n      each(splitAttributes, (item, _) => {\r\n        if (item !== '') {\r\n          // set current value\r\n          attributesArray.push({\r\n            label: item,\r\n            value: {\r\n              value: item,\r\n              expandable: false,\r\n            },\r\n          });\r\n        }\r\n      });\r\n      return this.getElementSegments(splitElements.length + 1, segmentsArray).then((elements) => {\r\n        if (elements.length > 0) {\r\n          segmentsArray.push({\r\n            label: 'Select Element',\r\n            value: {\r\n              value: '-Select Element-',\r\n            },\r\n          });\r\n        }\r\n        return segmentsArray;\r\n      });\r\n    }\r\n    return Promise.resolve(segmentsArray);\r\n  };\r\n\r\n  /**\r\n   * Gets the segment information and parses it to a string.\r\n   *\r\n   * @param {any} index - Last index of segment to use.\r\n   * @returns - AF Path or PI Point name.\r\n   *\r\n   * @memberOf PIWebAPIQueryEditor\r\n   */\r\n  getSegmentPathUpTo(segments: Array<SelectableValue<PIWebAPISelectableValue>>, index: number): string {\r\n    var arr = segments.slice(0, index);\r\n\r\n    return reduce(\r\n      arr,\r\n      (result: any, segment: SelectableValue<PIWebAPISelectableValue>) => {\r\n        if (!segment.value) {\r\n          return '';\r\n        }\r\n        if (!segment.value.value?.startsWith('-Select')) {\r\n          return result ? result + '\\\\' + segment.value.value : segment.value.value;\r\n        }\r\n        return result;\r\n      },\r\n      ''\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Get the current AF Element's child attributes. Validates when the element selection changes.\r\n   *\r\n   * @returns - Collection of attributes.\r\n   *\r\n   * @memberOf PIWebAPIQueryEditor\r\n   */\r\n  checkAttributeSegments(\r\n    attributes: Array<SelectableValue<PIWebAPISelectableValue>>,\r\n    segments: Array<SelectableValue<PIWebAPISelectableValue>>\r\n  ): Promise<any> {\r\n    const { datasource, data } = this.props;\r\n    var ctrl = this;\r\n    var findQuery = {\r\n      path: this.getSegmentPathUpTo(segments.slice(0), segments.length),\r\n      type: 'attributes',\r\n    };\r\n    return datasource\r\n      .metricFindQuery(findQuery, Object.assign(data?.request?.scopedVars ?? {}, { isPiPoint: false }))\r\n      .then((attributesResponse: any) => {\r\n        var validAttributes: any = {};\r\n\r\n        each(attributesResponse, (attribute: any) => {\r\n          validAttributes[attribute.Path.substring(attribute.Path.indexOf('|') + 1)] = attribute.WebId;\r\n        });\r\n\r\n        var filteredAttributes = filter(attributes, (attrib: SelectableValue<PIWebAPISelectableValue>) => {\r\n          const changedValue = datasource.templateSrv.replace(attrib.value?.value);\r\n          return validAttributes[changedValue] !== undefined;\r\n        });\r\n\r\n        ctrl.availableAttributes = validAttributes;\r\n        this.attributeChangeValue(filteredAttributes);\r\n      })\r\n      .catch((err: any) => {\r\n        ctrl.error = err.message || 'Failed to issue metric query';\r\n        this.attributeChangeValue(attributes);\r\n      });\r\n  }\r\n\r\n  /**\r\n   * Get PI points from server.\r\n   *\r\n   * @returns - Collection of attributes.\r\n   *\r\n   * @memberOf PIWebAPIQueryEditor\r\n   */\r\n  checkPiPointSegments(\r\n    attribute: SelectableValue<PIWebAPISelectableValue>,\r\n    attributes: Array<SelectableValue<PIWebAPISelectableValue>>\r\n  ) {\r\n    const { datasource, data } = this.props;\r\n    var ctrl = this;\r\n    var findQuery = {\r\n      path: attribute.path,\r\n      webId: ctrl.getSelectedPIServer(),\r\n      pointName: attribute.label,\r\n      type: 'pipoint',\r\n    };\r\n    return datasource\r\n      .metricFindQuery(findQuery, Object.assign(data?.request?.scopedVars ?? {}, { isPiPoint: true }))\r\n      .then(() => {\r\n        ctrl.attributeChangeValue(attributes);\r\n      })\r\n      .catch((err: any) => {\r\n        ctrl.error = err.message || 'Failed to issue metric query';\r\n        ctrl.attributeChangeValue([]);\r\n      });\r\n  }\r\n\r\n  /**\r\n   * Gets the webid of the current selected pi data server.\r\n   *\r\n   * @memberOf PIWebAPIQueryEditor\r\n   */\r\n  getSelectedPIServer() {\r\n    var webID = '';\r\n\r\n    this.piServer.forEach((s) => {\r\n      var parts = this.props.query.target.split(';');\r\n      if (parts.length >= 2) {\r\n        if (parts[0] === s.text) {\r\n          webID = s.WebId;\r\n          return;\r\n        }\r\n      }\r\n    });\r\n    return this.piServer.length > 0 ? this.piServer[0].value?.webId : webID;\r\n  }\r\n\r\n  /**\r\n   * Queries PI Web API for child elements and attributes when the raw query text editor is changed.\r\n   *\r\n   * @memberOf PIWebAPIQueryEditor\r\n   */\r\n  textEditorChanged() {\r\n    const { query, onChange } = this.props;\r\n    const splitAttributes = query.target.split(';');\r\n    const splitElements = splitAttributes.length > 0 ? splitAttributes[0].split('\\\\') : [];\r\n\r\n    let segments: Array<SelectableValue<PIWebAPISelectableValue>> = [];\r\n    let attributes: Array<SelectableValue<PIWebAPISelectableValue>> = [];\r\n\r\n    if (splitElements.length > 1 || (splitElements.length === 1 && splitElements[0] !== '')) {\r\n      // remove element hierarchy from attribute collection\r\n      splitAttributes.splice(0, 1);\r\n\r\n      each(splitElements, (item, _) => {\r\n        segments.push({\r\n          label: item,\r\n          value: {\r\n            type: item.match(/\\${\\w+}/gi) ? 'template' : undefined,\r\n            value: item,\r\n            expandable: true,\r\n          },\r\n        });\r\n      });\r\n      this.getElementSegments(splitElements.length + 1, segments).then((elements) => {\r\n        if (elements.length > 0) {\r\n          segments.push({\r\n            label: 'Select Element',\r\n            value: {\r\n              value: '-Select Element-',\r\n            },\r\n          });\r\n        }\r\n      });\r\n      each(splitAttributes, function (item, index) {\r\n        if (item !== '') {\r\n          attributes.push({\r\n            label: item,\r\n            value: {\r\n              value: item,\r\n              expandable: false,\r\n            },\r\n          });\r\n        }\r\n      });\r\n      this.updateArray(segments, attributes, this.state.summaries, query.isPiPoint, () => {\r\n        onChange({ ...query, query: undefined, rawQuery: false });\r\n      });\r\n    } else {\r\n      segments = this.checkAfServer();\r\n      this.updateArray(segments, this.state.attributes, this.state.summaries, query.isPiPoint, () => {\r\n        this.onChange({\r\n          ...query,\r\n          query: undefined,\r\n          rawQuery: false,\r\n          attributes: this.state.attributes,\r\n          segments: this.state.segments,\r\n        });\r\n      });\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Check if the AF server and database are configured in the datasoure config.\r\n   *\r\n   * @returns the segments array\r\n   *\r\n   * @memberOf PIWebAPIQueryEditor\r\n   */\r\n  checkAfServer = () => {\r\n    const { datasource } = this.props;\r\n    const segmentsArray = [];\r\n    if (datasource.afserver?.name) {\r\n      segmentsArray.push({\r\n        label: datasource.afserver.name,\r\n        value: {\r\n          value: datasource.afserver.name,\r\n          expandable: true,\r\n        },\r\n      });\r\n      if (datasource.afdatabase?.name) {\r\n        segmentsArray.push({\r\n          label: datasource.afdatabase.name,\r\n          value: {\r\n            value: datasource.afdatabase.name,\r\n            expandable: true,\r\n          },\r\n        });\r\n      }\r\n      segmentsArray.push({\r\n        label: 'Select Element',\r\n        value: {\r\n          value: '-Select Element-',\r\n        },\r\n      });\r\n    } else {\r\n      segmentsArray.push({\r\n        label: '',\r\n      });\r\n    }\r\n    return segmentsArray;\r\n  };\r\n\r\n  /**\r\n   * Update the internal state of the datasource.\r\n   *\r\n   * @param segmentsArray the segments array to update\r\n   * @param attributesArray the AF attributes array to update\r\n   * @param summariesArray the summaries array to update\r\n   * @param isPiPoint the is PI point flag\r\n   * @param cb optional callback function\r\n   *\r\n   * @memberOf PIWebAPIQueryEditor\r\n   */\r\n  updateArray = (\r\n    segmentsArray: Array<SelectableValue<PIWebAPISelectableValue>>,\r\n    attributesArray: Array<SelectableValue<PIWebAPISelectableValue>>,\r\n    summariesArray: Array<SelectableValue<PIWebAPISelectableValue>>,\r\n    isPiPoint: boolean,\r\n    cb?: (() => void) | undefined\r\n  ) => {\r\n    this.setState(\r\n      {\r\n        segments: segmentsArray,\r\n        attributes: attributesArray,\r\n        summaries: summariesArray,\r\n        isPiPoint,\r\n      },\r\n      () =>\r\n        this.checkAttributeSegments(attributesArray, this.state.segments).then(() => {\r\n          if (cb) {\r\n            cb();\r\n          }\r\n        })\r\n    );\r\n  };\r\n\r\n  // React action when component is initialized/updated\r\n  scopedVarsDone = false;\r\n  componentDidMount = () => {\r\n    this.initialLoad(false);\r\n  };\r\n  componentDidUpdate = () => {\r\n    if (this.props.data?.state === 'Done' && !!this.props.data?.request?.scopedVars && !this.scopedVarsDone) {\r\n      this.scopedVarsDone = true;\r\n      this.initialLoad(true);\r\n    }\r\n  };\r\n  initialLoad = (force: boolean) => {\r\n    const { query } = this.props;\r\n    const metricsQuery = defaults(query, defaultQuery) as PIWebAPIQuery;\r\n    const { segments, attributes, summary, isPiPoint } = metricsQuery;\r\n\r\n    let segmentsArray: Array<SelectableValue<PIWebAPISelectableValue>> = force ? [] : segments?.slice(0) ?? [];\r\n    let attributesArray: Array<SelectableValue<PIWebAPISelectableValue>> = force ? [] : attributes?.slice(0) ?? [];\r\n    let summariesArray = summary?.types ?? [];\r\n\r\n    if (!isPiPoint && segmentsArray.length === 0) {\r\n      if (query.target && query.target.length > 0 && query.target !== ';') {\r\n        attributesArray = [];\r\n        // Build query from target\r\n        this.buildFromTarget(query, segmentsArray, attributesArray)\r\n          .then((_segmentsArray) => {\r\n            this.updateArray(_segmentsArray, attributesArray, summariesArray, isPiPoint);\r\n          })\r\n          .catch((e) => console.error(e));\r\n        return;\r\n      } else {\r\n        segmentsArray = this.checkAfServer();\r\n      }\r\n    } else if (isPiPoint && segmentsArray.length > 0) {\r\n      this.piServer = segmentsArray;\r\n    }\r\n    this.updateArray(segmentsArray, attributesArray, summariesArray, isPiPoint, () => {\r\n      this.onChange(query);\r\n    });\r\n  };\r\n\r\n  onChange = (query: PIWebAPIQuery) => {\r\n    const { onChange, onRunQuery } = this.props;\r\n\r\n    query.summary.types = this.state.summaries;\r\n    if (query.rawQuery) {\r\n      query.target = query.query ?? '';\r\n\r\n      if (query.target !== '') {\r\n        const splitAttributes = query.target.split(';');\r\n        const splitElements = splitAttributes[0].split('\\\\');\r\n\r\n        // remove element hierarchy from attribute collection\r\n        splitAttributes.splice(0, 1);\r\n\r\n        query.attributes = [];\r\n        if (splitElements.length > 1 || (splitElements.length === 1 && splitElements[0] !== '')) {\r\n          query.elementPath = splitElements.join('\\\\');\r\n          each(splitAttributes, function (item, index) {\r\n            if (item !== '') {\r\n              query.attributes.push({\r\n                label: item,\r\n                value: {\r\n                  value: item,\r\n                  expandable: false,\r\n                },\r\n              });\r\n            }\r\n          });\r\n        }\r\n      }\r\n    } else {\r\n      query.elementPath = this.getSegmentPathUpTo(this.state.segments, this.state.segments.length);\r\n      query.target =\r\n        query.elementPath +\r\n        ';' +\r\n        join(\r\n          query.attributes.map((s) => s.value?.value),\r\n          ';'\r\n        );\r\n    }\r\n\r\n    onChange(query);\r\n\r\n    if (query.target && query.target.length > 0 && query.attributes.length > 0) {\r\n      onRunQuery();\r\n    }\r\n  };\r\n\r\n  stateCallback = () => {\r\n    const query = this.props.query as PIWebAPIQuery;\r\n    this.onChange(query);\r\n  };\r\n\r\n  onIsPiPointChange = (event: React.SyntheticEvent<HTMLInputElement>) => {\r\n    const { query: queryChange } = this.props;\r\n    const isPiPoint = !queryChange.isPiPoint;\r\n    this.setState(\r\n      {\r\n        segments: isPiPoint ? [{ label: '' }] : this.checkAfServer(),\r\n        attributes: [],\r\n        isPiPoint,\r\n      },\r\n      () => {\r\n        this.onChange({\r\n          ...queryChange,\r\n          expression: '',\r\n          attributes: this.state.attributes,\r\n          segments: this.state.segments,\r\n          isPiPoint,\r\n        });\r\n      }\r\n    );\r\n  };\r\n\r\n  render() {\r\n    const { query: queryProps, onChange, onRunQuery } = this.props;\r\n    const metricsQuery = defaults(queryProps, defaultQuery) as PIWebAPIQuery;\r\n    const {\r\n      interpolate,\r\n      query,\r\n      rawQuery,\r\n      digitalStates,\r\n      recordedValues,\r\n      expression,\r\n      isPiPoint,\r\n      summary,\r\n      display,\r\n      regex,\r\n    } = metricsQuery;\r\n\r\n    return (\r\n      <>\r\n        <InlineField label=\"Is Pi Point?\" labelWidth={LABEL_WIDTH}>\r\n          <InlineSwitch value={isPiPoint} onChange={this.onIsPiPointChange} />\r\n        </InlineField>\r\n\r\n        {!!rawQuery && (\r\n          <InlineFieldRow>\r\n            <InlineField label=\"Raw Query\" labelWidth={LABEL_WIDTH} grow={true}>\r\n              <Input\r\n                onBlur={this.stateCallback}\r\n                value={query}\r\n                onChange={(event: ChangeEvent<HTMLInputElement>) =>\r\n                  onChange({ ...metricsQuery, query: event.target.value })\r\n                }\r\n                placeholder=\"enter query\"\r\n              />\r\n            </InlineField>\r\n            <QueryEditorModeSwitcher isRaw={true} onChange={(value: boolean) => this.textEditorChanged()} />\r\n          </InlineFieldRow>\r\n        )}\r\n\r\n        {!rawQuery && (\r\n          <>\r\n            <div className=\"gf-form-inline\">\r\n              <QueryRawInlineField\r\n                label={isPiPoint ? 'PI Server' : 'AF Elements'}\r\n                tooltip={isPiPoint ? 'Select PI server.' : 'Select AF Element.'}\r\n              >\r\n                {this.state.segments.map((segment: SelectableValue<PIWebAPISelectableValue>, index: number) => {\r\n                  return (\r\n                    <SegmentAsync\r\n                      key={'element-' + index}\r\n                      Component={<CustomLabelComponent value={segment.value} label={segment.label} />}\r\n                      onChange={(item) => this.onSegmentChange(item, index)}\r\n                      loadOptions={(query?: string | undefined) => {\r\n                        return this.getElementSegments(index);\r\n                      }}\r\n                      allowCustomValue\r\n                      inputMinWidth={MIN_ELEM_INPUT_WIDTH}\r\n                    />\r\n                  );\r\n                })}\r\n                <QueryRowTerminator />\r\n                {!isPiPoint && (\r\n                  <QueryEditorModeSwitcher\r\n                    isRaw={false}\r\n                    onChange={(value: boolean) => {\r\n                      onChange({ ...metricsQuery, query: metricsQuery.target, rawQuery: value });\r\n                    }}\r\n                  />\r\n                )}\r\n              </QueryRawInlineField>\r\n            </div>\r\n\r\n            <QueryInlineField label={isPiPoint ? 'Pi Points' : 'Attributes'}>\r\n              {this.state.attributes.map((attribute: SelectableValue<PIWebAPISelectableValue>, index: number) => {\r\n                if (isPiPoint) {\r\n                  return (\r\n                    <SegmentAsync\r\n                      key={'attributes-' + index}\r\n                      Component={<CustomLabelComponent value={attribute.value} label={attribute.label} />}\r\n                      disabled={this.piServer.length === 0}\r\n                      onChange={(item) => this.onPiPointChange(item, index)}\r\n                      loadOptions={this.getAttributeSegmentsPI}\r\n                      reloadOptionsOnChange\r\n                      allowCustomValue\r\n                      inputMinWidth={MIN_ATTR_INPUT_WIDTH}\r\n                    />\r\n                  );\r\n                }\r\n                return (\r\n                  <Segment\r\n                    key={'attributes-' + index}\r\n                    Component={<CustomLabelComponent value={attribute.value} label={attribute.label} />}\r\n                    disabled={this.state.segments.length <= 2}\r\n                    onChange={(item) => this.onAttributeChange(item, index)}\r\n                    options={this.getAttributeSegmentsAF()}\r\n                    allowCustomValue\r\n                    inputMinWidth={MIN_ATTR_INPUT_WIDTH}\r\n                  />\r\n                );\r\n              })}\r\n\r\n              {isPiPoint && (\r\n                <SegmentAsync\r\n                  Component={\r\n                    <CustomLabelComponent\r\n                      value={this.state.attributeSegment.value}\r\n                      label={this.state.attributeSegment.label}\r\n                    />\r\n                  }\r\n                  disabled={this.piServer.length === 0}\r\n                  onChange={this.onAttributeAction}\r\n                  loadOptions={this.getAttributeSegmentsPI}\r\n                  reloadOptionsOnChange\r\n                  allowCustomValue\r\n                  inputMinWidth={MIN_ATTR_INPUT_WIDTH}\r\n                />\r\n              )}\r\n              {!isPiPoint && (\r\n                <Segment\r\n                  Component={\r\n                    <CustomLabelComponent\r\n                      value={this.state.attributeSegment.value}\r\n                      label={this.state.attributeSegment.label}\r\n                    />\r\n                  }\r\n                  disabled={this.state.segments.length <= 2}\r\n                  onChange={this.onAttributeAction}\r\n                  options={this.getAttributeSegmentsAF()}\r\n                  allowCustomValue\r\n                  inputMinWidth={MIN_ATTR_INPUT_WIDTH}\r\n                />\r\n              )}\r\n            </QueryInlineField>\r\n          </>\r\n        )}\r\n\r\n        {!isPiPoint && (\r\n          <InlineField\r\n            label=\"Calculation\"\r\n            labelWidth={LABEL_WIDTH}\r\n            tooltip={\r\n              \"Modify all attributes by an equation. Use '.' for current item. Leave Attributes empty if you wish to perform element based calculations.\"\r\n            }\r\n          >\r\n            <Input\r\n              onBlur={onRunQuery}\r\n              value={expression}\r\n              onChange={(event: ChangeEvent<HTMLInputElement>) =>\r\n                this.onChange({ ...metricsQuery, expression: event.target.value })\r\n              }\r\n              placeholder=\"'.'*2\"\r\n            />\r\n          </InlineField>\r\n        )}\r\n\r\n        <InlineFieldRow>\r\n          <InlineField\r\n            label=\"Max Recorded Values\"\r\n            labelWidth={LABEL_WIDTH}\r\n            tooltip={'Maximum number of recorded value to retrive from the data archive, without using interpolation.'}\r\n          >\r\n            <Input\r\n              onBlur={onRunQuery}\r\n              value={recordedValues.maxNumber}\r\n              onChange={(event: ChangeEvent<HTMLInputElement>) =>\r\n                this.onChange({\r\n                  ...metricsQuery,\r\n                  recordedValues: { ...recordedValues, maxNumber: parseInt(event.target.value, 10) },\r\n                })\r\n              }\r\n              type=\"number\"\r\n              placeholder=\"1000\"\r\n            />\r\n          </InlineField>\r\n          <InlineField label=\"Recorded Values\" labelWidth={LABEL_WIDTH}>\r\n            <InlineSwitch\r\n              value={recordedValues.enable}\r\n              onChange={() =>\r\n                this.onChange({\r\n                  ...metricsQuery,\r\n                  recordedValues: { ...recordedValues, enable: !recordedValues.enable },\r\n                })\r\n              }\r\n            />\r\n          </InlineField>\r\n          <InlineField label=\"Digital States\" labelWidth={LABEL_WIDTH}>\r\n            <InlineSwitch\r\n              value={digitalStates.enable}\r\n              onChange={() =>\r\n                this.onChange({ ...metricsQuery, digitalStates: { ...digitalStates, enable: !digitalStates.enable } })\r\n              }\r\n            />\r\n          </InlineField>\r\n        </InlineFieldRow>\r\n\r\n        <InlineFieldRow>\r\n          <InlineField\r\n            label=\"Interpolate Period\"\r\n            labelWidth={LABEL_WIDTH}\r\n            tooltip={\"Override time between sampling, e.g. '30s'. Defaults to timespan/chart width.\"}\r\n          >\r\n            <Input\r\n              onBlur={onRunQuery}\r\n              value={interpolate.interval}\r\n              onChange={(event: ChangeEvent<HTMLInputElement>) =>\r\n                this.onChange({ ...metricsQuery, interpolate: { ...interpolate, interval: event.target.value } })\r\n              }\r\n              placeholder=\"30s\"\r\n            />\r\n          </InlineField>\r\n          <InlineField label=\"Interpolate\" labelWidth={LABEL_WIDTH}>\r\n            <InlineSwitch\r\n              value={interpolate.enable}\r\n              onChange={() =>\r\n                this.onChange({ ...metricsQuery, interpolate: { ...interpolate, enable: !interpolate.enable } })\r\n              }\r\n            />\r\n          </InlineField>\r\n          <InlineField\r\n            label=\"Replace Bad Data\"\r\n            labelWidth={LABEL_WIDTH}\r\n            tooltip={'Replacement for bad quality values.'}\r\n          >\r\n            <Segment\r\n              Component={<CustomLabelComponent value={{ value: summary.nodata }} label={summary.nodata} />}\r\n              onChange={this.calcNoDataValueChanged}\r\n              options={this.getNoDataSegments()}\r\n              allowCustomValue\r\n            />\r\n          </InlineField>\r\n        </InlineFieldRow>\r\n\r\n        <InlineFieldRow>\r\n          <InlineField\r\n            label=\"Summary Period\"\r\n            labelWidth={LABEL_WIDTH}\r\n            tooltip={\"Override time between sampling, e.g. '30s'.\"}\r\n          >\r\n            <Input\r\n              onBlur={onRunQuery}\r\n              value={summary.interval}\r\n              onChange={(event: ChangeEvent<HTMLInputElement>) =>\r\n                onChange({ ...metricsQuery, summary: { ...summary, interval: event.target.value } })\r\n              }\r\n              placeholder=\"30s\"\r\n            />\r\n          </InlineField>\r\n          <InlineField\r\n            label=\"Basis\"\r\n            labelWidth={LABEL_WIDTH}\r\n            tooltip={\r\n              'Defines the possible calculation options when performing summary calculations over time-series data.'\r\n            }\r\n          >\r\n            <Segment\r\n              Component={<CustomLabelComponent value={{ value: summary.basis }} label={summary.basis} />}\r\n              onChange={this.calcBasisValueChanged}\r\n              options={this.getCalcBasisSegments()}\r\n              allowCustomValue\r\n            />\r\n          </InlineField>\r\n          <InlineField label=\"Summaries\" labelWidth={LABEL_WIDTH} tooltip={'Replacement for bad quality values.'}>\r\n            <InlineFieldRow>\r\n              {this.state.summaries.map((s: SelectableValue<PIWebAPISelectableValue>, index: number) => {\r\n                return (\r\n                  <Segment\r\n                    key={'summaries-' + index}\r\n                    Component={<CustomLabelComponent value={s.value} label={s.label} />}\r\n                    onChange={(item) => this.onSummaryValueChanged(item, index)}\r\n                    options={this.getSummarySegments()}\r\n                    allowCustomValue\r\n                  />\r\n                );\r\n              })}\r\n              <Segment\r\n                Component={\r\n                  <CustomLabelComponent\r\n                    value={this.state.summarySegment.value}\r\n                    label={this.state.summarySegment.label}\r\n                  />\r\n                }\r\n                onChange={this.onSummaryAction}\r\n                options={this.getSummarySegments()}\r\n                allowCustomValue\r\n              />\r\n            </InlineFieldRow>\r\n          </InlineField>\r\n        </InlineFieldRow>\r\n\r\n        <InlineFieldRow>\r\n          <InlineField\r\n            label=\"Display Name\"\r\n            labelWidth={LABEL_WIDTH}\r\n            tooltip={'If single attribute, modify display name. Otherwise use regex to modify display name.'}\r\n          >\r\n            <Input\r\n              onBlur={onRunQuery}\r\n              value={display}\r\n              onChange={(event: ChangeEvent<HTMLInputElement>) =>\r\n                this.onChange({ ...metricsQuery, display: event.target.value })\r\n              }\r\n              placeholder=\"Display\"\r\n            />\r\n          </InlineField>\r\n          <InlineField label=\"Enable Regex Replace\" labelWidth={LABEL_WIDTH}>\r\n            <InlineSwitch\r\n              value={regex.enable}\r\n              onChange={() => {\r\n                this.onChange({ ...metricsQuery, regex: { ...regex, enable: !regex.enable } });\r\n              }}\r\n            />\r\n          </InlineField>\r\n          <InlineField label=\"Search\" labelWidth={LABEL_WIDTH - 8}>\r\n            <Input\r\n              onBlur={onRunQuery}\r\n              value={regex.search}\r\n              onChange={(event: ChangeEvent<HTMLInputElement>) =>\r\n                this.onChange({ ...metricsQuery, regex: { ...regex, search: event.target.value } })\r\n              }\r\n              placeholder=\"(.*)\"\r\n            />\r\n          </InlineField>\r\n          <InlineField label=\"Replace\" labelWidth={LABEL_WIDTH - 8}>\r\n            <Input\r\n              onBlur={onRunQuery}\r\n              value={regex.replace}\r\n              onChange={(event: ChangeEvent<HTMLInputElement>) =>\r\n                this.onChange({ ...metricsQuery, regex: { ...regex, replace: event.target.value } })\r\n              }\r\n              placeholder=\"$1\"\r\n            />\r\n          </InlineField>\r\n        </InlineFieldRow>\r\n      </>\r\n    );\r\n  }\r\n}\r\n","import { curry, each, filter, flatten, forOwn, groupBy, keys, map, uniq } from 'lodash';\r\n\r\nimport {\r\n  DataQueryRequest,\r\n  DataQueryResponse,\r\n  DataSourceApi,\r\n  DataSourceInstanceSettings,\r\n  AnnotationEvent,\r\n  toDataFrame,\r\n  MetricFindValue,\r\n} from '@grafana/data';\r\nimport { BackendSrv, getBackendSrv, getTemplateSrv, TemplateSrv } from '@grafana/runtime';\r\n\r\nimport { PIWebAPIQuery, PIWebAPIDataSourceJsonData } from './types';\r\n\r\ninterface PiwebapiElementPath {\r\n  path: string;\r\n  variable: string;\r\n}\r\n\r\ninterface PiwebapiInternalRsp {\r\n  data: PiwebapiRsp;\r\n  status: number;\r\n  url: string;\r\n}\r\n\r\ninterface PiwebapTargetRsp {\r\n  refId: string;\r\n  target: string;\r\n  datapoints: any[];\r\n}\r\n\r\ninterface PiwebapiRsp {\r\n  Name?: string;\r\n  InstanceType?: string;\r\n  Items?: PiwebapiRsp[];\r\n  WebId?: string;\r\n  HasChildren?: boolean;\r\n  Path?: string;\r\n}\r\n\r\ninterface PiDataServer {\r\n  name: string | undefined;\r\n  webid: string | undefined;\r\n}\r\n\r\nexport class PiWebAPIDatasource extends DataSourceApi<PIWebAPIQuery, PIWebAPIDataSourceJsonData> {\r\n  piserver: PiDataServer;\r\n  afserver: PiDataServer;\r\n  afdatabase: PiDataServer;\r\n\r\n  basicAuth?: string;\r\n  withCredentials?: boolean;\r\n  url: string;\r\n  name: string;\r\n  isProxy = false;\r\n\r\n  templateSrv: TemplateSrv;\r\n  backendSrv: BackendSrv;\r\n\r\n  piwebapiurl?: string;\r\n  webidCache: Map<String, any> = new Map();\r\n\r\n  error: any;\r\n\r\n  constructor(instanceSettings: DataSourceInstanceSettings<PIWebAPIDataSourceJsonData>) {\r\n    super(instanceSettings);\r\n    this.basicAuth = instanceSettings.basicAuth;\r\n    this.withCredentials = instanceSettings.withCredentials;\r\n    this.url = instanceSettings.url!;\r\n    this.name = instanceSettings.name;\r\n    this.templateSrv = getTemplateSrv();\r\n    this.backendSrv = getBackendSrv();\r\n\r\n    this.piwebapiurl = instanceSettings.jsonData.url?.toString();\r\n    this.isProxy = /^http(s)?:\\/\\//.test(this.url) || instanceSettings.jsonData.access === 'proxy';\r\n\r\n    this.piserver = { name: (instanceSettings.jsonData || {}).piserver, webid: undefined };\r\n    this.afserver = { name: (instanceSettings.jsonData || {}).afserver, webid: undefined };\r\n    this.afdatabase = { name: (instanceSettings.jsonData || {}).afdatabase, webid: undefined };\r\n\r\n    Promise.all([\r\n      this.getAssetServer(this.afserver.name).then((result: PiwebapiRsp) => (this.afserver.webid = result.WebId)),\r\n      this.getDataServer(this.piserver.name).then((result: PiwebapiRsp) => (this.piserver.webid = result.WebId)),\r\n      this.getDatabase(this.afserver.name ? this.afserver.name + '\\\\' + this.afdatabase.name : undefined).then(\r\n        (result: PiwebapiRsp) => (this.afdatabase.webid = result.WebId)\r\n      ),\r\n    ]);\r\n  }\r\n\r\n  /**\r\n   * Converts a PIWebAPI Event Frame response to a Grafana Annotation\r\n   *\r\n   * @param {any} annotationOptions - Options data from configuration panel.\r\n   * @param {any} endTime - End time of the Event Frame.\r\n   * @param {any} eventFrame - The Event Frame data.\r\n   * @returns - Grafana Annotation\r\n   *\r\n   * @memberOf PiWebApiDatasource\r\n   */\r\n  private eventFrameToAnnotation(\r\n    annotationOptions: any,\r\n    endTime: any,\r\n    eventFrame: any,\r\n    attributeDataItems: any\r\n  ): AnnotationEvent {\r\n    if (annotationOptions.regex && annotationOptions.regex.enable) {\r\n      eventFrame.Name = eventFrame.Name.replace(\r\n        new RegExp(annotationOptions.regex.search),\r\n        annotationOptions.regex.replace\r\n      );\r\n    }\r\n\r\n    var attributeText = '';\r\n    if (attributeDataItems) {\r\n      each(attributeDataItems, (attributeData: any) => {\r\n        const attributeValue = attributeData.Value.Value\r\n          ? attributeData.Value.Value.Name || attributeData.Value.Value.Value || attributeData.Value.Value\r\n          : null;\r\n        attributeText += '<br />' + attributeData.Name + ': ' + attributeValue;\r\n      });\r\n    }\r\n    return {\r\n      annotation: annotationOptions,\r\n      title: (endTime ? 'END ' : annotationOptions.showEndTime ? 'START ' : '') + annotationOptions.name,\r\n      time: new Date(endTime ? eventFrame.EndTime : eventFrame.StartTime).getTime(),\r\n      text:\r\n        eventFrame.Name + attributeText + '<br />Start: ' + eventFrame.StartTime + '<br />End: ' + eventFrame.EndTime,\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Builds the PIWebAPI query parameters.\r\n   *\r\n   * @param {any} options - Grafana query and panel options.\r\n   * @returns - PIWebAPI query parameters.\r\n   *\r\n   * @memberOf PiWebApiDatasource\r\n   */\r\n  private buildQueryParameters(options: DataQueryRequest<PIWebAPIQuery>) {\r\n    options.targets = filter(options.targets, (target) => {\r\n      if (!target || !target.target) {\r\n        return false;\r\n      }\r\n      return !target.target.startsWith('Select AF');\r\n    });\r\n\r\n    options.targets = map(options.targets, (target) => {\r\n      const ds = this;\r\n      var tar = {\r\n        target: this.templateSrv.replace(target.elementPath, options.scopedVars),\r\n        elementPath: this.templateSrv.replace(target.elementPath, options.scopedVars),\r\n        elementPathArray: [\r\n          {\r\n            path: this.templateSrv.replace(target.elementPath, options.scopedVars),\r\n            variable: '',\r\n          } as PiwebapiElementPath,\r\n        ],\r\n        attributes: map(target.attributes, (att) =>\r\n          this.templateSrv.replace(att.value?.value || att, options.scopedVars)\r\n        ),\r\n        segments: map(target.segments, (att) => this.templateSrv.replace(att.value?.value, options.scopedVars)),\r\n        display: target.display,\r\n        refId: target.refId,\r\n        hide: target.hide,\r\n        interpolate: target.interpolate || { enable: false },\r\n        recordedValues: target.recordedValues || { enable: false },\r\n        digitalStates: target.digitalStates || { enable: false },\r\n        webid: target.webid,\r\n        webids: target.webids || [],\r\n        regex: target.regex || { enable: false },\r\n        expression: target.expression || '',\r\n        summary: target.summary || { types: [] },\r\n        startTime: options.range.from,\r\n        endTime: options.range.to,\r\n        isPiPoint: target.isPiPoint,\r\n        scopedVars: options.scopedVars,\r\n      };\r\n\r\n      if (tar.expression) {\r\n        tar.expression = this.templateSrv.replace(tar.expression, options.scopedVars);\r\n      }\r\n\r\n      if (tar.summary.types !== undefined) {\r\n        tar.summary.types = filter(tar.summary.types, (item) => {\r\n          return item !== undefined && item !== null && item !== '';\r\n        });\r\n      }\r\n\r\n      // explode All or Multi-selection\r\n      const varsKeys = keys(options.scopedVars);\r\n      this.templateSrv.getVariables().forEach((v: any) => {\r\n        if (ds.isAllSelected(v.current) && varsKeys.indexOf(v.name) < 0) {\r\n          // All selection\r\n          const variables = v.options.filter((o: any) => !o.selected);\r\n          // attributes\r\n          tar.attributes = tar.attributes.map((attr: string) =>\r\n            variables.map((vv: any) =>\r\n              !!v.allValue ? attr.replace(v.allValue, vv.value) : attr.replace(/{[a-zA-z0-9,-_]+}/gi, vv.value)\r\n            )\r\n          );\r\n          tar.attributes = uniq(flatten(tar.attributes));\r\n          // elementPath\r\n          tar.elementPathArray = ds.getElementPath(tar.elementPathArray, variables, v.allValue);\r\n        } else if (Array.isArray(v.current.text) && varsKeys.indexOf(v.name) < 0) {\r\n          // Multi-selection\r\n          const variables = v.options.filter((o: any) => o.selected);\r\n          // attributes\r\n          const query = v.current.value.join(',');\r\n          tar.attributes = tar.attributes.map((attr: string) =>\r\n            variables.map((vv: any) => attr.replace(`{${query}}`, vv.value))\r\n          );\r\n          tar.attributes = uniq(flatten(tar.attributes));\r\n          // elementPath\r\n          tar.elementPathArray = ds.getElementPath(tar.elementPathArray, variables, `{${query}}`);\r\n        }\r\n      });\r\n\r\n      return tar;\r\n    });\r\n\r\n    return options;\r\n  }\r\n\r\n  /**\r\n   * Datasource Implementation. Primary entry point for data source.\r\n   * This takes the panel configuration and queries, sends them to PI Web API and parses the response.\r\n   *\r\n   * @param {any} options - Grafana query and panel options.\r\n   * @returns - Promise of data in the format for Grafana panels.\r\n   *\r\n   * @memberOf PiWebApiDatasource\r\n   */\r\n  async query(options: DataQueryRequest<PIWebAPIQuery>): Promise<DataQueryResponse> {\r\n    var ds = this;\r\n    var query = this.buildQueryParameters(options);\r\n    query.targets = filter(query.targets, (t) => !t.hide);\r\n\r\n    if (query.targets.length <= 0) {\r\n      return Promise.resolve({ data: [] });\r\n    } else {\r\n      return Promise.all(ds.getStream(query)).then((targetResponses) => {\r\n        let flattened: PiwebapTargetRsp[] = [];\r\n        each(targetResponses, (tr) => {\r\n          each(tr, (item) => flattened.push(item));\r\n        });\r\n        const response: DataQueryResponse = {\r\n          data: flattened\r\n            .sort((a, b) => {\r\n              return +(a.target > b.target) || +(a.target === b.target) - 1;\r\n            })\r\n            .map((d) => toDataFrame(d)),\r\n        };\r\n        return response;\r\n      });\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Datasource Implementation.\r\n   * Used for testing datasource in datasource configuration pange\r\n   *\r\n   * @returns - Success or failure message.\r\n   *\r\n   * @memberOf PiWebApiDatasource\r\n   */\r\n  testDatasource(): Promise<any> {\r\n    return this.backendSrv\r\n      .datasourceRequest({\r\n        url: this.url + '/',\r\n        method: 'GET',\r\n      })\r\n      .then((response: any) => {\r\n        if (response.status === 200) {\r\n          return { status: 'success', message: 'Data source is working', title: 'Success' };\r\n        }\r\n        throw new Error('Failed');\r\n      });\r\n  }\r\n\r\n  /**\r\n   * Datasource Implementation.\r\n   * This queries PI Web API for Event Frames and converts them into annotations.\r\n   *\r\n   * @param {any} options - Annotation options, usually the Event Frame Category.\r\n   * @returns - A Grafana annotation.\r\n   *\r\n   * @memberOf PiWebApiDatasource\r\n   */\r\n  annotationQuery(options: any): Promise<AnnotationEvent[]> {\r\n    if (!this.afdatabase.webid) {\r\n      return Promise.resolve([]);\r\n    }\r\n\r\n    var categoryName = options.annotation.query.categoryName\r\n      ? this.templateSrv.replace(options.annotation.query.categoryName, options.scopedVars, 'glob')\r\n      : null;\r\n    var nameFilter = options.annotation.query.nameFilter\r\n      ? this.templateSrv.replace(options.annotation.query.nameFilter, options.scopedVars, 'glob')\r\n      : null;\r\n    var templateName = options.annotation.template ? options.annotation.template.Name : null;\r\n    var annotationOptions = {\r\n      name: options.annotation.name,\r\n      datasource: options.annotation.datasource,\r\n      enable: options.annotation.enable,\r\n      iconColor: options.annotation.iconColor,\r\n      showEndTime: options.annotation.showEndTime,\r\n      regex: options.annotation.regex,\r\n      attribute: options.annotation.attribute,\r\n      categoryName: categoryName,\r\n      templateName: templateName,\r\n      nameFilter: nameFilter,\r\n    };\r\n\r\n    var filter = [];\r\n    if (!!annotationOptions.categoryName) {\r\n      filter.push('categoryName=' + annotationOptions.categoryName);\r\n    }\r\n    if (!!annotationOptions.nameFilter) {\r\n      filter.push('nameFilter=' + annotationOptions.nameFilter);\r\n    }\r\n    if (!!annotationOptions.templateName) {\r\n      filter.push('templateName=' + annotationOptions.templateName);\r\n    }\r\n    if (!filter.length) {\r\n      return Promise.resolve([]);\r\n    }\r\n    filter.push('startTime=' + options.range.from.toJSON());\r\n    filter.push('endTime=' + options.range.to.toJSON());\r\n\r\n    if (annotationOptions.attribute && annotationOptions.attribute.enable) {\r\n      var resourceUrl =\r\n        this.piwebapiurl + '/streamsets/{0}/value?selectedFields=Items.WebId%3BItems.Value%3BItems.Name';\r\n      if (!!annotationOptions.attribute.name) {\r\n        resourceUrl =\r\n          this.piwebapiurl +\r\n          '/streamsets/{0}/value?nameFilter=' +\r\n          annotationOptions.attribute.name +\r\n          '&selectedFields=Items.WebId%3BItems.Value%3BItems.Name';\r\n      }\r\n      var query: any = {};\r\n      query['1'] = {\r\n        Method: 'GET',\r\n        Resource: this.piwebapiurl + '/assetdatabases/' + this.afdatabase.webid + '/eventframes?' + filter.join('&'),\r\n      };\r\n      query['2'] = {\r\n        Method: 'GET',\r\n        RequestTemplate: {\r\n          Resource: resourceUrl,\r\n        },\r\n        Parameters: ['$.1.Content.Items[*].WebId'],\r\n        ParentIds: ['1'],\r\n      };\r\n      return this.restBatch(query).then((result: any) => {\r\n        const data = result.data['1'].Content;\r\n        const valueData = result.data['2'].Content;\r\n\r\n        var annotations = map(data.Items, (item: any, index: any) => {\r\n          return curry(this.eventFrameToAnnotation)(\r\n            annotationOptions,\r\n            false,\r\n            item,\r\n            valueData.Items[index].Content.Items\r\n          );\r\n        });\r\n\r\n        if (options.annotation.showEndTime) {\r\n          var ends = map(data.Items, (item: any, index: number) => {\r\n            return curry(this.eventFrameToAnnotation)(\r\n              annotationOptions,\r\n              true,\r\n              item,\r\n              valueData.Items[index].Content.Items\r\n            );\r\n          });\r\n          each(ends, (end) => {\r\n            annotations.push(end);\r\n          });\r\n        }\r\n\r\n        return annotations;\r\n      });\r\n    } else {\r\n      return this.restGet('/assetdatabases/' + this.afdatabase.webid + '/eventframes?' + filter.join('&')).then(\r\n        (result) => {\r\n          var annotations = map(result.data.Items, curry(this.eventFrameToAnnotation)(annotationOptions, false));\r\n          if (options.annotation.showEndTime) {\r\n            var ends = map(result.data.Items, curry(this.eventFrameToAnnotation)(annotationOptions, true));\r\n            each(ends, (end) => {\r\n              annotations.push(end);\r\n            });\r\n          }\r\n          return annotations;\r\n        }\r\n      );\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Builds the Grafana metric segment for use on the query user interface.\r\n   *\r\n   * @param {any} response - response from PI Web API.\r\n   * @returns - Grafana metric segment.\r\n   *\r\n   * @memberOf PiWebApiDatasource\r\n   */\r\n  private metricQueryTransform(response: PiwebapiRsp[]): MetricFindValue[] {\r\n    return map(response, (item) => {\r\n      return {\r\n        text: item.Name,\r\n        expandable:\r\n          item.HasChildren === undefined || item.HasChildren === true || (item.Path ?? '').split('\\\\').length <= 3,\r\n        HasChildren: item.HasChildren,\r\n        Items: item.Items ?? [],\r\n        Path: item.Path,\r\n        WebId: item.WebId,\r\n      } as MetricFindValue;\r\n    });\r\n  }\r\n\r\n  /**\r\n   * This method does the discovery of the AF Hierarchy and populates the query user interface segments.\r\n   *\r\n   * @param {any} query - Parses the query configuration and builds a PI Web API query.\r\n   * @returns - Segment information.\r\n   *\r\n   * @memberOf PiWebApiDatasource\r\n   */\r\n  metricFindQuery(query: any, queryOptions: any): Promise<MetricFindValue[]> {\r\n    var ds = this;\r\n    var querydepth = ['servers', 'databases', 'databaseElements', 'elements'];\r\n    if (typeof query === 'string') {\r\n      query = JSON.parse(query as string);\r\n    }\r\n    if (queryOptions.isPiPoint) {\r\n      query.path = this.templateSrv.replace(query.path, queryOptions);\r\n    } else {\r\n      if (query.path === '') {\r\n        query.type = querydepth[0];\r\n      } else if (query.type !== 'attributes') {\r\n        query.type = querydepth[Math.max(0, Math.min(query.path.split('\\\\').length, querydepth.length - 1))];\r\n      }\r\n      query.path = this.templateSrv.replace(query.path, queryOptions);\r\n      query.path = query.path.replace(/\\{([^\\\\])*\\}/gi, (r: string) => r.substring(1, r.length - 2).split(',')[0]);\r\n    }\r\n\r\n    query.filter = query.filter ?? '*';\r\n\r\n    if (query.type === 'servers') {\r\n      return ds.afserver?.name\r\n        ? ds\r\n            .getAssetServer(ds.afserver.name)\r\n            .then((result: PiwebapiRsp) => [result])\r\n            .then(ds.metricQueryTransform)\r\n        : ds.getAssetServers().then(ds.metricQueryTransform);\r\n    } else if (query.type === 'databases') {\r\n      return ds\r\n        .getAssetServer(query.path)\r\n        .then((server) => ds.getDatabases(server.WebId ?? '', {}))\r\n        .then(ds.metricQueryTransform);\r\n    } else if (query.type === 'databaseElements') {\r\n      return ds\r\n        .getDatabase(query.path)\r\n        .then((db) =>\r\n          ds.getDatabaseElements(db.WebId ?? '', {\r\n            selectedFields: 'Items.WebId%3BItems.Name%3BItems.Items%3BItems.Path%3BItems.HasChildren',\r\n          })\r\n        )\r\n        .then(ds.metricQueryTransform);\r\n    } else if (query.type === 'elements') {\r\n      return ds\r\n        .getElement(query.path)\r\n        .then((element) =>\r\n          ds.getElements(element.WebId ?? '', {\r\n            selectedFields: 'Items.WebId%3BItems.Name%3BItems.Items%3BItems.Path%3BItems.HasChildren',\r\n            nameFilter: query.filter,\r\n          })\r\n        )\r\n        .then(ds.metricQueryTransform);\r\n    } else if (query.type === 'attributes') {\r\n      return ds\r\n        .getElement(query.path)\r\n        .then((element) =>\r\n          ds.getAttributes(element.WebId ?? '', {\r\n            searchFullHierarchy: 'true',\r\n            selectedFields: 'Items.WebId%3BItems.Name%3BItems.Path',\r\n            nameFilter: query.filter,\r\n          })\r\n        )\r\n        .then(ds.metricQueryTransform);\r\n    } else if (query.type === 'dataserver') {\r\n      return ds.getDataServers().then(ds.metricQueryTransform);\r\n    } else if (query.type === 'pipoint') {\r\n      return ds.piPointSearch(query.webId, query.pointName).then(ds.metricQueryTransform);\r\n    }\r\n    return Promise.reject('Bad type');\r\n  }\r\n\r\n  /**\r\n   * Gets the url of summary data from the query configuration.\r\n   *\r\n   * @param {any} summary - Query summary configuration.\r\n   * @returns - URL append string.\r\n   *\r\n   * @memberOf PiWebApiDatasource\r\n   */\r\n  getSummaryUrl(summary: any) {\r\n    if (summary.interval.trim() === '') {\r\n      return (\r\n        '&summaryType=' +\r\n        summary.types.map((s: any) => s.value?.value).join('&summaryType=') +\r\n        '&calculationBasis=' +\r\n        summary.basis\r\n      );\r\n    }\r\n    return (\r\n      '&summaryType=' +\r\n      summary.types.map((s: any) => s.value?.value).join('&summaryType=') +\r\n      '&calculationBasis=' +\r\n      summary.basis +\r\n      '&summaryDuration=' +\r\n      summary.interval.trim()\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Resolve PIWebAPI response 'value' data to value - timestamp pairs.\r\n   *\r\n   * @param {any} value - A list of PIWebAPI values.\r\n   * @param {any} target - The target Grafana metric.\r\n   * @param {any} isSummary - Boolean for tracking if data is of summary class.\r\n   * @returns - An array of Grafana value, timestamp pairs.\r\n   *\r\n   */\r\n  parsePiPointValueList(value: any[], target: any, isSummary: boolean) {\r\n    var api = this;\r\n    var datapoints: any[] = [];\r\n    each(value, (item) => {\r\n      // @ts-ignore\r\n      var { grafanaDataPoint, previousValue, drop } = this.noDataReplace(\r\n        isSummary ? item.Value : item,\r\n        target.summary.nodata,\r\n        api.parsePiPointValue(isSummary ? item.Value : item, target, isSummary)\r\n      );\r\n      if (!drop) {\r\n        datapoints.push(grafanaDataPoint);\r\n      }\r\n    });\r\n    return datapoints;\r\n  }\r\n\r\n  /**\r\n   * Convert a PI Point value to use Grafana value/timestamp.\r\n   *\r\n   * @param {any} value - PI Point value.\r\n   * @param {any} isSummary - Boolean for tracking if data is of summary class.\r\n   * @param {any} target - The target grafana metric.\r\n   * @returns - Grafana value pair.\r\n   *\r\n   */\r\n  parsePiPointValue(value: any, target: any, isSummary: boolean) {\r\n    let num = !isSummary && typeof value.Value === 'object' ? value.Value?.Value : value.Value;\r\n\r\n    if (!value.Good || !!target.digitalStates?.enable) {\r\n      num = !isSummary && typeof value.Value === 'object' ? value.Value.Name : value.Name;\r\n      return [num.trim(), new Date(value.Timestamp).getTime()];\r\n    }\r\n\r\n    return [this.checkNumber(num) ? Number(num) : num.trim(), new Date(value.Timestamp).getTime()];\r\n  }\r\n\r\n  /**\r\n   * Resolve PIWebAPI response 'value' data to value - timestamp pairs.\r\n   *\r\n   * @param {any} item - 'Item' object from PIWebAPI\r\n   * @param {any} noDataReplacementMode - String state of how to replace 'No Data'\r\n   * @param {any} grafanaDataPoint - Single Grafana value pair (value, timestamp).\r\n   * @returns grafanaDataPoint - Single Grafana value pair (value, timestamp).\r\n   * @returns perviousValue - {any} Grafana value (value only).\r\n   *\r\n   */\r\n  noDataReplace(\r\n    item: any,\r\n    noDataReplacementMode: any,\r\n    grafanaDataPoint: any[]\r\n  ): {\r\n    grafanaDataPoint: any[];\r\n    previousValue: any;\r\n    drop: boolean;\r\n  } {\r\n    var previousValue = null;\r\n    var drop = false;\r\n    if (!item.Good || item.Value === 'No Data' || (item.Value?.Name && item.Value?.Name === 'No Data')) {\r\n      if (noDataReplacementMode === 'Drop') {\r\n        drop = true;\r\n      } else if (noDataReplacementMode === '0') {\r\n        grafanaDataPoint[0] = 0;\r\n      } else if (noDataReplacementMode === 'Keep') {\r\n        // Do nothing keep\r\n      } else if (noDataReplacementMode === 'Null') {\r\n        grafanaDataPoint[0] = null;\r\n      } else if (noDataReplacementMode === 'Previous' && previousValue !== null) {\r\n        grafanaDataPoint[0] = previousValue;\r\n      }\r\n    } else {\r\n      previousValue = item.Value;\r\n    }\r\n    return { grafanaDataPoint, previousValue, drop };\r\n  }\r\n\r\n  /**\r\n   * Process the response from PI Web API for a single item.\r\n   *\r\n   * @param {any} content - Web response data.\r\n   * @param {any} target - The target grafana metric.\r\n   * @param {any} name - The target metric name.\r\n   * @returns - Parsed metric in target/datapoint json format.\r\n   *\r\n   * @memberOf PiWebApiDatasource\r\n   */\r\n  processResults(content: any, target: any, name: any, noTemplate: boolean): PiwebapTargetRsp[] {\r\n    const api = this;\r\n    const isSummary: boolean = target.summary && target.summary.types && target.summary.types.length > 0;\r\n    name = noTemplate ? name : this.getPath(target.elementPathArray, content.Path) + '|' + name;\r\n    if (target.regex && target.regex.enable && target.regex.search.length && target.regex.replace.length) {\r\n      name = name.replace(new RegExp(target.regex.search), target.regex.replace);\r\n    }\r\n    if (isSummary) {\r\n      var innerResults: any[] = [];\r\n      var groups = groupBy(content.Items, (item: any) => item.Type);\r\n      forOwn(groups, (value, key) => {\r\n        innerResults.push({\r\n          refId: target.refId,\r\n          target: name + '[' + key + ']',\r\n          datapoints: api.parsePiPointValueList(value, target, isSummary),\r\n        });\r\n      });\r\n      return innerResults;\r\n    }\r\n    return [\r\n      {\r\n        refId: target.refId,\r\n        target: name,\r\n        datapoints: api.parsePiPointValueList(content.Items, target, isSummary),\r\n      },\r\n    ];\r\n  }\r\n\r\n  /** PRIVATE SECTION */\r\n\r\n  /**\r\n   * Check if all items are selected.\r\n   *\r\n   * @param {any} current the current variable selection\r\n   * @return {boolean} true if all value is selected, false otherwise\r\n   */\r\n  private isAllSelected(current: any): boolean {\r\n    if (!current) {\r\n      return false;\r\n    }\r\n    if (Array.isArray(current.text)) {\r\n      return current.text.indexOf('All') >= 0;\r\n    }\r\n    return current.text === 'All';\r\n  }\r\n\r\n  /**\r\n   * Check if the value is a number.\r\n   *\r\n   * @param {any} number the value to check\r\n   * @returns {boolean} true if the value is a number, false otherwise\r\n   */\r\n  private checkNumber(number: any): boolean {\r\n    return typeof number === 'number' && !Number.isNaN(number) && Number.isFinite(number);\r\n  }\r\n\r\n  /**\r\n   * Returns a new element path list based on the panel variables.\r\n   *\r\n   * @param {string} elementPathArray array of element paths\r\n   * @param {string} variables the list of variable values\r\n   * @param {string} allValue the all value value for the variable\r\n   * @returns {PiwebapiElementPath[]} new element path list\r\n   */\r\n  private getElementPath(\r\n    elementPathArray: PiwebapiElementPath[],\r\n    variables: any[],\r\n    allValue: string\r\n  ): PiwebapiElementPath[] {\r\n    // elementPath\r\n    let newElementPathArray: PiwebapiElementPath[] = [];\r\n    elementPathArray.forEach((elem: PiwebapiElementPath) => {\r\n      if ((!!allValue && elem.path.indexOf(allValue) >= 0) || (!allValue && elem.path.match(/{[a-zA-z0-9,-_]+}/gi))) {\r\n        const temp: PiwebapiElementPath[] = variables.map((vv: any) => {\r\n          return {\r\n            path: !!allValue\r\n              ? elem.path.replace(allValue, vv.value)\r\n              : elem.path.replace(/{[a-zA-z0-9,-_]+}/gi, vv.value),\r\n            variable: vv.value,\r\n          } as PiwebapiElementPath;\r\n        });\r\n        newElementPathArray = newElementPathArray.concat(temp);\r\n      }\r\n    });\r\n    if (newElementPathArray.length) {\r\n      return uniq(flatten(newElementPathArray));\r\n    }\r\n    return elementPathArray;\r\n  }\r\n\r\n  /**\r\n   * Returns the last item of the element path.\r\n   *\r\n   * @param {string} path element path\r\n   * @returns {string} last item of the element path\r\n   */\r\n  private getPath(elementPathArray: PiwebapiElementPath[], path: string): string {\r\n    let splitPath = path.split('|');\r\n    if (splitPath.length === 0) {\r\n      return '';\r\n    }\r\n    if (elementPathArray.length === 0) {\r\n      return '';\r\n    }\r\n    splitPath = splitPath[0].split('\\\\');\r\n    const splitStr = splitPath.length === 0 ? '' : splitPath.pop() ?? '';\r\n    const foundElement = elementPathArray.find((e) => path.indexOf(e.path) >= 0)?.variable;\r\n    return foundElement ? foundElement + '|' + splitStr : splitStr;\r\n  }\r\n\r\n  /**\r\n   * Gets historical data from a PI Web API stream source.\r\n   *\r\n   * @param {any} query - Grafana query.\r\n   * @returns - Metric data.\r\n   *\r\n   * @memberOf PiWebApiDatasource\r\n   */\r\n  private getStream(query: any): Array<Promise<PiwebapTargetRsp[]>> {\r\n    const ds = this;\r\n    var results: Array<Promise<PiwebapTargetRsp[]>> = [];\r\n\r\n    each(query.targets, (target) => {\r\n      target.attributes = filter(target.attributes || [], (attribute) => {\r\n        return 1 && attribute;\r\n      });\r\n      var url = '';\r\n      var isSummary = target.summary && target.summary.types && target.summary.types.length > 0;\r\n      var isInterpolated = target.interpolate && target.interpolate.enable;\r\n      // perhaps add a check to see if interpolate override time < query.interval\r\n      var intervalTime = target.interpolate.interval ? target.interpolate.interval : query.interval;\r\n      var timeRange = '?startTime=' + query.range.from.toJSON() + '&endTime=' + query.range.to.toJSON();\r\n      var targetName = target.expression || target.elementPath;\r\n      var displayName = target.display ? this.templateSrv.replace(target.display, query.scopedVars) : null;\r\n      if (target.expression) {\r\n        url += '/calculation';\r\n        if (isSummary) {\r\n          url += '/summary' + timeRange + (isInterpolated ? '&sampleType=Interval&sampleInterval=' + intervalTime : '');\r\n        } else {\r\n          url += '/intervals' + timeRange + '&sampleInterval=' + intervalTime;\r\n        }\r\n        url += '&expression=' + encodeURIComponent(target.expression);\r\n        if (target.attributes.length > 0) {\r\n          results.push(ds.internalStream(query, target, url));\r\n        } else {\r\n          results.push(\r\n            ds.restGetWebId(target.elementPath, target.isPiPoint).then((webidresponse: any) => {\r\n              return ds\r\n                .restPost(url + webidresponse.WebId)\r\n                .then((response: any) => ds.processResults(response.data, target, displayName || targetName, false))\r\n                .catch((err: any) => (ds.error = err));\r\n            })\r\n          );\r\n        }\r\n      } else {\r\n        url += '/streamsets';\r\n        if (isSummary) {\r\n          url += '/summary' + timeRange + '&intervals=' + query.maxDataPoints + this.getSummaryUrl(target.summary);\r\n        } else if (target.interpolate && target.interpolate.enable) {\r\n          url += '/interpolated' + timeRange + '&interval=' + intervalTime;\r\n        } else if (target.recordedValues && target.recordedValues.enable) {\r\n          const maxNumber =\r\n            target.recordedValues.maxNumber && !isNaN(target.recordedValues.maxNumber)\r\n              ? target.recordedValues.maxNumber\r\n              : 1000;\r\n          url += '/recorded' + timeRange + '&maxCount=' + maxNumber;\r\n        } else {\r\n          url += '/plot' + timeRange + '&intervals=' + query.maxDataPoints;\r\n        }\r\n\r\n        results.push(ds.internalStream(query, target, url));\r\n      }\r\n    });\r\n\r\n    return results;\r\n  }\r\n\r\n  /**\r\n   * Return the data points from the provided Grafana query.\r\n   *\r\n   * @param {any} query - Grafana query.\r\n   * @param {any} target - Grafana query target.\r\n   * @param {string} url - The base URL for the query.\r\n   * @returns - Metric data.\r\n   *\r\n   * @memberOf PiWebApiDatasource\r\n   */\r\n  private internalStream(query: any, target: any, url: string): Promise<PiwebapTargetRsp[]> {\r\n    const ds = this;\r\n    const targetName = target.expression || target.elementPath;\r\n    const displayName = target.display ? this.templateSrv.replace(target.display, query.scopedVars) : null;\r\n    const noTemplate = target.elementPathArray.length === 1 && target.elementPath === target.elementPathArray[0].path;\r\n    let promises: Promise<PiwebapiRsp[]>;\r\n\r\n    if (noTemplate) {\r\n      if (target.attributes.length > 1) {\r\n        promises = ds\r\n          .restGetWebId(target.elementPath, target.isPiPoint)\r\n          .then((datarsp) =>\r\n            ds.getAttributes(datarsp.WebId!, {\r\n              searchFullHierarchy: 'true',\r\n              nameFilter: '*',\r\n            })\r\n          )\r\n          .then((datarspa) =>\r\n            datarspa.filter(\r\n              (d) =>\r\n                target.attributes.indexOf(d.Name) >= 0 ||\r\n                target.attributes.indexOf(d.Path?.split('|').splice(1).join('|')) >= 0\r\n            )\r\n          );\r\n      } else {\r\n        promises = Promise.all(\r\n          map(target.attributes, (attribute: string) =>\r\n            ds.restGetWebId(target.elementPath + '|' + attribute, target.isPiPoint)\r\n          )\r\n        );\r\n      }\r\n    } else {\r\n      if (target.attributes.length > 1) {\r\n        promises = Promise.all(\r\n          target.elementPathArray.map((elementPath: PiwebapiElementPath) => {\r\n            return ds\r\n              .restGetWebId(elementPath.path, target.isPiPoint)\r\n              .then((datarsp) =>\r\n                ds.getAttributes(datarsp.WebId!, {\r\n                  searchFullHierarchy: 'true',\r\n                  nameFilter: '*',\r\n                })\r\n              )\r\n              .then((datarspa) =>\r\n                datarspa.filter(\r\n                  (d) =>\r\n                    target.attributes.indexOf(d.Name) >= 0 ||\r\n                    target.attributes.indexOf(d.Path?.split('|').splice(1).join('|')) >= 0\r\n                )\r\n              );\r\n          })\r\n        );\r\n      } else {\r\n        promises = Promise.all(\r\n          flatten(\r\n            map(target.attributes, (attribute: string) => {\r\n              return target.elementPathArray.map((elementPath: PiwebapiElementPath) =>\r\n                ds.restGetWebId(elementPath.path + '|' + attribute, target.isPiPoint)\r\n              );\r\n            })\r\n          )\r\n        );\r\n      }\r\n    }\r\n\r\n    return promises.then((webidresponse) => {\r\n      const query: any = {};\r\n      each(flatten(webidresponse), (webid, index) => {\r\n        query[index + 1] = {\r\n          Method: 'GET',\r\n          Resource: ds.piwebapiurl + url + '&webid=' + webid.WebId,\r\n        };\r\n      });\r\n\r\n      return ds\r\n        .restBatch(query)\r\n        .then((response: any) => {\r\n          const targetResults: any[] = [];\r\n          each(response.data, (value, key) => {\r\n            if (target.expression) {\r\n              const attribute = webidresponse[parseInt(key, 10) - 1].Name;\r\n              each(\r\n                ds.processResults(value.Content, target, displayName || attribute || targetName, noTemplate),\r\n                (targetResult) => targetResults.push(targetResult)\r\n              );\r\n            } else {\r\n              each(value.Content.Items, (item) => {\r\n                each(\r\n                  ds.processResults(item, target, displayName || item.Name || targetName, noTemplate),\r\n                  (targetResult) => targetResults.push(targetResult)\r\n                );\r\n              });\r\n            }\r\n          });\r\n          return targetResults;\r\n        })\r\n        .catch((err: any) => (ds.error = err));\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Abstraction for calling the PI Web API REST endpoint\r\n   *\r\n   * @param {any} path - the path to append to the base server URL.\r\n   * @returns - The full URL.\r\n   *\r\n   * @memberOf PiWebApiDatasource\r\n   */\r\n  private restGet(path: string): Promise<PiwebapiInternalRsp> {\r\n    return this.backendSrv\r\n      .datasourceRequest({\r\n        url: this.url + path,\r\n        method: 'GET',\r\n        headers: { 'Content-Type': 'application/json' },\r\n      })\r\n      .then((response: any) => {\r\n        return response as PiwebapiInternalRsp;\r\n      });\r\n  }\r\n\r\n  /**\r\n   * Resolve a Grafana query into a PI Web API webid. Uses client side cache when possible to reduce lookups.\r\n   *\r\n   * @param {string} assetPath - The AF Path or the Pi Point Path (\\\\ServerName\\piPointName) to the asset.\r\n   * @param {boolean} isPiPoint - Flag indicating it's a PI Point\r\n   * @returns - URL query parameters.\r\n   *\r\n   * @memberOf PiWebApiDatasource\r\n   */\r\n  private restGetWebId(assetPath: string, isPiPoint: boolean): Promise<PiwebapiRsp> {\r\n    var ds = this;\r\n\r\n    // check cache\r\n    var cachedWebId = ds.webidCache.get(assetPath);\r\n    if (cachedWebId) {\r\n      return Promise.resolve({ Path: assetPath, WebId: cachedWebId.WebId, Name: cachedWebId.Name });\r\n    }\r\n\r\n    let path = '';\r\n    if (isPiPoint) {\r\n      path = '/points?selectedFields=WebId%3BName%3BPath&path=\\\\\\\\' + assetPath.replace('|', '\\\\');\r\n    } else {\r\n      // no cache hit, query server\r\n      path =\r\n        (assetPath.indexOf('|') >= 0\r\n          ? '/attributes?selectedFields=WebId%3BName%3BPath&path=\\\\\\\\'\r\n          : '/elements?selectedFields=WebId%3BName%3BPath&path=\\\\\\\\') + assetPath;\r\n    }\r\n\r\n    return this.backendSrv\r\n      .datasourceRequest({\r\n        url: this.url + path,\r\n        method: 'GET',\r\n        headers: { 'Content-Type': 'application/json' },\r\n      })\r\n      .then((response: any) => {\r\n        ds.webidCache.set(assetPath, response.data);\r\n        return { Path: assetPath, WebId: response.data.WebId, Name: response.data.Name };\r\n      });\r\n  }\r\n\r\n  /**\r\n   * Execute a batch query on the PI Web API.\r\n   *\r\n   * @param {any} batch - Batch JSON query data.\r\n   * @returns - Batch response.\r\n   *\r\n   * @memberOf PiWebApiDatasource\r\n   */\r\n  private restBatch(batch: any) {\r\n    return this.backendSrv.datasourceRequest({\r\n      url: this.url + '/batch',\r\n      data: batch,\r\n      method: 'POST',\r\n      headers: {\r\n        'Content-Type': 'application/json',\r\n        'X-Requested-With': 'message/http',\r\n      },\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Execute a POST on the PI Web API.\r\n   *\r\n   * @param {string} path - The full url of the POST.\r\n   * @returns - POST response data.\r\n   *\r\n   * @memberOf PiWebApiDatasource\r\n   */\r\n  private restPost(path: string) {\r\n    return this.backendSrv.datasourceRequest({\r\n      url: this.url,\r\n      method: 'POST',\r\n      headers: {\r\n        'Content-Type': 'application/json',\r\n        'X-Requested-With': 'message/http',\r\n        'X-PIWEBAPI-HTTP-METHOD': 'GET',\r\n        'X-PIWEBAPI-RESOURCE-ADDRESS': path,\r\n      },\r\n    });\r\n  }\r\n\r\n  // Get a list of all data (PI) servers\r\n  private getDataServers(): Promise<PiwebapiRsp[]> {\r\n    return this.restGet('/dataservers').then((response) => response.data.Items ?? []);\r\n  }\r\n  private getDataServer(name: string | undefined): Promise<PiwebapiRsp> {\r\n    if (!name) {\r\n      return Promise.resolve({});\r\n    }\r\n    return this.restGet('/dataservers?name=' + name).then((response) => response.data);\r\n  }\r\n  // Get a list of all asset (AF) servers\r\n  private getAssetServers(): Promise<PiwebapiRsp[]> {\r\n    return this.restGet('/assetservers').then((response) => response.data.Items ?? []);\r\n  }\r\n  private getAssetServer(name: string | undefined): Promise<PiwebapiRsp> {\r\n    if (!name) {\r\n      return Promise.resolve({});\r\n    }\r\n    return this.restGet('/assetservers?path=\\\\\\\\' + name).then((response) => response.data);\r\n  }\r\n  private getDatabase(path: string | undefined): Promise<PiwebapiRsp> {\r\n    if (!path) {\r\n      return Promise.resolve({});\r\n    }\r\n    return this.restGet('/assetdatabases?path=\\\\\\\\' + path).then((response) => response.data);\r\n  }\r\n  getDatabases(serverId: string, options?: any): Promise<PiwebapiRsp[]> {\r\n    if (!serverId) {\r\n      return Promise.resolve([]);\r\n    }\r\n    return this.restGet('/assetservers/' + serverId + '/assetdatabases').then((response) => response.data.Items ?? []);\r\n  }\r\n  getElement(path: string): Promise<PiwebapiRsp> {\r\n    if (!path) {\r\n      return Promise.resolve({});\r\n    }\r\n    return this.restGet('/elements?path=\\\\\\\\' + path).then((response) => response.data);\r\n  }\r\n  getEventFrameTemplates(databaseId: string): Promise<PiwebapiRsp[]> {\r\n    if (!databaseId) {\r\n      return Promise.resolve([]);\r\n    }\r\n    return this.restGet(\r\n      '/assetdatabases/' + databaseId + '/elementtemplates?selectedFields=Items.InstanceType%3BItems.Name%3BItems.WebId'\r\n    ).then((response) => {\r\n      return filter(response.data.Items ?? [], (item) => item.InstanceType === 'EventFrame');\r\n    });\r\n  }\r\n  getElementTemplates(databaseId: string): Promise<PiwebapiRsp[]> {\r\n    if (!databaseId) {\r\n      return Promise.resolve([]);\r\n    }\r\n    return this.restGet(\r\n      '/assetdatabases/' + databaseId + '/elementtemplates?selectedFields=Items.InstanceType%3BItems.Name%3BItems.WebId'\r\n    ).then((response) => {\r\n      return filter(response.data.Items ?? [], (item) => item.InstanceType === 'Element');\r\n    });\r\n  }\r\n\r\n  /**\r\n   * @description\r\n   * Get the child attributes of the current resource.\r\n   * GET attributes/{webId}/attributes\r\n   * @param {string} elementId - The ID of the parent resource. See WebID for more information.\r\n   * @param {Object} options - Query Options\r\n   * @param {string} options.nameFilter - The name query string used for finding attributes. The default is no filter. See Query String for more information.\r\n   * @param {string} options.categoryName - Specify that returned attributes must have this category. The default is no category filter.\r\n   * @param {string} options.templateName - Specify that returned attributes must be members of this template. The default is no template filter.\r\n   * @param {string} options.valueType - Specify that returned attributes' value type must be the given value type. The default is no value type filter.\r\n   * @param {string} options.searchFullHierarchy - Specifies if the search should include attributes nested further than the immediate attributes of the searchRoot. The default is 'false'.\r\n   * @param {string} options.sortField - The field or property of the object used to sort the returned collection. The default is 'Name'.\r\n   * @param {string} options.sortOrder - The order that the returned collection is sorted. The default is 'Ascending'.\r\n   * @param {string} options.startIndex - The starting index (zero based) of the items to be returned. The default is 0.\r\n   * @param {string} options.showExcluded - Specified if the search should include attributes with the Excluded property set. The default is 'false'.\r\n   * @param {string} options.showHidden - Specified if the search should include attributes with the Hidden property set. The default is 'false'.\r\n   * @param {string} options.maxCount - The maximum number of objects to be returned per call (page size). The default is 1000.\r\n   * @param {string} options.selectedFields - List of fields to be returned in the response, separated by semicolons (;). If this parameter is not specified, all available fields will be returned. See Selected Fields for more information.\r\n   */\r\n  private getAttributes(elementId: string, options: any): Promise<PiwebapiRsp[]> {\r\n    var querystring =\r\n      '?' +\r\n      map(options, (value, key) => {\r\n        return key + '=' + value;\r\n      }).join('&');\r\n\r\n    if (querystring === '?') {\r\n      querystring = '';\r\n    }\r\n\r\n    return this.restGet('/elements/' + elementId + '/attributes' + querystring).then(\r\n      (response) => response.data.Items ?? []\r\n    );\r\n  }\r\n\r\n  /**\r\n   * @description\r\n   * Retrieve elements based on the specified conditions. By default, this method selects immediate children of the current resource.\r\n   * Users can search for the elements based on specific search parameters. If no parameters are specified in the search, the default values for each parameter will be used and will return the elements that match the default search.\r\n   * GET assetdatabases/{webId}/elements\r\n   * @param {string} databaseId - The ID of the parent resource. See WebID for more information.\r\n   * @param {Object} options - Query Options\r\n   * @param {string} options.webId - The ID of the resource to use as the root of the search. See WebID for more information.\r\n   * @param {string} options.nameFilter - The name query string used for finding objects. The default is no filter. See Query String for more information.\r\n   * @param {string} options.categoryName - Specify that returned elements must have this category. The default is no category filter.\r\n   * @param {string} options.templateName - Specify that returned elements must have this template or a template derived from this template. The default is no template filter.\r\n   * @param {string} options.elementType - Specify that returned elements must have this type. The default type is 'Any'. See Element Type for more information.\r\n   * @param {string} options.searchFullHierarchy - Specifies if the search should include objects nested further than the immediate children of the searchRoot. The default is 'false'.\r\n   * @param {string} options.sortField - The field or property of the object used to sort the returned collection. The default is 'Name'.\r\n   * @param {string} options.sortOrder - The order that the returned collection is sorted. The default is 'Ascending'.\r\n   * @param {number} options.startIndex - The starting index (zero based) of the items to be returned. The default is 0.\r\n   * @param {number} options.maxCount - The maximum number of objects to be returned per call (page size). The default is 1000.\r\n   * @param {string} options.selectedFields -  List of fields to be returned in the response, separated by semicolons (;). If this parameter is not specified, all available fields will be returned. See Selected Fields for more information.\r\n   */\r\n  private getDatabaseElements(databaseId: string, options: any): Promise<PiwebapiRsp[]> {\r\n    var querystring =\r\n      '?' +\r\n      map(options, (value, key) => {\r\n        return key + '=' + value;\r\n      }).join('&');\r\n\r\n    if (querystring === '?') {\r\n      querystring = '';\r\n    }\r\n\r\n    return this.restGet('/assetdatabases/' + databaseId + '/elements' + querystring).then(\r\n      (response) => response.data.Items ?? []\r\n    );\r\n  }\r\n\r\n  /**\r\n   * @description\r\n   * Retrieve elements based on the specified conditions. By default, this method selects immediate children of the current resource.\r\n   * Users can search for the elements based on specific search parameters. If no parameters are specified in the search, the default values for each parameter will be used and will return the elements that match the default search.\r\n   * GET elements/{webId}/elements\r\n   * @param {string} databaseId - The ID of the resource to use as the root of the search. See WebID for more information.\r\n   * @param {Object} options - Query Options\r\n   * @param {string} options.webId - The ID of the resource to use as the root of the search. See WebID for more information.\r\n   * @param {string} options.nameFilter - The name query string used for finding objects. The default is no filter. See Query String for more information.\r\n   * @param {string} options.categoryName - Specify that returned elements must have this category. The default is no category filter.\r\n   * @param {string} options.templateName - Specify that returned elements must have this template or a template derived from this template. The default is no template filter.\r\n   * @param {string} options.elementType - Specify that returned elements must have this type. The default type is 'Any'. See Element Type for more information.\r\n   * @param {string} options.searchFullHierarchy - Specifies if the search should include objects nested further than the immediate children of the searchRoot. The default is 'false'.\r\n   * @param {string} options.sortField - The field or property of the object used to sort the returned collection. The default is 'Name'.\r\n   * @param {string} options.sortOrder - The order that the returned collection is sorted. The default is 'Ascending'.\r\n   * @param {number} options.startIndex - The starting index (zero based) of the items to be returned. The default is 0.\r\n   * @param {number} options.maxCount - The maximum number of objects to be returned per call (page size). The default is 1000.\r\n   * @param {string} options.selectedFields -  List of fields to be returned in the response, separated by semicolons (;). If this parameter is not specified, all available fields will be returned. See Selected Fields for more information.\r\n   */\r\n  private getElements(elementId: string, options: any): Promise<PiwebapiRsp[]> {\r\n    var querystring =\r\n      '?' +\r\n      map(options, (value, key) => {\r\n        return key + '=' + value;\r\n      }).join('&');\r\n\r\n    if (querystring === '?') {\r\n      querystring = '';\r\n    }\r\n\r\n    return this.restGet('/elements/' + elementId + '/elements' + querystring).then(\r\n      (response) => response.data.Items ?? []\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Retrieve a list of points on a specified Data Server.\r\n   *\r\n   * @param {string} serverId - The ID of the server. See WebID for more information.\r\n   * @param {string} nameFilter - A query string for filtering by point name. The default is no filter. *, ?, [ab], [!ab]\r\n   */\r\n  private piPointSearch(serverId: string, nameFilter: string): Promise<PiwebapiRsp[]> {\r\n    let filter1 = this.templateSrv.replace(nameFilter);\r\n    let filter2 = `${filter1}`;\r\n    let doFilter = false;\r\n    if (filter1 !== nameFilter) {\r\n      const regex = /\\{(\\w|,)+\\}/gs;\r\n      let m;\r\n      while ((m = regex.exec(filter1)) !== null) {\r\n        // This is necessary to avoid infinite loops with zero-width matches\r\n        if (m.index === regex.lastIndex) {\r\n          regex.lastIndex++;\r\n        }\r\n\r\n        // The result can be accessed through the `m`-variable.\r\n        m.forEach((match, groupIndex) => {\r\n          if (groupIndex === 0) {\r\n            filter1 = filter1.replace(match, match.replace('{', '(').replace('}', ')').replace(',', '|'));\r\n            filter2 = filter2.replace(match, '*');\r\n            doFilter = true;\r\n          }\r\n        });\r\n      }\r\n    }\r\n    return this.restGet('/dataservers/' + serverId + '/points?maxCount=20&nameFilter=' + filter2).then((results) => {\r\n      if (!!results && !!results.data?.Items) {\r\n        return doFilter ? results.data.Items.filter((item) => item.Name?.match(filter1)) : results.data.Items;\r\n      }\r\n      return [];\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Get the PI Web API webid or PI Point.\r\n   *\r\n   * @param {any} target - AF Path or Point name.\r\n   * @returns - webid.\r\n   *\r\n   * @memberOf PiWebApiDatasource\r\n   */\r\n  getWebId(target: any) {\r\n    var ds = this;\r\n    var isAf = target.target.indexOf('\\\\') >= 0;\r\n    var isAttribute = target.target.indexOf('|') >= 0;\r\n    if (!isAf && target.target.indexOf('.') === -1) {\r\n      return Promise.resolve([{ WebId: target.target, Name: target.display || target.target }]);\r\n    }\r\n\r\n    if (!isAf) {\r\n      // pi point lookup\r\n      return ds.piPointSearch(this.piserver.webid!, target.target).then((results) => {\r\n        if (results === undefined || results.length === 0) {\r\n          return [{ WebId: target.target, Name: target.display || target.target }];\r\n        }\r\n        return results;\r\n      });\r\n    } else if (isAf && isAttribute) {\r\n      // af attribute lookup\r\n      return ds.restGet('/attributes?path=\\\\\\\\' + target.target).then((results) => {\r\n        if (results.data === undefined || results.status !== 200) {\r\n          return [{ WebId: target.target, Name: target.display || target.target }];\r\n        }\r\n        // rewrite name if specified\r\n        results.data.Name = target.display || results.data.Name;\r\n        return [results.data];\r\n      });\r\n    } else {\r\n      // af element lookup\r\n      return ds.restGet('/elements?path=\\\\\\\\' + target.target).then((results) => {\r\n        if (results.data === undefined || results.status !== 200) {\r\n          return [{ WebId: target.target, Name: target.display || target.target }];\r\n        }\r\n        // rewrite name if specified\r\n        results.data.Name = target.display || results.data.Name;\r\n        return [results.data];\r\n      });\r\n    }\r\n  }\r\n}\r\n","import { DataSourcePlugin } from '@grafana/data';\r\nimport { AnnotationsQueryCtrl } from './AnnotationsQueryCtrl';\r\nimport { PIWebAPIConfigEditor } from './ConfigEditor';\r\nimport { PIWebAPIQueryEditor } from './QueryEditor';\r\nimport { PiWebAPIDatasource } from './datasource';\r\nimport { PIWebAPIQuery, PIWebAPIDataSourceJsonData } from './types';\r\n\r\nexport const plugin = new DataSourcePlugin<PiWebAPIDatasource, PIWebAPIQuery, PIWebAPIDataSourceJsonData>(\r\n  PiWebAPIDatasource\r\n)\r\n  .setConfigEditor(PIWebAPIConfigEditor)\r\n  .setQueryEditor(PIWebAPIQueryEditor)\r\n  .setAnnotationQueryCtrl(AnnotationsQueryCtrl);\r\n"],"sourceRoot":""}