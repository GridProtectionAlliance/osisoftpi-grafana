{"version":3,"file":"module.js","mappings":"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","sources":["webpack:///external amd \"react\"","webpack:///external amd \"@grafana/ui\"","webpack:///external amd \"@grafana/data\"","webpack:///external amd \"lodash\"","webpack:///external amd \"@grafana/runtime\"","webpack:///webpack/bootstrap","webpack:///webpack/runtime/compat get default export","webpack:///webpack/runtime/define property getters","webpack:///webpack/runtime/hasOwnProperty shorthand","webpack:///webpack/runtime/make namespace object","webpack:///./AnnotationsQueryCtrl.ts","webpack:///./ConfigEditor.tsx","webpack:///./components/Forms.tsx","webpack:///./types.ts","webpack:///./components/QueryEditorModeSwitcher.tsx","webpack:///./QueryEditor.tsx","webpack:///./datasource.ts","webpack:///./module.ts"],"sourcesContent":["module.exports = __WEBPACK_EXTERNAL_MODULE__0__;","module.exports = __WEBPACK_EXTERNAL_MODULE__1__;","module.exports = __WEBPACK_EXTERNAL_MODULE__2__;","module.exports = __WEBPACK_EXTERNAL_MODULE__3__;","module.exports = __WEBPACK_EXTERNAL_MODULE__5__;","// The module cache\nvar __webpack_module_cache__ = {};\n\n// The require function\nfunction __webpack_require__(moduleId) {\n\t// Check if module is in cache\n\tvar cachedModule = __webpack_module_cache__[moduleId];\n\tif (cachedModule !== undefined) {\n\t\treturn cachedModule.exports;\n\t}\n\t// Create a new module (and put it into the cache)\n\tvar module = __webpack_module_cache__[moduleId] = {\n\t\t// no module.id needed\n\t\t// no module.loaded needed\n\t\texports: {}\n\t};\n\n\t// Execute the module function\n\t__webpack_modules__[moduleId](module, module.exports, __webpack_require__);\n\n\t// Return the exports of the module\n\treturn module.exports;\n}\n\n","// getDefaultExport function for compatibility with non-harmony modules\n__webpack_require__.n = (module) => {\n\tvar getter = module && module.__esModule ?\n\t\t() => (module['default']) :\n\t\t() => (module);\n\t__webpack_require__.d(getter, { a: getter });\n\treturn getter;\n};","// define getter functions for harmony exports\n__webpack_require__.d = (exports, definition) => {\n\tfor(var key in definition) {\n\t\tif(__webpack_require__.o(definition, key) && !__webpack_require__.o(exports, key)) {\n\t\t\tObject.defineProperty(exports, key, { enumerable: true, get: definition[key] });\n\t\t}\n\t}\n};","__webpack_require__.o = (obj, prop) => (Object.prototype.hasOwnProperty.call(obj, prop))","// define __esModule on exports\n__webpack_require__.r = (exports) => {\n\tif(typeof Symbol !== 'undefined' && Symbol.toStringTag) {\n\t\tObject.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });\n\t}\n\tObject.defineProperty(exports, '__esModule', { value: true });\n};","export class AnnotationsQueryCtrl {\n  static templateUrl = 'partials/annotations.editor.html';\n\n  $scope: any;\n  annotation: any;\n  datasource: any;\n\n  /** @ngInject */\n  constructor($scope: any) {\n    this.$scope = $scope;\n    this.annotation = $scope.ctrl.annotation;\n    this.datasource = $scope.ctrl.datasource;\n\n    // load defaults\n    this.annotation.query = this.annotation.query || {};\n    this.annotation.databases = this.annotation.databases || [];\n    this.annotation.templates = this.annotation.templates || [];\n    this.annotation.regex = this.annotation.regex || {};\n    this.annotation.attribute = this.annotation.attribute || {};\n    this.annotation.showEndTime = this.annotation.showEndTime || false;\n\n    this.datasource.getAssetServer(this.datasource.afserver.name).then((result: any) => {\n      return this.getDatabases(result.WebId);\n    });\n  }\n  templateChanged() {\n    // do nothing\n  }\n  databaseChanged() {\n    this.annotation.templates = [];\n    this.getEventFrames();\n  }\n  getDatabases(webid: string) {\n    const ctrl = this;\n    ctrl.datasource.getDatabases(webid).then((dbs: any) => {\n      ctrl.annotation.databases = dbs;\n      this.$scope.$apply();\n    });\n  }\n  getEventFrames() {\n    const ctrl = this;\n    ctrl.datasource.getEventFrameTemplates(this.annotation.database.WebId).then((templates: any) => {\n      ctrl.annotation.templates = templates;\n      this.$scope.$apply();\n    });\n  }\n}\n","import React, { ChangeEvent, PureComponent } from 'react';\nimport { LegacyForms, DataSourceHttpSettings, InlineField, InlineSwitch } from '@grafana/ui';\nimport { DataSourcePluginOptionsEditorProps, DataSourceJsonData, DataSourceSettings } from '@grafana/data';\nimport { PIWebAPIDataSourceJsonData } from './types';\n\nconst { FormField } = LegacyForms;\n\ninterface Props extends DataSourcePluginOptionsEditorProps<PIWebAPIDataSourceJsonData, {}> {}\n\nconst coerceOptions = (\n  options: DataSourceSettings<PIWebAPIDataSourceJsonData, {}>\n): DataSourceSettings<PIWebAPIDataSourceJsonData, {}> => {\n  return {\n    ...options,\n    jsonData: {\n      ...options.jsonData,\n      url: options.url,\n    },\n  };\n};\n\ninterface State {}\n\nexport class PIWebAPIConfigEditor extends PureComponent<Props, State> {\n  onPIServerChange = (event: ChangeEvent<HTMLInputElement>) => {\n    const { onOptionsChange, options } = this.props;\n    const jsonData = {\n      ...options.jsonData,\n      piserver: event.target.value,\n    };\n    onOptionsChange({ ...options, jsonData });\n  };\n\n  onAFServerChange = (event: ChangeEvent<HTMLInputElement>) => {\n    const { onOptionsChange, options } = this.props;\n    const jsonData = {\n      ...options.jsonData,\n      afserver: event.target.value,\n    };\n    onOptionsChange({ ...options, jsonData });\n  };\n\n  onAFDatabaseChange = (event: ChangeEvent<HTMLInputElement>) => {\n    const { onOptionsChange, options } = this.props;\n    const jsonData = {\n      ...options.jsonData,\n      afdatabase: event.target.value,\n    };\n    onOptionsChange({ ...options, jsonData });\n  };\n\n  onMyOptionsChange = (options: DataSourceSettings<DataSourceJsonData, {}>) => {\n    const { onOptionsChange } = this.props;\n    onOptionsChange(coerceOptions(options));\n  };\n\n  onPiPointChange = (event: ChangeEvent<HTMLInputElement>) => {\n    const { onOptionsChange, options } = this.props;\n    const jsonData = {\n      ...options.jsonData,\n      piserver: event.target.checked ? options.jsonData.piserver : '',\n      pipoint: event.target.checked,\n    };\n    onOptionsChange({ ...options, jsonData });\n  };\n\n  render() {\n    const { options: originalOptions } = this.props;\n    const options = coerceOptions(originalOptions);\n\n    return (\n      <div>\n        <DataSourceHttpSettings\n          defaultUrl=\"https://server.name/piwebapi\"\n          dataSourceConfig={options}\n          onChange={this.onMyOptionsChange}\n          showAccessOptions\n        />\n\n        <h3 className=\"page-heading\">PI Point</h3>\n\n        <div className=\"gf-form-group\">\n          <div className=\"gf-form-inline\">\n            <InlineField label=\"Show PI Point in Query\" labelWidth={24}>\n              <InlineSwitch value={options.jsonData.pipoint} onChange={this.onPiPointChange} />\n            </InlineField>\n          </div>\n        </div>\n\n        <h3 className=\"page-heading\">PI/AF Connection Details</h3>\n\n        <div className=\"gf-form-group\">\n          {options.jsonData.pipoint && (\n            <div className=\"gf-form\">\n              <FormField\n                label=\"PI Server\"\n                labelWidth={10}\n                inputWidth={25}\n                onChange={this.onPIServerChange}\n                value={options.jsonData.piserver || ''}\n                placeholder=\"Default PI Server to use for data requests\"\n              />\n            </div>\n          )}\n          <div className=\"gf-form\">\n            <FormField\n              label=\"AF Server\"\n              labelWidth={10}\n              inputWidth={25}\n              onChange={this.onAFServerChange}\n              value={options.jsonData.afserver || ''}\n              placeholder=\"Default AF Server to use for data requests\"\n            />\n          </div>\n          <div className=\"gf-form\">\n            <FormField\n              label=\"AF Database\"\n              labelWidth={10}\n              inputWidth={25}\n              onChange={this.onAFDatabaseChange}\n              value={options.jsonData.afdatabase || ''}\n              placeholder=\"Default AF Database server for AF queries\"\n            />\n          </div>\n        </div>\n      </div>\n    );\n  }\n}\n","import React, { InputHTMLAttributes, FunctionComponent } from 'react';\nimport { InlineFormLabel } from '@grafana/ui';\n\nexport interface Props extends InputHTMLAttributes<HTMLInputElement> {\n  label: string;\n  tooltip?: string;\n  labelWidth?: number;\n  children?: React.ReactNode;\n  queryEditor?: JSX.Element;\n}\n\nexport const QueryField: FunctionComponent<Partial<Props>> = ({ label, labelWidth = 12, tooltip, children }) => (\n  <>\n    <InlineFormLabel width={labelWidth} tooltip={tooltip}>\n      {label}\n    </InlineFormLabel>\n    {children}\n  </>\n);\n\nexport const QueryRowTerminator = () => {\n  return (\n    <div className=\"gf-form gf-form--grow\">\n      <div className=\"gf-form-label gf-form-label--grow\" />\n    </div>\n  );\n};\n\nexport const QueryInlineField = ({ ...props }) => {\n  return (\n    <QueryEditorRow>\n      <QueryField {...props} />\n    </QueryEditorRow>\n  );\n};\n\nexport const QueryEditorRow = (props: Partial<Props>) => {\n  return (\n    <div className=\"gf-form-inline\">\n      {props.children}\n      <QueryRowTerminator />\n    </div>\n  );\n};\n\nexport const QueryRawInlineField = ({ ...props }) => {\n  return (\n    <QueryRawEditorRow>\n      <QueryField {...props} />\n    </QueryRawEditorRow>\n  );\n};\n\nexport const QueryRawEditorRow = (props: Partial<Props>) => {\n  return <>{props.children}</>;\n};\n","import { DataQuery, DataSourceJsonData } from '@grafana/data';\n\nexport interface PIWebAPISelectableValue {\n  webId?: string;\n  value?: string;\n  type?: string;\n  expandable?: boolean;\n}\n\nexport interface PIWebAPIAnnotationsQuery extends DataQuery {\n  target: string;\n}\n\nexport interface PIWebAPIQuery extends DataQuery {\n  target: string;\n  elementPath: string;\n  attributes: any[];\n  segments: any[];\n  display: any;\n  interpolate: any;\n  recordedValues: any;\n  digitalStates: any;\n  webid: string;\n  webids: string[];\n  regex: any;\n  summary: any;\n  expression: string;\n  isPiPoint: boolean;\n  rawQuery?: boolean;\n  query?: string;\n}\n\nexport const defaultQuery: Partial<PIWebAPIQuery> = {\n  target: ';',\n  attributes: [],\n  segments: [],\n  regex: { enable: false },\n  summary: { types: [], basis: 'EventWeighted', interval: '', nodata: 'Null' },\n  expression: '',\n  interpolate: { enable: false },\n  recordedValues: { enable: false },\n  digitalStates: { enable: false },\n  isPiPoint: false,\n};\n\n/**\n * These are options configured for each DataSource instance\n */\nexport interface PIWebAPIDataSourceJsonData extends DataSourceJsonData {\n  url?: string;\n  access?: string;\n  piserver?: string;\n  afserver?: string;\n  afdatabase?: string;\n  pipoint?: boolean;\n}\n\n/**\n * Value that is used in the backend, but never sent over HTTP to the frontend\n */\nexport interface PIWebAPISecureJsonData {\n  apiKey?: string;\n}\n","import React, { useEffect, useState } from 'react';\nimport { Button, ConfirmModal } from '@grafana/ui';\n\ntype Props = {\n  isRaw: boolean;\n  onChange: (newIsRaw: boolean) => void;\n};\n\nexport const QueryEditorModeSwitcher = ({ isRaw, onChange }: Props): JSX.Element => {\n  const [isModalOpen, setModalOpen] = useState(false);\n\n  useEffect(() => {\n    // if the isRaw changes, we hide the modal\n    setModalOpen(false);\n  }, [isRaw]);\n\n  if (isRaw) {\n    return (\n      <>\n        <Button\n          aria-label=\"Switch to visual editor\"\n          icon=\"pen\"\n          variant=\"secondary\"\n          type=\"button\"\n          onClick={() => {\n            // we show the are-you-sure modal\n            setModalOpen(true);\n          }}\n        ></Button>\n        <ConfirmModal\n          isOpen={isModalOpen}\n          title=\"Switch to visual editor mode\"\n          body=\"Are you sure to switch to visual editor mode? You will lose the changes done in raw query mode.\"\n          confirmText=\"Yes, switch to editor mode\"\n          dismissText=\"No, stay in raw query mode\"\n          onConfirm={() => {\n            onChange(false);\n          }}\n          onDismiss={() => {\n            setModalOpen(false);\n          }}\n        />\n      </>\n    );\n  } else {\n    return (\n      <Button\n        aria-label=\"Switch to text editor\"\n        icon=\"pen\"\n        variant=\"secondary\"\n        type=\"button\"\n        onClick={() => {\n          onChange(true);\n        }}\n      ></Button>\n    );\n  }\n};\n","import { each, filter, forOwn, join, reduce, map, slice, remove, defaults } from 'lodash';\n\nimport React, { PureComponent, ChangeEvent } from 'react';\nimport { Icon, InlineField, InlineFieldRow, InlineSwitch, Input, SegmentAsync, Segment } from '@grafana/ui';\nimport { QueryEditorProps, SelectableValue, VariableModel } from '@grafana/data';\n\nimport { PiWebAPIDatasource } from './datasource';\nimport { QueryInlineField, QueryRawInlineField, QueryRowTerminator } from './components/Forms';\nimport { PIWebAPISelectableValue, PIWebAPIDataSourceJsonData, PIWebAPIQuery, defaultQuery } from './types';\nimport { QueryEditorModeSwitcher } from 'components/QueryEditorModeSwitcher';\n\nconst LABEL_WIDTH = 24;\nconst MIN_ELEM_INPUT_WIDTH = 200;\nconst MIN_ATTR_INPUT_WIDTH = 250;\n\ninterface State {\n  isPiPoint: boolean;\n  segments: Array<SelectableValue<PIWebAPISelectableValue>>;\n  attributes: Array<SelectableValue<PIWebAPISelectableValue>>;\n  summaries: Array<SelectableValue<PIWebAPISelectableValue>>;\n  attributeSegment: SelectableValue<PIWebAPISelectableValue>;\n  summarySegment: SelectableValue<PIWebAPISelectableValue>;\n  calculationBasisSegment: SelectableValue<PIWebAPISelectableValue>;\n  noDataReplacementSegment: SelectableValue<PIWebAPISelectableValue>;\n}\n\ntype Props = QueryEditorProps<PiWebAPIDatasource, PIWebAPIQuery, PIWebAPIDataSourceJsonData>;\n\nconst REMOVE_LABEL = '-REMOVE-';\n\nconst CustomLabelComponent = (props: any) => {\n  if (props.value) {\n    return (\n      <div className={`gf-form-label ${props.value.type === 'template' ? 'query-keyword' : ''}`}>\n        {props.label ?? '--no label--'}\n      </div>\n    );\n  }\n  return (\n    <a className=\"gf-form-label query-part\">\n      <Icon name=\"plus\" />\n    </a>\n  );\n};\n\nexport class PIWebAPIQueryEditor extends PureComponent<Props, State> {\n  error: any;\n  piServer: any[] = [];\n  availableAttributes: any = {};\n  summaryTypes: string[];\n  calculationBasis: string[];\n  noDataReplacement: string[];\n  state: State = {\n    isPiPoint: false,\n    segments: [],\n    attributes: [],\n    summaries: [],\n    attributeSegment: {},\n    summarySegment: {},\n    calculationBasisSegment: {},\n    noDataReplacementSegment: {},\n  };\n\n  constructor(props: any) {\n    super(props);\n    this.onSegmentChange = this.onSegmentChange.bind(this);\n    this.calcBasisValueChanged = this.calcBasisValueChanged.bind(this);\n    this.calcNoDataValueChanged = this.calcNoDataValueChanged.bind(this);\n    this.onSummaryAction = this.onSummaryAction.bind(this);\n    this.onSummaryValueChanged = this.onSummaryValueChanged.bind(this);\n    this.onAttributeAction = this.onAttributeAction.bind(this);\n    this.onAttributeChange = this.onAttributeChange.bind(this);\n\n    this.summaryTypes = [\n      // 'None', // A summary type is not specified.\n      'Total', // A totalization over the time range.\n      'Average', // The average value over the time range.\n      'Minimum', // The minimum value over the time range.\n      'Maximum', // The maximum value over the time range.\n      'Range', // The range value over the time range (minimum-maximum).\n      'StdDev', // The standard deviation over the time range.\n      'PopulationStdDev', // The population standard deviation over the time range.\n      'Count', // The sum of event count over the time range when calculation basis is event weighted. The sum of event time duration over the time range when calculation basis is time weighted.\n      'PercentGood', // Percent of data with good value during the calculation period. For time weighted calculations, the percentage is based on time. For event weighted calculations, the percent is based on event count.\n      'All', // A convenience for requesting all available summary calculations.\n      'AllForNonNumeric', // A convenience for requesting all available summary calculations for non-numeric data.\n    ];\n\n    this.calculationBasis = [\n      'TimeWeighted', // Weight the values in the calculation by the time over which they apply. Interpolation is based on whether the attribute is stepped. Interpolated events are generated at the boundaries if necessary.\n      'EventWeighted', // Evaluate values with equal weighting for each event. No interpolation is done. There must be at least one event within the time range to perform a successful calculation. Two events are required for standard deviation. In handling events at the boundary of the calculation, the AFSDK uses following rules:\n      'TimeWeightedContinuous', // Apply weighting as in TimeWeighted, but do all interpolation between values as if they represent continuous data, (standard interpolation) regardless of whether the attribute is stepped.\n      'TimeWeightedDiscrete', // Apply weighting as in TimeWeighted but interpolation between values is performed as if they represent discrete, unrelated values (stair step plot) regardless of the attribute is stepped.\n      'EventWeightedExcludeMostRecentEvent', // The calculation behaves the same as _EventWeighted_, except in the handling of events at the boundary of summary intervals in a multiple intervals calculation. Use this option to prevent events at the intervals boundary from being double count at both intervals. With this option, events at the end time (most recent time) of an interval is not used in that interval.\n      'EventWeightedExcludeEarliestEvent', // Similar to the option _EventWeightedExcludeMostRecentEvent_. Events at the start time(earliest time) of an interval is not used in that interval.\n      'EventWeightedIncludeBothEnds', // Events at both ends of the interval boundaries are included in the event weighted calculation.\n    ];\n\n    this.noDataReplacement = [\n      'Null', // replace with nulls\n      'Drop', // drop items\n      'Previous', // use previous value if available\n      '0', // replace with 0\n      'Keep', // Keep value\n    ];\n  }\n\n  // is selected segment empty\n  isValueEmpty(value: PIWebAPISelectableValue | undefined) {\n    return !value || !value.value || !value.value.length || value.value === REMOVE_LABEL;\n  }\n\n  segmentChangeValue = (segments: Array<SelectableValue<PIWebAPISelectableValue>>) => {\n    const query = this.props.query;\n    this.setState({ segments }, () => this.onChange({ ...query, segments }));\n  };\n\n  attributeChangeValue = (attributes: Array<SelectableValue<PIWebAPISelectableValue>>) => {\n    const query = this.props.query;\n    this.setState({ attributes }, () => this.onChange({ ...query, attributes }));\n  };\n\n  // summary calculation basis change event\n  calcBasisValueChanged(segment: SelectableValue<PIWebAPISelectableValue>) {\n    const metricsQuery = this.props.query as PIWebAPIQuery;\n    const summary = metricsQuery.summary;\n    summary.basis = segment.value?.value;\n    this.onChange({ ...metricsQuery, summary });\n  }\n  // get summary calculation basis user interface segments\n  getCalcBasisSegments() {\n    const segments = map(this.calculationBasis, (item: string) => {\n      let selectableValue: SelectableValue<PIWebAPISelectableValue> = {\n        label: item,\n        value: {\n          value: item,\n          expandable: true,\n        },\n      };\n      return selectableValue;\n    });\n    return segments;\n  }\n\n  // no data change event\n  calcNoDataValueChanged(segment: SelectableValue<PIWebAPISelectableValue>) {\n    const metricsQuery = this.props.query as PIWebAPIQuery;\n    const summary = metricsQuery.summary;\n    summary.nodata = segment.value?.value;\n    this.onChange({ ...metricsQuery, summary });\n  }\n  // get no data user interface segments\n  getNoDataSegments() {\n    const segments = map(this.noDataReplacement, (item: string) => {\n      let selectableValue: SelectableValue<PIWebAPISelectableValue> = {\n        label: item,\n        value: {\n          value: item,\n          expandable: true,\n        },\n      };\n      return selectableValue;\n    });\n    return segments;\n  }\n\n  // summary query change event\n  onSummaryValueChanged(item: SelectableValue<PIWebAPISelectableValue>, index: number) {\n    const summaries = this.state.summaries.slice(0) as Array<SelectableValue<PIWebAPISelectableValue>>;\n    summaries[index] = item;\n    if (this.isValueEmpty(item.value)) {\n      summaries.splice(index, 1);\n    }\n    this.setState({ summaries }, this.stateCallback);\n  }\n  // get the list of summaries available\n  getSummarySegments() {\n    const ctrl = this;\n    const summaryTypes = filter(ctrl.summaryTypes, (type) => {\n      return this.state.summaries.map((s) => s.value?.value).indexOf(type) === -1;\n    });\n    const segments = map(summaryTypes, (item: string) => {\n      let selectableValue: SelectableValue<PIWebAPISelectableValue> = {\n        label: item,\n        value: {\n          value: item,\n          expandable: true,\n        },\n      };\n      return selectableValue;\n    });\n\n    segments.unshift({\n      label: REMOVE_LABEL,\n      value: {\n        value: REMOVE_LABEL,\n      },\n    });\n\n    return segments;\n  }\n\n  // remove a summary from the user interface and the query\n  removeSummary(part: SelectableValue<PIWebAPISelectableValue>) {\n    const summaries = filter(this.state.summaries, (item: SelectableValue<PIWebAPISelectableValue>) => {\n      return item !== part;\n    });\n    this.setState({ summaries });\n  }\n  // add a new summary to the query\n  onSummaryAction(item: SelectableValue<PIWebAPISelectableValue>) {\n    const summaries = this.state.summaries.slice(0) as Array<SelectableValue<PIWebAPISelectableValue>>;\n    // if value is not empty, add new attribute segment\n    if (!this.isValueEmpty(item.value)) {\n      let selectableValue: SelectableValue<PIWebAPISelectableValue> = {\n        label: item.label,\n        value: {\n          value: item.value?.value,\n          expandable: true,\n        },\n      };\n      summaries.push(selectableValue);\n    }\n    this.setState({ summarySegment: {}, summaries }, this.stateCallback);\n  }\n\n  // remove an attribute from the query\n  removeAttribute(part: SelectableValue<PIWebAPISelectableValue>) {\n    const attributes = filter(this.state.attributes, (item: SelectableValue<PIWebAPISelectableValue>) => {\n      return item !== part;\n    });\n    this.attributeChangeValue(attributes);\n  }\n  // add an attribute to the query\n  onAttributeAction(item: SelectableValue<PIWebAPISelectableValue>) {\n    const { query } = this.props;\n    const attributes = this.state.attributes.slice(0);\n    // if value is not empty, add new attribute segment\n    if (!this.isValueEmpty(item.value)) {\n      let selectableValue: SelectableValue<PIWebAPISelectableValue> = {\n        label: item.label,\n        value: {\n          value: item.value?.value,\n          expandable: !query.isPiPoint,\n        },\n      };\n      attributes.push(selectableValue);\n    }\n    this.attributeChangeValue(attributes);\n  }\n\n  // pi point change event\n  onPiPointChange = (item: SelectableValue<PIWebAPISelectableValue>, index: number) => {\n    let attributes = this.state.attributes.slice(0);\n\n    if (item.label === REMOVE_LABEL) {\n      remove(attributes, (value, n) => n === index);\n    } else {\n      // set current value\n      attributes[index] = item;\n    }\n\n    this.checkPiPointSegments(item, attributes);\n  };\n  // attribute change event\n  onAttributeChange = (item: SelectableValue<PIWebAPISelectableValue>, index: number) => {\n    let attributes = this.state.attributes.slice(0);\n\n    // set current value\n    attributes[index] = item;\n\n    this.checkAttributeSegments(attributes, this.state.segments);\n  };\n  // segment change\n  onSegmentChange = (item: SelectableValue<PIWebAPISelectableValue>, index: number) => {\n    const { query } = this.props;\n    let segments = this.state.segments.slice(0);\n\n    if (item.label === REMOVE_LABEL) {\n      segments = slice(segments, 0, index);\n      this.checkAttributeSegments([], segments);\n      if (segments.length === 0) {\n        segments.push({\n          label: '',\n        });\n      } else if (!!segments[segments.length - 1].value?.expandable) {\n        segments.push({\n          label: 'Select Element',\n          value: {\n            value: '-Select Element-',\n          },\n        });\n      }\n      if (query.isPiPoint) {\n        this.piServer = [];\n      }\n      this.segmentChangeValue(segments);\n      return;\n    }\n\n    // set current value\n    segments[index] = item;\n\n    // Accept only one PI server\n    if (query.isPiPoint) {\n      this.piServer.push(item);\n      this.segmentChangeValue(segments);\n      return;\n    }\n\n    // changed internal selection\n    if (index < segments.length - 1) {\n      segments = slice(segments, 0, index + 1);\n    }\n    this.checkAttributeSegments([], segments);\n    // add new options\n    if (!!item.value?.expandable) {\n      segments.push({\n        label: 'Select Element',\n        value: {\n          value: '-Select Element-',\n        },\n      });\n    }\n    this.segmentChangeValue(segments);\n  };\n\n  // get a ui segment for the attributes\n  getElementSegments = (\n    index: number,\n    currentSegment?: Array<SelectableValue<PIWebAPISelectableValue>>\n  ): Promise<Array<SelectableValue<PIWebAPISelectableValue>>> => {\n    const { datasource, query, data } = this.props;\n    const ctrl = this;\n    const findQuery = query.isPiPoint\n      ? { type: 'dataserver' }\n      : { path: this.getSegmentPathUpTo(currentSegment ?? this.state.segments.slice(0), index) };\n\n    if (!query.isPiPoint) {\n      if (datasource.afserver?.name && index === 0) {\n        return Promise.resolve([\n          {\n            label: datasource.afserver.name,\n            value: {\n              value: datasource.afserver.name,\n              expandable: true,\n            },\n          },\n        ]);\n      }\n      if (datasource.afserver?.name && datasource.afdatabase?.name && index === 1) {\n        return Promise.resolve([\n          {\n            label: datasource.afdatabase.name,\n            value: {\n              value: datasource.afdatabase.name,\n              expandable: true,\n            },\n          },\n        ]);\n      }\n\n      // if (!findQuery.path?.length) {\n      //   return Promise.resolve([]);\n      // }\n    }\n    return datasource\n      .metricFindQuery(findQuery, Object.assign(data?.request?.scopedVars ?? {}, { isPiPoint: query.isPiPoint }))\n      .then((items: any[]) => {\n        const altSegments = map(items, (item: any) => {\n          let selectableValue: SelectableValue<PIWebAPISelectableValue> = {\n            label: item.text,\n            value: {\n              webId: item.WebId,\n              value: item.text,\n              expandable: !query.isPiPoint && item.expandable,\n            },\n          };\n          return selectableValue;\n        });\n\n        if (altSegments.length === 0) {\n          return altSegments;\n        }\n\n        // add template variables\n        const variables = datasource.templateSrv.getVariables();\n        each(variables, (variable: VariableModel) => {\n          let selectableValue: SelectableValue<PIWebAPISelectableValue> = {\n            label: '${' + variable.name + '}',\n            value: {\n              type: 'template',\n              value: '${' + variable.name + '}',\n              expandable: !query.isPiPoint,\n            },\n          };\n          altSegments.unshift(selectableValue);\n        });\n\n        altSegments.unshift({\n          label: REMOVE_LABEL,\n          value: {\n            value: REMOVE_LABEL,\n          },\n        });\n\n        return altSegments;\n      })\n      .catch((err: any) => {\n        ctrl.error = err.message || 'Failed to issue metric query';\n        return [];\n      });\n  };\n\n  // get the list of attributes for the user interface - PI\n  getAttributeSegmentsPI = (attributeText?: string): Promise<Array<SelectableValue<PIWebAPISelectableValue>>> => {\n    const { datasource, query, data } = this.props;\n    const ctrl = this;\n    const findQuery = {\n      path: '',\n      webId: this.getSelectedPIServer(),\n      pointName: (attributeText ?? '') + '*',\n      type: 'pipoint',\n    };\n    let segments: Array<SelectableValue<PIWebAPISelectableValue>> = [];\n    return datasource\n      .metricFindQuery(findQuery, Object.assign(data?.request?.scopedVars ?? {}, { isPiPoint: query.isPiPoint }))\n      .then((items: any[]) => {\n        segments = map(items, (item: any) => {\n          let selectableValue: SelectableValue<PIWebAPISelectableValue> = {\n            path: item.Path,\n            label: item.text,\n            value: {\n              value: item.text,\n              expandable: false,\n            },\n          };\n          return selectableValue;\n        });\n        if (!!attributeText && attributeText.length > 0) {\n            segments.unshift({\n            label: attributeText,\n            value: {\n              value: attributeText,\n              expandable: false,\n            },\n          });\n        }\n        // add template variables\n        const variables = datasource.templateSrv.getVariables();\n        each(variables, (variable: VariableModel) => {\n          let selectableValue: SelectableValue<PIWebAPISelectableValue> = {\n            label: '${' + variable.name + '}',\n            value: {\n              type: 'template',\n              value: '${' + variable.name + '}',\n              expandable: !query.isPiPoint,\n            },\n          };\n          segments.unshift(selectableValue);\n        });\n        segments.unshift({\n          label: REMOVE_LABEL,\n          value: {\n            value: REMOVE_LABEL,\n          },\n        });\n        return segments;\n      })\n      .catch((err: any) => {\n        ctrl.error = err.message || 'Failed to issue metric query';\n        return segments;\n      });\n  };\n\n  // get the list of attributes for the user interface - AF\n  getAttributeSegmentsAF = (attributeText?: string): Array<SelectableValue<PIWebAPISelectableValue>> => {\n    const ctrl = this;\n    let segments: Array<SelectableValue<PIWebAPISelectableValue>> = [];\n\n    forOwn(ctrl.availableAttributes, (val: any, key: string) => {\n      let selectableValue: SelectableValue<PIWebAPISelectableValue> = {\n        label: key,\n        value: {\n          value: key,\n          expandable: true,\n        },\n      };\n      segments.push(selectableValue);\n    });\n\n    segments.unshift({\n      label: REMOVE_LABEL,\n      value: {\n        value: REMOVE_LABEL,\n      },\n    });\n\n    return segments;\n  };\n\n  // build data from target string\n  buildFromTarget = (\n    query: PIWebAPIQuery,\n    segmentsArray: Array<SelectableValue<PIWebAPISelectableValue>>,\n    attributesArray: Array<SelectableValue<PIWebAPISelectableValue>>\n  ) => {\n    const splitAttributes = query.target.split(';');\n    const splitElements = splitAttributes.length > 0 ? splitAttributes[0].split('\\\\') : [];\n\n    if (splitElements.length > 1 || (splitElements.length === 1 && splitElements[0] !== '')) {\n      // remove element hierarchy from attribute collection\n      splitAttributes.splice(0, 1);\n\n      each(splitElements, (item, _) => {\n        segmentsArray.push({\n          label: item,\n          value: {\n            value: item,\n            expandable: true,\n          },\n        });\n      });\n      each(splitAttributes, (item, _) => {\n        if (item !== '') {\n          // set current value\n          attributesArray.push({\n            label: item,\n            value: {\n              value: item,\n              expandable: false,\n            },\n          });\n        }\n      });\n      return this.getElementSegments(splitElements.length + 1, segmentsArray).then((elements) => {\n        if (elements.length > 0) {\n          segmentsArray.push({\n            label: 'Select Element',\n            value: {\n              value: '-Select Element-',\n            },\n          });\n        }\n        return segmentsArray;\n      });\n    }\n    return Promise.resolve(segmentsArray);\n  };\n\n  /**\n   * Gets the segment information and parses it to a string.\n   *\n   * @param {any} index - Last index of segment to use.\n   * @returns - AF Path or PI Point name.\n   *\n   * @memberOf PIWebAPIQueryEditor\n   */\n  getSegmentPathUpTo(segments: Array<SelectableValue<PIWebAPISelectableValue>>, index: number): string {\n    const arr = segments.slice(0, index);\n\n    return reduce(\n      arr,\n      (result: any, segment: SelectableValue<PIWebAPISelectableValue>) => {\n        if (!segment.value) {\n          return '';\n        }\n        if (!segment.value.value?.startsWith('-Select')) {\n          return result ? result + '\\\\' + segment.value.value : segment.value.value;\n        }\n        return result;\n      },\n      ''\n    );\n  }\n\n  /**\n   * Get the current AF Element's child attributes. Validates when the element selection changes.\n   *\n   * @returns - Collection of attributes.\n   *\n   * @memberOf PIWebAPIQueryEditor\n   */\n  checkAttributeSegments(\n    attributes: Array<SelectableValue<PIWebAPISelectableValue>>,\n    segments: Array<SelectableValue<PIWebAPISelectableValue>>\n  ): Promise<any> {\n    const { datasource, data } = this.props;\n    const ctrl = this;\n    const findQuery = {\n      path: this.getSegmentPathUpTo(segments.slice(0), segments.length),\n      type: 'attributes',\n    };\n    return datasource\n      .metricFindQuery(findQuery, Object.assign(data?.request?.scopedVars ?? {}, { isPiPoint: false }))\n      .then((attributesResponse: any) => {\n        const validAttributes: any = {};\n\n        each(attributesResponse, (attribute: any) => {\n          validAttributes[attribute.Path.substring(attribute.Path.indexOf('|') + 1)] = attribute.WebId;\n        });\n\n        const filteredAttributes = filter(attributes, (attrib: SelectableValue<PIWebAPISelectableValue>) => {\n          const changedValue = datasource.templateSrv.replace(attrib.value?.value);\n          return validAttributes[changedValue] !== undefined;\n        });\n\n        ctrl.availableAttributes = validAttributes;\n        this.attributeChangeValue(filteredAttributes);\n      })\n      .catch((err: any) => {\n        ctrl.error = err.message || 'Failed to issue metric query';\n        this.attributeChangeValue(attributes);\n      });\n  }\n\n  /**\n   * Get PI points from server.\n   *\n   * @returns - Collection of attributes.\n   *\n   * @memberOf PIWebAPIQueryEditor\n   */\n  checkPiPointSegments(\n    attribute: SelectableValue<PIWebAPISelectableValue>,\n    attributes: Array<SelectableValue<PIWebAPISelectableValue>>\n  ) {\n    const { datasource, data } = this.props;\n    const ctrl = this;\n    const findQuery = {\n      path: attribute.path,\n      webId: ctrl.getSelectedPIServer(),\n      pointName: attribute.label,\n      type: 'pipoint',\n    };\n    return datasource\n      .metricFindQuery(findQuery, Object.assign(data?.request?.scopedVars ?? {}, { isPiPoint: true }))\n      .then(() => {\n        ctrl.attributeChangeValue(attributes);\n      })\n      .catch((err: any) => {\n        ctrl.error = err.message || 'Failed to issue metric query';\n        ctrl.attributeChangeValue([]);\n      });\n  }\n\n  /**\n   * Gets the webid of the current selected pi data server.\n   *\n   * @memberOf PIWebAPIQueryEditor\n   */\n  getSelectedPIServer() {\n    let webID = '';\n\n    this.piServer.forEach((s) => {\n      const parts = this.props.query.target.split(';');\n      if (parts.length >= 2) {\n        if (parts[0] === s.text) {\n          webID = s.WebId;\n          return;\n        }\n      }\n    });\n    return this.piServer.length > 0 ? this.piServer[0].value?.webId : webID;\n  }\n\n  /**\n   * Queries PI Web API for child elements and attributes when the raw query text editor is changed.\n   *\n   * @memberOf PIWebAPIQueryEditor\n   */\n  textEditorChanged() {\n    const { query, onChange } = this.props;\n    const splitAttributes = query.target.split(';');\n    const splitElements = splitAttributes.length > 0 ? splitAttributes[0].split('\\\\') : [];\n\n    let segments: Array<SelectableValue<PIWebAPISelectableValue>> = [];\n    let attributes: Array<SelectableValue<PIWebAPISelectableValue>> = [];\n\n    if (splitElements.length > 1 || (splitElements.length === 1 && splitElements[0] !== '')) {\n      // remove element hierarchy from attribute collection\n      splitAttributes.splice(0, 1);\n\n      each(splitElements, (item, _) => {\n        segments.push({\n          label: item,\n          value: {\n            type: item.match(/\\${\\w+}/gi) ? 'template' : undefined,\n            value: item,\n            expandable: true,\n          },\n        });\n      });\n      this.getElementSegments(splitElements.length + 1, segments).then((elements) => {\n        if (elements.length > 0) {\n          segments.push({\n            label: 'Select Element',\n            value: {\n              value: '-Select Element-',\n            },\n          });\n        }\n      });\n      each(splitAttributes, function (item, index) {\n        if (item !== '') {\n          attributes.push({\n            label: item,\n            value: {\n              value: item,\n              expandable: false,\n            },\n          });\n        }\n      });\n      this.updateArray(segments, attributes, this.state.summaries, query.isPiPoint, () => {\n        onChange({ ...query, query: undefined, rawQuery: false });\n      });\n    } else {\n      segments = this.checkAfServer();\n      this.updateArray(segments, this.state.attributes, this.state.summaries, query.isPiPoint, () => {\n        this.onChange({\n          ...query,\n          query: undefined,\n          rawQuery: false,\n          attributes: this.state.attributes,\n          segments: this.state.segments,\n        });\n      });\n    }\n  }\n\n  /**\n   * Check if the AF server and database are configured in the datasoure config.\n   *\n   * @returns the segments array\n   *\n   * @memberOf PIWebAPIQueryEditor\n   */\n  checkAfServer = () => {\n    const { datasource } = this.props;\n    const segmentsArray = [];\n    if (datasource.afserver?.name) {\n      segmentsArray.push({\n        label: datasource.afserver.name,\n        value: {\n          value: datasource.afserver.name,\n          expandable: true,\n        },\n      });\n      if (datasource.afdatabase?.name) {\n        segmentsArray.push({\n          label: datasource.afdatabase.name,\n          value: {\n            value: datasource.afdatabase.name,\n            expandable: true,\n          },\n        });\n      }\n      segmentsArray.push({\n        label: 'Select Element',\n        value: {\n          value: '-Select Element-',\n        },\n      });\n    } else {\n      segmentsArray.push({\n        label: '',\n      });\n    }\n    return segmentsArray;\n  };\n\n  /**\n   * Update the internal state of the datasource.\n   *\n   * @param segmentsArray the segments array to update\n   * @param attributesArray the AF attributes array to update\n   * @param summariesArray the summaries array to update\n   * @param isPiPoint the is PI point flag\n   * @param cb optional callback function\n   *\n   * @memberOf PIWebAPIQueryEditor\n   */\n  updateArray = (\n    segmentsArray: Array<SelectableValue<PIWebAPISelectableValue>>,\n    attributesArray: Array<SelectableValue<PIWebAPISelectableValue>>,\n    summariesArray: Array<SelectableValue<PIWebAPISelectableValue>>,\n    isPiPoint: boolean,\n    cb?: (() => void) | undefined\n  ) => {\n    this.setState(\n      {\n        segments: segmentsArray,\n        attributes: attributesArray,\n        summaries: summariesArray,\n        isPiPoint,\n      },\n      () => {\n        if (!isPiPoint) {\n          this.checkAttributeSegments(attributesArray, this.state.segments).then(() => {\n            if (cb) {\n              cb();\n            }\n          })\n        }\n      }\n    );\n  };\n\n  // React action when component is initialized/updated\n  scopedVarsDone = false;\n  componentDidMount = () => {\n    this.initialLoad(false);\n  };\n\n  componentDidUpdate = () => {\n    const { query } = this.props;\n    if (this.props.data?.state === 'Done' && !!this.props.data?.request?.scopedVars && !this.scopedVarsDone) {\n      this.scopedVarsDone = true;\n      this.initialLoad(!query.isPiPoint);\n    }\n  };\n\n  initialLoad = (force: boolean) => {\n    const { query } = this.props;\n    const metricsQuery = defaults(query, defaultQuery) as PIWebAPIQuery;\n    const { segments, attributes, summary, isPiPoint } = metricsQuery;\n\n    let segmentsArray: Array<SelectableValue<PIWebAPISelectableValue>> = force ? [] : segments?.slice(0) ?? [];\n    let attributesArray: Array<SelectableValue<PIWebAPISelectableValue>> = force ? [] : attributes?.slice(0) ?? [];\n    let summariesArray = summary?.types ?? [];\n\n    if (!isPiPoint && segmentsArray.length === 0) {\n      if (query.target && query.target.length > 0 && query.target !== ';') {\n        attributesArray = [];\n        // Build query from target\n        this.buildFromTarget(query, segmentsArray, attributesArray)\n          .then((_segmentsArray) => {\n            this.updateArray(_segmentsArray, attributesArray, summariesArray, isPiPoint);\n          })\n          .catch((e) => console.error(e));\n        return;\n      } else {\n        segmentsArray = this.checkAfServer();\n      }\n    } else if (isPiPoint && segmentsArray.length > 0) {\n      this.piServer = segmentsArray;\n    }\n    this.updateArray(segmentsArray, attributesArray, summariesArray, isPiPoint, () => {\n      this.onChange(query);\n    });\n  };\n\n  onChange = (query: PIWebAPIQuery) => {\n    const { onChange, onRunQuery } = this.props;\n\n    query.summary.types = this.state.summaries;\n    if (query.rawQuery) {\n      query.target = query.query ?? '';\n\n      if (query.target !== '') {\n        const splitAttributes = query.target.split(';');\n        const splitElements = splitAttributes[0].split('\\\\');\n\n        // remove element hierarchy from attribute collection\n        splitAttributes.splice(0, 1);\n\n        query.attributes = [];\n        if (splitElements.length > 1 || (splitElements.length === 1 && splitElements[0] !== '')) {\n          query.elementPath = splitElements.join('\\\\');\n          each(splitAttributes, function (item, index) {\n            if (item !== '') {\n              query.attributes.push({\n                label: item,\n                value: {\n                  value: item,\n                  expandable: false,\n                },\n              });\n            }\n          });\n        }\n      }\n    } else {\n      query.elementPath = this.getSegmentPathUpTo(this.state.segments, this.state.segments.length);\n      query.target =\n        query.elementPath +\n        ';' +\n        join(\n          query.attributes.map((s) => s.value?.value),\n          ';'\n        );\n    }\n\n    onChange(query);\n\n    if (query.target && query.target.length > 0 && query.attributes.length > 0) {\n      onRunQuery();\n    }\n  };\n\n  stateCallback = () => {\n    const query = this.props.query as PIWebAPIQuery;\n    this.onChange(query);\n  };\n\n  onIsPiPointChange = (event: React.SyntheticEvent<HTMLInputElement>) => {\n    const { query: queryChange } = this.props;\n    const isPiPoint = !queryChange.isPiPoint;\n    this.setState(\n      {\n        segments: isPiPoint ? [{ label: '' }] : this.checkAfServer(),\n        attributes: [],\n        isPiPoint,\n      },\n      () => {\n        this.onChange({\n          ...queryChange,\n          expression: '',\n          attributes: this.state.attributes,\n          segments: this.state.segments,\n          isPiPoint,\n        });\n      }\n    );\n  };\n\n  render() {\n    const { query: queryProps, onChange, onRunQuery } = this.props;\n    const metricsQuery = defaults(queryProps, defaultQuery) as PIWebAPIQuery;\n    const {\n      interpolate,\n      query,\n      rawQuery,\n      digitalStates,\n      recordedValues,\n      expression,\n      isPiPoint,\n      summary,\n      display,\n      regex,\n    } = metricsQuery;\n\n    return (\n      <>\n        {this.props.datasource.piPointConfig && (\n          <InlineField label=\"Is Pi Point?\" labelWidth={LABEL_WIDTH}>\n            <InlineSwitch value={isPiPoint} onChange={this.onIsPiPointChange} />\n          </InlineField>\n        )}\n\n        {!!rawQuery && (\n          <InlineFieldRow>\n            <InlineField label=\"Raw Query\" labelWidth={LABEL_WIDTH} grow={true}>\n              <Input\n                onBlur={this.stateCallback}\n                value={query}\n                onChange={(event: ChangeEvent<HTMLInputElement>) =>\n                  onChange({ ...metricsQuery, query: event.target.value })\n                }\n                placeholder=\"enter query\"\n              />\n            </InlineField>\n            <QueryEditorModeSwitcher isRaw={true} onChange={(value: boolean) => this.textEditorChanged()} />\n          </InlineFieldRow>\n        )}\n\n        {!rawQuery && (\n          <>\n            <div className=\"gf-form-inline\">\n              <QueryRawInlineField\n                label={isPiPoint ? 'PI Server' : 'AF Elements'}\n                tooltip={isPiPoint ? 'Select PI server.' : 'Select AF Element.'}\n              >\n                {this.state.segments.map((segment: SelectableValue<PIWebAPISelectableValue>, index: number) => {\n                  return (\n                    <SegmentAsync\n                      key={'element-' + index}\n                      Component={<CustomLabelComponent value={segment.value} label={segment.label} />}\n                      onChange={(item) => this.onSegmentChange(item, index)}\n                      loadOptions={(query?: string | undefined) => {\n                        return this.getElementSegments(index);\n                      }}\n                      allowCustomValue\n                      inputMinWidth={MIN_ELEM_INPUT_WIDTH}\n                    />\n                  );\n                })}\n                <QueryRowTerminator />\n                {!isPiPoint && (\n                  <QueryEditorModeSwitcher\n                    isRaw={false}\n                    onChange={(value: boolean) => {\n                      onChange({ ...metricsQuery, query: metricsQuery.target, rawQuery: value });\n                    }}\n                  />\n                )}\n              </QueryRawInlineField>\n            </div>\n\n            <QueryInlineField label={isPiPoint ? 'Pi Points' : 'Attributes'}>\n              {this.state.attributes.map((attribute: SelectableValue<PIWebAPISelectableValue>, index: number) => {\n                if (isPiPoint) {\n                  return (\n                    <SegmentAsync\n                      key={'attributes-' + index}\n                      Component={<CustomLabelComponent value={attribute.value} label={attribute.label} />}\n                      disabled={this.piServer.length === 0}\n                      onChange={(item) => this.onPiPointChange(item, index)}\n                      loadOptions={this.getAttributeSegmentsPI}\n                      reloadOptionsOnChange\n                      allowCustomValue\n                      inputMinWidth={MIN_ATTR_INPUT_WIDTH}\n                    />\n                  );\n                }\n                return (\n                  <Segment\n                    key={'attributes-' + index}\n                    Component={<CustomLabelComponent value={attribute.value} label={attribute.label} />}\n                    disabled={this.state.segments.length <= 2}\n                    onChange={(item) => this.onAttributeChange(item, index)}\n                    options={this.getAttributeSegmentsAF()}\n                    allowCustomValue\n                    inputMinWidth={MIN_ATTR_INPUT_WIDTH}\n                  />\n                );\n              })}\n\n              {isPiPoint && (\n                <SegmentAsync\n                  Component={\n                    <CustomLabelComponent\n                      value={this.state.attributeSegment.value}\n                      label={this.state.attributeSegment.label}\n                    />\n                  }\n                  disabled={this.piServer.length === 0}\n                  onChange={this.onAttributeAction}\n                  loadOptions={this.getAttributeSegmentsPI}\n                  reloadOptionsOnChange\n                  allowCustomValue\n                  inputMinWidth={MIN_ATTR_INPUT_WIDTH}\n                />\n              )}\n              {!isPiPoint && (\n                <Segment\n                  Component={\n                    <CustomLabelComponent\n                      value={this.state.attributeSegment.value}\n                      label={this.state.attributeSegment.label}\n                    />\n                  }\n                  disabled={this.state.segments.length <= 2}\n                  onChange={this.onAttributeAction}\n                  options={this.getAttributeSegmentsAF()}\n                  allowCustomValue\n                  inputMinWidth={MIN_ATTR_INPUT_WIDTH}\n                />\n              )}\n            </QueryInlineField>\n          </>\n        )}\n\n        <InlineField\n          label=\"Calculation\"\n          labelWidth={LABEL_WIDTH}\n          tooltip={\n            \"Modify all attributes by an equation. Use '.' for current item. Leave Attributes empty if you wish to perform element based calculations.\"\n          }\n        >\n          <Input\n            onBlur={onRunQuery}\n            value={expression}\n            onChange={(event: ChangeEvent<HTMLInputElement>) =>\n              this.onChange({ ...metricsQuery, expression: event.target.value })\n            }\n            placeholder=\"'.'*2\"\n          />\n        </InlineField>\n\n        <InlineFieldRow>\n          <InlineField\n            label=\"Max Recorded Values\"\n            labelWidth={LABEL_WIDTH}\n            tooltip={'Maximum number of recorded value to retrive from the data archive, without using interpolation.'}\n          >\n            <Input\n              onBlur={onRunQuery}\n              value={recordedValues.maxNumber}\n              onChange={(event: ChangeEvent<HTMLInputElement>) =>\n                this.onChange({\n                  ...metricsQuery,\n                  recordedValues: { ...recordedValues, maxNumber: parseInt(event.target.value, 10) },\n                })\n              }\n              type=\"number\"\n              placeholder=\"1000\"\n            />\n          </InlineField>\n          <InlineField label=\"Recorded Values\" labelWidth={LABEL_WIDTH}>\n            <InlineSwitch\n              value={recordedValues.enable}\n              onChange={() =>\n                this.onChange({\n                  ...metricsQuery,\n                  recordedValues: { ...recordedValues, enable: !recordedValues.enable },\n                })\n              }\n            />\n          </InlineField>\n          <InlineField label=\"Digital States\" labelWidth={LABEL_WIDTH}>\n            <InlineSwitch\n              value={digitalStates.enable}\n              onChange={() =>\n                this.onChange({ ...metricsQuery, digitalStates: { ...digitalStates, enable: !digitalStates.enable } })\n              }\n            />\n          </InlineField>\n        </InlineFieldRow>\n\n        <InlineFieldRow>\n          <InlineField\n            label=\"Interpolate Period\"\n            labelWidth={LABEL_WIDTH}\n            tooltip={\"Override time between sampling, e.g. '30s'. Defaults to timespan/chart width.\"}\n          >\n            <Input\n              onBlur={onRunQuery}\n              value={interpolate.interval}\n              onChange={(event: ChangeEvent<HTMLInputElement>) =>\n                this.onChange({ ...metricsQuery, interpolate: { ...interpolate, interval: event.target.value } })\n              }\n              placeholder=\"30s\"\n            />\n          </InlineField>\n          <InlineField label=\"Interpolate\" labelWidth={LABEL_WIDTH}>\n            <InlineSwitch\n              value={interpolate.enable}\n              onChange={() =>\n                this.onChange({ ...metricsQuery, interpolate: { ...interpolate, enable: !interpolate.enable } })\n              }\n            />\n          </InlineField>\n          <InlineField\n            label=\"Replace Bad Data\"\n            labelWidth={LABEL_WIDTH}\n            tooltip={'Replacement for bad quality values.'}\n          >\n            <Segment\n              Component={<CustomLabelComponent value={{ value: summary.nodata }} label={summary.nodata} />}\n              onChange={this.calcNoDataValueChanged}\n              options={this.getNoDataSegments()}\n              allowCustomValue\n            />\n          </InlineField>\n        </InlineFieldRow>\n\n        <InlineFieldRow>\n          <InlineField\n            label=\"Summary Period\"\n            labelWidth={LABEL_WIDTH}\n            tooltip={\"Override time between sampling, e.g. '30s'.\"}\n          >\n            <Input\n              onBlur={onRunQuery}\n              value={summary.interval}\n              onChange={(event: ChangeEvent<HTMLInputElement>) =>\n                onChange({ ...metricsQuery, summary: { ...summary, interval: event.target.value } })\n              }\n              placeholder=\"30s\"\n            />\n          </InlineField>\n          <InlineField\n            label=\"Basis\"\n            labelWidth={LABEL_WIDTH}\n            tooltip={\n              'Defines the possible calculation options when performing summary calculations over time-series data.'\n            }\n          >\n            <Segment\n              Component={<CustomLabelComponent value={{ value: summary.basis }} label={summary.basis} />}\n              onChange={this.calcBasisValueChanged}\n              options={this.getCalcBasisSegments()}\n              allowCustomValue\n            />\n          </InlineField>\n          <InlineField label=\"Summaries\" labelWidth={LABEL_WIDTH} tooltip={'Replacement for bad quality values.'}>\n            <InlineFieldRow>\n              {this.state.summaries.map((s: SelectableValue<PIWebAPISelectableValue>, index: number) => {\n                return (\n                  <Segment\n                    key={'summaries-' + index}\n                    Component={<CustomLabelComponent value={s.value} label={s.label} />}\n                    onChange={(item) => this.onSummaryValueChanged(item, index)}\n                    options={this.getSummarySegments()}\n                    allowCustomValue\n                  />\n                );\n              })}\n              <Segment\n                Component={\n                  <CustomLabelComponent\n                    value={this.state.summarySegment.value}\n                    label={this.state.summarySegment.label}\n                  />\n                }\n                onChange={this.onSummaryAction}\n                options={this.getSummarySegments()}\n                allowCustomValue\n              />\n            </InlineFieldRow>\n          </InlineField>\n        </InlineFieldRow>\n\n        <InlineFieldRow>\n          <InlineField\n            label=\"Display Name\"\n            labelWidth={LABEL_WIDTH}\n            tooltip={'If single attribute, modify display name. Otherwise use regex to modify display name.'}\n          >\n            <Input\n              onBlur={onRunQuery}\n              value={display}\n              onChange={(event: ChangeEvent<HTMLInputElement>) =>\n                this.onChange({ ...metricsQuery, display: event.target.value })\n              }\n              placeholder=\"Display\"\n            />\n          </InlineField>\n          <InlineField label=\"Enable Regex Replace\" labelWidth={LABEL_WIDTH}>\n            <InlineSwitch\n              value={regex.enable}\n              onChange={() => {\n                this.onChange({ ...metricsQuery, regex: { ...regex, enable: !regex.enable } });\n              }}\n            />\n          </InlineField>\n          <InlineField label=\"Search\" labelWidth={LABEL_WIDTH - 8}>\n            <Input\n              onBlur={onRunQuery}\n              value={regex.search}\n              onChange={(event: ChangeEvent<HTMLInputElement>) =>\n                this.onChange({ ...metricsQuery, regex: { ...regex, search: event.target.value } })\n              }\n              placeholder=\"(.*)\"\n            />\n          </InlineField>\n          <InlineField label=\"Replace\" labelWidth={LABEL_WIDTH - 8}>\n            <Input\n              onBlur={onRunQuery}\n              value={regex.replace}\n              onChange={(event: ChangeEvent<HTMLInputElement>) =>\n                this.onChange({ ...metricsQuery, regex: { ...regex, replace: event.target.value } })\n              }\n              placeholder=\"$1\"\n            />\n          </InlineField>\n        </InlineFieldRow>\n      </>\n    );\n  }\n}\n","import { curry, each, filter, flatten, forOwn, groupBy, keys, map, uniq } from 'lodash';\n\nimport {\n  DataQueryRequest,\n  DataQueryResponse,\n  DataSourceApi,\n  DataSourceInstanceSettings,\n  AnnotationEvent,\n  toDataFrame,\n  MetricFindValue,\n} from '@grafana/data';\nimport { BackendSrv, getBackendSrv, getTemplateSrv, TemplateSrv } from '@grafana/runtime';\n\nimport { PIWebAPIQuery, PIWebAPIDataSourceJsonData } from './types';\n\ninterface PiwebapiElementPath {\n  path: string;\n  variable: string;\n}\n\ninterface PiwebapiInternalRsp {\n  data: PiwebapiRsp;\n  status: number;\n  url: string;\n}\n\ninterface PiwebapTargetRsp {\n  refId: string;\n  target: string;\n  datapoints: any[];\n}\n\ninterface PiwebapiRsp {\n  Name?: string;\n  InstanceType?: string;\n  Items?: PiwebapiRsp[];\n  WebId?: string;\n  HasChildren?: boolean;\n  Path?: string;\n}\n\ninterface PiDataServer {\n  name: string | undefined;\n  webid: string | undefined;\n}\n\nexport class PiWebAPIDatasource extends DataSourceApi<PIWebAPIQuery, PIWebAPIDataSourceJsonData> {\n  piserver: PiDataServer;\n  afserver: PiDataServer;\n  afdatabase: PiDataServer;\n  piPointConfig: boolean;\n\n  basicAuth?: string;\n  withCredentials?: boolean;\n  url: string;\n  name: string;\n  isProxy = false;\n\n  templateSrv: TemplateSrv;\n  backendSrv: BackendSrv;\n\n  piwebapiurl?: string;\n  webidCache: Map<String, any> = new Map();\n\n  error: any;\n\n  constructor(instanceSettings: DataSourceInstanceSettings<PIWebAPIDataSourceJsonData>) {\n    super(instanceSettings);\n    this.basicAuth = instanceSettings.basicAuth;\n    this.withCredentials = instanceSettings.withCredentials;\n    this.url = instanceSettings.url!;\n    this.name = instanceSettings.name;\n    this.templateSrv = getTemplateSrv();\n    this.backendSrv = getBackendSrv();\n\n    this.piwebapiurl = instanceSettings.jsonData.url?.toString();\n    this.isProxy = /^http(s)?:\\/\\//.test(this.url) || instanceSettings.jsonData.access === 'proxy';\n\n    this.piserver = { name: (instanceSettings.jsonData || {}).piserver, webid: undefined };\n    this.afserver = { name: (instanceSettings.jsonData || {}).afserver, webid: undefined };\n    this.afdatabase = { name: (instanceSettings.jsonData || {}).afdatabase, webid: undefined };\n    this.piPointConfig = instanceSettings.jsonData.pipoint || false;\n\n    Promise.all([\n      this.getAssetServer(this.afserver.name).then((result: PiwebapiRsp) => (this.afserver.webid = result.WebId)),\n      this.getDataServer(this.piserver.name).then((result: PiwebapiRsp) => (this.piserver.webid = result.WebId)),\n      this.getDatabase(this.afserver.name ? this.afserver.name + '\\\\' + this.afdatabase.name : undefined).then(\n        (result: PiwebapiRsp) => (this.afdatabase.webid = result.WebId)\n      ),\n    ]);\n  }\n\n  /**\n   * Converts a PIWebAPI Event Frame response to a Grafana Annotation\n   *\n   * @param {any} annotationOptions - Options data from configuration panel.\n   * @param {any} endTime - End time of the Event Frame.\n   * @param {any} eventFrame - The Event Frame data.\n   * @returns - Grafana Annotation\n   *\n   * @memberOf PiWebApiDatasource\n   */\n  private eventFrameToAnnotation(\n    annotationOptions: any,\n    endTime: any,\n    eventFrame: any,\n    attributeDataItems: any\n  ): AnnotationEvent {\n    if (annotationOptions.regex && annotationOptions.regex.enable) {\n      eventFrame.Name = eventFrame.Name.replace(\n        new RegExp(annotationOptions.regex.search),\n        annotationOptions.regex.replace\n      );\n    }\n\n    let attributeText = '';\n    if (attributeDataItems) {\n      each(attributeDataItems, (attributeData: any) => {\n        const attributeValue = attributeData.Value.Value\n          ? attributeData.Value.Value.Name || attributeData.Value.Value.Value || attributeData.Value.Value\n          : null;\n        attributeText += '<br />' + attributeData.Name + ': ' + attributeValue;\n      });\n    }\n    return {\n      annotation: annotationOptions,\n      title: (endTime ? 'END ' : annotationOptions.showEndTime ? 'START ' : '') + annotationOptions.name,\n      time: new Date(endTime ? eventFrame.EndTime : eventFrame.StartTime).getTime(),\n      text:\n        eventFrame.Name + attributeText + '<br />Start: ' + eventFrame.StartTime + '<br />End: ' + eventFrame.EndTime,\n    };\n  }\n\n  /**\n   * Builds the PIWebAPI query parameters.\n   *\n   * @param {any} options - Grafana query and panel options.\n   * @returns - PIWebAPI query parameters.\n   *\n   * @memberOf PiWebApiDatasource\n   */\n  private buildQueryParameters(options: DataQueryRequest<PIWebAPIQuery>) {\n    options.targets = filter(options.targets, (target) => {\n      if (!target || !target.target) {\n        return false;\n      }\n      return !target.target.startsWith('Select AF');\n    });\n\n    options.targets = map(options.targets, (target) => {\n      const ds = this;\n      const tar = {\n        target: this.templateSrv.replace(target.elementPath, options.scopedVars),\n        elementPath: this.templateSrv.replace(target.elementPath, options.scopedVars),\n        elementPathArray: [\n          {\n            path: this.templateSrv.replace(target.elementPath, options.scopedVars),\n            variable: '',\n          } as PiwebapiElementPath,\n        ],\n        attributes: map(target.attributes, (att) =>\n          this.templateSrv.replace(att.value?.value || att, options.scopedVars)\n        ),\n        segments: map(target.segments, (att) => this.templateSrv.replace(att.value?.value, options.scopedVars)),\n        display: target.display,\n        refId: target.refId,\n        hide: target.hide,\n        interpolate: target.interpolate || { enable: false },\n        recordedValues: target.recordedValues || { enable: false },\n        digitalStates: target.digitalStates || { enable: false },\n        webid: target.webid,\n        webids: target.webids || [],\n        regex: target.regex || { enable: false },\n        expression: target.expression || '',\n        summary: target.summary || { types: [] },\n        startTime: options.range.from,\n        endTime: options.range.to,\n        isPiPoint: target.isPiPoint,\n        scopedVars: options.scopedVars,\n      };\n\n      if (tar.expression) {\n        tar.expression = this.templateSrv.replace(tar.expression, options.scopedVars);\n      }\n\n      if (tar.summary.types !== undefined) {\n        tar.summary.types = filter(tar.summary.types, (item) => {\n          return item !== undefined && item !== null && item !== '';\n        });\n      }\n\n      // explode All or Multi-selection\n      const varsKeys = keys(options.scopedVars);\n      this.templateSrv.getVariables().forEach((v: any) => {\n        if (ds.isAllSelected(v.current) && varsKeys.indexOf(v.name) < 0) {\n          // All selection\n          const variables = v.options.filter((o: any) => !o.selected);\n          // attributes\n          tar.attributes = tar.attributes.map((attr: string) =>\n            variables.map((vv: any) =>\n              !!v.allValue ? attr.replace(v.allValue, vv.value) : attr.replace(/{[a-zA-z0-9,-_]+}/gi, vv.value)\n            )\n          );\n          tar.attributes = uniq(flatten(tar.attributes));\n          // elementPath\n          tar.elementPathArray = ds.getElementPath(tar.elementPathArray, variables, v.allValue);\n        } else if (Array.isArray(v.current.text) && varsKeys.indexOf(v.name) < 0) {\n          // Multi-selection\n          const variables = v.options.filter((o: any) => o.selected);\n          // attributes\n          const query = v.current.value.join(',');\n          tar.attributes = tar.attributes.map((attr: string) =>\n            variables.map((vv: any) => attr.replace(`{${query}}`, vv.value))\n          );\n          tar.attributes = uniq(flatten(tar.attributes));\n          // elementPath\n          tar.elementPathArray = ds.getElementPath(tar.elementPathArray, variables, `{${query}}`);\n        }\n      });\n\n      return tar;\n    });\n\n    return options;\n  }\n\n  /**\n   * Datasource Implementation. Primary entry point for data source.\n   * This takes the panel configuration and queries, sends them to PI Web API and parses the response.\n   *\n   * @param {any} options - Grafana query and panel options.\n   * @returns - Promise of data in the format for Grafana panels.\n   *\n   * @memberOf PiWebApiDatasource\n   */\n  async query(options: DataQueryRequest<PIWebAPIQuery>): Promise<DataQueryResponse> {\n    const ds = this;\n    const query = this.buildQueryParameters(options);\n    query.targets = filter(query.targets, (t) => !t.hide);\n\n    if (query.targets.length <= 0) {\n      return Promise.resolve({ data: [] });\n    } else {\n      return Promise.all(ds.getStream(query)).then((targetResponses) => {\n        let flattened: PiwebapTargetRsp[] = [];\n        each(targetResponses, (tr) => {\n          each(tr, (item) => flattened.push(item));\n        });\n        const response: DataQueryResponse = {\n          data: flattened\n            .sort((a, b) => {\n              return +(a.target > b.target) || +(a.target === b.target) - 1;\n            })\n            .map((d) => toDataFrame(d)),\n        };\n        return response;\n      });\n    }\n  }\n\n  /**\n   * Datasource Implementation.\n   * Used for testing datasource in datasource configuration pange\n   *\n   * @returns - Success or failure message.\n   *\n   * @memberOf PiWebApiDatasource\n   */\n  testDatasource(): Promise<any> {\n    return this.backendSrv\n      .datasourceRequest({\n        url: this.url + '/',\n        method: 'GET',\n      })\n      .then((response: any) => {\n        if (response.status === 200) {\n          return { status: 'success', message: 'Data source is working', title: 'Success' };\n        }\n        throw new Error('Failed');\n      });\n  }\n\n  /**\n   * Datasource Implementation.\n   * This queries PI Web API for Event Frames and converts them into annotations.\n   *\n   * @param {any} options - Annotation options, usually the Event Frame Category.\n   * @returns - A Grafana annotation.\n   *\n   * @memberOf PiWebApiDatasource\n   */\n  annotationQuery(options: any): Promise<AnnotationEvent[]> {\n    if (!this.afdatabase.webid) {\n      return Promise.resolve([]);\n    }\n\n    const categoryName = options.annotation.query.categoryName\n      ? this.templateSrv.replace(options.annotation.query.categoryName, options.scopedVars, 'glob')\n      : null;\n    const nameFilter = options.annotation.query.nameFilter\n      ? this.templateSrv.replace(options.annotation.query.nameFilter, options.scopedVars, 'glob')\n      : null;\n    const templateName = options.annotation.template ? options.annotation.template.Name : null;\n    const annotationOptions = {\n      name: options.annotation.name,\n      datasource: options.annotation.datasource,\n      enable: options.annotation.enable,\n      iconColor: options.annotation.iconColor,\n      showEndTime: options.annotation.showEndTime,\n      regex: options.annotation.regex,\n      attribute: options.annotation.attribute,\n      categoryName: categoryName,\n      templateName: templateName,\n      nameFilter: nameFilter,\n    };\n\n    const filter = [];\n    if (!!annotationOptions.categoryName) {\n      filter.push('categoryName=' + annotationOptions.categoryName);\n    }\n    if (!!annotationOptions.nameFilter) {\n      filter.push('nameFilter=' + annotationOptions.nameFilter);\n    }\n    if (!!annotationOptions.templateName) {\n      filter.push('templateName=' + annotationOptions.templateName);\n    }\n    if (!filter.length) {\n      return Promise.resolve([]);\n    }\n    filter.push('startTime=' + options.range.from.toJSON());\n    filter.push('endTime=' + options.range.to.toJSON());\n\n    if (annotationOptions.attribute && annotationOptions.attribute.enable) {\n      let resourceUrl =\n        this.piwebapiurl + '/streamsets/{0}/value?selectedFields=Items.WebId%3BItems.Value%3BItems.Name';\n      if (!!annotationOptions.attribute.name) {\n        resourceUrl =\n          this.piwebapiurl +\n          '/streamsets/{0}/value?nameFilter=' +\n          annotationOptions.attribute.name +\n          '&selectedFields=Items.WebId%3BItems.Value%3BItems.Name';\n      }\n      const query: any = {};\n      query['1'] = {\n        Method: 'GET',\n        Resource: this.piwebapiurl + '/assetdatabases/' + this.afdatabase.webid + '/eventframes?' + filter.join('&'),\n      };\n      query['2'] = {\n        Method: 'GET',\n        RequestTemplate: {\n          Resource: resourceUrl,\n        },\n        Parameters: ['$.1.Content.Items[*].WebId'],\n        ParentIds: ['1'],\n      };\n      return this.restBatch(query).then((result: any) => {\n        const data = result.data['1'].Content;\n        const valueData = result.data['2'].Content;\n\n        const annotations = map(data.Items, (item: any, index: any) => {\n          return curry(this.eventFrameToAnnotation)(\n            annotationOptions,\n            false,\n            item,\n            valueData.Items[index].Content.Items\n          );\n        });\n\n        if (options.annotation.showEndTime) {\n          const ends = map(data.Items, (item: any, index: number) => {\n            return curry(this.eventFrameToAnnotation)(\n              annotationOptions,\n              true,\n              item,\n              valueData.Items[index].Content.Items\n            );\n          });\n          each(ends, (end) => {\n            annotations.push(end);\n          });\n        }\n\n        return annotations;\n      });\n    } else {\n      return this.restGet('/assetdatabases/' + this.afdatabase.webid + '/eventframes?' + filter.join('&')).then(\n        (result) => {\n          const annotations = map(result.data.Items, curry(this.eventFrameToAnnotation)(annotationOptions, false));\n          if (options.annotation.showEndTime) {\n            const ends = map(result.data.Items, curry(this.eventFrameToAnnotation)(annotationOptions, true));\n            each(ends, (end) => {\n              annotations.push(end);\n            });\n          }\n          return annotations;\n        }\n      );\n    }\n  }\n\n  /**\n   * Builds the Grafana metric segment for use on the query user interface.\n   *\n   * @param {any} response - response from PI Web API.\n   * @returns - Grafana metric segment.\n   *\n   * @memberOf PiWebApiDatasource\n   */\n  private metricQueryTransform(response: PiwebapiRsp[]): MetricFindValue[] {\n    return map(response, (item) => {\n      return {\n        text: item.Name,\n        expandable:\n          item.HasChildren === undefined || item.HasChildren === true || (item.Path ?? '').split('\\\\').length <= 3,\n        HasChildren: item.HasChildren,\n        Items: item.Items ?? [],\n        Path: item.Path,\n        WebId: item.WebId,\n      } as MetricFindValue;\n    });\n  }\n\n  /**\n   * This method does the discovery of the AF Hierarchy and populates the query user interface segments.\n   *\n   * @param {any} query - Parses the query configuration and builds a PI Web API query.\n   * @returns - Segment information.\n   *\n   * @memberOf PiWebApiDatasource\n   */\n  metricFindQuery(query: any, queryOptions: any): Promise<MetricFindValue[]> {\n    const ds = this;\n    const querydepth = ['servers', 'databases', 'databaseElements', 'elements'];\n    if (typeof query === 'string') {\n      query = JSON.parse(query as string);\n    }\n    if (queryOptions.isPiPoint) {\n      query.path = this.templateSrv.replace(query.path, queryOptions);\n    } else {\n      if (query.path === '') {\n        query.type = querydepth[0];\n      } else if (query.type !== 'attributes') {\n        query.type = querydepth[Math.max(0, Math.min(query.path.split('\\\\').length, querydepth.length - 1))];\n      }\n      query.path = this.templateSrv.replace(query.path, queryOptions);\n      query.path = query.path.replace(/\\{([^\\\\])*\\}/gi, (r: string) => r.substring(1, r.length - 2).split(',')[0]);\n    }\n\n    query.filter = query.filter ?? '*';\n\n    if (query.type === 'servers') {\n      return ds.afserver?.name\n        ? ds\n            .getAssetServer(ds.afserver.name)\n            .then((result: PiwebapiRsp) => [result])\n            .then(ds.metricQueryTransform)\n        : ds.getAssetServers().then(ds.metricQueryTransform);\n    } else if (query.type === 'databases') {\n      return ds\n        .getAssetServer(query.path)\n        .then((server) => ds.getDatabases(server.WebId ?? '', {}))\n        .then(ds.metricQueryTransform);\n    } else if (query.type === 'databaseElements') {\n      return ds\n        .getDatabase(query.path)\n        .then((db) =>\n          ds.getDatabaseElements(db.WebId ?? '', {\n            selectedFields: 'Items.WebId%3BItems.Name%3BItems.Items%3BItems.Path%3BItems.HasChildren',\n          })\n        )\n        .then(ds.metricQueryTransform);\n    } else if (query.type === 'elements') {\n      return ds\n        .getElement(query.path)\n        .then((element) =>\n          ds.getElements(element.WebId ?? '', {\n            selectedFields: 'Items.WebId%3BItems.Name%3BItems.Items%3BItems.Path%3BItems.HasChildren',\n            nameFilter: query.filter,\n          })\n        )\n        .then(ds.metricQueryTransform);\n    } else if (query.type === 'attributes') {\n      return ds\n        .getElement(query.path)\n        .then((element) =>\n          ds.getAttributes(element.WebId ?? '', {\n            searchFullHierarchy: 'true',\n            selectedFields: 'Items.WebId%3BItems.Name%3BItems.Path',\n            nameFilter: query.filter,\n          })\n        )\n        .then(ds.metricQueryTransform);\n    } else if (query.type === 'dataserver') {\n      return ds.getDataServers().then(ds.metricQueryTransform);\n    } else if (query.type === 'pipoint') {\n      return ds.piPointSearch(query.webId, query.pointName).then(ds.metricQueryTransform);\n    }\n    return Promise.reject('Bad type');\n  }\n\n  /**\n   * Gets the url of summary data from the query configuration.\n   *\n   * @param {any} summary - Query summary configuration.\n   * @returns - URL append string.\n   *\n   * @memberOf PiWebApiDatasource\n   */\n  getSummaryUrl(summary: any) {\n    if (summary.interval.trim() === '') {\n      return (\n        '&summaryType=' +\n        summary.types.map((s: any) => s.value?.value).join('&summaryType=') +\n        '&calculationBasis=' +\n        summary.basis\n      );\n    }\n    return (\n      '&summaryType=' +\n      summary.types.map((s: any) => s.value?.value).join('&summaryType=') +\n      '&calculationBasis=' +\n      summary.basis +\n      '&summaryDuration=' +\n      summary.interval.trim()\n    );\n  }\n\n  /**\n   * Resolve PIWebAPI response 'value' data to value - timestamp pairs.\n   *\n   * @param {any} value - A list of PIWebAPI values.\n   * @param {any} target - The target Grafana metric.\n   * @param {any} isSummary - Boolean for tracking if data is of summary class.\n   * @returns - An array of Grafana value, timestamp pairs.\n   *\n   */\n  parsePiPointValueList(value: any[], target: any, isSummary: boolean) {\n    const api = this;\n    const datapoints: any[] = [];\n    each(value, (item) => {\n      // @ts-ignore\n      const { grafanaDataPoint, previousValue, drop } = this.noDataReplace(\n        isSummary ? item.Value : item,\n        target.summary.nodata,\n        api.parsePiPointValue(isSummary ? item.Value : item, target, isSummary)\n      );\n      if (!drop) {\n        datapoints.push(grafanaDataPoint);\n      }\n    });\n    return datapoints;\n  }\n\n  /**\n   * Convert a PI Point value to use Grafana value/timestamp.\n   *\n   * @param {any} value - PI Point value.\n   * @param {any} isSummary - Boolean for tracking if data is of summary class.\n   * @param {any} target - The target grafana metric.\n   * @returns - Grafana value pair.\n   *\n   */\n  parsePiPointValue(value: any, target: any, isSummary: boolean) {\n    let num = !isSummary && typeof value.Value === 'object' ? value.Value?.Value : value.Value;\n\n    if (!value.Good || !!target.digitalStates?.enable) {\n      num = (!isSummary && typeof value.Value === 'object' ? value.Value?.Name : value.Name) ?? '';\n      return [this.checkNumber(num) ? Number(num) : num.trim(), new Date(value.Timestamp).getTime()];\n    }\n\n    return [this.checkNumber(num) ? Number(num) : num.trim(), new Date(value.Timestamp).getTime()];\n  }\n\n  /**\n   * Resolve PIWebAPI response 'value' data to value - timestamp pairs.\n   *\n   * @param {any} item - 'Item' object from PIWebAPI\n   * @param {any} noDataReplacementMode - String state of how to replace 'No Data'\n   * @param {any} grafanaDataPoint - Single Grafana value pair (value, timestamp).\n   * @returns grafanaDataPoint - Single Grafana value pair (value, timestamp).\n   * @returns perviousValue - {any} Grafana value (value only).\n   *\n   */\n  noDataReplace(\n    item: any,\n    noDataReplacementMode: any,\n    grafanaDataPoint: any[]\n  ): {\n    grafanaDataPoint: any[];\n    previousValue: any;\n    drop: boolean;\n  } {\n    let previousValue = null;\n    let drop = false;\n    if (!item.Good || item.Value === 'No Data' || (item.Value?.Name && item.Value?.Name === 'No Data')) {\n      if (noDataReplacementMode === 'Drop') {\n        drop = true;\n      } else if (noDataReplacementMode === '0') {\n        grafanaDataPoint[0] = 0;\n      } else if (noDataReplacementMode === 'Keep') {\n        // Do nothing keep\n      } else if (noDataReplacementMode === 'Null') {\n        grafanaDataPoint[0] = null;\n      } else if (noDataReplacementMode === 'Previous' && previousValue !== null) {\n        grafanaDataPoint[0] = previousValue;\n      }\n    } else {\n      previousValue = item.Value;\n    }\n    return { grafanaDataPoint, previousValue, drop };\n  }\n\n  /**\n   * Process the response from PI Web API for a single item.\n   *\n   * @param {any} content - Web response data.\n   * @param {any} target - The target grafana metric.\n   * @param {any} name - The target metric name.\n   * @returns - Parsed metric in target/datapoint json format.\n   *\n   * @memberOf PiWebApiDatasource\n   */\n  processResults(content: any, target: any, name: any, noTemplate: boolean): PiwebapTargetRsp[] {\n    const api = this;\n    const isSummary: boolean = target.summary && target.summary.types && target.summary.types.length > 0;\n    name = noTemplate ? name : this.getPath(target.elementPathArray, content.Path) + '|' + name;\n    if (target.regex && target.regex.enable && target.regex.search.length && target.regex.replace.length) {\n      name = name.replace(new RegExp(target.regex.search), target.regex.replace);\n    }\n    if (isSummary) {\n      const innerResults: any[] = [];\n      const groups = groupBy(content.Items, (item: any) => item.Type);\n      forOwn(groups, (value, key) => {\n        innerResults.push({\n          refId: target.refId,\n          target: name + '[' + key + ']',\n          datapoints: api.parsePiPointValueList(value, target, isSummary),\n        });\n      });\n      return innerResults;\n    }\n    return [\n      {\n        refId: target.refId,\n        target: name,\n        datapoints: api.parsePiPointValueList(content.Items, target, isSummary),\n      },\n    ];\n  }\n\n  /** PRIVATE SECTION */\n\n  /**\n   * Check if all items are selected.\n   *\n   * @param {any} current the current variable selection\n   * @return {boolean} true if all value is selected, false otherwise\n   */\n  private isAllSelected(current: any): boolean {\n    if (!current) {\n      return false;\n    }\n    if (Array.isArray(current.text)) {\n      return current.text.indexOf('All') >= 0;\n    }\n    return current.text === 'All';\n  }\n\n  /**\n   * Check if the value is a number.\n   *\n   * @param {any} number the value to check\n   * @returns {boolean} true if the value is a number, false otherwise\n   */\n  private checkNumber(number: any): boolean {\n    return typeof number === 'number' && !Number.isNaN(number) && Number.isFinite(number);\n  }\n\n  /**\n   * Returns a new element path list based on the panel variables.\n   *\n   * @param {string} elementPathArray array of element paths\n   * @param {string} variables the list of variable values\n   * @param {string} allValue the all value value for the variable\n   * @returns {PiwebapiElementPath[]} new element path list\n   */\n  private getElementPath(\n    elementPathArray: PiwebapiElementPath[],\n    variables: any[],\n    allValue: string\n  ): PiwebapiElementPath[] {\n    // elementPath\n    let newElementPathArray: PiwebapiElementPath[] = [];\n    elementPathArray.forEach((elem: PiwebapiElementPath) => {\n      if ((!!allValue && elem.path.indexOf(allValue) >= 0) || (!allValue && elem.path.match(/{[a-zA-z0-9,-_]+}/gi))) {\n        const temp: PiwebapiElementPath[] = variables.map((vv: any) => {\n          return {\n            path: !!allValue\n              ? elem.path.replace(allValue, vv.value)\n              : elem.path.replace(/{[a-zA-z0-9,-_]+}/gi, vv.value),\n            variable: vv.value,\n          } as PiwebapiElementPath;\n        });\n        newElementPathArray = newElementPathArray.concat(temp);\n      }\n    });\n    if (newElementPathArray.length) {\n      return uniq(flatten(newElementPathArray));\n    }\n    return elementPathArray;\n  }\n\n  /**\n   * Returns the last item of the element path.\n   *\n   * @param {string} path element path\n   * @returns {string} last item of the element path\n   */\n  private getPath(elementPathArray: PiwebapiElementPath[], path: string): string {\n    let splitPath = path.split('|');\n    if (splitPath.length === 0) {\n      return '';\n    }\n    if (elementPathArray.length === 0) {\n      return '';\n    }\n    splitPath = splitPath[0].split('\\\\');\n    const splitStr = splitPath.length === 0 ? '' : splitPath.pop() ?? '';\n    const foundElement = elementPathArray.find((e) => path.indexOf(e.path) >= 0)?.variable;\n    return foundElement ? foundElement + '|' + splitStr : splitStr;\n  }\n\n  /**\n   * Gets historical data from a PI Web API stream source.\n   *\n   * @param {any} query - Grafana query.\n   * @returns - Metric data.\n   *\n   * @memberOf PiWebApiDatasource\n   */\n  private getStream(query: any): Array<Promise<PiwebapTargetRsp[]>> {\n    const ds = this;\n    const results: Array<Promise<PiwebapTargetRsp[]>> = [];\n\n    each(query.targets, (target) => {\n      // pi point config disabled\n      if (target.isPiPoint && !ds.piPointConfig) {\n        console.error('Trying to call Pi Point server with Pi Point config disabled');\n        return;\n      }\n      target.attributes = filter(target.attributes || [], (attribute) => {\n        return 1 && attribute;\n      });\n      let url = '';\n      const isSummary = target.summary && target.summary.types && target.summary.types.length > 0;\n      const isInterpolated = target.interpolate && target.interpolate.enable;\n      // perhaps add a check to see if interpolate override time < query.interval\n      const intervalTime = target.interpolate.interval ? target.interpolate.interval : query.interval;\n      const timeRange = '?startTime=' + query.range.from.toJSON() + '&endTime=' + query.range.to.toJSON();\n      const targetName = target.expression || target.elementPath;\n      const displayName = target.display ? this.templateSrv.replace(target.display, query.scopedVars) : null;\n      if (target.expression) {\n        url += '/calculation';\n        if (isSummary) {\n          url += '/summary' + timeRange + (isInterpolated ? '&sampleType=Interval&sampleInterval=' + intervalTime : '');\n        } else if (isInterpolated) {\n          url += '/intervals' + timeRange + '&sampleInterval=' + intervalTime;\n        } else {\n          url += '/recorded' + timeRange;\n        }\n        url += '&expression=' + encodeURIComponent(target.expression.replace(/\\${intervalTime}/g, intervalTime));\n        if (target.attributes.length > 0) {\n          results.push(ds.internalStream(query, target, url));\n        } else if (target.isPiPoint) {\n          ds\n              .restPost(url + '&webId=' + ds.piserver.webid!)\n              .then((response: any) => ds.processResults(response.data, target, displayName || targetName, false))\n              .catch((err: any) => (ds.error = err));\n        } else {\n          results.push(\n            ds.restGetWebId(target.elementPath, false).then((webidresponse: any) => {\n              return ds\n                .restPost(url + webidresponse.WebId)\n                .then((response: any) => ds.processResults(response.data, target, displayName || targetName, false))\n                .catch((err: any) => (ds.error = err));\n            })\n          );\n        }\n      } else {\n        url += '/streamsets';\n        if (isSummary) {\n          url += '/summary' + timeRange + '&intervals=' + query.maxDataPoints + this.getSummaryUrl(target.summary);\n        } else if (target.interpolate && target.interpolate.enable) {\n          url += '/interpolated' + timeRange + '&interval=' + intervalTime;\n        } else if (target.recordedValues && target.recordedValues.enable) {\n          const maxNumber =\n            target.recordedValues.maxNumber && !isNaN(target.recordedValues.maxNumber)\n              ? target.recordedValues.maxNumber\n              : 10000;\n          url += '/recorded' + timeRange + '&maxCount=' + maxNumber;\n        } else {\n          url += '/plot' + timeRange + '&intervals=' + query.maxDataPoints;\n        }\n\n        results.push(ds.internalStream(query, target, url));\n      }\n    });\n\n    return results;\n  }\n\n  /**\n   * Return the data points from the provided Grafana query.\n   *\n   * @param {any} query - Grafana query.\n   * @param {any} target - Grafana query target.\n   * @param {string} url - The base URL for the query.\n   * @returns - Metric data.\n   *\n   * @memberOf PiWebApiDatasource\n   */\n  private internalStream(query: any, target: any, url: string): Promise<PiwebapTargetRsp[]> {\n    const ds = this;\n    const targetName = target.expression || target.elementPath;\n    const displayName = target.display ? this.templateSrv.replace(target.display, query.scopedVars) : null;\n    const noTemplate = target.elementPathArray.length === 1 && target.elementPath === target.elementPathArray[0].path;\n    let promises: Promise<PiwebapiRsp[]>;\n\n    if (noTemplate) {\n      if (target.attributes.length > 1 && !target.isPiPoint) {\n        promises = ds\n          .restGetWebId(target.elementPath, target.isPiPoint)\n          .then((datarsp) =>\n            ds.getAttributes(datarsp.WebId!, {\n              searchFullHierarchy: 'true',\n              nameFilter: '*',\n            })\n          )\n          .then((datarspa) =>\n            datarspa.filter(\n              (d) =>\n                target.attributes.indexOf(d.Name) >= 0 ||\n                target.attributes.indexOf(d.Path?.split('|').splice(1).join('|')) >= 0\n            )\n          );\n      } else {\n        promises = Promise.all(\n          map(target.attributes, (attribute: string) => {\n            if (target.expression) {\n              return this.getDataServer(this.piserver.name).then((data) => {\n                data.Path = attribute;\n                return data;\n              });\n            } else {\n              return ds.restGetWebId(target.elementPath + '|' + attribute, target.isPiPoint);\n            }\n          })\n        );\n      }\n    } else {\n      if (target.attributes.length > 1 && !target.isPiPoint) {\n        promises = Promise.all(\n          target.elementPathArray.map((elementPath: PiwebapiElementPath) => {\n            return ds\n              .restGetWebId(elementPath.path, target.isPiPoint)\n              .then((datarsp) =>\n                ds.getAttributes(datarsp.WebId!, {\n                  searchFullHierarchy: 'true',\n                  nameFilter: '*',\n                })\n              )\n              .then((datarspa) =>\n                datarspa.filter(\n                  (d) =>\n                    target.attributes.indexOf(d.Name) >= 0 ||\n                    target.attributes.indexOf(d.Path?.split('|').splice(1).join('|')) >= 0\n                )\n              );\n          })\n        );\n      } else {\n        promises = Promise.all(\n          flatten(\n            map(target.attributes, (attribute: string) => {\n              return target.elementPathArray.map((elementPath: PiwebapiElementPath) => {\n                if (target.expression) {\n                  return this.getDataServer(this.piserver.name).then((data) => {\n                    data.Path = attribute;\n                    return data;\n                  });\n                } else {\n                  return ds.restGetWebId(elementPath.path + '|' + attribute, target.isPiPoint);\n                }\n              })\n            })\n          )\n        );\n      }\n    }\n\n    const getFinalUrl = (replace: boolean, webid: PiwebapiRsp, url: string): string => {\n      const newUrl = (replace ? url.replace(/'\\.'/g, `'${webid.Path}'`) : url);\n      return newUrl;\n    }\n\n    return promises.then((webidresponse) => {\n      const query: any = {};\n      each(flatten(webidresponse), (webid, index) => {\n        query[index + 1] = {\n          Method: 'GET',\n          Resource: ds.piwebapiurl + getFinalUrl(target.isPiPoint && !!target.expression, webid, url) + '&webId=' + webid.WebId,\n        };\n      });\n\n      return ds\n        .restBatch(query)\n        .then((response: any) => {\n          const targetResults: any[] = [];\n          each(response.data, (value, key) => {\n            if (target.expression) {\n              const webid = webidresponse[parseInt(key, 10) - 1];\n              const attribute = target.isPiPoint ? webid.Path : webid.Name;\n              each(\n                ds.processResults(value.Content, target, displayName || attribute || targetName, noTemplate),\n                (targetResult) => targetResults.push(targetResult)\n              );\n            } else {\n              each(value.Content.Items, (item) => {\n                each(\n                  ds.processResults(item, target, displayName || item.Name || targetName, noTemplate),\n                  (targetResult) => targetResults.push(targetResult)\n                );\n              });\n            }\n          });\n          return targetResults;\n        })\n        .catch((err: any) => (ds.error = err));\n    });\n  }\n\n  /**\n   * Abstraction for calling the PI Web API REST endpoint\n   *\n   * @param {any} path - the path to append to the base server URL.\n   * @returns - The full URL.\n   *\n   * @memberOf PiWebApiDatasource\n   */\n  private restGet(path: string): Promise<PiwebapiInternalRsp> {\n    return this.backendSrv\n      .datasourceRequest({\n        url: this.url + path,\n        method: 'GET',\n        headers: { 'Content-Type': 'application/json' },\n      })\n      .then((response: any) => {\n        return response as PiwebapiInternalRsp;\n      });\n  }\n\n  /**\n   * Resolve a Grafana query into a PI Web API webid. Uses client side cache when possible to reduce lookups.\n   *\n   * @param {string} assetPath - The AF Path or the Pi Point Path (\\\\ServerName\\piPointName) to the asset.\n   * @param {boolean} isPiPoint - Flag indicating it's a PI Point\n   * @returns - URL query parameters.\n   *\n   * @memberOf PiWebApiDatasource\n   */\n  private restGetWebId(assetPath: string, isPiPoint: boolean): Promise<PiwebapiRsp> {\n    const ds = this;\n\n    // check cache\n    const cachedWebId = ds.webidCache.get(assetPath);\n    if (cachedWebId) {\n      return Promise.resolve({ Path: assetPath, WebId: cachedWebId.WebId, Name: cachedWebId.Name });\n    }\n\n    let path = '';\n    if (isPiPoint) {\n      path = '/points?selectedFields=WebId%3BName%3BPath&path=\\\\\\\\' + assetPath.replace('|', '\\\\');\n    } else {\n      // no cache hit, query server\n      path =\n        (assetPath.indexOf('|') >= 0\n          ? '/attributes?selectedFields=WebId%3BName%3BPath&path=\\\\\\\\'\n          : '/elements?selectedFields=WebId%3BName%3BPath&path=\\\\\\\\') + assetPath;\n    }\n\n    return this.backendSrv\n      .datasourceRequest({\n        url: this.url + path,\n        method: 'GET',\n        headers: { 'Content-Type': 'application/json' },\n      })\n      .then((response: any) => {\n        ds.webidCache.set(assetPath, response.data);\n        return { Path: assetPath, WebId: response.data.WebId, Name: response.data.Name };\n      });\n  }\n\n  /**\n   * Execute a batch query on the PI Web API.\n   *\n   * @param {any} batch - Batch JSON query data.\n   * @returns - Batch response.\n   *\n   * @memberOf PiWebApiDatasource\n   */\n  private restBatch(batch: any) {\n    return this.backendSrv.datasourceRequest({\n      url: this.url + '/batch',\n      data: batch,\n      method: 'POST',\n      headers: {\n        'Content-Type': 'application/json',\n        'X-Requested-With': 'message/http',\n      },\n    });\n  }\n\n  /**\n   * Execute a POST on the PI Web API.\n   *\n   * @param {string} path - The full url of the POST.\n   * @returns - POST response data.\n   *\n   * @memberOf PiWebApiDatasource\n   */\n  private restPost(path: string) {\n    return this.backendSrv.datasourceRequest({\n      url: this.url,\n      method: 'POST',\n      headers: {\n        'Content-Type': 'application/json',\n        'X-Requested-With': 'message/http',\n        'X-PIWEBAPI-HTTP-METHOD': 'GET',\n        'X-PIWEBAPI-RESOURCE-ADDRESS': path,\n      },\n    });\n  }\n\n  // Get a list of all data (PI) servers\n  private getDataServers(): Promise<PiwebapiRsp[]> {\n    return this.restGet('/dataservers').then((response) => response.data.Items ?? []);\n  }\n  private getDataServer(name: string | undefined): Promise<PiwebapiRsp> {\n    if (!name) {\n      return Promise.resolve({});\n    }\n    return this.restGet('/dataservers?name=' + name).then((response) => response.data);\n  }\n  // Get a list of all asset (AF) servers\n  private getAssetServers(): Promise<PiwebapiRsp[]> {\n    return this.restGet('/assetservers').then((response) => response.data.Items ?? []);\n  }\n  private getAssetServer(name: string | undefined): Promise<PiwebapiRsp> {\n    if (!name) {\n      return Promise.resolve({});\n    }\n    return this.restGet('/assetservers?path=\\\\\\\\' + name).then((response) => response.data);\n  }\n  private getDatabase(path: string | undefined): Promise<PiwebapiRsp> {\n    if (!path) {\n      return Promise.resolve({});\n    }\n    return this.restGet('/assetdatabases?path=\\\\\\\\' + path).then((response) => response.data);\n  }\n  getDatabases(serverId: string, options?: any): Promise<PiwebapiRsp[]> {\n    if (!serverId) {\n      return Promise.resolve([]);\n    }\n    return this.restGet('/assetservers/' + serverId + '/assetdatabases').then((response) => response.data.Items ?? []);\n  }\n  getElement(path: string): Promise<PiwebapiRsp> {\n    if (!path) {\n      return Promise.resolve({});\n    }\n    return this.restGet('/elements?path=\\\\\\\\' + path).then((response) => response.data);\n  }\n  getEventFrameTemplates(databaseId: string): Promise<PiwebapiRsp[]> {\n    if (!databaseId) {\n      return Promise.resolve([]);\n    }\n    return this.restGet(\n      '/assetdatabases/' + databaseId + '/elementtemplates?selectedFields=Items.InstanceType%3BItems.Name%3BItems.WebId'\n    ).then((response) => {\n      return filter(response.data.Items ?? [], (item) => item.InstanceType === 'EventFrame');\n    });\n  }\n  getElementTemplates(databaseId: string): Promise<PiwebapiRsp[]> {\n    if (!databaseId) {\n      return Promise.resolve([]);\n    }\n    return this.restGet(\n      '/assetdatabases/' + databaseId + '/elementtemplates?selectedFields=Items.InstanceType%3BItems.Name%3BItems.WebId'\n    ).then((response) => {\n      return filter(response.data.Items ?? [], (item) => item.InstanceType === 'Element');\n    });\n  }\n\n  /**\n   * @description\n   * Get the child attributes of the current resource.\n   * GET attributes/{webId}/attributes\n   * @param {string} elementId - The ID of the parent resource. See WebID for more information.\n   * @param {Object} options - Query Options\n   * @param {string} options.nameFilter - The name query string used for finding attributes. The default is no filter. See Query String for more information.\n   * @param {string} options.categoryName - Specify that returned attributes must have this category. The default is no category filter.\n   * @param {string} options.templateName - Specify that returned attributes must be members of this template. The default is no template filter.\n   * @param {string} options.valueType - Specify that returned attributes' value type must be the given value type. The default is no value type filter.\n   * @param {string} options.searchFullHierarchy - Specifies if the search should include attributes nested further than the immediate attributes of the searchRoot. The default is 'false'.\n   * @param {string} options.sortField - The field or property of the object used to sort the returned collection. The default is 'Name'.\n   * @param {string} options.sortOrder - The order that the returned collection is sorted. The default is 'Ascending'.\n   * @param {string} options.startIndex - The starting index (zero based) of the items to be returned. The default is 0.\n   * @param {string} options.showExcluded - Specified if the search should include attributes with the Excluded property set. The default is 'false'.\n   * @param {string} options.showHidden - Specified if the search should include attributes with the Hidden property set. The default is 'false'.\n   * @param {string} options.maxCount - The maximum number of objects to be returned per call (page size). The default is 1000.\n   * @param {string} options.selectedFields - List of fields to be returned in the response, separated by semicolons (;). If this parameter is not specified, all available fields will be returned. See Selected Fields for more information.\n   */\n  private getAttributes(elementId: string, options: any): Promise<PiwebapiRsp[]> {\n    let querystring =\n      '?' +\n      map(options, (value, key) => {\n        return key + '=' + value;\n      }).join('&');\n\n    if (querystring === '?') {\n      querystring = '';\n    }\n\n    return this.restGet('/elements/' + elementId + '/attributes' + querystring).then(\n      (response) => response.data.Items ?? []\n    );\n  }\n\n  /**\n   * @description\n   * Retrieve elements based on the specified conditions. By default, this method selects immediate children of the current resource.\n   * Users can search for the elements based on specific search parameters. If no parameters are specified in the search, the default values for each parameter will be used and will return the elements that match the default search.\n   * GET assetdatabases/{webId}/elements\n   * @param {string} databaseId - The ID of the parent resource. See WebID for more information.\n   * @param {Object} options - Query Options\n   * @param {string} options.webId - The ID of the resource to use as the root of the search. See WebID for more information.\n   * @param {string} options.nameFilter - The name query string used for finding objects. The default is no filter. See Query String for more information.\n   * @param {string} options.categoryName - Specify that returned elements must have this category. The default is no category filter.\n   * @param {string} options.templateName - Specify that returned elements must have this template or a template derived from this template. The default is no template filter.\n   * @param {string} options.elementType - Specify that returned elements must have this type. The default type is 'Any'. See Element Type for more information.\n   * @param {string} options.searchFullHierarchy - Specifies if the search should include objects nested further than the immediate children of the searchRoot. The default is 'false'.\n   * @param {string} options.sortField - The field or property of the object used to sort the returned collection. The default is 'Name'.\n   * @param {string} options.sortOrder - The order that the returned collection is sorted. The default is 'Ascending'.\n   * @param {number} options.startIndex - The starting index (zero based) of the items to be returned. The default is 0.\n   * @param {number} options.maxCount - The maximum number of objects to be returned per call (page size). The default is 1000.\n   * @param {string} options.selectedFields -  List of fields to be returned in the response, separated by semicolons (;). If this parameter is not specified, all available fields will be returned. See Selected Fields for more information.\n   */\n  private getDatabaseElements(databaseId: string, options: any): Promise<PiwebapiRsp[]> {\n    let querystring =\n      '?' +\n      map(options, (value, key) => {\n        return key + '=' + value;\n      }).join('&');\n\n    if (querystring === '?') {\n      querystring = '';\n    }\n\n    return this.restGet('/assetdatabases/' + databaseId + '/elements' + querystring).then(\n      (response) => response.data.Items ?? []\n    );\n  }\n\n  /**\n   * @description\n   * Retrieve elements based on the specified conditions. By default, this method selects immediate children of the current resource.\n   * Users can search for the elements based on specific search parameters. If no parameters are specified in the search, the default values for each parameter will be used and will return the elements that match the default search.\n   * GET elements/{webId}/elements\n   * @param {string} databaseId - The ID of the resource to use as the root of the search. See WebID for more information.\n   * @param {Object} options - Query Options\n   * @param {string} options.webId - The ID of the resource to use as the root of the search. See WebID for more information.\n   * @param {string} options.nameFilter - The name query string used for finding objects. The default is no filter. See Query String for more information.\n   * @param {string} options.categoryName - Specify that returned elements must have this category. The default is no category filter.\n   * @param {string} options.templateName - Specify that returned elements must have this template or a template derived from this template. The default is no template filter.\n   * @param {string} options.elementType - Specify that returned elements must have this type. The default type is 'Any'. See Element Type for more information.\n   * @param {string} options.searchFullHierarchy - Specifies if the search should include objects nested further than the immediate children of the searchRoot. The default is 'false'.\n   * @param {string} options.sortField - The field or property of the object used to sort the returned collection. The default is 'Name'.\n   * @param {string} options.sortOrder - The order that the returned collection is sorted. The default is 'Ascending'.\n   * @param {number} options.startIndex - The starting index (zero based) of the items to be returned. The default is 0.\n   * @param {number} options.maxCount - The maximum number of objects to be returned per call (page size). The default is 1000.\n   * @param {string} options.selectedFields -  List of fields to be returned in the response, separated by semicolons (;). If this parameter is not specified, all available fields will be returned. See Selected Fields for more information.\n   */\n  private getElements(elementId: string, options: any): Promise<PiwebapiRsp[]> {\n    let querystring =\n      '?' +\n      map(options, (value, key) => {\n        return key + '=' + value;\n      }).join('&');\n\n    if (querystring === '?') {\n      querystring = '';\n    }\n\n    return this.restGet('/elements/' + elementId + '/elements' + querystring).then(\n      (response) => response.data.Items ?? []\n    );\n  }\n\n  /**\n   * Retrieve a list of points on a specified Data Server.\n   *\n   * @param {string} serverId - The ID of the server. See WebID for more information.\n   * @param {string} nameFilter - A query string for filtering by point name. The default is no filter. *, ?, [ab], [!ab]\n   */\n  private piPointSearch(serverId: string, nameFilter: string): Promise<PiwebapiRsp[]> {\n    let filter1 = this.templateSrv.replace(nameFilter);\n    let filter2 = `${filter1}`;\n    let doFilter = false;\n    if (filter1 !== nameFilter) {\n      const regex = /\\{(\\w|,)+\\}/gs;\n      let m;\n      while ((m = regex.exec(filter1)) !== null) {\n        // This is necessary to avoid infinite loops with zero-width matches\n        if (m.index === regex.lastIndex) {\n          regex.lastIndex++;\n        }\n\n        // The result can be accessed through the `m`-variable.\n        m.forEach((match, groupIndex) => {\n          if (groupIndex === 0) {\n            filter1 = filter1.replace(match, match.replace('{', '(').replace('}', ')').replace(',', '|'));\n            filter2 = filter2.replace(match, '*');\n            doFilter = true;\n          }\n        });\n      }\n    }\n    return this.restGet('/dataservers/' + serverId + '/points?maxCount=20&nameFilter=' + filter2).then((results) => {\n      if (!!results && !!results.data?.Items) {\n        return doFilter ? results.data.Items.filter((item) => item.Name?.match(filter1)) : results.data.Items;\n      }\n      return [];\n    });\n  }\n\n  /**\n   * Get the PI Web API webid or PI Point.\n   *\n   * @param {any} target - AF Path or Point name.\n   * @returns - webid.\n   *\n   * @memberOf PiWebApiDatasource\n   */\n  getWebId(target: any) {\n    const ds = this;\n    const isAf = target.target.indexOf('\\\\') >= 0;\n    const isAttribute = target.target.indexOf('|') >= 0;\n    if (!isAf && target.target.indexOf('.') === -1) {\n      return Promise.resolve([{ WebId: target.target, Name: target.display || target.target }]);\n    }\n\n    if (!isAf) {\n      // pi point lookup\n      return ds.piPointSearch(this.piserver.webid!, target.target).then((results) => {\n        if (results === undefined || results.length === 0) {\n          return [{ WebId: target.target, Name: target.display || target.target }];\n        }\n        return results;\n      });\n    } else if (isAf && isAttribute) {\n      // af attribute lookup\n      return ds.restGet('/attributes?path=\\\\\\\\' + target.target).then((results) => {\n        if (results.data === undefined || results.status !== 200) {\n          return [{ WebId: target.target, Name: target.display || target.target }];\n        }\n        // rewrite name if specified\n        results.data.Name = target.display || results.data.Name;\n        return [results.data];\n      });\n    } else {\n      // af element lookup\n      return ds.restGet('/elements?path=\\\\\\\\' + target.target).then((results) => {\n        if (results.data === undefined || results.status !== 200) {\n          return [{ WebId: target.target, Name: target.display || target.target }];\n        }\n        // rewrite name if specified\n        results.data.Name = target.display || results.data.Name;\n        return [results.data];\n      });\n    }\n  }\n}\n","import { DataSourcePlugin } from '@grafana/data';\nimport { AnnotationsQueryCtrl } from './AnnotationsQueryCtrl';\nimport { PIWebAPIConfigEditor } from './ConfigEditor';\nimport { PIWebAPIQueryEditor } from './QueryEditor';\nimport { PiWebAPIDatasource } from './datasource';\nimport { PIWebAPIQuery, PIWebAPIDataSourceJsonData } from './types';\n\nexport const plugin = new DataSourcePlugin<PiWebAPIDatasource, PIWebAPIQuery, PIWebAPIDataSourceJsonData>(\n  PiWebAPIDatasource\n)\n  .setConfigEditor(PIWebAPIConfigEditor)\n  .setQueryEditor(PIWebAPIQueryEditor)\n  .setAnnotationQueryCtrl(AnnotationsQueryCtrl);\n"],"names":["module","exports","__WEBPACK_EXTERNAL_MODULE__0__","__WEBPACK_EXTERNAL_MODULE__1__","__WEBPACK_EXTERNAL_MODULE__2__","__WEBPACK_EXTERNAL_MODULE__3__","__WEBPACK_EXTERNAL_MODULE__5__","__webpack_module_cache__","__webpack_require__","moduleId","cachedModule","undefined","__webpack_modules__","n","getter","__esModule","d","a","definition","key","o","Object","defineProperty","enumerable","get","obj","prop","prototype","hasOwnProperty","call","r","Symbol","toStringTag","value","AnnotationsQueryCtrl","$scope","this","annotation","ctrl","datasource","query","databases","templates","regex","attribute","showEndTime","getAssetServer","afserver","name","then","result","getDatabases","WebId","getEventFrames","webid","dbs","$apply","getEventFrameTemplates","database","FormField","LegacyForms","coerceOptions","options","jsonData","url","PIWebAPIConfigEditor","event","props","onOptionsChange","piserver","target","afdatabase","checked","pipoint","originalOptions","DataSourceHttpSettings","defaultUrl","dataSourceConfig","onChange","onMyOptionsChange","showAccessOptions","className","InlineField","label","labelWidth","InlineSwitch","onPiPointChange","inputWidth","onPIServerChange","placeholder","onAFServerChange","onAFDatabaseChange","PureComponent","QueryField","tooltip","children","InlineFormLabel","width","QueryRowTerminator","QueryInlineField","QueryEditorRow","QueryRawInlineField","QueryRawEditorRow","defaultQuery","attributes","segments","enable","summary","types","basis","interval","nodata","expression","interpolate","recordedValues","digitalStates","isPiPoint","QueryEditorModeSwitcher","isRaw","useState","isModalOpen","setModalOpen","useEffect","Button","icon","variant","type","onClick","ConfirmModal","isOpen","title","body","confirmText","dismissText","onConfirm","onDismiss","LABEL_WIDTH","MIN_ATTR_INPUT_WIDTH","REMOVE_LABEL","CustomLabelComponent","Icon","PIWebAPIQueryEditor","summaries","attributeSegment","summarySegment","calculationBasisSegment","noDataReplacementSegment","setState","item","index","state","slice","remove","checkPiPointSegments","checkAttributeSegments","length","push","expandable","piServer","segmentChangeValue","currentSegment","data","findQuery","path","getSegmentPathUpTo","Promise","resolve","metricFindQuery","assign","request","scopedVars","items","altSegments","map","text","webId","variables","templateSrv","getVariables","each","variable","selectableValue","unshift","err","error","message","attributeText","getSelectedPIServer","pointName","Path","forOwn","availableAttributes","val","segmentsArray","attributesArray","splitAttributes","split","splitElements","splice","_","getElementSegments","elements","summariesArray","cb","initialLoad","scopedVarsDone","force","metricsQuery","defaults","buildFromTarget","_segmentsArray","updateArray","e","checkAfServer","onRunQuery","rawQuery","elementPath","join","s","queryChange","onSegmentChange","bind","calcBasisValueChanged","calcNoDataValueChanged","onSummaryAction","onSummaryValueChanged","onAttributeAction","onAttributeChange","summaryTypes","calculationBasis","noDataReplacement","segment","isValueEmpty","stateCallback","filter","indexOf","part","attributeChangeValue","arr","reduce","startsWith","attributesResponse","validAttributes","substring","filteredAttributes","attrib","changedValue","replace","webID","forEach","parts","match","queryProps","display","piPointConfig","onIsPiPointChange","InlineFieldRow","grow","Input","onBlur","textEditorChanged","SegmentAsync","Component","loadOptions","allowCustomValue","inputMinWidth","disabled","getAttributeSegmentsPI","reloadOptionsOnChange","Segment","getAttributeSegmentsAF","maxNumber","parseInt","getNoDataSegments","getCalcBasisSegments","getSummarySegments","search","PiWebAPIDatasource","instanceSettings","Map","basicAuth","withCredentials","getTemplateSrv","backendSrv","getBackendSrv","piwebapiurl","toString","isProxy","test","access","all","getDataServer","getDatabase","annotationOptions","endTime","eventFrame","attributeDataItems","Name","RegExp","attributeData","attributeValue","Value","time","Date","EndTime","StartTime","getTime","targets","ds","tar","elementPathArray","att","refId","hide","webids","startTime","range","from","to","varsKeys","keys","v","isAllSelected","current","selected","attr","vv","allValue","uniq","flatten","getElementPath","Array","isArray","buildQueryParameters","t","getStream","targetResponses","flattened","tr","sort","b","toDataFrame","datasourceRequest","method","response","status","Error","categoryName","nameFilter","templateName","template","iconColor","toJSON","resourceUrl","Method","Resource","RequestTemplate","Parameters","ParentIds","restBatch","Content","valueData","annotations","Items","curry","eventFrameToAnnotation","ends","end","restGet","HasChildren","queryOptions","querydepth","JSON","parse","Math","max","min","metricQueryTransform","getAssetServers","server","db","getDatabaseElements","selectedFields","getElement","element","getElements","getAttributes","searchFullHierarchy","getDataServers","piPointSearch","reject","trim","isSummary","api","datapoints","noDataReplace","parsePiPointValue","grafanaDataPoint","previousValue","drop","num","Good","checkNumber","Number","Timestamp","noDataReplacementMode","content","noTemplate","getPath","innerResults","groups","groupBy","Type","parsePiPointValueList","number","isNaN","isFinite","newElementPathArray","elem","temp","concat","splitPath","splitStr","pop","foundElement","find","results","isInterpolated","intervalTime","timeRange","targetName","displayName","encodeURIComponent","internalStream","restPost","processResults","restGetWebId","webidresponse","maxDataPoints","getSummaryUrl","promises","datarsp","datarspa","getFinalUrl","targetResults","targetResult","headers","assetPath","cachedWebId","webidCache","set","batch","serverId","databaseId","InstanceType","elementId","querystring","filter1","filter2","doFilter","m","exec","lastIndex","groupIndex","isAf","isAttribute","DataSourceApi","plugin","DataSourcePlugin","setConfigEditor","setQueryEditor","setAnnotationQueryCtrl"],"sourceRoot":""}