{"version":3,"file":"module.js","mappings":";uHAAAA,EAAOC,QAAUC,OCAjBF,EAAOC,QAAUE,OCAjBH,EAAOC,QAAUG,OCAjBJ,EAAOC,QAAUI,QCAjBL,EAAOC,QAAUK,ICCbC,EAA2B,CAAC,EAGhC,SAASC,EAAoBC,GAE5B,IAAIC,EAAeH,EAAyBE,GAC5C,QAAqBE,IAAjBD,EACH,OAAOA,EAAaT,QAGrB,IAAID,EAASO,EAAyBE,GAAY,CAGjDR,QAAS,CAAC,GAOX,OAHAW,EAAoBH,GAAUT,EAAQA,EAAOC,QAASO,GAG/CR,EAAOC,OACf,CCrBAO,EAAoBK,EAAKb,IACxB,IAAIc,EAASd,GAAUA,EAAOe,WAC7B,IAAOf,EAAiB,QACxB,IAAM,EAEP,OADAQ,EAAoBQ,EAAEF,EAAQ,CAAEG,EAAGH,IAC5BA,CAAM,ECLdN,EAAoBQ,EAAI,CAACf,EAASiB,KACjC,IAAI,IAAIC,KAAOD,EACXV,EAAoBY,EAAEF,EAAYC,KAASX,EAAoBY,EAAEnB,EAASkB,IAC5EE,OAAOC,eAAerB,EAASkB,EAAK,CAAEI,YAAY,EAAMC,IAAKN,EAAWC,IAE1E,ECNDX,EAAoBY,EAAI,CAACK,EAAKC,IAAUL,OAAOM,UAAUC,eAAeC,KAAKJ,EAAKC,GCClFlB,EAAoBsB,EAAK7B,IACH,oBAAX8B,QAA0BA,OAAOC,aAC1CX,OAAOC,eAAerB,EAAS8B,OAAOC,YAAa,CAAEC,MAAO,WAE7DZ,OAAOC,eAAerB,EAAS,aAAc,CAAEgC,OAAO,GAAO,8VCLvD,IAAMC,EAAoB,WAQ/B,WAAYC,GAAa,iMACvBC,KAAKD,OAASA,EACdC,KAAKC,WAAaF,EAAOG,KAAKD,WAC9BD,KAAKG,WAAaJ,EAAOG,KAAKC,WAG9BH,KAAKC,WAAWG,MAAQJ,KAAKC,WAAWG,OAAS,CAAC,EAClDJ,KAAKC,WAAWI,UAAYL,KAAKC,WAAWI,WAAa,GACzDL,KAAKC,WAAWK,UAAYN,KAAKC,WAAWK,WAAa,GACzDN,KAAKC,WAAWM,MAAQP,KAAKC,WAAWM,OAAS,CAAC,EAClDP,KAAKC,WAAWO,UAAYR,KAAKC,WAAWO,WAAa,CAAC,EAC1DR,KAAKC,WAAWQ,YAAcT,KAAKC,WAAWQ,cAAe,EAE7DT,KAAKG,WAAWO,eAAeV,KAAKG,WAAWQ,SAASC,MAAMC,MAAK,SAACC,GAClE,OAAO,EAAKC,aAAaD,EAAOE,MAClC,GACF,WAqBC,OA7C8B,uBAwB9B,mCACD,WACE,GACD,6BACD,WACEhB,KAAKC,WAAWK,UAAY,GAC5BN,KAAKiB,gBACP,GAAC,0BACD,SAAaC,GAAe,WACpBhB,EAAOF,KACbE,EAAKC,WAAWY,aAAaG,GAAOL,MAAK,SAACM,GACxCjB,EAAKD,WAAWI,UAAYc,EAC5B,EAAKpB,OAAOqB,QACd,GACF,GAAC,4BACD,WAAiB,WACTlB,EAAOF,KACbE,EAAKC,WAAWkB,uBAAuBrB,KAAKC,WAAWqB,SAASN,OAAOH,MAAK,SAACP,GAC3EJ,EAAKD,WAAWK,UAAYA,EAC5B,EAAKP,OAAOqB,QACd,GACF,oFAAC,EA7C8B,GA8ChC,EA9CYtB,EAAoB,cACV,81DCIvB,QAAQyB,EAAcC,EAAAA,YAAAA,UAIhBC,EAAgB,SACpBC,GAEA,OAAO,EAAP,GACKA,EAAO,CACVC,SAAU,EAAF,GACHD,EAAQC,SAAQ,CACnBC,IAAKF,EAAQE,OAGnB,EAIaC,EAAoB,8ZAkD9B,OAlD8B,4DACZ,SAACC,GAClB,MAAqC,EAAKC,MAAlCC,EAAe,EAAfA,gBAAiBN,EAAO,EAAPA,QACnBC,EAAW,EAAH,GACTD,EAAQC,SAAQ,CACnBM,SAAUH,EAAMI,OAAOrC,QAEzBmC,EAAgB,EAAD,GAAMN,EAAS,CAAAC,SAAAA,IAChC,IAAC,2BAEkB,SAACG,GAClB,MAAqC,EAAKC,MAAlCC,EAAe,EAAfA,gBAAiBN,EAAO,EAAPA,QACnBC,EAAW,EAAH,GACTD,EAAQC,SAAQ,CACnBhB,SAAUmB,EAAMI,OAAOrC,QAEzBmC,EAAgB,EAAD,GAAMN,EAAS,CAAAC,SAAAA,IAChC,IAAC,6BAEoB,SAACG,GACpB,MAAqC,EAAKC,MAAlCC,EAAe,EAAfA,gBAAiBN,EAAO,EAAPA,QACnBC,EAAW,EAAH,GACTD,EAAQC,SAAQ,CACnBQ,WAAYL,EAAMI,OAAOrC,QAE3BmC,EAAgB,EAAD,GAAMN,EAAS,CAAAC,SAAAA,IAChC,IAAC,8BAEqB,SAACD,IAErBM,EAD4B,EAAKD,MAAzBC,iBACQP,EAAcC,GAChC,IAAC,0BAEiB,SAACI,GACjB,MAAqC,EAAKC,MAAlCC,EAAe,EAAfA,gBAAiBN,EAAO,EAAPA,QACnBC,EAAW,EAAH,GACTD,EAAQC,SAAQ,CACnBM,SAAUH,EAAMI,OAAOE,QAAUV,EAAQC,SAASM,SAAW,GAC7DI,QAASP,EAAMI,OAAOE,UAExBJ,EAAgB,EAAD,GAAMN,EAAS,CAAAC,SAAAA,IAChC,IAAC,4BAEmB,SAACG,GACnB,MAAqC,EAAKC,MAAlCC,EAAe,EAAfA,gBAAiBN,EAAO,EAAPA,QACnBC,EAAW,EAAH,GACTD,EAAQC,SAAQ,CACnBW,UAAWR,EAAMI,OAAOE,UAE1BJ,EAAgB,EAAD,GAAMN,EAAS,CAAAC,SAAAA,IAChC,IAAC,EAoEA,SApEA,0BAED,WACE,IAAiBY,EAAoBvC,KAAK+B,MAAlCL,QACFA,EAAUD,EAAcc,GAE9B,OACE,6BACE,kBAAC,EAAAC,uBAAsB,CACrBC,WAAW,+BACXC,iBAAkBhB,EAClBiB,SAAU3C,KAAK4C,oBACfC,mBAAiB,IACjB,MAEF,wBAAIC,UAAU,gBAAc,yBAE5B,yBAAKA,UAAU,iBACb,yBAAKA,UAAU,kBACb,kBAAC,EAAAC,YAAW,CAACC,MAAM,4BAA4BC,WAAY,IACzD,kBAAC,EAAAC,aAAY,CAACrD,MAAO6B,EAAQC,SAASU,QAASM,SAAU3C,KAAKmD,oBAGlE,yBAAKL,UAAU,kBACb,kBAAC,EAAAC,YAAW,CAACC,MAAM,yBAAyBC,WAAY,IACtD,kBAAC,EAAAC,aAAY,CAACrD,MAAO6B,EAAQC,SAASW,UAAWK,SAAU3C,KAAKoD,uBAGhE,MAEN,wBAAIN,UAAU,gBAAc,6BAE5B,yBAAKA,UAAU,iBACZpB,EAAQC,SAASU,SAChB,yBAAKS,UAAU,WACb,kBAACvB,EAAS,CACRyB,MAAM,YACNC,WAAY,GACZI,WAAY,GACZV,SAAU3C,KAAKsD,iBACfzD,MAAO6B,EAAQC,SAASM,UAAY,GACpCsB,YAAY,gDAIlB,yBAAKT,UAAU,WACb,kBAACvB,EAAS,CACRyB,MAAM,YACNC,WAAY,GACZI,WAAY,GACZV,SAAU3C,KAAKwD,iBACf3D,MAAO6B,EAAQC,SAAShB,UAAY,GACpC4C,YAAY,gDAGhB,yBAAKT,UAAU,WACb,kBAACvB,EAAS,CACRyB,MAAM,cACNC,WAAY,GACZI,WAAY,GACZV,SAAU3C,KAAKyD,mBACf5D,MAAO6B,EAAQC,SAASQ,YAAc,GACtCoB,YAAY,gDAMxB,oFAAC,EAtH8B,CAASG,EAAAA,0PCZnC,IAAMC,EAAgD,SAAH,OAAMX,EAAK,EAALA,MAAK,IAAEC,WAAAA,OAAU,IAAG,KAAE,EAAEW,EAAO,EAAPA,QAASC,EAAQ,EAARA,SAAQ,OACvG,oCACE,kBAAC,EAAAC,gBAAe,CAACC,MAAOd,EAAYW,QAASA,GAC1CZ,GAEFa,EACA,EAGQG,EAAqB,WAChC,OAAO,IAAP,EACE,yBAAKlB,UAAU,yBACb,yBAAKA,UAAU,uCAGrB,EAEamB,EAAmB,SAAH,GAAqB,IAAZlC,EAAK,QACzC,OACE,kBAACmC,EAAc,KACb,kBAACP,EAAe5B,GAGtB,EAEamC,EAAiB,SAACnC,GAC7B,OACE,yBAAKe,UAAU,kBACZf,EAAM8B,SAAQ,MACf,kBAACG,EAAkB,OAGzB,EAEaG,EAAsB,SAAH,GAAqB,IAAZpC,EAAK,QAC5C,OACE,kBAACqC,EAAiB,KAChB,kBAACT,EAAe5B,GAGtB,EAEaqC,EAAoB,SAACrC,GAChC,OAAO,oCAAGA,EAAM8B,SAClB,ECgBaQ,EAAuC,CAClDnC,OAAQ,IACRoC,WAAY,GACZC,SAAU,GACVhE,MAAO,CAAEiE,QAAQ,GACjBC,QAAS,CAAEC,MAAO,GAAIC,MAAO,gBAAiBC,SAAU,GAAIC,OAAQ,QACpEC,WAAY,GACZC,YAAa,CAAEP,QAAQ,GACvBQ,aAAc,CAAER,QAAQ,GACxBS,eAAgB,CAAET,QAAQ,GAC1BU,cAAe,CAAEV,QAAQ,GACzBW,WAAW,m9BC1EN,QAAMC,EAA0B,SAAH,GAAgD,IAA1CC,EAAK,EAALA,MAAO1C,EAAQ,EAARA,SACI,KAAf2C,EAAAA,EAAAA,WAAS,GAAM,GAA5CC,EAAW,KAAEC,EAAY,KAOhC,OALAC,EAAAA,EAAAA,YAAU,WAERD,GAAa,EACf,GAAG,CAACH,IAEAA,EAEA,oCACE,kBAAC,EAAAK,OAAM,CACL,aAAW,0BACXC,KAAK,MACLC,QAAQ,YACRC,KAAK,SACLC,QAAS,WAEPN,GAAa,EACf,IAEF,kBAAC,EAAAO,aAAY,CACXC,OAAQT,EACRU,MAAM,+BACNC,KAAK,kGACLC,YAAY,6BACZC,YAAY,6BACZC,UAAW,WACT1D,GAAS,EACX,EACA2D,UAAW,WACTd,GAAa,EACf,KAMJ,kBAAC,EAAAE,OAAM,CACL,aAAW,wBACXC,KAAK,MACLC,QAAQ,YACRC,KAAK,SACLC,QAAS,WACPnD,GAAS,EACX,GAIR,+rDC9CA,IAAM4D,EAAc,GAEdC,EAAuB,IAevBC,EAAe,WAEfC,EAAuB,SAAC3E,GACX,MAAjB,OAAIA,EAAMlC,MAEN,yBAAKiD,UAAS,wBAAwC,aAArBf,EAAMlC,MAAMgG,KAAsB,gBAAkB,KACvE,QAD4E,EACvF9D,EAAMiB,aAAK,QAAI,gBAIf,IAAP,EACE,uBAAGF,UAAU,4BACX,kBAAC,EAAA6D,KAAI,CAAC/F,KAAK,UAGjB,EAEagG,EAAmB,yTAkB9B,WAAY7E,GAAY,MAyCpB,mGAzCoB,SACT,IAAb,cAAMA,IAAO,kCAjBG,IAAE,6BACO,CAAC,GAAC,kHAId,CACboD,WAAW,EACXZ,SAAU,GACVD,WAAY,GACZuC,UAAW,GACXC,iBAAkB,CAAC,EACnBC,eAAgB,CAAC,EACjBC,wBAAyB,CAAC,EAC1BC,yBAA0B,CAAC,IAC5B,6BAmDoB,SAAC1C,GACpB,IAAMnE,EAAQ,EAAK2B,MAAM3B,MACzB,EAAK8G,SAAS,CAAE3C,SAAAA,IAAY,kBAAM,EAAK5B,SAAS,KAAKvC,EAAO,CAAAmE,SAAAA,IAAW,GACzE,IAAC,+BAEsB,SAACD,GACtB,IAAMlE,EAAQ,EAAK2B,MAAM3B,MACzB,EAAK8G,SAAS,CAAE5C,WAAAA,IAAc,kBAAM,EAAK3B,SAAS,KAAKvC,EAAO,CAAAkE,WAAAA,IAAa,GAC7E,IAAC,0BAoIiB,SAAC6C,EAAgDC,GACjE,IAAI9C,EAAa,EAAK+C,MAAM/C,WAAWgD,MAAM,GAEzCH,EAAKnE,QAAUyD,GACjBc,EAAAA,EAAAA,QAAOjD,GAAY,SAACzE,EAAOpB,GAAC,OAAKA,IAAM2I,CAAK,IAG5C9C,EAAW8C,GAASD,EAGtB,EAAKK,qBAAqBL,EAAM7C,EAClC,IAAC,4BAEmB,SAAC6C,EAAgDC,GAAkB,MACjF9C,EAAa,EAAK+C,MAAM/C,WAAWgD,MAAM,GAGzChD,EAAW8C,GAAOpE,SAAoB,QAAf,EAAKmE,EAAKtH,aAAK,aAAV,EAAYA,SAK5CyE,EAAW8C,GAASD,EAEpB,EAAKM,uBAAuBnD,EAAY,EAAK+C,MAAM9C,UACrD,IAAC,0BAEiB,SAAC4C,EAAgDC,GAAkB,MAC3EhH,EAAU,EAAK2B,MAAf3B,MACJmE,EAAW,EAAK8C,MAAM9C,SAAS+C,MAAM,GAGrC/C,EAAS6C,GAAOpE,SAAoB,QAAf,EAAKmE,EAAKtH,aAAK,aAAV,EAAYA,QAK1C,EAAKqH,SAAS,CAAE5C,WAAY,KAAM,WAChC,OAAI6C,EAAKnE,QAAUyD,GACjBlC,GAAW+C,EAAAA,EAAAA,OAAM/C,EAAU,EAAG6C,QAC9B,EAAKK,uBAAuB,GAAIlD,GAAU1D,MAAK,WAAM,MAC3B,IAApB0D,EAASmD,OACXnD,EAASoD,KAAK,CACZ3E,MAAO,KAEqC,QAApC,EAACuB,EAASA,EAASmD,OAAS,GAAG7H,aAAK,OAAnC,EAAqC+H,YAChDrD,EAASoD,KAAK,CACZ3E,MAAO,iBACPnD,MAAO,CACLA,MAAO,sBAITO,EAAM+E,YACR,EAAK0C,SAAW,IAElB,EAAKC,mBAAmBvD,EAC1B,MAKFA,EAAS6C,GAASD,EAGd/G,EAAM+E,WACR,EAAK0C,SAASF,KAAKR,QACnB,EAAKW,mBAAmBvD,KAKtB6C,EAAQ7C,EAASmD,OAAS,IAC5BnD,GAAW+C,EAAAA,EAAAA,OAAM/C,EAAU,EAAG6C,EAAQ,SAExC,EAAKK,uBAAuB,GAAIlD,GAAU1D,MAAK,WAAM,MAEnC,QAAX,EAACsG,EAAKtH,aAAK,OAAV,EAAY+H,YAChBrD,EAASoD,KAAK,CACZ3E,MAAO,iBACPnD,MAAO,CACLA,MAAO,sBAIb,EAAKiI,mBAAmBvD,EAC1B,KACF,GACF,IAAC,6BAGoB,SACnB6C,EACAW,GAC6D,QAC7D,EAAoC,EAAKhG,MAAjC5B,EAAU,EAAVA,WAAYC,EAAK,EAALA,MAAO4H,EAAI,EAAJA,KACrB9H,EAAO,KACP+H,EAAY7H,EAAM+E,UACpB,CAAEU,KAAM,cACR,CAAEqC,KAAM,EAAKC,mBAAmBJ,QAAAA,EAAkB,EAAKV,MAAM9C,SAAS+C,MAAM,GAAIF,IAEpF,IAAKhH,EAAM+E,UAAW,WACpB,GAAuB,QAAnB,EAAAhF,EAAWQ,gBAAQ,OAAnB,EAAqBC,MAAkB,IAAVwG,EAC/B,OAAOgB,QAAQC,QAAQ,CACrB,CACErF,MAAO7C,EAAWQ,SAASC,KAC3Bf,MAAO,CACLA,MAAOM,EAAWQ,SAASC,KAC3BgH,YAAY,MAKpB,GAAuB,QAAnB,EAAAzH,EAAWQ,gBAAQ,OAAnB,EAAqBC,MAA6B,QAAzB,EAAIT,EAAWgC,kBAAU,OAArB,EAAuBvB,MAAkB,IAAVwG,EAC9D,OAAOgB,QAAQC,QAAQ,CACrB,CACErF,MAAO7C,EAAWgC,WAAWvB,KAC7Bf,MAAO,CACLA,MAAOM,EAAWgC,WAAWvB,KAC7BgH,YAAY,KAStB,CACA,OAAOzH,EACJmI,gBAAgBL,EAAWhJ,OAAOsJ,OAAgC,QAA1B,EAACP,SAAa,QAAT,EAAJA,EAAMQ,eAAO,WAAT,EAAJ,EAAeC,kBAAU,QAAI,CAAC,EAAG,CAAEtD,UAAW/E,EAAM+E,aAC7FtE,MAAK,SAAC6H,GACL,IAAMC,GAAcC,EAAAA,EAAAA,KAAIF,GAAO,SAACvB,GAS9B,MARgE,CAC9DnE,MAAOmE,EAAK0B,KACZhJ,MAAO,CACLiJ,MAAO3B,EAAKnG,MACZnB,MAAOsH,EAAK0B,KACZjB,YAAaxH,EAAM+E,WAAagC,EAAKS,YAI3C,IAEA,GAA2B,IAAvBe,EAAYjB,OACd,OAAOiB,EAIT,IAAMI,EAAY5I,EAAW6I,YAAYC,eAoBzC,OAnBAC,EAAAA,EAAAA,MAAKH,GAAW,SAACI,GACf,IAAIC,EAA4D,CAC9DpG,MAAO,KAAOmG,EAASvI,KAAO,IAC9Bf,MAAO,CACLgG,KAAM,WACNhG,MAAO,KAAOsJ,EAASvI,KAAO,IAC9BgH,YAAaxH,EAAM+E,YAGvBwD,EAAYU,QAAQD,EACtB,IAEAT,EAAYU,QAAQ,CAClBrG,MAAOyD,EACP5G,MAAO,CACLA,MAAO4G,KAIJkC,CACT,IAAE,OACK,SAACW,GAEN,OADApJ,EAAKqJ,MAAQD,EAAIE,SAAW,+BACrB,EACT,GACJ,IAAC,iCAGwB,SAACC,GAAqF,QAC7G,EAAoC,EAAK1H,MAAjC5B,EAAU,EAAVA,WAAYC,EAAK,EAALA,MAAO4H,EAAI,EAAJA,KACrB9H,EAAO,KACP+H,EAAY,CAChBC,KAAM,GACNY,MAAO,EAAKY,sBACZC,WAAYF,QAAAA,EAAiB,IAAM,IACnC5D,KAAM,WAEJtB,EAA4D,GAChE,OAAOpE,EACJmI,gBAAgBL,EAAWhJ,OAAOsJ,OAAgC,QAA1B,EAACP,SAAa,QAAT,EAAJA,EAAMQ,eAAO,WAAT,EAAJ,EAAeC,kBAAU,QAAI,CAAC,EAAG,CAAEtD,UAAW/E,EAAM+E,aAC7FtE,MAAK,SAAC6H,GACLnE,GAAWqE,EAAAA,EAAAA,KAAIF,GAAO,SAACvB,GASrB,MARgE,CAC9De,KAAMf,EAAKyC,KACX5G,MAAOmE,EAAK0B,KACZhJ,MAAO,CACLA,MAAOsH,EAAK0B,KACZjB,YAAY,GAIlB,IACM6B,GAAiBA,EAAc/B,OAAS,GAC1CnD,EAAS8E,QAAQ,CACjBrG,MAAOyG,EACP5J,MAAO,CACLA,MAAO4J,EACP7B,YAAY,KAKlB,IAAMmB,EAAY5I,EAAW6I,YAAYC,eAkBzC,OAjBAC,EAAAA,EAAAA,MAAKH,GAAW,SAACI,GACf,IAAIC,EAA4D,CAC9DpG,MAAO,KAAOmG,EAASvI,KAAO,IAC9Bf,MAAO,CACLgG,KAAM,WACNhG,MAAO,KAAOsJ,EAASvI,KAAO,IAC9BgH,YAAaxH,EAAM+E,YAGvBZ,EAAS8E,QAAQD,EACnB,IACA7E,EAAS8E,QAAQ,CACfrG,MAAOyD,EACP5G,MAAO,CACLA,MAAO4G,KAGJlC,CACT,IAAE,OACK,SAAC+E,GAEN,OADApJ,EAAKqJ,MAAQD,EAAIE,SAAW,+BACrBjF,CACT,GACJ,IAAC,iCAGwB,SAACkF,GACxB,IAAMvJ,EAAO,KACTqE,EAA4D,GAoBhE,OAlBAsF,EAAAA,EAAAA,QAAO3J,EAAK4J,qBAAqB,SAACC,EAAUhL,GAC1C,IAAIqK,EAA4D,CAC9DpG,MAAOjE,EACPc,MAAO,CACLA,MAAOd,EACP6I,YAAY,IAGhBrD,EAASoD,KAAKyB,EAChB,IAEA7E,EAAS8E,QAAQ,CACfrG,MAAOyD,EACP5G,MAAO,CACLA,MAAO4G,KAIJlC,CACT,IAAC,0BAGiB,SAChBnE,EACA4J,EACAC,GAEA,IAAMC,EAAkB9J,EAAM8B,OAAOiI,MAAM,KACrCC,EAAgBF,EAAgBxC,OAAS,EAAIwC,EAAgB,GAAGC,MAAM,MAAQ,GAEpF,OAAIC,EAAc1C,OAAS,GAA+B,IAAzB0C,EAAc1C,QAAqC,KAArB0C,EAAc,IAE3EF,EAAgBG,OAAO,EAAG,IAE1BnB,EAAAA,EAAAA,MAAKkB,GAAe,SAACjD,EAAMmD,GACzBN,EAAcrC,KAAK,CACjB3E,MAAOmE,EACPtH,MAAO,CACLgG,KAAMsB,EAAKoD,MAAM,aAAe,gBAAahM,EAC7CsB,MAAOsH,EACPS,YAAY,IAGlB,KACAsB,EAAAA,EAAAA,MAAKgB,GAAiB,SAAC/C,EAAMmD,GACd,KAATnD,GAEF8C,EAAgBtC,KAAK,CACnB3E,MAAOmE,EACPtH,MAAO,CACLA,MAAOsH,EACPS,YAAY,IAIpB,IACO,EAAK4C,mBAAmBJ,EAAc1C,OAAS,EAAGsC,GAAenJ,MAAK,SAAC4J,GAS5E,OARIA,EAAS/C,OAAS,GACpBsC,EAAcrC,KAAK,CACjB3E,MAAO,iBACPnD,MAAO,CACLA,MAAO,sBAINmK,CACT,KAEK5B,QAAQC,QAAQ2B,EACzB,IAAC,wBAiMe,WAAM,MAGW,EAFvB7J,EAAe,EAAK4B,MAApB5B,WACF6J,EAAgB,GACC,QAAvB,EAAI7J,EAAWQ,gBAAQ,OAAnB,EAAqBC,MACvBoJ,EAAcrC,KAAK,CACjB3E,MAAO7C,EAAWQ,SAASC,KAC3Bf,MAAO,CACLA,MAAOM,EAAWQ,SAASC,KAC3BgH,YAAY,KAGS,QAAzB,EAAIzH,EAAWgC,kBAAU,OAArB,EAAuBvB,MACzBoJ,EAAcrC,KAAK,CACjB3E,MAAO7C,EAAWgC,WAAWvB,KAC7Bf,MAAO,CACLA,MAAOM,EAAWgC,WAAWvB,KAC7BgH,YAAY,KAIlBoC,EAAcrC,KAAK,CACjB3E,MAAO,iBACPnD,MAAO,CACLA,MAAO,uBAIXmK,EAAcrC,KAAK,CACjB3E,MAAO,KAGX,OAAOgH,CACT,IAAC,sBAaa,SACZA,EACAC,EACAS,EACAvF,EACAwF,GAEA,EAAKzD,SACH,CACE3C,SAAUyF,EACV1F,WAAY2F,EACZpD,UAAW6D,EACXvF,UAAAA,IAEF,WACOA,GACH,EAAKsC,uBAAuBwC,EAAiB,EAAK5C,MAAM9C,UAAU1D,MAAK,WACjE8J,GACFA,GAEJ,GAEJ,GAEJ,IAAC,yBAGgB,GAAK,4BACF,WAClB,EAAKC,aAAY,EACnB,IAAC,6BAEoB,WAAM,UACjBxK,EAAU,EAAK2B,MAAf3B,MACuB,UAAZ,QAAf,IAAK2B,MAAMiG,YAAI,aAAf,EAAiBX,QAAqC,QAAhB,EAAC,EAAKtF,MAAMiG,YAAI,OAAS,QAAT,EAAf,EAAiBQ,eAAO,OAAxB,EAA0BC,aAAe,EAAKoC,iBACvF,EAAKA,gBAAiB,EACtB,EAAKD,aAAaxK,EAAM+E,WAE5B,IAAC,sBAEa,SAAC2F,GAAmB,UACxB1K,EAAU,EAAK2B,MAAf3B,MACF2K,GAAeC,EAAAA,EAAAA,UAAS5K,EAAOiE,GAC7BE,EAA6CwG,EAA7CxG,SAAUD,EAAmCyG,EAAnCzG,WAAYG,EAAuBsG,EAAvBtG,QAASU,EAAc4F,EAAd5F,UAEnC6E,EAAiEc,EAAQ,GAAuB,QAArB,EAAGvG,aAAQ,EAARA,EAAU+C,MAAM,UAAE,QAAI,GACpG2C,EAAmEa,EAAQ,GAAyB,QAAvB,EAAGxG,aAAU,EAAVA,EAAYgD,MAAM,UAAE,QAAI,GACxGoD,EAA+B,QAAjB,EAAGjG,aAAO,EAAPA,EAASC,aAAK,QAAI,GAEvC,GAAKS,GAAsC,IAAzB6E,EAActC,OAarBvC,GAAa6E,EAActC,OAAS,IAC7C,EAAKG,SAAWmC,OAd4B,CAC5C,GAAI5J,EAAM8B,QAAU9B,EAAM8B,OAAOwF,OAAS,GAAsB,MAAjBtH,EAAM8B,OAQnD,OAPA+H,EAAkB,QAElB,EAAKgB,gBAAgB7K,EAAO4J,EAAeC,GACxCpJ,MAAK,SAACqK,GACL,EAAKC,YAAYD,EAAgBjB,EAAiBS,EAAgBvF,EACpE,IAAE,OACK,SAACiG,GAAsB,IAGhCpB,EAAgB,EAAKqB,eAEzB,CAGA,EAAKF,YAAYnB,EAAeC,EAAiBS,EAAgBvF,GAAW,WAC1E,EAAKxC,SAASvC,EAChB,GACF,IAAC,mBAEU,SAACA,GACV,IAGoB,EAHpB,EAAiC,EAAK2B,MAA9BY,EAAQ,EAARA,SAAU2I,EAAU,EAAVA,YAElBlL,EAAMqE,QAAQC,MAAQ,EAAK2C,MAAMR,UAC7BzG,EAAMmL,UACRnL,EAAM8B,OAAoB,QAAd,EAAG9B,EAAMA,aAAK,QAAI,IAE9BA,EAAMoL,YAAc,EAAKrD,mBAAmB,EAAKd,MAAM9C,SAAU,EAAK8C,MAAM9C,SAASmD,QACrFtH,EAAM8B,OACJ9B,EAAMoL,YACN,KACAC,EAAAA,EAAAA,MACErL,EAAMkE,WAAWsE,KAAI,SAAC8C,GAAC,aAAY,QAAZ,EAAKA,EAAE7L,aAAK,aAAP,EAASA,KAAK,IAC1C,MAIN8C,EAASvC,GAELA,EAAM8B,QAAU9B,EAAM8B,OAAOwF,OAAS,GACxC4D,GAEJ,IAAC,wBAEe,WACd,IAAMlL,EAAQ,EAAK2B,MAAM3B,MACzB,EAAKuC,SAASvC,EAChB,IAAC,4BAEmB,SAAC0B,GACnB,IAAe6J,EAAgB,EAAK5J,MAA5B3B,MACF+E,GAAawG,EAAYxG,UAC/B,EAAK+B,SACH,CACE3C,SAAUY,EAAY,CAAC,CAAEnC,MAAO,KAAQ,EAAKqI,gBAC7C/G,WAAY,GACZa,UAAAA,IAEF,WACE,EAAKxC,SAAS,KACTgJ,EAAW,CACd7G,WAAY,GACZR,WAAY,EAAK+C,MAAM/C,WACvBC,SAAU,EAAK8C,MAAM9C,SACrBY,UAAAA,IAEJ,GAEJ,IAv1BE,EAAKyG,gBAAkB,EAAKA,gBAAgBC,KAAK,MACjD,EAAKC,sBAAwB,EAAKA,sBAAsBD,KAAK,MAC7D,EAAKE,uBAAyB,EAAKA,uBAAuBF,KAAK,MAC/D,EAAKG,gBAAkB,EAAKA,gBAAgBH,KAAK,MACjD,EAAKI,sBAAwB,EAAKA,sBAAsBJ,KAAK,MAC7D,EAAKK,kBAAoB,EAAKA,kBAAkBL,KAAK,MACrD,EAAKM,kBAAoB,EAAKA,kBAAkBN,KAAK,MAErD,EAAKO,aAAe,CAElB,QACA,UACA,UACA,UACA,QACA,SACA,mBACA,QACA,cACA,MACA,oBAGF,EAAKC,iBAAmB,CACtB,eACA,gBACA,yBACA,uBACA,sCACA,oCACA,gCAGF,EAAKC,kBAAoB,CACvB,OACA,OACA,WACA,IACA,QACA,CACJ,CAkpCC,SAhpCD,gCACA,SAAazM,GACX,OAAQA,IAAUA,EAAMA,QAAUA,EAAMA,MAAM6H,QAAU7H,EAAMA,QAAU4G,CAC1E,GAAC,mCAaD,SAAsB8F,GAAmD,MACjExB,EAAe/K,KAAK+B,MAAM3B,MAC1BqE,EAAUsG,EAAatG,QAC7BA,EAAQE,MAAqB,QAAhB,EAAG4H,EAAQ1M,aAAK,aAAb,EAAeA,MAC/BG,KAAK2C,SAAS,KAAKoI,EAAc,CAAAtG,QAAAA,IACnC,GACA,kCACA,WAWE,OAViBmE,EAAAA,EAAAA,KAAI5I,KAAKqM,kBAAkB,SAAClF,GAQ3C,MAPgE,CAC9DnE,MAAOmE,EACPtH,MAAO,CACLA,MAAOsH,EACPS,YAAY,GAIlB,GAEF,GAEA,oCACA,SAAuB2E,GAAmD,MAClExB,EAAe/K,KAAK+B,MAAM3B,MAC1BqE,EAAUsG,EAAatG,QAC7BA,EAAQI,OAAsB,QAAhB,EAAG0H,EAAQ1M,aAAK,aAAb,EAAeA,MAChCG,KAAK2C,SAAS,KAAKoI,EAAc,CAAAtG,QAAAA,IACnC,GACA,+BACA,WAWE,OAViBmE,EAAAA,EAAAA,KAAI5I,KAAKsM,mBAAmB,SAACnF,GAQ5C,MAPgE,CAC9DnE,MAAOmE,EACPtH,MAAO,CACLA,MAAOsH,EACPS,YAAY,GAIlB,GAEF,GAEA,mCACA,SAAsBT,EAAgDC,GACpE,IAAMP,EAAY7G,KAAKqH,MAAMR,UAAUS,MAAM,GAC7CT,EAAUO,GAASD,EACfnH,KAAKwM,aAAarF,EAAKtH,QACzBgH,EAAUwD,OAAOjD,EAAO,GAE1BpH,KAAKkH,SAAS,CAAEL,UAAAA,GAAa7G,KAAKyM,cACpC,GACA,gCACA,WAAqB,WAEbL,GAAeM,EAAAA,EAAAA,QADR1M,KACoBoM,cAAc,SAACvG,GAC9C,OAA0E,IAAnE,EAAKwB,MAAMR,UAAU+B,KAAI,SAAC8C,GAAC,aAAY,QAAZ,EAAKA,EAAE7L,aAAK,aAAP,EAASA,KAAK,IAAE8M,QAAQ9G,EACjE,IACMtB,GAAWqE,EAAAA,EAAAA,KAAIwD,GAAc,SAACjF,GAQlC,MAPgE,CAC9DnE,MAAOmE,EACPtH,MAAO,CACLA,MAAOsH,EACPS,YAAY,GAIlB,IASA,OAPArD,EAAS8E,QAAQ,CACfrG,MAAOyD,EACP5G,MAAO,CACLA,MAAO4G,KAIJlC,CACT,GAEA,2BACA,SAAcqI,GACZ,IAAM/F,GAAY6F,EAAAA,EAAAA,QAAO1M,KAAKqH,MAAMR,WAAW,SAACM,GAC9C,OAAOA,IAASyF,CAClB,IACA5M,KAAKkH,SAAS,CAAEL,UAAAA,GAClB,GACA,6BACA,SAAgBM,GACd,IAAMN,EAAY7G,KAAKqH,MAAMR,UAAUS,MAAM,GAE7C,IAAKtH,KAAKwM,aAAarF,EAAKtH,OAAQ,OAC9BuJ,EAA4D,CAC9DpG,MAAOmE,EAAKnE,MACZnD,MAAO,CACLA,MAAiB,QAAZ,EAAEsH,EAAKtH,aAAK,aAAV,EAAYA,MACnB+H,YAAY,IAGhBf,EAAUc,KAAKyB,EACjB,CACApJ,KAAKkH,SAAS,CAAEH,eAAgB,CAAC,EAAGF,UAAAA,GAAa7G,KAAKyM,cACxD,GAEA,6BACA,SAAgBG,GACd,IAAMtI,GAAaoI,EAAAA,EAAAA,QAAO1M,KAAKqH,MAAM/C,YAAY,SAAC6C,GAChD,OAAOA,IAASyF,CAClB,IACA5M,KAAK6M,qBAAqBvI,EAC5B,GACA,+BACA,SAAkB6C,GAChB,IAAQ/G,EAAUJ,KAAK+B,MAAf3B,MACFkE,EAAatE,KAAKqH,MAAM/C,WAAWgD,MAAM,GAE/C,IAAKtH,KAAKwM,aAAarF,EAAKtH,OAAQ,OAC9BuJ,EAA4D,CAC9DpG,MAAOmE,EAAKnE,MACZnD,MAAO,CACLA,MAAiB,QAAZ,EAAEsH,EAAKtH,aAAK,aAAV,EAAYA,MACnB+H,YAAaxH,EAAM+E,YAGvBb,EAAWqD,KAAKyB,EAClB,CACApJ,KAAK6M,qBAAqBvI,EAC5B,GAEA,gCAmUA,SAAmBC,EAA2D6C,GAC5E,IAAM0F,EAAMvI,EAAS+C,MAAM,EAAGF,GAE9B,OAAO2F,EAAAA,EAAAA,QACLD,GACA,SAAChM,EAAayL,GAAsD,MAClE,OAAKA,EAAQ1M,MAGW,QAApB,EAAC0M,EAAQ1M,MAAMA,aAAK,OAAnB,EAAqBmN,WAAW,WAG9BlM,EAFEA,EAASA,EAAS,KAAOyL,EAAQ1M,MAAMA,MAAQ0M,EAAQ1M,MAAMA,MAH7D,EAMX,GACA,GAEJ,GAEA,oCAOA,SACEyE,EACAC,GACc,eACd,EAA6BvE,KAAK+B,MAA1B5B,EAAU,EAAVA,WAAY6H,EAAI,EAAJA,KACd9H,EAAOF,KACPiI,EAAY,CAChBC,KAAMlI,KAAKmI,mBAAmB5D,EAAS+C,MAAM,GAAI/C,EAASmD,QAC1D7B,KAAM,cAER,OAAO1F,EACJmI,gBAAgBL,EAAWhJ,OAAOsJ,OAAgC,QAA1B,EAACP,SAAa,QAAT,EAAJA,EAAMQ,eAAO,WAAT,EAAJ,EAAeC,kBAAU,QAAI,CAAC,EAAG,CAAEtD,WAAW,KACvFtE,MAAK,SAACoM,GACL,IAAMC,EAAuB,CAAC,GAE9BhE,EAAAA,EAAAA,MAAK+D,GAAoB,SAACzM,GACxB0M,EAAgB1M,EAAUoJ,KAAKuD,UAAU3M,EAAUoJ,KAAK+C,QAAQ,KAAO,IAAMnM,EAAUQ,KACzF,IAEA,IAAMoM,GAAqBV,EAAAA,EAAAA,QAAOpI,GAAY,SAAC+I,GAAqD,MAC5FC,EAAenN,EAAW6I,YAAYuE,QAAoB,QAAb,EAACF,EAAOxN,aAAK,aAAZ,EAAcA,OAClE,YAAyCtB,IAAlC2O,EAAgBI,EACzB,IAEApN,EAAK4J,oBAAsBoD,EAC3B,EAAKL,qBAAqBO,EAC5B,IAAE,OACK,SAAC9D,GACNpJ,EAAKqJ,MAAQD,EAAIE,SAAW,+BAC5B,EAAKqD,qBAAqBvI,EAC5B,GACJ,GAEA,kCAOA,SACE9D,EACA8D,GACA,QACA,EAA6BtE,KAAK+B,MAA1B5B,EAAU,EAAVA,WAAY6H,EAAI,EAAJA,KACd9H,EAAOF,KACPiI,EAAY,CAChBC,KAAM1H,EAAU0H,KAChBY,MAAO5I,EAAKwJ,sBACZC,UAAWnJ,EAAUwC,MACrB6C,KAAM,WAER,OAAO1F,EACJmI,gBAAgBL,EAAWhJ,OAAOsJ,OAAgC,QAA1B,EAACP,SAAa,QAAT,EAAJA,EAAMQ,eAAO,WAAT,EAAJ,EAAeC,kBAAU,QAAI,CAAC,EAAG,CAAEtD,WAAW,KACvFtE,MAAK,WACJX,EAAK2M,qBAAqBvI,EAC5B,IAAE,OACK,SAACgF,GACNpJ,EAAKqJ,MAAQD,EAAIE,SAAW,+BAC5BtJ,EAAK2M,qBAAqB,GAC5B,GACJ,GAEA,iCAKA,WAAsB,aAChBW,EAAQ,GAWZ,OATAxN,KAAK6H,SAAS4F,SAAQ,SAAC/B,GACrB,IAAMgC,EAAQ,EAAK3L,MAAM3B,MAAM8B,OAAOiI,MAAM,KACxCuD,EAAMhG,QAAU,GACdgG,EAAM,KAAOhC,EAAE7C,OACjB2E,EAAQ9B,EAAE1K,MAIhB,IACOhB,KAAK6H,SAASH,OAAS,EAA0B,QAAzB,EAAG1H,KAAK6H,SAAS,GAAGhI,aAAK,aAAtB,EAAwBiJ,MAAQ0E,CACpE,GAEA,+BAKA,WAAoB,WAClB,EAA4BxN,KAAK+B,MAAzB3B,EAAK,EAALA,MAAOuC,EAAQ,EAARA,SACTuH,EAAkB9J,EAAM8B,OAAOiI,MAAM,KACrCC,EAAgBF,EAAgBxC,OAAS,EAAIwC,EAAgB,GAAGC,MAAM,MAAQ,GAEhF5F,EAA4D,GAC5DD,EAA8D,GAE9D8F,EAAc1C,OAAS,GAA+B,IAAzB0C,EAAc1C,QAAqC,KAArB0C,EAAc,IAE3EF,EAAgBG,OAAO,EAAG,IAE1BnB,EAAAA,EAAAA,MAAKkB,GAAe,SAACjD,EAAMmD,GACzB/F,EAASoD,KAAK,CACZ3E,MAAOmE,EACPtH,MAAO,CACLgG,KAAMsB,EAAKoD,MAAM,aAAe,gBAAahM,EAC7CsB,MAAOsH,EACPS,YAAY,IAGlB,KACAsB,EAAAA,EAAAA,MAAKgB,GAAiB,SAAU/C,EAAMC,GACvB,KAATD,GACF7C,EAAWqD,KAAK,CACd3E,MAAOmE,EACPtH,MAAO,CACLA,MAAOsH,EACPS,YAAY,IAIpB,IACA5H,KAAKwK,mBAAmBJ,EAAc1C,OAAS,EAAGnD,GAC/C1D,MAAK,SAAC4J,GACDA,EAAS/C,OAAS,GACpBnD,EAASoD,KAAK,CACZ3E,MAAO,iBACPnD,MAAO,CACLA,MAAO,qBAIf,IACCgB,MAAK,WACJ,EAAKsK,YAAY5G,EAAUD,EAAY,EAAK+C,MAAMR,UAAWzG,EAAM+E,WAAW,WAC5ExC,EAAS,KAAKvC,EAAO,CAAAA,WAAO7B,EAAWgN,UAAU,IACnD,GACF,MAEFhH,EAAWvE,KAAKqL,gBAChBrL,KAAKmL,YAAY5G,EAAUvE,KAAKqH,MAAM/C,WAAYtE,KAAKqH,MAAMR,UAAWzG,EAAM+E,WAAW,WACvF,EAAKxC,SAAS,KACTvC,EAAK,CACRA,WAAO7B,EACPgN,UAAU,EACVjH,WAAY,EAAK+C,MAAM/C,WACvBC,SAAU,EAAK8C,MAAM9C,WAEzB,IAEJ,GAEA,oBA4KA,WAAS,WACP,EAAoDvE,KAAK+B,MAA1C4L,EAAU,EAAjBvN,MAAmBuC,EAAQ,EAARA,SAAU2I,EAAU,EAAVA,WAC/BP,GAAeC,EAAAA,EAAAA,UAAS2C,EAAYtJ,GAExCW,EAWE+F,EAXF/F,aACAD,EAUEgG,EAVFhG,YACA3E,EASE2K,EATF3K,MACAmL,EAQER,EARFQ,SACArG,EAOE6F,EAPF7F,cACAD,EAME8F,EANF9F,eACAH,EAKEiG,EALFjG,WACAK,EAIE4F,EAJF5F,UACAV,EAGEsG,EAHFtG,QACAmJ,EAEE7C,EAFF6C,QACArN,EACEwK,EADFxK,MAGF,OACE,oCACGP,KAAK+B,MAAM5B,WAAW0N,eACrB,kBAAC,EAAA9K,YAAW,CAACC,MAAM,eAAeC,WAAYsD,GAC5C,kBAAC,EAAArD,aAAY,CAACrD,MAAOsF,EAAWxC,SAAU3C,KAAK8N,uBAIhDvC,GACD,kBAAC,EAAAwC,eAAc,KACb,kBAAC,EAAAhL,YAAW,CAACC,MAAM,YAAYC,WAAYsD,EAAayH,MAAM,GAC5D,kBAAC,EAAAC,MAAK,CACJC,OAAQlO,KAAKyM,cACb5M,MAAOO,EACPuC,SAAU,SAACb,GAAoC,OAC7Ca,EAAS,KAAKoI,EAAc,CAAA3K,MAAO0B,EAAMI,OAAOrC,QAAQ,EAE1D0D,YAAY,iBAGhB,kBAAC6B,EAAuB,CAACC,OAAO,EAAM1C,SAAU,SAAC9C,GAAc,OAAK,EAAKsO,mBAAmB,MAI9F5C,GACA,oCACE,yBAAKzI,UAAU,kBACb,kBAACqB,EAAmB,CAClBnB,MAAOmC,EAAY,YAAc,cACjCvB,QAASuB,EAAY,oBAAsB,sBAE1CnF,KAAKqH,MAAM9C,SAASqE,KAAI,SAAC2D,EAAmDnF,GAC3E,OACE,kBAAC,EAAAgH,aAAY,CACXrP,IAAK,WAAaqI,EAClBiH,UAAW,kBAAC3H,EAAoB,CAAC7G,MAAO0M,EAAQ1M,MAAOmD,MAAOuJ,EAAQvJ,QACtEL,SAAU,SAACwE,GAAI,OAAK,EAAKyE,gBAAgBzE,EAAMC,EAAM,EACrDkH,YAAa,SAAClO,GACZ,OAAO,EAAKoK,mBAAmBpD,EACjC,EACAmH,kBAAgB,EAChBC,cAx8BO,KA28Bb,IAAE,MACF,kBAACxK,EAAkB,QACjBmB,GACA,kBAACC,EAAuB,CACtBC,OAAO,EACP1C,SAAU,SAAC9C,GACT8C,EAAS,KAAKoI,EAAc,CAAA3K,MAAO2K,EAAa7I,OAAQqJ,SAAU1L,IACpE,MAMR,kBAACoE,EAAgB,CAACjB,MAAOmC,EAAY,YAAc,cAChDnF,KAAKqH,MAAM/C,WAAWsE,KAAI,SAACpI,EAAqD4G,GAC/E,OAAIjC,EAEA,kBAAC,EAAAiJ,aAAY,CACXrP,IAAK,cAAgBqI,EACrBiH,UAAW,kBAAC3H,EAAoB,CAAC7G,MAAOW,EAAUX,MAAOmD,MAAOxC,EAAUwC,QAC1EyL,SAAmC,IAAzB,EAAK5G,SAASH,OACxB/E,SAAU,SAACwE,GAAI,OAAK,EAAKhE,gBAAgBgE,EAAMC,EAAM,EACrDkH,YAAa,EAAKI,uBAClBC,uBAAqB,EACrBJ,kBAAgB,EAChBC,cAAehI,IAKnB,kBAAC,EAAAoI,QAAO,CACN7P,IAAK,cAAgBqI,EACrBiH,UAAW,kBAAC3H,EAAoB,CAAC7G,MAAOW,EAAUX,MAAOmD,MAAOxC,EAAUwC,QAC1EyL,SAAU,EAAKpH,MAAM9C,SAASmD,QAAU,EACxC/E,SAAU,SAACwE,GAAI,OAAK,EAAKgF,kBAAkBhF,EAAMC,EAAM,EACvD1F,QAAS,EAAKmN,yBACdN,kBAAgB,EAChBC,cAAehI,GAGrB,IAECrB,GACC,kBAAC,EAAAiJ,aAAY,CACXC,UACE,kBAAC3H,EAAoB,CACnB7G,MAAOG,KAAKqH,MAAMP,iBAAiBjH,MACnCmD,MAAOhD,KAAKqH,MAAMP,iBAAiB9D,QAGvCyL,SAAmC,IAAzBzO,KAAK6H,SAASH,OACxB/E,SAAU3C,KAAKkM,kBACfoC,YAAatO,KAAK0O,uBAClBC,uBAAqB,EACrBJ,kBAAgB,EAChBC,cAAehI,KAGjBrB,GACA,kBAAC,EAAAyJ,QAAO,CACNP,UACE,kBAAC3H,EAAoB,CACnB7G,MAAOG,KAAKqH,MAAMP,iBAAiBjH,MACnCmD,MAAOhD,KAAKqH,MAAMP,iBAAiB9D,QAGvCyL,SAAUzO,KAAKqH,MAAM9C,SAASmD,QAAU,EACxC/E,SAAU3C,KAAKkM,kBACfxK,QAAS1B,KAAK6O,yBACdN,kBAAgB,EAChBC,cAAehI,MAOzB,kBAAC,EAAAuH,eAAc,KACb,kBAAC,EAAAhL,YAAW,CAACC,MAAM,iBAAiBC,WAAYsD,GAC9C,kBAAC,EAAArD,aAAY,CACXrD,MAAOmF,EAAaR,OACpB7B,SAAU,kBACR,EAAKA,SAAS,KACToI,EAAY,CACf/F,aAAc,KAAKA,EAAc,CAAAR,QAASQ,EAAaR,WACvD,OAMRQ,EAAaR,QACb,oCACE,kBAAC,EAAAzB,YAAW,CACVC,MAAM,cACNC,WAAYsD,EACZ3C,QACE,6IAGF,kBAAC,EAAAqK,MAAK,CACJC,OAAQ5C,EACRzL,MAAOiF,EACPnC,SAAU,SAACb,GAAoC,OAC7Ca,EAAS,KAAKoI,EAAc,CAAAjG,WAAYhD,EAAMI,OAAOrC,QAAQ,EAE/D0D,YAAY,WAIhB,kBAAC,EAAAwK,eAAc,KACb,kBAAC,EAAAhL,YAAW,CACVC,MAAM,sBACNC,WAAYsD,EACZ3C,QAAS,mGAET,kBAAC,EAAAqK,MAAK,CACJC,OAAQ5C,EACRzL,MAAOoF,EAAe6J,UACtBnM,SAAU,SAACb,GAAoC,OAC7Ca,EAAS,KACJoI,EAAY,CACf9F,eAAgB,KAAKA,EAAgB,CAAA6J,UAAWC,SAASjN,EAAMI,OAAOrC,MAAO,QAC7E,EAEJgG,KAAK,SACLtC,YAAY,UAGhB,kBAAC,EAAAR,YAAW,CAACC,MAAM,kBAAkBC,WAAYsD,GAC/C,kBAAC,EAAArD,aAAY,CACXrD,MAAOoF,EAAeT,OACtB7B,SAAU,kBACR,EAAKA,SAAS,KACToI,EAAY,CACf9F,eAAgB,KAAKA,EAAgB,CAAAT,QAASS,EAAeT,WAC7D,KAIR,kBAAC,EAAAzB,YAAW,CAACC,MAAM,iBAAiBC,WAAYsD,GAC9C,kBAAC,EAAArD,aAAY,CACXrD,MAAOqF,EAAcV,OACrB7B,SAAU,kBACR,EAAKA,SAAS,KAAKoI,EAAc,CAAA7F,cAAe,KAAKA,EAAe,CAAAV,QAASU,EAAcV,WAAW,MAM9G,kBAAC,EAAAuJ,eAAc,KACb,kBAAC,EAAAhL,YAAW,CACVC,MAAM,qBACNC,WAAYsD,EACZ3C,QAAS,2FAET,kBAAC,EAAAqK,MAAK,CACJC,OAAQ5C,EACRzL,MAAOkF,EAAYH,SACnBjC,SAAU,SAACb,GAAoC,OAC7Ca,EAAS,KAAKoI,EAAc,CAAAhG,YAAa,KAAKA,EAAa,CAAAH,SAAU9C,EAAMI,OAAOrC,UAAU,EAE9F0D,YAAY,QAGhB,kBAAC,EAAAR,YAAW,CAACC,MAAM,cAAcC,WAAYsD,GAC3C,kBAAC,EAAArD,aAAY,CACXrD,MAAOkF,EAAYP,OACnB7B,SAAU,kBACR,EAAKA,SAAS,KAAKoI,EAAc,CAAAhG,YAAa,KAAKA,EAAa,CAAAP,QAASO,EAAYP,WAAW,KAItG,kBAAC,EAAAzB,YAAW,CACVC,MAAM,mBACNC,WAAYsD,EACZ3C,QAAS,uCAET,kBAAC,EAAAgL,QAAO,CACNP,UAAW,kBAAC3H,EAAoB,CAAC7G,MAAO,CAAEA,MAAO4E,EAAQI,QAAU7B,MAAOyB,EAAQI,SAClFlC,SAAU3C,KAAK+L,uBACfrK,QAAS1B,KAAKgP,oBACdT,kBAAgB,MAKtB,kBAAC,EAAAR,eAAc,KACb,kBAAC,EAAAhL,YAAW,CACVC,MAAM,iBACNC,WAAYsD,EACZ3C,QAAS,+CAET,kBAAC,EAAAqK,MAAK,CACJC,OAAQ5C,EACRzL,MAAO4E,EAAQG,SACfjC,SAAU,SAACb,GAAoC,OAC7Ca,EAAS,KAAKoI,EAAc,CAAAtG,QAAS,KAAKA,EAAS,CAAAG,SAAU9C,EAAMI,OAAOrC,UAAU,EAEtF0D,YAAY,SAGhB,kBAAC,EAAAR,YAAW,CACVC,MAAM,QACNC,WAAYsD,EACZ3C,QACE,wGAGF,kBAAC,EAAAgL,QAAO,CACNP,UAAW,kBAAC3H,EAAoB,CAAC7G,MAAO,CAAEA,MAAO4E,EAAQE,OAAS3B,MAAOyB,EAAQE,QACjFhC,SAAU3C,KAAK8L,sBACfpK,QAAS1B,KAAKiP,uBACdV,kBAAgB,KAGpB,kBAAC,EAAAxL,YAAW,CAACC,MAAM,YAAYC,WAAYsD,EAAa3C,QAAS,uCAC/D,kBAAC,EAAAmK,eAAc,KACZ/N,KAAKqH,MAAMR,UAAU+B,KAAI,SAAC8C,EAA6CtE,GACtE,OACE,kBAAC,EAAAwH,QAAO,CACN7P,IAAK,aAAeqI,EACpBiH,UAAW,kBAAC3H,EAAoB,CAAC7G,MAAO6L,EAAE7L,MAAOmD,MAAO0I,EAAE1I,QAC1DL,SAAU,SAACwE,GAAI,OAAK,EAAK8E,sBAAsB9E,EAAMC,EAAM,EAC3D1F,QAAS,EAAKwN,qBACdX,kBAAgB,GAGtB,IACA,kBAAC,EAAAK,QAAO,CACNP,UACE,kBAAC3H,EAAoB,CACnB7G,MAAOG,KAAKqH,MAAMN,eAAelH,MACjCmD,MAAOhD,KAAKqH,MAAMN,eAAe/D,QAGrCL,SAAU3C,KAAKgM,gBACftK,QAAS1B,KAAKkP,qBACdX,kBAAgB,QAQ5B,kBAAC,EAAAR,eAAc,KACb,kBAAC,EAAAhL,YAAW,CACVC,MAAM,eACNC,WAAYsD,EACZ3C,QAAS,yFAET,kBAAC,EAAAqK,MAAK,CACJC,OAAQ5C,EACRzL,MAAO+N,EACPjL,SAAU,SAACb,GAAoC,OAC7Ca,EAAS,KAAKoI,EAAc,CAAA6C,QAAS9L,EAAMI,OAAOrC,QAAQ,EAE5D0D,YAAY,aAGhB,kBAAC,EAAAR,YAAW,CAACC,MAAM,uBAAuBC,WAAYsD,GACpD,kBAAC,EAAArD,aAAY,CACXrD,MAAOU,EAAMiE,OACb7B,SAAU,WACR,EAAKA,SAAS,KAAKoI,EAAc,CAAAxK,MAAO,KAAKA,EAAO,CAAAiE,QAASjE,EAAMiE,WACrE,KAGJ,kBAAC,EAAAzB,YAAW,CAACC,MAAM,SAASC,WAAYsD,IACtC,kBAAC,EAAA0H,MAAK,CACJC,OAAQ5C,EACRzL,MAAOU,EAAM4O,OACbxM,SAAU,SAACb,GAAoC,OAC7Ca,EAAS,KAAKoI,EAAc,CAAAxK,MAAO,KAAKA,EAAO,CAAA4O,OAAQrN,EAAMI,OAAOrC,UAAU,EAEhF0D,YAAY,UAGhB,kBAAC,EAAAR,YAAW,CAACC,MAAM,UAAUC,WAAYsD,IACvC,kBAAC,EAAA0H,MAAK,CACJC,OAAQ5C,EACRzL,MAAOU,EAAMgN,QACb5K,SAAU,SAACb,GAAoC,OAC7Ca,EAAS,KAAKoI,EAAc,CAAAxK,MAAO,KAAKA,EAAO,CAAAgN,QAASzL,EAAMI,OAAOrC,UAAU,EAEjF0D,YAAY,SAMxB,oFAAC,EA9sC6B,CAASG,EAAAA,+iCCClC,SAAS0L,GAA6BC,GAAmC,MAMlD,EALpBC,EAAkB,GAClBC,EAA4B,GAGG,KAAtBF,EAAWG,YACA,IAA1B,IAAK,EAAL,qBAA4B,KAAjBC,EAAK,QACZF,EAAO5H,KAAK8H,EAAM,IAClBH,EAAM3H,KAAK8H,EAAM,GACrB,CAAC,+BAED,IAAMC,EAAS,CACX,CACI9O,KAAM+O,EAAAA,4BACN9J,KAAM+J,EAAAA,UAAAA,KACNC,OAAQ,CAAC,EACTN,OAAQ,IAAIO,EAAAA,YAAoBR,IAEpC,CACI1O,KAAuB,QAAnB,EAAEyO,EAAWnN,cAAM,QAAI6N,EAAAA,6BAC3BlK,KAAM+J,EAAAA,UAAAA,OACNC,OAAQ,CACJG,KAAMX,EAAWW,MAErBT,OAAQ,IAAIO,EAAAA,YAA6BP,GACzCU,OAAQZ,EAAWa,OAQ3B,OAJIb,EAAWpJ,QACVyJ,EAAO,GAAGG,OAAuBM,kBAAoBd,EAAWpJ,OAG9D,CACHrF,KAAM,GACNwP,MAAOf,EAAWe,MAClBC,KAAMhB,EAAWgB,KACjBX,OAAAA,EACAhI,OAAQ6H,EAAO7H,OAEvB,CAgDO,SAAS4I,GAAYC,GACxB,MAAyB,iBAAXA,IAAwBC,OAAOC,MAAMF,IAAWC,OAAOE,SAASH,EAClF,CAQO,SAASI,GAAYzI,GAAsB,MAC1C0I,EAAY1I,EAAKiC,MAAM,KAC3B,OAAyB,IAArByG,EAAUlJ,QAIc,KAD5BkJ,EAAYA,EAAU,GAAGzG,MAAM,OACdzC,OAHN,GAGyC,QAAlB,EAAGkJ,EAAUC,aAAK,QAAI,EAC5D,CASO,SAASC,GAAQC,EAAyC7I,GAAsB,MAC7E8I,EAAWL,GAAYzI,GAC7B,GAAgC,IAA5B6I,EAAiBrJ,OACjB,MAAO,GAEX,IAAMuJ,EAAsE,QAA1D,EAAGF,EAAiBG,MAAK,SAAC9F,GAAC,OAAKlD,EAAKyE,QAAQvB,EAAElD,OAAS,CAAC,WAAC,aAAvD,EAAyDiB,SAC9E,OAAO8H,EAAeA,EAAe,IAAMD,EAAWA,CAC1D,CAUO,SAASG,GAAY5D,EAAkBrM,EAAoBU,GAE9D,OADgB2L,EAAU3L,EAAI2L,QAAQ,QAAS,IAAF,OAAMrM,EAAMkQ,KAAI,MAAOxP,CAExE,u/CCnLA,upPAgCO,IAAMyP,GAAkB,aAhC/B,sRAgC+B,UAhC/B,QA6NE,EA7L6B,QAqB7B,WAAYC,GAA0E,QAyB/B,OA9EzD,4FAqDwF,SAC5D,MAAxB,cAAMA,IAAkB,oRAXhB,GAAK,kHAMgB,IAAIC,KAAK,yBAMtC,EAAKC,UAAYF,EAAiBE,UAClC,EAAKC,gBAAkBH,EAAiBG,gBACxC,EAAK7P,IAAM0P,EAAiB1P,IAC5B,EAAKhB,KAAO0Q,EAAiB1Q,KAC7B,EAAKoI,aAAc0I,EAAAA,GAAAA,kBACnB,EAAKC,YAAaC,EAAAA,GAAAA,iBAElB,EAAKC,YAA2C,QAAhC,EAAGP,EAAiB3P,SAASC,WAAG,aAA7B,EAA+BkQ,WAClD,EAAKC,QAAU,iBAAiBC,KAAK,EAAKpQ,MAA6C,UAArC0P,EAAiB3P,SAASsQ,OAE5E,EAAKhQ,SAAW,CAAErB,MAAO0Q,EAAiB3P,UAAY,CAAC,GAAGM,SAAUf,WAAO3C,GAC3E,EAAKoC,SAAW,CAAEC,MAAO0Q,EAAiB3P,UAAY,CAAC,GAAGhB,SAAUO,WAAO3C,GAC3E,EAAK4D,WAAa,CAAEvB,MAAO0Q,EAAiB3P,UAAY,CAAC,GAAGQ,WAAYjB,WAAO3C,GAC/E,EAAKsP,cAAgByD,EAAiB3P,SAASU,UAAW,EAC1D,EAAK6P,gBAAkBZ,EAAiB3P,SAASW,YAAa,EAG9D8F,QAAQ+J,IAAI,CACV,EAAKC,cAAc,EAAKnQ,SAASrB,MAAMC,MAAK,SAACC,GAAmB,OAAM,EAAKmB,SAASf,MAAQJ,EAAOE,KAAK,IACxG,EAAKN,eAAe,EAAKC,SAASC,MAAMC,MAAK,SAACC,GAAmB,OAAM,EAAKH,SAASO,MAAQJ,EAAOE,KAAK,IACzG,EAAKqR,YAAY,EAAK1R,SAASC,KAAO,EAAKD,SAASC,KAAO,KAAO,EAAKuB,WAAWvB,UAAOrC,GAAWsC,MAClG,SAACC,GAAmB,OAAM,EAAKqB,WAAWjB,MAAQJ,EAAOE,KAAK,MAE/DH,MAAK,WAA2C,IAAE,CACvD,CAmsCC,OAlxCH,EAiFE,EAjFF,EAiFE,qCAUA,SACEyR,EACAC,EACAC,EACAC,GAEIH,EAAkB/R,OAAS+R,EAAkB/R,MAAMiE,SACrDgO,EAAWpB,KAAOoB,EAAWpB,KAAK7D,QAChC,IAAImF,OAAOJ,EAAkB/R,MAAM4O,QACnCmD,EAAkB/R,MAAMgN,UAI5B,IAAI9D,EAAgB,GASpB,OARIgJ,IACFvJ,EAAAA,EAAAA,MAAKuJ,GAAoB,SAACE,GACxB,IAAMC,EAAiBD,EAAcE,MAAMA,MACvCF,EAAcE,MAAMA,MAAMzB,MAAQuB,EAAcE,MAAMA,MAAMA,OAASF,EAAcE,MAAMA,MACzF,KACJpJ,GAAiB,SAAWkJ,EAAcvB,KAAO,KAAOwB,CAC1D,IAEK,CACL3S,WAAYqS,EACZrM,OAAQsM,EAAU,OAASD,EAAkB7R,YAAc,SAAW,IAAM6R,EAAkB1R,KAC9FkS,KAAM,IAAIC,KAAKR,EAAUC,EAAWQ,QAAUR,EAAWS,WAAWC,UACpErK,KACE2J,EAAWpB,KAAO3H,EAAgB,gBAAkB+I,EAAWS,UAAY,cAAgBT,EAAWQ,QAE5G,GAEA,kCAQA,SAA6BtR,GAA0C,WAwFrE,OAvFAA,EAAQyR,SAAUzG,EAAAA,EAAAA,QAAOhL,EAAQyR,SAAS,SAACjR,GACzC,SAAKA,IAAWA,EAAOA,QAAYA,EAAOkR,MAGlClR,EAAOA,OAAO8K,WAAW,aACnC,IAEAtL,EAAQyR,SAAUvK,EAAAA,EAAAA,KAAIlH,EAAQyR,SAAS,SAACjR,GACtC,GAAMA,EAAOqJ,UAAcrJ,EAAOA,OAAQ,CACxC,MD/HD,SAAuBmR,GAC1B,IAAMnJ,EAAkBmJ,EAAGlJ,MAAM,KAC3BC,EAAgBF,EAAgB,GAAGC,MAAM,MAG/CD,EAAgBG,OAAO,EAAG,GAE1B,IAAI/F,EAAoB,GACxB,GAAI8F,EAAc1C,OAAS,GAA+B,IAAzB0C,EAAc1C,QAAqC,KAArB0C,EAAc,GAAY,CACrF,IAAMoB,EAAsBpB,EAAcqB,KAAK,MAa/C,OAZAvC,EAAAA,EAAAA,MAAKgB,GAAiB,SAAU/C,EAAMC,GACrB,KAATD,GACA7C,EAAWqD,KAAK,CACZ3E,MAAOmE,EACPtH,MAAO,CACHA,MAAOsH,EACPS,YAAY,IAI5B,IAEO,CAAEtD,WAAAA,EAAYkH,YAAAA,EACzB,CAEA,MAAO,CAAElH,WAAAA,EAAYkH,YAAa,KACtC,CCqG4C8H,CAAc,EAAKtK,YAAYuE,QAAQrL,EAAOA,OAAQR,EAAQ+G,aAA1FnE,EAAU,EAAVA,WAAYkH,EAAW,EAAXA,YACpBtJ,EAAOoC,WAAaA,EACpBpC,EAAOsJ,YAAcA,CACvB,CACA,IAAM+H,EAAK,EACLC,EAAM,CACVtR,OAAQ,EAAK8G,YAAYuE,QAAQrL,EAAOsJ,YAAa9J,EAAQ+G,YAC7D+C,YAAa,EAAKxC,YAAYuE,QAAQrL,EAAOsJ,YAAa9J,EAAQ+G,YAClEsI,iBAAkB,CAChB,CACE7I,KAAM,EAAKc,YAAYuE,QAAQrL,EAAOsJ,YAAa9J,EAAQ+G,YAC3DU,SAAU,KAGd7E,YAAYsE,EAAAA,EAAAA,KAAI1G,EAAOoC,YAAY,SAACmP,GAAG,aACrC,EAAKzK,YAAYuE,SAAiB,QAAT,EAAAkG,EAAI5T,aAAK,aAAT,EAAWA,QAAS4T,EAAK/R,EAAQ+G,WAAW,IAEvElE,UAAUqE,EAAAA,EAAAA,KAAI1G,EAAOqC,UAAU,SAACkP,GAAG,aAAK,EAAKzK,YAAYuE,QAAiB,QAAV,EAACkG,EAAI5T,aAAK,aAAT,EAAWA,MAAO6B,EAAQ+G,WAAW,IACtGmF,QAAS1L,EAAO0L,QAChBwC,MAAOlO,EAAOkO,MACdgD,KAAMlR,EAAOkR,KACbrO,YAAa7C,EAAO6C,aAAe,CAAEP,QAAQ,GAC7CQ,aAAc9C,EAAO8C,cAAgB,CAAER,QAAQ,GAC/CS,eAAgB/C,EAAO+C,gBAAkB,CAAET,QAAQ,GACnDU,cAAehD,EAAOgD,eAAiB,CAAEV,QAAQ,GACjDtD,MAAOgB,EAAOhB,MACdwS,OAAQxR,EAAOwR,QAAU,GACzBnT,MAAO2B,EAAO3B,OAAS,CAAEiE,QAAQ,GACjCM,WAAY5C,EAAO4C,YAAc,GACjCL,QAASvC,EAAOuC,SAAW,CAAEC,MAAO,IACpCiP,UAAWjS,EAAQkS,MAAMC,KACzBtB,QAAS7Q,EAAQkS,MAAME,GACvB3O,UAAWjD,EAAOiD,UAClBsD,WAAY/G,EAAQ+G,YAGlB+K,EAAI1O,aACN0O,EAAI1O,WAAa,EAAKkE,YAAYuE,QAAQiG,EAAI1O,WAAYpD,EAAQ+G,kBAG1ClK,IAAtBiV,EAAI/O,QAAQC,QACd8O,EAAI/O,QAAQC,OAAQgI,EAAAA,EAAAA,QAAO8G,EAAI/O,QAAQC,OAAO,SAACyC,GAC7C,OAAOA,SAAgD,KAATA,CAChD,KAIF,IAAM4M,GAAWC,EAAAA,EAAAA,MAAKtS,EAAQ+G,YA4B9B,OA3BA,EAAKO,YAAYC,eAAewE,SAAQ,SAACwG,GACvC,GAAIV,EAAGW,cAAcD,EAAEE,UAAYJ,EAASpH,QAAQsH,EAAErT,MAAQ,EAAG,CAE/D,IAAMmI,EAAYkL,EAAEvS,QAAQgL,QAAO,SAAC1N,GAAM,OAAMA,EAAEoV,QAAQ,IAE1DZ,EAAIlP,WAAakP,EAAIlP,WAAWsE,KAAI,SAACyL,GAAY,OAC/CtL,EAAUH,KAAI,SAAC0L,GAAO,OAClBL,EAAEM,SAAWF,EAAK9G,QAAQ0G,EAAEM,SAAUD,EAAGzU,OAASwU,EAAK9G,QAAQ,sBAAuB+G,EAAGzU,MAAM,GAClG,IAEH2T,EAAIlP,YAAakQ,EAAAA,EAAAA,OAAKC,EAAAA,EAAAA,SAAQjB,EAAIlP,aAElCkP,EAAIzC,iBAAmBwC,EAAGmB,eAAelB,EAAIzC,iBAAkBhI,EAAWkL,EAAEM,SAC9E,MAAO,GAAII,MAAMC,QAAQX,EAAEE,QAAQtL,OAASkL,EAASpH,QAAQsH,EAAErT,MAAQ,EAAG,CAExE,IAAMmI,EAAYkL,EAAEvS,QAAQgL,QAAO,SAAC1N,GAAM,OAAKA,EAAEoV,QAAQ,IAEnDhU,EAAQ6T,EAAEE,QAAQtU,MAAM4L,KAAK,KACnC+H,EAAIlP,WAAakP,EAAIlP,WAAWsE,KAAI,SAACyL,GAAY,OAC/CtL,EAAUH,KAAI,SAAC0L,GAAO,OAAKD,EAAK9G,QAAQ,IAAD,OAAKnN,EAAK,KAAKkU,EAAGzU,MAAM,GAAC,IAElE2T,EAAIlP,YAAakQ,EAAAA,EAAAA,OAAKC,EAAAA,EAAAA,SAAQjB,EAAIlP,aAElCkP,EAAIzC,iBAAmBwC,EAAGmB,eAAelB,EAAIzC,iBAAkBhI,EAAW,IAAF,OAAM3I,EAAK,KACrF,CACF,IAEOoT,CACT,IAEO9R,CACT,GAEA,oBA7NF,EA6NE,WASA,WAAYA,GAAwC,0EAEF,GAD1C6R,EAAKvT,QACLI,EAAQJ,KAAK6U,qBAAqBnT,IAE9ByR,QAAQzL,QAAU,GAAC,yCACpBU,QAAQC,QAAQ,CAAEL,KAAM,MAAK,gCAE7BI,QAAQ+J,IAAIoB,EAAGuB,UAAU1U,IAAQS,MAAK,SAACkU,GAC5C,IAAIC,EAAgC,GAMpC,OALA9L,EAAAA,EAAAA,MAAK6L,GAAiB,SAAC1B,IACrBnK,EAAAA,EAAAA,MAAKmK,GAAI,SAAClM,GAAI,OAAK6N,EAAUrN,KAAKR,EAAK,GACzC,IAGyB,KAFzB6N,EAAYA,EAAUtI,QAAO,SAACuH,GAAC,OAAKA,EAAEzE,WAAW9H,OAAS,CAAC,KAE7CA,OACL,CAAEM,KAAM,IAEmB,CAClCA,KAAMgN,EACHC,MAAK,SAACpW,EAAGqW,GACR,QAASrW,EAAEqD,OAASgT,EAAEhT,WAAarD,EAAEqD,SAAWgT,EAAEhT,QAAU,CAC9D,IACC0G,KAAI,SAAChK,GAAC,OAAKwQ,GAA6BxQ,EAAE,IAGjD,KAAE,+CAlCN,EA7NF,gLAiQG,8CAED,4BAQA,WACE,OAAOoB,KAAK2R,WACTwD,kBAAkB,CACjBvT,IAAK5B,KAAK4B,IAAM,IAChBwT,OAAQ,QAETvU,MAAK,SAACwU,GACL,GAAwB,MAApBA,EAASC,OACX,MAAO,CAAEA,OAAQ,UAAW9L,QAAS,yBAA0BvD,MAAO,WAExE,MAAM,IAAIsP,MAAM,SAClB,GACJ,GAEA,6BASA,SAAgB7T,GAA0C,WACxD,IAAK1B,KAAKmC,WAAWjB,MACnB,OAAOkH,QAAQC,QAAQ,IAGzB,IAAMmN,EAAe9T,EAAQzB,WAAWG,MAAMoV,aAC1CxV,KAAKgJ,YAAYuE,QAAQ7L,EAAQzB,WAAWG,MAAMoV,aAAc9T,EAAQ+G,WAAY,QACpF,KACEgN,EAAa/T,EAAQzB,WAAWG,MAAMqV,WACxCzV,KAAKgJ,YAAYuE,QAAQ7L,EAAQzB,WAAWG,MAAMqV,WAAY/T,EAAQ+G,WAAY,QAClF,KACEiN,EAAehU,EAAQzB,WAAW0V,SAAWjU,EAAQzB,WAAW0V,SAASvE,KAAO,KAChFkB,EAAoB,CACxB1R,KAAMc,EAAQzB,WAAWW,KACzBT,WAAYuB,EAAQzB,WAAWE,WAC/BqE,OAAQ9C,EAAQzB,WAAWuE,OAC3BoR,UAAWlU,EAAQzB,WAAW2V,UAC9BnV,YAAaiB,EAAQzB,WAAWQ,YAChCF,MAAOmB,EAAQzB,WAAWM,MAC1BC,UAAWkB,EAAQzB,WAAWO,UAC9BgV,aAAcA,EACdE,aAAcA,EACdD,WAAYA,GAGR/I,EAAS,GAUf,GATM4F,EAAkBkD,cACtB9I,EAAO/E,KAAK,gBAAkB2K,EAAkBkD,cAE5ClD,EAAkBmD,YACtB/I,EAAO/E,KAAK,cAAgB2K,EAAkBmD,YAE1CnD,EAAkBoD,cACtBhJ,EAAO/E,KAAK,gBAAkB2K,EAAkBoD,eAE7ChJ,EAAOhF,OACV,OAAOU,QAAQC,QAAQ,IAKzB,GAHAqE,EAAO/E,KAAK,aAAejG,EAAQkS,MAAMC,KAAKgC,UAC9CnJ,EAAO/E,KAAK,WAAajG,EAAQkS,MAAME,GAAG+B,UAEtCvD,EAAkB9R,WAAa8R,EAAkB9R,UAAUgE,OAAQ,CACrE,IAAIsR,EACF9V,KAAK6R,YAAc,8EACfS,EAAkB9R,UAAUI,OAChCkV,EACE9V,KAAK6R,YACL,oCACAS,EAAkB9R,UAAUI,KAC5B,0DAEJ,IAAMR,EAAa,CAAC,EAapB,OAZAA,EAAM,GAAO,CACX2V,OAAQ,MACRC,SAAUhW,KAAK6R,YAAc,mBAAqB7R,KAAKmC,WAAWjB,MAAQ,gBAAkBwL,EAAOjB,KAAK,MAE1GrL,EAAM,GAAO,CACX2V,OAAQ,MACRE,gBAAiB,CACfD,SAAUF,GAEZI,WAAY,CAAC,8BACbC,UAAW,CAAC,MAEPnW,KAAKoW,UAAUhW,GAAOS,MAAK,SAACC,GACjC,IAAMkH,EAAOlH,EAAOkH,KAAK,GAAKqO,QACxBC,EAAYxV,EAAOkH,KAAK,GAAKqO,QAE7BE,GAAc3N,EAAAA,EAAAA,KAAIZ,EAAKwO,OAAO,SAACrP,EAAWC,GAC9C,OAAOqP,EAAAA,EAAAA,OAAM,EAAKC,uBAAXD,CACLnE,GACA,EACAnL,EACAmP,EAAUE,MAAMpP,GAAOiP,QAAQG,MAEnC,IAEA,GAAI9U,EAAQzB,WAAWQ,YAAa,CAClC,IAAMkW,GAAO/N,EAAAA,EAAAA,KAAIZ,EAAKwO,OAAO,SAACrP,EAAWC,GACvC,OAAOqP,EAAAA,EAAAA,OAAM,EAAKC,uBAAXD,CACLnE,GACA,EACAnL,EACAmP,EAAUE,MAAMpP,GAAOiP,QAAQG,MAEnC,KACAtN,EAAAA,EAAAA,MAAKyN,GAAM,SAACC,GACVL,EAAY5O,KAAKiP,EACnB,GACF,CAEA,OAAOL,CACT,GACF,CACE,OAAOvW,KAAK6W,QAAQ,mBAAqB7W,KAAKmC,WAAWjB,MAAQ,gBAAkBwL,EAAOjB,KAAK,MAAM5K,MACnG,SAACC,GACC,IAAMyV,GAAc3N,EAAAA,EAAAA,KAAI9H,EAAOkH,KAAKwO,OAAOC,EAAAA,EAAAA,OAAM,EAAKC,uBAAXD,CAAmCnE,GAAmB,IACjG,GAAI5Q,EAAQzB,WAAWQ,YAAa,CAClC,IAAMkW,GAAO/N,EAAAA,EAAAA,KAAI9H,EAAOkH,KAAKwO,OAAOC,EAAAA,EAAAA,OAAM,EAAKC,uBAAXD,CAAmCnE,GAAmB,KAC1FpJ,EAAAA,EAAAA,MAAKyN,GAAM,SAACC,GACVL,EAAY5O,KAAKiP,EACnB,GACF,CACA,OAAOL,CACT,GAGN,GAEA,kCAQA,SAA6BlB,GAC3B,OAAOzM,EAAAA,EAAAA,KAAIyM,GAAU,SAAClO,GAAS,QAC7B,MAAO,CACL0B,KAAM1B,EAAKiK,KACXxJ,gBACuBrJ,IAArB4I,EAAK2P,cAAkD,IAArB3P,EAAK2P,cAAkC,QAAV,EAAC3P,EAAKyC,YAAI,QAAI,IAAIO,MAAM,MAAMzC,QAAU,EACzGoP,YAAa3P,EAAK2P,YAClBN,MAAiB,QAAZ,EAAErP,EAAKqP,aAAK,QAAI,GACrB5M,KAAMzC,EAAKyC,KACX5I,MAAOmG,EAAKnG,MAEhB,GACF,GAEA,6BAQA,SAAgBZ,EAAY2W,GAA+C,MAuB3C,EAtBxBxD,EAAKvT,KACLgX,EAAa,CAAC,UAAW,YAAa,mBAAoB,YAqBhE,MApBqB,iBAAV5W,IACTA,EAAQ6W,KAAKC,MAAM9W,IAEjB2W,EAAa5R,UACf/E,EAAM8H,KAAOlI,KAAKgJ,YAAYuE,QAAQnN,EAAM8H,KAAM6O,IAE/B,KAAf3W,EAAM8H,KACR9H,EAAMyF,KAAOmR,EAAW,IAExB5W,EAAM8H,KAAOlI,KAAKgJ,YAAYuE,QAAQnN,EAAM8H,KAAM6O,GAClD3W,EAAM8H,KAAO9H,EAAM8H,KAAKiC,MAAM,KAAK,GAChB,eAAf/J,EAAMyF,OACRzF,EAAMyF,KAAOmR,EAAWG,KAAKC,IAAI,EAAGD,KAAKE,IAAIjX,EAAM8H,KAAKiC,MAAM,MAAMzC,OAAQsP,EAAWtP,OAAS,OAGpGtH,EAAM8H,KAAO9H,EAAM8H,KAAKqF,QAAQ,kBAAkB,SAAC7N,GAAS,OAAKA,EAAEyN,UAAU,EAAGzN,EAAEgI,OAAS,GAAGyC,MAAM,KAAK,EAAE,KAG7G/J,EAAMsM,OAAqB,QAAf,EAAGtM,EAAMsM,cAAM,QAAI,IAEZ,YAAftM,EAAMyF,KACU,QAAX,EAAA0N,EAAG5S,gBAAQ,OAAX,EAAaC,KAChB2S,EACG7S,eAAe6S,EAAG5S,SAASC,MAC3BC,MAAK,SAACC,GAAmB,MAAK,CAACA,EAAO,IACtCD,KAAK0S,EAAG+D,sBACX/D,EAAGgE,kBAAkB1W,KAAK0S,EAAG+D,sBACT,cAAflX,EAAMyF,KACR0N,EACJ7S,eAAeN,EAAM8H,MACrBrH,MAAK,SAAC2W,GAAM,aAAKjE,EAAGxS,aAAyB,QAAb,EAACyW,EAAOxW,aAAK,QAAI,GAAI,CAAC,EAAE,IACxDH,KAAK0S,EAAG+D,sBACa,qBAAflX,EAAMyF,KACR0N,EACJlB,YAAYjS,EAAM8H,MAClBrH,MAAK,SAAC4W,GAAE,aACPlE,EAAGmE,oBAA4B,QAAT,EAACD,EAAGzW,aAAK,QAAI,GAAI,CACrC2W,eAAgB,2EAChB,IAEH9W,KAAK0S,EAAG+D,sBACa,aAAflX,EAAMyF,KACR0N,EACJqE,WAAWxX,EAAM8H,MACjBrH,MAAK,SAACgX,GAAO,aACZtE,EAAGuE,YAAyB,QAAd,EAACD,EAAQ7W,aAAK,QAAI,GAAI,CAClC2W,eAAgB,8FAChBlC,WAAYrV,EAAMsM,QAClB,IAEH7L,KAAK0S,EAAG+D,sBACa,eAAflX,EAAMyF,KACR0N,EACJqE,WAAWxX,EAAM8H,MACjBrH,MAAK,SAACgX,GAAO,aACZtE,EAAGwE,cAA2B,QAAd,EAACF,EAAQ7W,aAAK,QAAI,GAAI,CACpCgX,oBAAqB,OACrBL,eAAgB,kGAChBlC,WAAYrV,EAAMsM,QAClB,IAEH7L,KAAK0S,EAAG+D,sBACa,eAAflX,EAAMyF,KACR0N,EAAG0E,iBAAiBpX,KAAK0S,EAAG+D,sBACX,YAAflX,EAAMyF,KACR0N,EAAG2E,cAAc9X,EAAM0I,MAAO1I,EAAMuJ,WAAW9I,KAAK0S,EAAG+D,sBAEzDlP,QAAQ+P,OAAO,WACxB,GAEA,2BAQA,SAAc1T,GACZ,MAAgC,KAA5BA,EAAQG,SAASwT,OAEjB,gBACA3T,EAAQC,MAAMkE,KAAI,SAAC8C,GAAM,aAAY,QAAZ,EAAKA,EAAE7L,aAAK,aAAP,EAASA,KAAK,IAAE4L,KAAK,iBACnD,qBACAhH,EAAQE,MAIV,gBACAF,EAAQC,MAAMkE,KAAI,SAAC8C,GAAM,aAAY,QAAZ,EAAKA,EAAE7L,aAAK,aAAP,EAASA,KAAK,IAAE4L,KAAK,iBACnD,qBACAhH,EAAQE,MACR,oBACAF,EAAQG,SAASwT,MAErB,GAIA,mCASA,SAA8BvY,EAAYqC,EAAamW,GAAoB,WACnE7I,EAAoB,GAQ1B,OAPImF,MAAMC,QAAQ/U,IAChBqJ,EAAAA,EAAAA,MAAKrJ,GAAO,SAACsH,GACX,EAAKmR,aAAaD,EAAYlR,EAAK0L,MAAQ1L,EAAMjF,EAAQmW,EAAW7I,EACtE,IAEAxP,KAAKsY,aAAazY,EAAOqC,EAAQmW,EAAW7I,GAEvCA,CACT,GAEA,0BASA,SAAqB3P,EAAYqC,EAAamW,EAAoB7I,GAEhE,MDjdG,SACHrI,EACAoR,EACAC,GAKF,QACMC,EAAgB,KAChBC,GAAO,EAgBX,OAfKvR,EAAKwR,MAAuB,YAAfxR,EAAK0L,OAAkC,QAAV,EAAA1L,EAAK0L,aAAK,OAAV,EAAYzB,MAA6B,aAAX,QAAV,EAAAjK,EAAK0L,aAAK,aAAV,EAAYzB,MAC7C,SAA1BmH,EACAG,GAAO,EAC0B,MAA1BH,EACPC,EAAiB,GAAK,EACW,SAA1BD,IAE0B,SAA1BA,EACPC,EAAiB,GAAK,KACW,aAA1BD,GAA0D,OAAlBE,IAC/CD,EAAiB,GAAKC,IAG1BA,EAAgBtR,EAAK0L,MAElB,CAAE2F,iBAAAA,EAAkBC,cAAAA,EAAeC,KAAAA,EAC9C,CCsbsDE,CAChD/Y,EACAqC,EAAOuC,QAAQI,OACf7E,KAAK6Y,kBAAkBhZ,EAAOqC,EAAQmW,IAHhCG,EAAgB,EAAhBA,iBAA+B,EAAbC,cAAmB,EAAJC,MAMvClJ,EAAW7H,KAAK6Q,EAEpB,GAEA,+BASA,SAA0B3Y,EAAYqC,EAAamW,GAAoB,QAGlB,IAF/CS,EAAOT,GAAoC,WAAvB,GAAOxY,EAAMgT,OAA0ChT,EAAMgT,MAAhB,QAAd,EAAGhT,EAAMgT,aAAK,aAAX,EAAaA,MAEvE,OAAKhT,EAAM8Y,MAA8B,QAArB,EAACzW,EAAOgD,qBAAa,OAApB,EAAsBV,OAElC,CAAC8L,GADRwI,EAAqF,QAA9E,EAACT,GAAoC,WAAvB,GAAOxY,EAAMgT,OAAyChT,EAAMuR,KAAf,QAAd,EAAGvR,EAAMgT,aAAK,aAAX,EAAazB,YAAiB,QAAK,IAC/DZ,OAAOsI,GAAOA,EAAIV,OAAQ,IAAIrF,KAAKlT,EAAMkZ,WAAW7F,WAG1E,CAAC5C,GAAYwI,GAAOtI,OAAOsI,GAAOA,EAAIV,OAAQ,IAAIrF,KAAKlT,EAAMkZ,WAAW7F,UACjF,GAEA,oBAMA,SAAehS,EAAoBiE,GAA4B,MACvD6T,EAAY,CAAC,OAAQ,QAAS,KAAM,aAAc,iBAClD3Z,GAAM4Z,EAAAA,EAAAA,QAAO/X,GAAO,SAACrB,EAAYd,GAAW,OAAMc,IAAUA,EAAM6H,QAAUsR,EAAUrM,QAAQ5N,IAAQ,CAAC,IAQ7G,OAPAM,EAAI6Z,QAAU/T,EAAYnF,KAAKiC,SAASrB,KAAO+P,GAAsB,QAAX,EAACzP,EAAM0I,YAAI,QAAI,IAC1D3K,OAAO+U,KAAK3U,GACxB4V,OACAlI,QAAO,SAACoM,EAAkBpa,GDpjB1B,IAA8Bqa,ECsjB7B,OADAD,GDrjB6BC,ECqjBIra,EDpjB9Bqa,EAAOC,OAAO,GAAGC,oBAAsBF,EAAO9R,MAAM,KCojBdjI,EAAIN,GACtCoa,CACT,GAAG,CAAC,EAER,GAEA,4BAUA,SAAuBI,EAAcrX,EAAatB,EAAW4Y,EAAqBtY,GAAwC,WAClHuY,EAAMzZ,KACNqY,EAAqBnW,EAAOuC,SAAWvC,EAAOuC,QAAQC,OAASxC,EAAOuC,QAAQC,MAAMgD,OAAS,EAWnG,GAVKxF,EAAOiD,WAAcjD,EAAO0L,UAE7BhN,EADEZ,KAAKkS,iBACCsH,EAAa7I,GAAY4I,EAAQ3P,MAAQkH,GAAQ5O,EAAO6O,iBAAkBwI,EAAQ3P,OAAS,IAAMhJ,EAElG4Y,EAAa5Y,EAAOkQ,GAAQ5O,EAAO6O,iBAAkBwI,EAAQ3P,MAAQ,IAAMhJ,GAGlFsB,EAAO3B,OAAS2B,EAAO3B,MAAMiE,QAAUtC,EAAO3B,MAAM4O,OAAOzH,QAAUxF,EAAO3B,MAAMgN,QAAQ7F,SAC5F9G,EAAOA,EAAK2M,QAAQ,IAAImF,OAAOxQ,EAAO3B,MAAM4O,QAASjN,EAAO3B,MAAMgN,UAEhE8K,EAAW,CACb,IAAMqB,EAAmC,GACnCC,GAASC,EAAAA,EAAAA,SAAQL,EAAQ/C,OAAO,SAACrP,GAAS,OAAKA,EAAK0S,IAAI,IAc9D,OAbAhQ,EAAAA,EAAAA,QAAO8P,GAAQ,SAAC9Z,EAAOd,GACrB2a,EAAa/R,KAAK,CAChByI,MAAOlO,EAAOkO,MACdlO,OAAQtB,EAAO,IAAM7B,EAAM,IAC3BsR,KAAM,CACJnI,KAAMhH,EAAM0I,KACZkQ,cAAe,MAEjB5J,KAAM,EAAKgC,gBAAkBuH,EAAIM,OAAO7Y,EAAOgB,EAAOiD,WAAa,CAAC,EACpEqK,WAAYiK,EAAIO,sBAAsBna,EAAOqC,EAAQmW,GACrDnQ,KAAMhH,EAAM0I,MAEhB,IACO8P,CACT,CAeA,MAdoC,CAClC,CACEtJ,MAAOlO,EAAOkO,MACdlO,OAAQtB,EACRyP,KAAM,CACJnI,KAAMhH,EAAM0I,KACZkQ,cAAe,MAEjB5J,KAAMlQ,KAAKkS,gBAAkBuH,EAAIM,OAAO7Y,EAAOgB,EAAOiD,WAAa,CAAC,EACpEqK,WAAYiK,EAAIO,sBAAsBT,EAAQ/C,OAAS+C,EAAQ1G,MAAO3Q,EAAQmW,GAC9EnQ,KAAMhH,EAAM0I,KACZoG,KAAM9O,EAAM+Y,kBAIlB,GAEA,2BAMA,SAAsB9F,GACpB,QAAKA,IAGDQ,MAAMC,QAAQT,EAAQtL,MACjBsL,EAAQtL,KAAK8D,QAAQ,QAAU,EAEhB,QAAjBwH,EAAQtL,KACjB,GAEA,4BAQA,SACEkI,EACAhI,EACAwL,GAGA,IAAI2F,EAA6C,GAcjD,OAbAnJ,EAAiBtD,SAAQ,SAAC0M,GACxB,GAAO5F,GAAY4F,EAAKjS,KAAKyE,QAAQ4H,IAAa,IAAQA,GAAY4F,EAAKjS,KAAKqC,MAAM,uBAAyB,CAC7G,IAAM6P,EAA8BrR,EAAUH,KAAI,SAAC0L,GACjD,MAAO,CACLpM,KAAQqM,EACJ4F,EAAKjS,KAAKqF,QAAQgH,EAAUD,EAAGzU,OAC/Bsa,EAAKjS,KAAKqF,QAAQ,sBAAuB+G,EAAGzU,OAChDsJ,SAAUmL,EAAGzU,MAEjB,IACAqa,EAAsBA,EAAoBG,OAAOD,EACnD,CACF,IACIF,EAAoBxS,QACf8M,EAAAA,EAAAA,OAAKC,EAAAA,EAAAA,SAAQyF,IAEfnJ,CACT,GAEA,uBAQA,SAAkB3Q,GAAgD,WAC1DmT,EAAKvT,KACLsa,EAA8C,GA8DpD,OA5DApR,EAAAA,EAAAA,MAAK9I,EAAM+S,SAAS,SAACjR,GAEnB,IAAIA,EAAOiD,WAAcoO,EAAG1F,cAA5B,CAIA3L,EAAOoC,YAAaoI,EAAAA,EAAAA,QAAOxK,EAAOoC,YAAc,IAAI,SAAC9D,GACnD,OAAYA,CACd,IACA,IAAIoB,EAAM,GACJyW,EAAYnW,EAAOuC,SAAWvC,EAAOuC,QAAQC,OAASxC,EAAOuC,QAAQC,MAAMgD,OAAS,EACpF6S,EAAiBrY,EAAO6C,aAAe7C,EAAO6C,YAAYP,OAE1DgW,EAAetY,EAAO6C,YAAYH,SAAW1C,EAAO6C,YAAYH,SAAWxE,EAAMwE,SACjF6V,EAAY,cAAgBra,EAAMwT,MAAMC,KAAKgC,SAAW,YAAczV,EAAMwT,MAAME,GAAG+B,SACrF6E,EAAaxY,EAAO4C,YAAc5C,EAAOsJ,YACzCmP,EAAczY,EAAO0L,QAAU,EAAK5E,YAAYuE,QAAQrL,EAAO0L,QAASxN,EAAMqI,YAAc,KAClG,GAAIvG,EAAO4C,WACTlD,GAAO,eAELA,GADEyW,EACK,WAAaoC,GAAaF,EAAiB,uCAAyCC,EAAe,IACjGD,EACF,aAAeE,EAAY,mBAAqBD,EAEhD,YAAcC,EAEvB7Y,GAAO,eAAiBgZ,mBAAmB1Y,EAAO4C,WAAWyI,QAAQ,oBAAqBiN,IACtFtY,EAAOoC,WAAWoD,OAAS,EAC7B4S,EAAQ3S,KAAK4L,EAAGsH,oBAAoB3Y,EAAQN,EAAK+Y,IAEjDL,EAAQ3S,KACN4L,EAAGuH,aAAa5Y,EAAOsJ,aAAa,GAAO3K,MAAK,SAACka,GAC/C,OAAOxH,EACJyH,SAASpZ,EAAMmZ,EAAc/Z,OAC7BH,MAAK,SAACwU,GAAa,OAAK9B,EAAG0H,eAAe5F,EAASrN,KAAM9F,EAAQyY,GAAeD,GAAY,EAAOK,EAAc,IAAC,OAC5G,SAACzR,GAAQ,OAAMiK,EAAGhK,MAAQD,CAAG,GACxC,SAGC,OAEL,GADA1H,GAAO,cACHyW,EACFzW,GAAO,WAAa6Y,EAAY,cAAgBra,EAAM8a,cAAgB,EAAKC,cAAcjZ,EAAOuC,cAC3F,GAAI8V,EACT3Y,GAAO,gBAAkB6Y,EAAY,aAAeD,OAC/C,GAAItY,EAAO+C,gBAAkB/C,EAAO+C,eAAeT,OAAQ,CAChE,IAAMsK,EACJ5M,EAAO+C,eAAe6J,YAAc2B,MAAMvO,EAAO+C,eAAe6J,WAC5D5M,EAAO+C,eAAe6J,UACtB1O,EAAM8a,cACZtZ,GAAO,YAAc6Y,EAAY,aAAe3L,CAClD,MAA8B,QAAvB,EAAI5M,EAAO8C,oBAAY,OAAnB,EAAqBR,OAC9B5C,GAAO,eAAiBxB,EAAMwT,MAAME,GAAG+B,SAEvCjU,GAAO,QAAU6Y,EAAY,cAAgBra,EAAM8a,cAErDZ,EAAQ3S,KAAK4L,EAAGsH,oBAAoB3Y,EAAQN,EAAK+Y,GACnD,CApDA,CAqDF,IAEOL,CACT,GAEA,iCAQA,SAA4BjF,EAAenT,EAAayY,GAAyD,IAK9E,EAL8E,OACzGD,EAAaxY,EAAO4C,YAAc5C,EAAOsJ,YACzCgO,EAAgD,IAAnCtX,EAAO6O,iBAAiBrJ,QAAgBxF,EAAOsJ,cAAgBtJ,EAAO6O,iBAAiB,GAAG7I,KACzGd,EAAQ,EACNgU,EAAoC,GAAG,KAC7BlZ,EAAOoC,YAAU,qBAArB,QAAqB,IACzB+W,EAAU,MAAH,OAASjU,EAAQ,KACxBc,EAAOmN,EAASxF,OAAO7H,KAAKqT,GAASC,QACvCjG,EAASxF,OAAO7H,KAAKqT,GAASC,QAAQ,cACtC,KACEtT,EAAOqN,EAASrN,KAAKqT,GAC3B,GAAIrT,EAAKuT,QAAU,IACjB,iBAGF,IAAIra,OAAkB,EACtB,GAAMgH,EACJhH,EAAQ,EAAKsa,WAAWpc,IAAI8I,OACvB,CACL,IAAMuT,EAAWpG,EAASrN,KAAK,MAAD,OAAOZ,IAASiP,QAC9CnV,EAAQ,CACN0I,KAAM6R,EAAS7R,KACfiQ,KAAM4B,EAAS5B,MAAQ4B,EAASC,UAChCzB,iBAAkBwB,EAASxB,kBAAoBwB,EAASE,iBACxDC,YAAaH,EAASG,aAAeH,EAASI,WAC9C7a,MAAOya,EAASza,MAChBoQ,KAAMqK,EAASrK,MAEjB,EAAKoK,WAAWM,IAAI5a,EAAM0I,KAAO1I,EACnC,CAEIgB,EAAO4C,YACToE,EAAAA,EAAAA,MACE,EAAK+R,eAAejT,EAAKqO,QAASnU,EAAQyY,GAAezZ,EAAMkQ,MAAQsJ,EAAYlB,EAAYtY,IAC/F,SAAC6a,GAAY,OAAKX,EAAczT,KAAKoU,EAAa,KAGpD7S,EAAAA,EAAAA,MAAKlB,EAAKqO,QAAQG,OAAO,SAACrP,IACxB+B,EAAAA,EAAAA,MACE,EAAK+R,eAAe9T,EAAMjF,EAAQyY,GAAexT,EAAKiK,MAAQsJ,EAAYlB,EAAYtY,IACtF,SAAC6a,GAAY,OAAKX,EAAczT,KAAKoU,EAAa,GAEtD,IAEF3U,GAAQ,EAvCV,IAAK,EAAL,qBAAmC,GAwClC,+BACD,OAAOgB,QAAQC,QAAQ+S,EACzB,GAEA,6BAWA,SACEjW,EACAqG,EACAhL,EACAJ,EACAgH,EACAmG,EACA3L,GAEA,IAAIsG,EAAO,GACP8T,EAAY,GAGd9T,EAFE/C,EAEK,gGADP6W,EAAY,OAASxQ,EAAc,KAAOhL,GAInC,gGADPwb,EAAY,OAASxQ,EAAc,IAAMhL,GAI3C,IAAMwH,EAAOhI,KAAKwb,WAAWpc,IAAI4c,GAC3BhU,EACJ5H,EAAM,MAAD,OAAOgH,EAAQ,MAAU,CAC5B2O,OAAQ,MACRC,SAAUhW,KAAK6R,YAAcV,GAAY5D,EAAS,CAAE6D,KAAM5Q,GAAaoB,GAAO,WAC3E2L,EAAUvN,KAAKiC,SAASf,MAAO8G,EAAKhH,OACvCsa,QAAS,CACP,aAAcU,KAIlB5b,EAAM,MAAD,OAAOgH,IAAW,CACrB2O,OAAQ,MACRC,SAAUhW,KAAK6R,YAAc3J,GAE/B9H,EAAM,MAAD,OAAOgH,EAAQ,MAAU,CAC5B2O,OAAQ,MACRI,UAAW,CAAC,MAAD,OACH/O,IAER8O,WAAY,CAAC,QAAD,OACF9O,EAAK,mBAEf4O,SAAUhW,KAAK6R,YAAcV,GAAY5D,EAAS,CAAE6D,KAAM5Q,GAAaoB,IACpE2L,EAAU,UAAYvN,KAAKiC,SAASf,MAAO,eAGpD,GAEA,iCAQA,SAA4BgB,EAAaN,EAAa+Y,GAAyD,IAKpE,EALoE,OACvGnB,EAAgD,IAAnCtX,EAAO6O,iBAAiBrJ,QAAgBxF,EAAOsJ,cAAgBtJ,EAAO6O,iBAAiB,GAAG7I,KACvGqF,EAAUrL,EAAOiD,aAAejD,EAAO4C,WACvC1E,EAAa,CAAC,EAChBgH,EAAQ,EAAE,KACUlF,EAAOoC,YAAU,yBAA9B9D,EAAS,QACdgZ,GACF,EAAKyC,gBAAgB/Z,EAAOiD,UAAWjD,EAAOsJ,YAAahL,EAAWJ,EAAOgH,EAAOmG,EAAS3L,GAC7FwF,KAEAlF,EAAO6O,iBAAiBtD,SAAQ,SAACjC,GAC/B,EAAKyQ,gBAAgB/Z,EAAOiD,UAAWqG,EAAYtD,KAAM1H,EAAWJ,EAAOgH,EAAOmG,EAAS3L,GAC3FwF,GACF,GACD,EATH,IAAK,EAAL,qBAA2C,GAU1C,+BACD,OAAOpH,KAAKoW,UAAUhW,GAAOS,MAAK,SAACwU,GAAa,OAAK,EAAK6G,oBAAoB7G,EAAUnT,EAAQyY,EAAY,GAC9G,GAEA,qBAQA,SAAgBzS,GACd,OAAOlI,KAAK2R,WACTwD,kBAAkB,CACjBvT,IAAK5B,KAAK4B,IAAMsG,EAChBkN,OAAQ,MACR+G,QAAS,CAAE,eAAgB,sBAE5Btb,MAAK,SAACwU,GACL,OAAOA,CACT,GACJ,GAEA,0BASA,SAAqB2G,EAAmB7W,GACtC,IAAMoO,EAAKvT,KAGLoc,EAAc7I,EAAGiI,WAAWpc,IAAI4c,GACtC,GAAII,EACF,OAAOhU,QAAQC,QAAQ,MAClB+T,IAKP,IAAIlU,EAAO,GAUX,OAREA,EADE/C,EACK,mGAAqG6W,EAAUzO,QAAQ,IAAK,OAGhIyO,EAAUrP,QAAQ,MAAQ,EACvB,mGACA,wEAA0EqP,EAG3Ehc,KAAK2R,WACTwD,kBAAkB,CACjBvT,IAAK5B,KAAK4B,IAAMsG,EAChBkN,OAAQ,MACR+G,QAAS,CAAE,eAAgB,sBAE5Btb,MAAK,SAACwU,GACL,IAAMrN,EAAO,CACX4B,KAAMoS,EACNnC,KAAMxE,EAASrN,KAAK6R,MAAQxE,EAASrN,KAAK0T,UAC1CzB,iBAAkB5E,EAASrN,KAAKiS,kBAAoB5E,EAASrN,KAAK2T,iBAClEC,YAAavG,EAASrN,KAAK4T,aAAevG,EAASrN,KAAK6T,WACxD7a,MAAOqU,EAASrN,KAAKhH,MACrBoQ,KAAMiE,EAASrN,KAAKoJ,MAGtB,OADAmC,EAAGiI,WAAWM,IAAIE,EAAWhU,GACtB,MACFA,EAEP,GACJ,GAEA,uBAQA,SAAkBqU,GAChB,OAAOrc,KAAK2R,WAAWwD,kBAAkB,CACvCvT,IAAK5B,KAAK4B,IAAM,SAChBoG,KAAMqU,EACNjH,OAAQ,OACR+G,QAAS,CACP,eAAgB,mBAChB,mBAAoB,iBAG1B,GAEA,sBAQA,SAAiBjU,GACf,OAAOlI,KAAK2R,WAAWwD,kBAAkB,CACvCvT,IAAK5B,KAAK4B,IACVwT,OAAQ,OACR+G,QAAS,CACP,eAAgB,mBAChB,mBAAoB,eACpB,yBAA0B,MAC1B,8BAA+BjU,IAGrC,GAEA,4BACA,WACE,OAAOlI,KAAK6W,QAAQ,gBAAgBhW,MAAK,SAACwU,GAAQ,aAAwB,QAAxB,EAAKA,EAASrN,KAAKwO,aAAK,QAAI,EAAE,GAClF,GAAC,2BACD,SAAsB5V,GACpB,OAAKA,EAGEZ,KAAK6W,QAAQ,qBAAuBjW,GAAMC,MAAK,SAACwU,GAAQ,OAAKA,EAASrN,IAAI,IAFxEI,QAAQC,QAAQ,CAAC,EAG5B,GACA,6BACA,WACE,OAAOrI,KAAK6W,QAAQ,iBAAiBhW,MAAK,SAACwU,GAAQ,aAAwB,QAAxB,EAAKA,EAASrN,KAAKwO,aAAK,QAAI,EAAE,GACnF,GAAC,4BACD,SAAuB5V,GACrB,OAAKA,EAGEZ,KAAK6W,QAAQ,0BAA4BjW,GAAMC,MAAK,SAACwU,GAAQ,OAAKA,EAASrN,IAAI,IAF7EI,QAAQC,QAAQ,CAAC,EAG5B,GAAC,yBACD,SAAoBH,GAClB,OAAKA,EAGElI,KAAK6W,QAAQ,4BAA8B3O,GAAMrH,MAAK,SAACwU,GAAQ,OAAKA,EAASrN,IAAI,IAF/EI,QAAQC,QAAQ,CAAC,EAG5B,GAAC,0BACD,SAAaiU,EAAkB5a,GAC7B,OAAK4a,EAGEtc,KAAK6W,QAAQ,iBAAmByF,EAAW,mBAAmBzb,MAAK,SAACwU,GAAQ,aAAwB,QAAxB,EAAKA,EAASrN,KAAKwO,aAAK,QAAI,EAAE,IAFxGpO,QAAQC,QAAQ,GAG3B,GAAC,wBACD,SAAWH,GACT,OAAKA,EAGElI,KAAK6W,QAAQ,sBAAwB3O,GAAMrH,MAAK,SAACwU,GAAQ,OAAKA,EAASrN,IAAI,IAFzEI,QAAQC,QAAQ,CAAC,EAG5B,GAAC,oCACD,SAAuBkU,GACrB,OAAKA,EAGEvc,KAAK6W,QACV,mBAAqB0F,EAAa,kFAClC1b,MAAK,SAACwU,GAAa,MACnB,OAAO3I,EAAAA,EAAAA,QAA0B,QAApB,EAAC2I,EAASrN,KAAKwO,aAAK,QAAI,IAAI,SAACrP,GAAI,MAA2B,eAAtBA,EAAKqV,YAA6B,GACvF,IANSpU,QAAQC,QAAQ,GAO3B,GAAC,iCACD,SAAoBkU,GAClB,OAAKA,EAGEvc,KAAK6W,QACV,mBAAqB0F,EAAa,kFAClC1b,MAAK,SAACwU,GAAa,MACnB,OAAO3I,EAAAA,EAAAA,QAA0B,QAApB,EAAC2I,EAASrN,KAAKwO,aAAK,QAAI,IAAI,SAACrP,GAAI,MAA2B,YAAtBA,EAAKqV,YAA0B,GACpF,IANSpU,QAAQC,QAAQ,GAO3B,GAEA,2BAmBA,SAAsBoU,EAAmB/a,GACvC,IAAIgb,EACF,KACA9T,EAAAA,EAAAA,KAAIlH,GAAS,SAAC7B,EAAOd,GACnB,OAAOA,EAAM,IAAMc,CACrB,IAAG4L,KAAK,KAMV,MAJoB,MAAhBiR,IACFA,EAAc,IAGT1c,KAAK6W,QAAQ,aAAe4F,EAAY,cAAgBC,GAAa7b,MAC1E,SAACwU,GAAQ,aAAwB,QAAxB,EAAKA,EAASrN,KAAKwO,aAAK,QAAI,EAAE,GAE3C,GAEA,iCAmBA,SAA4B+F,EAAoB7a,GAC9C,IAAIgb,EACF,KACA9T,EAAAA,EAAAA,KAAIlH,GAAS,SAAC7B,EAAOd,GACnB,OAAOA,EAAM,IAAMc,CACrB,IAAG4L,KAAK,KAMV,MAJoB,MAAhBiR,IACFA,EAAc,IAGT1c,KAAK6W,QAAQ,mBAAqB0F,EAAa,YAAcG,GAAa7b,MAC/E,SAACwU,GAAQ,aAAwB,QAAxB,EAAKA,EAASrN,KAAKwO,aAAK,QAAI,EAAE,GAE3C,GAEA,yBAmBA,SAAoBiG,EAAmB/a,GACrC,IAAIgb,EACF,KACA9T,EAAAA,EAAAA,KAAIlH,GAAS,SAAC7B,EAAOd,GACnB,OAAOA,EAAM,IAAMc,CACrB,IAAG4L,KAAK,KAMV,MAJoB,MAAhBiR,IACFA,EAAc,IAGT1c,KAAK6W,QAAQ,aAAe4F,EAAY,YAAcC,GAAa7b,MACxE,SAACwU,GAAQ,aAAwB,QAAxB,EAAKA,EAASrN,KAAKwO,aAAK,QAAI,EAAE,GAE3C,GAEA,2BAMA,SAAsB8F,EAAkB7G,GACtC,IAAIkH,EAAU3c,KAAKgJ,YAAYuE,QAAQkI,GACnCmH,EAAU,GAAH,OAAMD,GACbE,GAAW,EACf,GAAIF,IAAYlH,EAGd,IAFA,IACIqH,EADEvc,EAAQ,eAEuB,QAA7Buc,EAAIvc,EAAMwc,KAAKJ,KAEjBG,EAAE1V,QAAU7G,EAAMyc,WACpBzc,EAAMyc,YAIRF,EAAErP,SAAQ,SAAClD,EAAO0S,GACG,IAAfA,IACFN,EAAUA,EAAQpP,QAAQhD,EAAOA,EAAMgD,QAAQ,IAAK,KAAKA,QAAQ,IAAK,KAAKA,QAAQ,IAAK,MACxFqP,EAAUA,EAAQrP,QAAQhD,EAAO,KACjCsS,GAAW,EAEf,IAGJ,OAAO7c,KAAK6W,QAAQ,gBAAkByF,EAAW,kCAAoCM,GAAS/b,MAAK,SAACyZ,GAAY,MAC9G,OAAMA,GAAyB,QAAb,EAACA,EAAQtS,YAAI,OAAZ,EAAcwO,MACxBqG,EAAWvC,EAAQtS,KAAKwO,MAAM9J,QAAO,SAACvF,GAAI,aAAc,QAAd,EAAKA,EAAKiK,YAAI,aAAT,EAAW7G,MAAMoS,EAAQ,IAAIrC,EAAQtS,KAAKwO,MAE3F,EACT,GACF,GAEA,sBAQA,SAAStU,GACP,IAAMqR,EAAKvT,KACLkd,EAAOhb,EAAOA,OAAOyK,QAAQ,OAAS,EACtCwQ,EAAcjb,EAAOA,OAAOyK,QAAQ,MAAQ,EAClD,OAAKuQ,IAAwC,IAAhChb,EAAOA,OAAOyK,QAAQ,KAI9BuQ,EAQMA,GAAQC,EAEV5J,EAAGsD,QAAQ,wBAA0B3U,EAAOA,QAAQrB,MAAK,SAACyZ,GAC/D,YAAqB/b,IAAjB+b,EAAQtS,MAAyC,MAAnBsS,EAAQhF,OACjC,CAAC,CAAEtU,MAAOkB,EAAOA,OAAQkP,KAAMlP,EAAO0L,SAAW1L,EAAOA,UAGjEoY,EAAQtS,KAAKoJ,KAAOlP,EAAO0L,SAAW0M,EAAQtS,KAAKoJ,KAC5C,CAACkJ,EAAQtS,MAClB,IAGOuL,EAAGsD,QAAQ,sBAAwB3U,EAAOA,QAAQrB,MAAK,SAACyZ,GAC7D,YAAqB/b,IAAjB+b,EAAQtS,MAAyC,MAAnBsS,EAAQhF,OACjC,CAAC,CAAEtU,MAAOkB,EAAOA,OAAQkP,KAAMlP,EAAO0L,SAAW1L,EAAOA,UAGjEoY,EAAQtS,KAAKoJ,KAAOlP,EAAO0L,SAAW0M,EAAQtS,KAAKoJ,KAC5C,CAACkJ,EAAQtS,MAClB,IAzBOuL,EAAG2E,cAAclY,KAAKiC,SAASf,MAAQgB,EAAOA,QAAQrB,MAAK,SAACyZ,GACjE,YAAgB/b,IAAZ+b,GAA4C,IAAnBA,EAAQ5S,OAC5B,CAAC,CAAE1G,MAAOkB,EAAOA,OAAQkP,KAAMlP,EAAO0L,SAAW1L,EAAOA,SAE1DoY,CACT,IAVOlS,QAAQC,QAAQ,CAAC,CAAErH,MAAOkB,EAAOA,OAAQkP,KAAMlP,EAAO0L,SAAW1L,EAAOA,SAgCnF,IAlxCF,mFAkxCG,EAlvC4B,CAASkb,EAAAA,eC1B3BC,GAAS,IAAIC,EAAAA,iBACxBjM,IAECkM,gBAAgB1b,GAChB2b,eAAe5W,GACf6W,uBAAuB3d","sources":["webpack:///external amd \"react\"","webpack:///external amd \"@grafana/ui\"","webpack:///external amd \"@grafana/data\"","webpack:///external amd \"lodash\"","webpack:///external amd \"@grafana/runtime\"","webpack:///webpack/bootstrap","webpack:///webpack/runtime/compat get default export","webpack:///webpack/runtime/define property getters","webpack:///webpack/runtime/hasOwnProperty shorthand","webpack:///webpack/runtime/make namespace object","webpack:///./AnnotationsQueryCtrl.ts","webpack:///./ConfigEditor.tsx","webpack:///./components/Forms.tsx","webpack:///./types.ts","webpack:///./components/QueryEditorModeSwitcher.tsx","webpack:///./QueryEditor.tsx","webpack:///./helper.ts","webpack:///./datasource.ts","webpack:///./module.ts"],"sourcesContent":["module.exports = __WEBPACK_EXTERNAL_MODULE__0__;","module.exports = __WEBPACK_EXTERNAL_MODULE__1__;","module.exports = __WEBPACK_EXTERNAL_MODULE__2__;","module.exports = __WEBPACK_EXTERNAL_MODULE__3__;","module.exports = __WEBPACK_EXTERNAL_MODULE__5__;","// The module cache\nvar __webpack_module_cache__ = {};\n\n// The require function\nfunction __webpack_require__(moduleId) {\n\t// Check if module is in cache\n\tvar cachedModule = __webpack_module_cache__[moduleId];\n\tif (cachedModule !== undefined) {\n\t\treturn cachedModule.exports;\n\t}\n\t// Create a new module (and put it into the cache)\n\tvar module = __webpack_module_cache__[moduleId] = {\n\t\t// no module.id needed\n\t\t// no module.loaded needed\n\t\texports: {}\n\t};\n\n\t// Execute the module function\n\t__webpack_modules__[moduleId](module, module.exports, __webpack_require__);\n\n\t// Return the exports of the module\n\treturn module.exports;\n}\n\n","// getDefaultExport function for compatibility with non-harmony modules\n__webpack_require__.n = (module) => {\n\tvar getter = module && module.__esModule ?\n\t\t() => (module['default']) :\n\t\t() => (module);\n\t__webpack_require__.d(getter, { a: getter });\n\treturn getter;\n};","// define getter functions for harmony exports\n__webpack_require__.d = (exports, definition) => {\n\tfor(var key in definition) {\n\t\tif(__webpack_require__.o(definition, key) && !__webpack_require__.o(exports, key)) {\n\t\t\tObject.defineProperty(exports, key, { enumerable: true, get: definition[key] });\n\t\t}\n\t}\n};","__webpack_require__.o = (obj, prop) => (Object.prototype.hasOwnProperty.call(obj, prop))","// define __esModule on exports\n__webpack_require__.r = (exports) => {\n\tif(typeof Symbol !== 'undefined' && Symbol.toStringTag) {\n\t\tObject.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });\n\t}\n\tObject.defineProperty(exports, '__esModule', { value: true });\n};","export class AnnotationsQueryCtrl {\n  static templateUrl = 'partials/annotations.editor.html';\n\n  $scope: any;\n  annotation: any;\n  datasource: any;\n\n  /** @ngInject */\n  constructor($scope: any) {\n    this.$scope = $scope;\n    this.annotation = $scope.ctrl.annotation;\n    this.datasource = $scope.ctrl.datasource;\n\n    // load defaults\n    this.annotation.query = this.annotation.query || {};\n    this.annotation.databases = this.annotation.databases || [];\n    this.annotation.templates = this.annotation.templates || [];\n    this.annotation.regex = this.annotation.regex || {};\n    this.annotation.attribute = this.annotation.attribute || {};\n    this.annotation.showEndTime = this.annotation.showEndTime || false;\n\n    this.datasource.getAssetServer(this.datasource.afserver.name).then((result: any) => {\n      return this.getDatabases(result.WebId);\n    });\n  }\n  templateChanged() {\n    // do nothing\n  }\n  databaseChanged() {\n    this.annotation.templates = [];\n    this.getEventFrames();\n  }\n  getDatabases(webid: string) {\n    const ctrl = this;\n    ctrl.datasource.getDatabases(webid).then((dbs: any) => {\n      ctrl.annotation.databases = dbs;\n      this.$scope.$apply();\n    });\n  }\n  getEventFrames() {\n    const ctrl = this;\n    ctrl.datasource.getEventFrameTemplates(this.annotation.database.WebId).then((templates: any) => {\n      ctrl.annotation.templates = templates;\n      this.$scope.$apply();\n    });\n  }\n}\n","import React, { ChangeEvent, PureComponent } from 'react';\nimport { LegacyForms, DataSourceHttpSettings, InlineField, InlineSwitch } from '@grafana/ui';\nimport { DataSourcePluginOptionsEditorProps, DataSourceJsonData, DataSourceSettings } from '@grafana/data';\nimport { PIWebAPIDataSourceJsonData } from './types';\n\nconst { FormField } = LegacyForms;\n\ninterface Props extends DataSourcePluginOptionsEditorProps<PIWebAPIDataSourceJsonData, {}> {}\n\nconst coerceOptions = (\n  options: DataSourceSettings<PIWebAPIDataSourceJsonData, {}>\n): DataSourceSettings<PIWebAPIDataSourceJsonData, {}> => {\n  return {\n    ...options,\n    jsonData: {\n      ...options.jsonData,\n      url: options.url,\n    },\n  };\n};\n\ninterface State {}\n\nexport class PIWebAPIConfigEditor extends PureComponent<Props, State> {\n  onPIServerChange = (event: ChangeEvent<HTMLInputElement>) => {\n    const { onOptionsChange, options } = this.props;\n    const jsonData = {\n      ...options.jsonData,\n      piserver: event.target.value,\n    };\n    onOptionsChange({ ...options, jsonData });\n  };\n\n  onAFServerChange = (event: ChangeEvent<HTMLInputElement>) => {\n    const { onOptionsChange, options } = this.props;\n    const jsonData = {\n      ...options.jsonData,\n      afserver: event.target.value,\n    };\n    onOptionsChange({ ...options, jsonData });\n  };\n\n  onAFDatabaseChange = (event: ChangeEvent<HTMLInputElement>) => {\n    const { onOptionsChange, options } = this.props;\n    const jsonData = {\n      ...options.jsonData,\n      afdatabase: event.target.value,\n    };\n    onOptionsChange({ ...options, jsonData });\n  };\n\n  onHttpOptionsChange = (options: DataSourceSettings<DataSourceJsonData, {}>) => {\n    const { onOptionsChange } = this.props;\n    onOptionsChange(coerceOptions(options));\n  };\n\n  onPiPointChange = (event: ChangeEvent<HTMLInputElement>) => {\n    const { onOptionsChange, options } = this.props;\n    const jsonData = {\n      ...options.jsonData,\n      piserver: event.target.checked ? options.jsonData.piserver : '',\n      pipoint: event.target.checked,\n    };\n    onOptionsChange({ ...options, jsonData });\n  };\n\n  onNewFormatChange = (event: ChangeEvent<HTMLInputElement>) => {\n    const { onOptionsChange, options } = this.props;\n    const jsonData = {\n      ...options.jsonData,\n      newFormat: event.target.checked,\n    };\n    onOptionsChange({ ...options, jsonData });\n  };\n\n  render() {\n    const { options: originalOptions } = this.props;\n    const options = coerceOptions(originalOptions);\n\n    return (\n      <div>\n        <DataSourceHttpSettings\n          defaultUrl=\"https://server.name/piwebapi\"\n          dataSourceConfig={options}\n          onChange={this.onHttpOptionsChange}\n          showAccessOptions\n        />\n\n        <h3 className=\"page-heading\">Custom Configuration</h3>\n\n        <div className=\"gf-form-group\">\n          <div className=\"gf-form-inline\">\n            <InlineField label=\"Enable PI Points in Query\" labelWidth={24}>\n              <InlineSwitch value={options.jsonData.pipoint} onChange={this.onPiPointChange} />\n            </InlineField>\n          </div>\n          <div className=\"gf-form-inline\">\n            <InlineField label=\"Enable New Data Format\" labelWidth={24}>\n              <InlineSwitch value={options.jsonData.newFormat} onChange={this.onNewFormatChange} />\n            </InlineField>\n          </div>\n        </div>\n\n        <h3 className=\"page-heading\">PI/AF Connection Details</h3>\n\n        <div className=\"gf-form-group\">\n          {options.jsonData.pipoint && (\n            <div className=\"gf-form\">\n              <FormField\n                label=\"PI Server\"\n                labelWidth={10}\n                inputWidth={25}\n                onChange={this.onPIServerChange}\n                value={options.jsonData.piserver || ''}\n                placeholder=\"Default PI Server to use for data requests\"\n              />\n            </div>\n          )}\n          <div className=\"gf-form\">\n            <FormField\n              label=\"AF Server\"\n              labelWidth={10}\n              inputWidth={25}\n              onChange={this.onAFServerChange}\n              value={options.jsonData.afserver || ''}\n              placeholder=\"Default AF Server to use for data requests\"\n            />\n          </div>\n          <div className=\"gf-form\">\n            <FormField\n              label=\"AF Database\"\n              labelWidth={10}\n              inputWidth={25}\n              onChange={this.onAFDatabaseChange}\n              value={options.jsonData.afdatabase || ''}\n              placeholder=\"Default AF Database server for AF queries\"\n            />\n          </div>\n        </div>\n      </div>\n    );\n  }\n}\n","import React, { InputHTMLAttributes, FunctionComponent } from 'react';\nimport { InlineFormLabel } from '@grafana/ui';\n\nexport interface Props extends InputHTMLAttributes<HTMLInputElement> {\n  label: string;\n  tooltip?: string;\n  labelWidth?: number;\n  children?: React.ReactNode;\n  queryEditor?: JSX.Element;\n}\n\nexport const QueryField: FunctionComponent<Partial<Props>> = ({ label, labelWidth = 12, tooltip, children }) => (\n  <>\n    <InlineFormLabel width={labelWidth} tooltip={tooltip}>\n      {label}\n    </InlineFormLabel>\n    {children}\n  </>\n);\n\nexport const QueryRowTerminator = () => {\n  return (\n    <div className=\"gf-form gf-form--grow\">\n      <div className=\"gf-form-label gf-form-label--grow\" />\n    </div>\n  );\n};\n\nexport const QueryInlineField = ({ ...props }) => {\n  return (\n    <QueryEditorRow>\n      <QueryField {...props} />\n    </QueryEditorRow>\n  );\n};\n\nexport const QueryEditorRow = (props: Partial<Props>) => {\n  return (\n    <div className=\"gf-form-inline\">\n      {props.children}\n      <QueryRowTerminator />\n    </div>\n  );\n};\n\nexport const QueryRawInlineField = ({ ...props }) => {\n  return (\n    <QueryRawEditorRow>\n      <QueryField {...props} />\n    </QueryRawEditorRow>\n  );\n};\n\nexport const QueryRawEditorRow = (props: Partial<Props>) => {\n  return <>{props.children}</>;\n};\n","import { DataQuery, DataSourceJsonData, Labels, QueryResultMeta } from '@grafana/data';\n\nexport interface PiwebapiElementPath {\n  path: string;\n  variable: string;\n}\n\nexport interface PiwebapiInternalRsp {\n  data: PiwebapiRsp;\n  status: number;\n  url: string;\n}\n\nexport interface PiwebapTargetRsp {\n  refId: string;\n  target: string;\n  tags: Labels,\n  datapoints: any[];\n  path?: string;\n  meta?: QueryResultMeta;\n  unit?: string;\n}\n\nexport interface PiwebapiRsp {\n  Name?: string;\n  InstanceType?: string;\n  Items?: PiwebapiRsp[];\n  WebId?: string;\n  HasChildren?: boolean;\n  Type?: string;\n  DefaultUnitsName?: string;\n  Description?: string;\n  Path?: string;\n}\n\nexport interface PiDataServer {\n  name: string | undefined;\n  webid: string | undefined;\n}\n\nexport interface PIWebAPISelectableValue {\n  webId?: string;\n  value?: string;\n  type?: string;\n  expandable?: boolean;\n}\n\nexport interface PIWebAPIAnnotationsQuery extends DataQuery {\n  target: string;\n}\n\nexport interface PIWebAPIQuery extends DataQuery {\n  target: string;\n  elementPath: string;\n  attributes: any[];\n  segments: any[];\n  display: any;\n  interpolate: any;\n  recordedValues: any;\n  digitalStates: any;\n  useLastValue: any,\n  webid: string;\n  webids: string[];\n  regex: any;\n  summary: any;\n  expression: string;\n  isPiPoint: boolean;\n  rawQuery?: boolean;\n  query?: string;\n}\n\nexport const defaultQuery: Partial<PIWebAPIQuery> = {\n  target: ';',\n  attributes: [],\n  segments: [],\n  regex: { enable: false },\n  summary: { types: [], basis: 'EventWeighted', interval: '', nodata: 'Null' },\n  expression: '',\n  interpolate: { enable: false },\n  useLastValue: { enable: false },\n  recordedValues: { enable: false },\n  digitalStates: { enable: false },\n  isPiPoint: false,\n};\n\n/**\n * These are options configured for each DataSource instance\n */\nexport interface PIWebAPIDataSourceJsonData extends DataSourceJsonData {\n  url?: string;\n  access?: string;\n  piserver?: string;\n  afserver?: string;\n  afdatabase?: string;\n  pipoint?: boolean;\n  newFormat?: boolean;\n}\n\n/**\n * Value that is used in the backend, but never sent over HTTP to the frontend\n */\nexport interface PIWebAPISecureJsonData {\n  apiKey?: string;\n}\n","import React, { useEffect, useState } from 'react';\nimport { Button, ConfirmModal } from '@grafana/ui';\n\ntype Props = {\n  isRaw: boolean;\n  onChange: (newIsRaw: boolean) => void;\n};\n\nexport const QueryEditorModeSwitcher = ({ isRaw, onChange }: Props): JSX.Element => {\n  const [isModalOpen, setModalOpen] = useState(false);\n\n  useEffect(() => {\n    // if the isRaw changes, we hide the modal\n    setModalOpen(false);\n  }, [isRaw]);\n\n  if (isRaw) {\n    return (\n      <>\n        <Button\n          aria-label=\"Switch to visual editor\"\n          icon=\"pen\"\n          variant=\"secondary\"\n          type=\"button\"\n          onClick={() => {\n            // we show the are-you-sure modal\n            setModalOpen(true);\n          }}\n        ></Button>\n        <ConfirmModal\n          isOpen={isModalOpen}\n          title=\"Switch to visual editor mode\"\n          body=\"Are you sure to switch to visual editor mode? You will lose the changes done in raw query mode.\"\n          confirmText=\"Yes, switch to editor mode\"\n          dismissText=\"No, stay in raw query mode\"\n          onConfirm={() => {\n            onChange(false);\n          }}\n          onDismiss={() => {\n            setModalOpen(false);\n          }}\n        />\n      </>\n    );\n  } else {\n    return (\n      <Button\n        aria-label=\"Switch to text editor\"\n        icon=\"pen\"\n        variant=\"secondary\"\n        type=\"button\"\n        onClick={() => {\n          onChange(true);\n        }}\n      ></Button>\n    );\n  }\n};\n","import { each, filter, forOwn, join, reduce, map, slice, remove, defaults } from 'lodash';\n\nimport React, { PureComponent, ChangeEvent } from 'react';\nimport { Icon, InlineField, InlineFieldRow, InlineSwitch, Input, SegmentAsync, Segment } from '@grafana/ui';\nimport { QueryEditorProps, SelectableValue, VariableModel } from '@grafana/data';\n\nimport { PiWebAPIDatasource } from './datasource';\nimport { QueryInlineField, QueryRawInlineField, QueryRowTerminator } from './components/Forms';\nimport { PIWebAPISelectableValue, PIWebAPIDataSourceJsonData, PIWebAPIQuery, defaultQuery } from './types';\nimport { QueryEditorModeSwitcher } from 'components/QueryEditorModeSwitcher';\n\nconst LABEL_WIDTH = 24;\nconst MIN_ELEM_INPUT_WIDTH = 200;\nconst MIN_ATTR_INPUT_WIDTH = 250;\n\ninterface State {\n  isPiPoint: boolean;\n  segments: Array<SelectableValue<PIWebAPISelectableValue>>;\n  attributes: Array<SelectableValue<PIWebAPISelectableValue>>;\n  summaries: Array<SelectableValue<PIWebAPISelectableValue>>;\n  attributeSegment: SelectableValue<PIWebAPISelectableValue>;\n  summarySegment: SelectableValue<PIWebAPISelectableValue>;\n  calculationBasisSegment: SelectableValue<PIWebAPISelectableValue>;\n  noDataReplacementSegment: SelectableValue<PIWebAPISelectableValue>;\n}\n\ntype Props = QueryEditorProps<PiWebAPIDatasource, PIWebAPIQuery, PIWebAPIDataSourceJsonData>;\n\nconst REMOVE_LABEL = '-REMOVE-';\n\nconst CustomLabelComponent = (props: any) => {\n  if (props.value) {\n    return (\n      <div className={`gf-form-label ${props.value.type === 'template' ? 'query-keyword' : ''}`}>\n        {props.label ?? '--no label--'}\n      </div>\n    );\n  }\n  return (\n    <a className=\"gf-form-label query-part\">\n      <Icon name=\"plus\" />\n    </a>\n  );\n};\n\nexport class PIWebAPIQueryEditor extends PureComponent<Props, State> {\n  error: any;\n  piServer: any[] = [];\n  availableAttributes: any = {};\n  summaryTypes: string[];\n  calculationBasis: string[];\n  noDataReplacement: string[];\n  state: State = {\n    isPiPoint: false,\n    segments: [],\n    attributes: [],\n    summaries: [],\n    attributeSegment: {},\n    summarySegment: {},\n    calculationBasisSegment: {},\n    noDataReplacementSegment: {},\n  };\n\n  constructor(props: any) {\n    super(props);\n    this.onSegmentChange = this.onSegmentChange.bind(this);\n    this.calcBasisValueChanged = this.calcBasisValueChanged.bind(this);\n    this.calcNoDataValueChanged = this.calcNoDataValueChanged.bind(this);\n    this.onSummaryAction = this.onSummaryAction.bind(this);\n    this.onSummaryValueChanged = this.onSummaryValueChanged.bind(this);\n    this.onAttributeAction = this.onAttributeAction.bind(this);\n    this.onAttributeChange = this.onAttributeChange.bind(this);\n\n    this.summaryTypes = [\n      // 'None', // A summary type is not specified.\n      'Total', // A totalization over the time range.\n      'Average', // The average value over the time range.\n      'Minimum', // The minimum value over the time range.\n      'Maximum', // The maximum value over the time range.\n      'Range', // The range value over the time range (minimum-maximum).\n      'StdDev', // The standard deviation over the time range.\n      'PopulationStdDev', // The population standard deviation over the time range.\n      'Count', // The sum of event count over the time range when calculation basis is event weighted. The sum of event time duration over the time range when calculation basis is time weighted.\n      'PercentGood', // Percent of data with good value during the calculation period. For time weighted calculations, the percentage is based on time. For event weighted calculations, the percent is based on event count.\n      'All', // A convenience for requesting all available summary calculations.\n      'AllForNonNumeric', // A convenience for requesting all available summary calculations for non-numeric data.\n    ];\n\n    this.calculationBasis = [\n      'TimeWeighted', // Weight the values in the calculation by the time over which they apply. Interpolation is based on whether the attribute is stepped. Interpolated events are generated at the boundaries if necessary.\n      'EventWeighted', // Evaluate values with equal weighting for each event. No interpolation is done. There must be at least one event within the time range to perform a successful calculation. Two events are required for standard deviation. In handling events at the boundary of the calculation, the AFSDK uses following rules:\n      'TimeWeightedContinuous', // Apply weighting as in TimeWeighted, but do all interpolation between values as if they represent continuous data, (standard interpolation) regardless of whether the attribute is stepped.\n      'TimeWeightedDiscrete', // Apply weighting as in TimeWeighted but interpolation between values is performed as if they represent discrete, unrelated values (stair step plot) regardless of the attribute is stepped.\n      'EventWeightedExcludeMostRecentEvent', // The calculation behaves the same as _EventWeighted_, except in the handling of events at the boundary of summary intervals in a multiple intervals calculation. Use this option to prevent events at the intervals boundary from being double count at both intervals. With this option, events at the end time (most recent time) of an interval is not used in that interval.\n      'EventWeightedExcludeEarliestEvent', // Similar to the option _EventWeightedExcludeMostRecentEvent_. Events at the start time(earliest time) of an interval is not used in that interval.\n      'EventWeightedIncludeBothEnds', // Events at both ends of the interval boundaries are included in the event weighted calculation.\n    ];\n\n    this.noDataReplacement = [\n      'Null', // replace with nulls\n      'Drop', // drop items\n      'Previous', // use previous value if available\n      '0', // replace with 0\n      'Keep', // Keep value\n    ];\n  }\n\n  // is selected segment empty\n  isValueEmpty(value: PIWebAPISelectableValue | undefined) {\n    return !value || !value.value || !value.value.length || value.value === REMOVE_LABEL;\n  }\n\n  segmentChangeValue = (segments: Array<SelectableValue<PIWebAPISelectableValue>>) => {\n    const query = this.props.query;\n    this.setState({ segments }, () => this.onChange({ ...query, segments }));\n  };\n\n  attributeChangeValue = (attributes: Array<SelectableValue<PIWebAPISelectableValue>>) => {\n    const query = this.props.query;\n    this.setState({ attributes }, () => this.onChange({ ...query, attributes }));\n  };\n\n  // summary calculation basis change event\n  calcBasisValueChanged(segment: SelectableValue<PIWebAPISelectableValue>) {\n    const metricsQuery = this.props.query as PIWebAPIQuery;\n    const summary = metricsQuery.summary;\n    summary.basis = segment.value?.value;\n    this.onChange({ ...metricsQuery, summary });\n  }\n  // get summary calculation basis user interface segments\n  getCalcBasisSegments() {\n    const segments = map(this.calculationBasis, (item: string) => {\n      let selectableValue: SelectableValue<PIWebAPISelectableValue> = {\n        label: item,\n        value: {\n          value: item,\n          expandable: true,\n        },\n      };\n      return selectableValue;\n    });\n    return segments;\n  }\n\n  // no data change event\n  calcNoDataValueChanged(segment: SelectableValue<PIWebAPISelectableValue>) {\n    const metricsQuery = this.props.query as PIWebAPIQuery;\n    const summary = metricsQuery.summary;\n    summary.nodata = segment.value?.value;\n    this.onChange({ ...metricsQuery, summary });\n  }\n  // get no data user interface segments\n  getNoDataSegments() {\n    const segments = map(this.noDataReplacement, (item: string) => {\n      let selectableValue: SelectableValue<PIWebAPISelectableValue> = {\n        label: item,\n        value: {\n          value: item,\n          expandable: true,\n        },\n      };\n      return selectableValue;\n    });\n    return segments;\n  }\n\n  // summary query change event\n  onSummaryValueChanged(item: SelectableValue<PIWebAPISelectableValue>, index: number) {\n    const summaries = this.state.summaries.slice(0) as Array<SelectableValue<PIWebAPISelectableValue>>;\n    summaries[index] = item;\n    if (this.isValueEmpty(item.value)) {\n      summaries.splice(index, 1);\n    }\n    this.setState({ summaries }, this.stateCallback);\n  }\n  // get the list of summaries available\n  getSummarySegments() {\n    const ctrl = this;\n    const summaryTypes = filter(ctrl.summaryTypes, (type) => {\n      return this.state.summaries.map((s) => s.value?.value).indexOf(type) === -1;\n    });\n    const segments = map(summaryTypes, (item: string) => {\n      let selectableValue: SelectableValue<PIWebAPISelectableValue> = {\n        label: item,\n        value: {\n          value: item,\n          expandable: true,\n        },\n      };\n      return selectableValue;\n    });\n\n    segments.unshift({\n      label: REMOVE_LABEL,\n      value: {\n        value: REMOVE_LABEL,\n      },\n    });\n\n    return segments;\n  }\n\n  // remove a summary from the user interface and the query\n  removeSummary(part: SelectableValue<PIWebAPISelectableValue>) {\n    const summaries = filter(this.state.summaries, (item: SelectableValue<PIWebAPISelectableValue>) => {\n      return item !== part;\n    });\n    this.setState({ summaries });\n  }\n  // add a new summary to the query\n  onSummaryAction(item: SelectableValue<PIWebAPISelectableValue>) {\n    const summaries = this.state.summaries.slice(0) as Array<SelectableValue<PIWebAPISelectableValue>>;\n    // if value is not empty, add new attribute segment\n    if (!this.isValueEmpty(item.value)) {\n      let selectableValue: SelectableValue<PIWebAPISelectableValue> = {\n        label: item.label,\n        value: {\n          value: item.value?.value,\n          expandable: true,\n        },\n      };\n      summaries.push(selectableValue);\n    }\n    this.setState({ summarySegment: {}, summaries }, this.stateCallback);\n  }\n\n  // remove an attribute from the query\n  removeAttribute(part: SelectableValue<PIWebAPISelectableValue>) {\n    const attributes = filter(this.state.attributes, (item: SelectableValue<PIWebAPISelectableValue>) => {\n      return item !== part;\n    });\n    this.attributeChangeValue(attributes);\n  }\n  // add an attribute to the query\n  onAttributeAction(item: SelectableValue<PIWebAPISelectableValue>) {\n    const { query } = this.props;\n    const attributes = this.state.attributes.slice(0);\n    // if value is not empty, add new attribute segment\n    if (!this.isValueEmpty(item.value)) {\n      let selectableValue: SelectableValue<PIWebAPISelectableValue> = {\n        label: item.label,\n        value: {\n          value: item.value?.value,\n          expandable: !query.isPiPoint,\n        },\n      };\n      attributes.push(selectableValue);\n    }\n    this.attributeChangeValue(attributes);\n  }\n\n  // pi point change event\n  onPiPointChange = (item: SelectableValue<PIWebAPISelectableValue>, index: number) => {\n    let attributes = this.state.attributes.slice(0);\n\n    if (item.label === REMOVE_LABEL) {\n      remove(attributes, (value, n) => n === index);\n    } else {\n      // set current value\n      attributes[index] = item;\n    }\n\n    this.checkPiPointSegments(item, attributes);\n  };\n  // attribute change event\n  onAttributeChange = (item: SelectableValue<PIWebAPISelectableValue>, index: number) => {\n    let attributes = this.state.attributes.slice(0);\n\n    // ignore if no change\n    if (attributes[index].label === item.value?.value) {\n      return;\n    }\n\n    // set current value\n    attributes[index] = item;\n\n    this.checkAttributeSegments(attributes, this.state.segments);\n  };\n  // segment change\n  onSegmentChange = (item: SelectableValue<PIWebAPISelectableValue>, index: number) => {\n    const { query } = this.props;\n    let segments = this.state.segments.slice(0);\n\n    // ignore if no change\n    if (segments[index].label === item.value?.value) {\n      return;\n    }\n\n    // reset attributes list\n    this.setState({ attributes: [] }, () => {\n      if (item.label === REMOVE_LABEL) {\n        segments = slice(segments, 0, index);\n        this.checkAttributeSegments([], segments).then(() => {\n          if (segments.length === 0) {\n            segments.push({\n              label: '',\n            });\n          } else if (!!segments[segments.length - 1].value?.expandable) {\n            segments.push({\n              label: 'Select Element',\n              value: {\n                value: '-Select Element-',\n              },\n            });\n          }\n          if (query.isPiPoint) {\n            this.piServer = [];\n          }\n          this.segmentChangeValue(segments);\n        });\n        return;\n      }\n  \n      // set current value\n      segments[index] = item;\n  \n      // Accept only one PI server\n      if (query.isPiPoint) {\n        this.piServer.push(item);\n        this.segmentChangeValue(segments);\n        return;\n      }\n  \n      // changed internal selection\n      if (index < segments.length - 1) {\n        segments = slice(segments, 0, index + 1);\n      }\n      this.checkAttributeSegments([], segments).then(() => {\n        // add new options\n        if (!!item.value?.expandable) {\n          segments.push({\n            label: 'Select Element',\n            value: {\n              value: '-Select Element-',\n            },\n          });\n        }\n        this.segmentChangeValue(segments);\n      })\n    });\n  };\n\n  // get a ui segment for the attributes\n  getElementSegments = (\n    index: number,\n    currentSegment?: Array<SelectableValue<PIWebAPISelectableValue>>\n  ): Promise<Array<SelectableValue<PIWebAPISelectableValue>>> => {\n    const { datasource, query, data } = this.props;\n    const ctrl = this;\n    const findQuery = query.isPiPoint\n      ? { type: 'dataserver' }\n      : { path: this.getSegmentPathUpTo(currentSegment ?? this.state.segments.slice(0), index) };\n\n    if (!query.isPiPoint) {\n      if (datasource.afserver?.name && index === 0) {\n        return Promise.resolve([\n          {\n            label: datasource.afserver.name,\n            value: {\n              value: datasource.afserver.name,\n              expandable: true,\n            },\n          },\n        ]);\n      }\n      if (datasource.afserver?.name && datasource.afdatabase?.name && index === 1) {\n        return Promise.resolve([\n          {\n            label: datasource.afdatabase.name,\n            value: {\n              value: datasource.afdatabase.name,\n              expandable: true,\n            },\n          },\n        ]);\n      }\n\n      // if (!findQuery.path?.length) {\n      //   return Promise.resolve([]);\n      // }\n    }\n    return datasource\n      .metricFindQuery(findQuery, Object.assign(data?.request?.scopedVars ?? {}, { isPiPoint: query.isPiPoint }))\n      .then((items: any[]) => {\n        const altSegments = map(items, (item: any) => {\n          let selectableValue: SelectableValue<PIWebAPISelectableValue> = {\n            label: item.text,\n            value: {\n              webId: item.WebId,\n              value: item.text,\n              expandable: !query.isPiPoint && item.expandable,\n            },\n          };\n          return selectableValue;\n        });\n\n        if (altSegments.length === 0) {\n          return altSegments;\n        }\n\n        // add template variables\n        const variables = datasource.templateSrv.getVariables();\n        each(variables, (variable: VariableModel) => {\n          let selectableValue: SelectableValue<PIWebAPISelectableValue> = {\n            label: '${' + variable.name + '}',\n            value: {\n              type: 'template',\n              value: '${' + variable.name + '}',\n              expandable: !query.isPiPoint,\n            },\n          };\n          altSegments.unshift(selectableValue);\n        });\n\n        altSegments.unshift({\n          label: REMOVE_LABEL,\n          value: {\n            value: REMOVE_LABEL,\n          },\n        });\n\n        return altSegments;\n      })\n      .catch((err: any) => {\n        ctrl.error = err.message || 'Failed to issue metric query';\n        return [];\n      });\n  };\n\n  // get the list of attributes for the user interface - PI\n  getAttributeSegmentsPI = (attributeText?: string): Promise<Array<SelectableValue<PIWebAPISelectableValue>>> => {\n    const { datasource, query, data } = this.props;\n    const ctrl = this;\n    const findQuery = {\n      path: '',\n      webId: this.getSelectedPIServer(),\n      pointName: (attributeText ?? '') + '*',\n      type: 'pipoint',\n    };\n    let segments: Array<SelectableValue<PIWebAPISelectableValue>> = [];\n    return datasource\n      .metricFindQuery(findQuery, Object.assign(data?.request?.scopedVars ?? {}, { isPiPoint: query.isPiPoint }))\n      .then((items: any[]) => {\n        segments = map(items, (item: any) => {\n          let selectableValue: SelectableValue<PIWebAPISelectableValue> = {\n            path: item.Path,\n            label: item.text,\n            value: {\n              value: item.text,\n              expandable: false,\n            },\n          };\n          return selectableValue;\n        });\n        if (!!attributeText && attributeText.length > 0) {\n            segments.unshift({\n            label: attributeText,\n            value: {\n              value: attributeText,\n              expandable: false,\n            },\n          });\n        }\n        // add template variables\n        const variables = datasource.templateSrv.getVariables();\n        each(variables, (variable: VariableModel) => {\n          let selectableValue: SelectableValue<PIWebAPISelectableValue> = {\n            label: '${' + variable.name + '}',\n            value: {\n              type: 'template',\n              value: '${' + variable.name + '}',\n              expandable: !query.isPiPoint,\n            },\n          };\n          segments.unshift(selectableValue);\n        });\n        segments.unshift({\n          label: REMOVE_LABEL,\n          value: {\n            value: REMOVE_LABEL,\n          },\n        });\n        return segments;\n      })\n      .catch((err: any) => {\n        ctrl.error = err.message || 'Failed to issue metric query';\n        return segments;\n      });\n  };\n\n  // get the list of attributes for the user interface - AF\n  getAttributeSegmentsAF = (attributeText?: string): Array<SelectableValue<PIWebAPISelectableValue>> => {\n    const ctrl = this;\n    let segments: Array<SelectableValue<PIWebAPISelectableValue>> = [];\n\n    forOwn(ctrl.availableAttributes, (val: any, key: string) => {\n      let selectableValue: SelectableValue<PIWebAPISelectableValue> = {\n        label: key,\n        value: {\n          value: key,\n          expandable: true,\n        },\n      };\n      segments.push(selectableValue);\n    });\n\n    segments.unshift({\n      label: REMOVE_LABEL,\n      value: {\n        value: REMOVE_LABEL,\n      },\n    });\n\n    return segments;\n  };\n\n  // build data from target string\n  buildFromTarget = (\n    query: PIWebAPIQuery,\n    segmentsArray: Array<SelectableValue<PIWebAPISelectableValue>>,\n    attributesArray: Array<SelectableValue<PIWebAPISelectableValue>>\n  ) => {\n    const splitAttributes = query.target.split(';');\n    const splitElements = splitAttributes.length > 0 ? splitAttributes[0].split('\\\\') : [];\n\n    if (splitElements.length > 1 || (splitElements.length === 1 && splitElements[0] !== '')) {\n      // remove element hierarchy from attribute collection\n      splitAttributes.splice(0, 1);\n\n      each(splitElements, (item, _) => {\n        segmentsArray.push({\n          label: item,\n          value: {\n            type: item.match(/\\${\\w+}/gi) ? 'template' : undefined,\n            value: item,\n            expandable: true,\n          },\n        });\n      });\n      each(splitAttributes, (item, _) => {\n        if (item !== '') {\n          // set current value\n          attributesArray.push({\n            label: item,\n            value: {\n              value: item,\n              expandable: false,\n            },\n          });\n        }\n      });\n      return this.getElementSegments(splitElements.length + 1, segmentsArray).then((elements) => {\n        if (elements.length > 0) {\n          segmentsArray.push({\n            label: 'Select Element',\n            value: {\n              value: '-Select Element-',\n            },\n          });\n        }\n        return segmentsArray;\n      });\n    }\n    return Promise.resolve(segmentsArray);\n  };\n\n  /**\n   * Gets the segment information and parses it to a string.\n   *\n   * @param {any} index - Last index of segment to use.\n   * @returns - AF Path or PI Point name.\n   *\n   * @memberOf PIWebAPIQueryEditor\n   */\n  getSegmentPathUpTo(segments: Array<SelectableValue<PIWebAPISelectableValue>>, index: number): string {\n    const arr = segments.slice(0, index);\n\n    return reduce(\n      arr,\n      (result: any, segment: SelectableValue<PIWebAPISelectableValue>) => {\n        if (!segment.value) {\n          return '';\n        }\n        if (!segment.value.value?.startsWith('-Select')) {\n          return result ? result + '\\\\' + segment.value.value : segment.value.value;\n        }\n        return result;\n      },\n      ''\n    );\n  }\n\n  /**\n   * Get the current AF Element's child attributes. Validates when the element selection changes.\n   *\n   * @returns - Collection of attributes.\n   *\n   * @memberOf PIWebAPIQueryEditor\n   */\n  checkAttributeSegments(\n    attributes: Array<SelectableValue<PIWebAPISelectableValue>>,\n    segments: Array<SelectableValue<PIWebAPISelectableValue>>\n  ): Promise<any> {\n    const { datasource, data } = this.props;\n    const ctrl = this;\n    const findQuery = {\n      path: this.getSegmentPathUpTo(segments.slice(0), segments.length),\n      type: 'attributes',\n    };\n    return datasource\n      .metricFindQuery(findQuery, Object.assign(data?.request?.scopedVars ?? {}, { isPiPoint: false }))\n      .then((attributesResponse: any) => {\n        const validAttributes: any = {};\n\n        each(attributesResponse, (attribute: any) => {\n          validAttributes[attribute.Path.substring(attribute.Path.indexOf('|') + 1)] = attribute.WebId;\n        });\n\n        const filteredAttributes = filter(attributes, (attrib: SelectableValue<PIWebAPISelectableValue>) => {\n          const changedValue = datasource.templateSrv.replace(attrib.value?.value);\n          return validAttributes[changedValue] !== undefined;\n        });\n\n        ctrl.availableAttributes = validAttributes;\n        this.attributeChangeValue(filteredAttributes);\n      })\n      .catch((err: any) => {\n        ctrl.error = err.message || 'Failed to issue metric query';\n        this.attributeChangeValue(attributes);\n      });\n  }\n\n  /**\n   * Get PI points from server.\n   *\n   * @returns - Collection of attributes.\n   *\n   * @memberOf PIWebAPIQueryEditor\n   */\n  checkPiPointSegments(\n    attribute: SelectableValue<PIWebAPISelectableValue>,\n    attributes: Array<SelectableValue<PIWebAPISelectableValue>>\n  ) {\n    const { datasource, data } = this.props;\n    const ctrl = this;\n    const findQuery = {\n      path: attribute.path,\n      webId: ctrl.getSelectedPIServer(),\n      pointName: attribute.label,\n      type: 'pipoint',\n    };\n    return datasource\n      .metricFindQuery(findQuery, Object.assign(data?.request?.scopedVars ?? {}, { isPiPoint: true }))\n      .then(() => {\n        ctrl.attributeChangeValue(attributes);\n      })\n      .catch((err: any) => {\n        ctrl.error = err.message || 'Failed to issue metric query';\n        ctrl.attributeChangeValue([]);\n      });\n  }\n\n  /**\n   * Gets the webid of the current selected pi data server.\n   *\n   * @memberOf PIWebAPIQueryEditor\n   */\n  getSelectedPIServer() {\n    let webID = '';\n\n    this.piServer.forEach((s) => {\n      const parts = this.props.query.target.split(';');\n      if (parts.length >= 2) {\n        if (parts[0] === s.text) {\n          webID = s.WebId;\n          return;\n        }\n      }\n    });\n    return this.piServer.length > 0 ? this.piServer[0].value?.webId : webID;\n  }\n\n  /**\n   * Queries PI Web API for child elements and attributes when the raw query text editor is changed.\n   *\n   * @memberOf PIWebAPIQueryEditor\n   */\n  textEditorChanged() {\n    const { query, onChange } = this.props;\n    const splitAttributes = query.target.split(';');\n    const splitElements = splitAttributes.length > 0 ? splitAttributes[0].split('\\\\') : [];\n\n    let segments: Array<SelectableValue<PIWebAPISelectableValue>> = [];\n    let attributes: Array<SelectableValue<PIWebAPISelectableValue>> = [];\n\n    if (splitElements.length > 1 || (splitElements.length === 1 && splitElements[0] !== '')) {\n      // remove element hierarchy from attribute collection\n      splitAttributes.splice(0, 1);\n\n      each(splitElements, (item, _) => {\n        segments.push({\n          label: item,\n          value: {\n            type: item.match(/\\${\\w+}/gi) ? 'template' : undefined,\n            value: item,\n            expandable: true,\n          },\n        });\n      });\n      each(splitAttributes, function (item, index) {\n        if (item !== '') {\n          attributes.push({\n            label: item,\n            value: {\n              value: item,\n              expandable: false,\n            },\n          });\n        }\n      });\n      this.getElementSegments(splitElements.length + 1, segments)\n        .then((elements) => {\n          if (elements.length > 0) {\n            segments.push({\n              label: 'Select Element',\n              value: {\n                value: '-Select Element-',\n              },\n            });\n          }\n        })\n        .then(() => {\n          this.updateArray(segments, attributes, this.state.summaries, query.isPiPoint, () => {\n            onChange({ ...query, query: undefined, rawQuery: false });\n          });\n        });\n    } else {\n      segments = this.checkAfServer();\n      this.updateArray(segments, this.state.attributes, this.state.summaries, query.isPiPoint, () => {\n        this.onChange({\n          ...query,\n          query: undefined,\n          rawQuery: false,\n          attributes: this.state.attributes,\n          segments: this.state.segments,\n        });\n      });\n    }\n  }\n\n  /**\n   * Check if the AF server and database are configured in the datasoure config.\n   *\n   * @returns the segments array\n   *\n   * @memberOf PIWebAPIQueryEditor\n   */\n  checkAfServer = () => {\n    const { datasource } = this.props;\n    const segmentsArray = [];\n    if (datasource.afserver?.name) {\n      segmentsArray.push({\n        label: datasource.afserver.name,\n        value: {\n          value: datasource.afserver.name,\n          expandable: true,\n        },\n      });\n      if (datasource.afdatabase?.name) {\n        segmentsArray.push({\n          label: datasource.afdatabase.name,\n          value: {\n            value: datasource.afdatabase.name,\n            expandable: true,\n          },\n        });\n      }\n      segmentsArray.push({\n        label: 'Select Element',\n        value: {\n          value: '-Select Element-',\n        },\n      });\n    } else {\n      segmentsArray.push({\n        label: '',\n      });\n    }\n    return segmentsArray;\n  };\n\n  /**\n   * Update the internal state of the datasource.\n   *\n   * @param segmentsArray the segments array to update\n   * @param attributesArray the AF attributes array to update\n   * @param summariesArray the summaries array to update\n   * @param isPiPoint the is PI point flag\n   * @param cb optional callback function\n   *\n   * @memberOf PIWebAPIQueryEditor\n   */\n  updateArray = (\n    segmentsArray: Array<SelectableValue<PIWebAPISelectableValue>>,\n    attributesArray: Array<SelectableValue<PIWebAPISelectableValue>>,\n    summariesArray: Array<SelectableValue<PIWebAPISelectableValue>>,\n    isPiPoint: boolean,\n    cb?: (() => void) | undefined\n  ) => {\n    this.setState(\n      {\n        segments: segmentsArray,\n        attributes: attributesArray,\n        summaries: summariesArray,\n        isPiPoint,\n      },\n      () => {\n        if (!isPiPoint) {\n          this.checkAttributeSegments(attributesArray, this.state.segments).then(() => {\n            if (cb) {\n              cb();\n            }\n          })\n        }\n      }\n    );\n  };\n\n  // React action when component is initialized/updated\n  scopedVarsDone = false;\n  componentDidMount = () => {\n    this.initialLoad(false);\n  };\n\n  componentDidUpdate = () => {\n    const { query } = this.props;\n    if (this.props.data?.state === 'Done' && !!this.props.data?.request?.scopedVars && !this.scopedVarsDone) {\n      this.scopedVarsDone = true;\n      this.initialLoad(!query.isPiPoint);\n    }\n  };\n\n  initialLoad = (force: boolean) => {\n    const { query } = this.props;\n    const metricsQuery = defaults(query, defaultQuery) as PIWebAPIQuery;\n    const { segments, attributes, summary, isPiPoint } = metricsQuery;\n\n    let segmentsArray: Array<SelectableValue<PIWebAPISelectableValue>> = force ? [] : segments?.slice(0) ?? [];\n    let attributesArray: Array<SelectableValue<PIWebAPISelectableValue>> = force ? [] : attributes?.slice(0) ?? [];\n    let summariesArray = summary?.types ?? [];\n\n    if (!isPiPoint && segmentsArray.length === 0) {\n      if (query.target && query.target.length > 0 && query.target !== ';') {\n        attributesArray = [];\n        // Build query from target\n        this.buildFromTarget(query, segmentsArray, attributesArray)\n          .then((_segmentsArray) => {\n            this.updateArray(_segmentsArray, attributesArray, summariesArray, isPiPoint);\n          })\n          .catch((e) => console.error(e));\n        return;\n      } else {\n        segmentsArray = this.checkAfServer();\n      }\n    } else if (isPiPoint && segmentsArray.length > 0) {\n      this.piServer = segmentsArray;\n    }\n    this.updateArray(segmentsArray, attributesArray, summariesArray, isPiPoint, () => {\n      this.onChange(query);\n    });\n  };\n\n  onChange = (query: PIWebAPIQuery) => {\n    const { onChange, onRunQuery } = this.props;\n\n    query.summary.types = this.state.summaries;\n    if (query.rawQuery) {\n      query.target = query.query ?? '';\n    } else {\n      query.elementPath = this.getSegmentPathUpTo(this.state.segments, this.state.segments.length);\n      query.target =\n        query.elementPath +\n        ';' +\n        join(\n          query.attributes.map((s) => s.value?.value),\n          ';'\n        );\n    }\n\n    onChange(query);\n\n    if (query.target && query.target.length > 0) {\n      onRunQuery();\n    }\n  };\n\n  stateCallback = () => {\n    const query = this.props.query as PIWebAPIQuery;\n    this.onChange(query);\n  };\n\n  onIsPiPointChange = (event: React.SyntheticEvent<HTMLInputElement>) => {\n    const { query: queryChange } = this.props;\n    const isPiPoint = !queryChange.isPiPoint;\n    this.setState(\n      {\n        segments: isPiPoint ? [{ label: '' }] : this.checkAfServer(),\n        attributes: [],\n        isPiPoint,\n      },\n      () => {\n        this.onChange({\n          ...queryChange,\n          expression: '',\n          attributes: this.state.attributes,\n          segments: this.state.segments,\n          isPiPoint,\n        });\n      }\n    );\n  };\n\n  render() {\n    const { query: queryProps, onChange, onRunQuery } = this.props;\n    const metricsQuery = defaults(queryProps, defaultQuery) as PIWebAPIQuery;\n    const {\n      useLastValue,\n      interpolate,\n      query,\n      rawQuery,\n      digitalStates,\n      recordedValues,\n      expression,\n      isPiPoint,\n      summary,\n      display,\n      regex,\n    } = metricsQuery;\n\n    return (\n      <>\n        {this.props.datasource.piPointConfig && (\n          <InlineField label=\"Is Pi Point?\" labelWidth={LABEL_WIDTH}>\n            <InlineSwitch value={isPiPoint} onChange={this.onIsPiPointChange} />\n          </InlineField>\n        )}\n\n        {!!rawQuery && (\n          <InlineFieldRow>\n            <InlineField label=\"Raw Query\" labelWidth={LABEL_WIDTH} grow={true}>\n              <Input\n                onBlur={this.stateCallback}\n                value={query}\n                onChange={(event: ChangeEvent<HTMLInputElement>) =>\n                  onChange({ ...metricsQuery, query: event.target.value })\n                }\n                placeholder=\"enter query\"\n              />\n            </InlineField>\n            <QueryEditorModeSwitcher isRaw={true} onChange={(value: boolean) => this.textEditorChanged()} />\n          </InlineFieldRow>\n        )}\n\n        {!rawQuery && (\n          <>\n            <div className=\"gf-form-inline\">\n              <QueryRawInlineField\n                label={isPiPoint ? 'PI Server' : 'AF Elements'}\n                tooltip={isPiPoint ? 'Select PI server.' : 'Select AF Element.'}\n              >\n                {this.state.segments.map((segment: SelectableValue<PIWebAPISelectableValue>, index: number) => {\n                  return (\n                    <SegmentAsync\n                      key={'element-' + index}\n                      Component={<CustomLabelComponent value={segment.value} label={segment.label} />}\n                      onChange={(item) => this.onSegmentChange(item, index)}\n                      loadOptions={(query?: string | undefined) => {\n                        return this.getElementSegments(index);\n                      }}\n                      allowCustomValue\n                      inputMinWidth={MIN_ELEM_INPUT_WIDTH}\n                    />\n                  );\n                })}\n                <QueryRowTerminator />\n                {!isPiPoint && (\n                  <QueryEditorModeSwitcher\n                    isRaw={false}\n                    onChange={(value: boolean) => {\n                      onChange({ ...metricsQuery, query: metricsQuery.target, rawQuery: value });\n                    }}\n                  />\n                )}\n              </QueryRawInlineField>\n            </div>\n\n            <QueryInlineField label={isPiPoint ? 'Pi Points' : 'Attributes'}>\n              {this.state.attributes.map((attribute: SelectableValue<PIWebAPISelectableValue>, index: number) => {\n                if (isPiPoint) {\n                  return (\n                    <SegmentAsync\n                      key={'attributes-' + index}\n                      Component={<CustomLabelComponent value={attribute.value} label={attribute.label} />}\n                      disabled={this.piServer.length === 0}\n                      onChange={(item) => this.onPiPointChange(item, index)}\n                      loadOptions={this.getAttributeSegmentsPI}\n                      reloadOptionsOnChange\n                      allowCustomValue\n                      inputMinWidth={MIN_ATTR_INPUT_WIDTH}\n                    />\n                  );\n                }\n                return (\n                  <Segment\n                    key={'attributes-' + index}\n                    Component={<CustomLabelComponent value={attribute.value} label={attribute.label} />}\n                    disabled={this.state.segments.length <= 2}\n                    onChange={(item) => this.onAttributeChange(item, index)}\n                    options={this.getAttributeSegmentsAF()}\n                    allowCustomValue\n                    inputMinWidth={MIN_ATTR_INPUT_WIDTH}\n                  />\n                );\n              })}\n\n              {isPiPoint && (\n                <SegmentAsync\n                  Component={\n                    <CustomLabelComponent\n                      value={this.state.attributeSegment.value}\n                      label={this.state.attributeSegment.label}\n                    />\n                  }\n                  disabled={this.piServer.length === 0}\n                  onChange={this.onAttributeAction}\n                  loadOptions={this.getAttributeSegmentsPI}\n                  reloadOptionsOnChange\n                  allowCustomValue\n                  inputMinWidth={MIN_ATTR_INPUT_WIDTH}\n                />\n              )}\n              {!isPiPoint && (\n                <Segment\n                  Component={\n                    <CustomLabelComponent\n                      value={this.state.attributeSegment.value}\n                      label={this.state.attributeSegment.label}\n                    />\n                  }\n                  disabled={this.state.segments.length <= 2}\n                  onChange={this.onAttributeAction}\n                  options={this.getAttributeSegmentsAF()}\n                  allowCustomValue\n                  inputMinWidth={MIN_ATTR_INPUT_WIDTH}\n                />\n              )}\n            </QueryInlineField>\n          </>\n        )}\n\n        <InlineFieldRow>\n          <InlineField label=\"Use Last Value\" labelWidth={LABEL_WIDTH}>\n            <InlineSwitch\n              value={useLastValue.enable}\n              onChange={() =>\n                this.onChange({\n                  ...metricsQuery,\n                  useLastValue: { ...useLastValue, enable: !useLastValue.enable },\n                })\n              }\n            />\n          </InlineField>\n        </InlineFieldRow>\n\n        {!useLastValue.enable && (\n          <>\n            <InlineField\n              label=\"Calculation\"\n              labelWidth={LABEL_WIDTH}\n              tooltip={\n                \"Modify all attributes by an equation. Use '.' for current item. Leave Attributes empty if you wish to perform element based calculations.\"\n              }\n            >\n              <Input\n                onBlur={onRunQuery}\n                value={expression}\n                onChange={(event: ChangeEvent<HTMLInputElement>) =>\n                  onChange({ ...metricsQuery, expression: event.target.value })\n                }\n                placeholder=\"'.'*2\"\n              />\n            </InlineField>\n\n            <InlineFieldRow>\n              <InlineField\n                label=\"Max Recorded Values\"\n                labelWidth={LABEL_WIDTH}\n                tooltip={'Maximum number of recorded value to retrive from the data archive, without using interpolation.'}\n              >\n                <Input\n                  onBlur={onRunQuery}\n                  value={recordedValues.maxNumber}\n                  onChange={(event: ChangeEvent<HTMLInputElement>) =>\n                    onChange({\n                      ...metricsQuery,\n                      recordedValues: { ...recordedValues, maxNumber: parseInt(event.target.value, 10) },\n                    })\n                  }\n                  type=\"number\"\n                  placeholder=\"1000\"\n                />\n              </InlineField>\n              <InlineField label=\"Recorded Values\" labelWidth={LABEL_WIDTH}>\n                <InlineSwitch\n                  value={recordedValues.enable}\n                  onChange={() =>\n                    this.onChange({\n                      ...metricsQuery,\n                      recordedValues: { ...recordedValues, enable: !recordedValues.enable },\n                    })\n                  }\n                />\n              </InlineField>\n              <InlineField label=\"Digital States\" labelWidth={LABEL_WIDTH}>\n                <InlineSwitch\n                  value={digitalStates.enable}\n                  onChange={() =>\n                    this.onChange({ ...metricsQuery, digitalStates: { ...digitalStates, enable: !digitalStates.enable } })\n                  }\n                />\n              </InlineField>\n            </InlineFieldRow>\n\n            <InlineFieldRow>\n              <InlineField\n                label=\"Interpolate Period\"\n                labelWidth={LABEL_WIDTH}\n                tooltip={\"Override time in seconds between sampling, e.g. '30'. Defaults to timespan/chart width.\"}\n              >\n                <Input\n                  onBlur={onRunQuery}\n                  value={interpolate.interval}\n                  onChange={(event: ChangeEvent<HTMLInputElement>) =>\n                    onChange({ ...metricsQuery, interpolate: { ...interpolate, interval: event.target.value } })\n                  }\n                  placeholder=\"30\"\n                />\n              </InlineField>\n              <InlineField label=\"Interpolate\" labelWidth={LABEL_WIDTH}>\n                <InlineSwitch\n                  value={interpolate.enable}\n                  onChange={() =>\n                    this.onChange({ ...metricsQuery, interpolate: { ...interpolate, enable: !interpolate.enable } })\n                  }\n                />\n              </InlineField>\n              <InlineField\n                label=\"Replace Bad Data\"\n                labelWidth={LABEL_WIDTH}\n                tooltip={'Replacement for bad quality values.'}\n              >\n                <Segment\n                  Component={<CustomLabelComponent value={{ value: summary.nodata }} label={summary.nodata} />}\n                  onChange={this.calcNoDataValueChanged}\n                  options={this.getNoDataSegments()}\n                  allowCustomValue\n                />\n              </InlineField>\n            </InlineFieldRow>\n\n            <InlineFieldRow>\n              <InlineField\n                label=\"Summary Period\"\n                labelWidth={LABEL_WIDTH}\n                tooltip={\"Override time between sampling, e.g. '30s'.\"}\n              >\n                <Input\n                  onBlur={onRunQuery}\n                  value={summary.interval}\n                  onChange={(event: ChangeEvent<HTMLInputElement>) =>\n                    onChange({ ...metricsQuery, summary: { ...summary, interval: event.target.value } })\n                  }\n                  placeholder=\"30s\"\n                />\n              </InlineField>\n              <InlineField\n                label=\"Basis\"\n                labelWidth={LABEL_WIDTH}\n                tooltip={\n                  'Defines the possible calculation options when performing summary calculations over time-series data.'\n                }\n              >\n                <Segment\n                  Component={<CustomLabelComponent value={{ value: summary.basis }} label={summary.basis} />}\n                  onChange={this.calcBasisValueChanged}\n                  options={this.getCalcBasisSegments()}\n                  allowCustomValue\n                />\n              </InlineField>\n              <InlineField label=\"Summaries\" labelWidth={LABEL_WIDTH} tooltip={'Replacement for bad quality values.'}>\n                <InlineFieldRow>\n                  {this.state.summaries.map((s: SelectableValue<PIWebAPISelectableValue>, index: number) => {\n                    return (\n                      <Segment\n                        key={'summaries-' + index}\n                        Component={<CustomLabelComponent value={s.value} label={s.label} />}\n                        onChange={(item) => this.onSummaryValueChanged(item, index)}\n                        options={this.getSummarySegments()}\n                        allowCustomValue\n                      />\n                    );\n                  })}\n                  <Segment\n                    Component={\n                      <CustomLabelComponent\n                        value={this.state.summarySegment.value}\n                        label={this.state.summarySegment.label}\n                      />\n                    }\n                    onChange={this.onSummaryAction}\n                    options={this.getSummarySegments()}\n                    allowCustomValue\n                  />\n                </InlineFieldRow>\n              </InlineField>\n            </InlineFieldRow>\n          </>\n        )}\n\n        <InlineFieldRow>\n          <InlineField\n            label=\"Display Name\"\n            labelWidth={LABEL_WIDTH}\n            tooltip={'If single attribute, modify display name. Otherwise use regex to modify display name.'}\n          >\n            <Input\n              onBlur={onRunQuery}\n              value={display}\n              onChange={(event: ChangeEvent<HTMLInputElement>) =>\n                onChange({ ...metricsQuery, display: event.target.value })\n              }\n              placeholder=\"Display\"\n            />\n          </InlineField>\n          <InlineField label=\"Enable Regex Replace\" labelWidth={LABEL_WIDTH}>\n            <InlineSwitch\n              value={regex.enable}\n              onChange={() => {\n                this.onChange({ ...metricsQuery, regex: { ...regex, enable: !regex.enable } });\n              }}\n            />\n          </InlineField>\n          <InlineField label=\"Search\" labelWidth={LABEL_WIDTH - 8}>\n            <Input\n              onBlur={onRunQuery}\n              value={regex.search}\n              onChange={(event: ChangeEvent<HTMLInputElement>) =>\n                onChange({ ...metricsQuery, regex: { ...regex, search: event.target.value } })\n              }\n              placeholder=\"(.*)\"\n            />\n          </InlineField>\n          <InlineField label=\"Replace\" labelWidth={LABEL_WIDTH - 8}>\n            <Input\n              onBlur={onRunQuery}\n              value={regex.replace}\n              onChange={(event: ChangeEvent<HTMLInputElement>) =>\n                onChange({ ...metricsQuery, regex: { ...regex, replace: event.target.value } })\n              }\n              placeholder=\"$1\"\n            />\n          </InlineField>\n        </InlineFieldRow>\n      </>\n    );\n  }\n}\n","import { each } from \"lodash\";\r\n\r\nimport {\r\n    DataFrame,\r\n    FieldConfig,\r\n    TimeSeries,\r\n    FieldType,\r\n    TimeSeriesValue,\r\n    TIME_SERIES_VALUE_FIELD_NAME,\r\n    TIME_SERIES_TIME_FIELD_NAME,\r\n    ArrayVector,\r\n} from \"@grafana/data\";\r\nimport { PiwebapiElementPath, PiwebapiRsp } from \"types\";\r\n\r\nexport function parseRawQuery(tr: string): any {\r\n    const splitAttributes = tr.split(';');\r\n    const splitElements = splitAttributes[0].split('\\\\');\r\n\r\n    // remove element hierarchy from attribute collection\r\n    splitAttributes.splice(0, 1);\r\n\r\n    let attributes: any[] = [];\r\n    if (splitElements.length > 1 || (splitElements.length === 1 && splitElements[0] !== '')) {\r\n        const elementPath: string = splitElements.join('\\\\');\r\n        each(splitAttributes, function (item, index) {\r\n            if (item !== '') {\r\n                attributes.push({\r\n                    label: item,\r\n                    value: {\r\n                        value: item,\r\n                        expandable: false,\r\n                    },\r\n                });\r\n            }\r\n        });\r\n\r\n        return { attributes, elementPath };\r\n    }\r\n\r\n    return { attributes, elementPath: null };\r\n}\r\n\r\nexport function lowerCaseFirstLetter(string: string): string {\r\n    return string.charAt(0).toLocaleLowerCase() + string.slice(1);\r\n}\r\n\r\nexport function convertTimeSeriesToDataFrame(timeSeries: TimeSeries): DataFrame {\r\n    const times: number[] = [];\r\n    const values: TimeSeriesValue[] = [];\r\n\r\n    // Sometimes the points are sent as datapoints\r\n    const points = timeSeries.datapoints;\r\n    for (const point of points) {\r\n        values.push(point[0]);\r\n        times.push(point[1] as number);\r\n    }\r\n\r\n    const fields = [\r\n        {\r\n            name: TIME_SERIES_TIME_FIELD_NAME,\r\n            type: FieldType.time,\r\n            config: {},\r\n            values: new ArrayVector<number>(times),\r\n        },\r\n        {\r\n            name: timeSeries.target ?? TIME_SERIES_VALUE_FIELD_NAME,\r\n            type: FieldType.number,\r\n            config: {\r\n                unit: timeSeries.unit,\r\n            },\r\n            values: new ArrayVector<TimeSeriesValue>(values),\r\n            labels: timeSeries.tags,\r\n        },\r\n    ];\r\n\r\n    if (timeSeries.title) {\r\n        (fields[1].config as FieldConfig).displayNameFromDS = timeSeries.title;\r\n    }\r\n\r\n    return {\r\n        name: '',\r\n        refId: timeSeries.refId,\r\n        meta: timeSeries.meta,\r\n        fields,\r\n        length: values.length,\r\n    };\r\n}\r\n\r\n\r\n/**\r\n * Resolve PIWebAPI response 'value' data to value - timestamp pairs.\r\n *\r\n * @param {any} item - 'Item' object from PIWebAPI\r\n * @param {any} noDataReplacementMode - String state of how to replace 'No Data'\r\n * @param {any} grafanaDataPoint - Single Grafana value pair (value, timestamp).\r\n * @returns grafanaDataPoint - Single Grafana value pair (value, timestamp).\r\n * @returns perviousValue - {any} Grafana value (value only).\r\n *\r\n */\r\nexport function noDataReplace(\r\n    item: any,\r\n    noDataReplacementMode: any,\r\n    grafanaDataPoint: any[]\r\n): {\r\n    grafanaDataPoint: any[];\r\n    previousValue: any;\r\n    drop: boolean;\r\n} {\r\n    let previousValue = null;\r\n    let drop = false;\r\n    if (!item.Good || item.Value === 'No Data' || (item.Value?.Name && item.Value?.Name === 'No Data')) {\r\n        if (noDataReplacementMode === 'Drop') {\r\n            drop = true;\r\n        } else if (noDataReplacementMode === '0') {\r\n            grafanaDataPoint[0] = 0;\r\n        } else if (noDataReplacementMode === 'Keep') {\r\n            // Do nothing keep\r\n        } else if (noDataReplacementMode === 'Null') {\r\n            grafanaDataPoint[0] = null;\r\n        } else if (noDataReplacementMode === 'Previous' && previousValue !== null) {\r\n            grafanaDataPoint[0] = previousValue;\r\n        }\r\n    } else {\r\n        previousValue = item.Value;\r\n    }\r\n    return { grafanaDataPoint, previousValue, drop };\r\n}\r\n\r\n/**\r\n * Check if the value is a number.\r\n *\r\n * @param {any} number the value to check\r\n * @returns {boolean} true if the value is a number, false otherwise\r\n */\r\nexport function checkNumber(number: any): boolean {\r\n    return typeof number === 'number' && !Number.isNaN(number) && Number.isFinite(number);\r\n}\r\n\r\n/**\r\n * Returns the last item of the element path.\r\n *\r\n * @param {string} path element path\r\n * @returns {string} last item of the element path\r\n */\r\nexport function getLastPath(path: string): string {\r\n    let splitPath = path.split('|');\r\n    if (splitPath.length === 0) {\r\n        return '';\r\n    }\r\n    splitPath = splitPath[0].split('\\\\');\r\n    return splitPath.length === 0 ? '' : splitPath.pop() ?? '';\r\n}\r\n\r\n/**\r\n * Returns the last item of the element path plus variable.\r\n *\r\n * @param {PiwebapiElementPath[]} elementPathArray array of element paths\r\n * @param {string} path element path\r\n * @returns {string} last item of the element path\r\n */\r\nexport function getPath(elementPathArray: PiwebapiElementPath[], path: string): string {\r\n    const splitStr = getLastPath(path);\r\n    if (elementPathArray.length === 0) {\r\n        return '';\r\n    }\r\n    const foundElement = elementPathArray.find((e) => path.indexOf(e.path) >= 0)?.variable;\r\n    return foundElement ? foundElement + '|' + splitStr : splitStr;\r\n}\r\n\r\n/**\r\n * Replace calculation dot in expression with PI point name.\r\n *\r\n * @param {boolean} replace - is pi point and calculation.\r\n * @param {PiwebapiRsp} webid - Pi web api response object.\r\n * @param {string} url - original url. \r\n * @returns Modified url\r\n */\r\nexport function getFinalUrl(replace: boolean, webid: PiwebapiRsp, url: string) {\r\n    const newUrl = (replace ? url.replace(/'\\.'/g, `'${webid.Name}'`) : url);\r\n    return newUrl;\r\n}\r\n","import { curry, each, filter, flatten, forOwn, groupBy, keys, map, uniq, omitBy } from 'lodash';\n\nimport {\n  DataQueryRequest,\n  DataQueryResponse,\n  DataSourceApi,\n  DataSourceInstanceSettings,\n  AnnotationEvent,\n  MetricFindValue,\n  Labels,\n} from '@grafana/data';\nimport { BackendSrv, getBackendSrv, getTemplateSrv, TemplateSrv } from '@grafana/runtime';\n\nimport {\n  PIWebAPIQuery,\n  PIWebAPIDataSourceJsonData,\n  PiDataServer,\n  PiwebapTargetRsp,\n  PiwebapiElementPath,\n  PiwebapiInternalRsp,\n  PiwebapiRsp,\n} from './types';\nimport {\n  checkNumber,\n  convertTimeSeriesToDataFrame,\n  getFinalUrl,\n  getLastPath,\n  getPath,\n  lowerCaseFirstLetter,\n  noDataReplace,\n  parseRawQuery,\n} from 'helper';\n\nexport class PiWebAPIDatasource extends DataSourceApi<PIWebAPIQuery, PIWebAPIDataSourceJsonData> {\n  piserver: PiDataServer;\n  afserver: PiDataServer;\n  afdatabase: PiDataServer;\n  piPointConfig: boolean;\n  newFormatConfig: boolean;\n\n  basicAuth?: string;\n  withCredentials?: boolean;\n  url: string;\n  name: string;\n  isProxy = false;\n\n  templateSrv: TemplateSrv;\n  backendSrv: BackendSrv;\n\n  piwebapiurl?: string;\n  webidCache: Map<String, any> = new Map();\n\n  error: any;\n\n  constructor(instanceSettings: DataSourceInstanceSettings<PIWebAPIDataSourceJsonData>) {\n    super(instanceSettings);\n    this.basicAuth = instanceSettings.basicAuth;\n    this.withCredentials = instanceSettings.withCredentials;\n    this.url = instanceSettings.url!;\n    this.name = instanceSettings.name;\n    this.templateSrv = getTemplateSrv();\n    this.backendSrv = getBackendSrv();\n\n    this.piwebapiurl = instanceSettings.jsonData.url?.toString();\n    this.isProxy = /^http(s)?:\\/\\//.test(this.url) || instanceSettings.jsonData.access === 'proxy';\n\n    this.piserver = { name: (instanceSettings.jsonData || {}).piserver, webid: undefined };\n    this.afserver = { name: (instanceSettings.jsonData || {}).afserver, webid: undefined };\n    this.afdatabase = { name: (instanceSettings.jsonData || {}).afdatabase, webid: undefined };\n    this.piPointConfig = instanceSettings.jsonData.pipoint || false;\n    this.newFormatConfig = instanceSettings.jsonData.newFormat || false;\n\n    console.info('OSISoft PI Plugin v4.0.0');\n    Promise.all([\n      this.getDataServer(this.piserver.name).then((result: PiwebapiRsp) => (this.piserver.webid = result.WebId)),\n      this.getAssetServer(this.afserver.name).then((result: PiwebapiRsp) => (this.afserver.webid = result.WebId)),\n      this.getDatabase(this.afserver.name ? this.afserver.name + '\\\\' + this.afdatabase.name : undefined).then(\n        (result: PiwebapiRsp) => (this.afdatabase.webid = result.WebId)\n      ),\n    ]).then(() => console.info('Datasource configured'));\n  }\n\n  /**\n   * Converts a PIWebAPI Event Frame response to a Grafana Annotation\n   *\n   * @param {any} annotationOptions - Options data from configuration panel.\n   * @param {any} endTime - End time of the Event Frame.\n   * @param {any} eventFrame - The Event Frame data.\n   * @returns - Grafana Annotation\n   *\n   * @memberOf PiWebApiDatasource\n   */\n  private eventFrameToAnnotation(\n    annotationOptions: any,\n    endTime: any,\n    eventFrame: any,\n    attributeDataItems: any\n  ): AnnotationEvent {\n    if (annotationOptions.regex && annotationOptions.regex.enable) {\n      eventFrame.Name = eventFrame.Name.replace(\n        new RegExp(annotationOptions.regex.search),\n        annotationOptions.regex.replace\n      );\n    }\n\n    let attributeText = '';\n    if (attributeDataItems) {\n      each(attributeDataItems, (attributeData: any) => {\n        const attributeValue = attributeData.Value.Value\n          ? attributeData.Value.Value.Name || attributeData.Value.Value.Value || attributeData.Value.Value\n          : null;\n        attributeText += '<br />' + attributeData.Name + ': ' + attributeValue;\n      });\n    }\n    return {\n      annotation: annotationOptions,\n      title: (endTime ? 'END ' : annotationOptions.showEndTime ? 'START ' : '') + annotationOptions.name,\n      time: new Date(endTime ? eventFrame.EndTime : eventFrame.StartTime).getTime(),\n      text:\n        eventFrame.Name + attributeText + '<br />Start: ' + eventFrame.StartTime + '<br />End: ' + eventFrame.EndTime,\n    };\n  }\n\n  /**\n   * Builds the PIWebAPI query parameters.\n   *\n   * @param {any} options - Grafana query and panel options.\n   * @returns - PIWebAPI query parameters.\n   *\n   * @memberOf PiWebApiDatasource\n   */\n  private buildQueryParameters(options: DataQueryRequest<PIWebAPIQuery>) {\n    options.targets = filter(options.targets, (target) => {\n      if (!target || !target.target || !!target.hide) {\n        return false;\n      }\n      return !target.target.startsWith('Select AF');\n    });\n\n    options.targets = map(options.targets, (target) => {\n      if (!!target.rawQuery && !!target.target) {\n        const { attributes, elementPath } = parseRawQuery(this.templateSrv.replace(target.target, options.scopedVars));\n        target.attributes = attributes;\n        target.elementPath = elementPath;\n      }\n      const ds = this;\n      const tar = {\n        target: this.templateSrv.replace(target.elementPath, options.scopedVars),\n        elementPath: this.templateSrv.replace(target.elementPath, options.scopedVars),\n        elementPathArray: [\n          {\n            path: this.templateSrv.replace(target.elementPath, options.scopedVars),\n            variable: '',\n          } as PiwebapiElementPath,\n        ],\n        attributes: map(target.attributes, (att) =>\n          this.templateSrv.replace(att.value?.value || att, options.scopedVars)\n        ),\n        segments: map(target.segments, (att) => this.templateSrv.replace(att.value?.value, options.scopedVars)),\n        display: target.display,\n        refId: target.refId,\n        hide: target.hide,\n        interpolate: target.interpolate || { enable: false },\n        useLastValue: target.useLastValue || { enable: false },\n        recordedValues: target.recordedValues || { enable: false },\n        digitalStates: target.digitalStates || { enable: false },\n        webid: target.webid,\n        webids: target.webids || [],\n        regex: target.regex || { enable: false },\n        expression: target.expression || '',\n        summary: target.summary || { types: [] },\n        startTime: options.range.from,\n        endTime: options.range.to,\n        isPiPoint: target.isPiPoint,\n        scopedVars: options.scopedVars,\n      };\n\n      if (tar.expression) {\n        tar.expression = this.templateSrv.replace(tar.expression, options.scopedVars);\n      }\n\n      if (tar.summary.types !== undefined) {\n        tar.summary.types = filter(tar.summary.types, (item) => {\n          return item !== undefined && item !== null && item !== '';\n        });\n      }\n\n      // explode All or Multi-selection\n      const varsKeys = keys(options.scopedVars);\n      this.templateSrv.getVariables().forEach((v: any) => {\n        if (ds.isAllSelected(v.current) && varsKeys.indexOf(v.name) < 0) {\n          // All selection\n          const variables = v.options.filter((o: any) => !o.selected);\n          // attributes\n          tar.attributes = tar.attributes.map((attr: string) =>\n            variables.map((vv: any) =>\n              !!v.allValue ? attr.replace(v.allValue, vv.value) : attr.replace(/{[a-zA-z0-9,-_]+}/gi, vv.value)\n            )\n          );\n          tar.attributes = uniq(flatten(tar.attributes));\n          // elementPath\n          tar.elementPathArray = ds.getElementPath(tar.elementPathArray, variables, v.allValue);\n        } else if (Array.isArray(v.current.text) && varsKeys.indexOf(v.name) < 0) {\n          // Multi-selection\n          const variables = v.options.filter((o: any) => o.selected);\n          // attributes\n          const query = v.current.value.join(',');\n          tar.attributes = tar.attributes.map((attr: string) =>\n            variables.map((vv: any) => attr.replace(`{${query}}`, vv.value))\n          );\n          tar.attributes = uniq(flatten(tar.attributes));\n          // elementPath\n          tar.elementPathArray = ds.getElementPath(tar.elementPathArray, variables, `{${query}}`);\n        }\n      });\n\n      return tar;\n    });\n\n    return options;\n  }\n\n  /**\n   * Datasource Implementation. Primary entry point for data source.\n   * This takes the panel configuration and queries, sends them to PI Web API and parses the response.\n   *\n   * @param {any} options - Grafana query and panel options.\n   * @returns - Promise of data in the format for Grafana panels.\n   *\n   * @memberOf PiWebApiDatasource\n   */\n  async query(options: DataQueryRequest<PIWebAPIQuery>): Promise<DataQueryResponse> {\n    const ds = this;\n    const query = this.buildQueryParameters(options);\n\n    if (query.targets.length <= 0) {\n      return Promise.resolve({ data: [] });\n    } else {\n      return Promise.all(ds.getStream(query)).then((targetResponses) => {\n        let flattened: PiwebapTargetRsp[] = [];\n        each(targetResponses, (tr) => {\n          each(tr, (item) => flattened.push(item));\n        });\n        flattened = flattened.filter((v) => v.datapoints.length > 0);\n        // handle no data properly\n        if (flattened.length === 0) {\n          return { data: [] };\n        }\n        const response: DataQueryResponse = {\n          data: flattened\n            .sort((a, b) => {\n              return +(a.target > b.target) || +(a.target === b.target) - 1;\n            })\n            .map((d) => convertTimeSeriesToDataFrame(d)),\n        };\n        return response;\n      });\n    }\n  }\n\n  /**\n   * Datasource Implementation.\n   * Used for testing datasource in datasource configuration pange\n   *\n   * @returns - Success or failure message.\n   *\n   * @memberOf PiWebApiDatasource\n   */\n  testDatasource(): Promise<any> {\n    return this.backendSrv\n      .datasourceRequest({\n        url: this.url + '/',\n        method: 'GET',\n      })\n      .then((response: any) => {\n        if (response.status === 200) {\n          return { status: 'success', message: 'Data source is working', title: 'Success' };\n        }\n        throw new Error('Failed');\n      });\n  }\n\n  /**\n   * Datasource Implementation.\n   * This queries PI Web API for Event Frames and converts them into annotations.\n   *\n   * @param {any} options - Annotation options, usually the Event Frame Category.\n   * @returns - A Grafana annotation.\n   *\n   * @memberOf PiWebApiDatasource\n   */\n  annotationQuery(options: any): Promise<AnnotationEvent[]> {\n    if (!this.afdatabase.webid) {\n      return Promise.resolve([]);\n    }\n\n    const categoryName = options.annotation.query.categoryName\n      ? this.templateSrv.replace(options.annotation.query.categoryName, options.scopedVars, 'glob')\n      : null;\n    const nameFilter = options.annotation.query.nameFilter\n      ? this.templateSrv.replace(options.annotation.query.nameFilter, options.scopedVars, 'glob')\n      : null;\n    const templateName = options.annotation.template ? options.annotation.template.Name : null;\n    const annotationOptions = {\n      name: options.annotation.name,\n      datasource: options.annotation.datasource,\n      enable: options.annotation.enable,\n      iconColor: options.annotation.iconColor,\n      showEndTime: options.annotation.showEndTime,\n      regex: options.annotation.regex,\n      attribute: options.annotation.attribute,\n      categoryName: categoryName,\n      templateName: templateName,\n      nameFilter: nameFilter,\n    };\n\n    const filter = [];\n    if (!!annotationOptions.categoryName) {\n      filter.push('categoryName=' + annotationOptions.categoryName);\n    }\n    if (!!annotationOptions.nameFilter) {\n      filter.push('nameFilter=' + annotationOptions.nameFilter);\n    }\n    if (!!annotationOptions.templateName) {\n      filter.push('templateName=' + annotationOptions.templateName);\n    }\n    if (!filter.length) {\n      return Promise.resolve([]);\n    }\n    filter.push('startTime=' + options.range.from.toJSON());\n    filter.push('endTime=' + options.range.to.toJSON());\n\n    if (annotationOptions.attribute && annotationOptions.attribute.enable) {\n      let resourceUrl =\n        this.piwebapiurl + '/streamsets/{0}/value?selectedFields=Items.WebId%3BItems.Value%3BItems.Name';\n      if (!!annotationOptions.attribute.name) {\n        resourceUrl =\n          this.piwebapiurl +\n          '/streamsets/{0}/value?nameFilter=' +\n          annotationOptions.attribute.name +\n          '&selectedFields=Items.WebId%3BItems.Value%3BItems.Name';\n      }\n      const query: any = {};\n      query['1'] = {\n        Method: 'GET',\n        Resource: this.piwebapiurl + '/assetdatabases/' + this.afdatabase.webid + '/eventframes?' + filter.join('&'),\n      };\n      query['2'] = {\n        Method: 'GET',\n        RequestTemplate: {\n          Resource: resourceUrl,\n        },\n        Parameters: ['$.1.Content.Items[*].WebId'],\n        ParentIds: ['1'],\n      };\n      return this.restBatch(query).then((result: any) => {\n        const data = result.data['1'].Content;\n        const valueData = result.data['2'].Content;\n\n        const annotations = map(data.Items, (item: any, index: any) => {\n          return curry(this.eventFrameToAnnotation)(\n            annotationOptions,\n            false,\n            item,\n            valueData.Items[index].Content.Items\n          );\n        });\n\n        if (options.annotation.showEndTime) {\n          const ends = map(data.Items, (item: any, index: number) => {\n            return curry(this.eventFrameToAnnotation)(\n              annotationOptions,\n              true,\n              item,\n              valueData.Items[index].Content.Items\n            );\n          });\n          each(ends, (end) => {\n            annotations.push(end);\n          });\n        }\n\n        return annotations;\n      });\n    } else {\n      return this.restGet('/assetdatabases/' + this.afdatabase.webid + '/eventframes?' + filter.join('&')).then(\n        (result) => {\n          const annotations = map(result.data.Items, curry(this.eventFrameToAnnotation)(annotationOptions, false));\n          if (options.annotation.showEndTime) {\n            const ends = map(result.data.Items, curry(this.eventFrameToAnnotation)(annotationOptions, true));\n            each(ends, (end) => {\n              annotations.push(end);\n            });\n          }\n          return annotations;\n        }\n      );\n    }\n  }\n\n  /**\n   * Builds the Grafana metric segment for use on the query user interface.\n   *\n   * @param {any} response - response from PI Web API.\n   * @returns - Grafana metric segment.\n   *\n   * @memberOf PiWebApiDatasource\n   */\n  private metricQueryTransform(response: PiwebapiRsp[]): MetricFindValue[] {\n    return map(response, (item) => {\n      return {\n        text: item.Name,\n        expandable:\n          item.HasChildren === undefined || item.HasChildren === true || (item.Path ?? '').split('\\\\').length <= 3,\n        HasChildren: item.HasChildren,\n        Items: item.Items ?? [],\n        Path: item.Path,\n        WebId: item.WebId,\n      } as MetricFindValue;\n    });\n  }\n\n  /**\n   * This method does the discovery of the AF Hierarchy and populates the query user interface segments.\n   *\n   * @param {any} query - Parses the query configuration and builds a PI Web API query.\n   * @returns - Segment information.\n   *\n   * @memberOf PiWebApiDatasource\n   */\n  metricFindQuery(query: any, queryOptions: any): Promise<MetricFindValue[]> {\n    const ds = this;\n    const querydepth = ['servers', 'databases', 'databaseElements', 'elements'];\n    if (typeof query === 'string') {\n      query = JSON.parse(query as string);\n    }\n    if (queryOptions.isPiPoint) {\n      query.path = this.templateSrv.replace(query.path, queryOptions);\n    } else {\n      if (query.path === '') {\n        query.type = querydepth[0];\n      } else {\n        query.path = this.templateSrv.replace(query.path, queryOptions); // replace variables in the path\n        query.path = query.path.split(';')[0]; // if the attribute is in the path, let's remote it\n        if (query.type !== 'attributes') {\n          query.type = querydepth[Math.max(0, Math.min(query.path.split('\\\\').length, querydepth.length - 1))];\n        }\n      }\n      query.path = query.path.replace(/\\{([^\\\\])*\\}/gi, (r: string) => r.substring(1, r.length - 2).split(',')[0]);\n    }\n\n    query.filter = query.filter ?? '*';\n\n    if (query.type === 'servers') {\n      return ds.afserver?.name\n        ? ds\n            .getAssetServer(ds.afserver.name)\n            .then((result: PiwebapiRsp) => [result])\n            .then(ds.metricQueryTransform)\n        : ds.getAssetServers().then(ds.metricQueryTransform);\n    } else if (query.type === 'databases') {\n      return ds\n        .getAssetServer(query.path)\n        .then((server) => ds.getDatabases(server.WebId ?? '', {}))\n        .then(ds.metricQueryTransform);\n    } else if (query.type === 'databaseElements') {\n      return ds\n        .getDatabase(query.path)\n        .then((db) =>\n          ds.getDatabaseElements(db.WebId ?? '', {\n            selectedFields: 'Items.WebId%3BItems.Name%3BItems.Items%3BItems.Path%3BItems.HasChildren',\n          })\n        )\n        .then(ds.metricQueryTransform);\n    } else if (query.type === 'elements') {\n      return ds\n        .getElement(query.path)\n        .then((element) =>\n          ds.getElements(element.WebId ?? '', {\n            selectedFields: 'Items.Description%3BItems.WebId%3BItems.Name%3BItems.Items%3BItems.Path%3BItems.HasChildren',\n            nameFilter: query.filter,\n          })\n        )\n        .then(ds.metricQueryTransform);\n    } else if (query.type === 'attributes') {\n      return ds\n        .getElement(query.path)\n        .then((element) =>\n          ds.getAttributes(element.WebId ?? '', {\n            searchFullHierarchy: 'true',\n            selectedFields: 'Items.Type%3BItems.DefaultUnitsName%3BItems.Description%3BItems.WebId%3BItems.Name%3BItems.Path',\n            nameFilter: query.filter,\n          })\n        )\n        .then(ds.metricQueryTransform);\n    } else if (query.type === 'dataserver') {\n      return ds.getDataServers().then(ds.metricQueryTransform);\n    } else if (query.type === 'pipoint') {\n      return ds.piPointSearch(query.webId, query.pointName).then(ds.metricQueryTransform);\n    }\n    return Promise.reject('Bad type');\n  }\n\n  /**\n   * Gets the url of summary data from the query configuration.\n   *\n   * @param {any} summary - Query summary configuration.\n   * @returns - URL append string.\n   *\n   * @memberOf PiWebApiDatasource\n   */\n  getSummaryUrl(summary: any) {\n    if (summary.interval.trim() === '') {\n      return (\n        '&summaryType=' +\n        summary.types.map((s: any) => s.value?.value).join('&summaryType=') +\n        '&calculationBasis=' +\n        summary.basis\n      );\n    }\n    return (\n      '&summaryType=' +\n      summary.types.map((s: any) => s.value?.value).join('&summaryType=') +\n      '&calculationBasis=' +\n      summary.basis +\n      '&summaryDuration=' +\n      summary.interval.trim()\n    );\n  }\n\n  /** PRIVATE SECTION */\n\n  /**\n   * Resolve PIWebAPI response 'value' data to value - timestamp pairs.\n   *\n   * @param {any} value - A list of PIWebAPI values.\n   * @param {any} target - The target Grafana metric.\n   * @param {boolean} isSummary - Boolean for tracking if data is of summary class.\n   * @returns - An array of Grafana value, timestamp pairs.\n   *\n   */\n  private parsePiPointValueData(value: any, target: any, isSummary: boolean) {\n    const datapoints: any[] = [];\n    if (Array.isArray(value)) {\n      each(value, (item) => {\n        this.piPointValue(isSummary ? item.Value : item, target, isSummary, datapoints);\n      });\n    } else {\n      this.piPointValue(value, target, isSummary, datapoints);\n    }\n    return datapoints;\n  }\n\n  /**\n   * Resolve PIWebAPI response 'value' data to value - timestamp pairs.\n   *\n   * @param {any} value - PI Point value.\n   * @param {any} target - The target grafana metric.\n   * @param {boolean} isSummary - Boolean for tracking if data is of summary class.\n   * @param {any[]} datapoints - Array with Grafana datapoints.\n   *\n   */\n  private piPointValue(value: any, target: any, isSummary: boolean, datapoints: any[]) {\n    // @ts-ignore\n    const { grafanaDataPoint, previousValue, drop } = noDataReplace(\n      value,\n      target.summary.nodata,\n      this.parsePiPointValue(value, target, isSummary)\n    );\n    if (!drop) {\n      datapoints.push(grafanaDataPoint);\n    }\n  }\n\n  /**\n   * Convert a PI Point value to use Grafana value/timestamp.\n   *\n   * @param {any} value - PI Point value.\n   * @param {any} target - The target grafana metric.\n   * @param {boolean} isSummary - Boolean for tracking if data is of summary class.\n   * @returns - Grafana value pair.\n   *\n   */\n  private parsePiPointValue(value: any, target: any, isSummary: boolean) {\n    let num = !isSummary && typeof value.Value === 'object' ? value.Value?.Value : value.Value;\n\n    if (!value.Good || !!target.digitalStates?.enable) {\n      num = (!isSummary && typeof value.Value === 'object' ? value.Value?.Name : value.Name) ?? '';\n      return [checkNumber(num) ? Number(num) : num.trim(), new Date(value.Timestamp).getTime()];\n    }\n\n    return [checkNumber(num) ? Number(num) : num.trim(), new Date(value.Timestamp).getTime()];\n  }\n\n  /**\n   * Convert the Pi web api response object to the Grafana Labels object.\n   *\n   * @param {PiwebapiRsp} webid - Pi web api response object.\n   * @returns The converted Labels object.\n   */\n  private toTags(webid: PiwebapiRsp, isPiPoint: boolean): Labels {\n    const omitArray = ['Path', 'WebId', 'Id', 'ServerTime', 'ServerVersion'];\n    const obj = omitBy(webid, (value: any, key: string) => !value || !value.length || omitArray.indexOf(key) >= 0);\n    obj.Element = isPiPoint ? this.piserver.name : getLastPath(webid.Path ?? '');\n    const sorted = Object.keys(obj)\n      .sort()\n      .reduce((accumulator: any, key: string) => {\n        accumulator[lowerCaseFirstLetter(key)] = obj[key];\n        return accumulator;\n      }, {});\n    return sorted as Labels;\n  }\n\n  /**\n   * Process the response from PI Web API for a single item.\n   *\n   * @param {any} content - Web response data.\n   * @param {any} target - The target grafana metric.\n   * @param {any} name - The target metric name.\n   * @returns - Parsed metric in target/datapoint json format.\n   *\n   * @memberOf PiWebApiDatasource\n   */\n  private processResults(content: any, target: any, name: any, noTemplate: boolean, webid: PiwebapiRsp): PiwebapTargetRsp[] {\n    const api = this;\n    const isSummary: boolean = target.summary && target.summary.types && target.summary.types.length > 0;\n    if (!target.isPiPoint && !target.display) {\n      if (this.newFormatConfig) {\n        name = (noTemplate ? getLastPath(content.Path) : getPath(target.elementPathArray, content.Path)) + '|' + name;\n      } else {\n        name = noTemplate ? name : getPath(target.elementPathArray, content.Path) + '|' + name;\n      }\n    }\n    if (target.regex && target.regex.enable && target.regex.search.length && target.regex.replace.length) {\n      name = name.replace(new RegExp(target.regex.search), target.regex.replace);\n    }\n    if (isSummary) {\n      const innerResults: PiwebapTargetRsp[] = [];\n      const groups = groupBy(content.Items, (item: any) => item.Type);\n      forOwn(groups, (value, key) => {\n        innerResults.push({\n          refId: target.refId,\n          target: name + '[' + key + ']',\n          meta: {\n            path: webid.Path,\n            pathSeparator: '\\\\'\n          },\n          tags: this.newFormatConfig ? api.toTags(webid, target.isPiPoint) : {},\n          datapoints: api.parsePiPointValueData(value, target, isSummary),\n          path: webid.Path,\n        });\n      });\n      return innerResults;\n    }\n    const results: PiwebapTargetRsp[] = [\n      {\n        refId: target.refId,\n        target: name,\n        meta: {\n          path: webid.Path,\n          pathSeparator: '\\\\'\n        },\n        tags: this.newFormatConfig ? api.toTags(webid, target.isPiPoint) : {},\n        datapoints: api.parsePiPointValueData(content.Items || content.Value, target, isSummary),\n        path: webid.Path,\n        unit: webid.DefaultUnitsName,\n      },\n    ];\n    return results;\n  }\n\n  /**\n   * Check if all items are selected.\n   *\n   * @param {any} current the current variable selection\n   * @return {boolean} true if all value is selected, false otherwise\n   */\n  private isAllSelected(current: any): boolean {\n    if (!current) {\n      return false;\n    }\n    if (Array.isArray(current.text)) {\n      return current.text.indexOf('All') >= 0;\n    }\n    return current.text === 'All';\n  }\n\n  /**\n   * Returns a new element path list based on the panel variables.\n   *\n   * @param {string} elementPathArray array of element paths\n   * @param {string} variables the list of variable values\n   * @param {string} allValue the all value value for the variable\n   * @returns {PiwebapiElementPath[]} new element path list\n   */\n  private getElementPath(\n    elementPathArray: PiwebapiElementPath[],\n    variables: any[],\n    allValue: string\n  ): PiwebapiElementPath[] {\n    // elementPath\n    let newElementPathArray: PiwebapiElementPath[] = [];\n    elementPathArray.forEach((elem: PiwebapiElementPath) => {\n      if ((!!allValue && elem.path.indexOf(allValue) >= 0) || (!allValue && elem.path.match(/{[a-zA-z0-9,-_]+}/gi))) {\n        const temp: PiwebapiElementPath[] = variables.map((vv: any) => {\n          return {\n            path: !!allValue\n              ? elem.path.replace(allValue, vv.value)\n              : elem.path.replace(/{[a-zA-z0-9,-_]+}/gi, vv.value),\n            variable: vv.value,\n          } as PiwebapiElementPath;\n        });\n        newElementPathArray = newElementPathArray.concat(temp);\n      }\n    });\n    if (newElementPathArray.length) {\n      return uniq(flatten(newElementPathArray));\n    }\n    return elementPathArray;\n  }\n\n  /**\n   * Gets historical data from a PI Web API stream source.\n   *\n   * @param {any} query - Grafana query.\n   * @returns - Metric data.\n   *\n   * @memberOf PiWebApiDatasource\n   */\n  private getStream(query: any): Array<Promise<PiwebapTargetRsp[]>> {\n    const ds = this;\n    const results: Array<Promise<PiwebapTargetRsp[]>> = [];\n\n    each(query.targets, (target) => {\n      // pi point config disabled\n      if (target.isPiPoint && !ds.piPointConfig) {\n        console.error('Trying to call Pi Point server with Pi Point config disabled');\n        return;\n      }\n      target.attributes = filter(target.attributes || [], (attribute) => {\n        return 1 && attribute;\n      });\n      let url = '';\n      const isSummary = target.summary && target.summary.types && target.summary.types.length > 0;\n      const isInterpolated = target.interpolate && target.interpolate.enable;\n      // perhaps add a check to see if interpolate override time < query.interval\n      const intervalTime = target.interpolate.interval ? target.interpolate.interval : query.interval;\n      const timeRange = '?startTime=' + query.range.from.toJSON() + '&endTime=' + query.range.to.toJSON();\n      const targetName = target.expression || target.elementPath;\n      const displayName = target.display ? this.templateSrv.replace(target.display, query.scopedVars) : null;\n      if (target.expression) {\n        url += '/calculation';\n        if (isSummary) {\n          url += '/summary' + timeRange + (isInterpolated ? '&sampleType=Interval&sampleInterval=' + intervalTime : '');\n        } else if (isInterpolated) {\n          url += '/intervals' + timeRange + '&sampleInterval=' + intervalTime;\n        } else {\n          url += '/recorded' + timeRange;\n        }\n        url += '&expression=' + encodeURIComponent(target.expression.replace(/\\${intervalTime}/g, intervalTime));\n        if (target.attributes.length > 0) {\n          results.push(ds.createBatchGetWebId(target, url, displayName));\n        } else {\n          results.push(\n            ds.restGetWebId(target.elementPath, false).then((webidresponse: PiwebapiRsp) => {\n              return ds\n                .restPost(url + webidresponse.WebId)\n                .then((response: any) => ds.processResults(response.data, target, displayName || targetName, false, webidresponse))\n                .catch((err: any) => (ds.error = err));\n            })\n          );\n        }\n      } else {\n        url += '/streamsets';\n        if (isSummary) {\n          url += '/summary' + timeRange + '&intervals=' + query.maxDataPoints + this.getSummaryUrl(target.summary);\n        } else if (isInterpolated) {\n          url += '/interpolated' + timeRange + '&interval=' + intervalTime;\n        } else if (target.recordedValues && target.recordedValues.enable) {\n          const maxNumber =\n            target.recordedValues.maxNumber && !isNaN(target.recordedValues.maxNumber)\n              ? target.recordedValues.maxNumber\n              : query.maxDataPoints;\n          url += '/recorded' + timeRange + '&maxCount=' + maxNumber;\n        } else if (target.useLastValue?.enable) {\n          url += '/value?time=' + query.range.to.toJSON();\n        } else {\n          url += '/plot' + timeRange + '&intervals=' + query.maxDataPoints;\n        }\n        results.push(ds.createBatchGetWebId(target, url, displayName));\n      }\n    });\n\n    return results;\n  }\n\n  /**\n   * Process batch response to metric data.\n   *\n   * @param {any} response - The batch response.\n   * @param {any} target - Grafana query target.\n   * @param {string} displayName - The display name.\n   * @returns - Process metric data.\n   */\n  private handleBatchResponse(response: any, target: any, displayName: string | null): Promise<PiwebapTargetRsp[]> {\n    const targetName = target.expression || target.elementPath;\n    const noTemplate = target.elementPathArray.length === 1 && target.elementPath === target.elementPathArray[0].path;\n    let index = 1;\n    const targetResults: PiwebapTargetRsp[] = [];\n    for (const _ of target.attributes) {\n      const dataKey = `Req${index + 1000}`;\n      const path = response.config.data[dataKey].Headers \n        ? response.config.data[dataKey].Headers['Asset-Path']\n        : null;\n      const data = response.data[dataKey];\n      if (data.Status >= 400) {\n        continue;\n      }\n\n      let webid: PiwebapiRsp;\n      if (!!path) {\n        webid = this.webidCache.get(path);\n      } else {\n        const respData = response.data[`Req${index}`].Content;\n        webid = {\n          Path: respData.Path!,\n          Type: respData.Type || respData.PointType,\n          DefaultUnitsName: respData.DefaultUnitsName || respData.EngineeringUnits,\n          Description: respData.Description || respData.Descriptor,\n          WebId: respData.WebId,\n          Name: respData.Name,\n        }\n        this.webidCache.set(webid.Path!, webid);\n      }\n\n      if (target.expression) {\n        each(\n          this.processResults(data.Content, target, displayName || webid.Name || targetName, noTemplate, webid),\n          (targetResult) => targetResults.push(targetResult)\n        );\n      } else {\n        each(data.Content.Items, (item) => {  \n          each(\n            this.processResults(item, target, displayName || item.Name || targetName, noTemplate, webid),\n            (targetResult) => targetResults.push(targetResult)\n          );\n        });\n      }\n      index++;\n    }\n    return Promise.resolve(targetResults);\n  }\n\n  /**\n   * Creates a batch query pair.\n   *\n   * @param {boolean} isPiPoint - is Pi point flag.\n   * @param {string} elementPath - the PI element path or PI Data server name.\n   * @param {string} attribute - the attribute or PI point name.\n   * @param {any} query - the batch query to build.\n   * @param {number} index - the current query index.\n   * @param {boolean} replace - is pi point and calculation.\n   * @param {string} url - the base url to call. \n   */\n  private createQueryPair(\n    isPiPoint: boolean,\n    elementPath: string,\n    attribute: string,\n    query: any,\n    index: number,\n    replace: boolean,\n    url: string,\n  ) {\n    let path = '';\n    let assetPath = '';\n    if (isPiPoint) {\n      assetPath = '\\\\\\\\' + elementPath + '\\\\' + attribute;\n      path = '/points?selectedFields=Descriptor%3BPointType%3BEngineeringUnits%3BWebId%3BName%3BPath&path=' + assetPath;\n    } else {\n      assetPath = '\\\\\\\\' + elementPath + '|' + attribute;\n      path = '/attributes?selectedFields=Type%3BDefaultUnitsName%3BDescription%3BWebId%3BName%3BPath&path=' + assetPath;\n    }\n\n    const data = this.webidCache.get(assetPath);\n    if (!!data) {\n      query[`Req${index + 1000}`] = {\n        Method: 'GET',\n        Resource: this.piwebapiurl + getFinalUrl(replace, { Name: attribute }, url) + '&webId=' +\n          (replace ? this.piserver.webid: data.WebId),\n        Headers: {\n          'Asset-Path': assetPath\n        }\n      };\n    } else {\n      query[`Req${index}`] = {\n        Method: 'GET',\n        Resource: this.piwebapiurl + path,\n      };\n      query[`Req${index + 1000}`] = {\n        Method: 'GET',\n        ParentIds: [ \n          `Req${index}`\n        ],\n        Parameters: [\n          `$.Req${index}.Content.WebId`\n        ],\n        Resource: this.piwebapiurl + getFinalUrl(replace, { Name: attribute }, url) + \n          (replace ? '&webId=' + this.piserver.webid: '&webId={0}'),\n      };\n    }\n  }\n\n  /**\n   * Get metric data using Batch.\n   *\n   * @param {any} target - Grafana query target.\n   * @param {string} url The base URL for the query.\n   * @param {string} displayName - The display name.\n   * @returns - Metric data.\n   */\n  private createBatchGetWebId(target: any, url: string, displayName: string | null): Promise<PiwebapTargetRsp[]> {\n    const noTemplate = target.elementPathArray.length === 1 && target.elementPath === target.elementPathArray[0].path;\n    const replace = target.isPiPoint && !!target.expression;\n    const query: any = {};\n    let index = 1;\n    for (const attribute of target.attributes) {\n      if (noTemplate) {\n        this.createQueryPair(target.isPiPoint, target.elementPath, attribute, query, index, replace, url);\n        index++;\n      } else {\n        target.elementPathArray.forEach((elementPath: PiwebapiElementPath) => {\n          this.createQueryPair(target.isPiPoint, elementPath.path, attribute, query, index, replace, url);\n          index++;\n        });\n      }\n    }\n    return this.restBatch(query).then((response: any) => this.handleBatchResponse(response, target, displayName));\n  }\n\n  /**\n   * Abstraction for calling the PI Web API REST endpoint\n   *\n   * @param {any} path - the path to append to the base server URL.\n   * @returns - The full URL.\n   *\n   * @memberOf PiWebApiDatasource\n   */\n  private restGet(path: string): Promise<PiwebapiInternalRsp> {\n    return this.backendSrv\n      .datasourceRequest({\n        url: this.url + path,\n        method: 'GET',\n        headers: { 'Content-Type': 'application/json' },\n      })\n      .then((response: any) => {\n        return response as PiwebapiInternalRsp;\n      });\n  }\n\n  /**\n   * Resolve a Grafana query into a PI Web API webid. Uses client side cache when possible to reduce lookups.\n   *\n   * @param {string} assetPath - The AF Path or the Pi Point Path (\\\\ServerName\\piPointName) to the asset.\n   * @param {boolean} isPiPoint - Flag indicating it's a PI Point\n   * @returns - URL query parameters.\n   *\n   * @memberOf PiWebApiDatasource\n   */\n  private restGetWebId(assetPath: string, isPiPoint: boolean): Promise<PiwebapiRsp> {\n    const ds = this;\n\n    // check cache\n    const cachedWebId = ds.webidCache.get(assetPath);\n    if (cachedWebId) {\n      return Promise.resolve({\n        ...cachedWebId,\n      });\n    }\n\n    // no cache hit, query server\n    let path = '';\n    if (isPiPoint) {\n      path = '/points?selectedFields=Descriptor%3BPointType%3BEngineeringUnits%3BWebId%3BName%3BPath&path=\\\\\\\\' + assetPath.replace('|', '\\\\');\n    } else {\n      path =\n        (assetPath.indexOf('|') >= 0\n          ? '/attributes?selectedFields=Type%3BDefaultUnitsName%3BDescription%3BWebId%3BName%3BPath&path=\\\\\\\\'\n          : '/elements?selectedFields=Description%3BWebId%3BName%3BPath&path=\\\\\\\\') + assetPath;\n    }\n\n    return this.backendSrv\n      .datasourceRequest({\n        url: this.url + path,\n        method: 'GET',\n        headers: { 'Content-Type': 'application/json' },\n      })\n      .then((response: any) => {\n        const data = {\n          Path: assetPath,\n          Type: response.data.Type || response.data.PointType,\n          DefaultUnitsName: response.data.DefaultUnitsName || response.data.EngineeringUnits,\n          Description: response.data.Description || response.data.Descriptor,\n          WebId: response.data.WebId,\n          Name: response.data.Name,\n        }\n        ds.webidCache.set(assetPath, data);\n        return {\n          ...data,\n        };\n      });\n  }\n\n  /**\n   * Execute a batch query on the PI Web API.\n   *\n   * @param {any} batch - Batch JSON query data.\n   * @returns - Batch response.\n   *\n   * @memberOf PiWebApiDatasource\n   */\n  private restBatch(batch: any) {\n    return this.backendSrv.datasourceRequest({\n      url: this.url + '/batch',\n      data: batch,\n      method: 'POST',\n      headers: {\n        'Content-Type': 'application/json',\n        'X-Requested-With': 'message/http',\n      },\n    });\n  }\n\n  /**\n   * Execute a POST on the PI Web API.\n   *\n   * @param {string} path - The full url of the POST.\n   * @returns - POST response data.\n   *\n   * @memberOf PiWebApiDatasource\n   */\n  private restPost(path: string) {\n    return this.backendSrv.datasourceRequest({\n      url: this.url,\n      method: 'POST',\n      headers: {\n        'Content-Type': 'application/json',\n        'X-Requested-With': 'message/http',\n        'X-PIWEBAPI-HTTP-METHOD': 'GET',\n        'X-PIWEBAPI-RESOURCE-ADDRESS': path,\n      },\n    });\n  }\n\n  // Get a list of all data (PI) servers\n  private getDataServers(): Promise<PiwebapiRsp[]> {\n    return this.restGet('/dataservers').then((response) => response.data.Items ?? []);\n  }\n  private getDataServer(name: string | undefined): Promise<PiwebapiRsp> {\n    if (!name) {\n      return Promise.resolve({});\n    }\n    return this.restGet('/dataservers?name=' + name).then((response) => response.data);\n  }\n  // Get a list of all asset (AF) servers\n  private getAssetServers(): Promise<PiwebapiRsp[]> {\n    return this.restGet('/assetservers').then((response) => response.data.Items ?? []);\n  }\n  private getAssetServer(name: string | undefined): Promise<PiwebapiRsp> {\n    if (!name) {\n      return Promise.resolve({});\n    }\n    return this.restGet('/assetservers?path=\\\\\\\\' + name).then((response) => response.data);\n  }\n  private getDatabase(path: string | undefined): Promise<PiwebapiRsp> {\n    if (!path) {\n      return Promise.resolve({});\n    }\n    return this.restGet('/assetdatabases?path=\\\\\\\\' + path).then((response) => response.data);\n  }\n  getDatabases(serverId: string, options?: any): Promise<PiwebapiRsp[]> {\n    if (!serverId) {\n      return Promise.resolve([]);\n    }\n    return this.restGet('/assetservers/' + serverId + '/assetdatabases').then((response) => response.data.Items ?? []);\n  }\n  getElement(path: string): Promise<PiwebapiRsp> {\n    if (!path) {\n      return Promise.resolve({});\n    }\n    return this.restGet('/elements?path=\\\\\\\\' + path).then((response) => response.data);\n  }\n  getEventFrameTemplates(databaseId: string): Promise<PiwebapiRsp[]> {\n    if (!databaseId) {\n      return Promise.resolve([]);\n    }\n    return this.restGet(\n      '/assetdatabases/' + databaseId + '/elementtemplates?selectedFields=Items.InstanceType%3BItems.Name%3BItems.WebId'\n    ).then((response) => {\n      return filter(response.data.Items ?? [], (item) => item.InstanceType === 'EventFrame');\n    });\n  }\n  getElementTemplates(databaseId: string): Promise<PiwebapiRsp[]> {\n    if (!databaseId) {\n      return Promise.resolve([]);\n    }\n    return this.restGet(\n      '/assetdatabases/' + databaseId + '/elementtemplates?selectedFields=Items.InstanceType%3BItems.Name%3BItems.WebId'\n    ).then((response) => {\n      return filter(response.data.Items ?? [], (item) => item.InstanceType === 'Element');\n    });\n  }\n\n  /**\n   * @description\n   * Get the child attributes of the current resource.\n   * GET attributes/{webId}/attributes\n   * @param {string} elementId - The ID of the parent resource. See WebID for more information.\n   * @param {Object} options - Query Options\n   * @param {string} options.nameFilter - The name query string used for finding attributes. The default is no filter. See Query String for more information.\n   * @param {string} options.categoryName - Specify that returned attributes must have this category. The default is no category filter.\n   * @param {string} options.templateName - Specify that returned attributes must be members of this template. The default is no template filter.\n   * @param {string} options.valueType - Specify that returned attributes' value type must be the given value type. The default is no value type filter.\n   * @param {string} options.searchFullHierarchy - Specifies if the search should include attributes nested further than the immediate attributes of the searchRoot. The default is 'false'.\n   * @param {string} options.sortField - The field or property of the object used to sort the returned collection. The default is 'Name'.\n   * @param {string} options.sortOrder - The order that the returned collection is sorted. The default is 'Ascending'.\n   * @param {string} options.startIndex - The starting index (zero based) of the items to be returned. The default is 0.\n   * @param {string} options.showExcluded - Specified if the search should include attributes with the Excluded property set. The default is 'false'.\n   * @param {string} options.showHidden - Specified if the search should include attributes with the Hidden property set. The default is 'false'.\n   * @param {string} options.maxCount - The maximum number of objects to be returned per call (page size). The default is 1000.\n   * @param {string} options.selectedFields - List of fields to be returned in the response, separated by semicolons (;). If this parameter is not specified, all available fields will be returned. See Selected Fields for more information.\n   */\n  private getAttributes(elementId: string, options: any): Promise<PiwebapiRsp[]> {\n    let querystring =\n      '?' +\n      map(options, (value, key) => {\n        return key + '=' + value;\n      }).join('&');\n\n    if (querystring === '?') {\n      querystring = '';\n    }\n\n    return this.restGet('/elements/' + elementId + '/attributes' + querystring).then(\n      (response) => response.data.Items ?? []\n    );\n  }\n\n  /**\n   * @description\n   * Retrieve elements based on the specified conditions. By default, this method selects immediate children of the current resource.\n   * Users can search for the elements based on specific search parameters. If no parameters are specified in the search, the default values for each parameter will be used and will return the elements that match the default search.\n   * GET assetdatabases/{webId}/elements\n   * @param {string} databaseId - The ID of the parent resource. See WebID for more information.\n   * @param {Object} options - Query Options\n   * @param {string} options.webId - The ID of the resource to use as the root of the search. See WebID for more information.\n   * @param {string} options.nameFilter - The name query string used for finding objects. The default is no filter. See Query String for more information.\n   * @param {string} options.categoryName - Specify that returned elements must have this category. The default is no category filter.\n   * @param {string} options.templateName - Specify that returned elements must have this template or a template derived from this template. The default is no template filter.\n   * @param {string} options.elementType - Specify that returned elements must have this type. The default type is 'Any'. See Element Type for more information.\n   * @param {string} options.searchFullHierarchy - Specifies if the search should include objects nested further than the immediate children of the searchRoot. The default is 'false'.\n   * @param {string} options.sortField - The field or property of the object used to sort the returned collection. The default is 'Name'.\n   * @param {string} options.sortOrder - The order that the returned collection is sorted. The default is 'Ascending'.\n   * @param {number} options.startIndex - The starting index (zero based) of the items to be returned. The default is 0.\n   * @param {number} options.maxCount - The maximum number of objects to be returned per call (page size). The default is 1000.\n   * @param {string} options.selectedFields -  List of fields to be returned in the response, separated by semicolons (;). If this parameter is not specified, all available fields will be returned. See Selected Fields for more information.\n   */\n  private getDatabaseElements(databaseId: string, options: any): Promise<PiwebapiRsp[]> {\n    let querystring =\n      '?' +\n      map(options, (value, key) => {\n        return key + '=' + value;\n      }).join('&');\n\n    if (querystring === '?') {\n      querystring = '';\n    }\n\n    return this.restGet('/assetdatabases/' + databaseId + '/elements' + querystring).then(\n      (response) => response.data.Items ?? []\n    );\n  }\n\n  /**\n   * @description\n   * Retrieve elements based on the specified conditions. By default, this method selects immediate children of the current resource.\n   * Users can search for the elements based on specific search parameters. If no parameters are specified in the search, the default values for each parameter will be used and will return the elements that match the default search.\n   * GET elements/{webId}/elements\n   * @param {string} databaseId - The ID of the resource to use as the root of the search. See WebID for more information.\n   * @param {Object} options - Query Options\n   * @param {string} options.webId - The ID of the resource to use as the root of the search. See WebID for more information.\n   * @param {string} options.nameFilter - The name query string used for finding objects. The default is no filter. See Query String for more information.\n   * @param {string} options.categoryName - Specify that returned elements must have this category. The default is no category filter.\n   * @param {string} options.templateName - Specify that returned elements must have this template or a template derived from this template. The default is no template filter.\n   * @param {string} options.elementType - Specify that returned elements must have this type. The default type is 'Any'. See Element Type for more information.\n   * @param {string} options.searchFullHierarchy - Specifies if the search should include objects nested further than the immediate children of the searchRoot. The default is 'false'.\n   * @param {string} options.sortField - The field or property of the object used to sort the returned collection. The default is 'Name'.\n   * @param {string} options.sortOrder - The order that the returned collection is sorted. The default is 'Ascending'.\n   * @param {number} options.startIndex - The starting index (zero based) of the items to be returned. The default is 0.\n   * @param {number} options.maxCount - The maximum number of objects to be returned per call (page size). The default is 1000.\n   * @param {string} options.selectedFields -  List of fields to be returned in the response, separated by semicolons (;). If this parameter is not specified, all available fields will be returned. See Selected Fields for more information.\n   */\n  private getElements(elementId: string, options: any): Promise<PiwebapiRsp[]> {\n    let querystring =\n      '?' +\n      map(options, (value, key) => {\n        return key + '=' + value;\n      }).join('&');\n\n    if (querystring === '?') {\n      querystring = '';\n    }\n\n    return this.restGet('/elements/' + elementId + '/elements' + querystring).then(\n      (response) => response.data.Items ?? []\n    );\n  }\n\n  /**\n   * Retrieve a list of points on a specified Data Server.\n   *\n   * @param {string} serverId - The ID of the server. See WebID for more information.\n   * @param {string} nameFilter - A query string for filtering by point name. The default is no filter. *, ?, [ab], [!ab]\n   */\n  private piPointSearch(serverId: string, nameFilter: string): Promise<PiwebapiRsp[]> {\n    let filter1 = this.templateSrv.replace(nameFilter);\n    let filter2 = `${filter1}`;\n    let doFilter = false;\n    if (filter1 !== nameFilter) {\n      const regex = /\\{(\\w|,)+\\}/gs;\n      let m;\n      while ((m = regex.exec(filter1)) !== null) {\n        // This is necessary to avoid infinite loops with zero-width matches\n        if (m.index === regex.lastIndex) {\n          regex.lastIndex++;\n        }\n\n        // The result can be accessed through the `m`-variable.\n        m.forEach((match, groupIndex) => {\n          if (groupIndex === 0) {\n            filter1 = filter1.replace(match, match.replace('{', '(').replace('}', ')').replace(',', '|'));\n            filter2 = filter2.replace(match, '*');\n            doFilter = true;\n          }\n        });\n      }\n    }\n    return this.restGet('/dataservers/' + serverId + '/points?maxCount=50&nameFilter=' + filter2).then((results) => {\n      if (!!results && !!results.data?.Items) {\n        return doFilter ? results.data.Items.filter((item) => item.Name?.match(filter1)) : results.data.Items;\n      }\n      return [];\n    });\n  }\n\n  /**\n   * Get the PI Web API webid or PI Point.\n   *\n   * @param {any} target - AF Path or Point name.\n   * @returns - webid.\n   *\n   * @memberOf PiWebApiDatasource\n   */\n  getWebId(target: any) {\n    const ds = this;\n    const isAf = target.target.indexOf('\\\\') >= 0;\n    const isAttribute = target.target.indexOf('|') >= 0;\n    if (!isAf && target.target.indexOf('.') === -1) {\n      return Promise.resolve([{ WebId: target.target, Name: target.display || target.target }]);\n    }\n\n    if (!isAf) {\n      // pi point lookup\n      return ds.piPointSearch(this.piserver.webid!, target.target).then((results) => {\n        if (results === undefined || results.length === 0) {\n          return [{ WebId: target.target, Name: target.display || target.target }];\n        }\n        return results;\n      });\n    } else if (isAf && isAttribute) {\n      // af attribute lookup\n      return ds.restGet('/attributes?path=\\\\\\\\' + target.target).then((results) => {\n        if (results.data === undefined || results.status !== 200) {\n          return [{ WebId: target.target, Name: target.display || target.target }];\n        }\n        // rewrite name if specified\n        results.data.Name = target.display || results.data.Name;\n        return [results.data];\n      });\n    } else {\n      // af element lookup\n      return ds.restGet('/elements?path=\\\\\\\\' + target.target).then((results) => {\n        if (results.data === undefined || results.status !== 200) {\n          return [{ WebId: target.target, Name: target.display || target.target }];\n        }\n        // rewrite name if specified\n        results.data.Name = target.display || results.data.Name;\n        return [results.data];\n      });\n    }\n  }\n}\n","import { DataSourcePlugin } from '@grafana/data';\nimport { AnnotationsQueryCtrl } from './AnnotationsQueryCtrl';\nimport { PIWebAPIConfigEditor } from './ConfigEditor';\nimport { PIWebAPIQueryEditor } from './QueryEditor';\nimport { PiWebAPIDatasource } from './datasource';\nimport { PIWebAPIQuery, PIWebAPIDataSourceJsonData } from './types';\n\nexport const plugin = new DataSourcePlugin<PiWebAPIDatasource, PIWebAPIQuery, PIWebAPIDataSourceJsonData>(\n  PiWebAPIDatasource\n)\n  .setConfigEditor(PIWebAPIConfigEditor)\n  .setQueryEditor(PIWebAPIQueryEditor)\n  .setAnnotationQueryCtrl(AnnotationsQueryCtrl);\n"],"names":["module","exports","__WEBPACK_EXTERNAL_MODULE__0__","__WEBPACK_EXTERNAL_MODULE__1__","__WEBPACK_EXTERNAL_MODULE__2__","__WEBPACK_EXTERNAL_MODULE__3__","__WEBPACK_EXTERNAL_MODULE__5__","__webpack_module_cache__","__webpack_require__","moduleId","cachedModule","undefined","__webpack_modules__","n","getter","__esModule","d","a","definition","key","o","Object","defineProperty","enumerable","get","obj","prop","prototype","hasOwnProperty","call","r","Symbol","toStringTag","value","AnnotationsQueryCtrl","$scope","this","annotation","ctrl","datasource","query","databases","templates","regex","attribute","showEndTime","getAssetServer","afserver","name","then","result","getDatabases","WebId","getEventFrames","webid","dbs","$apply","getEventFrameTemplates","database","FormField","LegacyForms","coerceOptions","options","jsonData","url","PIWebAPIConfigEditor","event","props","onOptionsChange","piserver","target","afdatabase","checked","pipoint","newFormat","originalOptions","DataSourceHttpSettings","defaultUrl","dataSourceConfig","onChange","onHttpOptionsChange","showAccessOptions","className","InlineField","label","labelWidth","InlineSwitch","onPiPointChange","onNewFormatChange","inputWidth","onPIServerChange","placeholder","onAFServerChange","onAFDatabaseChange","PureComponent","QueryField","tooltip","children","InlineFormLabel","width","QueryRowTerminator","QueryInlineField","QueryEditorRow","QueryRawInlineField","QueryRawEditorRow","defaultQuery","attributes","segments","enable","summary","types","basis","interval","nodata","expression","interpolate","useLastValue","recordedValues","digitalStates","isPiPoint","QueryEditorModeSwitcher","isRaw","useState","isModalOpen","setModalOpen","useEffect","Button","icon","variant","type","onClick","ConfirmModal","isOpen","title","body","confirmText","dismissText","onConfirm","onDismiss","LABEL_WIDTH","MIN_ATTR_INPUT_WIDTH","REMOVE_LABEL","CustomLabelComponent","Icon","PIWebAPIQueryEditor","summaries","attributeSegment","summarySegment","calculationBasisSegment","noDataReplacementSegment","setState","item","index","state","slice","remove","checkPiPointSegments","checkAttributeSegments","length","push","expandable","piServer","segmentChangeValue","currentSegment","data","findQuery","path","getSegmentPathUpTo","Promise","resolve","metricFindQuery","assign","request","scopedVars","items","altSegments","map","text","webId","variables","templateSrv","getVariables","each","variable","selectableValue","unshift","err","error","message","attributeText","getSelectedPIServer","pointName","Path","forOwn","availableAttributes","val","segmentsArray","attributesArray","splitAttributes","split","splitElements","splice","_","match","getElementSegments","elements","summariesArray","cb","initialLoad","scopedVarsDone","force","metricsQuery","defaults","buildFromTarget","_segmentsArray","updateArray","e","checkAfServer","onRunQuery","rawQuery","elementPath","join","s","queryChange","onSegmentChange","bind","calcBasisValueChanged","calcNoDataValueChanged","onSummaryAction","onSummaryValueChanged","onAttributeAction","onAttributeChange","summaryTypes","calculationBasis","noDataReplacement","segment","isValueEmpty","stateCallback","filter","indexOf","part","attributeChangeValue","arr","reduce","startsWith","attributesResponse","validAttributes","substring","filteredAttributes","attrib","changedValue","replace","webID","forEach","parts","queryProps","display","piPointConfig","onIsPiPointChange","InlineFieldRow","grow","Input","onBlur","textEditorChanged","SegmentAsync","Component","loadOptions","allowCustomValue","inputMinWidth","disabled","getAttributeSegmentsPI","reloadOptionsOnChange","Segment","getAttributeSegmentsAF","maxNumber","parseInt","getNoDataSegments","getCalcBasisSegments","getSummarySegments","search","convertTimeSeriesToDataFrame","timeSeries","times","values","datapoints","point","fields","TIME_SERIES_TIME_FIELD_NAME","FieldType","config","ArrayVector","TIME_SERIES_VALUE_FIELD_NAME","unit","labels","tags","displayNameFromDS","refId","meta","checkNumber","number","Number","isNaN","isFinite","getLastPath","splitPath","pop","getPath","elementPathArray","splitStr","foundElement","find","getFinalUrl","Name","PiWebAPIDatasource","instanceSettings","Map","basicAuth","withCredentials","getTemplateSrv","backendSrv","getBackendSrv","piwebapiurl","toString","isProxy","test","access","newFormatConfig","all","getDataServer","getDatabase","annotationOptions","endTime","eventFrame","attributeDataItems","RegExp","attributeData","attributeValue","Value","time","Date","EndTime","StartTime","getTime","targets","hide","tr","parseRawQuery","ds","tar","att","webids","startTime","range","from","to","varsKeys","keys","v","isAllSelected","current","selected","attr","vv","allValue","uniq","flatten","getElementPath","Array","isArray","buildQueryParameters","getStream","targetResponses","flattened","sort","b","datasourceRequest","method","response","status","Error","categoryName","nameFilter","templateName","template","iconColor","toJSON","resourceUrl","Method","Resource","RequestTemplate","Parameters","ParentIds","restBatch","Content","valueData","annotations","Items","curry","eventFrameToAnnotation","ends","end","restGet","HasChildren","queryOptions","querydepth","JSON","parse","Math","max","min","metricQueryTransform","getAssetServers","server","db","getDatabaseElements","selectedFields","getElement","element","getElements","getAttributes","searchFullHierarchy","getDataServers","piPointSearch","reject","trim","isSummary","piPointValue","noDataReplacementMode","grafanaDataPoint","previousValue","drop","Good","noDataReplace","parsePiPointValue","num","Timestamp","omitArray","omitBy","Element","accumulator","string","charAt","toLocaleLowerCase","content","noTemplate","api","innerResults","groups","groupBy","Type","pathSeparator","toTags","parsePiPointValueData","DefaultUnitsName","newElementPathArray","elem","temp","concat","results","isInterpolated","intervalTime","timeRange","targetName","displayName","encodeURIComponent","createBatchGetWebId","restGetWebId","webidresponse","restPost","processResults","maxDataPoints","getSummaryUrl","targetResults","dataKey","Headers","Status","webidCache","respData","PointType","EngineeringUnits","Description","Descriptor","set","targetResult","assetPath","createQueryPair","handleBatchResponse","headers","cachedWebId","batch","serverId","databaseId","InstanceType","elementId","querystring","filter1","filter2","doFilter","m","exec","lastIndex","groupIndex","isAf","isAttribute","DataSourceApi","plugin","DataSourcePlugin","setConfigEditor","setQueryEditor","setAnnotationQueryCtrl"],"sourceRoot":""}